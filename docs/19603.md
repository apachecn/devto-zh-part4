# ä½¿ç”¨ IndexedDB æ„å»ºåŸºæœ¬çš„ web åº”ç”¨ç¨‹åº

> åŸæ–‡:[https://dev . to/andyhaskell/build-a-basic-we b-app-with-indexed db-38ef](https://dev.to/andyhaskell/build-a-basic-web-app-with-indexeddb-38ef)

IndexedDB æ˜¯ä¸€ä¸ª NoSQL æ•°æ®åº“ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•ä¸»æµæµè§ˆå™¨ä¸Šä½¿ç”¨å®ƒæ¥å­˜å‚¨å¤§é‡æ•°æ®ï¼Œå¹¶åƒåœ¨ MongoDB è¿™æ ·çš„æ•°æ®åº“ä¸­ä¸€æ ·è¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœä½ æ­£åœ¨åˆ¶ä½œä¸€ä¸ªå­˜å‚¨å¤§é‡æ•°æ®çš„ web åº”ç”¨ç¨‹åºæˆ–æµè§ˆå™¨æ‰©å±•ï¼Œå¹¶ä¸”ä½ æƒ³è¦å¤šç§æ–¹æ³•æ¥æŸ¥è¯¢è¿™äº›æ•°æ®ï¼ŒIndexedDB å°±æ˜¯å®ƒçš„ç”¨æ­¦ä¹‹åœ°ï¼

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ¶ä½œä¸€ä¸ªç®€å•çš„æ— æ¡†æ¶ä¾¿ç¬º web åº”ç”¨ç¨‹åºï¼Œä½œä¸ºä½¿ç”¨ IndexedDB åº”è¯¥çŸ¥é“çš„æ¦‚å¿µçš„æ¦‚è¿°ã€‚ä¸ºäº†æ›´æ·±å…¥åœ°äº†è§£ï¼ŒMozilla Developer Network çš„ä½¿ç”¨ IndexedDB çš„[æ˜¯å¦ä¸€ä¸ªå¾ˆå¥½çš„æ¦‚è¿°ï¼Œæˆ‘è¿˜æ¨è](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB)[https://www . freecodecamp . org/news/a-quick-but-complete-guide-to-indexed db-25f 030425501/](https://dev.tothis%20tutorial%20from%20FreeCodeCamp)ï¼Œå®ƒæ›´ä¾§é‡äº API æ–¹æ³•ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æœ¬æ•™ç¨‹çš„ä»£ç [ï¼Œåœ¨è¿™é‡Œ](https://github.com/andyhaskell/indexeddb-tutorial/tree/master/1-intro-tutorial)ä½ å¯ä»¥æ‰¾åˆ°æœ¬æ•™ç¨‹å…³äºå‘ä½ çš„ IDB ä»£ç æ·»åŠ æµ‹è¯•è¦†ç›–çš„ç¬¬ 2 éƒ¨åˆ†[ã€‚](https://dev.to/andyhaskell/testing-your-indexeddb-code-with-jest-2o17)

## [](#why-should-i-use-indexeddb-in-my-web-app)ä¸ºä»€ä¹ˆè¦åœ¨æˆ‘çš„ web app ä¸­ä½¿ç”¨ IndexedDBï¼Ÿ

æ­£å¦‚æˆ‘å‰é¢æ‰€è¯´çš„ï¼Œé€‰æ‹© IndexedDB è€Œä¸æ˜¯æœ¬åœ°å­˜å‚¨çš„ä¸¤ä¸ªåŸå› æ˜¯:

*   æ²¡æœ‰å¤§å°é™åˆ¶ï¼›å¦‚æœä½ çš„åº”ç”¨éœ€è¦å¤„ç†å¤§é‡æ•°æ®ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ¬åœ°å’Œä¼šè¯å­˜å‚¨çš„å‡ å…†å­—èŠ‚ï¼ŒIndexedDB å¯ä»¥è®©ä½ å­˜å‚¨å¤§é‡æ•°æ®ã€‚
*   ç»“æ„åŒ–å­˜å‚¨ï¼›æ‚¨å¯ä»¥å°†å¯¹è±¡å­˜å‚¨åœ¨ IndexedDB å¯¹è±¡å­˜å‚¨ä¸­ï¼Œå¹¶ä½¿ç”¨å®ƒä»¬çš„å­—æ®µæ¥æŸ¥è¯¢å®ƒä»¬ã€‚

è¿™äº›ä¹Ÿæ˜¯ä½ åœ¨æœåŠ¡å™¨ä¸Šå­˜å‚¨æ•°æ®çš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥å¦‚æœä½ çš„é¡¹ç›®æœ‰åå°ï¼Œä½ æ€»æ˜¯å¯ä»¥æŠŠæ•°æ®å­˜å‚¨åœ¨é‚£é‡Œã€‚ä½†æ˜¯å¦‚æœä½ æ­£åœ¨åˆ¶ä½œä¸€ä¸ªç¦»çº¿ä¼˜å…ˆçš„ web åº”ç”¨æˆ–è€…ä¸€ä¸ªæ²¡æœ‰åå°çš„åº”ç”¨ï¼ŒIndexedDB æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚ä¾‹å¦‚ï¼Œæˆ‘æ­£åœ¨å¼€å‘ä¸€ä¸ªæµè§ˆå™¨æ‰©å±•æ¥åˆ¶ä½œä¸€ä¸ªå¯è§†åŒ–çš„ã€äº¤äº’å¼çš„ç½‘é¡µå†å²çš„æ ‡ç­¾å›¾ã€‚ä¸ºæ­¤ï¼Œæˆ‘å¸Œæœ›èƒ½å¤Ÿå­˜å‚¨å¤§é‡æ ‡ç­¾ï¼ŒæŒ‰æ—¶é—´é¡ºåºæ£€ç´¢å®ƒä»¬ï¼Œå¹¶ä¸”è¯¥åº”ç”¨ç¨‹åºæ²¡æœ‰ web åç«¯ï¼Œå› æ­¤ IndexedDB æ˜¯ä¸€ä¸ªå®Œç¾çš„é€‰æ‹©ï¼

## [](#making-our-database)åˆ¶ä½œæˆ‘ä»¬çš„æ•°æ®åº“

å¥½äº†ï¼Œè®©æˆ‘ä»¬å¼€å§‹åˆ¶ä½œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå§ï¼é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªåä¸º indexeddb-tutorial çš„æ–‡ä»¶å¤¹ï¼Œåœ¨ä¸€ä¸ªåä¸º`db.js`çš„æ–‡ä»¶ä¸­ï¼Œæ·»åŠ è¿™æ®µä»£ç ï¼Œè¿™å°†åˆ›å»ºæˆ‘ä»¬çš„æ•°æ®åº“ï¼

```
let db;
let dbReq = indexedDB.open('myDatabase', 1);

dbReq.onupgradeneeded = function(event) {
  // Set the db variable to our database so we can use it! 
  db = event.target.result;

  // Create an object store named notes. Object stores
  // in databases are where data are stored.
  let notes = db.createObjectStore('notes', {autoIncrement: true});
}
dbReq.onsuccess = function(event) {
  db = event.target.result;
}

dbReq.onerror = function(event) {
  alert('error opening database ' + event.target.errorCode);
} 
```

è¦è¿è¡Œ JavaScriptï¼Œå°†è¿™æ®µä»£ç æ”¾åœ¨åä¸º index.html çš„æ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨ Chrome:
ä¸­æ‰“å¼€å®ƒ

```
<!DOCTYPE html>
<html>
  <head><title>IndexedDB note store</title></head>
  <body>
    <div id="app"><h1>Coming soon</h1></div>
    <script src="db.js"></script>
  </body>
</html> 
```

ç°åœ¨åœ¨ Chrome ä¸­ï¼Œè¿›å…¥**å¼€å‘è€…å·¥å…·**ï¼Œç‚¹å‡»**åº”ç”¨**æ ‡ç­¾ï¼Œç„¶åç‚¹å‡»å·¦è¾¹æ çš„ **IndexedDB** ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®åº“å·²ç»åˆ›å»ºå¥½äº†ï¼

[![Screenshot of our IndexedDB panel with our database and object store created](../Images/485867c27233fa37ef542557ebb4eed0.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--t2uCodS7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/aj7wlmaizb5ez6cy0kst.png)

é…·ï¼æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º`myDatabase`çš„**æ•°æ®åº“**ï¼Œè¿˜æœ‰ä¸€ä¸ªåä¸º`notes`çš„**å¯¹è±¡å­˜å‚¨**(ä¸€ä¸ªæ¡ç›®é›†åˆï¼Œç±»ä¼¼äºä¸€ä¸ª SQL è¡¨æˆ– MongoDB ä¸­çš„ä¸€ä¸ªé›†åˆ)ã€‚ä½†æ˜¯ï¼Œä»…ä»…æ˜¯åˆ›å»ºæ•°æ®åº“å’Œå•†åº—å°±éœ€è¦å¾ˆå¤šä»£ç ã€‚é‚£é‡Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿ

åœ¨å‰å‡ è¡Œ

```
let db;
let dbReq = indexedDB.open('myDatabase', 1); 
```

æˆ‘ä»¬æ‰“å¼€äº†åä¸º myDatabase çš„æ•°æ®åº“ç‰ˆæœ¬ 1ï¼Œä½†æ˜¯`indexedDB.open`æ²¡æœ‰è¿”å›æ•°æ®åº“ï¼Œå®ƒè¿”å›äº†å¯¹æ•°æ®åº“çš„**è¯·æ±‚**ï¼Œå› ä¸º IndexedDB æ˜¯ä¸€ä¸ª**å¼‚æ­¥** APIã€‚IndexedDB ä»£ç åœ¨åå°è¿è¡Œï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚å­˜å‚¨æˆåƒä¸Šä¸‡çš„é¡¹ç›®ï¼Œä½ çš„ web åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ä¸ä¼šåœæ­¢è¿è¡Œå®ƒçš„ JavaScriptï¼Œç­‰å¾…å®ƒå®Œæˆã€‚æ‰€ä»¥åœ¨å‰©ä¸‹çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç”¨**äº‹ä»¶ç›‘å¬å™¨** :
ç›‘å¬æ•°æ®åº“ä½•æ—¶å‡†å¤‡å¥½

```
dbReq.onupgradeneeded = function(event) {
  db = event.target.result;
  let notes = db.createObjectStore('notes', {autoIncrement: true});
} 
```

`myDatabase`ä»¥å‰ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å®ƒæ˜¯è‡ªåŠ¨åˆ›å»ºçš„ï¼Œç„¶åè§¦å‘`onupgradeneeded`äº‹ä»¶ã€‚åœ¨ onupgradeneeded å›è°ƒä¸­ï¼Œå¹¶ä¸”åªæœ‰åœ¨é‚£ä¸ªå›è°ƒä¸­ï¼Œæˆ‘ä»¬æ‰èƒ½åˆ›å»ºæ•°æ®åº“çš„å¯¹è±¡å­˜å‚¨ã€‚æ‰€ä»¥é¦–å…ˆï¼Œä½¿ç”¨`db = event.target.result`ï¼Œæˆ‘ä»¬è®¾ç½®å˜é‡`db`æ¥ä¿å­˜æˆ‘ä»¬çš„æ•°æ®åº“ã€‚ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º`notes`çš„å¯¹è±¡å­˜å‚¨ã€‚

```
dbReq.onsuccess = function(event) {
  db = event.target.result;
} 
```

åœ¨è¿™é‡Œï¼Œ`onsuccess`åœ¨`onupgradeneeded`å®Œæˆåè§¦å‘ï¼Œå¦‚æœæˆ‘ä»¬åˆ·æ–°é¡µé¢å¹¶å†æ¬¡æ‰“å¼€æ•°æ®åº“ï¼Œå®ƒä¹Ÿä¼šè§¦å‘ã€‚åŒæ ·ï¼Œæˆ‘ä»¬è¿è¡Œ`db = event.target.result`æ¥è·å–æˆ‘ä»¬çš„æ•°æ®åº“ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒäº†ã€‚

```
dbReq.onerror = function(event) {
  alert('error opening database ' + event.target.errorCode);
} 
```

æœ€åï¼Œå¦‚æœä»»ä½• IndexedDB è¯·æ±‚å‡ºé”™ï¼Œå®ƒçš„`onerror`äº‹ä»¶å°±ä¼šè§¦å‘ï¼Œå› æ­¤æ‚¨å¯ä»¥æŒ‰ç…§è‡ªå·±è®¤ä¸ºåˆé€‚çš„æ–¹å¼å¤„ç†é”™è¯¯ã€‚æˆ‘ä»¬åªæ˜¯è¦åšä¸€ä¸ª`alert`ã€‚

## [](#put-some-data-into-the-database)æŠŠä¸€äº›æ•°æ®æ”¾å…¥æ•°æ®åº“

æˆ‘ä»¬æœ‰è‡ªå·±çš„æ•°æ®åº“ï¼Œä½†æ˜¯æ²¡æœ‰æ•°æ®æˆ‘ä»¬åšä¸äº†ä»€ä¹ˆã€‚è®©æˆ‘ä»¬å†™ä¸€ä¸ªå‡½æ•°æ¥æ·»åŠ ä¾¿åˆ©è´´ï¼

```
function addStickyNote(db, message) {
  // Start a database transaction and get the notes object store
  let tx = db.transaction(['notes'], 'readwrite');
  let store = tx.objectStore('notes');

  // Put the sticky note into the object store
  let note = {text: message, timestamp: Date.now()};
  store.add(note);

  // Wait for the database transaction to complete
  tx.oncomplete = function() { console.log('stored note!') }
  tx.onerror = function(event) {
    alert('error storing note ' + event.target.errorCode);
  }
} 
```

ä¸ºäº†çœ‹åˆ°è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬å°†å¯¹æˆ‘ä»¬å‡½æ•°çš„ä¸€ç»„ä¸‰ä¸ªè°ƒç”¨æ”¾åˆ°æˆ‘ä»¬çš„`dbReq.onsuccess`ä¸­ï¼Œè¿™æ ·ä¸€æ—¦æ•°æ®åº“å‡†å¤‡å°±ç»ªï¼Œå®ƒä»¬å°±è¿è¡Œ:

```
dbReq.onsuccess = function(event) {
  db = event.target.result;

  // Add some sticky notes
  addStickyNote(db, 'Sloths are awesome!');
  addStickyNote(db, 'Order more hibiscus tea');
  addStickyNote(db, 'And Green Sheen shampoo, the best for sloth fur algae grooming!');
} 
```

ç°åœ¨åœ¨ä½ çš„æµè§ˆå™¨ä¸­åˆ·æ–° index.htmlï¼Œå†æ¬¡è¿›å…¥å¼€å‘è€…å·¥å…·ä¸­çš„**åº”ç”¨> IndexedDB** ï¼Œç‚¹å‡»å¯¹è±¡å­˜å‚¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„æ•°æ®ï¼

[![Screenshot of our IndexedDB panel with our objects stored](../Images/12c3789a250254267e5e9d541915a41c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--lyc2CZIM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/cjendv4p4240jt11smpl.png)

ç°åœ¨æˆ‘ä»¬å·²ç»å­˜å‚¨äº†ä¸€äº›æ•°æ®ï¼å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬åœ¨ notes å¯¹è±¡å­˜å‚¨ä¸­çš„ä¾¿ç¬ºæ˜¯ä½œä¸º JavaScript å¯¹è±¡å­˜å‚¨çš„ã€‚é‚£ä¹ˆä»£ç ä¸­å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

```
let tx = db.transaction(['notes'], 'readwrite');
let store = tx.objectStore('notes'); 
```

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸Šå¯åŠ¨ä¸€ä¸ª**äº‹åŠ¡**ï¼Œå°†æ•°æ®å†™å…¥æˆ‘ä»¬çš„`notes`å¯¹è±¡å­˜å‚¨ï¼Œç„¶åæˆ‘ä»¬ä»è¯¥äº‹åŠ¡ä¸­æ£€ç´¢å¯¹è±¡å­˜å‚¨ã€‚

```
let note = {text: message, timestamp: Date.now()};
store.add(note); 
```

æˆ‘ä»¬å°†ä¾¿ç¬ºè¡¨ç¤ºä¸ºä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶é€šè¿‡è°ƒç”¨å‡½æ•°`store.add`å°†å…¶å­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ä¸­ã€‚

```
tx.oncomplete = function() { console.log('stored note!') }
tx.onerror = function(event) {
  alert('error storing note ' + event.target.errorCode);
} 
```

æœ€åï¼Œå°±åƒæˆ‘ä»¬çš„å¼€æ”¾å¼æ•°æ®åº“è¯·æ±‚ä¸€æ ·ï¼Œè¿™ä¸ªäº‹åŠ¡æœ‰äº‹ä»¶ä¾¦å¬å™¨ï¼›æˆ‘ä»¬ç”¨äº‹åŠ¡çš„`oncomplete`å’Œ`onerror`ä¾¦å¬å™¨æ¥ä¾¦å¬å­˜å‚¨æ³¨é‡Šçš„æ“ä½œæ˜¯å®Œæˆè¿˜æ˜¯å‡ºé”™ã€‚

å…³äºæˆ‘ä»¬çš„ä¾¿åˆ©è´´ï¼Œå¦ä¸€ä»¶å€¼å¾—æ³¨æ„çš„äº‹æƒ…æ˜¯ï¼Œæ¯å¼ ä¾¿åˆ©è´´éƒ½æœ‰ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨è¿™ä¸‰ä¸ªéŸ³ç¬¦ä¹‹åå­˜å‚¨å¦ä¸€ä¸ªéŸ³ç¬¦ï¼Œå®ƒçš„é”®å°±æ˜¯ 4ã€‚é‚£äº›æ•°å­—æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿåœ¨ IndexedDB ä¸­ï¼Œå¯¹è±¡å­˜å‚¨ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª**é”®**æ¥æ ‡è¯†å®ƒä»¬ï¼Œå½“æˆ‘ä»¬ç”¨ä¸‹é¢çš„ä»£ç è¡Œåˆ›å»ºå¯¹è±¡å­˜å‚¨æ—¶:

`let notes = db.createObjectStore('notes', {autoIncrement: true});`

`autoIncrement`é€‰é¡¹è¡¨ç¤ºæˆ‘ä»¬å¸Œæœ›å­˜å‚¨ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªé€’å¢çš„é”®ã€‚å¦‚æœé€šè¿‡å”¯ä¸€çš„åç§°å­˜å‚¨å’Œæ£€ç´¢å¯¹è±¡æ›´æœ‰æ„ä¹‰ï¼Œä¹Ÿå¯ä»¥ç”¨å­—ç¬¦ä¸²é”®è¿›è¡Œå¯¹è±¡å­˜å‚¨(ä¾‹å¦‚ï¼Œä¸€ä¸ª UUID å¯ä»¥æ˜¯å¯¹è±¡å­˜å‚¨çš„å­—ç¬¦ä¸²é”®ï¼Œæˆ–è€…å¦‚æœæœ‰ä¸€ä¸ªæ ‘æ‡’çš„å¯¹è±¡å­˜å‚¨ï¼Œå¯ä»¥é€šè¿‡å°†æ¯åªæ ‘æ‡’å‘å‡ºçš„å±å±å£°çš„å­—ç¬¦ä¸²ç¼–ç ä½œä¸ºé”®æ¥è¯†åˆ«å®ƒä»¬)ã€‚

[https://www.youtube.com/embed/aaqzPMOd_1g](https://www.youtube.com/embed/aaqzPMOd_1g)

ç°åœ¨è®©æˆ‘ä»¬å°†è¿™ä¸ª`addStickyNote`å‡½æ•°æ·»åŠ åˆ°æˆ‘ä»¬å®é™…çš„ web åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥ç‚¹å‡»æäº¤ä¾¿ç¬ºäº†ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–‡æœ¬æ¡†æ¥æäº¤æ³¨é‡Šï¼Œæ‰€ä»¥åœ¨ id ä¸º`app`çš„ div ä¸­ï¼Œæ·»åŠ è¿™äº›æ ‡ç­¾:

```
<div id="textbox">
  <textarea id="newmessage"></textarea>
  <button onclick="submitNote()">Add note</button>
</div> 
```

å¹¶å°†è¯¥å‡½æ•°æ·»åŠ åˆ° db.js ä¸­ï¼Œè¯¥å‡½æ•°åœ¨ç”¨æˆ·æ¯æ¬¡æäº¤æ³¨é‡Šæ—¶è¿è¡Œ:

```
function submitNote() {
  let message = document.getElementById('newmessage');
  addStickyNote(db, message.value);
  message.value = '';
} 
```

ç°åœ¨å»æ‰å¯¹`dbReq.onsuccess`ä¸­çš„`addStickyNote`çš„è°ƒç”¨ï¼Œç„¶åå¦‚æœæˆ‘ä»¬å» index.html å¹¶åœ¨æˆ‘ä»¬çš„æ–‡æœ¬åŒºä¸­é”®å…¥ä¸€äº›ä¸œè¥¿ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»æäº¤æ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ç¬”è®°è¢«å­˜å‚¨åœ¨ IndexedDB ä¸­ï¼

åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•æ£€ç´¢æ•°æ®ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºå®ƒï¼Œä½†æ˜¯ï¼Œè®©æˆ‘ä»¬ç»•é“æ¥è°ˆè°ˆä½¿ç”¨ IndexedDB çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œäº‹åŠ¡ï¼

## [](#transactions-are-king-in-indexeddb)äº¤æ˜“ä¸ºç‹åœ¨ IndexedDB

æ­£å¦‚æ‚¨åœ¨æˆ‘ä»¬çš„ä¸Šä¸€ä¸ªç¤ºä¾‹ä¸­çœ‹åˆ°çš„ï¼Œä¸ºäº†è®¿é—®æˆ‘ä»¬çš„`notes`å¯¹è±¡å­˜å‚¨ï¼Œæˆ‘ä»¬å¿…é¡»è¿è¡Œ`db.transaction`æ¥åˆ›å»ºä¸€ä¸ª**äº‹åŠ¡**ï¼Œå®ƒæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹æ•°æ®åº“çš„**è¯·æ±‚**çš„é›†åˆã€‚IndexedDB ä¸­çš„ä¸€åˆ‡éƒ½æ˜¯é€šè¿‡äº‹åŠ¡å‘ç”Ÿçš„ã€‚å› æ­¤ï¼Œå­˜å‚¨ä¾¿ç¬ºã€æ‰“å¼€æ•°æ®åº“å’Œæ£€ç´¢ç¬”è®°éƒ½æ˜¯å‘ç”Ÿåœ¨äº‹åŠ¡å†…éƒ¨çš„è¯·æ±‚ã€‚

åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªè¯·æ±‚ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åœ¨åŒä¸€ä¸ªå¯¹è±¡å­˜å‚¨ä¸­å­˜å‚¨äº†è®¸å¤šé¡¹ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ store.add è¯·æ±‚éƒ½å¯ä»¥åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å‘å‡ºï¼Œæ¯”å¦‚:

```
function addManyNotes(db, messages) {
  let tx = db.transaction(['notes'], 'readwrite');
  let store = tx.objectStore('notes');

  for (let i = 0; i < messages.length; i++) {
    // All of the requests made from store.add are part of
    // the same transaction
    store.add({text: messages[i], timestamp: Date.now()});
  }

  // When all of these requests complete, the transaction's oncomplete
  // event fires
  tx.oncomplete = function() {console.log('transaction complete')};
} 
```

å°±åƒè¯·æ±‚æœ‰`onsuccess`å’Œ`onerror`äº‹ä»¶å¤„ç†ç¨‹åºä¸€æ ·ï¼Œäº‹åŠ¡æœ‰`oncomplete`ã€`onerror`å’Œ`onabort`äº‹ä»¶å¤„ç†ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åˆ«ç”¨å®ƒä»¬æ¥å“åº”äº‹åŠ¡çš„å®Œæˆã€å‡ºé”™æˆ–å›æ»šã€‚

ä½†æ˜¯ï¼Œå°†æ¯ä¸ªè¯·æ±‚æ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæˆ‘ä»¬åˆ°åº•èƒ½å¾—åˆ°ä»€ä¹ˆå‘¢ï¼Ÿè¯·è®°ä½ï¼ŒIndexedDB æ˜¯ä¸€ä¸ªå¼‚æ­¥ APIï¼Œå› æ­¤å¯èƒ½ä¼šæœ‰è®¸å¤šè¯·æ±‚åŒæ—¶è¿›è¡Œã€‚å‡è®¾æˆ‘ä»¬åœ¨ä¾¿ç­¾åº—é‡Œæœ‰ä¸€å¼ ä¾¿ç­¾ï¼Œä¸Šé¢å†™ç€â€œæ ‘æ‡’å¾ˆæ£’â€ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªè¯·æ±‚ï¼Œè¦æ±‚å°†ä¾¿ç­¾å…¨å¤§å†™ï¼Œå¦ä¸€ä¸ªè¯·æ±‚æ˜¯åœ¨ä¾¿ç­¾ä¸Šæ·»åŠ ä¸€ä¸ªæ„Ÿå¹å·ã€‚å¦‚æœæ²¡æœ‰äº¤æ˜“ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé¢ä¸´è¿™æ ·çš„å±€é¢:

[![Two database actions running on the same sticky note without transactions; because there's no transactions, the two actions read the sticky note from the object store before it is updated, and then run their updates, overwriting each other](../Images/a040b98d8318a906b707971e30cba605.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--nDE9P9D7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/0kc2mtuag1kalksavh6x.png)

æˆ‘ä»¬å¼€å§‹`makeAllCaps`å’Œ`addExclamation`åŠ¨ä½œï¼Œå®ƒä»¬éƒ½å–å›äº†æœªä¿®æ”¹çš„â€œæ ‘æ‡’å¾ˆæ£’â€ç¬”è®°ã€‚`addExclamation`å…ˆç”¨æ„Ÿå¹å·ä¿å­˜ä¾¿ç¬ºã€‚`makeAllCaps`èŠ±çš„æ—¶é—´æ›´é•¿ï¼Œä¹Ÿçœäº†â€œæ ‘æ‡’å¾ˆç‰›é€¼â€çš„çº¸æ¡ï¼Œæ²¡æœ‰æ„Ÿå¹å·ã€‚`makeAllCaps`æ›´æ–°å½»åº•æ¸…é™¤äº†`addExclamation`çš„æ›´æ–°ï¼

ç„¶è€Œï¼Œå¯¹äºäº‹åŠ¡ï¼Œæˆ‘ä»¬å¾—åˆ°äº†**å¹¶å‘æ§åˆ¶**ã€‚**ä¸€æ¬¡åªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åˆ›å»ºã€ä¿®æ”¹æˆ–åˆ é™¤å¯¹è±¡å­˜å‚¨ä¸­çš„é¡¹ç›®**ï¼Œå› æ­¤ IndexedDB ä¸­å®é™…å‘ç”Ÿçš„æƒ…å†µçœ‹èµ·æ¥æ›´åƒè¿™æ ·:

[![Two database actions running on the same sticky note with transactions; because we have transactions, the addExclamation transaction does not start untill after the makeAllCaps transaction completes. Therefore, the when the addExclamation transaction reads the sticky note, it has the modification from makeAllCaps](../Images/b9f299ef0ed73c2b3a7b7e20321b9137.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--r7mmJpSI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ipqobuo50g20la4ll55u.png)

`makeAllCaps`äº‹åŠ¡é¦–å…ˆå¼€å§‹ï¼Œä½†æ˜¯ç”±äº`addExclamation`ä½¿ç”¨ä¸ makeAllCaps ç›¸åŒçš„å¯¹è±¡å­˜å‚¨ï¼Œæ‰€ä»¥å®ƒç›´åˆ° makeAllCaps å®Œæˆåæ‰å¼€å§‹ã€‚æ‰€ä»¥ makeAllCaps ç»“æŸï¼Œall caps è¯»å–å…¨éƒ¨å¤§å†™çš„æ³¨é‡Šï¼Œç„¶åä¸¤æ¬¡ç¼–è¾‘éƒ½é€šè¿‡ï¼ğŸ‰

è¿™ä¹Ÿæ„å‘³ç€ï¼Œå¦‚æœä¸€æ¡è·¯æ˜¯ä¸€ä¸ªå¯¹è±¡å•†åº—ï¼Œä¸€ä¸ªæ‰«è¡—å·¥å’Œä¸€ä¸ªç”»çº¿å·¥æ­£åœ¨è¿è¡Œè€Œæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆç”»çº¿å·¥å¯èƒ½ä¼šåœ¨æ‰«è¡—å·¥ç§»åŠ¨ä¸€ä¸ªåˆ†æ”¯ä¹‹å‰è¿›è¡Œç»˜ç”»ï¼Œä½ ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœ:

[![Road with the side line painted around a fallen tree branch, with the word FAIL in all caps](../Images/d2edfe424dac279caf9365e7f92f40a9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--xUg50cvp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/81v4bzhdfolwwywrac1x.jpeg)

ä½†æ˜¯æœ‰äº† IndexedDB è¿è¡Œçš„äº‹åŠ¡ï¼Œæ‰«è¡—çš„äººå¯ä»¥æ‰«æ‰è·¯ä¸Šçš„æ ‘æï¼Œç”»çº¿çš„äººå¯ä»¥ç”»çº¿ï¼Œè¿™æ ·æ ‘æ‡’å°±å¯ä»¥å®‰å…¨åœ°å»éª‘è½¦äº†ï¼

[![Sloth hugging a bike](../Images/af2a922dc8e2f6bc6facbe6b952077fe.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--p9c-nrDw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/j1rl67zym4l4x34ayys1.jpeg)

åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œéœ€è¦çŸ¥é“çš„å¦ä¸€ä»¶äº‹æ˜¯ï¼Œå¦‚æœæ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æ•°æ®ï¼ŒåŒä¸€å¯¹è±¡å­˜å‚¨ä¸Šçš„äº‹åŠ¡ä¸€æ¬¡åªå‘ç”Ÿä¸€ä¸ª**ï¼›æ¢å¥è¯è¯´ï¼Œå®ƒä»¬æ˜¯`readwrite`äº‹åŠ¡ï¼Œæ˜¯è¿™æ ·åˆ›å»ºçš„:**

`let tx = db.transaction(['notes', 'someOtherStore'], 'readwrite');`

è¿™é‡Œæˆ‘ä»¬åšäº†ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼Œå¹¶è¯´å®ƒå½±å“äº†`notes`å’Œ`someOtherStore`ã€‚å› ä¸ºå®ƒæ˜¯ readwriteï¼Œæ‰€ä»¥åœ¨ä»»ä½•å…¶ä»–æ¶‰åŠè¿™äº›å¯¹è±¡å­˜å‚¨çš„äº‹åŠ¡å®Œæˆä¹‹å‰ï¼Œå®ƒä¸èƒ½å¯åŠ¨ã€‚

è™½ç„¶è¯»å†™äº‹åŠ¡æ˜¯ä¸€æ¬¡ä¸€ä¸ªï¼Œä½†ä¹Ÿæœ‰`readonly`ä¸ªäº‹åŠ¡ï¼›ä½ å¯ä»¥**è®©ä»»æ„å¤šçš„ç”¨æˆ·**åŒæ—¶ä¸åŒä¸€ä¸ªå¯¹è±¡åº“å¯¹è¯ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦é˜»æ­¢ä»–ä»¬å¼„ä¹±å½¼æ­¤çš„æ•°æ®ï¼ä½ æŠŠå®ƒä»¬åšæˆè¿™æ ·:

```
// These transactions can all do their thing at the same time, even with
// overlapping object stores!
let tx = db.transaction(['notes', 'someOtherStore'], 'readonly');
let tx2 = db.transaction(['notes'], 'readonly');
let tx3 = db.transaction(['someOtherStore'], 'readonly'); 
```

## [](#retrieving-one-sticky-note)æ£€ç´¢ä¸€å¼ ä¾¿ç¬ºæ¡

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†äº‹åŠ¡æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œåªè¯»äº‹åŠ¡æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè®©æˆ‘ä»¬ä»ä¾¿ç¬ºå­˜å‚¨ä¸­æ£€ç´¢ä¾¿ç¬ºï¼Œä»¥ä¾¿æ˜¾ç¤ºå®ƒä»¬ã€‚å¦‚æœæˆ‘ä»¬åªä»æ•°æ®åº“ä¸­è·å–ä¸€ä¸ªé¡¹ç›®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¯¹è±¡å­˜å‚¨çš„`get`æ–¹æ³•ï¼Œå°±åƒè¿™æ ·:

```
// Set up an object store and transaction
let tx = db.transaction(['notes'], 'readonly');
let store = tx.objectStore('notes');

// Set up a request to get the sticky note with the key 1
let req = store.get(1);

// We can use the note if the request succeeds, getting it in the
// onsuccess handler
req.onsuccess = function(event) {
  let note = event.target.result;

  if (note) {
    console.log(note);
  } else {
    console.log("note 1 not found")
  }
}

// If we get an error, like that the note wasn't in the object
// store, we handle the error in the onerror handler
req.onerror = function(event) {
  alert('error getting note 1 ' + event.target.errorCode);
} 
```

æˆ‘ä»¬è¿›è¡Œä¸€ä¸ªäº‹åŠ¡ï¼Œç”¨é”® 1 è¯·æ±‚ note store ä¸­çš„ note ä»¥è·å¾—æˆ‘ä»¬çš„è¯·æ±‚ï¼Œç„¶åæˆ‘ä»¬æˆ–è€…åœ¨è¯·æ±‚çš„`onsuccess`å¤„ç†ç¨‹åºä¸­ä½¿ç”¨æ£€ç´¢åˆ°çš„ noteï¼Œæˆ–è€…å¦‚æœæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬åœ¨`onerror`å¤„ç†ç¨‹åºä¸­å¤„ç†ä¸€ä¸ªé”™è¯¯ã€‚æ³¨æ„ï¼Œå¦‚æœä¾¿åˆ©è´´ä¸å­˜åœ¨ï¼Œ`onsuccess`ä»ç„¶ä¼šå¼€ç«ï¼Œä½†æ˜¯`event.target.result`ä¼šæ˜¯`undefined`ã€‚

è¯¥æ¨¡å¼æ„Ÿè§‰ç±»ä¼¼äºæˆ‘ä»¬æ‰“å¼€æ•°æ®åº“çš„å¤„ç†ç¨‹åºï¼›æˆ‘ä»¬å¯åŠ¨è¯·æ±‚ï¼Œç„¶ååœ¨`onsuccess`å¤„ç†ç¨‹åºä¸­è·å¾—ç»“æœï¼Œæˆ–è€…åœ¨`onerror`å¤„ç†ç¨‹åºä¸­å¤„ç†é”™è¯¯ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸ä»…ä»…æƒ³è¦ä¸€ä¸ªç¬”è®°ï¼Œæˆ‘ä»¬æƒ³è¦æ˜¾ç¤ºæ‰€æœ‰çš„ç¬”è®°ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¾—åˆ°æ‰€æœ‰è¿™äº›ï¼Œä¸ºæ­¤æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª**å…‰æ ‡**ã€‚

## [](#retrieving-data-with-cursors-and-displaying-your-sticky-notes)ç”¨å…‰æ ‡æ£€ç´¢æ•°æ®å¹¶æ˜¾ç¤ºæ‚¨çš„ä¾¿ç¬º

æ£€ç´¢å¯¹è±¡å­˜å‚¨ä¸­çš„æ‰€æœ‰é¡¹ç›®æœ‰è¿™æ ·ä¸€ä¸ªæ—¶é«¦çš„è¯­æ³•:

```
function getAndDisplayNotes(db) {
  let tx = db.transaction(['notes'], 'readonly');
  let store = tx.objectStore('notes');

  // Create a cursor request to get all items in the store, which 
  // we collect in the allNotes array
  let req = store.openCursor();
  let allNotes = [];

  req.onsuccess = function(event) {
    // The result of req.onsuccess in openCursor requests is an
    // IDBCursor
    let cursor = event.target.result;

    if (cursor != null) {
      // If the cursor isn't null, we got an item. Add it to the
      // the note array and have the cursor continue!
      allNotes.push(cursor.value);
      cursor.continue();
    } else {
      // If we have a null cursor, it means we've gotten
      // all the items in the store, so display the notes we got.
      displayNotes(allNotes);
    }
  }

  req.onerror = function(event) {
    alert('error in cursor request ' + event.target.errorCode);
  }
} 
```

è¿è¡Œè¯¥å‡½æ•°ï¼Œä¸‹é¢æ˜¯æ‰€æœ‰å‘ç”Ÿçš„æ­¥éª¤:

```
let tx = db.transaction(['notes'], 'readonly');
let store = tx.objectStore('notes'); 
```

åœ¨å‡½æ•°çš„å¼€å§‹ï¼Œæˆ‘ä»¬åœ¨`notes`å¯¹è±¡å­˜å‚¨ä¸Šåˆ›å»ºä¸€ä¸ªåªè¯»äº‹åŠ¡ã€‚ç„¶åæˆ‘ä»¬å¾—åˆ°å•†åº—ï¼Œç„¶åç”¨`store.openCursor()`æ–¹æ³•ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªè¯·æ±‚ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å†æ¬¡ç”¨è¯·æ±‚çš„`onsuccess`å’Œ`onerror`å¤„ç†ç¨‹åºå¤„ç†è¯·æ±‚çš„ç»“æœã€‚

åœ¨ onsuccess å¤„ç†ç¨‹åºä¸­ï¼Œäº‹ä»¶çš„ç»“æœæ˜¯ä¸€ä¸ª **IDBCursor** ï¼Œå…¶ä¸­åŒ…å«å…‰æ ‡æŒæœ‰çš„ä¾¿ç¬ºçš„`key`ï¼Œä»¥åŠä½œä¸ºå…‰æ ‡çš„`value`çš„ä¾¿ç¬ºæœ¬èº«ã€‚

```
let cursor = event.target.result;
if (cursor != null) {
  allNotes.push(cursor.value);
  cursor.continue();
} else { 
```

åœ¨ if è¯­å¥ä¸­ï¼Œå¦‚æœå…‰æ ‡ä¸ä¸ºç©ºï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æœ‰å¦ä¸€ä¸ªä¾¿ç¬ºï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…‰æ ‡çš„`value`æ·»åŠ åˆ°æˆ‘ä»¬çš„ä¾¿ç¬ºæ•°ç»„ä¸­ï¼Œå¹¶é€šè¿‡è°ƒç”¨`cursor.continue`ç»§ç»­æ£€ç´¢ä¾¿ç¬ºã€‚

```
} else {
  displayNotes(allNotes);
} 
```

ä½†æ˜¯å¦‚æœå…‰æ ‡ä¸ºç©ºï¼Œå°±æ²¡æœ‰æ›´å¤šè¦æ£€ç´¢çš„æ³¨é‡Šï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡å°†æ³¨é‡Šä¼ é€’ç»™ä¸€ä¸ª`displayNotes`å‡½æ•°æ¥æ˜¾ç¤ºæ³¨é‡Šã€‚

å—¯ï¼Œè¿™ä¸ª`cursor.continue()`æ„Ÿè§‰æœ‰ç‚¹åƒ while å¾ªç¯ï¼Œä½†æ˜¯æ²¡æœ‰å¾ªç¯æˆ–è€…æ§åˆ¶æµã€‚æˆ‘ä»¬åˆ°åº•è¦æ€ä¹ˆå¾ªç¯ï¼Ÿè¿™ä¸€è¡Œä¼šç»™ä½ ä¸€ä¸ªæç¤º:

`req.onsuccess = function(event) {`

åŸæ¥æ¯æ¬¡è°ƒç”¨`cursor.continue()`æ—¶ï¼Œéƒ½ä¼šè§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶å°†å…‰æ ‡å’Œä¸‹ä¸€ä¸ªé¡¹ç›®å‘é€ç»™ onsuccess å¤„ç†ç¨‹åºã€‚å› æ­¤ï¼Œåœ¨æ¯ä¸ª`onsuccess`ä¸­ï¼Œæˆ‘ä»¬æ”¶é›†å¦ä¸€ä¸ªä¾¿ç¬ºï¼Œç›´åˆ°æˆ‘ä»¬æˆåŠŸåˆ°è¾¾å…‰æ ‡ä¸ºç©ºçš„åœ°æ–¹ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ç”¨æ¸¸æ ‡è¿­ä»£æ•°æ®çš„æ–¹å¼ã€‚

ç°åœ¨è¦æ˜¾ç¤ºè¿™äº›ä¾¿ç¬ºï¼Œåœ¨ index.htmlï¼Œåœ¨æ–‡æœ¬æ¡† div ä¹‹åï¼Œåœ¨æ–‡æœ¬æ¡†ä¸‹é¢æ·»åŠ ä¸€ä¸ª div æ¥å­˜å‚¨æˆ‘ä»¬çš„ä¾¿ç¬º:

`<div id="notes"></div>`

å¹¶åœ¨ db.js ä¸­æ·»åŠ è¿™ä¸ªå‡½æ•°æ¥æ˜¾ç¤ºæ³¨é‡Š:

```
function displayNotes(notes) {
  let listHTML = '<ul>';
  for (let i = 0; i < notes.length; i++) {
    let note = notes[i];
    listHTML += '<li>' + note.text + '  ' + 
      new Date(note.timestamp).toString() + '</li>';
  }

  document.getElementById('notes').innerHTML = listHTML;
} 
```

è¯¥å‡½æ•°åªæ˜¯å°†æ¯ä¸ªç¬”è®°è½¬æ¢æˆä¸€ä¸ª`<li>`æ ‡ç­¾ï¼Œå¹¶ç”¨è€å¼çš„ JavaScript å°†å®ƒä»¬æ˜¾ç¤ºä¸ºä¸€ä¸ªåˆ—è¡¨ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ˜¾ç¤ºæ‰€æœ‰ä¾¿ç¬ºçš„å‡½æ•°ï¼Œè®©æˆ‘ä»¬åœ¨å‡ ä¸ªåœ°æ–¹æ·»åŠ å®ƒã€‚å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡æ‰“å¼€åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿçœ‹åˆ°æˆ‘ä»¬æ‰€æœ‰çš„ä¾¿ç¬ºï¼Œæ‰€ä»¥å½“æ•°æ®åº“ç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥è°ƒç”¨`dbReq.onsuccess` :
ä¸­çš„`getAndDisplayNotes`

```
dbReq.onsuccess = function(event) {
  db = event.target.result;
  // Once the database is ready, display the notes we already have!
  getAndDisplayNotes(db);
} 
```

å½“æ‚¨æ·»åŠ ä¸€ä¸ªä¾¿ç¬ºæ¡æ—¶ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿç«‹å³çœ‹åˆ°å®ƒï¼Œæ‰€ä»¥åœ¨`addStickyNote`ä¸­ï¼Œè®©æˆ‘ä»¬å°†å®Œæˆå›è°ƒä¸Šçš„äº‹åŠ¡æ›´æ”¹ä¸ºè°ƒç”¨`getAndDisplayNotes` :

```
tx.oncomplete = function() { getAndDisplayNotes(db); } 
```

ç°åœ¨åœ¨ Chrome ä¸­é‡æ–°æ‰“å¼€é¡µé¢ï¼Œå°è¯•æ·»åŠ æ›´å¤šæ³¨é‡Šã€‚åº”è¯¥æ˜¯è¿™æ ·çš„ï¼

[![The web app, showing notes displaying in our list tag, and the textarea containing the message "These sticky notes display as you add them!"](../Images/7321fe18c2992f1c00474d48d249166b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--cubjUAiU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/rjiz79hncm90br0xwfg1.png)

ç°åœ¨ï¼Œæœ€åä¸€ä»¶äº‹ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¨¡å¼ï¼Œé¦–å…ˆæŸ¥çœ‹æœ€æ–°çš„ç¬”è®°ï¼Œå¹¶çœ‹çœ‹ä¸ºä»€ä¹ˆè¿™è¢«ç§°ä¸º IndexedDBï¼

## [](#indices-putting-the-indexed-in-indexeddb)ç´¢å¼•ï¼Œå°†ç´¢å¼•æ”¾å…¥ IndexedDB

æˆ‘ä»¬å·²ç»æœ‰äº†è¿™ä¸ªä¾¿ç¬ºå­˜å‚¨ï¼Œå¹¶ä¸”æˆ‘ä»¬æ­£åœ¨å­˜å‚¨å¸¦æœ‰æ—¶é—´æˆ³çš„ä¾¿ç¬ºï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿæ£€ç´¢æŸä¸ªæ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰ä¾¿ç¬º(å°±åƒè¿‡å» 10 åˆ†é’Ÿå†…çš„æ‰€æœ‰ä¾¿ç¬º)æˆ–è€…èƒ½å¤Ÿé¦–å…ˆæ£€ç´¢æœ€æ–°çš„ä¾¿ç¬ºï¼Œè¿™åº”è¯¥æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå¯¹å—ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ï¼Œä½†æ˜¯ä¸ºäº†èƒ½å¤Ÿé€šè¿‡æ—¶é—´æˆ³å­—æ®µè¿›è¡ŒæŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦ç»™ notes å¯¹è±¡å­˜å‚¨ä¸­çš„é‚£ä¸ªå­—æ®µä¸€ä¸ª**ç´¢å¼•**ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†é‚£ä¸ªç´¢å¼•ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å®ƒè¿›è¡ŒæŸ¥è¯¢ã€‚ä½†æ˜¯è¯·è®°ä½ï¼Œå¯¹æ•°æ®åº“ç»“æ„çš„ä»»ä½•æ›´æ”¹éƒ½éœ€è¦å‘ç”Ÿåœ¨æ•°æ®åº“è¯·æ±‚çš„`onupgradeneeded`å¤„ç†ç¨‹åºä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ›´æ–°æ•°æ®åº“çš„ç‰ˆæœ¬æ¥åˆ›å»ºç´¢å¼•ï¼Œå°±åƒè¿™æ ·:

```
// We update the version of the database to 2 to trigger
// onupgradeneeded
let dbReq = indexedDB.open('myDatabase', 2);
dbReq.onupgradeneeded = function(event) {
  db = event.target.result;

  // Create the notes object store, or retrieve that store if it
  // already exists.
  let notes;
  if (!db.objectStoreNames.contains('notes')) {
    notes = db.createObjectStore('notes', {autoIncrement: true});
  } else {
    notes = dbReq.transaction.objectStore('notes');
  }

  // If there isn't already a timestamp index in our notes object
  // store, make one so we can query notes by their timestamps
  if (!notes.indexNames.contains('timestamp')) {
    notes.createIndex('timestamp', 'timestamp');
  }
} 
```

é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ•°æ®åº“çš„ç‰ˆæœ¬æ›´æ–°ä¸º 2ï¼Œè¿™è¡¨æ˜æ•°æ®åº“çš„ç»“æ„æ­£åœ¨å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤è§¦å‘äº†`onupgradeneeded`äº‹ä»¶ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªç‰ˆæœ¬å‡çº§ï¼Œå…¶ä¸­ notes å¯¹è±¡å­˜å‚¨ä»¥å‰å·²ç»å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ä¸€ä¸ªå¸¦æœ‰`db.objectStoreNames`çš„ notes å­˜å‚¨:

`if (!db.objectStoreNames.contains('notes')) {`

å¦‚æœå­˜å‚¨å¯¹è±¡å·²ç»å­˜åœ¨ï¼Œæˆ‘ä»¬ç”¨`dbReq.transaction.objectStore`æ£€ç´¢å®ƒ:

`notes = dbReq.transaction.objectStore('notes');`

æœ€åï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå¸¦æœ‰`createIndex`çš„ç´¢å¼•:

`notes.createIndex('timestamp', 'timestamp');`

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬ç´¢å¼•çš„åç§°ï¼Œç¬¬äºŒä¸ªæ˜¯ç´¢å¼•çš„ **keyPath** ã€‚ç´¢å¼•æœ¬èº«å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¯¹è±¡å­˜å‚¨ï¼Œå› æ­¤ç´¢å¼•ä¸­çš„æ‰€æœ‰é¡¹éƒ½æœ‰ä¸€ä¸ªé”®ã€‚å› æ­¤ï¼Œå¦‚æœç»™ä¸€ä¸ªç´¢å¼•ä¸€ä¸ª keyPath `timestamp`ï¼Œé‚£ä¹ˆå¯¹è±¡å­˜å‚¨ä¸­æ¯ä¸ªå¯¹è±¡çš„æ—¶é—´æˆ³å°†æ˜¯å®ƒçš„é”®ã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰å¯é€‰çš„ç¬¬ä¸‰ä¸ª options å¯¹è±¡å‚æ•°ã€‚å‡è®¾æˆ‘ä»¬çš„ç¬”è®°æœ‰æ ‡é¢˜ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³è¦è¦æ±‚ä¸€ä¸ªç¬”è®°ä¸èƒ½è¢«å­˜å‚¨ï¼Œå¦‚æœå®ƒä¸å¦ä¸€ä¸ªç¬”è®°æœ‰ç›¸åŒçš„æ ‡é¢˜ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼Œåˆ›å»ºä¸€ä¸ªç‹¬ç‰¹çš„æ ‡é¢˜ç´¢å¼•ï¼Œå¦‚ä¸‹æ‰€ç¤º:

`notes.createIndex('title', 'title', {unique: true});`

è¦æŸ¥çœ‹æˆ‘ä»¬çš„æ–°ç´¢å¼•ï¼Œä¸€æ—¦æ‚¨æ›´æ–°äº†`onupgradeneeded`ï¼Œåˆ·æ–°äº† Chrome ä¸­çš„ index.html(æ‚¨å¯èƒ½éœ€è¦é€€å‡º Chrome æ‰èƒ½çœ‹åˆ°æ›´æ”¹)ï¼Œå†æ¬¡è¿›å…¥å¼€å‘å·¥å…·>åº”ç”¨ç¨‹åº> IndexedDBï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿåœ¨ notes å¯¹è±¡å­˜å‚¨ä¸­çœ‹åˆ°æ–°çš„æ—¶é—´æˆ³ç´¢å¼•:

[![Screenshot of the IndexedDB panel in developer tools, looking at an index in IndexedDB. The timestamps of our sticky notes serve as keys. Indices in IndexedDB are listed in the panel under their object store.](../Images/94f797996870034861fcbcf7e7e53cd1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--OGbBl7an--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/rcnrybdhd2nd0jhktar1.png)

å¦‚æ‚¨æ‰€è§ï¼Œç¬”è®°ç°åœ¨æŒ‰ç…§å®ƒä»¬çš„æ—¶é—´æˆ³ä½œä¸ºä¸»é”®åˆ—å‡ºã€‚äº‹å®ä¸Šï¼Œä½œä¸ºä¸€ä¸ªå¯¹è±¡å­˜å‚¨ï¼Œç´¢å¼•æ‹¥æœ‰ä¸æ™®é€šå¯¹è±¡å­˜å‚¨ç›¸åŒçš„`get`å’Œ`openCursor`æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ä»¥ä¸‹å‘½ä»¤æ¥è¯·æ±‚åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªç¬”è®°:

`tx.objectStore('notes').index('timestamp').get(1533144673015);`

å¥½å§ã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå¾ˆé…·çš„æ–°ç´¢å¼•ï¼Œè®©æˆ‘ä»¬ç»™æˆ‘ä»¬çš„ web åº”ç”¨ç¨‹åºæ·»åŠ ä¸€ä¸ªæ¨¡å¼æ¥ç¿»è½¬æˆ‘ä»¬æ˜¾ç¤ºç¬”è®°çš„é¡ºåºã€‚é¦–å…ˆï¼Œåœ¨ db.js ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªå…¨å±€ bool å˜é‡:

```
let reverseOrder = false; 
```

ç„¶ååœ¨ getAndDisplayNotes ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ–°æˆ‘ä»¬çš„è¯·æ±‚ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æ—¶é—´æˆ³ç´¢å¼•ï¼Œå¹¶ä¸”å¯ä»¥é€‰æ‹©ä»å“ªä¸ªæ–¹å‘è¯»å–ä¾¿ç¬ºã€‚

```
let tx = db.transaction(['notes'], 'readonly');
let store = tx.objectStore('notes');

// Retrieve the sticky notes index to run our cursor query on; 
// the results will be ordered by their timestamp
let index = store.index('timestamp');

// Create our openCursor request, on the index rather than the main
// notes object store. If we're going in reverse, then specify the
// direction as "prev". Otherwise, we specify it as "next".
let req = index.openCursor(null, reverseOrder ? 'prev' : 'next'); 
```

åœ¨`store.index()`ä¸­ï¼Œæˆ‘ä»¬ç”¨æˆ‘ä»¬è¯·æ±‚çš„åç§°æ£€ç´¢ç´¢å¼•ï¼Œå°±åƒæˆ‘ä»¬å¦‚ä½•ä»äº‹åŠ¡ä¸­æ£€ç´¢å¯¹è±¡å­˜å‚¨ä¸€æ ·ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯¥ç´¢å¼•ä¸Šå®šä¹‰ä¸€ä¸ªæ¸¸æ ‡è¯·æ±‚ï¼Œä»¥è·å–æŒ‰æ—¶é—´æˆ³æ’åºçš„ç¬”è®°ã€‚

`index.openCursor`æœ‰ä¸¤ä¸ªå¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªï¼Œå¦‚æœå®ƒä¸ä¸ºç©ºï¼Œè®©æˆ‘ä»¬æŒ‡å®šæˆ‘ä»¬æƒ³è¦æ£€ç´¢çš„é¡¹ç›®çš„èŒƒå›´ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åªæƒ³è¦è¿‡å»ä¸€ä¸ªå°æ—¶çš„ä¾¿ç¬ºï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ‰“å¼€å…‰æ ‡:

```
let anHourAgoInMilliseconds = Date.now() - 60 * 60 * 1000;

// IDBKeyRange is a global variable for defining ranges to query
// indices on
let keyRange = IDBKeyRange.lowerBound(anHourAgoInMilliseconds);
let req = index.openCursor(keyRange, 'next'); 
```

ç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬å¸Œæœ›æ£€ç´¢æ¡ç›®çš„é¡ºåºï¼Œå¯ä»¥æ˜¯`'prev'`æˆ–`'next'`ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡ä¼ å…¥`reverseOrder ? 'prev' : 'next'`æ¥æŒ‡å®šæˆ‘ä»¬çš„æ–¹å‘ã€‚

æœ€åï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸€ç‚¹åœ¨è¡ŒåŠ¨ä¸­ï¼›åœ¨ index.htmlï¼Œå¢åŠ å¦ä¸€ä¸ªåŠŸèƒ½ã€‚è¿™å°†ç”¨äºç¿»è½¬æˆ‘ä»¬æ˜¾ç¤ºçš„ç¬”è®°çš„é¡ºåº:

```
function flipNoteOrder(notes) {
  reverseOrder = !reverseOrder;
  getAndDisplayNotes(db);
} 
```

ä¸ºäº†ä½¿ç”¨æˆ‘ä»¬ç”¨æˆ·ç•Œé¢ä¸­çš„ flipNoteOrder åŠŸèƒ½ï¼Œåœ¨ index.html ä¸­å†æ·»åŠ ä¸€ä¸ªæŒ‰é’®æ¥ç¿»è½¬éŸ³ç¬¦çš„é¡ºåºã€‚

```
<button onclick="flipNoteOrder()">Flip note order</button> 
```

å¦‚æœä½ åˆ·æ–° Chromeï¼Œä½ çš„ flip æŒ‰é’®ç°åœ¨åº”è¯¥å¯ä»¥å·¥ä½œäº†ï¼

[![Our web app, demonstrating that the flip note order button now works. Textarea contains the message "Flipped note order"](../Images/016704d862aed46693bbcf939e6aa729.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--7izvkaU3--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/j3x1j4pi3r271e4qluxn.png)

é…·ï¼ç°åœ¨æˆ‘ä»¬å¯ä»¥æ”¹å˜æˆ‘ä»¬çœ‹åˆ°ç¬”è®°çš„é¡ºåºäº†ï¼ç°åœ¨æ‚¨å·²ç»çœ‹åˆ°äº† IndexedDB çš„åŸºç¡€çŸ¥è¯†ã€‚è¿˜æœ‰å…¶ä»–ä¸€äº›æˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚åˆ é™¤å¯¹è±¡ã€åœ¨ IndexedDB ä¸­å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®å’Œå¤šå­—æ®µç´¢å¼•ï¼Œä½†è¿™åº”è¯¥æ˜¯ç”¨ IndexedDB æ„å»º web åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œå°½ç®¡åŸºæœ¬çš„ IndexedDB API å¾ˆå¼ºå¤§ï¼Œä½†å®ƒå¹¶ä¸ç¬¦åˆäººä½“å·¥ç¨‹å­¦ã€‚æˆ‘ä¸çŸ¥é“ä½ æ€ä¹ˆæƒ³ï¼Œä½†æ˜¯å¯¹æˆ‘æ¥è¯´ï¼Œè¿™äº› on event ç›‘å¬å™¨æ„Ÿè§‰ä¸æ–¹ä¾¿æ¨ç†ï¼Œå¹¶ä¸”é‚£äº›å¤„ç†ç¨‹åºåœ¨æˆ‘ç¬¬ä¸€æ¬¡å¼„æ¸…æ¥šå¦‚ä½•ç»™å‡º IndexedDB ä»£ç æµ‹è¯•è¦†ç›–ç‡æ—¶ä¹ŸèŠ±äº†ä¸€äº›å¿ƒæ€ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•ç»™è¿™ä¸ª API è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–å‘¢ï¼Ÿ

åœ¨æˆ‘æ¥ä¸‹æ¥çš„å‡ ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•é‡æ„è¿™æ®µä»£ç ä»¥ä½¿å…¶å¯æµ‹è¯•ï¼Œç„¶ååœ¨æ¥ä¸‹æ¥çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å±•ç¤ºå¦‚ä½•é‡æ„å®ƒä»¥ä½¿å…¶æ›´æ˜“äºä½¿ç”¨ï¼ç›´åˆ°ä¸‹ä¸€æ¬¡ï¼Œ

[![Three-toed sloth climbing on a bar, smiling](../Images/bc611f1697b03b23a95b86d41c8c60f2.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--sbqaII59--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/kkf5rf3hzfxluwd6iov2.jpeg)

### [](#stay-slothful)å·æ‡’ï¼

æœ¬æ•™ç¨‹çš„ç¬¬ 2 éƒ¨åˆ†æ˜¯å…³äºç´¢å¼•æµ‹è¯•è¦†ç›–ç‡çš„

[æ­£åœ¨ç¼–å†™æœ¬æ•™ç¨‹çš„ç¬¬ 3 éƒ¨åˆ†]