# ä½¿ç”¨ Pyspark çš„ Azure Blob å­˜å‚¨

> åŸæ–‡:[https://dev . to/luminous men/azure-blob-storage-with-py spark-21hd](https://dev.to/luminousmen/azure-blob-storage-with-pyspark-21hd)

[Azure Blob Storage](https://azure.microsoft.com/en-us/services/storage/blobs/) æ˜¯ä¸€é¡¹ç”¨äºå­˜å‚¨ä»¥[ä»»æ„æ ¼å¼](https://luminousmen.com/post/big-data-file-formats)æˆ–äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨çš„å¤§é‡æ•°æ®çš„æœåŠ¡ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æœåŠ¡ï¼Œå¯ä»¥å›´ç»•å®ƒåˆ›å»ºæ•°æ®ä»“åº“æˆ–æ•°æ®æ¹–ï¼Œä»¥å­˜å‚¨é¢„å¤„ç†æˆ–åŸå§‹æ•°æ®ï¼Œä¾›å°†æ¥åˆ†æä½¿ç”¨ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•åœ¨ Python ä¸Šä½¿ç”¨ [Spark framework](https://luminousmen.com/post/spark-anatomy-of-spark-application) è®¿é—® Azure Blob å­˜å‚¨ã€‚

* * *

Azure blob éœ€è¦å®‰è£…é¢å¤–çš„åº“æ¥è®¿é—®å…¶ä¸­çš„æ•°æ®ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†[wasb/wabs åè®®](https://blogs.msdn.microsoft.com/cindygross/2015/02/04/understanding-wasb-and-hadoop-storage-in-azure/)ï¼Œè€Œä¸æ˜¯äº‹å®ä¸Šçš„æ ‡å‡† hdfs åè®®ã€‚Wasbs åè®®åªæ˜¯å»ºç«‹åœ¨ HDFS API ä¹‹ä¸Šçš„ä¸€ä¸ªæ‰©å±•ã€‚ä¸ºäº†ä» Azure blob è®¿é—®èµ„æºï¼Œæ‚¨éœ€è¦åœ¨æäº¤ä½œä¸šæ—¶æ·»åŠ æ„å»ºçš„ jar æ–‡ä»¶ï¼Œåä¸º [hadoop-azure.jar](https://mvnrepository.com/artifact/org.apache.hadoop/hadoop-azure) å’Œ [azure-storage.jar](https://mvnrepository.com/artifact/com.microsoft.azure/azure-storage) åˆ°`spark-submit`ã€‚

```
$ spark-submit --py-files src.zip \
            --master yarn \
            --deploy-mode=cluster \
            --jars hadoop-azure.jar,azure-storage.jar
            src/app.py 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­¤å¤–ï¼Œå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ Docker æˆ–å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°é›†ç¾¤ä¸­ï¼Œè¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªæç¤ºã€‚å¦‚æœé¢å¤–çš„ jar å·²ç»åœ¨æ­£ç¡®çš„ä½ç½® pyspark å¯ä»¥æ‰¾åˆ°å®ƒâ€”â€”å°±ä¸éœ€è¦ä¼ é€’é¢å¤–çš„ jar(å½“ç„¶ï¼Œéœ€è¦åœ¨æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šéƒ½è¿™æ ·åš)ã€‚å°å¿ƒä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤â€”ç‰ˆæœ¬/é“¾æ¥å¯èƒ½æ˜¯é”™è¯¯çš„ï¼

```
$ wget -nc -nv -O /usr/local/lib/python3.5/site-packages/pyspark/jars/azure-storage-2.2.0.jar http://central.maven.org/maven2/com/microsoft/azure/azure-storage/2.2.0/azure-storage-2.2.0.jar
$ wget -nc -nv -O /usr/local/lib/python3.5/site-packages/pyspark/jars/hadoop-azure-2.7.3.jar http://central.maven.org/maven2/org/apache/hadoop/hadoop-azure/2.7.3/hadoop-azure-2.7.3.jar 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨åº”ç”¨ç¨‹åºçº§åˆ«ï¼Œé¦–å…ˆï¼Œå’Œ spark åº”ç”¨ç¨‹åºä¸€æ ·ï¼Œæ‚¨éœ€è¦è·å–ä¸€ä¸ª Spark ä¼šè¯ã€‚Spark ä¼šè¯æ˜¯é›†ç¾¤èµ„æºçš„å…¥å£ç‚¹ï¼Œç”¨äºè¯»å–æ•°æ®å’Œå¯¹æ•°æ®æ‰§è¡Œ SQL æŸ¥è¯¢å¹¶è·å¾—ç»“æœã€‚

```
session = SparkSession.builder.getOrCreate() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åä¸ºä½ çš„ blob å®¹å™¨è®¾ç½®ä¸€ä¸ªè´¦æˆ·å¯†é’¥:

```
session.conf.set(
    "fs.azure.account.key.<storage-account-name>.blob.core.windows.net",
    "<your-storage-account-access-key>"
) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€… SAS ä»¤ç‰Œ:

```
session.conf.set(
    "fs.azure.sas.<container-name>.blob.core.windows.net",
    "<sas-token>"
) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦è®¾ç½®äº†å¸æˆ·è®¿é—®å¯†é’¥æˆ– SAS ä»¤ç‰Œï¼Œæ‚¨å°±å¯ä»¥è¯»å†™ Azure blob:

```
sdf = session.read.parquet(
    "wasbs://<container-name>@<storage-account-name>.blob.core.windows.net/<prefix>"
)
sdf.show() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

* * *

**æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼**

æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿè¯·åœ¨ä¸‹é¢ç•™ä¸‹æ‚¨çš„è¯„è®ºï¼Œå¼€å§‹ç²¾å½©çš„è®¨è®ºï¼

æŸ¥çœ‹æˆ‘çš„åšå®¢æˆ–æ¥æ‰“ä¸ªæ‹›å‘¼ğŸ‘‹åœ¨[æ¨ç‰¹](https://twitter.com/luminousmen)æˆ–è®¢é˜…[æˆ‘çš„ç”µæŠ¥é¢‘é“](https://t.me/iamluminousmen)ã€‚
åšå¥½ä½ çš„è®¡åˆ’ï¼