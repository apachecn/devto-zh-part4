# å¦‚ä½•ä½¿ç”¨ Particle å¼ºå¤§çš„è“ç‰™ Api

> åŸæ–‡:[https://dev . to/jaredwolff/how-to-use-particle-s-powerful-bluetooth-API-1gfp](https://dev.to/jaredwolff/how-to-use-particle-s-powerful-bluetooth-api-1gfp)

æˆ‘è¢«æ‰“è´¥äº†ã€‚

æˆ‘èŠ±äº†æ•´æ•´ä¸€ä¸ªæ™šä¸Šè¯•å›¾è®©ä¸€ä¸ªè“ç‰™ä½èƒ½è€—é¡¹ç›®å·¥ä½œã€‚å¾ˆç—›è‹¦ã€‚ä»¤äººæ²®ä¸§ã€‚æˆ‘å‡†å¤‡æ”¾å¼ƒäº†ã€‚

é‚£æ˜¯åœ¨è“ç‰™ä½èƒ½è€—çš„æ—©æœŸã€‚ä»é‚£æ—¶èµ·ï¼Œå®ƒå˜å¾—è¶Šæ¥è¶Šå®¹æ˜“å¼€å‘ã€‚ç²’å­ç½‘æ ¼è“ç‰™åº“ä¹Ÿä¸ä¾‹å¤–ã€‚

åœ¨æœ¬æ¼”ç»ƒä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ç²’å­çš„è“ç‰™ APIã€‚æˆ‘ä»¬å°†é…ç½®ä¸€äº› ledï¼Œå¹¶è§‚å¯Ÿå®ƒä»¬åœ¨ç½‘çŠ¶ç½‘ç»œä¸­æ‰€æœ‰è®¾å¤‡ä¸Šçš„å˜åŒ–ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ°©æ°™æ¿ã€‚

å‡†å¤‡å¥½äº†å—ï¼Ÿæˆ‘ä»¬å¼€å§‹å§ï¼

é™„:è¿™ä¸ªå¸–å­å¾ˆé•¿ã€‚å¦‚æœä½ æƒ³ä¸‹è½½ä¸€äº›ä¸œè¥¿ï¼Œç‚¹å‡»è¿™é‡Œè·å¾—ä¸€ä»½æ ¼å¼ç²¾ç¾çš„ PDF æ–‡ä»¶ã€‚

## [](#stage-1-setting-up-bluetooth)ç¬¬ä¸€é˜¶æ®µ:è®¾ç½®è“ç‰™

1.  [ä¸‹è½½/å®‰è£…ç²’å­å·¥ä½œå°](https://www.particle.io/workbench/)
2.  åˆ›å»ºæ–°é¡¹ç›®ã€‚æˆ‘æŒ‘é€‰äº†ä¸€ä¸ªåˆé€‚çš„åœ°ç‚¹ï¼Œç„¶åå‘½åä¸º`ble_mesh`

    [![Create a new Project in Particle Workbench](../Images/120006340f5f4afb6ca4ff3c678fdcbe.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--M3Du4xOY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-13_at_5-4348ea15-e220-4138-8d28-a8c5de99e9fe.32.11_PM.png)

3.  å»ä½ çš„`/src/`ç›®å½•å¹¶æ‰“å¼€ä½ çš„`<your project name>.ino`æ–‡ä»¶

4.  ç„¶åï¼Œç¡®ä¿æ‚¨å°†è®¾å¤‡æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬æ›´æ”¹ä¸º> **1.3.0**

    [![Select DeviceOS Version](../Images/4d49e724f96305c7065283b6e7db1a73.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--B95agg3B--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-13_at_5-9d20c90b-e27c-4609-9917-2ec1bb849727.40.15_PM.png)

### [](#write-the-code)ç¼–å†™ä»£ç 

æˆ‘ä»¬å¸Œæœ›å»ºç«‹ä¸€ä¸ªå…·æœ‰ 3 ä¸ªç‰¹å¾çš„æœåŠ¡ã€‚è¿™äº›ç‰¹æ€§åˆ†åˆ«ä¸ RGB LEDs çš„å¼ºåº¦ç›¸å…³ã€‚ä»¥ä¸‹æ˜¯è®¾ç½®è“ç‰™çš„æ–¹æ³•:

1.  åœ¨æ‚¨çš„`Setup()`åŠŸèƒ½ä¸­ï¼Œå¯ç”¨åº”ç”¨ç¨‹åºå¯¹ LED çš„æ§åˆ¶

    ```
    RGB.control(true); 
    ```

2.  åœ¨ä½ çš„`.ino`æ–‡ä»¶çš„é¡¶éƒ¨è®¾ç½®ä½ çš„ UUIDs

    ```
    const char* serviceUuid = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
    const char* red         = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E";
    const char* green       = "6E400003-B5A3-F393-E0A9-E50E24DCCA9E";
    const char* blue        = "6E400004-B5A3-F393-E0A9-E50E24DCCA9E"; 
    ```

    UUIDs æ˜¯å”¯ä¸€çš„æ ‡è¯†ç¬¦æˆ–åœ°å€ã€‚å®ƒä»¬ç”¨äºåŒºåˆ†è®¾å¤‡ä¸Šçš„ä¸åŒæœåŠ¡å’Œç‰¹æ€§ã€‚

    ä¸Šé¢çš„ UUIDs ç”¨åœ¨å‰é¢çš„ç²’å­ä¾‹å­ä¸­ã€‚å¦‚æœä½ æƒ³åˆ›å»ºè‡ªå·±çš„ï¼Œä½ å¯ä»¥åœ¨ OSX å‘½ä»¤è¡Œä½¿ç”¨`uuidgen`ã€‚ä¹Ÿå¯ä»¥å»ç±»ä¼¼ **[çš„ç½‘ç«™åœ¨çº¿ GUID ç”Ÿæˆå™¨](https://www.guidgenerator.com/online-guid-generator.aspx)ã€‚**

    [![Online GUID Generator](../Images/fa36cfc7be582703a19f1dbf45eed050.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--icItX-y9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-14_at_11-343e1df6-69e8-4560-98b9-f2f54caeb7d3.28.46_AM.png)

    ä½¿ç”¨ä»¥ä¸Šè®¾ç½®è·å¾—æ‚¨è‡ªå·±çš„ UUIDã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä»è¿™ä¸ªç”Ÿæˆçš„ UUIDS åˆ›å»ºæ‚¨çš„æœåŠ¡å’Œç‰¹å¾ UUIDS:

    ```
    const char* serviceUuid = "b425040**0**-fb4b-4746-b2b0-93f0e61122c6"; //service
    const char* red         = "b4250401-fb4b-4746-b2b0-93f0e61122c6"; //red char
    const char* green       = "b4250402-fb4b-4746-b2b0-93f0e61122c6"; //green char
    const char* blue        = "b4250403-fb4b-4746-b2b0-93f0e61122c6"; //blue char 
    ```

    åšè¿™ä»¶äº‹æ²¡æœ‰å¯¹é”™ä¹‹åˆ†ã€‚ä½†æ˜¯ä½ å¿…é¡»å°å¿ƒä¸è¦ä½¿ç”¨è“ç‰™ SIG ä¿ç•™çš„ UUIDsã€‚è¿™æ˜¯æä¸å¯èƒ½çš„ã€‚å¦‚æœä½ æƒ³ä»”ç»†æ£€æŸ¥ï¼Œä½ å¯ä»¥å»[è¿™é‡Œ](https://www.bluetooth.com/specifications/gatt/characteristics/)å’Œ[è¿™é‡Œ](https://www.bluetooth.com/specifications/gatt/services/)ã€‚

    ç°åœ¨ï¼Œæˆ‘ä»¬å°†åšæŒä½¿ç”¨ç¬¬ä¸€ç»„ UUIDsã€‚

3.  åœ¨`Setup()`ä¸­ï¼Œåˆå§‹åŒ–æ‚¨çš„æœåŠ¡ã€‚

    ```
    // Set the RGB BLE service
    BleUuid rgbService(serviceUuid); 
    ```

    è¿™æ˜¯â€œæ³¨å†Œâ€æ‚¨çš„æœåŠ¡çš„ç¬¬ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯æ›´å¤šç›¸å…³ä¿¡æ¯ã€‚

4.  åˆå§‹åŒ–`Setup()`ä¸­çš„æ¯ä¸ªç‰¹æ€§

    ```
    BleCharacteristic redCharacteristic("red", BleCharacteristicProperty::WRITE_WO_RSP, red, serviceUuid, onDataReceived, (void*)red);
    BleCharacteristic greenCharacteristic("green", BleCharacteristicProperty::WRITE_WO_RSP, green, serviceUuid, onDataReceived, (void*)green);
    BleCharacteristic blueCharacteristic("blue", BleCharacteristicProperty::WRITE_WO_RSP, blue, serviceUuid, onDataReceived, (void*)blue); 
    ```

    å¯¹äºè¿™ä¸ªè®¾ç½®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`WRITE_WO_RSP`å±æ€§ã€‚è¿™å…è®¸æˆ‘ä»¬å†™å…¥æ•°æ®ï¼Œå¹¶ä¸”ä¸æœŸæœ›ä»»ä½•å“åº”ã€‚
    æˆ‘å¼•ç”¨äº† UUIDs ä½œä¸ºæ¥ä¸‹æ¥çš„ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªæ˜¯å…¸å‹çš„ UUIDã€‚ç¬¬äºŒä¸ªæ˜¯æœåŠ¡ UUIDã€‚

    ä¸‹ä¸€ä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°ã€‚å½“æ•°æ®è¢«å†™å…¥è¿™ä¸ªå›è°ƒæ—¶ï¼Œè¿™ä¸ªå‡½æ•°å°†è¢«æ¿€å‘ã€‚

    æœ€åï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¸Šä¸‹æ–‡ã€‚è¿™åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæˆ‘ä»¬å¯¹æ‰€æœ‰ä¸‰ä¸ªç‰¹å¾ä½¿ç”¨ç›¸åŒçš„å›è°ƒã€‚æˆ‘ä»¬çŸ¥é“å“ªä¸ªç‰¹å¾è¢«å†™å…¥äº†(è‡³å°‘åœ¨ deviceOS ä¸­)çš„å”¯ä¸€æ–¹æ³•æ˜¯è®¾ç½®ä¸€ä¸ªä¸Šä¸‹æ–‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å·²ç»å¯ç”¨çš„ UUIDsã€‚

5.  å®šä¹‰ç‰¹å¾åï¼Œè®©æˆ‘ä»¬æ·»åŠ å®ƒä»¬ï¼Œè¿™æ ·å®ƒä»¬å°±ä¼šæ˜¾ç¤ºå‡ºæ¥:

    ```
    // Add the characteristics
    BLE.addCharacteristic(redCharacteristic);
    BLE.addCharacteristic(greenCharacteristic);
    BLE.addCharacteristic(blueCharacteristic); 
    ```

6.  è®¾ç½®å›è°ƒå‡½æ•°ã€‚

    ```
    // Static function for handling Bluetooth Low Energy callbacks
    static void onDataReceived(const uint8_t* data, size_t len, const BlePeerDevice& peer, void* context) {

    } 
    ```

    ä½ å¯ä»¥åœ¨æ–‡ä»¶çš„é¡¶éƒ¨è¿™æ ·åš(åœ¨`Setup()`ä¸Šé¢),æˆ‘ä»¬ç¨åä¼šè¯¦ç»†è¯´æ˜ã€‚

7.  æœ€åï¼Œä¸ºäº†è®©æ‚¨çš„è®¾å¤‡å¯ä»¥è¿æ¥ï¼Œæˆ‘ä»¬å¿…é¡»è®¾ç½®å¹¿å‘Šã€‚å°†è¿™æ®µä»£ç æ”¾åœ¨æ‚¨çš„`Setup()`å‡½æ•°çš„æœ«å°¾

    ```
    // Advertising data
    BleAdvertisingData advData;

    // Add the RGB LED service
    advData.appendServiceUUID(rgbService);

    // Start advertising!
    BLE.advertise(&advData); 
    ```

    é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`BleAdvertisingData`å¯¹è±¡ã€‚æˆ‘ä»¬æ·»åŠ æ­¥éª¤ 3 ä¸­çš„`rgbService`ã€‚æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹åšå¹¿å‘Šï¼Œè¿™æ ·æˆ‘ä»¬çš„æœåŠ¡å’Œç‰¹è‰²å°±å¯ä»¥è¢«å‘ç°äº†ï¼

### [](#time-to-test)æµ‹è¯•æ—¶é—´

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæœ€ä½é™åº¦çš„å¯è¡Œè®¡åˆ’ã€‚è®©æˆ‘ä»¬ç¼–è¯‘å®ƒï¼Œå¹¶å°†å…¶ç¼–ç¨‹åˆ°æˆ‘ä»¬çš„ç²’å­ç¡¬ä»¶ã€‚è¿™åº”è¯¥é€‚ç”¨äºä»»ä½•æ”¯æŒç½‘æ ¼çš„è®¾å¤‡ã€‚(æ°™ã€æ°©ã€ç¡¼)

1.  åœ¨æˆ‘ä»¬å¼€å§‹æµ‹è¯•ä¹‹å‰ï¼Œæš‚æ—¶å°†`SYSTEM_MODE(MANUAL);`æ·»åŠ åˆ°æ–‡ä»¶çš„é¡¶éƒ¨ã€‚è¿™å°†é˜»æ­¢è®¾å¤‡è¿æ¥åˆ°ç½‘çŠ¶ç½‘ç»œã€‚å¦‚æœè®¾å¤‡åœ¨å¯åŠ¨æ—¶é—ªç€è“å…‰ï¼Œä½ å¿…é¡»åœ¨ç»§ç»­ä¹‹å‰ç”¨[ç²’å­åº”ç”¨](https://apps.apple.com/ru/app/particle-iot/id991459054?l=en)è®¾ç½®å®ƒã€‚
2.  [åœ¨æ­¤ä¸‹è½½ 1.3.0-rc.1 é•œåƒã€‚](https://github.com/particle-iot/device-os/releases/tag/v1.3.0-rc.1)å¯¹äºæ°™æ°”ï¼Œä½ éœ€è¦ **[æ°™æ°”-ç³»ç»Ÿ-part1@1.3.0-rc.1.bin](mailto:xenon-system-part1@1.3.0-rc.1.bin) ã€‚**å¯¹äºå…¶ä»–ï¼ŒæŸ¥æ‰¾ **[ç¡¼-ç³»ç»Ÿ-part1@1.3.0-rc.1.bin](mailto:boron-system-part1@1.3.0-rc.1.bin)** å’Œ **[æ°©-ç³»ç»Ÿ-part1@1.3.0-rc.1.bin](mailto:argon-system-part1@1.3.0-rc.1.bin) ã€‚**æ–‡ä»¶åœ¨é¡µé¢åº•éƒ¨çš„**èµ„äº§**ä¸‹

    [![Assets location on DeviceOS Release Page](../Images/ccf2e06f76ef44f88911a1ec2be22a87.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--wJDAZVYe--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-14_at_11-df9b46f4-e230-484e-b69e-828526f5566e.39.39_AM.png)

3.  å°†æ‚¨çš„è®¾å¤‡ç½®äº DFU æ¨¡å¼ã€‚æŒ‰ä½**æ¨¡å¼æŒ‰é’®**ï¼Œç¬é—´ç‚¹å‡»**å¤ä½** **æŒ‰é’®ã€‚**ç»§ç»­æŒ‰ä½**æ¨¡å¼æŒ‰é’®**ç›´åˆ° LED é—ªçƒé»„è‰²ã€‚

4.  åœ¨å‘½ä»¤è¡Œçª—å£ä¸­ï¼Œå°†ç›®å½•æ›´æ”¹ä¸ºå­˜å‚¨ä¸‹è½½æ–‡ä»¶çš„ä½ç½®ã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œå‘½ä»¤æ˜¯`cd ~/Downloads/`

5.  ç„¶åè¿è¡Œ:

    ```
    particle flash --usb xenon-system-part1@1.3.0-rc.1.bin 
    ```

    è¿™å°†å®‰è£…æœ€æ–°çš„æ“ä½œç³»ç»Ÿåˆ°ä½ çš„æ°™ã€‚ä¸€æ—¦å®Œæˆï¼Œå®ƒå°†ç»§ç»­å¿«é€Ÿé—ªçƒé»„è‰²ã€‚åŒæ ·ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªä¸åŒçš„ç²’å­ç½‘æ ¼è®¾å¤‡ï¼Œæ”¹å˜æ–‡ä»¶åæ¥åŒ¹é…ã€‚

6.  åœ¨å¯è§†åŒ–ä»£ç ä¸­ï¼Œä½¿ç”¨ **Command + Shift + P** ç»„åˆé”®å¼¹å‡ºå‘½ä»¤èœå•ã€‚é€‰æ‹©**ç²’å­:ç¼–è¯‘åº”ç”¨ç¨‹åº(æœ¬åœ°)**

    [![Compile application (local) choice](../Images/066af8396591003363173698c85020be.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--gddvjdBv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-13_at_10-8cb8dda2-73ae-4b0d-af5b-33892d66752e.52.19_PM.png)

7.  ä¿®å¤ä»»ä½•å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚

8.  ç„¶åï¼Œæ‰“å¼€åŒä¸€èœå•ï¼Œé€‰æ‹© **Flash åº”ç”¨ç¨‹åº(æœ¬åœ°)**

    [![Flash application (local) choice](../Images/d0a3f7b9d0f3a9da6cce5c92ffa0af90.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--_hrAXN9K--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-13_at_10-4ff7bc95-58f1-497f-9edf-9eadb69e3abb.51.59_PM.png)

9.  ç¼–ç¨‹å®Œæˆåï¼Œæ‹¿å‡ºæ‰‹æœºã€‚ç„¶åï¼Œæ‰“å¼€ä½ æœ€å–œæ¬¢çš„è“ç‰™ä½èƒ½è€— appã€‚æœ€å¥½çš„æ˜¯ **[NRF è¿æ¥](https://apps.apple.com/cn/app/nrf-connect/id1054362403?l=en)** å’Œ **[æµ…è“è‰²æ¢ç´¢è€…ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨æµ…è“è‰²çš„æµè§ˆå™¨ã€‚](https://apps.apple.com/ru/app/lightblue-explorer/id557428110?l=en)**

10.  æ£€æŸ¥ä¸€ä¸ªåä¸º**â€œXenon-â€**çš„è®¾å¤‡æ˜¯å¦åœ¨åšå¹¿å‘Šã€‚ä¸ºæ‚¨çš„è®¾å¤‡æ’å…¥å¸¦æœ‰å”¯ä¸€ ID çš„**ã€‚**

     **[![Light Blue Explorer Scan Results](../Images/cc9a54f657948f62abdf17ccfe618bfb.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ar-UuVom--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2187-aa8b88cc-f423-4b5a-8bb0-e1f75c3b7dd9.png)** 
***   æ‰¾åˆ°æ‚¨çš„è®¾å¤‡å¹¶å•å‡»åç§°ã€‚

    *   æŸ¥çœ‹æœåŠ¡å’Œç‰¹æ€§åˆ—è¡¨ã€‚åŒ…æ‹¬æˆ‘ä»¬ç›®å‰è®¾å®šçš„æœåŠ¡å’Œç‰¹è‰² UUID å—ï¼Ÿä¾‹å¦‚ï¼ŒæœåŠ¡ UUID æ˜¯å¦æ˜¾ç¤ºä¸º**6e 400001-b5 a3-F393-e0a 9-e 50 e 24 DCCA 9 e**ï¼Ÿ

    [![Confirm Light Blue Explorer has new characteristic UUIDs](../Images/1260740c4755b887bdb635dd0c5cd3d3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--fR_5i-mA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2188-d7759af0-964e-4067-9ca2-d78edd190410.png)

    å¦‚æœä¸€åˆ‡éƒ½å¦‚ä½ æ‰€æ–™ï¼Œä½ å°±åœ¨ä¸€ä¸ªå¥½åœ°æ–¹ã€‚å¦‚æœä¸åŒ¹é…ï¼Œè¯·ä»”ç»†é˜…è¯»å‰é¢çš„è¯´æ˜ï¼Œç¡®ä¿ä¸€åˆ‡åŒ¹é…ã€‚** 

 **## [](#stage-2-handling-data)ç¬¬äºŒé˜¶æ®µ:å¤„ç†æ•°æ®

æˆ‘ä»¬é¡¹ç›®çš„ä¸‹ä¸€æ­¥æ˜¯å¤„ç†å†™äº‹ä»¶ã€‚æˆ‘ä»¬å°†æ›´æ–°æˆ‘ä»¬çš„`onDataReceived`åŠŸèƒ½ã€‚

### [](#write-the-code)ç¼–å†™ä»£ç 

1.  é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¿æŒ led çŠ¶æ€çš„ç»“æ„ã€‚è¿™å¯ä»¥åœ¨æ–‡ä»¶çš„é¡¶éƒ¨å®Œæˆã€‚

    ```
    // Variables for keeping state
    typedef struct {
      uint8_t red;
      uint8_t green;
      uint8_t blue;
    } led_level_t; 
    ```

2.  ç¬¬äºŒéƒ¨åˆ†æ˜¯ä½¿ç”¨è¿™ä¸ªæ•°æ®ç±»å‹åˆ›å»ºä¸€ä¸ªé™æ€å˜é‡

    ```
    // Static level tracking
    static led_level_t m_led_level; 
    ```

    å‰ä¸¤æ­¥å…è®¸æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥è¡¨ç¤º RGB LED çš„ä¸‰ä¸ªå€¼ã€‚

3.  æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹`onDataReceive`å‡½æ•°ä¸­çš„åŸºæœ¬é”™è¯¯ï¼Œä¾‹å¦‚æˆ‘ä»¬æƒ³ç¡®ä¿æˆ‘ä»¬åªæ¥æ”¶ä¸€ä¸ªå­—èŠ‚ã€‚

    ```
    // We're only looking for one byte
      if( len != 1 ) {
        return;
        } 
    ```

4.  æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æƒ³çœ‹çœ‹è¿™ä¸ªäº‹ä»¶æ¥è‡ªå“ªä¸ªç‰¹å¾ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`context`å˜é‡æ¥ç¡®å®šè¿™ä¸€ç‚¹ã€‚

    ```
    // Sets the global level
      if( context == red ) {
        m_led_level.red = data[0];
      } else if ( context == green ) {
        m_led_level.green = data[0];
      } else if ( context == blue ) {
        m_led_level.blue = data[0];
      } 
    ```

    è®°ä½ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸Šä¸‹æ–‡å°†ç­‰äºçº¢è‰²ã€ç»¿è‰²æˆ–è“è‰² UUID å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚ä½ ä¹Ÿå¯ä»¥æ³¨æ„åˆ°æˆ‘ä»¬æ­£åœ¨è®¾ç½®`m_led_level`ã€‚è¿™æ ·ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªå€¼å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ›´æ–° RGB ledã€‚

5.  æœ€åï¼Œä¸€æ—¦è®¾ç½®å®Œæ¯•ï¼Œæ‚¨å°±å¯ä»¥å†™å…¥`RGB`å¯¹è±¡

    ```
    // Set RGB color
        RGB.color(m_led_level.red, m_led_level.green, m_led_level.blue); 
    ```

### [](#test-the-code)æµ‹è¯•ä»£ç 

è®©æˆ‘ä»¬æŒ‰ç…§ä¸ä¹‹å‰ç›¸åŒçš„æ­¥éª¤æ¥åˆ·æ–°è®¾å¤‡ã€‚

1.  å°†æ‚¨çš„è®¾å¤‡ç½®äº DFU æ¨¡å¼ã€‚æŒ‰ä½**æ¨¡å¼æŒ‰é’®**ï¼Œç‚¹å‡»**å¤ä½** **æŒ‰é’®ã€‚**ç»§ç»­æŒ‰ä½**æ¨¡å¼æŒ‰é’®**ç›´åˆ° LED é—ªçƒé»„è‰²ã€‚
2.  ç„¶åï¼Œæ‰“å¼€åŒä¸€èœå•ï¼Œé€‰æ‹© **Flash åº”ç”¨ç¨‹åº(æœ¬åœ°)**

    [![Flash application (local) choice](../Images/d0a3f7b9d0f3a9da6cce5c92ffa0af90.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--_hrAXN9K--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-13_at_10-4ff7bc95-58f1-497f-9edf-9eadb69e3abb.51.59_PM.png)

3.  ç¼–ç¨‹å®Œæˆåï¼Œä½¿ç”¨**æµ…è“è‰²æµè§ˆå™¨**è¿æ¥åˆ°è®¾å¤‡ã€‚

4.  ç‚¹å‡»é€‚ç”¨äºçº¢è‰² LED çš„ç‰¹æ€§ã€‚

5.  **å†™ FF** ã€‚çº¢è‰² LED åº”è¯¥ä¼šäº®èµ·ã€‚

    [![Write new value choice](../Images/4ca4fa8c0d05e168a294b8432fd9f273.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--HnuXhVXz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2191-b8ad0693-f4f8-4828-ae99-b0a0e204cc50.jpg)

    [![Write the hex value of 0xff](../Images/005fa1f8fc05d07c638838be2b62943e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--7uikPJDl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2190-2c799875-22e5-44bc-9edc-c647cf8669f6.png)

6.  **å†™ 00** ã€‚çº¢è‰² LED åº”è¯¥ç†„ç­ã€‚

7.  å¯¹å…¶ä»–ä¸¤ä¸ªç‰¹å¾åšåŒæ ·çš„æ“ä½œã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡è“ç‰™ä½èƒ½è€—å®Œå…¨æ§åˆ¶ RGB LEDï¼

## [](#stage-3-sharing-via-mesh)ç¬¬ä¸‰é˜¶æ®µ:é€šè¿‡ç½‘æ ¼å…±äº«

æœ€åï¼Œç°åœ¨æˆ‘ä»¬æˆåŠŸåœ°æ¥æ”¶åˆ°äº† BLE æ¶ˆæ¯ï¼Œæ˜¯æ—¶å€™å°†å®ƒä»¬è½¬å‘åˆ°æˆ‘ä»¬çš„ç½‘çŠ¶ç½‘ç»œäº†ã€‚

### [](#write-the-code)ç¼–å†™ä»£ç 

1.  é¦–å…ˆè®©æˆ‘ä»¬å–æ¶ˆæ‰‹åŠ¨æ¨¡å¼ã€‚æ³¨é‡Šæ‰`SYSTEM_MODE(MANUAL);`
2.  åœ¨æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå˜é‡ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å‘å¸ƒï¼Œæˆ‘ä»¬å°†ç”¨å®ƒæ¥è·Ÿè¸ª

    ```
    // Tracks when to publish to Mesh
    static bool m_publish; 
    ```

3.  ç„¶ååœ¨`Setup()`ä¸­åˆå§‹åŒ–

    ```
    // Set to false at first
    m_publish = false; 
    ```

4.  ç„¶åï¼Œåœ¨`onDataReceived`å›è°ƒä¸­è®¾ç½® RGB led åï¼Œè®©æˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º true:

    ```
    // Set RGB color
    RGB.color(m_led_level.red, m_led_level.green, m_led_level.blue);

    // Set to publish
    m_publish = true; 
    ```

5.  è®©æˆ‘ä»¬åœ¨`loop()`å‡½æ•°ä¸­æ·»åŠ ä¸€ä¸ªæ¡ä»¶ã€‚è¿™å°†å¯¼è‡´æˆ‘ä»¬å‘ç½‘çŠ¶ç½‘ç»œå‘å¸ƒ LED çŠ¶æ€:

    ```
    if( m_publish ) {
        // Reset flag
        m_publish = false;

        // Publish to Mesh
      Mesh.publish("red", String::format("%d", m_led_level.red));
      Mesh.publish("green", String::format("%d", m_led_level.green));
      Mesh.publish("blue", String::format("%d", m_led_level.blue));
    } 
    ```

    `Mesh.publish`ä¸¤ä¸ªè¾“å…¥éƒ½éœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨`String::format`æ¥åˆ›å»ºä¸€ä¸ªåŒ…å«çº¢è‰²ã€ç»¿è‰²å’Œè“è‰²å€¼çš„å­—ç¬¦ä¸²ã€‚

6.  é‚£ä¹ˆè®©æˆ‘ä»¬è®¢é˜…`Setup()`ä¸­çš„ç›¸åŒå˜é‡ã€‚è¿™æ ·ï¼Œå¦ä¸€ä¸ªè®¾å¤‡ä¹Ÿå¯ä»¥ä½¿è¯¥è®¾å¤‡ä¸Šçš„ LED æ›´æ–°ã€‚

    ```
    Mesh.subscribe("red", meshHandler);
    Mesh.subscribe("green", meshHandler);
    Mesh.subscribe("blue", meshHandler); 
    ```

7.  åœ¨æˆ‘ä»¬æƒ³è¦åˆ›å»ºçš„æ–‡ä»¶çš„é¡¶ç«¯`meshHandler`

    ```
    // Mesh event handler
    static void meshHandler(const char *event, const char *data)
    {
    } 
    ```

8.  åœ¨è¿™ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬éœ€è¦`event`å‚æ•°å’Œ`data`å‚æ•°ã€‚ä¸ºäº†ä½¿ç”¨å®ƒä»¬ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠå®ƒä»¬æ”¹æˆ`String`å‹ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…ç½®çš„è½¬æ¢å’Œæ¯”è¾ƒåŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œåœ¨`meshHandler`å‡½æ•°é‡Œé¢æ·»åŠ :

    ```
     // Convert to String for useful conversion and comparison functions
      String eventString = String(event);
      String dataString = String(data); 
    ```

9.  æœ€åæˆ‘ä»¬åšäº†ä¸€äº›æ¯”è¾ƒã€‚æˆ‘ä»¬é¦–å…ˆæ£€æŸ¥äº‹ä»¶åç§°æ˜¯å¦åŒ¹é…ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†`dataString`çš„å€¼è®¾ç½®ä¸ºç›¸åº”çš„ led çº§åˆ«ã€‚

    ```
     // Determine which event we recieved
      if( eventString.equals("red") ) {
        m_led_level.red = dataString.toInt();
      } else if ( eventString.equals("green") ) {
        m_led_level.green = dataString.toInt();
      } else if ( eventString.equals("blue") ) {
        m_led_level.blue = dataString.toInt();
      } else {
            return;
        }

      // Set RGB color
      RGB.color(m_led_level.red, m_led_level.green, m_led_level.blue); 
    ```

    ç„¶ååœ¨æœ€åæˆ‘ä»¬è®¾ç½®æ–°çš„ RGB é¢œè‰²ã€‚æ³¨æ„æˆ‘æ˜¯å¦‚ä½•é€šè¿‡åœ¨`else`éƒ¨åˆ†æ·»åŠ ä¸€ä¸ª`return`è¯­å¥æ¥å¤„ç†æœªçŸ¥çŠ¶æ€çš„ã€‚åœ¨é”™è¯¯æ¡ä»¶é€ æˆä¸¥é‡ç ´åä¹‹å‰è¿‡æ»¤æ‰å®ƒä»¬æ€»æ˜¯å¥½çš„ï¼

### [](#test-the-code)æµ‹è¯•ä»£ç 

1.  æ‰“å¼€æ‰‹æœºä¸Šçš„ç²’å­åº”ç”¨ç¨‹åº
2.  è®©æˆ‘ä»¬å…ˆè®¾ç½®æ°©æ°”ã€‚**å¦‚æœä¸æ˜¯é—ªçƒçš„è“è‰²ï¼ŒæŒ‰ä½æ¨¡å¼æŒ‰é’®ç›´åˆ°å®ƒé—ªçƒè“è‰²ã€‚**

    [![Particle Argon with Blue LED](../Images/14fe33766302285e40b40906912d3da9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--THW0VU3F--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_1216-f78725ab-a9f5-4270-b389-73d6dddb1f62.jpg)

    æ³¨:å¦‚æœæ‚¨å·²ç»å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œäº†ç¼–ç¨‹ï¼ŒLED å°†é»˜è®¤å…³é—­ã€‚**æŒ‰ä½æ¨¡å¼æŒ‰é’® 5 ç§’é’Ÿï¼Œç„¶åç»§ç»­ã€‚**

3.  å®Œæˆé…å¯¹è¿‡ç¨‹ã€‚è¿™ä¸ªåº”ç”¨ç¨‹åºä¼šå¼•å¯¼ä½ å®Œæˆæ‰€æœ‰çš„æ­¥éª¤ã€‚ç¡®ä¿æ‚¨è®°ä½äº†ç½‘çŠ¶ç½‘ç»œçš„ç®¡ç†å‘˜å¯†ç ã€‚

    [![Particle Setup App Board Choice](../Images/d4288bd8a0e6a4c65840d3d1851d55e5.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--omHZeUvv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2194-2482aa12-082c-4786-8883-860b50b4cd53.png)

    [![Scan the sticker](../Images/5ae1c75cec6ddce0f39764f82e12eb60.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--NokXqnuT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2195-2d030603-e59f-4e76-9d1a-9d4f2c078a4e.png)

    [![Pairing with your Argon](../Images/b0558d0dde0f456bdc01150ce62dba79.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--k0koPkrv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2198-80bb83d8-818b-4cd8-a583-9262da9b5121.png)

    [![Enter wifi password](../Images/0afaa93161a0a3fa71b86792c16fb913.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Mk6l7pLl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2199-e3c107dd-2704-4aa3-9781-550ad14ea7fc.png)

4.  ä½¿ç”¨æœ€æ–°å›ºä»¶(1.3.0)å¯¹æ°©æ°”è¿›è¡Œç¼–ç¨‹(å‚è§**é˜¶æ®µ 1 -æµ‹è¯•æ—¶é—´-æ­¥éª¤ 2** äº†è§£å¦‚ä½•è¿›è¡Œè¯¥æ“ä½œ)

5.  ä¸€æ—¦å¿«é€Ÿé—ªçƒé»„è‰²ï¼Œç”¨ Tinker åº”ç”¨ç¨‹åºç¼–ç¨‹æ°©æ°”ã€‚å¯ä»¥åœ¨[å‘å¸ƒé¡µé¢](https://github.com/particle-iot/device-os/releases/tag/v1.3.0-rc.1)ä¸‹è½½ã€‚

6.  ä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ¼‚äº®çš„å›ºæ€é’è‰² LED(è¿æ¥åˆ°ç²’å­äº‘)ï¼Œæˆ‘ä»¬å°†ç¼–ç¨‹åº”ç”¨ç¨‹åºã€‚ä½¿ç”¨ä¸‹æ‹‰èœå•ä¸­çš„**äº‘é—ª**é€‰é¡¹ã€‚

    [![Cloud Flash option](../Images/4f455ea9cb6a7ada6e30184e4759bbd7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--UQOXwX7s--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-15_at_9-a50458b1-ade1-4d4d-818b-ef214f3fec5d.55.19_AM.png)

    æ®æˆ‘æ‰€çŸ¥ï¼Œå½“è¿æ¥åˆ°äº‘æ—¶ï¼ŒParticle ä¼šå¼ºåˆ¶ä»»ä½•è®¾å¤‡åœ¨æœ¬åœ°é—ªé€Ÿè¿›å…¥å®‰å…¨æ¨¡å¼ã€‚å¯èƒ½æ˜¯æˆ‘è®¾çš„å¥—ã€‚æ‚¨çš„é‡Œç¨‹å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚æœ€å¥½ç”¨**äº‘é—ª**ã€‚

    ç¡®ä¿æ‚¨é€‰æ‹©äº†æ­£ç¡®çš„è®¾å¤‡æ“ä½œç³»ç»Ÿç‰ˆæœ¬( **1.3.0-rc1** )ã€è®¾å¤‡ç±»å‹(**æ°©**)å’Œè®¾å¤‡åç§°(**æ‚¨åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å‘½åçš„åç§°**)

7.  ä½¿ç”¨**æ‰‹æœºåº”ç”¨**è¿æ¥æ°™æ°”ç¯

8.  ä½¿ç”¨æ‰‹æœºåº”ç”¨ç¨‹åºå°† Xenon è¿æ¥åˆ°æ‚¨çš„ç½‘çŠ¶ç½‘ç»œ

9.  ä½¿ç”¨**äº‘é—ª**æ¥é—ªçƒä½ çš„æ°™æ°”ç¯ã€‚ä½¿ç”¨æ‚¨åœ¨è®¾ç½®æ‰‹æœºåº”ç”¨ç¨‹åºæ—¶æä¾›çš„åç§°ã€‚åªè¦è®¾å¤‡è¿æ¥åˆ°ç²’å­äº‘æˆ–å¤„äºå®‰å…¨æ¨¡å¼(ç´«è‰² LED)ï¼Œå®ƒå°±åº”è¯¥å¯ä»¥ç¼–ç¨‹ã€‚

    [![Confirm board type, deviceOS version and device name](../Images/a3bf6bf9460340f92739d2bd6fb81bf7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--q_Oht98h--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-15_at_10-2f76843b-3cee-4818-adfb-7ece4173df2d.06.32_AM.png)

    [![Cloud flash option](../Images/4701421dccb5c7459c3444b317ad2256.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--MAPg3brV--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/Screen_Shot_2019-07-15_at_10-8e140009-440c-480d-838e-b83c782a8c96.08.47_AM.png)

10.  ä¸€æ—¦è¿æ¥ä¸Šï¼Œè®©æˆ‘ä»¬å¼€å§‹æœ‰è¶£çš„éƒ¨åˆ†ã€‚æ‰“å¼€**æµ…è“è‰²æ¢ç´¢è€…ã€‚**è¿æ¥åˆ°**æ°©æ°”**æˆ–**æ°™æ°”**ã€‚

    [![Select either the Argon or Xenon](../Images/35390fdeea3e2a98535f086d79f42b51.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--GgwjVTds--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_2200-e1c513ba-6689-4652-b442-e5c6f916d619.png)

11.  é€‰æ‹©ä¸€ä¸ª LED ç‰¹æ€§å¹¶æ›´æ”¹å€¼ã€‚

    [![Argon and Xenon with red LEDs on](../Images/956175870f7b8046be98fa2b6328c80e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--e64DhxkR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-use-particles-powerful-bluetooth-api/images/IMG_0627-2db8ab26-99e1-46a2-9583-97126fbe2594.jpg)

    æ‰€æœ‰è®¾å¤‡ä¸Šçš„æŒ‡ç¤ºç¯éƒ½åº”è¯¥æ”¹å˜ï¼

## [](#final-code)æœ€ç»ˆä»£ç 

è¿™æ˜¯æ‰€æœ‰éƒ¨åˆ†ç»„åˆåœ¨ä¸€èµ·çš„æœ€ç»ˆä»£ç ã€‚ä½ å¯ä»¥ç”¨è¿™ä¸ªæ¥ç¡®ä¿ä½ æŠŠå®ƒä»¬æ”¾åœ¨æ­£ç¡®çš„åœ°æ–¹ï¼ï¼

```
/*
  * Project ble_mesh
  * Description: Bluetooth Low Energy + Mesh Example
  * Author: Jared Wolff
  * Date: 7/13/2019
  */

//SYSTEM_MODE(MANUAL);

// UUIDs for service + characteristics
const char* serviceUuid = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
const char* red         = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E";
const char* green       = "6E400003-B5A3-F393-E0A9-E50E24DCCA9E";
const char* blue        = "6E400004-B5A3-F393-E0A9-E50E24DCCA9E";

// Set the RGB BLE service
BleUuid rgbService(serviceUuid);

// Variables for keeping state
typedef struct {
  uint8_t red;
  uint8_t green;
  uint8_t blue;
} led_level_t;

// Static level tracking
static led_level_t m_led_level;

// Tracks when to publish to Mesh
static bool m_publish;

// Mesh event handler
static void meshHandler(const char *event, const char *data)
{

  // Convert to String for useful conversion and comparison functions
  String eventString = String(event);
  String dataString = String(data);

  // Determine which event we recieved
  if( eventString.equals("red") ) {
    m_led_level.red = dataString.toInt();
  } else if ( eventString.equals("green") ) {
    m_led_level.green = dataString.toInt();
  } else if ( eventString.equals("blue") ) {
    m_led_level.blue = dataString.toInt();
  } else {
    return;
  }

  // Set RGB color
  RGB.color(m_led_level.red, m_led_level.green, m_led_level.blue);

}

// Static function for handling Bluetooth Low Energy callbacks
static void onDataReceived(const uint8_t* data, size_t len, const BlePeerDevice& peer, void* context) {

  // We're only looking for one byte
  if( len != 1 ) {
    return;
  }

  // Sets the global level
  if( context == red ) {
    m_led_level.red = data[0];
  } else if ( context == green ) {
    m_led_level.green = data[0];
  } else if ( context == blue ) {
    m_led_level.blue = data[0];
  }

  // Set RGB color
  RGB.color(m_led_level.red, m_led_level.green, m_led_level.blue);

  // Set to publish
  m_publish = true;

}

// setup() runs once, when the device is first turned on.
void setup() {

  // Enable app control of LED
  RGB.control(true);

  // Init default level
  m_led_level.red = 0;
  m_led_level.green = 0;
  m_led_level.blue = 0;

  // Set to false at first
  m_publish = false;

  // Set the subscription for Mesh updates
  Mesh.subscribe("red",meshHandler);
  Mesh.subscribe("green",meshHandler);
  Mesh.subscribe("blue",meshHandler);

  // Set up characteristics
  BleCharacteristic redCharacteristic("red", BleCharacteristicProperty::WRITE_WO_RSP, red, serviceUuid, onDataReceived, (void*)red);
  BleCharacteristic greenCharacteristic("green", BleCharacteristicProperty::WRITE_WO_RSP, green, serviceUuid, onDataReceived, (void*)green);
  BleCharacteristic blueCharacteristic("blue", BleCharacteristicProperty::WRITE_WO_RSP, blue, serviceUuid, onDataReceived, (void*)blue);

  // Add the characteristics
  BLE.addCharacteristic(redCharacteristic);
  BLE.addCharacteristic(greenCharacteristic);
  BLE.addCharacteristic(blueCharacteristic);

  // Advertising data
  BleAdvertisingData advData;

  // Add the RGB LED service
  advData.appendServiceUUID(rgbService);

  // Start advertising!
  BLE.advertise(&advData);
}

// loop() runs over and over again, as quickly as it can execute.
void loop() {

  // Checks the publish flag,
  // Publishes to a variable called "red" "green" and "blue"
  if( m_publish ) {

    // Reset flag
    m_publish = false;

    // Publish to Mesh
    Mesh.publish("red", String::format("%d", m_led_level.red));
    Mesh.publish("green", String::format("%d", m_led_level.green));
    Mesh.publish("blue", String::format("%d", m_led_level.blue));
  }

} 
```

## [](#conclusion)ç»“è®º

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæ‚¨å­¦ä¹ äº†å¦‚ä½•å°†è“ç‰™æ·»åŠ åˆ°ç²’å­ç½‘æ ¼é¡¹ç›®ä¸­ã€‚å¯ä»¥æƒ³è±¡ï¼Œå¯èƒ½æ€§æ˜¯æ— ç©·æ— å°½çš„ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†ç”¨æˆ·/ç®¡ç†åº”ç”¨ç¨‹åºæ·»åŠ åˆ°ä½“éªŒä¸­ã€‚è¿™å¤ªæ£’äº†ã€‚ğŸ˜

ä½ å¯ä»¥åœ¨æˆ‘å³å°†å‡ºç‰ˆçš„ä¹¦ä¸­æœŸå¾…æ›´å¤šè¿™æ ·çš„å†…å®¹: ***ç²’å­ç½‘æ ¼ç»ˆææŒ‡å—*** ã€‚è®¢é˜…æˆ‘çš„åˆ—è¡¨ä»¥è·å–æ›´æ–°å’Œå†…éƒ¨å†…å®¹ã€‚æ­¤å¤–ï¼Œæ‰€æœ‰æ—©æœŸè®¢æˆ·åœ¨å‘è¡Œæ—¶éƒ½å¯ä»¥äº«å—æŠ˜æ‰£ï¼[ç‚¹å‡»è¿™é‡ŒæŠ¥åã€‚](https://www.jaredwolff.com/the-ultimate-guide-to-particle-mesh)**