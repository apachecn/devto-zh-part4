# ç¬¬ 024 é›†-æ•´åˆèº«ä»½æœåŠ¡å™¨ 4 -ç¬¬ 4 éƒ¨åˆ†-æ­£é¢èƒŒå-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°è¿‡åº¦æ€æˆ®

> åŸæ–‡ï¼š<https://dev.to/joaofbantunes/episode-024-integrating-identityserver4-part-4-back-for-front-asp-net-core-from-0-to-overkill-58cp>

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å‰ç«¯çš„åç«¯ï¼Œä»¥åŠå®ƒå¤„ç†ç”¨æˆ·è®¤è¯ã€é‡å®šå‘åˆ°èº«ä»½æä¾›è€…(IdentityServer4 powered auth æœåŠ¡)ã€åœ¨è¿›è¡Œ API è°ƒç”¨æ—¶åŒ…å«è®¿é—®ä»¤ç‰Œã€åˆ·æ–°æ‰€è¿°ä»¤ç‰Œå’Œå¤„ç† CSRF ä»¤ç‰Œæ‰€éœ€çš„æ›´æ”¹ã€‚

å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œä½†å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

[https://www.youtube.com/embed/bK1N-C5zI1Q](https://www.youtube.com/embed/bK1N-C5zI1Q)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚
T3ã€‘

## [T1ã€‘ç®€ä»‹](#intro)

åœ¨è¿‡å»çš„å‡ æœŸä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•å°† IdentityServer4 é›†æˆåˆ°æˆ‘ä»¬çš„ auth æœåŠ¡ä¸­ï¼Œç„¶åå‡†å¤‡äº†ç»„ç®¡ç† API æ¥åˆ©ç”¨å®ƒåœ¨æ¯ä¸ªè¯·æ±‚ä¸­è·å¾—çš„è®¿é—®ä»¤ç‰Œ(ç‰¹åˆ«æ˜¯ JWT)å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬å°†å¼€å§‹è°ƒæ•´å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„åç«¯å¯¹å‰ç«¯ç»„ä»¶ï¼Œå°†èº«ä»½éªŒè¯å§”æ‰˜ç»™ auth æœåŠ¡ï¼Œç„¶ååœ¨æ¯ä¸ªå¯¹ç»„ç®¡ç† API çš„è¯·æ±‚ä¸­åŒ…å«ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œã€‚

é‰´äºæˆ‘ä»¬å°†ä½¿ç”¨ cookies å¯¹ BFF çš„æ¯ä¸ª SPA(å•é¡µåº”ç”¨ç¨‹åº)è¯·æ±‚è¿›è¡Œè®¤è¯ï¼Œæˆ‘ä»¬è¿˜å°†åŒ…æ‹¬å¯¹[è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF))ä»¤ç‰Œçš„æ”¯æŒã€‚

## é…ç½® BFF å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯/æˆæƒ

æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†åœ¨ ASP.NET æ ¸å¿ƒä¸­å®ç°èº«ä»½éªŒè¯çš„ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦ä¸€ç§ä¸ OpenID Connect é›†æˆçš„æ–¹æ³•ã€‚

è¦ç‚¹ä¸æˆ‘ä»¬åœ¨ä¹‹å‰å…³äº[ç»„ç®¡ç† API](https://blog.codingmilitia.com/2019/06/16/aspnet-023-from-zero-to-overkill-integrating-identityserver4-part3-api) çš„å¸–å­ä¸­çœ‹åˆ°çš„ä¸€æ ·â€”â€”æˆ‘ä»¬å°†åœ¨`Startup.ConfigureServices`ä¸­ä½¿ç”¨`AddAuthentication`å’Œä¸€äº›ç‰¹å®šçš„ OpenID è¿æ¥é…ç½®ï¼Œå¹¶åœ¨è¯·æ±‚å¤„ç†ç®¡é“å®šä¹‰ä¸­è°ƒç”¨`app.UseAuthentication`ã€‚

`AddAuthentication`è¿™æ¬¡æœ‰äº†æ›´å¤šçš„é…ç½®ï¼Œè®©æˆ‘ä»¬ç›´æ¥è¿›å…¥ä¸»é¢˜å§ã€‚

### æ·»åŠ è®¤è¯

è®©æˆ‘ä»¬ä»æŸ¥çœ‹ä»£ç å¼€å§‹ï¼Œç„¶åä¸€æ­¥ä¸€æ­¥åœ°æµè§ˆå®ƒã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services.AddAuthentication(options =>
    {
        options.DefaultScheme = "Cookies";
        options.DefaultChallengeScheme = "oidc";
    })
    .AddCookie("Cookies", options =>
    {
        options.EventsType = typeof(CustomCookieAuthenticationEvents);
    })
    .AddOpenIdConnect("oidc", options =>
    {
        options.SignInScheme = "Cookies";

        options.Authority = "https://localhost:5005";

        options.ClientId = "WebFrontend";
        options.ClientSecret = "secret";
        options.ResponseType = OidcConstants.ResponseTypes.Code;

        options.SaveTokens = true;
        options.GetClaimsFromUserInfoEndpoint = true;

        options.Scope.Add("GroupManagement");
        options.Scope.Add(OidcConstants.StandardScopes.OfflineAccess);

        options.Events.OnRedirectToIdentityProvider = context =>
        {
            if (!context.HttpContext.Request.Path.StartsWithSegments("/auth/login"))
            {
                context.HttpContext.Response.StatusCode = 401;
                context.HandleResponse();
            }
            return Task.CompletedTask;
        };
    });
    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹`AddAuthentication`çš„å®é™…è°ƒç”¨å¹¶æ²¡æœ‰é‚£ä¹ˆå¤šï¼Œé…ç½®é»˜è®¤çš„è®¤è¯æ–¹æ¡ˆå’Œè´¨è¯¢æ–¹æ¡ˆã€‚åœ¨è¿™ä¸ªè°ƒç”¨ä¹‹åï¼Œåœ¨è¿”å›çš„`AuthenticationBuilder`å®ä¾‹ä¸Šï¼Œæˆ‘ä»¬é…ç½®æ–¹æ¡ˆä»¥åŒ¹é…æˆ‘ä»¬æ‰€é…ç½®çš„ã€‚

`Cookies`è®¤è¯æ–¹æ¡ˆæ˜¯ç”¨`AddCookie`é…ç½®çš„ï¼Œå°½ç®¡æ²¡æœ‰å‘ç”Ÿå¾ˆå¤šäº‹æƒ…ï¼Œä½†è¿™æ˜¯å¾ˆé‡è¦çš„ä¸€ç‚¹ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­æ›´è¯¦ç»†åœ°äº†è§£è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½†æ˜¯è®¾ç½®`options.EventsType`å…è®¸æˆ‘ä»¬æä¾›`CookieAuthenticationEvents`ç±»çš„æ›¿ä»£å®ç°ã€‚é¡¾åæ€ä¹‰ï¼Œé€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰åœ¨ cookie èº«ä»½éªŒè¯æµç¨‹çš„ç‰¹å®šæ—¶åˆ»ä¼šå‘ç”Ÿä»€ä¹ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ­£å¦‚æˆ‘ä»¬ç¨åå°†çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬å°†è¿æ¥åˆ°ä¸€ä¸ªäº‹ä»¶ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬æ‹¥æœ‰çš„ä»¤ç‰Œ(å³è®¿é—®å’Œåˆ·æ–°ä»¤ç‰Œ)ä»ç„¶æœ‰æ•ˆï¼Œç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨è¯¥åº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€é‡æ–°è®¤è¯ã€‚

åä¸º`oidc`çš„æŒ‘æˆ˜æ–¹æ¡ˆé…ç½®æœ‰å¯¹`AddOpenIdConnect`çš„è°ƒç”¨ã€‚å½“æˆ‘ä»¬è€ƒè™‘ç»™å®ƒæ·»åŠ `IdentityServer4`(ç¬¬ 022 é›†ä¸­çš„[)æ—¶ï¼Œè¿™çœ‹èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼Œå› ä¸ºå®ƒä¸æˆ‘ä»¬åœ¨è®¤è¯æœåŠ¡ä¸­é…ç½®çš„ç›¸åŒ¹é…ã€‚](https://blog.codingmilitia.com/2019/06/13/aspnet-022-from-zero-to-overkill-integrating-identityserver4-part2-auth-service)

æˆ‘ä»¬ä»è®¾ç½®`SignInScheme`å¼€å§‹ï¼Œå®ƒè´Ÿè´£ä¿å­˜æˆ‘ä»¬å°†ä»è®¤è¯è¿‡ç¨‹ä¸­è·å¾—çš„ç”¨æˆ·ä¿¡æ¯ã€‚

ç„¶åï¼Œæˆ‘ä»¬ç”¨èº«ä»½éªŒè¯æœåŠ¡ç«¯ç‚¹è®¾ç½®`Authority`ï¼ŒåŠ ä¸Š`ClientId`ã€`ClientSecret`å’Œ`ResponseType`ï¼Œå®ƒä»¬çš„å€¼ä¸æˆ‘ä»¬åœ¨èº«ä»½éªŒè¯æœåŠ¡ä¸­é…ç½®å®¢æˆ·ç«¯æ—¶è®¾ç½®çš„å€¼ç›¸åŒã€‚

`SaveTokens = true`è¡¨ç¤ºä»¤ç‰Œå°†å­˜å‚¨åœ¨ cookie ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯`false`ï¼Œä»¥ä¿æŒ cookie æ›´å°ï¼Œæ‰€ä»¥å°†æ¥æˆ‘ä»¬å¯èƒ½åº”è¯¥å°†å®ƒæå–åˆ°æŸä¸ªæœåŠ¡å™¨ç«¯ä¼šè¯ï¼Œä½†ç›®å‰å®ƒå·¥ä½œæ­£å¸¸ã€‚

å°†`GetClaimsFromUserInfoEndpoint`è®¾ç½®ä¸º`true`ï¼Œæ„å‘³ç€åœ¨ OpenID è¿æ¥æµå®Œæˆå¹¶ä¸”ä»¤ç‰Œè¢«æ£€ç´¢ä¹‹åï¼Œå‘ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹å‘å‡ºé¢å¤–çš„è¯·æ±‚ä»¥è·å–é¢å¤–çš„ç”¨æˆ·å£°æ˜ã€‚

æˆ‘ä»¬æ·»åŠ äº†ä¸€äº›é¢å¤–çš„ä½œç”¨åŸŸ(é™¤äº†é»˜è®¤çš„ OpenID Connect ä½œç”¨åŸŸ)ï¼Œ`GroupManagement`å’Œ`offline_access`ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®¿é—®ç»„ç®¡ç† API å¹¶ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œã€‚

æœ€åï¼Œæˆ‘ä»¬æ³¨å†Œäº†`OnRedirectToIdentityProvider`äº‹ä»¶ã€‚ç”±äºè¿™ä¸ªåº”ç”¨ç¨‹åºå°†è¢« SPA ç”¨ä½œ APIï¼Œè€Œä¸æ˜¯ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„ MVC åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥å½“ç”¨æˆ·æ²¡æœ‰ç™»å½•æ—¶ï¼Œå°† API è¯·æ±‚é‡å®šå‘åˆ° auth æœåŠ¡æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè€Œæ˜¯ç”¨ 401(æœªæˆæƒ)æ¥å“åº”ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œåœ¨æˆ‘ä»¬æä¾›çš„äº‹ä»¶å¤„ç†ç¨‹åºä¸­ï¼Œæ‰€æœ‰å‘é€åˆ°é`/auth/login`ç«¯ç‚¹çš„æœªç»èº«ä»½éªŒè¯çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å°†çŠ¶æ€ä»£ç è®¾ç½®ä¸º 401ï¼Œå¹¶å°†å“åº”æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œå¦åˆ™è®©å®ƒç…§å¸¸è¿›è¡Œã€‚

### è¦æ±‚ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†å¦‚ä½•ç¡®ä¿å¯¹ API çš„æ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡èº«ä»½éªŒè¯ï¼Œæ‰€ä»¥è¿™æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œä½†æˆ‘è¿˜æ˜¯æŠŠå®ƒæ”¾åœ¨è¿™é‡Œä½œä¸ºå‚è€ƒğŸ™‚ã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    services
        .AddMvc(options =>
        {
            var policy = new AuthorizationPolicyBuilder()
                .RequireAuthenticatedUser()
                .Build();
            options.Filters.Add(new AuthorizeFilter(policy));
            // ...
        })
        // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬è°ƒç”¨äº†`AddMvc`,åœ¨é…ç½® lambda ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºå¹¶æ·»åŠ äº†ä¸€ä¸ªå¸¦æœ‰æˆ‘ä»¬éœ€è¦çš„ç­–ç•¥çš„`AuthorizeFilter`,åœ¨æœ¬ä¾‹ä¸­æ˜¯ä¸ºäº†å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚

### ç™»å½•

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œå½“æˆ‘ä»¬åœ¨`OnRedirectToIdentityProvider`ä¸Šæ³¨å†Œ OpenID Connect èº«ä»½éªŒè¯è´¨è¯¢æ–¹æ¡ˆæ—¶ï¼Œæˆ‘ä»¬è®©å®ƒå¯¹é™¤äº†`/auth/login`è·¯ç”±ä¹‹å¤–çš„æ‰€æœ‰è¯·æ±‚ç”¨ 401 è¿›è¡Œå“åº”ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªè·¯å¾„åœ¨ SPA ä¸­æ”¾ç½®ä¸€ä¸ªç™»å½•é“¾æ¥ã€‚

æ€»ä¹‹ï¼Œç™»å½•ç­–ç•¥å¦‚ä¸‹:

*   æˆ‘ä»¬å…¬å¼€ä¸€ä¸ª SPA å¯ä»¥è°ƒç”¨çš„`/auth/info`ç«¯ç‚¹ã€‚å¦‚æœå®ƒå¾—åˆ° 401ï¼ŒSPA æ˜¾ç¤ºç™»å½•çš„é“¾æ¥ï¼Œå¦åˆ™å®ƒä½¿ç”¨è¿”å›çš„ä¿¡æ¯ã€‚
*   æˆ‘ä»¬å…¬å¼€ä¸€ä¸ª`/auth/login`ç«¯ç‚¹ï¼Œå”¯ä¸€çš„ç›®çš„æ˜¯é‡å®šå‘åˆ° auth æœåŠ¡ï¼Œç„¶åï¼Œå½“è®¤è¯å®Œæˆæ—¶ï¼Œé‡å®šå‘åˆ°æ‰€éœ€çš„ SPA urlã€‚

è®©æˆ‘ä»¬çœ‹çœ‹`AuthController`çš„ä»£ç ï¼Œå®ƒæ˜¯ä¸ºå®ç°ä¸Šè¿°ç™»å½•ç­–ç•¥è€Œå¼€å‘çš„ã€‚

`Features/Auth/AuthController.cs`

```
[Route("auth")]
public class AuthController : ControllerBase
{
    // ...

    [HttpGet]
    [Route("info")]
    public ActionResult<AuthInfoModel> GetInfo()
    {
        // CSRF token stuff we'll see later ...

        return new AuthInfoModel
        {
            Name = User.FindFirst("name").Value
        };
    }

    [HttpGet]
    [Route("login")]
    public IActionResult Login([FromQuery] string returnUrl)
    {
        /*
        * No need to do anything here, as the auth middleware will take care of redirecting to IdentityServer4.
        * When the user is authenticated and gets back here, we can redirect to the desired url. 
        */
        return Redirect(string.IsNullOrWhiteSpace(returnUrl) ? "/" : returnUrl);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`/auth/info`ç«¯ç‚¹åªæ˜¯è¿”å›ä¸€äº›å½“å‰ç”¨æˆ·çš„ä¿¡æ¯(åŠ ä¸Šä¸€äº› CSRF ä»¤ç‰Œé€»è¾‘ï¼Œæˆ‘ä»¬å°†åœ¨åé¢çœ‹åˆ°)ã€‚å¯¹äºæœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·ï¼Œå®ƒè¿”å› 401 æ˜¯ç”±æ¡†æ¶è‡ªåŠ¨å¤„ç†çš„ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨èº«ä»½éªŒè¯è´¨è¯¢æ–¹æ¡ˆä¸­æ·»åŠ æˆæƒè¿‡æ»¤å™¨å’Œè½¬æ¢ 401 ä¸­çš„é‡å®šå‘æ—¶çœ‹åˆ°çš„é‚£æ ·ã€‚

`/auth/login`ç«¯ç‚¹è·å¾—ä¸€ä¸ªè¿”å› urlï¼Œå› æ­¤å®ƒå¯ä»¥å°†ç”¨æˆ·é‡å®šå‘å› SPA ä¸­çš„æ­£ç¡®ä½ç½®ã€‚åŒæ ·ï¼Œå¯¹æœªè®¤è¯ç”¨æˆ·çš„å¤„ç†ï¼Œé‡å®šå‘åˆ°è®¤è¯æœåŠ¡ï¼Œæ˜¯ç”±æ¡†æ¶è‡ªåŠ¨å®Œæˆçš„ã€‚

## æ”¯æŒè·¨ç«™è¯·æ±‚ä¼ªé€ ä»¤ç‰Œ

ä¸ºäº†å¢åŠ å¯¹è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ä»¤ç‰Œçš„æ”¯æŒï¼Œæˆ‘ä»¬æ¯”å‰å‡ é›† MVC å’Œ Razor é¡µé¢åšäº†æ›´å¤šçš„å·¥ä½œã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ SPA è€Œä¸æ˜¯ Razor ç”Ÿæˆçš„ HTMLï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰æ›´å¤šçš„æ‰‹å·¥å·¥ä½œè¦åšã€‚

å…ˆä»`Startup.ConfigureServices`è¯´èµ·å§ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›ä¿®æ”¹:æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨æ¥éªŒè¯æ‰€æœ‰åº”è¯¥æ‹¥æœ‰é˜²ä¼ªä»¤ç‰Œçš„è¯·æ±‚ä¸­æ˜¯å¦å­˜åœ¨é˜²ä¼ªä»¤ç‰Œ(å› æ­¤ï¼Œé™¤äº†`GET`ã€`HEAD`ã€`OPTIONS`å’Œ`TRACE`ä¹‹å¤–çš„æ‰€æœ‰è¯·æ±‚)ï¼Œå¹¶æ·»åŠ è¾…åŠ©é˜²ä¼ªæœåŠ¡ã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    services
        .AddMvc(options =>
        {
            // ...
            options.Filters.Add(new AutoValidateAntiforgeryTokenAttribute());
        })

    // ...

    services.AddAntiforgery(options => options.HeaderName = "X-XSRF-TOKEN");
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨é…ç½® MVC çš„ lambda ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ·»åŠ äº†æ–°çš„è¿‡æ»¤å™¨æ¥éªŒè¯é˜²ä¼ªæ ‡è®°ã€‚

è¿‡æ»¤ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨`AddAntiforgery`æ‰©å±•æ–¹æ³•æ¥æŸ¥çœ‹é˜²ä¼ªæœåŠ¡çš„é…ç½®ã€‚æˆ‘ä»¬è®¾ç½®çš„`HeaderName`å±æ€§æ˜¯ SPA å°†ä¸é˜²ä¼ªä»¤ç‰Œä¸€èµ·å‘é€çš„å¤´çš„åç§°ï¼Œå› æ­¤å®ƒå¯ä»¥åœ¨æœåŠ¡å™¨ç«¯è¿›è¡ŒéªŒè¯ã€‚å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·è®¾ç½®ï¼ŒæœåŠ¡å™¨åªä¼šè¯•å›¾åœ¨æäº¤çš„è¡¨å•æ•°æ®ä¸­æŸ¥æ‰¾ä»¤ç‰Œï¼Œè¿™æ˜¯ MVC/Razor Pages åº”ç”¨ç¨‹åºä¸­çš„å…¸å‹è¡Œä¸ºã€‚

ç°åœ¨ï¼Œä¸ºäº†è®© SPA èƒ½å¤Ÿè®¾ç½®æ ‡å¤´ï¼Œå®ƒéœ€è¦ä»æŸä¸ªåœ°æ–¹è·å–å®ƒã€‚è¿™å°±æ˜¯æˆ‘ä»¬å›åˆ°`AuthController`çš„åœ°æ–¹ã€‚åœ¨`GetInfo`åŠ¨ä½œä¸­ï¼Œæˆ‘ä»¬å°†ç”Ÿæˆé˜²ä¼ªä»¤ç‰Œï¼Œå¹¶ç”¨å®ƒè®¾ç½®ä¸€ä¸ª cookieï¼Œä»¥ä¾¿ SPA èƒ½å¤Ÿä½¿ç”¨å®ƒã€‚

`Features/Auth/AuthController.cs`

```
[Route("auth")]
public class AuthController : ControllerBase
{
    private readonly IAntiforgery _antiForgery;

    public AuthController(IAntiforgery antiForgery)
    {
        _antiForgery = antiForgery;
    }

    [HttpGet]
    [Route("info")]
    public ActionResult<AuthInfoModel> GetInfo()
    {
        var tokens = _antiForgery.GetAndStoreTokens(HttpContext);
            HttpContext.Response.Cookies.Append(
                "XSRF-TOKEN", 
                tokens.RequestToken, 
                new CookieOptions() {HttpOnly = false}); //allow JS to grab the cookie to put it in the request header

            return new AuthInfoModel
            {
                Name = User.FindFirst("name").Value
            };
    }

    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ç°åœ¨åœ¨æ„é€ å‡½æ•°ä¸­å¾—åˆ°ä¸€ä¸ªä¾èµ–é¡¹ï¼Œ`IAntiforgery`,å®ƒå…è®¸æˆ‘ä»¬ç”Ÿæˆé˜²ä¼ªä»¤ç‰Œã€‚æˆ‘ä»¬åœ¨`GetInfo`åŠ¨ä½œä¸­ä½¿ç”¨äº†å®ƒï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†ç”Ÿæˆä»¤ç‰Œä¹‹å¤–ï¼Œè¯¥æœåŠ¡è¿˜å­˜å‚¨äº†ä»¤ç‰Œï¼Œå› æ­¤å½“å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºåœ¨æŠ¥å¤´ä¸­å‘å›ä»¤ç‰Œæ—¶ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡ŒéªŒè¯ã€‚

ä¸ºäº†è®© SPA è·å¾—ä»¤ç‰Œï¼Œæˆ‘ä»¬æ·»åŠ äº† cookie å¹¶å°†å…¶`HttpOnly`å±æ€§è®¾ç½®ä¸º`false`ï¼Œå¦åˆ™æµè§ˆå™¨å°†ä¸å…è®¸åº”ç”¨ç¨‹åºè®¿é—®å®ƒã€‚

## æä¾› API è°ƒç”¨çš„è®¿é—®ä»¤ç‰Œ

å½“æˆ‘ä»¬è®¤ä¸ºæˆ‘ä»¬å¿…é¡»åœ¨æ¯ä¸ªå¯¹ API çš„è¯·æ±‚ä¸­å‘é€è®¿é—®ä»¤ç‰Œæ—¶ï¼Œæˆ‘ä»¬æƒ³åˆ°çš„ç¬¬ä¸€ä»¶äº‹å¯èƒ½æ˜¯å»æˆ‘ä»¬å‘å‡ºè¯·æ±‚çš„åœ°æ–¹å¹¶æ·»åŠ å¤´ã€‚è¿™å½“ç„¶å¯è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ›´å¹²å‡€çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™æ˜¯éå¸¸å¯é‡ç”¨çš„:åˆ›å»ºä¸€ä¸ªä»`DelegatingHandler`ç»§æ‰¿çš„ç±»ï¼Œå¹¶é…ç½®æˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„`HttpClient`ã€‚

ä¸€ä¸ª`DelegatingHandler`å…è®¸æˆ‘ä»¬æ‹¦æˆª`HttpClient`çš„è¯·æ±‚ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è¯·æ±‚ä¹‹å‰ã€ä¹‹åç”šè‡³æ›¿ä»£è¯·æ±‚æ·»åŠ ä¸€äº›é€»è¾‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å‘é€è¯·æ±‚ä¹‹å‰æ·»åŠ è®¿é—®ä»¤ç‰Œå¤´ã€‚ä¸‹é¢çš„ç±»`AccessTokenHttpMessageHandler`å®ç°äº†è¿™ä¸ªé€»è¾‘ã€‚

`AuthTokenHelpers/AccessTokenHttpMessageHandler.cs`

```
public class AccessTokenHttpMessageHandler : DelegatingHandler
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public AccessTokenHttpMessageHandler(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    protected override async Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
    {
        var accessToken = await _httpContextAccessor.HttpContext.GetTokenAsync("access_token");
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
        return await base.SendAsync(request, cancellationToken);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ²¡ä»€ä¹ˆè¿›å±•ï¼Œä½†è®©æˆ‘ä»¬å¿«é€Ÿæµè§ˆä¸€éã€‚æˆ‘ä»¬åªæ˜¯è¦†ç›–äº†`SendAsync`æ–¹æ³•ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å®ç°æˆ‘ä»¬éœ€è¦çš„é€»è¾‘ã€‚æˆ‘ä»¬æ³¨å…¥äº†ä¸€ä¸ª`IHttpContextAccessor`å®ä¾‹ï¼Œæˆ‘ä»¬åœ¨`SendAsync`ä¸­ä½¿ç”¨å®ƒä»`HttpContext`ä¸­è·å–è®¿é—®ä»¤ç‰Œ(è®°å¾—æˆ‘ä»¬å°†å®ƒå­˜å‚¨åœ¨ cookies ä¸­ï¼Œå¹¶å¯ä»¥ç”¨è¿™ç§æ–¹å¼è·å–å®ƒ)ã€‚

æœ‰äº†ä»¤ç‰Œï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒæ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­ï¼Œç„¶åå°†å…¶ä¼ é€’ç»™`SendAsync`çš„åŸºæœ¬å®ç°ï¼Œè®©è¯·æ±‚çš„å…¶ä½™éƒ¨åˆ†ç…§å¸¸æµåŠ¨ã€‚

ç°åœ¨æˆ‘ä»¬åªéœ€è¦åœ¨`Startup.ConfigureServices`ä¸­åšä¸€äº›æ”¹å˜ï¼Œæ¥ä½¿ç”¨å¤„ç†ç¨‹åº:åœ¨ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­æ³¨å†Œå®ƒï¼Œå¹¶ç”¨æœŸæœ›çš„`HttpClient`é…ç½®å®ƒã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services
        .AddTransient<AccessTokenHttpMessageHandler>()
        .TryAddSingleton<IHttpContextAccessor, HttpContextAccessor>();
    //...
    services
        .AddHttpClient<GroupsController>(/*...*/)
        // ...
        .AddHttpMessageHandler<AccessTokenHttpMessageHandler>();
    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚ä½ æ‰€è§ï¼Œæ²¡æœ‰å¤ªå¤šäº‹æƒ…è¦åšï¼Œæˆ‘ä»¬åªéœ€è¦è®°ä½å»åšğŸ˜›ã€‚å‘ DI å®¹å™¨æ³¨å†Œ`AccessTokenHttpMessageHandler`ï¼ŒåŒæ—¶ä¹Ÿæ³¨å†Œ`IHttpContextAccessor`ï¼Œå› ä¸ºåœ¨ ASP.NET æ ¸å¿ƒä¸­é»˜è®¤æƒ…å†µä¸‹å®ƒä¸åœ¨é‚£é‡Œã€‚ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨`IHttpClientBuilder`ä¸Šçš„`AddHttpMessageHandler`æ‰©å±•æ–¹æ³•æ¥ä½¿ç”¨å¤„ç†ç¨‹åºã€‚

> æ³¨æ„:æ³¨å†Œ`IHttpContextAccessor`çš„ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•æ˜¯è°ƒç”¨`AddHttpContextAccessor`æ‰©å±•æ–¹æ³•ï¼Œä½†æ˜¯å½“æˆ‘æœ€åˆç¼–å†™è¿™æ®µä»£ç æ—¶ï¼Œæˆ‘å¹¶ä¸çŸ¥é“å®ƒğŸ™‚ã€‚

## åˆ·æ–°è®¿é—®ä»¤ç‰Œ

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æœ€åä¸€ä»¶äº‹æ˜¯ç¡®ä¿åœ¨è®¿é—®ä»¤ç‰Œåˆ°æœŸæ—¶(æˆ–å³å°†åˆ°æœŸæ—¶)åˆ·æ–°å®ƒã€‚

ä¸ºäº†å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œæ­£å¦‚æˆ‘ç®€å•æåˆ°çš„ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ›¿ä»£çš„`CookieAuthenticationEvents`å®ç°å’Œä¸€äº›é¢å¤–çš„åŠ©æ‰‹ç±»ã€‚è¿™æ„å‘³ç€åœ¨æ”¶åˆ°çš„æ¯ä¸ªè¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥è®¿é—®ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ï¼Œå¦‚æœè¿‡æœŸï¼Œæˆ‘ä»¬å°†åˆ·æ–°å®ƒã€‚

æ£€æŸ¥è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæ€§çš„å¦ä¸€ç§å¯èƒ½çš„æ–¹æ³•æ˜¯åœ¨æˆ‘ä»¬å®ç°çš„`HttpClient`çš„å§”æ‰˜å¤„ç†ç¨‹åºä¸­è¿›è¡Œã€‚ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå¯¹äº cookie è®¤è¯äº‹ä»¶ï¼Œæˆ‘ä»¬å¯¹ BFF çš„æ¯ä¸ªè¯·æ±‚è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œè€Œå¦‚æœæˆ‘ä»¬åœ¨å§”æ‰˜å¤„ç†ç¨‹åºä¸­è¿›è¡Œæ£€æŸ¥ï¼Œæˆ‘ä»¬å¯¹åå¤‡ API çš„æ¯ä¸ªè¯·æ±‚è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ã€‚ä¸¤è€…éƒ½æœ‰ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œä½†æ˜¯è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æœºä¼šæ¥æ£€æŸ¥æˆ‘ä»¬å¯ä»¥æŒ‚é’©åˆ°æ¡†æ¶çš„å¯æ‰©å±•æ€§ç‚¹çš„æ›´å¤šæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªğŸ˜‰ã€‚

å…ˆè¯´`CustomCookieAuthenticationEvents`ç±»ã€‚å½“ä»`CookieAuthenticationEvents`ç»§æ‰¿æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€å †å¯ä»¥è¦†ç›–çš„æ–¹æ³•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³è¦è¦†ç›–`ValidatePrincipal`â€”â€”å¦‚æœè®¿é—®ä»¤ç‰Œæœ‰æ•ˆæˆ–è€…æˆ‘ä»¬èƒ½å¤Ÿåˆ·æ–°å®ƒï¼Œæˆ‘ä»¬å¯ä»¥è®©å®ƒæ­£å¸¸æµåŠ¨(å¯èƒ½æœ‰ä¸€äº›è°ƒæ•´)ï¼Œå¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬æ‹’ç»ä¸»ä½“å¹¶å¼ºåˆ¶æ³¨é”€ï¼Œå› æ­¤ç”¨æˆ·éœ€è¦é‡æ–°è®¤è¯ã€‚

`AuthTokenHelpers/CustomCookieAuthenticationEvents.cs`

```
public class CustomCookieAuthenticationEvents : CookieAuthenticationEvents
{
    private readonly ITokenRefresher _tokenRefresher;

    public CustomCookieAuthenticationEvents(ITokenRefresher tokenRefresher)
    {
        _tokenRefresher = tokenRefresher;
    }

    public override async Task ValidatePrincipal(CookieValidatePrincipalContext context)
    {
        var result = await _tokenRefresher.TryRefreshTokenIfRequiredAsync(
            context.Properties.GetTokenValue("refresh_token"),
            context.Properties.GetTokenValue("expires_at"),
            CancellationToken.None);

        if (!result.IsSuccessResult)
        {
            context.RejectPrincipal();
            await context.HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
        }
        else if (result.TokensRenewed)
        {
            context.Properties.UpdateTokenValue("access_token", result.AccessToken);
            context.Properties.UpdateTokenValue("refresh_token", result.RefreshToken);
            context.Properties.UpdateTokenValue("expires_at", result.ExpiresAt);
            context.ShouldRenew = true;
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»ç„¶æœ‰ä¸€äº›ç¼ºå¤±çš„éƒ¨åˆ†ï¼Œä½†æ˜¯æˆ‘ä»¬èƒ½å¤Ÿç†è§£`CustomCookieAuthenticationEvents`ä¸­å‘ç”Ÿäº†ä»€ä¹ˆã€‚æˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­è·å¾—äº†ä¸€ä¸ª`ITokenRefresher`çš„å®ä¾‹ï¼Œæˆ‘ä»¬å°†ä¼šæ›´è¯¦ç»†åœ°çœ‹åˆ°å®ƒï¼Œä½†æ˜¯é¡¾åæ€ä¹‰ï¼Œå®ƒè´Ÿè´£åˆ·æ–°(å¦‚æœéœ€è¦çš„è¯)ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚å¦‚æœä»¤ç‰Œåˆ·æ–°å¤±è´¥ï¼Œæˆ‘ä»¬æ‹’ç»ä¸»ä½“å¹¶å¼ºåˆ¶æ³¨é”€ã€‚å¦‚æœä»¤ç‰Œè¢«åˆ·æ–°ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ›´æ–°å­˜å‚¨åœ¨ cookie ä¸­çš„å€¼ï¼Œå¹¶ä¸ºç”¨æˆ·æ›´æ–° cookie(å› æ­¤æœ‰äº†`context.ShouldRenew = true`)ã€‚å¦ä¸€ä¸ªåœºæ™¯æ˜¯ä»¤ç‰Œå¯èƒ½ä»ç„¶æœ‰æ•ˆï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹æƒ…(å› æ­¤æ²¡æœ‰é’ˆå¯¹è¯¥åœºæ™¯çš„ç‰¹å®šä»£ç )ã€‚

åœ¨æŸ¥çœ‹`ITokenRefresher`åŠå…¶å®ç°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹ç”±`TryRefreshTokenIfRequiredAsync`è¿”å›çš„`TokenRefreshResult`ç±»ã€‚

`AuthTokenHelpers/TokenRefreshResult.cs`

```
public class TokenRefreshResult
{
    private static readonly TokenRefreshResult NoRefreshNeededResult =
        new TokenRefreshResult(true, false, null, null, null);

    private static readonly TokenRefreshResult FailedResult =
        new TokenRefreshResult(false, false, null, null, null);

    protected TokenRefreshResult(
        bool isSuccessResult,
        bool tokensRenewed,
        string accessToken,
        string refreshToken,
        string expiresAt)
    {
        IsSuccessResult = isSuccessResult;
        TokensRenewed = tokensRenewed;
        AccessToken = accessToken;
        RefreshToken = refreshToken;
        ExpiresAt = expiresAt;
    }

    public bool IsSuccessResult { get; }
    public bool TokensRenewed { get; }
    public string AccessToken { get; }
    public string RefreshToken { get; }
    public string ExpiresAt { get; }

    public static TokenRefreshResult Success(
        string accessToken,
        string refreshToken,
        string expiresAt)
    {
        return new TokenRefreshResult(true, true, accessToken, refreshToken, expiresAt);
    }

    public static TokenRefreshResult Failed() => FailedResult;

    public static TokenRefreshResult NoRefreshNeeded() => NoRefreshNeededResult;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œé™¤äº†åœ¨`CustomCookieAuthenticationEvents`ç±»ä¸­æœ‰å¿…è¦çš„å±æ€§æ¥æ£€æŸ¥ç»“æœä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€äº›åŠ©æ‰‹æ–¹æ³•ï¼Œ`ITokenRefresher`å®ç°å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§ã€‚

`ITokenRefresher`æ¥å£å…¬å¼€äº†ä¸€ä¸ªæ–¹æ³•`TryRefreshTokenIfRequiredAsync`,å®ƒ...é¡¾åæ€ä¹‰ğŸ˜›

`AuthTokenHelpers/ITokenRefresher.cs`

```
/// <summary>
/// Provides an easy way to ensure the user's access token is up to date. 
/// </summary>
public interface ITokenRefresher
{
    /// <summary>
    /// Tries to refresh the current user's access token if required.
    /// </summary>
    /// <param name="refreshToken">The current refresh token.</param>
    /// <param name="expiresAt">The current token expiration information.</param>
    /// <param name="ct">The async cancellation token.</param>
    /// <returns><code>True</code> if refresh is not needed or executed successfully, <code>False</code> otherwise.</returns>
    Task<TokenRefreshResult> TryRefreshTokenIfRequiredAsync(
        string refreshToken,
        string expiresAt,
        CancellationToken ct);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®ç°ã€‚

`AuthTokenHelpers/TokenRefresher.cs`

```
/// <inheritdoc />
public class TokenRefresher : ITokenRefresher
{
    private static readonly TimeSpan TokenRefreshThreshold = TimeSpan.FromSeconds(30);

    private readonly HttpClient _httpClient;
    private readonly IDiscoveryCache _discoveryCache;
    private readonly ILogger<TokenRefresher> _logger;

    public TokenRefresher(
        HttpClient httpClient,
        IDiscoveryCache discoveryCache,
        ILogger<TokenRefresher> logger)
    {
        _httpClient = httpClient;
        _discoveryCache = discoveryCache;
        _logger = logger;
    }

    /// <inheritdoc />
    public async Task<TokenRefreshResult> TryRefreshTokenIfRequiredAsync(
        string refreshToken,
        string expiresAt,
        CancellationToken ct)
    {
        if (string.IsNullOrWhiteSpace(refreshToken))
        {
            return TokenRefreshResult.Failed();
        }

        if (!DateTime.TryParse(expiresAt, out var expiresAtDate) || expiresAtDate >= GetRefreshThreshold())
        {
            return TokenRefreshResult.NoRefreshNeeded();
        }

        var discovered = await _discoveryCache.GetAsync();
        var tokenResult = await _httpClient.RequestRefreshTokenAsync(
            new RefreshTokenRequest
            {
                Address = discovered.TokenEndpoint,
                ClientId = "WebFrontend",
                ClientSecret = "secret",
                RefreshToken = refreshToken
            }, ct);

        if (tokenResult.IsError)
        {
            _logger.LogDebug(
                "Unable to refresh token, reason: {refreshTokenErrorDescription}",
                tokenResult.ErrorDescription);
            return TokenRefreshResult.Failed();
        }

        var newAccessToken = tokenResult.AccessToken;
        var newRefreshToken = tokenResult.RefreshToken;
        var newExpiresAt = CalculateNewExpiresAt(tokenResult.ExpiresIn);

        return TokenRefreshResult.Success(newAccessToken, newRefreshToken, newExpiresAt);
    }

    private static string CalculateNewExpiresAt(int expiresIn)
    {
        // TODO: abstract usages of DateTime to ease unit tests
        return (DateTime.UtcNow + TimeSpan.FromSeconds(expiresIn)).ToString("o", CultureInfo.InvariantCulture);
    }

    private static DateTime GetRefreshThreshold()
    {
        // TODO: abstract usages of DateTime to ease unit tests
        return DateTime.UtcNow + TokenRefreshThreshold;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»£ç å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯è®©æˆ‘ä»¬ä»”ç»†é˜…è¯»ä¸€ä¸‹ï¼Œå› ä¸ºå…¶ä¸­æœ‰ä¸€äº›æœ‰è¶£çš„åœ°æ–¹ã€‚

çœ‹ä¸€ä¸‹æ„é€ å‡½æ•°ï¼Œæ³¨å…¥çš„ä¾èµ–é¡¹ä¸­æœ‰ä¸¤ä¸ªæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ï¼Œä½†å¦ä¸€ä¸ªå´ä¸æ˜¯ã€‚`IDiscoveryCache`æ˜¯åœ¨`IdentityModel` NuGet åŒ…ä¸­æä¾›çš„ä¸€ä¸ªåŠ©æ‰‹ï¼Œå…è®¸æˆ‘ä»¬ä» OpenID Connect æä¾›è€…çš„å‘ç°ç«¯ç‚¹è·å–ä¿¡æ¯(å¹¶ç¼“å­˜å®ƒ),è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨å¯¹æä¾›è€…çš„å…¶ä»–è¯·æ±‚ä¸­ä½¿ç”¨å®ƒï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œç”¨äºä»¤ç‰Œåˆ·æ–°ã€‚

è¿›å…¥`TryRefreshTokenIfRequiredAsync`æ–¹æ³•å®ç°ï¼Œæˆ‘ä»¬æœ‰:

*   æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤±è´¥ã€‚
*   æ£€æŸ¥ä»¤ç‰Œåˆ°æœŸæ—¥æœŸæ˜¯å¦ä½äºé˜ˆå€¼ï¼Œå¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³è¿”å›ä¸€ä¸ª`NoRefreshNeeded`ã€‚
*   ç”¨`_discoveryCache`è·å–æä¾›å•†ä¿¡æ¯ã€‚
*   è¯·æ±‚åˆ·æ–°ä»¤ç‰Œï¼Œä¹Ÿä½¿ç”¨æˆ‘ä»¬åœ¨`Startup`ç±»ä¸­é…ç½®çš„ä¿¡æ¯(æ˜¯çš„ï¼Œå®ƒåº”è¯¥æ¥è‡ªé…ç½®ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç åœ¨è¿™é‡ŒğŸ™ƒ).æ³¨æ„ï¼Œ`RequestRefreshTokenAsync`æ˜¯æ¥è‡ª`IdentityModel` NuGet åŒ…çš„æ‰©å±•æ–¹æ³•ï¼Œç®€åŒ–äº†åˆ·æ–°ä»¤ç‰Œè¯·æ±‚çš„åˆ›å»ºã€‚
*   å¦‚æœä»¤ç‰Œåˆ·æ–°æˆåŠŸï¼Œåˆ™è¿”å›åŒ…å«æ‰€éœ€ä¿¡æ¯çš„æˆåŠŸï¼Œå¦åˆ™è¿”å›å¤±è´¥ã€‚

å¯¹äºä»¤ç‰Œåˆ·æ–°é€»è¾‘æ¥è¯´åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚è™½ç„¶ä¸æ˜¯å¾ˆå¤šï¼Œä½†ä»ç„¶æ˜¯å¾ˆå¥½çš„ä¸€æ®µä»£ç ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ PlayBall åº”ç”¨ç¨‹åºçš„å…¶ä»–ç»„ä»¶ä¸­é‡ç”¨å®ƒï¼Œä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥å°†å®ƒæ”¾åœ¨ä¸€ä¸ªå…±äº«åŒ…ä¸­ã€‚

> PS:ä¸è¦å¿˜è®°åœ¨ DI å®¹å™¨ä¸­æ³¨å†Œæ‰€æœ‰éœ€è¦çš„æœåŠ¡ã€‚

## å…¶ä»–

æœ€åï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•å°†ç”¨æˆ·èº«ä»½éªŒè¯å§”æ‰˜ç»™ auth æœåŠ¡ï¼ŒåŒæ—¶è·å–å’Œç»´æŠ¤ä»¤ç‰Œä»¥è®¿é—®åå° API(ç›®å‰åªæœ‰ç»„ç®¡ç† API)ã€‚æˆ‘ä»¬è¿˜çœ‹åˆ°äº†å¦‚ä½•è®© CSRF ä»¤ç‰ŒåŸºç¡€è®¾æ–½å‡†å¤‡å¥½ä½¿ç”¨ SPAï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Razor è¿›è¡Œå¸¸è§çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“ã€‚åœ¨ä¸‹ä¸€é›†é‡Œï¼Œæˆ‘ä»¬å°†æ€»ç»“è¿™ä¸ªå­ç³»åˆ—ï¼Œé€šè¿‡çœ‹åˆ°å‰ç«¯çš„å˜åŒ–æ¥å¾ˆå¥½åœ°ä¸ BFF ä¸€èµ·ç©ï¼Œå¹¶é›†æˆæˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢å¼€å‘çš„æ‰€æœ‰ä¸œè¥¿ã€‚

ä½œä¸ºæé†’(æˆ‘å¯èƒ½ä¼šåœ¨ä¸‹ä¸€é›†é‡å¤)ï¼Œæ‰€æœ‰è¿™äº›åªæ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„(å¯èƒ½)è®¸å¤šå¯èƒ½æ–¹æ³•ä¸­çš„ä¸€ç§ï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰ä¸åŒçš„æƒ³æ³•ï¼Œå¹¶ä¸”è®¤ä¸ºå®ƒæ›´å¥½ï¼Œé‚£å°±å»åšå§ğŸ™‚(è®©æˆ‘çŸ¥é“ï¼Œè¿™æ ·æˆ‘å¯ä»¥æ”¹è¿›æˆ‘çš„)ã€‚

å¸–å­ä¸­çš„é“¾æ¥:

*   [è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF))
*   [ç¬¬ 023 é›†-æ•´åˆèº«ä»½æœåŠ¡å™¨ 4 -ç¬¬ 3 éƒ¨åˆ†-API-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°è¿‡åº¦æ€ä¼¤](https://blog.codingmilitia.com/2019/06/16/aspnet-023-from-zero-to-overkill-integrating-identityserver4-part3-api)

è¿™ä¸ªå­ç³»åˆ—å¸–å­çš„æºä»£ç åˆ†æ•£åœ¨[â€œç¼–ç æ°‘å…µ:ASP.NET æ ¸å¿ƒ-ä» 0 åˆ°è¿‡åº¦æ€æˆ®â€ç»„ç»‡](https://github.com/AspNetCoreFromZeroToOverkill)çš„ä¸€å †ä»“åº“ä¸­ï¼Œæ ‡è®°ä¸º`episode021`ã€‚

*   [è®¤è¯](https://github.com/AspNetCoreFromZeroToOverkill/Auth/tree/episode021)
*   [ç¾¤ç»„ç®¡ç†](https://github.com/AspNetCoreFromZeroToOverkill/GroupManagement/tree/episode021)
*   [web å‰ç«¯](https://github.com/AspNetCoreFromZeroToOverkill/WebFrontend/tree/episode021)

æ„Ÿè°¢åˆ†äº«å’Œåé¦ˆï¼

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼