# Kentico 12:è®¾è®¡æ¨¡å¼ç¬¬ 11 éƒ¨åˆ†-å•å…ƒæµ‹è¯•å®šåˆ¶é¡µé¢ç±»å‹

> åŸæ–‡ï¼š<https://dev.to/seangwright/kentico-12-design-patterns-part-11-unit-testing-custom-page-types-2c11>

<figure>

[![Books and pages](img/4a1dc4fa73a374867929169f470a55ce.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--JC7OvzaM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/bya0yinp23e4bm4jvq1r.jpg)

<figcaption>Photo by [Patrick Tomasso](https://unsplash.com/@impatrickt) on [Unsplash](https://unsplash.com)</figcaption>

</figure>

å¤§å¤šæ•°æ—¶å€™ï¼Œå½“ä½ ä¸ºä½ çš„ Kentico 12 MVC åº”ç”¨ç¨‹åºç¼–å†™å•å…ƒæµ‹è¯•æ—¶ï¼Œä½ å¯ä»¥ä¾é [æ–‡æ¡£åŒ–çš„ Kentico æµ‹è¯• API](https://docs.kentico.com/k12sp/custom-development/writing-automated-tests/faking-info-and-provider-objects-in-unit-tests)ï¼Œæ¯”å¦‚`UnitTests`åŸºç±»å’Œ`Fake<>()`æ–¹æ³•ã€‚

è¿™äº› API å…è®¸æ¸…é™¤ä¾èµ–äº Kentico æ•°æ®åº“çš„ç±»å‹å’Œæ•°æ®æºï¼Œè€Œä¸ä¾èµ–äºä¸æ•°æ®åº“çš„å®æ—¶è¿æ¥ğŸ’ªã€‚

ä½†æ˜¯ä¸€äº›æµ‹è¯•åœºæ™¯çš„è§£å†³æ–¹æ¡ˆéœ€è¦æ·±å…¥äº†è§£ Kentico çš„å†…éƒ¨å·¥ä½œåŸç†ğŸ˜®ã€‚

ä¸‹é¢æˆ‘ä»¬å°†çœ‹ä¸€ä¸ªå¦‚ä½•æµ‹è¯•ä»£ç çš„ä¾‹å­ï¼Œè¿™ä¸ªä»£ç ä½¿ç”¨ä¸€ä¸ªå®šåˆ¶çš„é¡µé¢ç±»å‹ï¼Œè¿™ä¸ªé¡µé¢ç±»å‹æœ‰ä¸€ä¸ªâ€œæ–‡ä»¶â€ç±»å‹çš„æ•°æ®åº“å­—æ®µã€‚

> è¦äº†è§£æ›´å¤šå…³äºé¡µé¢ç±»å‹çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [Kentico çš„æ–‡æ¡£](https://docs.kentico.com/k12sp/developing-websites/defining-website-content-structure/creating-and-configuring-page-types/creating-content-only-page-types)æˆ–[æ¥è‡ª BizStream çš„è¿™ç¯‡æ–‡ç« ğŸ‘ã€‚](https://www.bizstream.com/blog/february-2019/kentico-101-page-types)

* * *

## å®šä¹‰åœºæ™¯

### è‡ªå®šä¹‰é¡µé¢ç±»å‹- `EmployeeContent`

è®©æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªæƒ³è¦æµ‹è¯•çš„åœºæ™¯ã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰ä»¥ä¸‹å­—æ®µçš„`EmployeeContent`è‡ªå®šä¹‰é¡µé¢ç±»å‹:

*   `EmployeeContentID` - `int`
*   `EmployeeContentImage` - `Guid`
*   `EmployeeContentName` - `string`
*   `EmployeeContentHireDate` - `DateTime`

ä¸‹é¢æ˜¯ Kentico ä¸ºè¿™ç§é¡µé¢ç±»å‹è‡ªåŠ¨ç”Ÿæˆçš„ä¸€äº›ä»£ç :

```
public partial class EmployeeContent : TreeNode
{
    public const string CLASS_NAME = "Sandbox.EmployeeContent";

    private readonly EmployeeContentFields mFields;

    [DatabaseIDField]
    public int EmployeeContentID
    {
        get => ValidationHelper
            .GetInteger(GetValue("EmployeeContentID"), 0);
        set => SetValue("EmployeeContentID", value);
    }

    [DatabaseField]
    public Guid EmployeeContentImage
    {
        get => ValidationHelper
            .GetGuid(GetValue("EmployeeContentImage"), Guid.Empty);
        set => SetValue("EmployeeContentImage", value);
    }

    [DatabaseField]
    public string EmployeeContentName
    {
        get => ValidationHelper
            .GetString(GetValue("EmployeeContentName"), @"");
        set => SetValue("EmployeeContentName", value);
    }

    [DatabaseField]
    public DateTime EmployeeContentHireDate
    {
        get => ValidationHelper
            .GetDateTime(GetValue("EmployeeContentHireDate"), DateTimeHelper.ZERO_TIME);
        set => SetValue("EmployeeContentHireDate", value);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä¸Šé¢çš„åˆå§‹ç±»å’Œå±æ€§å®šä¹‰ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°`EmployeeContentFields`åµŒå¥—ç±»ï¼Œè¿™ç»™äº†æˆ‘ä»¬ä¸€ç§æ›´æ–¹ä¾¿çš„æ–¹å¼æ¥è®¿é—®ä¸æ˜¯ä»`TreeNode`ç»§æ‰¿çš„å­—æ®µ(è¿™äº›å°†æ˜¯ä¸Šé¢å®šä¹‰çš„å®šåˆ¶å­—æ®µ)ã€‚

```
[RegisterAllProperties]
public partial class EmployeeContentFields :
    AbstractHierarchicalObject<EmployeeContentFields>
{
    private readonly EmployeeContent mInstance;

    public EmployeeContentFields(EmployeeContent instance) =>
        mInstance = instance;

    public int ID
    {
        get => mInstance.EmployeeContentID;
        set => mInstance.EmployeeContentID = value;
    }

    public DocumentAttachment Image =>
        mInstance.GetFieldDocumentAttachment("EmployeeContentImage");

    public string Name
    {
        get => mInstance.EmployeeContentName;
        set => mInstance.EmployeeContentName = value;
    }

    public DateTime HireDate
    {
        get => mInstance.EmployeeContentHireDate;
        set => mInstance.EmployeeContentHireDate = value;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é™¤äº†è®©æˆ‘ä»¬å¿«é€Ÿè®¿é—®ç‰¹å®šäºè‡ªå®šä¹‰é¡µé¢ç±»å‹çš„å­—æ®µä¹‹å¤–ï¼Œ`EmployeeContentFields`è®©æˆ‘ä»¬å°†æŸäº›ç±»å‹çš„å­—æ®µè§†ä¸ºæˆ‘ä»¬æœŸæœ›çš„æ•°æ®ç±»å‹ğŸ‘ã€‚

`EmployeeContent.EmployeeContentImage`å±æ€§å’Œ`EmployeeContent.EmployeeContentFields.Image`å±æ€§æ˜¯å¸¦æœ‰`File`æ•°æ®ç±»å‹å­—æ®µçš„è‡ªå®šä¹‰é¡µé¢ç±»å‹çš„æŒ‡ç¤ºå™¨ã€‚

> ä½ å¯ä»¥åœ¨ Kentico çš„æ–‡æ¡£ä¸­é˜…è¯»æ›´å¤šå…³äºç®¡ç†é¡µé¢ç±»å‹å­—æ®µçš„ä¿¡æ¯ã€‚

è¿™æ˜¯ä¸€ä¸ªå”¯ä¸€å‘½åçš„é¡µé¢é™„ä»¶ï¼Œä¸`EmployeeContent`ç»§æ‰¿çš„`TreeNode.Attachments`å±æ€§ç›¸åã€‚

`TreeNode.Attachments`æ˜¯é¡µé¢é™„ä»¶çš„é›†åˆï¼Œè¿™äº›é™„ä»¶ä¸é¡µé¢æœ¬èº«æ²¡æœ‰å‘½åå…³è”ã€‚å®ƒä»¬ä¸æ˜¯æš´éœ²åœ¨é¡µé¢ç±»å‹ç±»ä¸Šçš„å±æ€§â€”â€”åªæ˜¯ä¸€åŒ…é™„ä»¶ğŸ¤”ã€‚

è¿™ä¸åŒäºé¡µé¢ç±»å‹ä¸Šå…·æœ‰æŒ‡å®šä¸ºâ€œæ–‡ä»¶â€çš„æ•°æ®ç±»å‹çš„å­—æ®µã€‚ç”±äºè¿™äº›æ˜¯ç‰¹å®šå­—æ®µï¼Œå› æ­¤å®ƒä»¬åœ¨é¡µé¢ç±»å‹ç±»ä¸Šå…·æœ‰ç‰¹å®šçš„å±æ€§ï¼Œå…è®¸æ‚¨è®¿é—®é™„ä»¶ğŸ§.

æ³¨æ„ï¼Œè™½ç„¶`EmployeeContentImage`æ˜¯ç±»å‹`Guid`(è¿™æ˜¯ä¸è¯¥å­—æ®µç›¸å…³è”çš„å›¾åƒé™„ä»¶çš„`Guid`)ï¼Œä½†æ˜¯åœ¨`EmployeeContentFields`ç±»ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç±»å‹`DocumentAttachment`çš„`Image`å±æ€§ã€‚

```
[DatabaseField]
public Guid EmployeeContentImage
{
    get => ValidationHelper
       .GetGuid(GetValue("EmployeeContentImage"), Guid.Empty);
    set => SetValue("EmployeeContentImage", value);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

vs

```
public DocumentAttachment Image =>
    mInstance.GetFieldDocumentAttachment("EmployeeContentImage"); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è™½ç„¶`Guid`æ˜¯å­˜å‚¨åœ¨æ•°æ®åº“åˆ—ä¸­çš„çœŸå®åŸå§‹å€¼ï¼Œä½†æ˜¯`DocumentAttachment`å¯èƒ½æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨è¿™ä¸ªå®šåˆ¶é¡µé¢ç±»å‹ç±»æ—¶æƒ³è¦ä¸ä¹‹äº¤äº’çš„å¯¹è±¡ã€‚

> `DocumentAttachment`ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹`.GetPath()`æ–¹æ³•çš„è®¿é—®ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨ Kentico çš„å†…éƒ¨æœºåˆ¶æ¥æ„å»ºé™„ä»¶çš„ URLğŸ‘ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±åš URL çš„å­—ç¬¦ä¸²æ„å»ºã€‚

è¿™ä¸ª`Image`å±æ€§ç¡®å®å¸®åŠ©äº†æˆ‘ä»¬ï¼Œä½†æ˜¯å®ƒä¹Ÿä½¿å¾—æˆ‘ä»¬çš„ç±»å¾ˆéš¾æµ‹è¯•ã€‚è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼æˆ‘ä»¬ä¸èƒ½å°†ä¸€ä¸ªæµ‹è¯•å€¼åˆ†é…ç»™æˆ‘ä»¬å¯èƒ½ä¸ºæµ‹è¯•è€Œåˆ›å»ºçš„`EmployeeContent`çš„å®ä¾‹ğŸ˜ã€‚

è¿˜æœ‰ï¼Œ`.GetFieldDocumentAttachment()`æ˜¯åšä»€ä¹ˆçš„ï¼Ÿæˆ‘ä»¬æ— æ³•æ‹¦æˆªè¿™ä¸ªå‘¼å«ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¾é  Kentico çš„æµ‹è¯• API æ¥å¸®åŠ©ğŸ™„ã€‚

### è¯·æ±‚å¤„ç†ç¨‹åº- `EmployeesListPageRequestHandler`

éµå¾ª[ä¸­ä»‹æ¨¡å¼](https://blogs.msdn.microsoft.com/cdndevs/2016/01/26/simplifying-development-and-separating-concerns-with-mediatr/),æˆ‘ä»¬å°†ä¸šåŠ¡é€»è¾‘å’Œè¯·æ±‚å¤„ç†ä» MVC æ§åˆ¶å™¨ä¸­è½¬ç§»åˆ°è¯·æ±‚å¤„ç†å™¨ä¸­ã€‚

> æˆ‘ä»¬å°†ä½¿ç”¨[mediator](https://github.com/jbogard/MediatR)åº“æ¥å¸®åŠ©æˆ‘ä»¬æ„å»ºè¿™ä¸ªåŸºç¡€è®¾æ–½ã€‚

è¿™ä¸ªè¯·æ±‚å¤„ç†å™¨ç±»ï¼Œæˆ‘ä»¬å°†å‘½åä¸º`EmployeesListPageRequestHandler`ï¼Œå°†ä»æ§åˆ¶å™¨è·å–è¯·æ±‚ï¼Œå¤„ç†å®ƒï¼Œå¹¶è¿”å›ä¸€ä¸ªè§†å›¾æ¨¡å‹ä½œä¸ºå“åº”ã€‚

æˆ‘ä»¬å¯ä»¥ä»è‡ªåŠ¨ç”Ÿæˆçš„`EmployeeContentProvider`ä¸­æ£€ç´¢æ•°æ®ï¼Œä½†æ˜¯è¿™å¯èƒ½ä¼šè¿«ä½¿æˆ‘ä»¬ä¸ºè¿™ä¸ªè¯·æ±‚å¤„ç†ç¨‹åºç¼–å†™ä¸€ä¸ªé›†æˆæµ‹è¯•ã€‚

ç›¸åï¼Œæˆ‘ä»¬å°†æŠŠæ•°æ®è®¿é—®å®ç°çš„ç»†èŠ‚éšè—åœ¨å¤–è§‚åé¢ã€‚

å®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå­˜å‚¨åº“ã€ä¸€ä¸ªæŸ¥è¯¢æˆ–ä¸€ä¸ªå°†æŸ¥è¯¢æ˜ å°„åˆ°æŸ¥è¯¢å¤„ç†ç¨‹åºçš„è°ƒåº¦ç¨‹åº(ç±»ä¼¼äº Mediatr çš„å·¥ä½œæ–¹å¼)ã€‚

å…³é”®æ˜¯ï¼Œæ‚¨éœ€è¦æŸç§æŠ½è±¡æ¥ä¿æŒè¯·æ±‚å¤„ç†ç¨‹åºä¸æ•°æ®è®¿é—®æŠ€æœ¯çš„æ¾æ•£è€¦åˆã€‚

#### å…³äºå­˜å‚¨åº“çš„å¿«é€Ÿè¯´æ˜...

å‡ºäºå‡ ä¸ªåŸå› ï¼Œæˆ‘å¹¶ä¸å–œæ¬¢å®šåˆ¶çš„å­˜å‚¨åº“ã€‚

1.  æˆ‘ä»¬ç»å¸¸ä½¿ç”¨å·²ç»æ˜¯å­˜å‚¨åº“çš„å¯¹è±¡å…³ç³»æ˜ å°„å™¨(ä¾‹å¦‚:å®ä½“æ¡†æ¶æˆ– Kentico çš„`ObjectQuery<T>`ã€`DocumentQuery<T>`å’Œé™æ€`*Provider`ç±»å‹)ï¼Œæ‰€ä»¥[å°†ä¸€ä¸ªå­˜å‚¨åº“åŒ…è£…åœ¨å¦ä¸€ä¸ª](https://lostechies.com/jimmybogard/2012/10/08/favor-query-objects-over-repositories/)ä¸­æ„Ÿè§‰åƒæ˜¯æ»¥ç”¨æ¨¡å¼ã€‚

2.  è‡ªå®šä¹‰ç¼–å†™çš„å­˜å‚¨åº“å˜æˆäº†å¤„ç†ç›¸åŒç±»å‹(ä¾‹å¦‚:`EmployeeContent`)ä½†ç”¨é€”ä¸åŒçš„æ–¹æ³•çš„å¤§è¢‹ã€‚å®ƒä»¬æ‰“ç ´äº†å•ä¸€å“åº”åŸåˆ™ï¼Œé€šå¸¸æ²¡æœ‰ç†ç”±åŒ…å«å®ƒä»¬åŒ…å«çš„æ‰€æœ‰æ–¹æ³•ï¼Œå› ä¸ºå­˜å‚¨åº“ç±»æœ¬èº«åœ¨æ–¹æ³•ä¹‹é—´æ²¡æœ‰ä»»ä½•å…±äº«çŠ¶æ€ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘æ›´å–œæ¬¢ä½¿ç”¨å‘½ä»¤/æŸ¥è¯¢è´£ä»»åˆ†ç¦»æ¨¡å¼ï¼Œå¹¶ä½¿ç”¨[æŸ¥è¯¢ã€æŸ¥è¯¢å¤„ç†ç¨‹åºå’Œè°ƒåº¦ç¨‹åº](https://weblogs.asp.net/shijuvarghese/cqrs-commands-command-handlers-and-command-dispatcher)ğŸ’ªã€‚

ä¸‹é¢æˆ‘å°†ä½¿ç”¨ä¸€ä¸ªç®€å•çš„`Query`ï¼Œä½†æ˜¯ä½¿ç”¨ä½ æœ€ç†Ÿæ‚‰çš„æ¨¡å¼ğŸ¤—ã€‚

å½“ç„¶ï¼Œä¸ºäº†å¯æµ‹è¯•æ€§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŸºäºæ„é€ å‡½æ•°çš„ä¾èµ–æ³¨å…¥ğŸ˜ï¼

* * *

ä¸‹é¢æ˜¯æˆ‘ä»¬çš„è¯·æ±‚å¤„ç†ç¨‹åºçš„ç®€å•å®ç°ï¼Œè¿™æ˜¯æˆ‘ä»¬å°†è¦ä¸ºå…¶ç¼–å†™å•å…ƒæµ‹è¯•çš„ä»£ç ã€‚

```
public class EmployeesListPageRequestHandler
    : RequestHandler<EmployeeListPageRequest, EmployeeListPageViewModel>
{
    private readonly IEmployeeQuery query;

    public EmployeesListPageRequestHandler(IEmployeesQuery query)
    {
        this.query = query;
    }

    protected override EmployeeListPageViewModel Handle(
        EmployeeListPageRequest request)
    {
        IEnumerable<EmployeeContent> employees = query.Execute(request.EmployeeCount);

        if (employees is null)
        {
            return new EmployeeListPageViewModel(
                employees: Enumerable.Empty<EmployeeContent>(),
                count: 0);
        }

        var employeeViewModels = employees.Select(e =>
        {
            string imageUrl = e.Fields.Image.GetPath();

            new EmployeeViewModel(
                name: e.Fields.Name,
                imageUrl: imageUrl,
                hireDate: e.Fields.HireDate
        }));

        return new EmployeeListPageViewModel(
                employees: employeeViewModels,
                count: employeeViewModels.Count());
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªç±»å¤§æ¦‚ä»æ•°æ®åº“ä¸­æ£€ç´¢`EmployeeContent`ï¼Œå¤„ç†æ— æ•ˆæ•°æ®ï¼Œå¹¶è¿”å›æœ‰æ•ˆçš„è§†å›¾æ¨¡å‹å®ä¾‹ã€‚

éå¸¸æ™®é€šçš„ç”¨ä¾‹ï¼

## è®¾ç½®æˆ‘ä»¬çš„æµ‹è¯•

æ—¢ç„¶æˆ‘ä»¬å·²ç»æ­å»ºå‡ºäº†æ‰€æœ‰æƒ³è¦æµ‹è¯•çš„ä»£ç ï¼Œå¹¶ä¸”ç¡®å®šäº†æˆ‘ä»¬çš„æµ‹è¯•å°†ä¸ä¹‹äº¤äº’çš„å…³é”®é¢†åŸŸï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºæˆ‘ä»¬çš„å•å…ƒæµ‹è¯•ğŸ¥³å§ï¼

### åˆ›å»ºæµ‹è¯•ç±»- `EmployeesListPageRequestHandlerTests`

é¦–å…ˆï¼Œè®©æˆ‘ä»¬æŒ‰ç…§ Kentico çš„å•å…ƒæµ‹è¯•æ–‡æ¡£åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±»å’Œæµ‹è¯•æ–¹æ³•ã€‚

```
using CMS.Tests;
using NUnit.Framework;
using using System.Threading.Tasks;

[TestFixture]
public class EmployeesListPageRequestHandlerTests : UnitTests
{
    [Test]
    public async Task Handle_Will_Initialize_ViewModel()
    {
        // Arrange

        // Act

        // Assert
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬éœ€è¦ä»`CMS.Tests`åç§°ç©ºé—´ä¸­çš„`UnitTests`ç»§æ‰¿ã€‚

è¿™å°†è®©æˆ‘ä»¬å‘Šè¯‰ Kenticoï¼Œæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæµ‹è¯•ä½¿ç”¨é€šå¸¸æ¥è‡ªæ•°æ®åº“(æˆ‘ä»¬çš„è‡ªå®šä¹‰é¡µé¢ç±»å‹å®ä¾‹)çš„æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬å°†åœ¨æµ‹è¯•ä¸­è‡ªå·±æä¾›æ•°æ®ğŸ‘ã€‚

æˆ‘ä»¬ä¹Ÿå°†æŠŠæˆ‘ä»¬çš„æµ‹è¯•æ–¹æ³•åˆ†æˆä¸‰ä¸ªé˜¶æ®µâ€”â€”å®‰æ’ã€è¡ŒåŠ¨å’Œæ–­è¨€ã€‚

### å®‰æ’æˆ‘ä»¬çš„æµ‹è¯•-è‡ªåŠ¨ä¿®å¤ã€n æ›¿ä»£å’Œ Kentico å‡è´§

ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹æµ‹è¯•çš„â€œå®‰æ’â€é˜¶æ®µã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ [AutoFixture](https://github.com/AutoFixture/AutoFixture) æ¥ä¸ºæˆ‘ä»¬çš„æµ‹è¯•åˆ›å»ºå€¼ã€‚

å¤§å¤šæ•°æ—¶å€™ï¼Œæµ‹è¯•ä¸­ä½¿ç”¨çš„å®é™…å€¼å¹¶ä¸é‡è¦ã€‚

è¿™äº›å€¼è¢«ä¼ é€’å¹¶å¯èƒ½è¢«ä¿®æ”¹ï¼Œä½†æ˜¯åªè¦æµ‹è¯•ç»“æŸæ—¶çš„å€¼ä¸å¼€å§‹æ—¶çš„å€¼ä¸€è‡´â€”â€”ç»™å®šæµ‹è¯•å¯¹è±¡çš„è¿‡ç¨‹(`sut`)â€”â€”æˆ‘ä»¬å¹¶ä¸çœŸæ­£å…³å¿ƒåŸå§‹å€¼æ˜¯ä»€ä¹ˆã€‚

AutoFixture å…è®¸æˆ‘ä»¬åŠ¨æ€åˆ›å»ºæœ‰æ•ˆå€¼ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­:

```
using AutoFixture;

...

// Arrange

var fixture = new DomainFixture();

string name = fixture.Create<string>();

// Do something with name ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬éœ€è¦å‘Šè¯‰ Kenticoï¼Œæˆ‘ä»¬æƒ³è¦åˆ›å»ºæˆ‘ä»¬çš„`EmployeeContent`é¡µé¢ç±»å‹çš„å‡å®ä¾‹ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒä»¬ä½œä¸ºä»æˆ‘ä»¬çš„`EmployeesQuery`è¿”å›çš„å€¼æ¥æä¾›ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºå‡çš„`EmployeeContent`å®ä¾‹ã€‚

å¯¹äºä» Kentico å¯¼å…¥åç§°ç©ºé—´ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹é¢çš„`using`è¯­å¥:

```
using CMS.DataEngine;
using CMS.DocumentEngine;
using CMS.DocumentEngine.Types.Sandbox;
using CMS.Tests;
using Tests.DocumentEngine; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†ä½¿ç”¨ä»`UnitTests`ç»§æ‰¿è€Œæ¥çš„`Fake()`æ–¹æ³•æ¥å‘Šè¯‰ Kentico æˆ‘ä»¬æƒ³è¦ä¼ªé€ å¯¹ä¸€äº›æ•°æ®çš„è®¿é—®ã€‚

æˆ‘ä»¬è¿˜å°†ä½¿ç”¨`DocumentType<T>()`æ‰©å±•æ–¹æ³•æ¥å‘Šè¯‰ Kentico æˆ‘ä»¬å°†ä¼ªé€ ä»€ä¹ˆç±»å‹çš„é¡µé¢ç±»å‹ã€‚

```
Fake().DocumentType<EmployeeContent>(EmployeeContent.CLASS_NAME); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„è¡Œåªå‘Šè¯‰ Kentico æˆ‘ä»¬çš„æ„å›¾â€”â€”å®ƒå®é™…ä¸Šå¹¶æ²¡æœ‰åˆ›å»ºä»»ä½•`EmployeeContent`çš„å®ä¾‹ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥åš:

```
var employee = TreeNode.New<EmployeeContent>().With(e =>
{
    e.Fields.Name = fixture.Create<string>();
    e.Fields.HireDate = fixture.Create<DateTime>();
    e.EmployeeContentImage = fixture.Create<Guid>();
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ ä¼šæ³¨æ„åˆ°æˆ‘ä»¬æ²¡æœ‰ç»™`e.Fields.Image`èµ‹å€¼ï¼Œå› ä¸ºå®ƒæ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»™å®ƒçš„åå°å­—æ®µ`EmployeeContentImage`èµ‹å€¼`Guid`ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬è°ƒç”¨`EmployeeContent.Fields.Image`æ—¶ï¼Œæˆ‘ä»¬å¦‚ä½•å°†é‚£ä¸ª`Guid`è½¬æ¢æˆ`DocumentImage`çš„å®ä¾‹å‘¢ğŸ¤”ï¼Ÿ

æˆ‘ä»¬å°†éœ€è¦ Kentico ä¸ºæˆ‘ä»¬åšè¿™äº›ï¼Œä½†è¿™å°†éœ€è¦æ¨¡ä»¿æ›´å¤šçš„æ•°æ®

```
var attachmentGuid = fixture.Create<Guid>();

Fake<AttachmentInfo, AttachmentInfoProvider>()
    .WithData(new AttachmentInfo
    {
        AttachmentGUID = attachmentGuid
    });

Fake().DocumentType<EmployeeContent>(EmployeeContent.CLASS_NAME);

var employee = TreeNode.New<EmployeeContent>().With(e =>
{
    e.Fields.Name = fixture.Create<string>();
    e.Fields.HireDate = fixture.Create<DateTime>();
    e.EmployeeContentImage = attachmentGuid;
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„æˆ‘ä»¬æ˜¯å¦‚ä½•å°†`attachmentGuid`å€¼ç”¨äºä¼ªé€ çš„`AttachmentInfo.AttachmentGUID`å±æ€§å’Œ`EmployeeContent.EmployeeContentImage`å±æ€§çš„ã€‚

è¿™å°†å…è®¸ Kentico åœ¨æµ‹è¯•è¿è¡Œæ—¶å°†è¿™ä¸¤ä¸ªå®ä¾‹è”ç³»åœ¨ä¸€èµ·ã€‚

åŸæ¥`TreeNode.GetFieldDocumentAttachment()`è°ƒç”¨`AttachmentInfoProvider.GetAttachmentInfo()`ï¼Œä¼ é€’è¦æ£€ç´¢çš„é™„ä»¶çš„`Guid`ã€‚

å› æ­¤ï¼Œåªè¦æˆ‘ä»¬ä½¿ç”¨`AttachmentInfoProvider`ä¼ªé€ ä¸€ä¸ª`AttachmentInfo`ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿè®¾ç½®æˆ‘ä»¬çš„æµ‹è¯•çŠ¶æ€ï¼Œä½¿å…¶å®Œå…¨åœ¨å†…å­˜ä¸­å·¥ä½œï¼Œè€Œä¸éœ€è¦æ•°æ®åº“ğŸ¤˜ğŸ‰ğŸ”¥ã€‚

* * *

ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥æä¾›æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„`employee`ï¼Œä½œä¸ºæˆ‘ä»¬çš„`IEmployeeQuery`ä¸º`Execute()`è°ƒç”¨è¿”å›çš„å€¼ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [NSubstitute](https://nsubstitute.github.io/) ç”¨æœ€å°‘çš„å®ç°æ¥å­˜æ ¹æˆ‘ä»¬çš„æ¥å£ï¼Œè¿™äº›å®ç°åªè¿”å›å€¼è€Œä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚

```
using NSubstitute;

// Arrange

var query = Substitute.For<IEmployeeQuery>();

query
    .Execute(Arg.Is(request.EmployeeCount))
    .Returns(new [] { employee }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬æŠŠæµ‹è¯•çš„å®‰æ’é˜¶æ®µçš„æ‰€æœ‰éƒ¨åˆ†æ”¾åœ¨ä¸€èµ·:

```
[Test, AutoDomainData]
public async Task public async Task Handle_Will_Initialize_ViewModel()
{
    // Arrange

    var attachmentGuid = fixture.Create<Guid>();

    Fake<AttachmentInfo, AttachmentInfoProvider>()
        .WithData(new AttachmentInfo
        {
            AttachmentGUID = attachmentGuid
        });

    Fake().DocumentType<EmployeeContent>(EmployeeContent.CLASS_NAME);

    var employee = TreeNode.New<EmployeeContent>().With(e =>
    {
        e.Fields.Name = fixture.Create<string>();
        e.Fields.HireDate = fixture.Create<DateTime>();
        e.EmployeeContentImage = attachmentGuid;
    });

    var request = fixture.Create<EmployeeListPageRequest>();

    var query = Substitute.For<IEmployeeQuery>();

    query
        .Execute(Arg.Is(request.EmployeeCount))
        .Returns(new [] { employee });

    IRequestHandler<EmployeeListPageRequest, EmployeeListPageViewModel> sut =
        new NewsRequestHandler(query);

    // Act

    // Assert
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

* * *

### è¡¨æ¼”æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹

ç°åœ¨æ˜¯ç®€å•çš„éƒ¨åˆ†â€”â€”è¡ŒåŠ¨é˜¶æ®µ:

```
var viewModel = await sut.Handle(request, default); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ˜¯çš„ï¼Œå°±æ˜¯è¿™æ ·ã€‚æ‰€æœ‰çš„å·¥ä½œé€šå¸¸éƒ½è¿›å…¥æµ‹è¯•çš„å®‰æ’å’Œæ–­è¨€é˜¶æ®µï¼Œå› ä¸º Act é˜¶æ®µå·²ç»ç¼–å†™å¥½äº†â€”â€”è¿™æ˜¯æ‚¨æ­£åœ¨æµ‹è¯•çš„æ–¹æ³•çš„ä¸»ä½“ï¼

### åœ¨æˆ‘ä»¬çš„æµ‹è¯•ç»“æœä¸Šæ–­è¨€-æµé‡è¯„ä¼°

æˆ‘ä»¬ç°åœ¨éœ€è¦æ–­è¨€æµ‹è¯•æ•°æ®çš„çŠ¶æ€æ­£æ˜¯æˆ‘ä»¬åœ¨ Act é˜¶æ®µä¹‹åæ‰€æœŸæœ›çš„çŠ¶æ€ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ã€‚NET çš„å†…ç½®æ–­è¨€è°ƒç”¨(åœ¨`Microsoft.VisualStudio.TestTools.UnitTesting`åç§°ç©ºé—´ä¸­)ï¼Œä½†æ˜¯`NUnit`å·²ç»åœ¨`NUnit.Framework`åç§°ç©ºé—´ä¸­ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘æ›´å–œæ¬¢ä½¿ç”¨åƒ[fluent assessments](https://fluentassertions.com/introduction)è¿™æ ·çš„åº“æ¥æä¾›æ›´åŠ è¡Œä¸ºé©±åŠ¨çš„æ–­è¨€å¼€å‘é£æ ¼ï¼Œæˆ‘å‘ç°è¿™ä½¿å¾—æµ‹è¯•æ›´å…·å¯è¯»æ€§ğŸ˜‰ã€‚

FluentAssertions ä½¿ç”¨æ‰©å±•æ–¹æ³•æä¾›å¦‚ä¸‹è¯­æ³•:

```
SomeViewModel viewModel = ...

viewModel.Should().NotBeNull();

viewModel.FirstName.Should().Be("abc"); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å› æ­¤ï¼Œè®©æˆ‘ä»¬åœ¨å¯¹æµ‹è¯•å¯¹è±¡é‡‡å–è¡ŒåŠ¨åï¼Œä½¿ç”¨ FluentAssertions æ¥æ–­è¨€æµ‹è¯•çš„çŠ¶æ€:

> æˆ‘å°†åœ¨ç¼–æ›²å’Œè¡¨æ¼”é˜¶æ®µåŠ å…¥ä¸€äº›ç‰‡æ®µä»¥ä¾›å‚è€ƒã€‚

```
// Arrange

...

var employee = TreeNode.New<EmployeeContent>().With(e =>
{
    e.Fields.Name = fixture.Create<string>();
    e.Fields.HireDate = fixture.Create<DateTime>();
    e.EmployeeContentImage = attachmentGuid;
});

...

// Act

var viewModel = await sut.Handle(request, default);

// Assert

viewModel.Count.Should().Be(1);

var employeeViewModel = viewModel.Employees.First();

employeeViewModel.Name.Should().Be(employee.Fields.Name);
employeeViewModel.HireDate.Should().Be(employee.Fields.HireDate);

employeeViewModel.ImageUrl
    .Should()
    .Contain(employee.EmployeeContentImage.ToString()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬åœ¨è¿™é‡Œçš„æ–­è¨€é™ˆè¿°äº†ä»¥ä¸‹å†…å®¹:

*   è§†å›¾æ¨¡å‹ä¸­åº”è¯¥åªæœ‰(1)ä¸ªé›‡å‘˜ã€‚
*   `EmployeeViewModel`çš„å€¼åº”è¯¥ä¸`EmployeeContent`å®ä¾‹çš„å€¼ç›¸åŒ¹é…ã€‚
*   `EmployeeViewModel.ImageUrl`åº”è¯¥åŒ…å«ä¸`EmployeeViewModel.EmployeeContentImage`çš„`Guid`åŒ¹é…çš„å­—ç¬¦ä¸²`Guid`ã€‚

å¯¹äºæœ€åä¸€ä¸ªæ–­è¨€ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å…·ä½“ä¸€äº›ï¼Œç¡®ä¿ç”± Kentico çš„`DocumentAttachment.GetPath()`æ–¹æ³•åˆ›å»ºçš„ URL ä¸æˆ‘ä»¬æœŸæœ›çš„åŒ¹é…ï¼Œä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦åœ°åŒ¹é…ï¼Œä½†æ˜¯æˆ‘å¯¹æˆ‘ä»¬æ‰€æ‹¥æœ‰çš„å¾ˆæ»¡æ„ã€‚

## æ€»ç»“

çœ‹çœ‹æˆ‘ä»¬åˆ¶é€ çš„ç¾ä¸½çš„æ··ä¹±ğŸ¤£ï¼

æˆ‘ä»¬æŸ¥çœ‹äº†ä¸€äº›è®¾è®¡æ¨¡å¼ï¼Œå®ƒä»¬å°†å¸®åŠ©æˆ‘ä»¬æ„å»ºæˆ‘ä»¬çš„ Kentico MVC åº”ç”¨ç¨‹åºï¼Œå¹¶è®¾ç½®æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘(æ­¤æ—¶ä¸»è¦æ˜¯æ•°æ®è®¿é—®)ï¼Œä½¿å…¶ 100%å¯æµ‹è¯•ğŸ‘ï¼

æˆ‘ä»¬è¿˜ä½¿ç”¨ Kentico çš„æµ‹è¯• API æ¥å¸®åŠ©æˆ‘ä»¬æ¨¡æ‹Ÿæ•°æ®ï¼Œå¹¶ç¡®ä¿æˆ‘ä»¬çš„æµ‹è¯•å¯ä»¥ä½œä¸ºå•å…ƒæµ‹è¯•è€Œä¸æ˜¯é›†æˆæµ‹è¯•æ¥è¿è¡ŒğŸ‘ã€‚

è¿™å°†ä½¿æµ‹è¯•è¿è¡Œå¾—æ›´å¿«ï¼Œå¹¶ä¸”éšç€æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„å˜åŒ–è€Œå˜å¾—ä¸é‚£ä¹ˆè„†å¼±ğŸ‘ã€‚

æœ€åæˆ‘ä»¬åˆ©ç”¨äº†ä¸€äº›ã€‚NET æµ‹è¯•åº“(AutoFixtureã€NSubstitute å’Œ FluentAssertions)æ¥å¸®åŠ©æˆ‘ä»¬å…³æ³¨æµ‹è¯•çš„å…³é”®é˜¶æ®µâ€”â€”å®‰æ’ã€æ‰§è¡Œå’Œæ–­è¨€ğŸ‘ã€‚

> æˆ‘ä»¬å¿½ç•¥äº†ä¸€ä¸ªå…³é”®çš„æµ‹è¯•åœºæ™¯â€”â€”å¦‚æœæˆ‘ä»¬çš„`IEmployeesQuery`è¿”å›çš„æ•°æ®æ˜¯`null`ä¼šæ€ä¹ˆæ ·ï¼Ÿæˆ‘ä»¬åœ¨è¯·æ±‚å¤„ç†ç¨‹åºä¸­å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰é’ˆå¯¹è¿™ä¸ªåœºæ™¯è¿›è¡Œæµ‹è¯•ã€‚
> 
> è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹åº”è¯¥æ˜¯ä¸€ä¸ªå•ç‹¬çš„æµ‹è¯•æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨å…¶ä¸­é‡æ–°å®‰æ’ã€æ“ä½œå’Œæ–­è¨€ï¼Œä½†æ˜¯è¿™ä¸€æ¬¡å®‰æ’å’Œæ–­è¨€é˜¶æ®µæ˜¯ä¸ºä¸€ä¸ª`null`æ•°æ®åœºæ™¯è®¾ç½®çš„ã€‚
> 
> æˆ‘å°†æŠŠè¿™ç•™ç»™æ‚¨æ¥å®ç°ğŸ¤“ï¼

å¦‚æœä½ æœ‰ä»»ä½•åé¦ˆï¼Œæˆ–è€…æ¨èä½ å–œæ¬¢çš„å†™æµ‹è¯•çš„æ–¹æ³•ï¼Œæˆ‘å¾ˆä¹æ„åœ¨ä¸‹é¢çš„è¯„è®ºä¸­å¬åˆ°ã€‚

æ„Ÿè°¢é˜…è¯»ï¼

* * *

å¦‚æœæ‚¨æ­£åœ¨å¯»æ‰¾æ›´å¤šçš„ Kentico å†…å®¹ï¼Œè¯·åœ¨ DEV:

## # [è‚¯è’‚ç§‘](https://dev.to/t/kentico) <button name="button" type="button" data-info="{&quot;className&quot;:&quot;Tag&quot;,&quot;style&quot;:&quot;full&quot;,&quot;id&quot;:5339,&quot;name&quot;:&quot;kentico&quot;}" class="crayons-btn follow-action-button whitespace-nowrap c-btn--secondary fs-base " aria-label="Follow tag: kentico" aria-pressed="false">è·Ÿéš</button>

æˆ–è€…æˆ‘çš„ Kentico åšå®¢ç³»åˆ—:

*   [Kentico 12:è®¾è®¡æ¨¡å¼](https://dev.to/search?q=Kentico%2012%20-%20Design%20Patterns)
*   [Kentico CMS å¿«é€Ÿæç¤º](https://dev.to/search?q=Kentico%20CMS%20Quick%20Tip)