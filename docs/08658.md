# åœ¨ TravisCI ä¸­ä½¿ç”¨ API ä»¤ç‰Œåˆ†å‘ PyPI åŒ…

> åŸæ–‡:[https://dev . to/oscarmcm/distributing-pypi-packages-using-API-tokens-in-travisci-1n9i](https://dev.to/oscarmcm/distributing-pypi-packages-using-api-tokens-in-travisci-1n9i)

*PyPI* åŒ…ç´¢å¼•æ˜¯ä½¿ **Python** å¦‚æ­¤å¼ºå¤§çš„å·¥å…·ä¹‹ä¸€ï¼Œåªéœ€ä¸€ä¸ªç®€å•çš„å‘½ä»¤ï¼Œä½ å°±å¯ä»¥è®¿é—®æ•°åƒä¸ªå¾ˆé…·çš„åº“ï¼Œä¸ºä½ çš„é¡¹ç›®åšå¥½å‡†å¤‡ã€‚

ç¼–å†™ **Python** åŒ…å¹¶å°†å®ƒä»¬éƒ¨ç½²åˆ° *PyPI* æ˜¯å¼€æºç¤¾åŒºå…±äº«åº“çš„ä¸€ç§æ–¹å¼ã€‚å¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œå‘ *PyPI* æäº¤ä¸€ä¸ªåŒ…ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œä½†æ˜¯ç¤¾åŒºæ­£åœ¨åŠªåŠ›å·¥ä½œï¼Œä¸ºäº†ä½¿è¿™ä¸ªè¿‡ç¨‹æ›´å®¹æ˜“ï¼Œä½ å¯ä»¥é˜…è¯»æ›´å¤šå…³äºæ‰“åŒ…çš„å†…å®¹ï¼Œéµå¾ªå®˜æ–¹ [Python æ‰“åŒ…æŒ‡å—](https://packaging.python.org/tutorials/packaging-projects/)ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è·³è¿‡ä¸€äº›å…³äºæ‰“åŒ…çš„äº‹æƒ…/æ­¥éª¤ï¼Œå¹¶æŒ‡å¯¼æ‚¨åœ¨ *PyPI* ä¸­ä½¿ç”¨æœ€æ–°çš„ [API ä»¤ç‰Œ](http://pyfound.blogspot.com/2019/07/pypi-now-supports-uploading-via-api.html)ç‰¹æ€§ï¼Œç”¨äºæ‚¨çš„æŒç»­é›†æˆå’Œéƒ¨ç½²(CI/CD)ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [PyPI æµ‹è¯•](https://test.pypi.org/)å®ä¾‹ï¼Œè¿™æ˜¯åœ¨ä½ çš„åŒ…ä¸­è¿›è¡Œåˆå§‹æµ‹è¯•çš„æ›´å¥½é€‰æ‹©ï¼Œæ¯”å¦‚:æµ‹è¯•æ–‡æ¡£æ˜¯å¦æ­£ç¡®å‘ˆç°ï¼Œæˆ–è€…ä½ çš„`setup.py`ä¸­çš„[åˆ†ç±»å™¨](https://pypi.org/classifiers/)æ˜¯å¦æ­£ç¡®ã€‚

## [](#using-travis-ci)ä½¿ç”¨ç‰¹æ‹‰ç»´æ–¯è¯

æˆåŠŸæ„å»ºåï¼Œ *Travis CI* å¯ä»¥è‡ªåŠ¨é‡Šæ”¾ä½ çš„ **Python** åŒ…åˆ° *PyPI* ã€‚å¯¹äºæœ€å°é…ç½®ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„`.travis.yml`æ–‡ä»¶ä¸­ä½¿ç”¨ä¸‹é¢çš„ä»£ç :

```
deploy:
  provider: pypi
  user: "Your  username"
  password: "Your  password" 
```

ç„¶è€Œï¼Œæ­£å¦‚ä½ å¯èƒ½æ³¨æ„åˆ°çš„ï¼Œè¿™ä¼šå°†ä½ çš„ *PyPI* å¯†ç å…¬ä¹‹äºä¼—ï¼Œè¿™æ˜¯ä¸€ä¸ªåä¸»æ„ã€‚Travis æ¨èçš„æ˜¯åŠ å¯†å¯†ç æˆ–å°†å‡­è¯ä¿å­˜ä¸º Travis ç¯å¢ƒå˜é‡ï¼Œä½ å¯ä»¥åœ¨ [Travis éƒ¨ç½²æ–‡æ¡£](https://docs.travis-ci.com/user/deployment/pypi/)ä¸Šäº†è§£æ›´å¤šä¿¡æ¯ã€‚

### [](#get-the-pypi-tokens)è·å– PyPI ä»¤ç‰Œ

æ‰€ä»¥ï¼Œç¬¬ä¸€ä»¶è¦åšçš„äº‹ï¼Œå°±æ˜¯å»[https://test.pypi.org/](https://test.pypi.org/)åˆ›å»ºä¸€ä¸ªè´¦æˆ·(å¦‚æœä½ æ²¡æœ‰)æˆ–ç™»å½•ï¼Œä¹‹åï¼Œæˆ‘ä»¬å°†éœ€è¦æˆ‘ä»¬çš„ *API ä»¤ç‰Œ*ã€‚å¦‚ä½•è·å¾—ï¼Ÿè¿›å…¥ä½ çš„ *PyPI* è´¦æˆ·è®¾ç½®ï¼Œé€‰æ‹©â€œæ·»åŠ  API ä»¤ç‰Œâ€ã€‚å½“æ‚¨åˆ›å»º API ä»¤ç‰Œæ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©å®ƒçš„èŒƒå›´:æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªä»¤ç‰Œï¼Œç”¨äºä¸Šä¼ åˆ°æ‚¨ç»´æŠ¤æˆ–æ‹¥æœ‰çš„æ‰€æœ‰é¡¹ç›®ï¼Œæˆ–è€…æ‚¨å¯ä»¥å°†å…¶èŒƒå›´é™åˆ¶ä¸ºä¸€ä¸ªé¡¹ç›®ã€‚

[![](../Images/a7769983ff91cbf80811904b8ff52c85.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--tYjUCxjj--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/js4fdwiifbvbyvstc8zo.png)

### [](#how-to-use-the-tokens)å¦‚ä½•ä½¿ç”¨ä»£å¸

å½“å°†åŒ…ä¸Šä¼ åˆ° *PyPI* æ—¶ï¼ŒAPI ä»¤ç‰Œæä¾›äº†å¦ä¸€ç§è®¤è¯æ–¹å¼(è€Œä¸æ˜¯ç”¨æˆ·åå’Œå¯†ç )ã€‚

è¿™äº› API ä»¤ç‰Œåªèƒ½ç”¨äºå°†åŒ…ä¸Šä¼ åˆ° PyPIï¼Œè€Œä¸æ˜¯æ›´ä¸€èˆ¬çš„ç™»å½•ï¼Œå› ä¸ºå¤åˆ¶ä»¤ç‰Œçš„çªƒè´¼å°†æ— æ³•åˆ é™¤é¡¹ç›®ã€åˆ é™¤æ—§ç‰ˆæœ¬æˆ–æ·»åŠ /åˆ é™¤åˆä½œè€…ã€‚

æ­£å¦‚æ‚¨åœ¨ä¸‹é¢çš„æˆªå›¾ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘å·²ç»æˆåŠŸåœ°åœ¨ PyPI ä¸Šæ‰‹åŠ¨éƒ¨ç½²äº†æ¼”ç¤ºé¡¹ç›®çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬:

[![](../Images/8562473df45fa763a9b8aea91aeddbe1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--7LnZ-eSM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/xz68e9fukw7icfkui8a5.png)

ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªé¡¹ç›®å¯ç”¨*ç‰¹æ‹‰ç»´æ–¯*ï¼Œæ‰€ä»¥è½¬åˆ°å¹¶å¯ç”¨å®ƒï¼Œä¹‹åæˆ‘ä»¬å¿…é¡»æ›´æ”¹æˆ‘ä»¬çš„`.travis.yml`æ–‡ä»¶ä¸­çš„ä»¥ä¸‹å†…å®¹:

*   å°†ç”¨æˆ·åè®¾ç½®ä¸º`__token__`ã€‚
*   å°†å¯†ç è®¾ç½®ä¸ºä»¤ç‰Œå€¼ï¼ŒåŒ…æ‹¬`pypi-`å‰ç¼€ã€‚

ä¸ºäº†æ›´åŠ å®‰å…¨ï¼Œæˆ‘ä»¬å°†æŠŠä»¤ç‰Œå­˜å‚¨ä¸ºç¯å¢ƒå˜é‡ï¼Œè½¬åˆ° https://travis-ci.org/çš„**//è®¾ç½®**ï¼Œç°åœ¨æˆ‘ä»¬çš„`.travis.yml`æ–‡ä»¶å°†å¦‚ä¸‹æ‰€ç¤º:

```
deploy:
  provider: pypi
  user: __token__
  password: $TEST_PYPI_TOKEN
  server: https://test.pypi.org/legacy/
  distributions: "sdist  bdist_wheel"
  on:
    branch: staging
    condition: $TRAVIS_PYTHON_VERSION = "3.6" 
```

ç°åœ¨ï¼Œæ¯å½“æˆ‘ä»¬å°†ä»£ç æ¨é€åˆ°*è¯•è¿è¡Œ*åˆ†æ”¯æ—¶ï¼Œ *Travis* å°†è§¦å‘è‡ªåŠ¨éƒ¨ç½²åˆ° *PyPI* æµ‹è¯•å®ä¾‹ã€‚å¯¹ä»£ç åº“åšä¸€äº›å°çš„æ”¹åŠ¨ï¼Œæ›´æ”¹`setup.py`ç‰ˆæœ¬å·ï¼Œç„¶åæ¨é€åˆ° *staging* åˆ†æ”¯ï¼Œ *Travis* å°†è§¦å‘æ„å»ºï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå°†æ–°ç‰ˆæœ¬éƒ¨ç½²åˆ° *PyPI* ã€‚

[![](../Images/dc255cb8dcd8ac4d52d565fdf9bf136e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--FN3skg1A--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/j0n1h21o1ulv7in5rl86.png)

æˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ„å»ºæ—¥å¿—æ¥æŸ¥çœ‹éƒ¨ç½²è¿‡ç¨‹æ˜¯å¦æ­£ç¡®å¯åŠ¨:

[![](../Images/88cb4db5d827898d158db0835e2c1e8a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Lqk_bq-x--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/hf1p4lgjx9aaqfsqf64y.png)

ç§ï¼Œåœ¨ç¬¬ *271* è¡Œä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°éƒ¨ç½²æµç¨‹å·²å¯åŠ¨ï¼Œå¦‚æœæ‚¨å±•å¼€è¯¥è¡Œï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—:

[![](../Images/4a9ad0433ec25a4f3c59cbb92081a123.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--HI4bPNNw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/in5rcm8ljalsyfk8zvpy.png)

è¿™æ„å‘³ç€æˆ‘ä»¬çš„æ–°ç‰ˆæœ¬ä¸Šä¼ æ­£ç¡®ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ *PyPI* ä¸­çœ‹åˆ°å®ƒï¼Œä½¿ç”¨æ–°çš„ API ä»¤ç‰Œä¸ *Travis* ä¸€èµ·è‡ªåŠ¨éƒ¨ç½²:

[![](../Images/d37879b18e5f043150a0737d3c4bfefb.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--RotIaiCq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ityi3uscghk93qsf7m98.png)

## [](#conclusion)ç»“è®º

è¿™æ˜¯ Python åŒ…ç´¢å¼•çš„ä¸€å¤§è¿›æ­¥ï¼Œå¢åŠ äº†æ–°çš„å¤šç§ç‰¹æ€§çš„å®‰å…¨æ€§ï¼Œå¹¶å‡å°‘äº†æ‰€æœ‰ä½¿å…¶éš¾ä»¥å·¥ä½œçš„ç‰¹æ€§ï¼Œå¯¹äº **Python** ç¤¾åŒºæ¥è¯´ï¼Œè¿™è¦æ„Ÿè°¢[æ‰“åŒ…å·¥ä½œç»„](https://wiki.python.org/psf/PackagingWG)å’Œ[å¼€æ”¾æŠ€æœ¯åŸºé‡‘](https://pyfound.blogspot.com/2019/03/commencing-security-accessibility-and.html)çš„èµ„åŠ©ã€‚

ä½ å¯ä»¥åœ¨å®˜æ–¹çš„ [PSF åšå®¢](http://pyfound.blogspot.com/2019/07/pypi-now-supports-uploading-via-api.html)ä¸Šé˜…è¯»æ›´å¤šå…³äº API ä»¤ç‰Œçš„å†…å®¹ï¼Œæˆ–è€…å¸®åŠ©æµ‹è¯•è¿™ä¸ª [beta ç‰¹æ€§](https://wiki.python.org/psf/WarehousePackageMaintainerTesting)ã€‚å¦‚æœä½ æƒ³çœ‹è¿™ç¯‡æ–‡ç« çš„è¥¿ç­ç‰™è¯­ç‰ˆæœ¬ï¼Œä½ å¯ä»¥åœ¨[æˆ‘çš„åšå®¢](https://oscarmcm.com/essays/2019/distributing-packages-via-pypi-tokens)ä¸Šæ‰¾åˆ°ã€‚æºä»£ç ä¹Ÿå¯ä»¥åœ¨ GitHub ä¸Šè·å¾—[ã€‚](https://github.com/oscarmcm/pypi-token-demo)

å°±æ˜¯è¿™æ ·ï¼ä»è¿™é‡Œä½ å¯ä»¥è‡ªåŠ¨å‘å¸ƒæ–°çš„åŒ…ç‰ˆæœ¬ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å§ï¼Œå‘å¸ƒä¸€äº›ä¸œè¥¿åˆ° *PyPI* ğŸã€‚

æ„Ÿè°¢ [@Darwing1210](https://twitter.com/Darwing1210/) å’Œ [@guadamzjj](https://twitter.com/guadamzjj/) å®¡é˜…æœ¬æ–‡ã€‚

æ¥è‡ªğŸ‡³ğŸ‡®.çš„â¤ï¸