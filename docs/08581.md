# å°† Docker å®¹å™¨ä» Bitbucket å‘å¸ƒåˆ° Google Cloud Container Registry

> åŸæ–‡:[https://dev . to/æ³•å­¦å®¶/publish-a-docker-container-from-bit bucket-to-Google-cloud-container-registry-5dif](https://dev.to/juristr/publish-a-docker-container-from-bitbucket-to-google-cloud-container-registry-5dif)

*æœ¬å¸–æœ€åˆå‘å¸ƒäº[https://justir . com/blog/2019/08/docker-deploy-bit bucket-ci-to-GCP](https://juristr.com/blog/2019/08/docker-deploy-bitbucket-ci-to-gcp)ã€‚å‰å¾€[juristr.com/blog](https://juristr.com/blog)äº†è§£æ›´å¤šå†…å®¹*

* * *

è‡ªåŠ¨åŒ–æ˜¯å…³é”®ï¼Œè¿™ä¸€ç‚¹æˆ‘å†æ€ä¹ˆé‡å¤ä¹Ÿä¸ä¸ºè¿‡ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•è®¾ç½®å’Œé…ç½®æ‚¨çš„ Bitbucket ç®¡é“ï¼Œä»¥è‡ªåŠ¨å°†æ‚¨çš„ Docker å®¹å™¨æ¨é€åˆ° Google Cloud Container Registryã€‚

è®©æœºå™¨æ¥åšç¹é‡çš„å·¥ä½œï¼Œå¯¹å—ï¼Ÿå¦‚æœä½ è¿˜è®°å¾—æˆ‘çš„æ–‡ç« â€œåƒä¸“ä¸šäººå£«ä¸€æ ·é‡Šæ”¾ä½ çš„ libsï¼â€(å›åˆ° 2015 å¹´)ï¼Œè°ˆåˆ°è‡ªåŠ¨åŒ–ï¼Œæˆ‘æ˜¯ 100%çš„æŠ•å…¥ã€‚æˆ‘åªæƒ³æ‘†è„±ç¹ççš„äº‹æƒ…ï¼Œä¸“æ³¨äºé‡è¦çš„äº‹æƒ…ã€‚å½“æˆ‘ä»¬è°ˆåˆ°è‡ªåŠ¨åŒ–æ—¶ï¼Œè‡ªåŠ¨åŒ–æ„å»ºç®¡é“å°±æ´¾ä¸Šäº†ç”¨åœºã€‚æˆ‘å·²ç»ä½¿ç”¨è©¹é‡‘æ–¯å¤šå¹´ï¼Œè‡ªæˆ‘æ‰˜ç®¡ä¸æˆ‘ä»¬å½“åœ°çš„ GitLab å›è´­ã€‚æœ€è¿‘æˆ‘è½¬å‘äº†äº‘ç®¡é“ï¼Œæ¯”å¦‚ Travisã€CircleCi å’Œ Bitbucket ç®¡é“ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å¿«é€Ÿé…ç½®ä¸€ä¸ª Bitbucket ç®¡é“ï¼Œå°†æˆ‘ä»¬çš„ Docker æ˜ åƒéƒ¨ç½²åˆ°ä¸€ä¸ªç§æœ‰çš„ repoï¼Œæ‰˜ç®¡åœ¨ Google Cloud Container Registry ä¸Šã€‚

æˆ‘ä»¬çš„æ€»ä½“æƒ³æ³•å¦‚ä¸‹:

*   æ¯æ¬¡æäº¤åˆ°`master`ï¼Œéƒ½ä¼šè‡ªåŠ¨è§¦å‘æˆ‘ä»¬çš„ç®¡é“ï¼Œè¯¥ç®¡é“ç¼–è¯‘å¹¶æ¨é€å¸¦æœ‰`latest`æ ‡ç­¾çš„ Docker æ˜ åƒ
*   æ ‡ç­¾çš„æ¯æ¬¡æäº¤éƒ½ä¼šè‡ªåŠ¨è§¦å‘æµæ°´çº¿ï¼Œå¹¶é€šè¿‡ä¸ºå›¾åƒåˆ†é…ç›¸åº”çš„æ ‡ç­¾æ¥æ¨é€å›¾åƒï¼Œå³ g it æ ‡ç­¾`v1.2.0`ä¼šå¯¼è‡´å›¾åƒåƒ`hello-world:1.2.0`ä¸€æ ·è¢«æ¨é€ã€‚

å¥½å§ï¼Œè®©æˆ‘ä»¬æŠŠå®ƒåˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£å‘ç”Ÿäº†ä»€ä¹ˆã€‚å¦‚æœä½ å¾ˆå¿«æƒ³çœ‹å®Œæ•´ç‰ˆï¼Œå¯ä»¥ç›´æ¥è·³åˆ°æ–‡ç« æœ«å°¾ã€‚

## [](#building-the-docker-image)æ„å»º docker å›¾åƒ

æ„å»º Docker æ˜ åƒéå¸¸ç®€å•ã€‚ä¸‹é¢æ˜¯æµæ°´çº¿æ­¥éª¤:

```
definitions:
  steps:
    - step: &build-image
        name: Build Docker image
        image: openjdk:8-jdk-alpine
        script:
          - docker build -t helloworld -f docker/hello-world/Dockerfile . 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªâ€œå®šä¹‰â€éƒ¨åˆ†ã€‚è¿™å°†å…è®¸æˆ‘ä»¬ç¨åé€šè¿‡ä½¿ç”¨ç±»ä¼¼`*build-image`çš„â€œæŒ‡é’ˆâ€æ¥å¼•ç”¨è¯¥æ­¥éª¤ã€‚

`image`å±æ€§è®¾ç½®åº”è¯¥ç”¨äºè¯¥æ­¥éª¤çš„ Docker å›¾åƒã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªåŸºäº Spring æ¡†æ¶çš„é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨äº†`openjdk:8-jdk-alpine`å›¾åƒã€‚

## [](#pushing-to-gcp)å‘ GCP æ¨è¿›

é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨ Bitbucket ç®¡é“é…ç½®ä¸­è®¾ç½®ä¸¤ä¸ªç¯å¢ƒå˜é‡:

*   \$GCLOUD_API_KEYFILE
*   \$GCLOUD_PROJECT

ä½ å¯ä»¥ä»ä½ çš„è°·æ­Œäº‘å¹³å°è´¦æˆ·è·å¾—è¿™äº›ã€‚

åŒæ ·ï¼Œæˆ‘ä»¬ä¸ºéƒ¨ç½²åˆ›å»ºä¸€ä¸ªå®šä¹‰éƒ¨åˆ†:

```
definitions:
  steps:
    - step: &build-image
        ...
    - step: &push-gcp
        name: Push to GCP registry
        image: google/cloud-sdk:alpine
        script:
          ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨`google/cloud-sdk:alpine`å›¾åƒï¼Œå®ƒå·²ç»åŒ…å«äº†æˆ‘ä»¬éœ€è¦æ¨é€åˆ° GCP æ³¨å†Œä¸­å¿ƒçš„æ‰€æœ‰å¿…è¦å†…å®¹ã€‚

### [](#authenticate-with-gcp)å‘ GCP æ±‚è¯

ä½œä¸ºä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦éªŒè¯æˆ‘ä»¬è‡ªå·±ï¼Œå¹¶é€‰æ‹©é¡¹ç›®æ¨è¿›åˆ°:

```
definitions:
  steps:
    - step: &build-image
        ...
    - step: &push-gcp
        name: Push to GCP registry
        image: google/cloud-sdk:alpine
        script:
          - echo $GCLOUD_API_KEYFILE | base64 -d > ./gcloud-api-key.json
          - gcloud auth activate-service-account --key-file gcloud-api-key.json
          - gcloud config set project $GCLOUD_PROJECT 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#tagging-our-docker-image)æ ‡è®°æˆ‘ä»¬çš„ Docker å›¾åƒ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ ‡è®°æˆ‘ä»¬çš„å›¾åƒã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ­¥éª¤å†æ¥è§£é‡Š:

```
definitions:
  steps:
    - step: &build-image
        ...
    - step: &push-gcp
        name: Push to GCP registry
        image: google/cloud-sdk:alpine
        script:
          ...
          - export TAG=$(echo "$BITBUCKET_TAG" | sed -e "s/v//g")
          - export SUFFIX=$([[ ! -z "$TAG" ]] && echo ":$TAG" || echo "")
          - export IMAGE_NAME=gcr.io/my-project/hello-world${SUFFIX}
          - docker tag helloworld ${IMAGE_NAME} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å› æ­¤,`export TAG=$(echo "$BITBUCKET_TAG" | sed -e "s/v//g")`è¡¨è¾¾å¼é‡‡ç”¨äº†`$BITBUCKET_TAG`,è¿™æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œæ¯å½“ Bitbucket é€šè¿‡ git æ ‡ç­¾è¢«è§¦å‘æ—¶ï¼Œå®ƒå°±ä¼šæ³¨å…¥åˆ°æˆ‘ä»¬çš„ç®¡é“ä¸­ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å°† git æ ‡ç­¾ä¸­çš„`v`(çœ‹èµ·æ¥åƒ`v1.2.0`)æ›¿æ¢ä¸ºç©ºï¼Œä»è€Œå¾—åˆ°`1.2.0`ã€‚è¿™åªæ˜¯æˆ‘åœ¨è¿™é‡Œåšçš„ä¸€äº›ç‰¹åˆ«çš„äº‹æƒ…ã€‚ä½ ä¹Ÿå¯ä»¥è½»æ¾åœ°é€‰æ‹©`v1.2.0`ã€‚

æ¥ä¸‹æ¥åœ¨`export SUFFIX=$([[ ! -z "$TAG" ]] && echo ":$TAG" || echo "")`æŒ‡ä»¤ä¸­ï¼Œæˆ‘åŸºæœ¬ä¸Šè®¡ç®—äº†æˆ‘æƒ³è¦æ·»åŠ çš„åç¼€æ¥æ ‡è®°æˆ‘çš„ docker å›¾åƒã€‚æˆ‘è¿™æ ·åšçš„åŸå› æ˜¯ï¼Œæˆ‘æƒ³åœ¨`master`è§¦å‘çš„æ„å»ºè¿‡ç¨‹ä¸­ä»¥åŠ git æ ‡ç­¾è§¦å‘å®ƒæ—¶é‡ç”¨è¿™ä¸ªæ­¥éª¤ã€‚åŒºåˆ«ï¼Ÿå—¯ï¼Œ`master`è§¦å‘å»ºé€ ä¸ä¼šæœ‰`$BITBUCKET_TAG`è®¾å®šã€‚æ‰€ä»¥æˆ‘æƒ³è¦çš„æ˜¯å¾—åˆ°ä»¥ä¸‹å†…å®¹:

*   `master`è§¦å‘å™¨æ„å»º= > `docker tag helloworld gcr.io/my-project/hello-world`ã€‚è¿™å°†è‡ªåŠ¨æ ‡è®°ä¸º`latest`
*   git æ ‡ç­¾è§¦å‘ build => `docker tag helloworld gcr.io/my-project/hello-world:1.2.0`ã€‚

å›æ¥ï¼Œæ¯å½“ä¸€ä¸ª`$TAG`è¢«è®¾ç½®ï¼Œ`export SUFFIX=$([[ ! -z "$TAG" ]] && echo ":$TAG" || echo "")`å°†ç”¨æ ‡ç­¾å¡«å……`$SUFFIX`ï¼Œå¦åˆ™æˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚

### [](#login-and-push)ç™»å½•å¹¶æ¨é€

æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„èº«ä»½éªŒè¯ä»¤ç‰Œç™»å½•ï¼Œå¹¶æ¨é€æ ‡è®°çš„å›¾åƒã€‚

```
definitions:
  steps:
    - step: &build-image
        name: Build Docker image
        image: openjdk:8-jdk-alpine
        script:
          - docker build -t helloworld -f docker/hello-world/Dockerfile .
          - docker save --output tmp-image.docker helloworld
        artifacts:
          - tmp-image.docker
    - step: &push-gcp
        name: Push to GCP registry
        image: google/cloud-sdk:alpine
        script:
          ...
          - cat ./gcloud-api-key.json | docker login -u _json_key --password-stdin https://gcr.io
          - docker push ${IMAGE_NAME} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#passing-the-compiled-image-between-pipeline-steps)åœ¨æµæ°´çº¿æ­¥éª¤ä¹‹é—´ä¼ é€’ç¼–è¯‘å¥½çš„å›¾åƒ

å¤ªå¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“å¦‚ä½•å»ºç«‹å’Œæ¨å¹¿æˆ‘ä»¬çš„å½¢è±¡äº†ã€‚ç¼ºå°‘çš„æ˜¯å¦‚ä½•å°†æ­¥éª¤`build-image`ä¸­ç¼–è¯‘çš„å›¾åƒä¼ é€’åˆ°`push-gcp`æ­¥éª¤ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨ä¸€ä¸ªæ­¥éª¤ï¼Œå› ä¸ºä¸¤è€…éƒ½éœ€è¦ä¸åŒçš„ Docker æ˜ åƒï¼Œä¸€ä¸ªç”¨äºæ„å»ºï¼Œå¦ä¸€ä¸ªç”¨äºå°†æ‰€æœ‰å·¥å…·æ¨é€åˆ° GCPã€‚

ä¸ºäº†åœ¨æ­¥éª¤ä¹‹é—´ä¼ é€’å›¾åƒï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`docker save`ä¿å­˜å®ƒï¼Œç„¶åå°†ä¿å­˜çš„æ–‡ä»¶å£°æ˜ä¸ºå·¥ä»¶ã€‚

```
definitions:
  steps:
    - step: &build-image
        name: Build Docker image
        image: openjdk:8-jdk-alpine
        script:
          ...
          - docker save --output tmp-image.docker helloworld
        artifacts:
          - tmp-image.docker
    - step: &push-gcp
        name: Push to GCP registry
        image: google/cloud-sdk:alpine
        script:
          - docker load --input ./tmp-image.docker 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#conclusion-amp-full-script)ç»“è®º&å®Œæ•´å‰§æœ¬

å› æ­¤ï¼Œä½¿ç”¨è¿™ç§è®¾ç½®ï¼Œæ¯å½“æ‚¨å¯¹ master å’Œ commit è¿›è¡Œæ›´æ”¹æ—¶ï¼Œéƒ½ä¼šæ¨é€ä¸€ä¸ªæ–°çš„ Docker æ˜ åƒï¼Œå¹¶æ ‡è®°ä¸º`latest`ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœæˆ‘ä»¬å†³å®šå‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ªæ ‡ç­¾å¹¶æ¨é€å®ƒã€‚ç”±äºæ ‡ç­¾åº”è¯¥è®¾ç½®åœ¨`master`ä¸Šï¼Œæ‰€ä»¥å¸¦æœ‰â€œæœ€æ–°â€æ ‡ç­¾çš„æ–°å›¾åƒå’Œå¸¦æœ‰æˆ‘ä»¬æŒ‡å®šçš„æ ‡ç­¾çš„å›¾åƒéƒ½å°†åœ¨æˆ‘ä»¬çš„ repo ä¸Šå®Œæˆã€‚

è¿™æ˜¯å®Œæ•´çš„å‰§æœ¬ğŸ˜ƒ

```
options:
  docker: true

definitions:
  steps:
    - step: &build-image
        name: Build Docker image
        image: openjdk:8-jdk-alpine
        script:
          - docker build -t helloworld -f docker/hello-world/Dockerfile .
          - docker save --output tmp-image.docker helloworld
        artifacts:
          - tmp-image.docker
    - step: &push-gcp
        name: Push to GCP registry
        image: google/cloud-sdk:alpine
        script:
          - docker load --input ./tmp-image.docker
          # Authenticating with the service account key file
          - echo $GCLOUD_API_KEYFILE | base64 -d > ./gcloud-api-key.json
          - gcloud auth activate-service-account --key-file gcloud-api-key.json
          - gcloud config set project $GCLOUD_PROJECT
          # Tag container & push
          - export TAG=$(echo "$BITBUCKET_TAG" | sed -e "s/v//g")
          - export SUFFIX=$([[ ! -z "$TAG" ]] && echo ":$TAG" || echo "")
          - export IMAGE_NAME=gcr.io/my-project/hello-world${SUFFIX}
          - docker tag helloworld ${IMAGE_NAME}
          # Login to google docker hub
          - cat ./gcloud-api-key.json | docker login -u _json_key --password-stdin https://gcr.io
          - docker push ${IMAGE_NAME}

pipelines:
  tags:
    v*:
      - step: *build-image
      - step: *push-gcp

  branches:
    master:
      - step: *build-image
      - step: *push-gcp 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#possible-improvements)å¯èƒ½çš„æ”¹è¿›

å°†å„ä¸ªæ­¥éª¤å°è£…åœ¨ä¸€ä¸ª shell è„šæœ¬ä¸­ï¼Œè¿™ä¸ªè„šæœ¬åŒ…å«åœ¨ git repo ä¸­ï¼Œæ‚¨åªéœ€ä» Bitbucket ç®¡é“ä¸­å¯åŠ¨å®ƒã€‚è¿™æ ·ï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨æœ¬åœ°éå¸¸å®¹æ˜“åœ°æ„å»ºå’Œæ¨é€æ–°ç‰ˆæœ¬ã€‚æ­¤å¤–ï¼Œç®¡é“ä¿æŒæ¸…æ´ï¼Œæ›´æ˜“äºç»´æŠ¤ã€‚