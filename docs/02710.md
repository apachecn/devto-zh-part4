# ä½¿ç”¨ MySQL ä½œä¸º BigQuery çš„ç¼“å­˜å±‚

> åŸæ–‡:[https://dev . to/keydunov/using-MySQL-as-a-cache-layer-for-big query-37p 2](https://dev.to/keydunov/using-mysql-as-a-cache-layer-for-bigquery-37p2)

BigQuery åœ¨å¤„ç†å¤§å‹æ•°æ®é›†æ–¹é¢éå¸¸å‡ºè‰²ï¼Œä½†å³ä½¿åœ¨å°å‹æ•°æ®é›†ä¸Šï¼Œä¹Ÿæ°¸è¿œä¸ä¼šç»™ä½ äºšç§’çº§çš„å“åº”ã€‚è¿™ä¼šå¯¼è‡´ä»ªè¡¨æ¿å’Œå›¾è¡¨ä¸Šçš„ç­‰å¾…æ—¶é—´ï¼Œå°¤å…¶æ˜¯åŠ¨æ€çš„ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸åŒçš„æ—¥æœŸèŒƒå›´æˆ–æ›´æ”¹è¿‡æ»¤å™¨ã€‚å¯¹äºå†…éƒ¨ BIs æ¥è¯´ï¼Œè¿™å‡ ä¹æ€»æ˜¯å¯ä»¥çš„ï¼Œä½†å¯¹äºé¢å‘å®¢æˆ·çš„åˆ†ææ¥è¯´å°±ä¸è¡Œäº†ã€‚æˆ‘ä»¬å®¹å¿å¾ˆå¤šäº‹æƒ…ï¼Œæ¯”å¦‚å†…éƒ¨å·¥å…·çš„ UI å’Œæ€§èƒ½å¾ˆå·®ï¼Œä½†æˆ‘ä»¬äº¤ä»˜ç»™å®¢æˆ·çš„å·¥å…·å´ä¸è¡Œã€‚

ä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥åˆ©ç”¨ BigQuery å»‰ä»·çš„æ•°æ®å­˜å‚¨å’Œå¤„ç†å¤§å‹æ•°æ®é›†çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¸æ”¾å¼ƒæ€§èƒ½ã€‚ç”±äº BigQuery å……å½“å•ä¸€çš„äº‹å®æ¥æºå¹¶å­˜å‚¨æ‰€æœ‰çš„åŸå§‹æ•°æ®ï¼ŒMySQL å¯ä»¥å……å½“å®ƒä¸Šé¢çš„ç¼“å­˜å±‚ï¼Œåªå­˜å‚¨å°çš„èšåˆè¡¨ï¼Œå¹¶ä¸ºæˆ‘ä»¬æä¾›æ‰€éœ€çš„äºšç§’çº§å“åº”ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹æ¼”ç¤ºï¼Œåœ¨ Github ä¸ŠæŸ¥çœ‹æºä»£ç ã€‚ç¡®ä¿ä½¿ç”¨æ—¥æœŸèŒƒå›´å’Œå¼€å…³â€”åŠ¨æ€ä»ªè¡¨æ¿ä»é¢„èšåˆä¸­è·ç›Šæœ€å¤§ã€‚

[![cubejs-external-rollups.gif](img/56eca4ac91a3abec339124853ff7ace3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--wkX590j---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.graphcms.com/7fvaHi7TymwSBb01Y3Zi)

Cube.js åˆ©ç”¨é¢„èšåˆå±‚ä½œä¸ºå…¶[ä¸¤çº§ç¼“å­˜ç³»ç»Ÿ](https://cube.dev/docs/caching)çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬æœ€è¿‘å‘å¸ƒäº†é’ˆå¯¹ç›®æ ‡ç”¨ä¾‹çš„å¤–éƒ¨é¢„èšåˆæ”¯æŒï¼Œåœ¨è¿™äº›ç”¨ä¾‹ä¸­ï¼Œç”¨æˆ·å¯ä»¥ç»„åˆå¤šä¸ªæ•°æ®åº“ï¼Œå¹¶ä»ä¸¤ä¸ªä¸–ç•Œä¸­è·å¾—æœ€ä½³æ•ˆæœã€‚ä¸‹é¢çš„æ¨¡å¼æ˜¾ç¤ºäº†ä½¿ç”¨ BigQuery å’Œ MySQL çš„ Cube.js çš„å…¸å‹è®¾ç½®ã€‚

[![Alt Text](img/79098b3b9a2ef1fb990209f36bfc8464.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--f7qYhVev--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/55qblyygj9q9vmruvf3f.png)

è¦ä½¿ç”¨å¤–éƒ¨æ±‡æ€»åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Cube.js ä»¥è¿æ¥åˆ° BigQuery å’Œ MySQLï¼Œå¹¶æŒ‡å®šæˆ‘ä»¬å¸Œæœ›åœ¨å¤–éƒ¨æ„å»ºå“ªä¸ªé¢„èšåˆã€‚å¦‚æœä½ æ˜¯ Cube.js çš„æ–°æ‰‹ï¼Œæˆ‘æ¨èä½ å…ˆçœ‹çœ‹è¿™ä¸ª 101 å¼æ•™ç¨‹ï¼Œç„¶åå†å›åˆ°è¿™é‡Œã€‚å¯¹äºæˆ‘ä»¬çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ª BigQuery çš„å…¬å…±é»‘å®¢æ–°é—»æ•°æ®é›†ã€‚

è®©æˆ‘ä»¬é¦–å…ˆå®‰è£… Cube.js CLI å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºã€‚

```
$ npm install -g cubejs-cli
$ cubejs create external-rollups -d bigquery 
```

æˆ‘ä»¬è®¾ç½®`-d bigquery`ä½¿æˆ‘ä»¬çš„ä¸»æ•°æ®åº“æˆä¸ºä¸€ä¸ªå¤§æŸ¥è¯¢ã€‚æ¥ä¸‹æ¥ï¼Œå°†`cd`æ”¾å…¥`bigquery-mysql`æ–‡ä»¶å¤¹ï¼Œå¹¶ä½¿ç”¨æ­£ç¡®çš„å‡­è¯é…ç½®`.env`ã€‚

```
CUBEJS_DB_TYPE=bigquery
CUBEJS_DB_BQ_PROJECT_ID=<BIGQUERY PROJECT ID>
CUBEJS_DB_BQ_CREDENTIALS=<BIGQUERY BASE64-ENCODED KEY>
CUBEJS_EXT_DB_NAME=preags
CUBEJS_EXT_DB_HOST=localhost
CUBEJS_EXT_DB_USER=root
CUBEJS_EXT_DB_PASS=12345 
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºä¸»æ•°æ®åº“(BigQuery)å’Œé¢„èšåˆçš„å¤–éƒ¨æ•°æ®åº“(MySQL)è®¾ç½®å‡­è¯ã€‚ä½ å¯ä»¥åœ¨ [Cube.js docs è¿™é‡Œ](https://cube.dev/docs/connecting-to-the-database#notes-google-big-query)äº†è§£æ›´å¤šå…³äºè·å– BigQuery å‡­è¯çš„ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œä¸ºäº†åœ¨ MySQL ä¸­æ„å»ºé¢„èšåˆï¼ŒCube.js åº”è¯¥æ‹¥æœ‰å¯¹å­˜å‚¨é¢„èšåˆè¡¨çš„`stb_pre_aggregations`æ¨¡å¼çš„å†™æƒé™ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å®‰è£… Cube.js MySQL é©±åŠ¨ç¨‹åºã€‚

```
$ npm install @cubejs-backend/mysql-driver --save 
```

ä¸€æ—¦æˆ‘ä»¬æœ‰äº†å®ƒï¼Œæœ€åçš„é…ç½®æ­¥éª¤æ˜¯é€šè¿‡`externalDbType`å’Œ`externalDriverFactory`å±æ€§æä¾› MySQL ç›¸å…³çš„é€‰é¡¹ã€‚ç”¨ä»¥ä¸‹å†…å®¹æ›¿æ¢`index.js`æ–‡ä»¶çš„å†…å®¹ã€‚

```
const CubejsServer = require("@cubejs-backend/server");
const MySQLDriver = require('@cubejs-backend/mysql-driver');

const server = new CubejsServer({
  externalDbType: 'mysql',
  externalDriverFactory: () => new MySQLDriver({
    host: process.env.CUBEJS_EXT_DB_HOST,
    database: process.env.CUBEJS_EXT_DB_NAME,
    user: process.env.CUBEJS_EXT_DB_USER,
    password: process.env.CUBEJS_EXT_DB_PASS.toString()
  })
});

server.listen().then(({ port }) => {
  console.log(`ğŸš€ Cube.js server is listening on ${port}`);
}); 
```

è¿™å°±æ˜¯æˆ‘ä»¬è®© Cube.js è¿æ¥åˆ° BigQuery å’Œ MySQL æ‰€éœ€è¦çš„ä¸€åˆ‡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºç¬¬ä¸€ä¸ª Cube.js æ•°æ®æ¨¡å¼æ–‡ä»¶ã€‚Cube.js ä½¿ç”¨æ•°æ®æ¨¡å¼ç”Ÿæˆ SQL ä»£ç ï¼Œè¯¥ä»£ç å°†åœ¨æ‚¨çš„æ•°æ®åº“ä¸­æ‰§è¡Œã€‚

ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»º`schema/Stories.js`æ–‡ä»¶ã€‚

```
cube(`Stories`, {
  sql: `select * from \`fh-bigquery.hackernews.full_partitioned\` WHERE type = 'story'`,

  measures: {
    count: {
      type: `count`,
    }
  },

  dimensions: {
    category: {
      type: `string`,
      case: {
        when: [
          { sql: `STARTS_WITH(title, "Show HN")`, label: `Show HN` },
          { sql: `STARTS_WITH(title, "Ask HN")`, label: `Ask HN` }
        ],
        else: { label: `Other` }
      }
    },

    time: {
      sql: `timestamp`,
      type: `time`
    }
  }
}); 
```

ç°åœ¨ï¼Œé€šè¿‡è¿è¡Œ`node index.js`å¯åŠ¨ Cube.js æœåŠ¡å™¨ï¼Œå¹¶å¯¼èˆªåˆ°ä½äº [http://localhost:4000](http://localhost:4000) çš„å¼€å‘å¹³å°ã€‚

æ‚¨å¯ä»¥é€‰æ‹© Stories count åº¦é‡å’Œ category ç»´ä»¥åŠæ—¶é—´ç»´æ¥æ„å»ºå›¾è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

[![Alt Text](img/2f05fc3bb2dd4db9454b0d8ada694082.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--QYgaKewv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/l4czj3fnsgpawxbq1n70.png)

å¦‚æœæˆ‘ä»¬é€šè¿‡å•å‡»ä¸€ä¸ª SQL æŒ‰é’®æ¥æ£€æŸ¥ç”Ÿæˆçš„ SQLï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹å†…å®¹ã€‚

```
SELECT
  CASE
    WHEN STARTS_WITH(title, "Show HN") THEN 'Show HN'
    WHEN STARTS_WITH(title, "Ask HN") THEN 'Ask HN'
    ELSE 'Other'
  END `stories__category`,
  DATETIME_TRUNC(DATETIME(`stories`.timestamp, 'UTC'), MONTH) `stories__time_month`,
  count(*) `stories__count`
FROM
  (
    select
      *
    from
      `fh-bigquery.hackernews.full_partitioned`
    WHERE
      type = 'story'
  ) AS `stories`
GROUP BY
  1,
  2
ORDER BY
  2 ASC
LIMIT
  10000 
```

è¿™ä¸ª SQL å‘æˆ‘ä»¬å±•ç¤ºäº†è¿™ä¸ªæŸ¥è¯¢æ˜¯é’ˆå¯¹ BigQuery ä¸­çš„åŸå§‹æ•°æ®è¿è¡Œçš„ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¯¹ MySQL ä¸­é¢„å…ˆèšé›†çš„è¡¨è¿è¡Œå®ƒã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªé¢„èšåˆã€‚é€šå¸¸ï¼Œè¿™æ˜¯åœ¨åŒä¸€ä¸ªå¤šç»´æ•°æ®é›†ä¸­å®Œæˆçš„ï¼Œä½†æ˜¯ä¸ºäº†æœ¬æ•™ç¨‹çš„ç›®çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒä½¿ç”¨å’Œä¸ä½¿ç”¨é¢„èšåˆçš„æ€§èƒ½ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„å¤šç»´æ•°æ®é›†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­å®Œæˆã€‚å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`schema/Stories.js`æ–‡ä»¶ä¸­ã€‚

```
cube(`StoriesPreAgg`, {
  extends: Stories,
  preAggregations: {
    main: {
      type: `rollup`,
      measureReferences: [count],
      dimensionReferences: [category],
      granularity: `month`,
      timeDimensionReference: time,
      external: true
    }
  }
}); 
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª`rollup`ç±»å‹å£°æ˜äº†ä¸€ä¸ªé¢„èšåˆï¼Œå¹¶æŒ‡å®šåœ¨èšåˆè¡¨ä¸­åŒ…å«å“ªäº›åº¦é‡å’Œç»´åº¦ã€‚è¿˜è¦æ³¨æ„`external: true`ï¼›è¿™ä¸€è¡Œå‘Šè¯‰ Cube.js å°†è¿™ä¸ªé¢„èšåˆä¸Šä¼ åˆ° MySQLã€‚

ç°åœ¨ï¼Œè½¬åˆ°å¼€å‘å¹³å°ï¼Œé€‰æ‹©ä¸ä¹‹å‰ç›¸åŒçš„åº¦é‡å’Œç»´åº¦:è®¡æ•°ã€ç±»åˆ«å’ŒæŒ‰æœˆåˆ†ç»„çš„æ—¶é—´ï¼Œä½†æ˜¯è¿™æ¬¡ä» Stories PreAgg å¤šç»´æ•°æ®é›†ä¸­é€‰æ‹©å®ƒä»¬ã€‚å½“ç¬¬ä¸€æ¬¡è¢«è¯·æ±‚æ—¶ï¼ŒCube.js å°†ç”Ÿæˆä¸€ä¸ªèšåˆè¡¨å¹¶ä¸Šä¼ åˆ° MySQLã€‚æ‰€æœ‰åç»­è¯·æ±‚éƒ½å°†ç›´æ¥è¿›å…¥ MySQL ä¸­çš„èšåˆè¡¨ã€‚æ‚¨å¯ä»¥æ£€æŸ¥ç”Ÿæˆçš„ SQLï¼Œå®ƒåº”è¯¥å¦‚ä¸‹æ‰€ç¤ºã€‚

```
SELECT
  `stories_pre_agg__category` `stories_pre_agg__category`,
  `stories_pre_agg__time_month` `stories_pre_agg__time_month`,
  sum(`stories_pre_agg__count`) `stories_pre_agg__count`
FROM
  stb_pre_aggregations.stories_pre_agg_main
GROUP BY
  1,
  2
ORDER BY
  2 ASC
LIMIT
  10000 
```

å¦‚æ‚¨æ‰€è§ï¼Œå®ƒç°åœ¨ä» MySQL ä¸­çš„`stb_pre_aggregations.stories_pre_agg_main`è¡¨ä¸­æŸ¥è¯¢æ•°æ®ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿‡æ»¤å™¨æ¥æŸ¥çœ‹èšåˆæŸ¥è¯¢ç›¸å¯¹äºåŸå§‹æŸ¥è¯¢çš„æ€§èƒ½æå‡ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨å¤šä¸ªå›¾è¡¨æ¥æ£€æŸ¥[è¿™ä¸ªæ¼”ç¤ºä»ªè¡¨æ¿ï¼Œå¹¶æ¯”è¾ƒä½¿ç”¨å’Œä¸ä½¿ç”¨é¢„èšåˆæ—¶çš„æ€§èƒ½ã€‚](https://cubejs-external-rollups.herokuapp.com/)[Github ä¸Šæä¾›äº†ç¤ºä¾‹ä»ªè¡¨æ¿çš„æºä»£ç ã€‚](https://github.com/cube-js/cube.js/tree/master/examples/external-rollups)