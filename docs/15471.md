# ä¸ºä»€ä¹ˆæ•ˆæœä¸åº”è¯¥ä¾èµ–äºå®ƒä»¬çš„ä¾èµ–å…³ç³»

> åŸæ–‡ï¼š<https://dev.to/aman_singh/why-effects-shouldn-t-lie-about-their-dependencies-1645>

å¾ˆé•¿ä¸€æ®µæ—¶é—´ä»¥æ¥ï¼ŒReact å¼€å‘äººå‘˜ä¸€ç›´åœ¨å‘æ˜å’Œåˆ†äº«ä¸åŒçš„ä»£ç é€»è¾‘é‡ç”¨æ¨¡å¼â€”â€”é«˜é˜¶ç»„ä»¶[å’Œ](https://reactjs.org/docs/higher-order-components.html)[æ¸²æŸ“é“å…·](https://reactjs.org/docs/render-props.html)ä»…ä¸¾å‡ ä¸ªä¾‹å­ã€‚è¿™æ˜¯å› ä¸º **React æ²¡æœ‰æ¯”ç±»ç»„ä»¶**æ›´ç®€å•çš„æœ‰çŠ¶æ€åŸè¯­ã€‚æœ€åï¼ŒReact ç”Ÿæ€ç³»ç»Ÿä¸­[æŒ‚é’©](https://reactjs.org/docs/hooks-intro.html)çš„å‡ºç°æ ¹é™¤äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä½¿ä»£ç é‡ç”¨å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚å¦‚æœä½ æœ‰å…´è¶£çŸ¥é“ä¸ºä»€ä¹ˆé’©å­è¢«å¼•å…¥ï¼Œæˆ‘å·²ç»å†™äº†ä¸€ç¯‡å…³äºå®ƒçš„å•ç‹¬çš„æ·±å…¥æ–‡ç« [åœ¨è¿™é‡Œ](https://medium.com/@5066aman/how-to-write-90-cleaner-code-with-hooks-a3604116fb90?source=friends_link&sk=e3d0a1d284d45faa357638950421d520)ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†åªè®¨è®º *useEffect* hookï¼Œå¹¶åˆ†äº«æˆ‘çš„ä¸€äº›å¿ƒå¾—å’Œä¸€äº›ç›¸å…³çš„æ³¨æ„äº‹é¡¹ã€‚æˆ‘ä»¬å°†è®¨è®ºçš„å‡ ä»¶äº‹æ˜¯:

1.  æˆ‘ä»¬å°†ä»ä¸€ä¸ªä½¿ç”¨ useEffect çš„ä¾‹å­å¼€å§‹ï¼Œå®ƒæœ‰ä¸€ä¸ª bugã€‚
2.  ç„¶åï¼Œæˆ‘ä»¬å°†è¯•å›¾æ­å¼€è¿™ä¸ªé”™è¯¯çš„åŸå› ğŸ˜€ã€‚
3.  æœ€åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•é¿å…è¿™äº›é”™è¯¯ï¼Œå¹¶å†™å‡ºå®¹æ˜“ç†è§£çš„æ•ˆæœã€‚

åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œæˆ‘æƒ³è®©ä½ å¿˜è®°ä½ å·²ç»å¯¹ç±»ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸåšäº†ä»€ä¹ˆã€‚æœ‰äº†é’©å­ï¼Œæˆ‘ä»¬éœ€è¦ä¸åŒçš„å¿ƒæ€ã€‚

> åœ¨é’©å­ç‹å›½ï¼ŒåŠŸèƒ½æ‰æ˜¯ç‹é“ã€‚

èƒŒæ™¯å¤Ÿäº†ã€‚è®©æˆ‘ä»¬ç°åœ¨å¼€å§‹å§ã€‚

### ä¸€æ¬¡å›é¡¾

å‰¯ä½œç”¨æ˜¯ä»»ä½• web åº”ç”¨ç¨‹åºä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚è·å–æ•°æ®ã€æ‰‹åŠ¨æ”¹å˜ DOM å’Œè®¾ç½®è®¢é˜…éƒ½æ˜¯å‰¯ä½œç”¨çš„ä¾‹å­ã€‚ *useEffect* é’©å­å…è®¸ä½ åœ¨ä½ çš„å‡½æ•°ç»„ä»¶ä¸­æ‰§è¡Œå‰¯ä½œç”¨ã€‚

```
 // Inside your function component 
 useEffect(() => {
 // some side effect code 
 });
} 
```

æˆ‘è§è¿‡ä¸€äº›å¼€å‘è€…å‡è®¾æ¯æ¬¡æ¸²æŸ“åéƒ½æœ‰ç›¸åŒçš„æ•ˆæœ(åŒ¿åå‡½æ•°)æ¥å“åº”è°ƒç”¨ã€‚ä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚æ¯æ¬¡é‡æ–°æ¸²æŸ“çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¼šå®‰æ’ä¸€ä¸ªæ–°çš„**æ•ˆæœ**æ¥ä»£æ›¿ä¹‹å‰çš„**æ•ˆæœ**ã€‚è¿™æ˜¯æœ‰æ„çš„ï¼Œä¹Ÿå¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒä½¿æ•ˆæœè¡¨ç°å¾—æ›´åƒæ¸²æŸ“ç»“æœçš„ä¸€éƒ¨åˆ†ã€‚è¿™é‡Œè¦è®°ä½çš„å…³é”®ç‚¹æ˜¯æ¯ä¸ªæ•ˆæœâ€œå±äºâ€ä¸€ä¸ªç‰¹å®šçš„æ¸²æŸ“ã€‚

> æ¯ä¸ªæ•ˆæœâ€œå±äºâ€ä¸€ä¸ªç‰¹å®šçš„æ¸²æŸ“ã€‚

useEffect è°ƒç”¨è¿˜æœ‰ä¸€ä¸ªå¯é€‰çš„ç¬¬äºŒä¸ªå‚æ•°â€”ä¾èµ–æ•°ç»„ã€‚è¿™æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå¦‚æœæŸäº›å€¼åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´æ²¡æœ‰æ”¹å˜ï¼ŒReact çŸ¥é“ä½•æ—¶è·³è¿‡è¿è¡Œæ•ˆæœã€‚

åœ¨æ•ˆæœéœ€è¦æ¸…ç†çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ã€‚è¯·è®°ä½ï¼ŒReact æ€»æ˜¯åœ¨åº”ç”¨ä¸‹ä¸€ä¸ªæ•ˆæœä¹‹å‰è°ƒç”¨è¿™ä¸ªæ¸…ç†å‡½æ•°ã€‚

> åœ¨åº”ç”¨ä¸‹ä¸€ä¸ªæ•ˆæœä¹‹å‰ï¼Œä¸€å®šè¦æ¸…ç†ä¸Šä¸€ä¸ªæ•ˆæœã€‚

æŠ›å¼€åŸºç¡€çŸ¥è¯†ï¼Œç°åœ¨è®©æˆ‘ä»¬è¿›å…¥æœ‰è¶£çš„éƒ¨åˆ†ã€‚

### 1ã€‚é”™è¯¯çš„æ•ˆæœ

ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ç‰‡æ®µï¼Œæ¼”ç¤ºäº†åœ¨ useEffect é’©å­ä¸­ä½¿ç”¨ setInterval(ä¸€ç§å‰¯ä½œç”¨):

```
function CounterWithBug() {
  const [count, setCount] = useState(0);
useEffect(() => {
    const id = setInterval(() => setCount(count + 1), 1000);
    return () => clearInterval(id);
  }, []);
return <h1>Count is {count} </h1>;
} 
```

ä»…ä»…é€šè¿‡æŸ¥çœ‹è¿™äº›ä»£ç ï¼Œæ‚¨èƒ½è¯†åˆ«å‡ºä»»ä½• bug å—ï¼Ÿ

è¿™æ®µä»£ç çœ‹èµ·æ¥å¾ˆå¥½ï¼Œä½†æ˜¯æˆ‘ä»¬çš„è®¡æ•°å€¼æ²¡æœ‰å¢åŠ ã€‚å¦‚æœä½ æƒ³çœ‹å®é™…æ“ä½œï¼Œè¿™é‡Œæœ‰[æ¼”ç¤º](https://codesandbox.io/s/counterwithbug-sqn37)é“¾æ¥ã€‚ä½ å¯èƒ½ä¼šè®¤ä¸º *setInterval* å›è°ƒå‡½æ•°æ­£åœ¨è°ƒç”¨ setterï¼Œå®ƒåº”è¯¥æ¯ 1 ç§’é’Ÿé€’å¢ä¸€æ¬¡è®¡æ•°å€¼ã€‚ä½†è¿™å¹¶æ²¡æœ‰å‘ç”Ÿã€‚æˆ‘ä»¬é—æ¼äº†ä»€ä¹ˆï¼Ÿ

### 2ã€‚æ­å¼€é”™è¯¯åŸå› çš„ç¥ç§˜é¢çº±

æˆ‘ä»¬è‚¯å®šå¯ä»¥é€šè¿‡ä¸€ä¸ªå°å°çš„æ”¹å˜æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ç›¸ä¿¡ä½ ä»¬å¤§å¤šæ•°äººéƒ½çŸ¥é“æ€ä¹ˆåšã€‚ä½†æ˜¯è®©æˆ‘ä»¬é€€ä¸€æ­¥ï¼Œè¯•ç€ç†è§£ä¸ºä»€ä¹ˆè¿™ç§è¡Œä¸ºä¼šå­˜åœ¨ã€‚

æ¯æ¬¡å½“ setInterval è°ƒç”¨ setter æ—¶ï¼ŒReact éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚è¿™æ ·åšä¼šäº§ç”Ÿæ–°çš„æ•ˆæœ(åŠŸèƒ½)ã€‚ä½†æœ‰è¶£çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬ä¼ é€’äº†ä¸€ä¸ªç©ºçš„*ä¾èµ–æ•°ç»„* []ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“åè·³è¿‡åº”ç”¨è¯¥æ•ˆæœçš„ä¿¡å·ï¼Œå®ƒä¸ä¼šåœ¨ç¬¬äºŒæ¬¡è¢«è°ƒç”¨ã€‚
ç°åœ¨ä½ å¯èƒ½æƒ³çŸ¥é“è¿™æœ‰ä»€ä¹ˆåŒºåˆ«:æˆ‘ä»¬çš„ setter æ¯æ¬¡éƒ½è¢«è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒåº”è¯¥å¢åŠ  *count* å€¼ã€‚å¯¹å—ï¼Ÿ

è¿™ç§è¡Œä¸ºä¸ååº”æ— å…³ã€‚å®ƒæ˜¯å…³äº JavaScript ä¸­çš„é—­åŒ…å¦‚ä½•å·¥ä½œçš„ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒECMAScript ä¸­çš„æ‰€æœ‰å‡½æ•°éƒ½æ˜¯é—­åŒ…ï¼Œå› ä¸ºå®ƒä»¬åœ¨åˆ›å»ºé˜¶æ®µ**å°±åœ¨è¯æ±‡ä¸Š**æ•è·äº†è‡ªèº«å’Œçˆ¶ä¸Šä¸‹æ–‡çš„ä½œç”¨åŸŸé“¾ã€‚è¿™ä¸åŠŸèƒ½æ˜¯å¦åœ¨ä¹‹å**è¢«æ¿€æ´»æ— å…³ã€‚**

è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªä¾‹å­:

```
let x = 10;
// function is created here (not invoked yet)
function bar() {
  console.log(x);
}
function foo() {
  let x = 50;
  bar(); // invocation happens here
}
foo(); // will print 10 
```

å½“ *foo* è¢«è°ƒç”¨æ—¶ï¼Œ *10* ä¼šè¢«æ‰“å°ï¼Œè€Œ *50* ä¸ä¼šè¢«æ‰“å°ã€‚è¿™æ˜¯å› ä¸ºå½“ *bar* åœ¨å‰é¢è¢«åˆ›å»ºæ—¶(å‡½æ•°åˆ›å»ºé˜¶æ®µ)ï¼Œ **x** è¢«é™æ€åœ°å­˜å‚¨åˆ°å®ƒçš„ä½œç”¨åŸŸé“¾ä¸­ï¼Œè¿™å°±æ˜¯ç¨å bar æ‰§è¡Œè¢«æ¿€æ´»æ—¶æ‰€è§£å†³çš„é—®é¢˜ã€‚

è®©æˆ‘ä»¬å†è€ƒè™‘ä¸€ä¸ªä¾‹å­æ¥åŠ å¼ºæˆ‘ä»¬çš„é—­åŒ…æ¦‚å¿µã€‚

```
function parent() {
  let x = 20;
  setTimeout(() => console.log(x), 1000);
}
parent(); // prints 20 after a minimun time delay of 1 sec. 
```

å³ä½¿çˆ¶æ‰§è¡Œä¸Šä¸‹æ–‡è¢«ç ´åï¼Œé—´éš”å†…çš„å›è°ƒä»ç„¶èƒ½å¤Ÿåœ¨ 1 ç§’é’Ÿçš„å»¶è¿Ÿåæ‰“å°å‡ºæ­£ç¡®çš„ x å€¼ã€‚è¿™æ˜¯å› ä¸º**å…³é—­**é€ æˆçš„ã€‚å†…éƒ¨å‡½æ•°åœ¨åˆ›å»ºæ—¶é™æ€åœ°æ•è·çˆ¶ä½œç”¨åŸŸä¸­å®šä¹‰çš„å˜é‡ã€‚

> å†…éƒ¨å‡½æ•°åœ¨åˆ›å»ºæ—¶é™æ€åœ°æ•è·çˆ¶ä½œç”¨åŸŸä¸­å®šä¹‰çš„å˜é‡ã€‚

å¦‚æœä½ æƒ³æ›´æ·±å…¥åœ°ç ”ç©¶é—­åŒ…çš„æ¦‚å¿µï¼Œæˆ‘ä¹Ÿåœ¨è¿™é‡Œå†™äº†ä¸€ç¯‡å…³äºå®ƒçš„æ–‡ç« ã€‚

ç°åœ¨å¸¦ç€è¿™ä¸ªæ–°çŸ¥è¯†ï¼Œè®©æˆ‘ä»¬ä»ä¸åŒçš„è§’åº¦å†ä¸€æ¬¡å‚è§‚æˆ‘ä»¬çš„æ•ˆæœã€‚è¿™æ˜¯ä»£ç ç‰‡æ®µï¼Œè¿™æ ·ä½ å°±ä¸ç”¨å‘ä¸Šæ»šåŠ¨:

```
function CounterWithBug() {
  const [count, setCount] = useState(0);
useEffect(() => {
    const id = setInterval(() => setCount(count + 1), 1000);
    return () => clearInterval(id);
  }, []); // ğŸ›‘ missing the 'count' dependency
return <h1>Count is {count} </h1>;
} 
```

å½“æ•ˆæœåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“åæ‰§è¡Œæ—¶ï¼ŒsetInterval **ä¸­çš„åŒ¿åå›è°ƒé™æ€åœ°**ä»å…¶çˆ¶ä¸Šä¸‹æ–‡ä¸­æ•è·*è®¡æ•°*å€¼ã€‚è¿™å‘ç”Ÿåœ¨**åˆ›å»ºé˜¶æ®µ**ï¼Œæ•è·çš„å€¼ä¸º 0ã€‚åœ¨ 1 ç§’çš„æœ€å°å»¶è¿Ÿä¹‹åï¼Œè¿™ä¸ªå›è°ƒè¢«è°ƒç”¨ï¼Œå®ƒåˆç”¨ä¸€ä¸ªæ–°å€¼ 1 (0 + 1)è°ƒç”¨ setterã€‚ä½œä¸ºå“åº”ï¼ŒReact é‡æ–°å‘ˆç°ç»„ä»¶ï¼Œæ‚¨å¯ä»¥åœ¨ UI ä¸­çœ‹åˆ°æ–°çš„ *count* å€¼ 1ã€‚

ç°åœ¨ï¼Œç”±äºä¾èµ–æ•°ç»„æ˜¯ç©ºçš„ï¼ŒReact åªä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•ˆæœæ¥æ›¿æ¢ä¹‹å‰çš„æ•ˆæœï¼Œä½†æ˜¯**æ°¸è¿œä¸ä¼šè¿è¡Œå®ƒã€‚æ­£å¦‚æˆ‘ä»¬åˆšåˆšäº†è§£åˆ°çš„ï¼ŒReact æ€»æ˜¯åœ¨**åº”ç”¨ä¸‹ä¸€ä¸ªæ•ˆæœä¹‹å‰æ¸…ç†å‰é¢çš„æ•ˆæœ**ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¸ä¼šè´¹å¿ƒè¿è¡Œæ¸…ç†ã€‚å› æ­¤ï¼Œåˆå§‹é—´éš”æ°¸è¿œä¸ä¼šè¢«æ¸…é™¤ï¼Œæˆ‘ä»¬çš„åŒ¿åå›è°ƒä»ç„¶ä¿æŒå…¶ä½œç”¨åŸŸé“¾ä¸­çš„è®¡æ•°å€¼ 0ã€‚è°ƒç”¨ setter æ—¶ï¼Œä¼ é€’ç»™å®ƒçš„æ–°å€¼æ€»æ˜¯ 1 (0 + 1)ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè®¡æ•°å€¼ä¸ä¼šå¢åŠ è¶…è¿‡ 1ã€‚**

### 3ã€‚æ°¸è¿œä¸è¦å¯¹ä½ çš„æ•ˆæœä¾èµ–å…³ç³»æ’’è°â€”â€”ä¸€äº›ä¿®æ­£

åœ¨æˆåŠŸæ­ç¤ºäº†é”™è¯¯çš„æ ¹æœ¬åŸå› ä¹‹åï¼Œç°åœ¨æ˜¯ä¿®å¤å®ƒçš„æ—¶å€™äº†ã€‚å½“ä½ çŸ¥é“é—®é¢˜çš„ç¡®åˆ‡æ¥æºæ—¶ï¼Œæ€»æ˜¯å¾ˆå®¹æ˜“æ‰¾åˆ°è§£å†³åŠæ³•ã€‚é—®é¢˜æ˜¯å½“ç¬¬ä¸€æ¬¡æ¸²æŸ“å‘ç”Ÿæ—¶ï¼Œé—´éš”é™æ€åœ°æ•è·äº†è®¡æ•°å€¼ 0ã€‚å› æ­¤ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯è®©é—´éš”æ•æ‰åˆ°æ¯æ¬¡æ¸²æŸ“çš„æœ€æ–°è®¡æ•°å€¼ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿæˆ‘ä»¬èƒ½ä» React é‚£é‡Œå¾—åˆ°å¸®åŠ©å—ï¼Ÿ

æ˜¯å•Šï¼ä½ çŒœå¯¹äº†â€” *ä¾èµ–æ•°ç»„*ã€‚æ¯å½“ä¾èµ–æ•°ç»„ä¸­çš„å€¼æ”¹å˜æ—¶ï¼ŒReact æ¸…é™¤ä»¥å‰çš„æ•ˆæœå¹¶åº”ç”¨æ–°çš„æ•ˆæœã€‚

#### ä¿®å¤ 1:ä½¿ç”¨â€œè®¡æ•°â€ä½œä¸ºä¾èµ–é¡¹

åœ¨æˆ‘ä»¬çš„é”™è¯¯ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°† **count** å˜é‡ä½œä¸ºä¾èµ–é¡¹æ¥ä¼ é€’ï¼Œå°±å¯ä»¥è§£å†³é—®é¢˜ã€‚è¿™é‡Œæ˜¯[çš„æ¼”ç¤ºé“¾æ¥](https://medium.com/r/?url=https%3A%2F%2Fcodesandbox.io%2Fs%2Fpeaceful-wave-9uudg)ã€‚

```
function Counter() {
  const [count, setCount] = useState(0);
useEffect(() => {
    const id = setInterval(() => setCount(count + 1), 1000);
    return () => clearInterval(id);
  }, [count]); // âœ… passing 'count' as dependency
  // will render the correct value of count
return <h1>Count is {count} </h1>;
} 
```

ç°åœ¨æœ‰äº†è¿™ä¸ªå°å°çš„æ”¹å˜ï¼Œæ¯å½“ *count* å€¼æ”¹å˜æ—¶ï¼ŒReact ç»§ç»­å‰è¿›ï¼Œé¦–å…ˆè°ƒç”¨æˆ‘ä»¬çš„æ¸…ç†æœºåˆ¶æ¥æ¸…ç†å…ˆå‰çš„é—´éš”ï¼Œç„¶åé€šè¿‡å†æ¬¡è¿è¡Œæ•ˆæœæ¥è®¾ç½®æ–°çš„é—´éš”ã€‚**ç­”å¯¹äº†ï¼ï¼**ğŸ‰

åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œæ•ˆæœä¾èµ–äº*è®¡æ•°*å˜é‡ã€‚æ‰€ä»¥ï¼Œå®ƒä¹Ÿåº”è¯¥åœ¨ä¾èµ–æ•°ç»„ä¸­ã€‚

æ‰€ä»¥ï¼Œè¿™é‡Œçš„æ•™è®­æ˜¯ï¼Œä¸€ä¸ªæ•ˆæœåº”è¯¥æ€»æ˜¯è¯šå®åœ°å¯¹å¾…å®ƒçš„ä¾èµ–æ€§ã€‚æ¯æ¬¡è¿™ä¸ªæ‰¿è¯ºå¤±è´¥ï¼Œä¸€ä¸ªé”™è¯¯çš„ä»£ç è¡Œä¸ºå¯èƒ½ä¼šå‡ºç°ã€‚

> æ•ˆæœæ°¸è¿œä¸åº”è¯¥å¯¹å®ƒçš„ä¾èµ–æ€§æ’’è°ã€‚

#### ä¿®å¤ 2:å®Œå…¨ç§»é™¤ä¾èµ–æ•°ç»„

è§£å†³æ­¤é—®é¢˜çš„å¦ä¸€ä¸ªä¿®å¤æ–¹æ³•æ˜¯å®Œå…¨åˆ é™¤ä¾èµ–æ•°ç»„ã€‚å½“æ²¡æœ‰ä¾èµ–æ•°ç»„æ—¶ï¼ŒReact å°†ç¡®ä¿åœ¨è¿è¡Œæ–°çš„æ•ˆæœä¹‹å‰éµå¾ªæ¸…é™¤ä»¥å‰çš„æ•ˆæœçš„ä¾‹ç¨‹ã€‚ç°åœ¨ï¼Œå½“ç„¶ï¼Œä½ çŸ¥é“ä¸ºä»€ä¹ˆä¼šæœ‰ä¸åŒğŸ˜€

```
function Counter() {
  const [count, setCount] = useState(0);
// the following effect will run after the first render and after each update
  useEffect(() => {
    const id = setInterval(() => setCount(count + 1), 1000);
    return () => clearInterval(id);
  }); // âœ… No dependency array here.
  // will render the correct value of count
return <h1>Count is {count} </h1>;
} 
```

è¿™æ˜¯æ­£åœ¨è¿è¡Œçš„[æ¼”ç¤º](https://medium.com/r/?url=https%3A%2F%2Fcodesandbox.io%2Fs%2Fcountewithoutdeps-0ptoo)ã€‚

#### ä¿®å¤ 3:åœ¨ setter å†…éƒ¨ä½¿ç”¨â€˜updaterâ€™å‡½æ•°

ç°åœ¨ï¼Œå¦‚æœä½ æœ‰ä¸€åŒé”åˆ©çš„çœ¼ç›ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°å‰é¢æåˆ°çš„ä¸¤ä¸ªä¿®å¤éƒ½ä¸æ˜¯å¾ˆæœ‰æ•ˆã€‚æˆ‘ä»¬æ­£åœ¨ä¸ºæ¯æ¬¡æ¸²æŸ“åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¶é—´é—´éš”ã€‚æˆ‘ä»¬çš„è®¡æ•°å™¨å¯èƒ½è¿è¡Œç¼“æ…¢ï¼Œå› ä¸ºæµè§ˆå™¨åœ¨åº”ç”¨æ–°çš„æ—¶é—´é—´éš”ä¹‹å‰å¿…é¡»æ¸…é™¤ä»¥å‰çš„æ—¶é—´é—´éš”ã€‚è¿™å¯èƒ½éœ€è¦å‡ å¾®ç§’çš„æ—¶é—´ï¼Œæ…¢æ…¢ç´¯ç§¯èµ·æ¥ï¼Œæˆ‘ä»¬çš„è®¡æ•°å™¨å°±ä¼šå¼€å§‹å˜æ…¢ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½åªè®¾ç½®ä¸€æ¬¡æ—¶é—´é—´éš”ï¼Œåªåœ¨ç»„ä»¶å¸è½½æ—¶æ¸…é™¤å®ƒï¼Ÿå”¯ä¸€çš„æ–¹æ³•æ˜¯ä¼ é€’ä¸€ä¸ªç©ºæ•°ç»„ã€‚å¯¹å—ï¼Ÿä½†æ˜¯æˆ‘ä»¬åˆç¢°åˆ°äº†å’Œä¸Šé¢çœ‹åˆ°çš„ä¸€æ ·çš„é—®é¢˜ã€‚æˆ‘ä»¬å¿…é¡»å†æ¬¡ä¼ é€’è®¡æ•°å˜é‡ã€‚

å¥½å§ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªéš¾é¢˜ï¼Œæˆ‘ä»¬å°†éµå¾ªåŒæ ·çš„ç»éªŒæ³•åˆ™â€”â€”ä¸è¦å¯¹ä½ çš„æ•ˆæœçš„ä¾èµ–æ€§æ’’è°ã€‚ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹[æ¼”ç¤º](https://medium.com/r/?url=https%3A%2F%2Fcodesandbox.io%2Fs%2Fcounterusingstateupdater-5ynwv)ã€‚

```
function Counter() {
  const [count, setCount] = useState(0);
useEffect(() => {
    // âœ… No more dependency on `count` variable outside
    const id = setInterval(() => setCount(c => c + 1), 1000);
    return () => clearInterval(id);
  }, []);
return <h1>Count is : {count}</h1>;
} 
```

è¿™é‡Œæˆ‘ä»¬åœ¨ setter å‡½æ•°ä¸­ä½¿ç”¨ updater å‡½æ•°ï¼Œå®ƒä¸ä¾èµ–äºå¤–éƒ¨çš„ count å˜é‡ã€‚è¿™æ ·åšï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª**ç©ºçš„**ä¾èµ–æ•°ç»„ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰æ’’è°æ¥ååº”æˆ‘ä»¬æ•ˆæœçš„ä¾èµ–æ€§ã€‚è¿™æ˜¯ä¸€ä¸ªå€¼å¾—éª„å‚²çš„æ—¶åˆ»ğŸ‘ã€‚

#### ä¿®å¤ 4:â€œuseRefâ€æ¥æ•‘æ´

åœ¨ç»“æŸä¹‹å‰ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºè¿™ä¸ªé—®é¢˜çš„å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åŸºäºä½¿ç”¨å¦ä¸€ä¸ªå«åš [useRef](https://medium.com/r/?url=https%3A%2F%2Freactjs.org%2Fdocs%2Fhooks-reference.html%23useref) çš„é’©å­ã€‚

æˆ‘ä¸æƒ³è¯¦ç»†è§£é‡Š useRef å¦‚ä½•å·¥ä½œã€‚ä½†æˆ‘è®¤ä¸ºå®ƒä»¬æ˜¯ä¸€ä¸ªç›’å­ï¼Œä½ å¯ä»¥åœ¨é‡Œé¢æ”¾ç½®ä»»ä½•å€¼ã€‚å®ƒä»¬æ›´åƒ JavaScript ç±»ä¸­çš„[å®ä¾‹å±æ€§](https://medium.com/r/?url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FReference%2FClasses%23Instance_properties)ã€‚æœ‰è¶£çš„æ˜¯ï¼ŒReact **åœ¨ä¸åŒçš„æ¸²æŸ“ä¸­ä¿ç•™äº†ä» *useRef* è¿”å›çš„å¯¹è±¡çš„å€¼**ã€‚

è®©æˆ‘ä»¬æœ€åä¸€æ¬¡è®¿é—®æˆ‘ä»¬çš„ä»£ç ç¤ºä¾‹:

```
function CounterUsingRef() {
  const [count, setCount] = useState(0);
// âœ… putting fresh count into the latestCount
  const latestCount = useRef();
useEffect(() => {
    // âœ… make sure current always point to fresh value of count
    latestCount.current = count;
  });
useEffect(() => {
    const id = setInterval(() => setCount(latestCount.current + 1), 1000);
    return () => clearInterval(id);
  }, []);
return <h3>Counter with useRef: {count}</h3>;
} 
```

æˆ‘ä»¬åˆä¸€æ¬¡éµå®ˆäº†æˆ‘ä»¬çš„æ‰¿è¯ºï¼Œä¸ä¼šå¯¹æˆ‘ä»¬çš„ä¾èµ–æ€§æ’’è°ã€‚æˆ‘ä»¬çš„æ•ˆæœä¸å†æ˜¯*è®¡æ•°*å˜é‡ä¾èµ–ã€‚

å³ä½¿ interval ä»ç„¶é™æ€æ•è· *latestCount* å¯¹è±¡(å°±åƒåœ¨ç¬¬ä¸€ä¸ªæœ‰é”™è¯¯çš„ä¾‹å­ä¸­ä¸€æ ·)ï¼ŒReact ç¡®ä¿**å¯å˜** *å½“å‰*æ€»æ˜¯è·å¾—æ–°çš„è®¡æ•°å€¼ã€‚ğŸ™‚

å¦‚æœä½ æ„Ÿå…´è¶£çš„è¯ï¼Œè¿™é‡Œæœ‰ä¸Šé¢ä»£ç ç‰‡æ®µçš„æ¼”ç¤ºã€‚

### ç»“è®º

è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æˆ‘ä»¬åˆšåˆšå­¦åˆ°çš„å†…å®¹:

1.  ä¼ é€’ç»™*ä½¿ç”¨æ•ˆæœ*çš„**å‡½æ•°**å°†åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶**ä¸åŒ**ï¼Œè¿™ç§è¡Œä¸ºæ˜¯æœ‰æ„çš„ã€‚
2.  æ¯æ¬¡æˆ‘ä»¬é‡æ–°æ¸²æŸ“çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¼šå®‰æ’ä¸€ä¸ªæ–°çš„æ•ˆæœï¼Œå–ä»£ä¹‹å‰çš„**æ•ˆæœã€‚**
3.  æ‰€æœ‰çš„å‡½æ•°ï¼Œåœ¨**åˆ›å»ºé˜¶æ®µ**ï¼Œé™æ€åœ°æ•è·åœ¨**çˆ¶ä½œç”¨åŸŸ**ä¸­å®šä¹‰çš„å˜é‡ã€‚
4.  æˆ‘ä»¬åº”è¯¥**æ°¸è¿œä¸è¦æ’’è°**æ¥å¯¹æˆ‘ä»¬æ•ˆæœçš„ä¾èµ–æ€§åšå‡ºååº”ã€‚

* * *

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« è¯»èµ·æ¥æœ‰è¶£ï¼Œå¹¶å¸®åŠ©ä½ ç†è§£ä¸ºä»€ä¹ˆä¾èµ–æ•°ç»„åœ¨æˆ‘ä»¬çš„æ•ˆæœä¸­èµ·ç€é‡è¦çš„ä½œç”¨ã€‚å› æ­¤ï¼Œæˆ‘å¼ºçƒˆå»ºè®®å®‰è£…ä¸€ä¸ªåä¸º [*çš„ ESLint æ’ä»¶æ¥æ‰§è¡Œè¿™ä¸ªè§„åˆ™ã€‚*](http://ks%28https//www.npmjs.com/package/eslint-plugin-react-hooks)

è¿™é‡Œæœ‰ä¸€ä¸ªå•ç‹¬çš„[é“¾æ¥](https://codesandbox.io/s/setintervalwithuseeffect-vbneb)å°†æ‰€æœ‰çš„æ¼”ç¤ºåˆå¹¶åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ç•™æ„ç¬¬äºŒæ¬¡ä¿®æ­£ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æ…¢ä¸‹æ¥çš„ğŸ¢æ¯”ä¸Šä¸¤æ¬¡ä¿®å¤æ›´å¥½ã€‚

æ­¤å¤–ï¼Œè®©æˆ‘çŸ¥é“ä½ çš„æƒ³æ³•åœ¨ä¸‹é¢çš„è¯„è®ºï¼Œå¦‚æœä½ å–œæ¬¢å®ƒï¼Œä¸€äº›ğŸ‘ä¸€å®šä¼šè®©æˆ‘å¾®ç¬‘ğŸ˜ƒã€‚ç°åœ¨ï¼Œè¯·ç»§ç»­ä¸ä»–äººåˆ†äº«è¿™äº›çŸ¥è¯†ã€‚