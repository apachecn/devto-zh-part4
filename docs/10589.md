# å…·æœ‰æ··åˆç‰ˆæœ¬å’Œ libcluster çš„åˆ†å¸ƒå¼é…å‰‚

> åŸæ–‡ï¼š<https://dev.to/render/distributed-elixir-with-mix-releases-and-libcluster-47f5>

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ [libcluster](https://hexdocs.pm/libcluster) ã€ [Phoenix](https://phoenixframework.org) å’Œ [Mix releases](https://hexdocs.pm/mix/Mix.Tasks.Release.html) åœ¨ Render ä¸Šéƒ¨ç½²åˆ†å¸ƒå¼ Elixir é›†ç¾¤çš„æŒ‡å—ã€‚é›†ç¾¤è®¾ç½®ä¸ºè‡ªåŠ¨å‘ç°èŠ‚ç‚¹ï¼Œå¹¶åœ¨èŠ‚ç‚¹åŠ å…¥æˆ–ç¦»å¼€é›†ç¾¤æ—¶ä¿æŒèŠ‚ç‚¹åˆ—è¡¨æœ€æ–°ã€‚

æˆ‘ä»¬å°†ä»ä¸€ä¸ªè£¸çš„ Phoenix é¡¹ç›®å¼€å§‹ï¼Œä¿®æ”¹å®ƒä»¥ä½¿ç”¨ Mix releases å’Œ`libcluster`å¹¶åœ¨ Render ä¸Šéƒ¨ç½²å®ƒã€‚è¿™ä¸ªä¾‹å­çš„å®Œæ•´æºä»£ç å¯ä»¥åœ¨ https://github.com/render-examples/elixir_cluster è·å¾—ã€‚

## åˆ›å»ºå‡¤å‡° App

*   åœ¨ç»ˆç«¯ä¸­åˆ›å»ºæ–°çš„ Phoenix åº”ç”¨ç¨‹åºã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬ä¸éœ€è¦æ•°æ®åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æŠŠ`--no-ecto`æ ‡å¿—ä¼ é€’ç»™`mix`ã€‚

```
 # install phx.new; feel free to change 1.4.9 to a different version
   $ mix archive.install hex phx_new 1.4.9
   # create a new Phoenix app
   $ mix phx.new elixir_cluster_demo --no-ecto # also fetch and install dependencies
   $ cd elixir_cluster_demo 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   æ›´æ–°`mix.exs`ä»¥å°†`libcluster`æ·»åŠ åˆ° depsã€‚

```
 defp deps do
     [ ...,
       {:libcluster, "~> 3.1"}
     ] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨æ‚¨çš„ç»ˆç«¯ä¸­è¿è¡Œ`mix deps.get`æ¥æ›´æ–°ä¾èµ–å…³ç³»ã€‚

## é…ç½®æ··åˆå‘å¸ƒ

åˆ›å»º Mix å‘å¸ƒæ‰€éœ€çš„è¿è¡Œæ—¶é…ç½®ã€‚

1.  å°†`config/prod.secret.exs`é‡å‘½åä¸º`config/releases.exs`ã€‚
2.  å°†æ–°çš„`config/releases.exs`æ–‡ä»¶ä¸­çš„`use Mix.Config`æ›´æ”¹ä¸º`import Config`ã€‚
3.  å–æ¶ˆ`config/releases.exs`ä¸­ä»¥ä¸‹è¡Œçš„æ³¨é‡Š:

```
 config :elixir_cluster_demo, ElixirClusterDemoWeb.Endpoint, server: true 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åæ›´æ–°`config/prod.exs`åˆ é™¤åº•éƒ¨çš„è¡Œ`import_config "prod.secret.exs"`ã€‚

## é…ç½® libcluster

æˆ‘ä»¬çš„è®¾ç½®å°†åˆ›å»ºåä¸º`elixir-cluster-demo@10.200.30.4`çš„èŠ‚ç‚¹ï¼Œå…¶ä¸­ IP åœ°å€æ˜¯åŠ¨æ€çš„ã€‚é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œæ¸²æŸ“ä¼šä¸ºèŠ‚ç‚¹æŒ‡å®š IPï¼Œæ¯æ¬¡éƒ¨ç½²éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ IPã€‚è¿™å°±æ˜¯`libcluster`çš„ç”¨æ­¦ä¹‹åœ°:å®ƒé€šè¿‡å¤šç§å¯é…ç½®çš„[é›†ç¾¤ç®¡ç†ç­–ç•¥](https://hexdocs.pm/libcluster/readme.html#clustering)å®ç°[è‡ªåŠ¨é›†ç¾¤å½¢æˆ](https://hexdocs.pm/libcluster/readme.html#features)ã€‚

ç»™å®šåŠ¨æ€èŠ‚ç‚¹ IPï¼ŒDNS æ˜¯å¯é åœ°å½¢æˆé›†ç¾¤å¹¶ä¿æŒå…¶æœ€æ–°çš„æœ€ä½³æ–¹å¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`libcluster`çš„ [DNS ç­–ç•¥](https://hexdocs.pm/libcluster/Cluster.Strategy.Kubernetes.DNS.html)æ¥å½¢æˆé›†ç¾¤ã€‚

è®©æˆ‘ä»¬å°†`libcluster`æ·»åŠ åˆ°ç”Ÿäº§é…ç½®ä¸­ã€‚å°†ä»¥ä¸‹å‡ è¡Œæ·»åŠ åˆ°`rel/prod.exs`ã€‚

```
dns_name = System.get_env("RENDER_DISCOVERY_SERVICE")
app_name = System.get_env("RENDER_SERVICE_NAME")

config :libcluster, topologies: [
  render: [
    strategy: Cluster.Strategy.Kubernetes.DNS,
    config: [
      service: dns_name,
      application_name: app_name
    ]
  ]
] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Render æ ¹æ®æ‚¨çš„æœåŠ¡åè‡ªåŠ¨å¡«å……`RENDER_DISCOVERY_SERVICE`å’Œ`RENDER_SERVICE_NAME`ã€‚

æœ€åï¼Œé€šè¿‡å°†ä¸‹é¢çªå‡ºæ˜¾ç¤ºçš„è¡Œæ·»åŠ åˆ°`application.ex` :
ï¼Œå°†`libcluster`æ·»åŠ åˆ°åº”ç”¨ä¸»ç®¡

```
 def start(_type, _args) do
    # List all child processes to be supervised
    topologies = Application.get_env(:libcluster, :topologies) || []

    children = [
      # start libcluster
      {Cluster.Supervisor, [topologies, [name: ElixirClusterDemo.ClusterSupervisor]]},
      # Start the endpoint when the application starts
      ElixirClusterDemoWeb.Endpoint
      # Starts a worker by calling: ElixirClusterDemo.Worker.start_link(arg)
      # {ElixirClusterDemo.Worker, arg},
    ]

    # See https://hexdocs.pm/elixir/Supervisor.html
    # for other strategies and supported options
    opts = [strategy: :one_for_one, name: ElixirClusterDemo.Supervisor]
    Supervisor.start_link(children, opts)
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## æ˜¾ç¤ºè¿æ¥çš„èŠ‚ç‚¹

ä¸€æ—¦ä¸€åˆ‡å°±ç»ªï¼Œæ‚¨å°±å¯ä»¥ä½¿ç”¨`node()`è®¿é—®å½“å‰èŠ‚ç‚¹ï¼Œä½¿ç”¨`Node.list()`è®¿é—®é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ã€‚

æˆ‘ä»¬çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºåœ¨ä¸»é¡µä¸Šæ˜¾ç¤ºæ‰€æœ‰è¿æ¥çš„èŠ‚ç‚¹ã€‚åœ¨æ‚¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­ç¼–è¾‘ç´¢å¼•è§†å›¾å’Œæ¨¡æ¿ï¼Œå¦‚ [this commit](https://github.com/render-examples/elixir_cluster/commit/a7bec265602ab3e038a8e7af5e8a6cd67eba3e8b) æ‰€ç¤ºã€‚

## æ›´æ–°ä½ çš„åº”ç”¨ç¨‹åºè¿›è¡Œæ¸²æŸ“

æ›´æ–°`config/prod.exs`ä»¥æ›´æ”¹ä¸‹é¢çš„ä»£ç ã€‚

```
 config :elixir_cluster_demo, ElixirClusterDemoWeb.Endpoint,
     url: [host: "example.com", port: 80], 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹æ­¤:

```
 config :elixir_cluster_demo, ElixirClusterDemoWeb.Endpoint,
     url: [host: System.get_env("RENDER_EXTERNAL_HOSTNAME") || "localhost", port: 80], 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Render ä¸º`config/prod.exs`å¡«å……`RENDER_EXTERNAL_HOSTNAME`ã€‚

> å¦‚æœæ‚¨å°†è‡ªå®šä¹‰åŸŸæ·»åŠ åˆ°æ¸²æŸ“åº”ç”¨ç¨‹åºï¼Œè¯·ä¸è¦å¿˜è®°å°†ä¸»æœºæ›´æ”¹ä¸ºæ‚¨çš„æ–°åŸŸã€‚

## åˆ›å»ºä¸€ä¸ªæ„å»ºè„šæœ¬

æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡æ¨é€ Git repo æ—¶è¿è¡Œä¸€ç³»åˆ—å‘½ä»¤æ¥æ„å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ„å»ºè„šæœ¬æ¥å®Œæˆè¿™ä¸€ä»»åŠ¡ã€‚åœ¨ repo çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`build.sh`çš„è„šæœ¬:

```
 #!/usr/bin/env bash
   # Initial setup
   mix deps.get --only prod
   MIX_ENV=prod mix compile

   # Compile assets
   npm install --prefix ./assets
   npm run deploy --prefix ./assets
   mix phx.digest

   # Remove the existing release directory and build the release
   rm -rf "_build"
   MIX_ENV=prod mix release 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨å°†è„šæœ¬ç­¾å…¥ g it ä¹‹å‰ï¼Œç¡®ä¿è„šæœ¬æ˜¯å¯æ‰§è¡Œçš„:

```
 $ chmod a+x build.sh 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## åœ¨æœ¬åœ°æ„å»ºæ‚¨çš„ç‰ˆæœ¬

é€šè¿‡è¿è¡Œ`./build.sh`åœ¨æœ¬åœ°ç¼–è¯‘æ‚¨çš„ç‰ˆæœ¬ã€‚è¾“å‡ºåº”è¯¥æ˜¯è¿™æ ·çš„:

```
 Generated elixir_cluster_demo app
   * assembling elixir_cluster_demo-0.1.0 on MIX_ENV=prod
   * using config/releases.exs to configure the release at runtime
   * skipping elixir.bat for windows (bin/elixir.bat not found in the Elixir installation)
   * skipping iex.bat for windows (bin/iex.bat not found in the Elixir installation)

   Release created at _build/prod/rel/elixir_cluster_demo!

       # To start your system
       _build/prod/rel/elixir_cluster_demo/bin/elixir_cluster_demo start

   Once the release is running:

       # To connect to it remotely
       _build/prod/rel/elixir_cluster_demo/bin/elixir_cluster_demo remote

       # To stop it gracefully (you may also send SIGINT/SIGTERM)
       _build/prod/rel/elixir_cluster_demo/bin/elixir_cluster_demo stop

   To list all commands:

       _build/prod/rel/elixir_cluster_demo/bin/elixir_cluster_demo 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½ï¼ŒæŠŠä½ çš„æ”¹å˜æ¨è¿›åˆ°ä½ çš„å›è´­ä¸­ã€‚æ‚¨ç°åœ¨å¯ä»¥åœ¨ç”Ÿäº§ä¸­éƒ¨ç½²æ‚¨çš„åº”ç”¨ç¨‹åºäº†ï¼ğŸ‰

## éƒ¨ç½²æ¸²æŸ“

1.  åœ¨ Render ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ **Web æœåŠ¡**ï¼Œå¹¶æˆäºˆ Render è®¿é—®æ–° repo çš„æƒé™ã€‚

2.  åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ä»¥ä¸‹å€¼:

    | é’¥åŒ™ | ä»·å€¼ |
    | --- | --- |
    | **ç¯å¢ƒ** | `Elixir` |
    | **æ„å»ºå‘½ä»¤** | `./build.sh` |
    | **å¼€å§‹å‘½ä»¤** | `_build/prod/rel/elixir_cluster_demo/bin/elixir_cluster_demo start` |

    åœ¨**é«˜çº§**éƒ¨åˆ†ä¸‹ï¼Œæ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡:

    | é’¥åŒ™ | ä»·å€¼ |
    | --- | --- |
    | `SECRET_KEY_BASE` | ä¸€ä¸ªè¶³å¤Ÿå¼ºå¤§çš„ç§˜å¯†ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ`mix phx.gen.secret`åœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ªç§˜å¯† |

å°±æ˜¯è¿™æ ·ï¼ä¸€æ—¦æ„å»ºå®Œæˆï¼Œæ‚¨çš„åˆ†å¸ƒå¼ Elixir web æœåŠ¡å°†åœ¨æ‚¨çš„ Render URL ä¸Šè¿è¡Œã€‚

æ‚¨å¯ä»¥é€šè¿‡åœ¨**è®¾ç½®**ä¸‹å¢åŠ æ‚¨çš„æœåŠ¡çš„å®ä¾‹æ•°é‡æ¥å‘æ‚¨çš„é›†ç¾¤æ·»åŠ èŠ‚ç‚¹ã€‚

[![Update Server Instance Count](img/3b6e5d4aeeb22e067ef3d2256fedbb40.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--sJxh0dfg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ib4xegfo67u5le6h4gr4.png)

å®ä¾‹æ›´æ–°å¼€å§‹åï¼Œæ‚¨åº”è¯¥ä¼šåœ¨ä¸»é¡µä¸Šçœ‹åˆ°ç¬¬äºŒä¸ªèŠ‚ç‚¹ã€‚

[![Screenshot of Elixir Cluster Nodes](img/9cde0797ee12f1eac4f835501f4d8f1b.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--QKheHwxT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/wsxpx3ahh3dq9lx20zm1.png)

æ­å–œä½ ï¼æ‚¨å·²ç»æˆåŠŸåœ°åœ¨ç”Ÿäº§ä¸­è®¾ç½®äº†åˆ†å¸ƒå¼ Elixirï¼Œå¹¶ä¸”æ‚¨çš„é›†ç¾¤å°†éšç€èŠ‚ç‚¹çš„æ·»åŠ æˆ–åˆ é™¤è€Œè‡ªåŠ¨æ›´æ–°ã€‚ğŸ‰