# åœ¨ 5 åˆ†é’Ÿå†…ä¸º Knex.js(æˆ–å…¶ä»–åŸºäºèµ„æºçš„åº“)æ„å»ºä¸€ä¸ª NestJS æ¨¡å—

> åŸæ–‡:[https://dev . to/nestjs/build-a-nestjs-module-for-knex-js-or-other-resource-based-libraries-in-5-minutes-12an](https://dev.to/nestjs/build-a-nestjs-module-for-knex-js-or-other-resource-based-libraries-in-5-minutes-12an)

*çº¦ç¿°æ˜¯ NestJS æ ¸å¿ƒå›¢é˜Ÿçš„æˆå‘˜*

æœ‰æ²¡æœ‰æƒ³è¿‡å°†è‡ªå·±å–œæ¬¢çš„åº“é›†æˆåˆ° NestJS ä¸­ï¼Ÿä¾‹å¦‚ï¼Œè™½ç„¶ Nest å¯¹æ•°æ®åº“é›†æˆæœ‰å¹¿æ³›çš„å†…ç½®æ”¯æŒï¼Œä½†å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„åº“ï¼Œè€Œæ²¡æœ‰ Nest åŒ…ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸è‡ªå·±é€ ä¸€ä¸ªå‘¢ï¼Ÿ

èµ·åˆï¼Œè¿™ä¼¼ä¹æ˜¯ä¸€é¡¹è‰°å·¨çš„ä»»åŠ¡ã€‚ä½†æ˜¯å¦‚æœä½ å·²ç»[å…³æ³¨äº†æˆ‘çš„åšå®¢æ–‡ç« ](https://dev.to/johnbiundo)ï¼Œä½ ä¼šåœ¨æˆ‘çš„[ä¸Šä¸€ç¯‡æ–‡ç« ](https://dev.to/nestjs/advanced-nestjs-how-to-build-completely-dynamic-nestjs-modules-1370)ä¸­çœ‹åˆ° NestJS åŠ¨æ€æ¨¡å—çš„*è®¾è®¡æ¨¡å¼*ï¼Œå®ƒä¸ºä½ æŒ‡å‡ºäº†æ­£ç¡®çš„æ–¹å‘ã€‚å¥½å§ï¼Œä½ ä¼šè¯´ï¼Œä½†æ˜¯é›†æˆä¸€ä¸ªåº“ä¼¼ä¹éœ€è¦åšå¾ˆå¤šå·¥ä½œã€‚

æˆ‘æœ‰å¥½æ¶ˆæ¯ï¼ä½¿ç”¨ Nest CLI çš„å¼ºå¤§åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ NestJS çš„æœ€ä½³å®è·µï¼Œç”¨ä¸€ä¸ªå‘½ä»¤**ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ã€å®šåˆ¶çš„åŠ¨æ€æ¨¡å—æ¨¡æ¿ï¼**ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨å¤§çº¦ 5 åˆ†é’Ÿå†…é›†æˆæ‚¨çš„åº“ï¼è¿™ç§æŠ€æœ¯é€‚ç”¨äºè®¸å¤šåŸºäº*èµ„æºçš„*åº“ï¼Œå®ƒä»¬è¾“å‡ºæˆ‘ç§°ä¹‹ä¸º *API å¯¹è±¡*ï¼Œè¿™è‡ªç„¶ä¸ Nest çš„å†…ç½®*å•ä¾‹æä¾›è€…*æ¨¡å‹å¾ˆå¥½åœ°å·¥ä½œï¼Œç”¨äºå…±äº«å…¨å±€èµ„æºã€‚è·Ÿéšè¿™æ ·çš„å†’é™©ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢æ„å»ºä¸€ä¸ªåˆ° [Knex.js](http://knexjs.org/) çš„å¿«é€Ÿé›†æˆã€‚

è¯·ç»§ç»­å…³æ³¨è¢«å¤§å¤§ä½ä¼°çš„ NestJS CLI çš„å¥‡è¿¹ã€‚æ„å»ºåœ¨ Angular CLI ä¹‹ä¸Šï¼Œè¿™ä¸ªå·¥å…·å½»åº•æ”¹å˜æ‚¨ä½¿ç”¨ Nest çš„æ–¹å¼çš„æ½œåŠ›æ˜¯æ— é™çš„ã€‚åœ¨ä¸ä¹…çš„å°†æ¥ï¼Œæˆ‘å¯¹è¿™ä¸ªè¯é¢˜æœ‰æ›´å¤šçš„è®¡åˆ’ï¼

### [T1ã€‘ç®€ä»‹](#intro)

åœ¨æˆ‘ä¸Šå‘¨çš„[å¦‚ä½•æ„å»ºå®Œå…¨åŠ¨æ€çš„ NestJS æ¨¡å—](https://dev.to/nestjs/advanced-nestjs-how-to-build-completely-dynamic-nestjs-modules-1370)çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»‹ç»äº†ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼åœ¨æ ‡å‡†çš„ Nest åŒ…ä¸­ä½¿ç”¨ï¼Œæ¯”å¦‚`@nestjs/passport`ã€`@nestjs/jwt`å’Œ`@nestjs/typeorm`ã€‚è¿™ç¯‡æ–‡ç« çš„è§‚ç‚¹æœ‰ä¸¤ä¸ªæ–¹é¢:

*   æä¾›ä¸€ä¸ªé€šç”¨ NestJS åŒ…ä¸­ä½¿ç”¨çš„åŸºæœ¬æ¨¡å¼çš„è·¯çº¿å›¾ï¼Œå¸®åŠ©æ‚¨æˆä¸ºè¿™äº›åŒ…çš„æ›´å¥½çš„æ¶ˆè´¹è€…ã€‚
*   é¼“åŠ±å¼€å‘äººå‘˜è€ƒè™‘å¦‚ä½•åœ¨ä»–ä»¬è‡ªå·±çš„ä»£ç ä¸­åˆ©ç”¨è¿™ç§æ¨¡å¼æ¥å®ç°æ›´å®¹æ˜“ç»„åˆçš„æ¨¡å—ã€‚

æœ‰äº›äººå¯èƒ½è®¤ä¸ºè¿™ç§æ¨¡å¼æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä¸ä¸€å®šä¼šåé©³ã€‚ç„¶è€Œï¼Œå¾ˆå¥½åœ°ç†è§£å®ƒæ˜¯æœ‰ç”¨çš„ï¼Œæœ‰åŠ©äºæŒæ¡ Nest çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼Œå°¤å…¶æ˜¯åˆ©ç”¨*æ¨¡å—ç³»ç»Ÿ*å’Œ*ä¾èµ–æ³¨å…¥*ã€‚ç„¶è€Œï¼Œæ¨¡å¼ä¸­æœ‰ç›¸å½“æ•°é‡çš„æ ·æ¿ä»£ç ã€‚ç®€åŒ–æµç¨‹ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿ

ç³»å¥½å®‰å…¨å¸¦ã€‚NestJS CLI è‡ªå®šä¹‰åŸç†å›¾æ¥æ‹¯æ•‘ï¼ğŸš€

### [](#what-well-build)æˆ‘ä»¬è¦å»ºé€ ä»€ä¹ˆ

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå°†ç›´æ¥ API å¯¼å‡ºåˆ°å®Œæ•´çš„ [Knex.js](http://knexjs.org/) åº“çš„æ¨¡å—ã€‚è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®åº“é›†æˆåº“ï¼Œåœ¨ Node.js ç”Ÿæ€ç³»ç»Ÿä¸­å¹¿æ³›ä½¿ç”¨ã€‚è¿™æ˜¯æˆ‘ä»¬è¦åšçš„ã€‚ä¸‹é¢ç»™å‡ºäº†ä¸*å®Œå…¨ç›¸åŒçš„æ­¥éª¤*ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›æ­¥éª¤æ¥é›†æˆä»»ä½•å…¶ä»–åŸºæœ¬çš„å¯è°ƒç”¨ API(ä¾‹å¦‚ï¼Œ [ioredis](https://github.com/luin/ioredis) ã€ [Cassandra](https://github.com/datastax/nodejs-driver#readme) ã€ [Neo4J](https://github.com/neo4j/neo4j-javascript-driver#readme) ã€ [Elasticsearch](https://www.elastic.co/blog/new-elasticsearch-javascript-client-released) ã€ [LevelDb](https://github.com/Level/levelup) ç­‰ç­‰)ã€‚

1.  ä½¿ç”¨ [dynpkg](https://github.com/nestjsplus/dyn-schematics#use-case-1-generating-a-standalone-package) *å®šåˆ¶ç¤ºæ„å›¾*ç”Ÿæˆä¸€ä¸ªå®šåˆ¶åŒ…(è¯¥ç¤ºæ„å›¾è‡ªåŠ¨åŒ–äº†æˆ‘åœ¨ä¸Šé¢è®¨è®ºè¿‡çš„[åŠ¨æ€æ¨¡å—æ¨¡å¼](https://dev.to/nestjs/advanced-nestjs-how-to-build-completely-dynamic-nestjs-modules-1370))ã€‚
2.  å¡«å†™ä¸€äº›å¿«é€Ÿçš„ç»†èŠ‚æ¥å®šåˆ¶ Knex.js çš„åŒ…ã€‚
3.  ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•å®¢æˆ·ç«¯æ¥è¯æ˜å®ƒæ˜¯æœ‰æ•ˆçš„ã€‚

å¤šäºäº† Nest CLI çš„å¼ºå¤§åŠŸèƒ½ï¼Œå†åŠ ä¸Šä¸€ä¸ª*è‡ªå®šä¹‰ç¤ºæ„å›¾*ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤§çº¦ 5 åˆ†é’Ÿå†…å®Œæˆè¿™äº›æ­¥éª¤ï¼ä½œä¸ºå¥–åŠ±ï¼Œæˆ‘ä»¬å°†åœ¨æœ¬æ–‡æœ«å°¾ä»‹ç»ä¸€äº›æ›´é«˜çº§çš„ç‰¹æ€§ï¼ŒåŒ…æ‹¬å¦‚ä½•é€šè¿‡å•å‡»åœ¨ npm ä¸Šå‘å¸ƒç”Ÿæˆçš„åŒ…ã€‚

å¦‚æœæ‚¨æƒ³æŸ¥çœ‹æœ¬æ–‡å‰©ä½™éƒ¨åˆ†ä¸­ä»‹ç»çš„æ­¥éª¤çš„å®Œæ•´ç‰ˆæœ¬(ä¸€ä¸ª*å®Œå…¨å¯ç”¨çš„ NestJS/Knex.js æ¨¡å—*ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªå¸¦æœ‰å®Œæ•´ä»£ç çš„[github repo](https://github.com/nestjsplus/knex)ã€‚

### [](#nest-cli-and-schematics)åµŒå¥— CLI å’ŒåŸç†å›¾

æ‚¨å¯èƒ½å·²ç»ç»å¸¸ä½¿ç”¨ Nest CLI äº†ã€‚`nest new myProject`å’Œ`nest generate controller user`å°±æ˜¯å¸¸è§çš„ä¾‹å­ã€‚ä»–ä»¬ä½¿ç”¨ CLI è‡ªå¸¦çš„`@nestjs/schematics`åŒ…ã€‚éå¸¸é…·çš„æ˜¯ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°ä½¿ç”¨å…¶ä»–åŸç†å›¾æ¥å®Œæˆé«˜åº¦å®šåˆ¶çš„å·¥ä½œã€‚æ‰€æœ‰åŸç†å›¾çš„ä¸€ä¸ªå…±åŒç‰¹ç‚¹æ˜¯ï¼Œå®ƒä»¬*ç†è§£*ä½ çš„é¡¹ç›®ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå·§å¦™çš„æ–¹æ³•æ¥æ­å»ºæ–°çš„å»ºç­‘ç»„ä»¶ï¼Œå¹¶å°†å®ƒä»¬è¿æ¥åˆ°ä½ çš„é¡¹ç›®ä¸­ã€‚æŠŠä¸€ä¸ªå•ç‹¬çš„åŸç†å›¾æƒ³è±¡æˆä¸€ä¸ªè“å›¾ï¼ŒæŠŠ CLI æœºåˆ¶æƒ³è±¡æˆæ¯ä¸ªè“å›¾å¦‚ä½•å·¥ä½œçš„ä¸€å¥—æ ‡å‡†*ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œæ–°çš„åŸç†å›¾â€œå·¥ä½œæ­£å¸¸â€ï¼Œå¹¶ç»§æ‰¿äº† CLI æä¾›çš„æ‰€æœ‰åŠŸèƒ½åŠå…¶æ ‡å‡†åŠŸèƒ½ã€‚*

æ‚¨å¯ä»¥ç¼–å†™è‡ªå·±çš„åŸç†å›¾ï¼Œæˆ‘è®¡åˆ’åœ¨æ¥ä¸‹æ¥çš„ä¸€äº›åšå®¢æ–‡ç« ä¸­å‘æ‚¨å±•ç¤ºã€‚ç°åœ¨ï¼Œæˆ‘å·²ç»æ„å»ºäº†ä¸€ä¸ªï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥å®Œæˆæˆ‘ä»¬ä»Šå¤©æ‰¿æ‹…çš„åº“é›†æˆé¡¹ç›®ã€‚æˆ‘ä»¬å¼€å§‹å§ï¼

è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨åŸç†å›¾ï¼Œæ‚¨å½“ç„¶éœ€è¦å®‰è£…å®ƒä»¬ã€‚ä¸€ä¸ªé‡è¦æ³¨æ„äº‹é¡¹:ç”±äº CLI çš„å·¥ä½œæ–¹å¼ï¼Œæ‚¨**å¿…é¡»**å°† schematics é›†åˆä½œä¸ºå…¨å±€åŒ…å®‰è£…ã€‚

#### [](#installing-a-custom-schematics-collection)å®‰è£…è‡ªå®šä¹‰åŸç†å›¾é›†åˆ

Schematics è¢«æ‰“åŒ…æˆ*é›†åˆ*å¹¶ä¸”å¯ä»¥æ†ç»‘æˆ npm åŒ…ï¼Œæ‰€ä»¥å®‰è£…å®ƒä»¬å¾ˆç®€å•ã€‚ä½ ç°åœ¨å¯ä»¥ç”¨
æ¥åš

```
npm install @nestjsplus/dyn-schematics -g 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### [](#using-a-custom-schematics-collection)ä½¿ç”¨è‡ªå®šä¹‰åŸç†å›¾é›†åˆ

ä½¿ç”¨è‡ªå®šä¹‰é›†åˆä¸­çš„é€»è¾‘ç¤ºæ„å›¾éå¸¸ç®€å•ã€‚æ ‡å‡†åµŒå¥— CLI å‘½ä»¤ç»“æ„å¦‚ä¸‹æ‰€ç¤º:

> åµŒå¥—*å‘½ä»¤åˆ«å* [-c schematicCollection] *éœ€è¦å‘½ä»¤*[é€‰é¡¹]

*   *`commandOrAlias`* æ˜¯:`new`æˆ–`generate`(åˆ«å:`g`)æˆ–`add`
*   `schematicCollection`å¯é€‰ï¼Œé»˜è®¤ä¸ºå†…ç½®çš„ NestJS åŸç†å›¾ï¼›æ‚¨å¯ä»¥é€‰æ‹©æŒ‡å®šå…¨å±€å®‰è£…çš„ npm è½¯ä»¶åŒ…
*   *`requiredArg`* æ˜¯æ­£åœ¨ç”Ÿæˆ/æ·»åŠ çš„æ¶æ„å…ƒç´ ï¼Œä¾‹å¦‚`controller`ã€`module`æˆ–å¾ˆå¿«ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯`dynpkg`
*   `options`å¯¹æ‰€æœ‰åŸç†å›¾éƒ½æ˜¯å…¨å±€çš„ï¼›ä»–ä»¬å¯ä»¥æ˜¯`--dry-run`ã€`--no-spec`æˆ–`--flat`

å®‰è£…å®Œæˆåï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·ä½¿ç”¨[@ nestjsplus/dyn-schematics](https://github.com/nestjsplus/dyn-schematics)åŒ…:

1.  ç¡®ä¿æ‚¨ä½äºè¦ä½œä¸ºé¡¹ç›®çˆ¶çº§çš„æ–‡ä»¶å¤¹ä¸­ã€‚æ ¹æ®è¿™ä¸ªç¤ºæ„å›¾ï¼Œæˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ª*æ–°çš„*å®Œæ•´çš„ nest åŒ…ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯ä¸€ä¸ªæ–°çš„ç‹¬ç«‹é¡¹ç›®ã€‚å› æ­¤ï¼Œå®ƒå°†ä½¿ç”¨æ‚¨æä¾›çš„`name`åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¹¶å°†æ‰€æœ‰ç»„ä»¶æ”¾å…¥è¯¥æ–‡ä»¶å¤¹ä¸­ã€‚
2.  ä½¿ç”¨ CLI è¿è¡ŒåŸç†å›¾

```
nest g -c @nestjsplus/dyn-schematics dynpkg nest-knex 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä½¿ç”¨æ¥è‡ª`@nestjsplus/dyn-schematics`çš„è‡ªå®šä¹‰ schematics é›†åˆè¿è¡Œï¼Œå¹¶æŒ‡å®šè¦æ‰§è¡Œçš„`dynpkg`åŸç†å›¾(è¯¥åŸç†å›¾æ ‡è¯†äº†è¦ç”Ÿæˆçš„*ä¸œè¥¿*â€”â€”åœ¨æœ¬ä¾‹ä¸­ï¼Œæ˜¯æ ‡è¯†ä¸º`dynpkg`çš„*åŠ¨æ€æ¨¡å—åŒ…*ï¼Œå¹¶ç»™å®ƒä¸€ä¸ª`nest-knex`çš„`name`ã€‚å¦‚æœæ‚¨æƒ³çœ‹çœ‹åœ¨ä¸å°†æ–‡ä»¶æ·»åŠ åˆ°æ‚¨çš„æ–‡ä»¶ç³»ç»Ÿçš„æƒ…å†µä¸‹**ä¼šåšä»€ä¹ˆï¼Œåªéœ€åœ¨å‘½ä»¤æœ«å°¾æ·»åŠ `--dry-run`å³å¯ã€‚**

è¿™åº”è¯¥ä¼šæç¤ºæ‚¨ä¸€ä¸ªé—®é¢˜`Generate a testing client?`ã€‚å›ç­”â€œæ˜¯â€ä»¥ä½¿æµ‹è¯•æ›´å®¹æ˜“ã€‚æ‚¨å°†çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºï¼Œç„¶åæ‚¨å°†èƒ½å¤Ÿåœ¨æ‚¨çš„ IDE ä¸­ä»`nest-knex`æ–‡ä»¶å¤¹ä¸­æ‰“å¼€è¿™ä¸ªé¡¹ç›®ã€‚

```
â–º nest g -c @nestjsplus/dyn-schematics dynpkg nest-knex
? Generate a testing client? Yes
CREATE /nest-knex/.gitignore (375 bytes)
CREATE /nest-knex/.prettierrc (51 bytes)
CREATE /nest-knex/README.md (2073 bytes)
CREATE /nest-knex/nest-cli.json (84 bytes)
CREATE /nest-knex/package.json (1596 bytes)
CREATE /nest-knex/tsconfig.build.json (97 bytes)
CREATE /nest-knex/tsconfig.json (430 bytes)
CREATE /nest-knex/tslint.json (426 bytes)
CREATE /nest-knex/src/constants.ts (54 bytes)
CREATE /nest-knex/src/index.ts (103 bytes)
CREATE /nest-knex/src/main.ts (519 bytes)
CREATE /nest-knex/src/nest-knex.module.ts (1966 bytes)
CREATE /nest-knex/src/nest-knex.providers.ts (262 bytes)
CREATE /nest-knex/src/nest-knex.service.ts (1111 bytes)
CREATE /nest-knex/src/interfaces/index.ts (162 bytes)
CREATE /nest-knex/src/interfaces/nest-knex-module-async-options.interface.ts (532 bytes)
CREATE /nest-knex/src/interfaces/nest-knex-options-factory.interface.ts (194 bytes)
CREATE /nest-knex/src/interfaces/nest-knex-options.interface.ts (409 bytes)
CREATE /nest-knex/src/nest-knex-client/nest-knex-client.controller.ts (732 bytes)
CREATE /nest-knex/src/nest-knex-client/nest-knex-client.module.ts (728 bytes) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­¤æ—¶ï¼Œå¯ä»¥å®‰è£…ç”Ÿæˆçš„ä»£ç :

```
cd nest-knex
npm install 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ä½¿ç”¨
å¯åŠ¨åº”ç”¨ç¨‹åº

```
npm run start:dev 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæ‚¨ç°åœ¨æµè§ˆåˆ° [http://localhost:3000](http://localhost:3000) ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°:

> æ¥è‡ª NestKnexModule çš„ä½ å¥½ï¼

å¤ªå¥½äº†ï¼æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»æ­å»ºäº†åŠ¨æ€æ¨¡å—çš„*æ¡†æ¶*ï¼Œå¹¶ä¸”æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½å¼€å§‹ Knex.js é›†æˆã€‚

### [](#integrating-with-knexjs)ä¸ Knex.js é›†æˆ

ç°åœ¨æ‚¨å·²ç»æœ‰äº†ä¸€ä¸ªé¡¹ç›®æ¥å®Œæˆåº“é›†æˆã€‚æˆ‘ä»¬å¿…é¡»åšä¸€äº›ç¼–è¾‘æ¥æ‰§è¡Œå®é™…çš„é›†æˆã€‚è®©æˆ‘ä»¬å‘ä»–ä»¬è§£é‡Šä¸€ä¸‹:

1.  æˆ‘ä»¬éœ€è¦å®‰è£…`knex`ä½œä¸ºä¾èµ–é¡¹ã€‚æ³¨æ„ï¼Œä¸ºäº†**è¿è¡Œ**è¿™ä¸ªé¡¹ç›®ï¼Œä½ éœ€è¦è®¿é—®ä¸€ä¸ªæ´»åŠ¨çš„ SQL æ•°æ®åº“ã€‚Knex.js æ²¡æœ‰æ†ç»‘ä»»ä½•æ•°æ®åº“åº“ï¼Œæ‰€ä»¥æ‚¨éœ€è¦å®‰è£…åˆé€‚çš„åº“([æ‚¨å¯ä»¥åœ¨è¿™é‡Œ](http://knexjs.org/#Installation-node)é˜…è¯»æ›´å¤šä¿¡æ¯)ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ PostgreSqlï¼Œå®ƒå¯ä»¥åœ¨ localhost ä¸Šæ‰¾åˆ°ã€‚å¦‚æœæ‚¨æ²¡æœ‰å¯ç”¨çš„æœ¬åœ°æ•°æ®åº“ï¼Œæ‚¨å¯ä»¥è€ƒè™‘ä½¿ç”¨ docker è®¾ç½®çš„[ã€‚](https://docs.docker.com/samples/library/postgres/)
2.  æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥ä¸º Knex.js API æä¾›é…ç½®é€‰é¡¹ã€‚
3.  æˆ‘ä»¬éœ€è¦ä»¥å®ƒå¸Œæœ›è¢«åˆå§‹åŒ–çš„æ–¹å¼è°ƒç”¨ Knex.js APIï¼Œè¿”å›ä¸€ä¸ª`knex`å¯¹è±¡çš„å¥æŸ„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥è®¿é—® Knex.js ç‰¹æ€§ã€‚
4.  ä¸ºäº†è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŸç†å›¾è‡ªåŠ¨ç”Ÿæˆçš„å®¢æˆ·ç«¯æ§åˆ¶å™¨ã€‚
5.  ä¸€æ—¦æˆåŠŸï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªåŒ…äº†ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŒ…å‘å¸ƒåˆ°æ³¨å†Œä¸­å¿ƒ(ä¾‹å¦‚ï¼Œå†…éƒ¨åŒ…æ³¨å†Œä¸­å¿ƒæˆ–å…¬å¼€å‘å¸ƒåˆ° npmjs.com)

#### [](#install-dependencies)å®‰è£…ä¾èµ–é¡¹

éœ€è¦`knex`åŒ…ã€‚æ‚¨è¿˜éœ€è¦ä¸€ä¸ªæ•°æ®åº“ API åº“æ¥è¿è¡Œæ¨¡å—ã€‚ä¸‹é¢ï¼Œæˆ‘å¯¹ PostgreSql ä½¿ç”¨`pg`ï¼Œä½†æ˜¯ä½ å¯ä»¥é€‰æ‹©ä½ æƒ³è¦çš„(ä»è¿™é‡Œçš„[åˆ—è¡¨ä¸­é€‰æ‹©](http://knexjs.org/#Installation-node))ã€‚

```
cd nest-knex
npm install knex pg 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### [](#knexjs-options)Knex.js é€‰é¡¹

æ­£å¦‚åœ¨[åŠ¨æ€æ¨¡å—æ–‡ç« ](https://dev.to/nestjs/advanced-nestjs-how-to-build-completely-dynamic-nestjs-modules-1370#async-options-providers-usecase)ä¸­æ‰€è®¨è®ºçš„ï¼Œæˆ‘ä»¬ä½¿ç”¨*å¼‚æ­¥é€‰é¡¹æä¾›è€…*ä¸ºæœåŠ¡æä¾›é€‰é¡¹ã€‚å®Œæˆæ‰€æœ‰è¿™äº›çš„ä»£ç å·²ç»ä¸ºæ‚¨æ­å»ºå¥½äº†ï¼Œä½†æ˜¯è¦ä»¥æœ¬æœºç±»å‹è„šæœ¬çš„æ–¹å¼ä¼ é€’é€‚å½“çš„é€‰é¡¹ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹`NestKnexOptions`æ¥å£ã€‚è¿™åŒ…å«åœ¨æ–‡ä»¶`src/interfaces/nest-knex-options.interface.ts`ä¸­ã€‚

æˆ‘ä»¬æƒ³è¦æè¿°å°†è¢«ä¼ é€’ç»™åº“ API çš„å¯ç”¨ Knex.js é€‰é¡¹ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Knex.js å·²ç»æä¾›çš„ç±»å‹[ã€‚ç”±äºè¿™ä¸ªæ¥å£æ˜¯ç”±`knex`åŒ…å¯¼å‡ºçš„ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å¯¼å…¥å®ƒï¼Œæˆ‘ä»¬çš„å·¥ä½œå°±å¿«å®Œæˆäº†ï¼æˆ‘ä»¬ç®€å•åœ°ç»™å®ƒèµ·ä¸ªåˆ«åï¼Œè®©å®ƒå¯¹æˆ‘ä»¬ç”Ÿæˆçš„åŒ…å¯è§ã€‚æ‰“å¼€`src/interfaces/nest-knex-options.interface.ts`ï¼Œç¼–è¾‘æˆè¿™æ ·:](https://github.com/tgriesser/knex/blob/master/types/index.d.ts#L1590) 

```
// src/interfaces/nest-knex-options.interface.ts
import { Config } from 'knex';

export interface NestKnexOptions extends Config {} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### [](#knex-connections)Knex è¿æ¥

æˆ‘ä»¬æ¨¡å—çš„å·¥ä½œéå¸¸ç®€å•:è¿æ¥åˆ° API å¹¶è¿”å›ä¸€ä¸ªå¯é‡ç”¨çš„`knex`å¯¹è±¡æ¥ä¸æ•°æ®åº“äº¤äº’ã€‚åœ¨ PostgreSql çš„ä¾‹å­ä¸­ï¼Œ`knex`(åœ¨`pg`ä¹‹ä¸Š)è¿”å›ä¸€ä¸ª*è¿æ¥æ± *ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è¿æ¥ä¸€æ¬¡å¹¶è¿”å›ä¸€ä¸ª *singleton* `knex`å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†è‡ªåŠ¨å¹³è¡¡è¿æ¥æ± ä¸­çš„å¤šä¸ªæŸ¥è¯¢ã€‚è¿™ä¸ NestJS åŠå…¶å•ä½“æä¾›è€…çš„æ¦‚å¿µæ— ç¼åœ°é…åˆå·¥ä½œï¼

> æ³¨æ„:ä¸å…¶ä»–æ•°æ®åº“åº“ç›¸æ¯”ï¼Œæˆ‘å¯¹ Knex ä¸å¤ªç†Ÿæ‚‰ï¼Œå¯¹ MySQL ç­‰å…¶ä»–æ•°æ®åº“ä¹Ÿä¸å¤ªç†Ÿæ‚‰ï¼Œå› æ­¤ï¼Œå¦‚æœæ‚¨å°†æ­¤æ¨¡å—ç”¨äºæ­¤ç±»æ•°æ®åº“ï¼Œè¯·ç¡®ä¿æ‚¨äº†è§£åœ¨åº”ç”¨ç¨‹åºä¸­å…±äº«`knex`è¿æ¥å¯¹è±¡çš„æ­£ç¡®æ¨¡å¼ã€‚è¿™ä¸ªä¸»é¢˜**ä¸æ˜¯**ä¸€ä¸ª NestJS é—®é¢˜â€”â€”å®ƒå®Œå…¨æ˜¯å…³äº Knex.js åº“å’Œæ•°æ®åº“å®¢æˆ·ç«¯åº“çš„æ¶æ„ã€‚

ç°åœ¨æˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„æ¨¡å¼æ¥è¿”å›æˆ‘ä»¬çš„`knex`å¯¹è±¡ã€‚æ‰“å¼€`src/nest-knex.service.ts`ã€‚å¿«é€Ÿæµè§ˆä¸€ä¸‹ç”Ÿæˆçš„ä»£ç ï¼Œç„¶åç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢å®ƒ:

```
// src/nest-knex.service.ts
import { Injectable, Inject, Logger } from '@nestjs/common';
import { NEST_KNEX_OPTIONS } from './constants';
import { NestKnexOptions } from './interfaces';

const Knex = require('knex');

interface INestKnexService {
  getKnex();
}

@Injectable()
export class NestKnexService implements INestKnexService {
  private readonly logger: Logger;
  private _knexConnection: any;
  constructor(@Inject(NEST_KNEX_OPTIONS) private _NestKnexOptions: NestKnexOptions) {
    this.logger = new Logger('NestKnexService');
    this.logger.log(`Options: ${JSON.stringify(this._NestKnexOptions)}`);
  }

  getKnex() {
    if (!this._knexConnection) {
      this._knexConnection = new Knex(this._NestKnexOptions);
    }
    return this._knexConnection;
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å‡ ä¹æ‰€æœ‰è¿™äº›éƒ½ä¸ç”Ÿæˆçš„æ ·æ¿æ–‡ä»¶ä¸€æ ·ã€‚æˆ‘ä»¬ç®€å•åœ°æ·»åŠ äº†ä¸€ä¸ªå±æ€§æ¥å­˜å‚¨æˆ‘ä»¬çš„è¿æ¥å¯¹è±¡(`_knexConnection`)ï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ª`getKnex()`æ–¹æ³•æ¥åœ¨å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«è¯·æ±‚æ—¶å®ä¾‹åŒ–å®ƒï¼Œç„¶åç¼“å­˜å®ƒä»¥å¤‡å°†æ¥ä½¿ç”¨ã€‚

#### [](#test-the-module)æµ‹è¯•æ¨¡å—

å¦‚å‰æ‰€è¿°ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªæœ¬åœ°æ•°æ®åº“å®ä¾‹æ¥æµ‹è¯•è¯¥æ¨¡å—ã€‚å¦‚æœä½ æ‰‹å¤´æ²¡æœ‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ docker æ¥å®ç°ã€‚å¾ˆç®€å•ï¼

`@nestjsplus/dyn-schematics` `dynpkg`åŸç†å›¾ä¸ºæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå°å‹æµ‹è¯•*å®¢æˆ·ç«¯æ¨¡å—*(å‡è®¾ä½ å¯¹æç¤ºå›ç­”äº†`yes`)ã€‚æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å¿«é€Ÿæµ‹è¯•æˆ‘ä»¬çš„`nest-knex`æ¨¡å—ã€‚

é¦–å…ˆï¼Œæ‰“å¼€`src/nest-knex-client/nest-knex-client.module.ts`ï¼Œåœ¨`register()`æ–¹æ³•ä¸­æ·»åŠ æ‰€éœ€çš„ Knex.js é€‰é¡¹ã€‚é€‚å½“è°ƒæ•´ä¸€ä¸‹ä½ çš„:

```
// src/nest-knex-client/nest-knex-client.module.ts
...
@Module({
  controllers: [NestKnexClientController],
  imports: [
    NestKnexModule.register({
      client: 'pg',
      connection: {
        host: 'localhost',
        user: 'john',
        password: 'mypassword',
        database: 'nest',
        port: 5432,
      },
    }),
  ],
})
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæ‰“å¼€`src/nest-knex-client/nest-knex-client.controller.ts`å¹¶æ’å…¥ä¸€äº›æŸ¥è¯¢ã€‚å½“ç„¶ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è®¾è®¡æ¨¡å¼(ç›´æ¥ä»æ§åˆ¶å™¨è°ƒç”¨æ•°æ®åº“æœåŠ¡)ï¼Œè€Œåªæ˜¯ Knex.js é›†æˆå·¥ä½œçš„ä¸€ä¸ªå¿«é€Ÿæµ‹è¯•ã€‚å®é™…ä¸Šï¼Œæ‚¨ä¼šå¸Œæœ›æŒ‰ç…§ NestJS çš„æœ€ä½³å®è·µï¼Œå°†ä»»ä½•æ­¤ç±»è®¿é—®å§”æ‰˜ç»™çœŸæ­£çš„ NestJS *æœåŠ¡*ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªä½ å¯ä»¥å°è¯•çš„æƒ³æ³•ã€‚è¯¥æµ‹è¯•ä¾èµ–äºä»¥ä¸‹å¯ç”¨çš„æ•°æ®åº“è¡¨(ä»¥ä¸‹è¯­æ³•é€‚ç”¨äº PostgreSqlï¼Œä½†å¯èƒ½éœ€è¦å¯¹å…¶ä»–æ•°æ®åº“ç¨åŠ è°ƒæ•´):

```
CREATE TABLE cats
(
   id     serial    NOT NULL,
   name   text,
   age    integer,
   breed  text
);

ALTER TABLE cats
   ADD CONSTRAINT cats_pkey
   PRIMARY KEY (id); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæœ‰ä¸€ä¸ªä½ å¯ä»¥åœ¨æµ‹è¯•æ§åˆ¶å™¨ä¸­å°è¯•çš„ä¾‹å­ã€‚æ³¨æ„ï¼Œæ‚¨å¯ä»¥é€šè¿‡`knex`å¯¹è±¡è·å¾— Knex.js çš„å…¨éƒ¨åŠŸèƒ½ã€‚ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹[æ›´å¤šæœ‰è¶£çš„ä¾‹å­](http://knexjs.org/#Builder)ä½ å¯ä»¥ç”¨ Knex åšçš„äº‹æƒ…ã€‚æ—¢ç„¶æ‚¨æœ‰äº†ä¸€ä¸ª`knex`å¯¹è±¡çš„å¥æŸ„ï¼Œé‚£ä¹ˆæ‰€æœ‰è¿™äº› *Knex æŸ¥è¯¢æ„å»ºå™¨*æ–¹æ³•åº”è¯¥éƒ½å¯ä»¥å·¥ä½œäº†ï¼åœ¨è¿™ä¸ªå…¬è®¤çš„æ„šè ¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨ç´¢å¼•è·¯å¾„ä¸­åˆ›å»ºå’ŒæŸ¥è¯¢äº†ä¸€äº›çŒ«ï¼Œä½¿ç”¨`knex`å¯¹è±¡è®¿é—®æ•°æ®åº“ã€‚

```
// src/nest-knex-client/nest-knex-client.controller.ts
import { Controller, Get } from '@nestjs/common';
import { NestKnexService } from '../nest-knex.service';

@Controller()
export class NestKnexClientController {
  constructor(private readonly nestKnexService: NestKnexService) {}

  @Get()
  async index() {
    const knex = this.nestKnexService.getKnex();
    const newcat = await knex('cats').insert({
      name: 'Fred',
      age: 5,
      breed: 'tom cat',
    });

    const cats = await knex.select('*').from('cats');

    return cats;
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œç”¨`npm run start:dev`å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œæµè§ˆåˆ°`http://localhost:3000`ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ‚¨çš„æŸ¥è¯¢ç»“æœï¼

å¦‚æœä½ æƒ³ç”¨ä¸€ä¸ªå•ç‹¬çš„åº”ç”¨ç¨‹åºæµ‹è¯•è¿™ä¸ªæ¨¡å—â€”â€”çœŸæ­£å±•ç¤ºä½ åˆšåˆšæ„å»ºçš„å¯é‡ç”¨åº“æ¨¡å—çš„å¼ºå¤§åŠŸèƒ½â€”[é˜…è¯»](#publish-the-package),çœ‹çœ‹å¦‚ä½•ä¸€æ­¥å°†å®ƒä½œä¸º npm åŒ…ä¸Šä¼ ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæ‚¨å¯ä»¥ä¸‹è½½ä¸€ä¸ª[å®Œæ•´å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºï¼Œåœ¨è¿™é‡Œå¯¼å…¥æ¨¡å—](https://github.com/nestjsplus/knex-cats)ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥æµ‹è¯•æ‚¨æ–°åˆ›å»ºçš„ Knex.js æ¨¡å—ã€‚äº‹å®ä¸Šï¼Œ [knex-cats](https://github.com/nestjsplus/knex-cats) æ˜¯ä¸€ä¸ªå®Œå…¨å¯è¡Œçš„ä¾‹å­ï¼Œæ‰€ä»¥å¦‚æœä½ ä¸€ç›´åœ¨é˜…è¯»è€Œæ²¡æœ‰ç¼–ç ï¼Œè¿™æ˜¯çœ‹åˆ°æˆå“æœ€ç®€å•çš„æ–¹æ³•ã€‚

### [](#bonus-section)å¥–é‡‘éƒ¨åˆ†

å¸Œæœ›æˆ‘éµå®ˆäº†æˆ‘çš„æ‰¿è¯ºï¼Œå‘æ‚¨å±•ç¤ºäº†ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ NestJS æ¨¡å—æœ‰å¤šå¿«ï¼Œåªéœ€å‡ åˆ†é’Ÿå°±å¯ä»¥åŒ…è£…ä¸€ä¸ªå¤–éƒ¨èµ„æºåº“ï¼æˆ‘ä»¬å®Œæˆäº†â€”â€”ç°åœ¨æ‚¨æ‹¥æœ‰äº†ä¸€ä¸ªå®Œå…¨æˆç†Ÿçš„ Knex.js APIï¼æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­æ‰€åšçš„æŸ¥è¯¢åªæ˜¯å†°å±±ä¸€è§’ï¼Œå› ä¸º Knex.js æœ‰[ä¸€èˆ¹å¾ˆé…·çš„ç‰¹æ€§](http://knexjs.org/#Builder)ã€‚

è®©æˆ‘ä»¬å†è°ˆå‡ ä¸ªè¯é¢˜æ¥ç»“æŸè¿™æ¬¡è®¨è®ºã€‚

#### [](#a-better-api)æ›´å¥½çš„ API

å¦‚å‰æ‰€è¿°ï¼Œç›´æ¥ä»æˆ‘ä»¬çš„æ§åˆ¶å™¨è®¿é—®`knex`å¯¹è±¡å¹¶ä¸æ˜¯å¥½çš„åšæ³•ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªæœåŠ¡æ¥å­˜æ”¾æˆ‘ä»¬çš„æ•°æ®åº“é€»è¾‘ï¼Œè®©äº‹æƒ…å˜å¾—ç¨å¾®å¥½ä¸€ç‚¹ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ·»åŠ æ›´é«˜çº§åˆ«çš„ API æ¥ä½¿ Knex.js æ¨¡å—æ›´å®¹æ˜“ä½¿ç”¨ã€‚å°±è¿™ä¹ˆåŠå§ã€‚æˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ª*æä¾›è€…*ï¼Œè®©æˆ‘ä»¬ç›´æ¥å°†`knex`å¯¹è±¡æ³¨å…¥åˆ°ä»»ä½•æœåŠ¡ä¸­ã€‚ç¨åæ‚¨å°†çœ‹åˆ°è¿™æ˜¯å¦‚ä½•æ¸…ç† API çš„ã€‚

é¦–å…ˆï¼Œåœ¨`src`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`nest-knex-connection.provider.ts`çš„æ–‡ä»¶ã€‚æ·»åŠ ä»¥ä¸‹ä»£ç :

```
// src/nest-knex-connection.provider.ts
import { KNEX_CONNECTION } from './constants';
import { NestKnexService } from './nest-knex.service';

export const connectionFactory = {
  provide: KNEX_CONNECTION,
  useFactory: async nestKnexService => {
    return nestKnexService.getKnex();
  },
  inject: [NestKnexService],
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†éµå¾ªæä¾›è€…çš„æœ€ä½³å®è·µï¼Œæˆ‘ä»¬ä½¿ç”¨`KNEX_CONNECTION`å¸¸é‡ä½œä¸ºæˆ‘ä»¬çš„æä¾›è€…æ³¨å…¥ä»¤ç‰Œã€‚ä¸€å®šè¦æŠŠè¿™ä¸€è¡ŒåŠ åˆ°`src/constants.ts` :

```
export const KNEX_CONNECTION = 'KNEX_CONNECTION'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

çœ‹åˆ°æˆ‘ä»¬åœ¨åšä»€ä¹ˆäº†å—ï¼Ÿæˆ‘ä»¬å°†æ³¨å…¥ä»¤ç‰Œ(`KNEX_CONNECTION`)ç»‘å®šåˆ°ä¸€ä¸ªå·¥å‚ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ‘ä»¬çš„`knex` API å¯¹è±¡ï¼Œé¿å…äº†å®ä¾‹åŒ–æœåŠ¡çš„éœ€è¦ã€‚ä¾‹å¦‚ï¼Œä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†å¦ä¸€ä¸ªæ­¥éª¤(å¦‚ä¸‹)ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿè®¿é—®æ§åˆ¶å™¨ä¸­çš„`knex`å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤º(æ³¨æ„ç¤ºä¾‹ä»£ç ä¸­*æ—§*å’Œ*æ–°*ä¹‹é—´ç¨å¾®ç®€åŒ–çš„æŠ€æœ¯):

```
// src/nest-knex-client/nest-knex-client.controller.ts
import { Controller, Inject, Get } from '@nestjs/common';
import { KNEX_CONNECTION } from '../constants';

@Controller()
export class NestKnexClientController {
  // new
  constructor(@Inject(KNEX_CONNECTION) private readonly knex) {}
  // old
  // constructor(private readonly nestKnexService: NestKnexService) {}

  @Get()
  async index() {
    // following line no longer needed
    // const knex = this.nestKnexService.getKnex();
    const newcat = await this.knex('cats').insert({
      name: 'Fred',
      age: 5,
      breed: 'tom cat',
    });

    const cats = await this.knex.select('*').from('cats');

    return cats;
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦å°†è¿™ä¸ªæ–°çš„æä¾›è€…è¿æ¥åˆ°æˆ‘ä»¬çš„æ¨¡å—ä¸­ï¼Œæ‰“å¼€`src/nest-knex.module.ts`å¹¶è¿›è¡Œä»¥ä¸‹æ›´æ”¹:

1.  å¯¼å…¥`connectionFactory`
2.  å°†`connectionFactory`æ·»åŠ åˆ°`@Module`å…ƒæ•°æ®`providers`å’Œ`exports`å±æ€§ä¸­ã€‚æ–‡ä»¶çš„è¿™ä¸€éƒ¨åˆ†ç°åœ¨å°†å¦‚ä¸‹æ‰€ç¤º:

```
import { connectionFactory } from './nest-knex-connection.provider';

@Global()
@Module({
  providers: [NestKnexService, connectionFactory],
  exports: [NestKnexService, connectionFactory],
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ•°æ®åº“è®¿é—®æœ€ä½³å®è·µçš„å®Œæ•´å®ç°è¿˜éœ€è¦æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè®¿é—®`KNEX_CONNECTION`æä¾›è€…çš„**æœåŠ¡**ï¼Œè€Œä¸æ˜¯åœ¨æ§åˆ¶å™¨ä¸­å®Œæˆï¼Œä½†æ˜¯æˆ‘å°†æŠŠå®ƒç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ ã€‚ğŸ˜‰

#### [](#dynamic-registration-with-a-config-factory)åŠ¨æ€æ³¨å†Œ(å¸¦é…ç½®å·¥å‚)

åœ¨[åŠ¨æ€æ¨¡å—æ–‡ç« ](https://dev.to/nestjs/advanced-nestjs-how-to-build-completely-dynamic-nestjs-modules-1370#async-options-providers-usecase)ä¸­ï¼Œæˆ‘ä»¬è°ˆåˆ°äº†ä½¿ç”¨*å¼‚æ­¥é€‰é¡¹æä¾›è€…*ã€‚æˆ‘ä»¬çš„æ„æ€æ˜¯ï¼Œä¸è¦ä½¿ç”¨é™æ€å£°æ˜çš„åŒ…å«è¿æ¥å‚æ•°çš„*å¯¹è±¡ï¼Œæ¯”å¦‚:* 

```
 NestKnexModule.register({
      client: 'pg',
      connection: {
        host: 'localhost',
        user: 'john',
        password: 'mypassword',
        database: 'nest',
        port: 5432,
      },
    }), 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç›¸åï¼Œæˆ‘ä»¬å¸Œæœ›ä»¥åŠ¨æ€çš„æ–¹å¼æä¾›æˆ‘ä»¬çš„è¿æ¥é€‰é¡¹ã€‚å¥½æ¶ˆæ¯ï¼è¿™æ˜¯**å·²ç»å†…ç½®åˆ°ç”ŸæˆåŒ…ä¸­çš„**ã€‚è®©æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†åªä½¿ç”¨ä¸€ä¸ª*å°±åœ°*å·¥å‚ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨åŸºäº*ç±»çš„*ã€åŸºäº*å·¥å‚çš„*å’Œ*ç°æœ‰çš„*æä¾›è€…çš„å…¨éƒ¨åŠŸèƒ½ã€‚ä¸ºäº†æµ‹è¯•å®ƒï¼Œæˆ‘ä»¬å°†æ›´æ–°`src/nest-knex-client/nest-knex-client.module.ts`ä¸­`NestKnexModule`çš„æ³¨å†Œï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
// src/nest-knex-client/nest-knex-client/module.ts
    NestKnexModule.registerAsync({
      useFactory: () => {
        return {
          debug: false,
          client: 'pg',
          connection: {
            host: 'localhost',
            user: 'john',
            password: 'mypassword',
            database: 'nest',
            port: 5432,
          },
        };
      },
    }), 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸æ˜¯ä¸€ä¸ªéå¸¸ä»¤äººå…´å¥‹çš„ä¾‹å­ï¼Œä½†æ˜¯ä½ æ˜ç™½äº†ã€‚æ‚¨å¯ä»¥åˆ©ç”¨ä»»ä½•å¼‚æ­¥æä¾›ç¨‹åºæ–¹æ³•å‘æ¨¡å—æä¾›é…ç½®æ•°æ®ã€‚å¦‚æœæ‚¨æŸ¥çœ‹ä¸€ä¸‹ [knex-cats](https://github.com/nestjsplus/knex-cats) ç¤ºä¾‹ï¼Œæ‚¨å°†çœ‹åˆ°é…ç½®æ¨¡å—çš„ä¸€äº›æ›´å¥å£®çš„ç”¨æ³•ï¼Œä»¥åŠ¨æ€é…ç½®æˆ‘ä»¬çš„ knex æ¨¡å—ã€‚

#### [](#publish-the-package)å‘å¸ƒåŒ…

å¦‚æœæ‚¨é˜…è¯»äº†æˆ‘ä¹‹å‰çš„[ç”¨ npm](https://dev.to/nestjs/publishing-nestjs-packages-with-npm-21fm) å‘å¸ƒ NestJS åŒ…çš„æ–‡ç« ï¼Œæ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°è¿™ä¸ªåŒ…çš„*ç»“æ„*(ä¾‹å¦‚ï¼Œ`package.json`æ–‡ä»¶ã€`tsconfig.json`æ–‡ä»¶ã€æ ¹æ–‡ä»¶å¤¹ä¸­çš„`index.ts`æ–‡ä»¶)å®Œå…¨éµå¾ªè¿™ç§æ¨¡å¼ã€‚ç»“æœå‘å¸ƒè¿™ä¸ªåŒ…å°±è¿™ä¹ˆç®€å•(å‡è®¾ä½ æœ‰ä¸€ä¸ª`npmjs.com`è´¦å·ï¼Œä¹Ÿå°±æ˜¯):

```
npm publish 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯´çœŸçš„ï¼Œå°±æ˜¯è¿™æ ·ï¼

å½“ç„¶ï¼Œä½ å¯ä»¥ä¸€ç›´ä½¿ç”¨è¿™ä¸ªç°æˆçš„  åŒ…ï¼Œæ­£å¦‚æœ¬æ–‡æ‰€æè¿°çš„é‚£æ ·æ„å»º*ã€‚*

 *### [](#not-just-external-apis)ä¸ä»…ä»…æ˜¯å¤–éƒ¨ APIï¼

[@nestjsplus/dyn-schematics åŒ…](https://github.com/nestjsplus/dyn-schematics)ä¸ä»…æ”¯æŒç”Ÿæˆç‹¬ç«‹çš„åŒ…ï¼Œå¦‚å‰æ‰€è¿°ï¼Œè¿˜æ”¯æŒåœ¨ç°æœ‰é¡¹ç›®å†…ç”Ÿæˆå¸¸è§„çš„åŠ¨æ€æ¨¡å—*ã€‚æˆ‘ä¸ä¼šåœ¨è¿™é‡Œè¯¦ç»†è®¨è®ºï¼Œä½†æ˜¯ç”¨ä¾‹å¾ˆç®€å•ã€‚å‡è®¾æ‚¨æ­£åœ¨æ„å»ºä¸€ä¸ªåœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„*é…ç½®æ¨¡å—*ã€‚ç®€å•åœ°ç”¨`dynmod`ç¤ºæ„å›¾(è€Œä¸æ˜¯`dynpkg`)æ­å»ºå®ƒï¼Œå®ƒå°†ç”Ÿæˆä¸€ä¸ªæ–°çš„åŠ¨æ€æ¨¡å—*åˆ°æ‚¨ç°æœ‰çš„é¡¹ç›®*ä¸­ï¼Œä¸ºæ‚¨å®ç°æ‚¨çš„`register()`å’Œ`registerAsync()`é™æ€æ–¹æ³•çš„ç»†èŠ‚åšå¥½å……åˆ†å‡†å¤‡ã€‚*

è¿™*çš„å·¥ä½œæ–¹å¼*å®Œå…¨ç±»ä¼¼äºæ™®é€šçš„ CLI å‘½ä»¤ï¼Œç”¨äºæ·»åŠ åƒ*æ§åˆ¶å™¨*ã€*æœåŠ¡*å’Œ*æ¨¡å—*è¿™æ ·çš„å…ƒç´ ã€‚å…¶å®å®ƒçš„è¡Œä¸ºå’Œ`nest generate module`å¾ˆå¹³è¡Œã€‚å®ƒåœ¨æ‚¨çš„é¡¹ç›®å†…çš„ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­æ„å»º*åŠ¨æ€æ¨¡å—*åŠå…¶æ‰€æœ‰éƒ¨åˆ†(çœ‹èµ·æ¥ä¸æˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­çœ‹åˆ°çš„éå¸¸ç›¸ä¼¼ï¼Œé™¤äº†é¡¶å±‚åµŒå¥—åº”ç”¨ç¨‹åºç»„ä»¶),å¹¶ä¸”*å°†å®ƒä»¬è¿æ¥åˆ°é¡¹ç›®çš„å…¶ä½™éƒ¨åˆ†*,å°±åƒæ™®é€šçš„`module`ç¤ºæ„å›¾æ‰€åšçš„é‚£æ ·ã€‚åœ¨ github é¡µé¢ä¸Šé˜…è¯»æ›´å¤šå…³äºå®ƒçš„å†…å®¹ï¼Œç½‘å€ä¸º[@ nestjsplus/dyn-schematics](https://github.com/nestjsplus/dyn-schematics)ã€‚è¿™ä¸ªç”¨ä¾‹(å‘ç°æœ‰é¡¹ç›®æ·»åŠ ä¸€ä¸ªåŠ¨æ€æ¨¡å—)åœ¨è¿™é‡Œä¸­[ä»‹ç»ã€‚æ‚¨å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨ä¸€ä¸ªç°æœ‰çš„åµŒå¥—é¡¹ç›®ä¸­ç”¨
è¿›è¡Œä¸€æ¬¡å¿«é€Ÿçš„*æµ‹è¯•*](https://github.com/nestjsplus/dyn-schematics#use-case-2-adding-a-dynamic-module-to-an-existing-project)

```
nest g -c @nestjsplus/dyn-schematics dynmod myNewModule --dry-run 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#conclusion)ç»“è®º

å¦‚æœæ‚¨ä¸€ç›´åœ¨é˜…è¯»æœ¬ç³»åˆ—æ–‡ç« ï¼Œé‚£ä¹ˆæ‚¨å·²ç»äº†è§£äº†ä¸€ä¸ªå¼ºå¤§çš„æ¶æ„æ¨¡å¼ï¼Œç”¨äºæ„å»ºæ¨¡å—åŒ–çš„ NestJS æœåŠ¡å’Œæ¨¡å—ï¼Œå¹¶å°†å®ƒä»¬ç»„åˆæˆåº”ç”¨ç¨‹åºã€‚ç°åœ¨ï¼Œå€ŸåŠ© schematics çš„å¼ºå¤§åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥*è‡ªåŠ¨ç”Ÿæˆ*æ ·æ¿ä»£ç æ¥å®ç°è¿™ä¸ªå¼ºå¤§çš„æ¨¡å¼ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªç¤ºæ„å›¾æ¥å®šåˆ¶æ‚¨è‡ªå·±çš„å†…éƒ¨æ¨¡å—ï¼Œæˆ–è€…è½»æ¾åœ°é›†æˆå¤–éƒ¨ APIã€‚åœ¨ä»¥åçš„æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•æ„å»ºè‡ªå·±çš„åŸç†å›¾æ¥è¿›ä¸€æ­¥æ‰©å±• NestJS å’Œ NestJS CLI çš„åŠŸèƒ½ï¼

è¯·éšæ„æé—®ï¼Œå‘è¡¨æ„è§æˆ–å»ºè®®ï¼Œæˆ–è€…åœ¨ä¸‹é¢çš„è¯„è®ºä¸­è¯´å£°ä½ å¥½ã€‚è¯·å‚åŠ æˆ‘ä»¬çš„ [Discord](https://discord.gg/G7Qnnhy) èŠ‚ç›®ï¼Œäº«å—æ›´å¤šå…³äº NestJS çš„å¿«ä¹è®¨è®ºã€‚æˆ‘åœ¨é‚£é‡Œå‘å¸ƒçš„åå­—æ˜¯ *Y å‰æ™¯*ã€‚

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>*