# å°† next.js ä¸ react-router ä¸€èµ·ä½¿ç”¨

> åŸæ–‡:[https://dev.to/toomuchdesign/next-js-react-router-2kl8](https://dev.to/toomuchdesign/next-js-react-router-2kl8)

æœ¬æŠ¥å‘Šè®°å½•äº†åœ¨ä»¥ä¸‹è®¾ç½®ä¸­ä½¿ç”¨ [Next.js](https://github.com/zeit/next.js/) (ä¿ç•™åŸç”Ÿ SSR åŠŸèƒ½)çš„å°è¯•:

*   å•ä¸€å…¥å£ç‚¹(æ¯”å¦‚[åˆ›å»º React åº”ç”¨](https://github.com/facebook/create-react-app)å’Œ[è·³è½¬](https://github.com/xing/hops))ã€‚æ²¡æœ‰åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯ç”±
*   [react-è·¯ç”±å™¨](https://github.com/ReactTraining/react-router)ä½œä¸ºå”¯ä¸€çš„è·¯ç”±ç³»ç»Ÿ

æœ¬æ–‡æ¡£æœ‰ä»¥ä¸‹ç‰ˆæœ¬:

*   [GitHub åº“](https://github.com/toomuchdesign/next-react-router)
*   [å¼€å‘äººå‘˜å‘å¸ƒ](https://dev.to/toomuchdesign/next-js-react-router-2kl8)

* * *

## [](#disclaimers)å…è´£å£°æ˜

*   Next.js å›¢é˜Ÿå¼ºçƒˆåå¯¹è¿™ç§æ–¹æ³•ã€‚
*   è¿™ä¸ªå®éªŒæ˜¯åœ¨ Next.js v9.3 çš„æ—¶ä»£è¿›è¡Œçš„:ä»é‚£ä»¥åæ¡†æ¶å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ã€‚

* * *

## [](#part-one-basic-setup)ç¬¬ä¸€éƒ¨åˆ†ï¼ŒåŸºæœ¬è®¾ç½®

### [](#1-install-nextjs)1 -å®‰è£… Next.js

ç›¸å…³[å›è´­æ‰¿è¯º](https://github.com/toomuchdesign/next-react-router/tree/1-initial-setup)ã€‚

[ç…§å¸¸å®‰è£… NextJS](https://nextjs.org/docs#setup) ï¼Œåœ¨`pages/index.js`åˆ›å»º**å•å…¥å£ç‚¹**æ–‡ä»¶ã€‚

### [](#2-redirect-all-requests-to-single-entrypoint)2 -å°†æ‰€æœ‰è¯·æ±‚é‡å®šå‘åˆ°å•ä¸ªå…¥å£ç‚¹

ç›¸å…³[å›è´­æ‰¿è¯º](https://github.com/toomuchdesign/next-react-router/tree/2-redirect-to-entrypoint)ã€‚

ä¸ºäº†è·³è¿‡åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯ç”±ï¼Œæˆ‘ä»¬å°†é…ç½®ä¸€ä¸ª[è‡ªå®šä¹‰ Next.js æœåŠ¡å™¨](https://nextjs.org/docs#custom-server-and-routing)æ¥å°†æ‰€æœ‰è¯·æ±‚è½¬å‘åˆ°æˆ‘ä»¬çš„å•ä¸ªå…¥å£ç‚¹ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ Next.js [`Server.render`æ–¹æ³•](https://github.com/zeit/next.js/blob/2b1a5c3eb4f67a30e1a9000d7d21e14bbe536687/packages/next-server/server/next-server.ts#L405)æ¥å‘ˆç°å’ŒæœåŠ¡å…¥å£ç‚¹ã€‚

```
// server.js
const express = require('express');
const nextJS = require('next');

async function start() {
  const dev = process.env.NODE_ENV !== 'production';
  const app = nextJS({dev});
  const server = express();
  await app.prepare();

  // Redirect all requests to main entrypoint pages/index.js
  server.get('/*', async (req, res, next) => {
    try {
      app.render(req, res, '/');
    } catch (e) {
      next(e);
    }
  });

  server.listen(3000, err => {
    if (err) throw err;
    console.log(`> Ready on http://localhost:3000`);
  });
}

start(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿è¡Œ dev æœåŠ¡å™¨ï¼Œä½äº`pages/index.js`çš„å…¥å£ç‚¹é¡µé¢åº”è¯¥ä½œä¸ºä»»ä½•è¯·æ±‚çš„ url çš„å“åº”ã€‚ğŸ‘Š

### [](#3-introduce-reactrouter)3 -ä»‹ç» react-è·¯ç”±å™¨

ç›¸å…³[å›è´­æ‰¿è¯º](https://github.com/toomuchdesign/next-react-router/tree/3-introduce-react-router)ã€‚

ä¸ºäº†æ ¹æ®è¯·æ±‚çš„ url å¾—åˆ°ä¸åŒçš„å“åº”ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè·¯ç”±ç³»ç»Ÿã€‚

æˆ‘ä»¬å°†ä½¿ç”¨`react-router`(å‚è§å…³äº SSR çš„[æ–‡æ¡£)å¹¶åŸºäºç¯å¢ƒåº”ç”¨ç¨‹åºç¯å¢ƒ(æœåŠ¡å™¨æˆ–æµè§ˆå™¨)ç”¨`StaticRouter`æˆ–`BrowserRouter`åŒ…è£…åº”ç”¨ç¨‹åºã€‚](https://reacttraining.com/react-router/web/guides/server-rendering)

å®‰è£…`react-router`å’Œ`react-router-dom` :

```
npm i react-router react-router-dom -S 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

...å¹¶æ›´æ–°`pages/index.js`å…¥å£ç‚¹ä»¥ä½¿ç”¨æ¥è‡ª`react-router-dom`çš„ä¸€äº›`Link`å’Œ`Route`ç»„ä»¶(å‚è§ repo)ã€‚

ç°åœ¨è®©æˆ‘ä»¬å£°æ˜ä¸€ä¸ª`withReactRouter` HOC æ¥ç”¨åˆé€‚çš„è·¯ç”±å™¨:
åŒ…è£…åº”ç”¨ç¨‹åº

```
// next/with-react-router.js
import React from 'react';
import {BrowserRouter} from 'react-router-dom';
const isServer = typeof window === 'undefined';

export default App => {
  return class AppWithReactRouter extends React.Component {
    render() {
      if (isServer) {
        const {StaticRouter} = require('react-router');
        return (
          <StaticRouter
            location={this.props.router.asPath}
          >
            <App {...this.props} />
          </StaticRouter>
        );
      }
      return (
        <BrowserRouter>
          <App {...this.props} />
        </BrowserRouter>
      );
    }
  };
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

...å¹¶ç”¨`withReactRouter` HOC:
åŒ…è£…åº”ç”¨ç¨‹åº

```
// pages/_app.js
import App, {Container} from 'next/app';
import React from 'react';
import withReactRouter from '../next/with-react-router';

class MyApp extends App {
  render() {
    const {Component, pageProps} = this.props;
    return (
      <Container>
        <Component {...pageProps} />
      </Container>
    );
  }
}

export default withReactRouter(MyApp); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿è¡Œ dev æœåŠ¡å™¨ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æ‚¨çš„å®æ—¶è·¯çº¿å’ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ã€‚

## [](#part-two-context-information)ç¬¬äºŒéƒ¨åˆ†ï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯

æˆ‘æœ€å–œæ¬¢çš„`react-router`ç‰¹æ€§ä¹‹ä¸€åŒ…æ‹¬åœ¨æ¸²æŸ“é˜¶æ®µ[æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯](https://reacttraining.com/react-router/web/guides/server-rendering/adding-app-specific-context-information)å’Œ**åŸºäºæ”¶é›†åˆ° **`context`å¯¹è±¡**ä¸­çš„ä¿¡æ¯è¿”å›æœåŠ¡å™¨ç«¯å“åº”**çš„å¯èƒ½æ€§ã€‚

è¿™ä½¿å¾—å®¢æˆ·ç«¯ä»£ç èƒ½å¤Ÿæ§åˆ¶èŠ‚ç‚¹æœåŠ¡å™¨è¿”å›çš„å“åº”ï¼Œå¦‚**è¿”å› HTTP 404** è€Œä¸æ˜¯â€œæœªæ‰¾åˆ°çš„é¡µé¢â€,æˆ–è€…è¿”å›**çœŸå®çš„ HTTP 302 é‡å®šå‘**è€Œä¸æ˜¯å®¢æˆ·ç«¯é‡å®šå‘ã€‚

ä¸ºäº†å®ç°è¿™ç§è¡Œä¸ºï¼Œæˆ‘ä»¬å¿…é¡»é…ç½® Next.js æ¥æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

1.  å‘ˆç°æ‰€è¯·æ±‚çš„é¡µé¢ï¼Œå‘åº”ç”¨è·¯ç”±å™¨æä¾›ä¸Šä¸‹æ–‡å¯¹è±¡
2.  æ£€æŸ¥åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ä¸Šä¸‹æ–‡å¯¹è±¡æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–
3.  æ ¹æ®ä¸Šä¸‹æ–‡å¯¹è±¡å†³å®šæ˜¯è¿”å›å‘ˆç°çš„é¡µé¢è¿˜æ˜¯åšå…¶ä»–äº‹æƒ…

### [](#4-provide-context-object-to-the-router)4 -å‘è·¯ç”±å™¨æä¾›ä¸Šä¸‹æ–‡å¯¹è±¡

ç›¸å…³[å›è´­æ‰¿è¯º](https://github.com/toomuchdesign/next-react-router/tree/4-provide-context)ã€‚

æˆ‘ä»¬å°†åœ¨ Express' `req.local`å¯¹è±¡ä¸­æ³¨å…¥ä¸€ä¸ªç©ºçš„`context`å¯¹è±¡ï¼Œå¹¶é€šè¿‡ [React ä¸Šä¸‹æ–‡](https://reactjs.org/docs/context.html)ä½¿å…¶å¯¹è·¯ç”±å™¨åº”ç”¨ç¨‹åºå¯ç”¨ã€‚

è®©æˆ‘ä»¬å°†`context`å¯¹è±¡æ³¨å…¥åˆ° Express' `req.local`å¯¹è±¡:

```
// server.js
server.get('/*', async (req, res, next) => {
  try {
+   req.locals = {};
+   req.locals.context = {};
    app.render(req, res, '/'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Next.js æä¾›äº†ä¸€ä¸ª`req`å’Œ`res`å¯¹è±¡ä½œä¸º [`getInitialProps`é™æ€æ–¹æ³•](https://nextjs.org/docs#fetching-data-and-component-lifecycle)çš„é“å…·ã€‚æˆ‘ä»¬å°†è·å–`req.originalUrl`å’Œ`req.locals.context`ï¼Œå¹¶å°†å…¶äº¤ç»™é™æ€è·¯ç”±å™¨ã€‚

```
// next/with-react-router.js
  return class AppWithReactRouter extends React.Component {
+   static async getInitialProps(appContext) {
+     const {
+       ctx: {
+         req: {
+           originalUrl,
+           locals = {},
+         },
+       },
+     } = appContext;
+     return {
+       originalUrl,
+       context: locals.context || {},
+     };
+   } 
  // Code omitted
          <StaticRouter
-           location={this.props.router.asPath} +           location={this.props.originalUrl}
+           context={this.props.context}
          > 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#5-separate-rendering-and-response)5 -å•ç‹¬æ¸²æŸ“å’Œå“åº”

ç›¸å…³[å›è´­æ‰¿è¯º](https://github.com/toomuchdesign/next-react-router/)ã€‚

ç”±äºæˆ‘ä»¬å¸Œæœ›åŸºäº SSR å’ŒæœåŠ¡å™¨å“åº”ä¹‹é—´çš„`req.locals.context`æä¾›é¢å¤–çš„æœåŠ¡å™¨è¡Œä¸ºï¼ŒNext.js `Server.render`ç¼ºä¹çµæ´»æ€§ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ Next.js `Server.renderToHTML`å’Œ`Server.sendHTML`æ–¹æ³•é‡æ–°å®ç°`server.js`ä¸­çš„`Server.render`ã€‚

è¯·æ³¨æ„ï¼Œæœ‰äº›ä»£ç è¢«çœç•¥äº†ã€‚æœ‰å…³å®Œæ•´çš„å®ç°ï¼Œè¯·å‚è€ƒæºä»£ç ã€‚

```
// server.js
  server.get('/*', async (req, res, next) => {
    try {
+     // Code omitted 
      req.locals = {};
      req.locals.context = {};
-     app.render(req, res, '/'); +     const html = await app.renderToHTML(req, res, '/', {});
+
+     // Handle client redirects
+     const context = req.locals.context;
+     if (context.url) {
+       return res.redirect(context.url)
+     }
+
+     // Handle client response statuses
+     if (context.status) {
+       return res.status(context.status).send();
+     }
+
+     // Code omitted
+     app.sendHTML(req, res, html);
    } catch (e) { 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨å°†å¸¦æœ‰å‘ˆç°çš„ HTML çš„å“åº”å‘é€ç»™å®¢æˆ·æœºä¹‹å‰ï¼Œæˆ‘ä»¬ç°åœ¨æ£€æŸ¥`context`å¯¹è±¡ï¼Œå¹¶åœ¨å¿…è¦æ—¶é‡å®šå‘æˆ–è¿”å›ä¸€ä¸ªå®šåˆ¶çš„ HTTP ä»£ç ã€‚

ä¸ºäº†è¿›è¡Œè¯•éªŒï¼Œå°†`pages/index.js`å…¥å£ç‚¹æ›´æ–°ä¸º[ï¼Œåˆ©ç”¨`<Redirect>`å’Œ`<Status>`ç»„ä»¶](https://github.com/toomuchdesign/next-react-router/blob/master/pages/index.js)ï¼Œå¹¶å¯åŠ¨å¼€å‘æœåŠ¡å™¨ã€‚

## [](#summary)æ€»ç»“

æˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•è®¾ç½® Next.js æ¥å……åˆ†åˆ©ç”¨`react-router` çš„**ä¼˜åŠ¿ï¼Œå¯ç”¨**å•ä¸€å…¥å£ç‚¹**æ–¹æ³•å¹¶å®Œå…¨**ä¿ç•™ SSR** ã€‚**

ä¸ºæ­¤ï¼Œæˆ‘ä»¬:

1.  å°†æ‰€æœ‰æœåŠ¡å™¨è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªå•ä¸€å…¥å£ç‚¹
2.  **ç”¨åˆé€‚çš„ **`react-router`è·¯ç”±å™¨**åŒ…è£…**åº”ç”¨ç¨‹åº(ä½¿ç”¨ HOC)
3.  ç”¨ä¸€ä¸ª **`locals.context`å¯¹è±¡**æ³¨å…¥`req`æœåŠ¡å™¨å¯¹è±¡
4.  ä¸º**ç‰¹è®¾åŒ…è£…**æä¾›`req.locals.context`å’Œ`req.originalUrl`
5.  **æ‰©å±•äº† next.js `Server.render`** æ¥è€ƒè™‘å‘é€ HTML å‰çš„`req.locals.context`

userland ä»£ç ä¸­çš„`Server.render`çš„é‡æ–°å®ç°æ˜¯æœ€ä»¤äººä¸å®‰çš„éƒ¨åˆ†ï¼Œä½†æ˜¯é€šè¿‡æ‰©å±• Next.js ä¸­çš„ bit `Server.render` APIï¼Œè¿™å¯èƒ½æ˜¯ä¸å¿…è¦çš„ã€‚

### [](#results)ç»“æœ

#### [](#-raw-reactrouter-endraw-rendered-server-side)`react-router`å‘ˆç°æœåŠ¡å™¨ç«¯

react-router çš„`<Route>`ç»„ä»¶æ ¹æ®æ”¶åˆ°çš„ [`req.originalUrl`](https://expressjs.com/en/api.html#req.originalUrl) url åœ¨æœåŠ¡å™¨ä¸Šé™æ€å‘ˆç°**ã€‚**

 **[![Server side render](../Images/1a5284bf46f323154ba8e8a075f5b969.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--E4JjQfJf--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://raw.githubusercontent.com/toomuchdesign/next-react-router/master/docs/ssr.png)

#### [](#http-302-redirect-triggered-by-client-code)å®¢æˆ·ç«¯ä»£ç è§¦å‘çš„ HTTP 302 é‡å®šå‘

å½“æœåŠ¡å™¨æ¸²æŸ“è¿‡ç¨‹é‡åˆ°`<Redirect from="/people/" to="/users/" />`ç»„ä»¶æ—¶ï¼ŒæœåŠ¡å™¨å“åº”å°†è¿”å›ä¸€ä¸ª **HTTP 302 å“åº”**ï¼Œå¸¦æœ‰é¢„æœŸçš„ **`Location`å¤´**ã€‚

[![HTTP 302 redirect](../Images/a4d956a08c65e6ba92b7dafb260dd2aa.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--JzL7S2zQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://raw.githubusercontent.com/toomuchdesign/next-react-router/master/docs/302.png)

#### [](#http-404-triggered-by-client-code)HTTP 404 ç”±å®¢æˆ·ç«¯ä»£ç è§¦å‘

å½“æœåŠ¡å™¨æ¸²æŸ“è¿‡ç¨‹é‡åˆ°`<Status code={404}/>`ç»„ä»¶æ—¶ï¼Œ**æœåŠ¡å™¨**å“åº”è¿”å›ä¸€ä¸ª **HTTP å“åº”**ï¼Œå¸¦æœ‰**é¢„æœŸçŠ¶æ€ç **ã€‚

[![HTTP 404 redirect](../Images/405014f6c8496e595efc8c20ffa920b1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--_t3DcCiH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://raw.githubusercontent.com/toomuchdesign/next-react-router/master/docs/404.png)

### [](#further-consideration)è¿›ä¸€æ­¥è€ƒè™‘

æˆ‘æ•¢è‚¯å®šï¼Œè¿™ç§è®¾ç½®æ˜¯è¿œè¿œä¸æ˜¯æœ€ä½³çš„ã€‚æˆ‘å¾ˆä¹æ„è€ƒè™‘ä»»ä½•å»ºè®®ã€åé¦ˆã€æ”¹è¿›å’Œæƒ³æ³•ã€‚

### [](#issues)é—®é¢˜

*   é™æ€é¡µé¢æœªè¢«å¯¼å‡º
*   å¼€å‘æ¨¡å¼æ— æ³•æŒ‰éœ€æ„å»ºè¯·æ±‚çš„è·¯çº¿
*   `getInitialProps`æœªå®æ–½**