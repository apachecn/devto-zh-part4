# ä½¿ç”¨ Node å’Œ Express åˆ›å»º REST æœåŠ¡ä»¥ä¾¿ä¸ Unity ä¸€èµ·ä½¿ç”¨â€”â€”ç¬¬ 3 éƒ¨åˆ†

> åŸæ–‡:[https://dev . to/ce muka/making-a-rest-service-using-node-and-express-to-use-with-unity-part-3-4 onf](https://dev.to/cemuka/making-a-rest-service-using-node-and-express-to-use-with-unity-part-3-4onf)

é—®å€™æ‰€æœ‰çš„ç»Ÿä¸€å¿è€…ï¼

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä» unity å®¢æˆ·ç«¯å‘èŠ‚ç‚¹æœåŠ¡å™¨å‘å‡º POST è¯·æ±‚ã€‚æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»ºæ•°æ®åº“ï¼Œæ‰€ä»¥æˆ‘ç°åœ¨è¦åˆ›å»ºä¸€ä¸ªæ•°ç»„ã€‚

ä»æœåŠ¡å™¨ç«¯å¼€å§‹ã€‚åœ¨`app.js`ä¸­ï¼Œè®°å¾—æˆ‘ä»¬æœ‰ä¸€ä¸ªå•ä¸€çš„æ•Œäººå¯¹è±¡ï¼Œè¿™éƒ¨åˆ†ï¼Œæˆ‘å°†åˆ›å»ºä¸€ä¸ªæ•°ç»„å¹¶å¡«å……ä¸€äº›æ•Œäººã€‚

```
let enemies = [
    {
        "id": 0,
        "name": "orc",
        "health": 100,
        "attack": 25
    },
    {
        "id": 1,
        "name": "wolf",
        "health": 110,
        "attack": 25
    }
]; 
```

æ¥ä¸‹æ¥ï¼Œå‘Šè¯‰ express æ”¯æŒ JSON ç¼–ç çš„ä¸»ä½“ã€‚

```
app.use(express.json()); 
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª post æ–¹æ³•æ¥æ¥æ”¶æ¥è‡ª unity å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚

```
app.post('/enemy/create', (req, res) => {
let newEnemy = {
    "id": req.body.id,
    "name": req.body.name,
    "health": req.body.health,
    "attack": req.body.attack
};

enemies.push(newEnemy);
console.log(enemies);
res.send(enemies);
}); 
```

æˆ‘å°†ä¿®æ”¹æˆ‘çš„ get æ–¹æ³•æ¥è·å–æˆ‘çš„`enemies`æ•°ç»„ã€‚ç°åœ¨æˆ‘çš„`app.js`æ–‡ä»¶æ˜¯è¿™æ ·çš„:

```
const express = require('express');
const app = express();
app.use(express.json());

app.get('/', (req, res) => {
    res.send('Hello Unity Developers!');
});

let enemies = [
    {
        "id": 0,
        "name": "orc",
        "health": 100,
        "attack": 25
    },
    {
        "id": 1,
        "name": "wolf",
        "health": 110,
        "attack": 25
    }
];

app.get('/enemy', (req, res) => {
    res.send(enemies);
});

app.post('/enemy/create', (req, res) => {
let newEnemy = {
    "id": req.body.id,
    "name": req.body.name,
    "health": req.body.health,
    "attack": req.body.attack
};

enemies.push(newEnemy);
console.log(enemies);
res.send(enemies);
});

app.listen(3000, () => console.log('started and listening.')); 
```

æ‰“å¼€ç»ˆç«¯ï¼Œå¯åŠ¨èŠ‚ç‚¹ï¼Œè®¿é—® unity å®¢æˆ·ç«¯ã€‚

```
node app.js 
```

è®©æˆ‘ä»¬è¿›è¡Œä¸€ä¸ª api è°ƒç”¨ï¼Œæˆ‘å°†ä½¿ç”¨ postmanã€‚

[![Alt Text](img/2f59664fed2ea05276babb9929245cbb.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--m6kS4zRB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/4s05xp31h5lltieosq5m.png)

ä¸è¦å¿˜è®°å°†æ ‡é¢˜å’Œæ­£æ–‡è®¾ç½®ä¸º`application/json`ã€‚

ç°åœ¨æ ¹æ®æ•Œæ–¹æ¨¡å¼åˆ›å»ºä¸€ä¸ªæ•Œæ–¹ json å­—ç¬¦ä¸²ï¼Œç‚¹å‡»å‘é€ã€‚

[![Alt Text](img/78d55cadc351db287631115bef43ff6a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--3KSP3t_h--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/zsar1id2q4e7282jils8.png)

[![Alt Text](img/bf6d81b803ccb9a31b5fc659a861907c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--GT532m3s--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/sphg3g6131k8cisxh00i.png)

çœ‹æ¥æˆ‘ä»¬çš„æ•Œäººè¶Šæ¥è¶Šå¤šäº†:)

æœ€åä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬æˆåŠŸåœ°æ¥æ”¶äº†ä¸€ä¸ª json å¯¹è±¡ï¼Œå¹¶ç”¨ unity ui å…ƒç´ å°†å®ƒæ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚ä½†æ˜¯æˆ‘ä»¬ç»“æ„çš„è¿™ä¸€éƒ¨åˆ†å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ã€‚æˆ‘ç»™æ•Œäººæ·»åŠ äº†`id`å±æ€§ï¼Œç°åœ¨æˆ‘çš„å›åº”ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡è€Œæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚

é¦–å…ˆï¼Œåœ¨ unity ä¸­å°†`id`å±æ€§æ·»åŠ åˆ°`Enemy`ç±»ä¸­ã€‚

```
public class Enemy
{
    public int id;
    public string name;
    public int health;
    public int attack;
} 
```

æ˜¯å•Šï¼Œé‚£å¾ˆå®¹æ˜“ï¼ä½†æ˜¯è¯·è®°ä½ï¼Œ`JsonUtility`ä¸èƒ½ä¸`{get; set;}`ä¸€èµ·å·¥ä½œã€‚

ç°åœ¨é‡è¦çš„éƒ¨åˆ†ï¼å¦‚æœæ‚¨çš„ä»»åŠ¡æ˜¯å‘é€ä¸€ä¸ª json æ•°ç»„å¹¶åœ¨ unity ä¸­è§£æï¼Œä¸å¹¸çš„æ˜¯æ²¡æœ‰ç°æˆçš„è§£å†³æ–¹æ¡ˆã€‚åˆ«æ‹…å¿ƒï¼Œç»è¿‡å‡ æ¬¡æœç´¢å’Œè¯•éªŒï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªå˜é€šåŠæ³•ï¼Œè¯¦ç»†çš„è§£é‡Šï¼Œè¯·çœ‹è¿™é‡Œçš„å’Œè¿™é‡Œçš„ã€‚

æ¯”å¦‚ä½ çš„å›åº”æ˜¯è¿™æ ·çš„ï¼Œé‚£ä¹ˆ`JsonUtility`å°±ä¸è¡Œ:

```
[  {  //item  },  {  //item  },  {  //item  }  ] 
```

ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿å®ƒæˆä¸ºä¸€ä¸ªå•é”®å’Œä¸€ä¸ªæ•°ç»„å¯¹è±¡ä½œä¸ºä¸€ä¸ªå€¼:

```
{  "result":  [{//item},{//item},{//item}]  } 
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªåŒ…å«**é¡¹**çš„**ä¸€ä¸ªåˆ—è¡¨**ï¼Œè¿™ä¸ªç»“æ„ä¸`JsonUtility`ä¸€èµ·å·¥ä½œã€‚

ä¸ºäº†å®ç°è¿™ä¸ªæŠ€å·§ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º`JsonHelper`çš„é™æ€ç±»ã€‚è®©æˆ‘ä»¬åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­åˆ›å»ºå®ƒã€‚

```
using UnityEngine;
using System.Collections.Generic;

public static class JsonHelper
{
    public static List<T> FromJson<T>(string json)
    {
        Wrapper<T> wrapper = JsonUtility.FromJson<Wrapper<T>>(json);
        return wrapper.result;
    }

    [System.Serializable]
    private class Wrapper<T>
    {
        public List<T> result;
    }
} 
```

`JsonHelper`ç±»æœ‰ä¸€ä¸ªé€šç”¨çš„`FromJson`æ–¹æ³•ï¼Œå®ƒè¿”å›æˆ‘ä»¬è¦åˆ›å»ºçš„ä»»ä½•ç±»çš„åˆ—è¡¨ã€‚è¿™é‡Œçš„å…³é”®éƒ¨åˆ†æ˜¯`Wrapper`ç±»ï¼Œå®ƒæœ‰ä¸€ä¸ªç»“æœåˆ—è¡¨ï¼Œå­˜å‚¨æ¥è‡ªã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå½“æˆ‘ä»¬ä»æœåŠ¡å™¨è·å¾—ä¸€ä¸ª json å¯¹è±¡æ•°ç»„æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»åƒè¿™æ ·ä¿®æ”¹æˆ‘ä»¬çš„å“åº”å­—ç¬¦ä¸²:

```
{
    "result": [
        //enemy,
        //enemy
    ]
} 
```

æˆ‘ä»¬å·²ç»è®¨è®ºäº†æˆ‘ä»¬çš„æ¨¡å¼ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªåŠ©æ‰‹ç±»æ¥ä½¿å®ƒå·¥ä½œï¼Œè®©æˆ‘ä»¬å†™ä¸€äº›ä»£ç å§ï¼

é¦–å…ˆï¼Œå°†`Enemy`ç±»æ ‡è®°ä¸º`Serializable`ï¼Œè¿™æ · unity å°†èƒ½å¤Ÿè½¬æ¢ä¸º jsonã€‚æ›´å¤šè§£é‡Š[æ­¤å¤„](https://forum.unity.com/threads/terminology-what-does-serializable-mean-in-unity-terms.546241/)ã€‚

```
[System.Serializable]
public class Enemy
{
    public int id;
    public string name;
    public int health;
    public int attack;
} 
```

ç¬¬äºŒï¼Œæ‰“å¼€`ClientApi`è„šæœ¬ï¼Œåšä¸€ä¸ª post æ–¹æ³•ã€‚unity çš„ post æ–¹æ³•éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œpost url å’Œä¸€ä¸ªæ•Œäººå¯¹è±¡ã€‚

```
public IEnumerator Post(string url, Enemy enemy)
{
  var jsonData = JsonUtility.ToJson(enemy);
  Debug.Log(jsonData);

  using(UnityWebRequest www = UnityWebRequest.Post(url, jsonData))
  {

  }
} 
```

æˆ‘ä»¬ç”¨`JsonUtility`å°†ä¸€ä¸ª`Enemy`å¯¹è±¡è½¬æ¢æˆä¸€ä¸ª json å­—ç¬¦ä¸²ã€‚

æ¥ä¸‹æ¥ï¼Œé…ç½®æˆ‘ä»¬è¯·æ±‚çš„`content-type`ã€‚

```
public IEnumerator Post(string url, Enemy enemy)
{
  var jsonData = JsonUtility.ToJson(enemy);
  Debug.Log(jsonData);

  using(UnityWebRequest www = UnityWebRequest.Post(url, jsonData))
  {
        www.SetRequestHeader("content-type", "application/json");
    www.uploadHandler.contentType = "application/json";
    www.uploadHandler = new UploadHandlerRaw(System.Text.Encoding.UTF8.GetBytes(jsonData));

    yield return www.SendWebRequest();
  }
} 
```

æˆ‘ä»¬å·²ç»å°†æ–¹æ³•è®¾ç½®ä¸ºå‘é€ä¸€ä¸ª json å¯¹è±¡å’Œä¸€ä¸ª url ç«¯ç‚¹ã€‚

è®°ä½ï¼Œæˆ‘ä»¬åœ¨æ¥åˆ°è¯·æ±‚åä¼šæŠŠæ•Œäººé€å›å»ä½œä¸ºå›åº”ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬æ ¹æ®å“åº”åˆ—å‡ºä¸€ä¸ªåˆ—è¡¨ï¼Œç„¶åæ˜¾ç¤ºåˆ°æ§åˆ¶å°ã€‚ç°åœ¨ï¼Œæ˜¯å¤„ç†å“åº”ç»“æŸé”™è¯¯çš„æ—¶å€™äº†ã€‚

```
// handle the result
var result = System.Text.Encoding.UTF8.GetString(www.downloadHandler.data);  
result = "{\"result\":" + result + "}"; 
var resultEnemyList = JsonHelper.FromJson<Enemy>(result);

foreach (var item in resultEnemyList)
{
  Debug.Log(item.name);
} 
```

è¿™æ˜¯æˆ‘ä»¬ä¸Šé¢è®¨è®ºè¿‡çš„éƒ¨åˆ†ã€‚æˆ‘ä¸€å¾—åˆ°æ•°æ®ï¼Œå°±ä¿®æ”¹å®ƒï¼Œä»¥ä¾¿èƒ½å¤Ÿä¸`JsonHelper`ä¸€èµ·å·¥ä½œã€‚

ç„¶ååªæ˜¾ç¤ºæ§åˆ¶å°æ¯ä¸ªå…ƒç´ çš„`name`è¿›è¡Œæµ‹è¯•ã€‚

```
public IEnumerator Post(string url, Enemy enemy)
{
  var jsonData = JsonUtility.ToJson(enemy);
  Debug.Log(jsonData);

  using(UnityWebRequest www = UnityWebRequest.Post(url, jsonData))
  {
        www.SetRequestHeader("content-type", "application/json");
    www.uploadHandler.contentType = "application/json";
    www.uploadHandler = new UploadHandlerRaw(System.Text.Encoding.UTF8.GetBytes(jsonData));
    yield return www.SendWebRequest();

    if (www.isNetworkError)
    {
      Debug.Log(www.error);
    }
    else
    {
      if (www.isDone)
      {
        // handle the result
        var result = System.Text.Encoding.UTF8.GetString(www.downloadHandler.data);  
        result = "{\"result\":" + result + "}"; 
        var resultEnemyList = JsonHelper.FromJson<Enemy>(result);

        foreach (var item in resultEnemyList)
        {
          Debug.Log(item.name);
        }
      }
      else
      {
        //handle the problem
        Debug.Log("Error! data couldn't get.");
      }
    }
  }
} 
```

ä¸ºäº†æµ‹è¯•ï¼Œä¸º post url å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ï¼Œåœ¨`Start`ä¸­åˆ›å»ºä¸€ä¸ª`Enemy`å¯¹è±¡ï¼Œç„¶ååˆ‡æ¢å› unityã€‚

```
public string getUrl  = "localhost:3000/enemy";
public string postUrl = "localhost:3000/enemy/create";

void Start()
{
  var enemy = new Enemy(){
    id = 100,
    name = "Balrog",
    health = 1000,
    attack = 2500
  };

  StartCoroutine(Post(postUrl, enemy));
} 
```

è¯¥ä¸Šåœºäº†ï¼

[![Alt Text](img/111ac328cda728df9614344919085c0b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--M8MNr8RY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/tk9jj9splrphzq80hec7.png)

ä¹Ÿåœ¨ç»ˆç«¯ä¸Šæ£€æŸ¥ console.logã€‚

[![Alt Text](img/3a736724e99e1a45f0c66ab25e95e9c3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ZDeHhCSi--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/fqeusdv13gycruwvhel1.png)

å¹²å¾—å¥½ï¼Œæˆ‘ä»¬çš„å›¢ç»“å¿è€…æŠ€èƒ½æé«˜äº†ä¸€ç‚¹ç‚¹ï¼ï¼ğŸ‰ğŸ‰ğŸ‰ğŸŒŸğŸŒŸğŸŒŸğŸ‘ğŸ‘ğŸ‘ğŸ˜ğŸ˜

çœ‹èµ·æ¥æˆ‘ä»¬å·²ç»æˆåŠŸåœ°ä» unity å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®ï¼Œå¹¶ç”¨æ›´æ–°çš„æ•°æ®è¿›è¡Œå“åº”ğŸ˜ğŸ‘¾

æŠ¢ä»£ç [è¿™é‡Œ](https://github.com/cemuka/unity-node-tutorial)

ä¸‹ä¸€éƒ¨åˆ†æˆ‘ä»¬å°†åœ¨ ui å…ƒç´ çš„å¸®åŠ©ä¸‹å‘å¸ƒï¼Œä¸ºäº†åœ¨ unity ä¸­å¤„ç†æ•°æ®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¯è„šæœ¬åŒ–çš„å¯¹è±¡ã€‚

ç›´åˆ°ä¸‹ä¸€éƒ¨åˆ†ï¼Œå¹²æ¯ï¼