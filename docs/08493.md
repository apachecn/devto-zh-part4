# å®¢æˆ·ç«¯ Git æŒ‚é’©ç®€ä»‹

> åŸæ–‡ï¼š<https://dev.to/robotsquidward/intro-to-client-side-git-hooks-24mn>

å½“æ¶‰åŠåˆ°éƒ¨ç½²ä»£ç çš„è¿‡ç¨‹æ—¶ï¼Œè‡ªåŠ¨åŒ–å°±æ˜¯ä¸€åˆ‡ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå³ä½¿æ˜¯æœ€å°çš„æ”¹è¿›ä¹Ÿä¼šå¯¹æ‚¨åœ¨æ„å»ºå’Œå‘å¸ƒè½¯ä»¶æ—¶ä¸å¾—ä¸å¿å—çš„æ‰‹å·¥è¿‡ç¨‹äº§ç”Ÿå·¨å¤§çš„å½±å“ã€‚

åœ¨ç¼–å†™ã€æ„å»ºå’Œéƒ¨ç½²ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥æ³¨å…¥è‡ªåŠ¨åŒ–ã€‚å½“åœ¨å›¢é˜Ÿä¸­å’Œè¶Šæ¥è¶Šå¤§çš„é¡¹ç›®ä¸­ç¼–å†™ä»£ç æ—¶ï¼Œè¿™äº›æŒ‘æˆ˜å’Œæœºä¼šåªä¼šå¢åŠ ã€‚åƒæ—æŒºã€è‡ªåŠ¨åŒ–æµ‹è¯•å’Œ GitHub æ£€æŸ¥è¿™æ ·çš„ä¸œè¥¿å¯ä»¥å¸®åŠ©ä½ åœ¨æ¨é€ã€å®¡æŸ¥ã€åˆå¹¶å’Œäº¤ä»˜ä»£ç æ—¶å‡å°‘[è¾›åŠ³](https://landing.google.com/sre/sre-book/chapters/eliminating-toil/)ã€‚

[![Screen Shot 2019-08-12 at 10 20 40 AM](img/47fd824faa728a4bab67dcf3819a7540.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--j_vZu26I--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/10855762/62872161-e1500e00-bcea-11e9-8490-0533a31fc589.png)

è¿™äº›é—®é¢˜æœ‰è®¸å¤šè§£å†³æ–¹æ¡ˆï¼Œå¤§å¤šæ•°éƒ½é›†ä¸­åœ¨éƒ¨ç½²ä»£ç æ—¶æœ€æ˜ç¡®çš„æŠŠå…³è€…â€”â€”æ„å»ºæ­¥éª¤ã€‚æ‚¨çš„æ„å»ºåº”è¯¥èƒ½å¤Ÿåœ¨æ²¡æœ‰äººå·¥å¹²é¢„çš„æƒ…å†µä¸‹è‡ªåŠ¨æ£€æµ‹é—®é¢˜ã€‚åœ¨å°†ä»£ç æŠ•å…¥ç”Ÿäº§ä¹‹å‰ï¼Œä»ä»£ç é£æ ¼åˆ°æ€§èƒ½åˆ°æœåŠ¡å™¨å¥åº·çŠ¶å†µçš„ä¸€åˆ‡éƒ½å¯ä»¥åœ¨æ„å»ºä¸­è¿›è¡Œæµ‹è¯•å’Œè®¤è¯ã€‚æ„å»ºä¼šå¼ºåˆ¶æ‰§è¡Œæ‚¨çš„è§„åˆ™ï¼Œå¹¶è®©å¼€å‘äººå‘˜ä¿æŒè¯šå®ï¼Œè¿™æ˜¯äººå·¥å¹²é¢„æ°¸è¿œæ— æ³•åšåˆ°çš„ã€‚

ç„¶è€Œï¼Œå½“æ¨è¿›åˆ°é¢„æ„å»ºè¿‡ç¨‹æ—¶ï¼Œæœ‰ä¸€äº›æ£€æŸ¥å¯ä»¥èŠ‚çœæ›´å¤šçš„æ—¶é—´ã€‚

ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯å¼€å‘äººå‘˜æäº¤å’Œæ¨é€ç³Ÿç³•çš„ä»£ç ã€‚ä¸æ˜¯*åˆå¹¶*ç³Ÿç³•çš„ä»£ç ï¼Œè€Œæ˜¯ç®€å•åœ°ç¼–å†™ç³Ÿç³•çš„ä»£ç ï¼Œå¹¶å°†å…¶æäº¤åˆ°å®ƒä»¬è‡ªå·±çš„ç‰¹æ€§åˆ†æ”¯ä¸­çš„æºä»£ç æ§åˆ¶ã€‚è¿™å¯èƒ½çœ‹èµ·æ¥ä¸æ˜¯ä¸€ä¸ªå¤§é—®é¢˜â€”â€”æ¯•ç«Ÿæ‰€æœ‰å—ä¿æŠ¤çš„åˆ†æ”¯æ„å‘³ç€æ‚¨å¯ä»¥åœ¨æ‰¹å‡†åˆå¹¶ä¹‹å‰é€šè¿‡æ„å»ºæ£€æŸ¥æ¥å¼ºåˆ¶æ‰§è¡Œæ­£ç¡®æ€§â€”â€”ä½†æ˜¯å®ƒå¯èƒ½ä¼šå¼•å…¥æ‰‹åŠ¨å·¥ä½œå¹¶ç»™å¼€å‘äººå‘˜å¸¦æ¥æŒ«æŠ˜ï¼Œè¿™ä¸¤è€…éƒ½å¯ä»¥é€šè¿‡å®¢æˆ·ç«¯ git ä¿æŠ¤è½»æ¾é¿å…ã€‚

## å¼•å…¥ Git æŒ‚é’©

[Git æŒ‚é’©](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks)æ˜¯åœ¨è¿è¡ŒæŸäº› Git å‘½ä»¤æ—¶è¿è¡Œè„šæœ¬çš„ä¸€ç§æ–¹å¼ã€‚å®¢æˆ·ç«¯ Git æµç¨‹å’ŒæœåŠ¡å™¨ç«¯æµç¨‹ä¸Šéƒ½æœ‰æŒ‚é’©ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å¯¹ Git å·¥ä½œæµä¸­çš„å˜åŒ–åšå‡ºååº”ã€‚æˆ‘ä»¬å°†å…³æ³¨å®¢æˆ·ç«¯é’©å­ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨å®Œæˆæäº¤ä¹‹å‰ä¿æŠ¤è‡ªå·±ã€‚

### å®¢æˆ·ç«¯ Git æŒ‚é’©

å®¢æˆ·ç«¯é’©å­åŒ…æ‹¬å¤šä¸ª Git è¿›ç¨‹çš„é’©å­ï¼ŒåŒ…æ‹¬æäº¤ã€ç”µå­é‚®ä»¶å·¥ä½œæµå’Œå…¶ä»–è¿›ç¨‹ï¼Œå¦‚`checkout`å’Œ`merge`ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨æäº¤å·¥ä½œæµ*(ä½†æ˜¯[çœ‹çœ‹åˆ—è¡¨çš„å…¶ä½™éƒ¨åˆ†](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks)ï¼Œä½ å¯ä»¥åšçš„è¿˜æœ‰å¾ˆå¤šï¼)*ã€‚

*   `pre-commit` -ç”šè‡³åœ¨æäº¤æ¶ˆæ¯ç”Ÿæˆä¹‹å‰åœ¨`git commit`è¿è¡Œ
*   `prepare-commit-msg` -åœ¨æäº¤æ¶ˆæ¯ç¼–è¾‘å™¨æ‰“å¼€ä¹‹å‰ä½†åœ¨ç”Ÿæˆé»˜è®¤æ¶ˆæ¯ä¹‹åè¿è¡Œ
*   `commit-msg` -åœ¨æ¶ˆæ¯åˆ›å»ºåè¿è¡Œï¼Œä»¥éªŒè¯åŒ…å«æäº¤æ¶ˆæ¯çš„ä¸´æ—¶æ–‡ä»¶

è¿™äº›å®¢æˆ·ç«¯`commit`æŒ‚é’©å®é™…ä¸Šåˆ†ä¸ºä¸¤ç±»:

1.  æ‚¨æäº¤çš„ä»£ç 
2.  æ ¼å¼åŒ–/å®æ–½æ­£ç¡®çš„æäº¤æ¶ˆæ¯

æˆ‘ä»¬å°†ä»ç¬¬ä¸€ç±»å¼€å§‹ï¼Œåœ¨æˆ‘ä»¬è€ƒè™‘ç”¨æ¶ˆæ¯å®Œæˆæäº¤ä¹‹å‰ï¼Œä½¿ç”¨`pre-commit`æ¥åˆ†ææˆ‘ä»¬å°†è¦æäº¤çš„ä»£ç ã€‚

### å†™ä¸€ä¸ªé¥­æ¡¶`pre-commit`æŒ‚é’©

é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨å­˜å‚¨åº“ä¸­ä¸ºé’©å­æŒ‡å®šä¸€ä¸ªä½ç½®ã€‚å¯¹äºæˆ‘ä»¬çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨æˆ‘ä»¬çš„å­˜å‚¨åº“çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`.githooks`çš„ç›®å½•:

```
mkdir .githooks
cd .githooks
touch areYouSure.sh 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨ä½ æœ€å–œæ¬¢çš„ç¼–è¾‘å™¨ä¸­æ‰“å¼€`areYouSure.sh`ã€‚ç¼–å†™ä¸€ä¸ªé’©å­æ—¢æå…¶ç®€å•ï¼Œåˆå…·æœ‰æå¤§çš„å¼€æ”¾æ€§ã€‚æ‚¨åªéœ€è¦ä¸€ä¸ªè¿”å›é€€å‡ºä»£ç çš„è„šæœ¬ï¼Œ0 è¡¨ç¤ºæˆåŠŸï¼Œé 0 è¡¨ç¤ºå¤±è´¥ã€‚ä»»ä½•ä¸ä¸º 0 çš„å€¼éƒ½ä¼šå®Œå…¨ä¸­æ­¢æäº¤ã€‚

è®©æˆ‘ä»¬å†™ä¸€ä¸ªéå¸¸ç®€å•çš„è„šæœ¬ï¼Œè¯¢é—®æˆ‘ä»¬çš„å¼€å‘äººå‘˜ä»–ä»¬æ˜¯å¦ç¡®å®šè¦æäº¤ã€‚

```
#!/usr/bin/env bash

# Check that we want to commit.

read -p "Are you sure you want to commit this (y/n)? " answer
case ${answer:0:1} in y|Y )
        exit 0 # If yes, success!
    ;;
    * )
        exit 1 # If no, sorry yo.
    ;;
esac 
```

Enter fullscreen mode Exit fullscreen mode

æœ€åï¼Œé€šè¿‡è¿è¡Œ
ç¡®ä¿è¿™ä¸ªæ–°æ–‡ä»¶æ˜¯å¯æ‰§è¡Œçš„

```
chmod +x .githooks/areYouSure.sh 
```

Enter fullscreen mode Exit fullscreen mode

ç°åœ¨è®©æˆ‘ä»¬å¼„æ¸…æ¥šå¦‚ä½•è®© Git ä½œä¸º`pre-commit`é’©å­çš„ä¸€éƒ¨åˆ†è‡ªåŠ¨è¿è¡Œè¿™ä¸ªè„šæœ¬ã€‚

### æ·»åŠ è‡ªå®šä¹‰`pre-commit`æ­¥éª¤

åœ¨æˆ‘ä»¬çš„`.githooks`ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„è„šæœ¬ï¼Œç”¨è¿™äº›å‘½ä»¤æ¥å¤„ç†æˆ‘ä»¬çš„è‡ªå®šä¹‰`pre-commit`åŠ¨ä½œ:

```
cd .githooks
touch pre-commit 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨æ‚¨å–œæ¬¢çš„ç¼–è¾‘å™¨ä¸­æ‰“å¼€æ–°çš„`pre-commit`æ–‡ä»¶ã€‚è®©æˆ‘ä»¬æ›´æ–°å®ƒæ¥åšæˆ‘ä»¬éœ€è¦çš„åŸºæœ¬äº‹æƒ…ã€‚

```
#!/bin/sh

# Specify the directory for the hooks.
# We'll use the current one (.githooks)
hookDir=$(dirname $0)

# Specify the hooks you want to run during
# the pre-commit process:
"$hookDir/areYouSure.sh"
# && "hookDir/add-your-own-scripts-here" 
```

Enter fullscreen mode Exit fullscreen mode

è¿™ä¸ªè„šæœ¬å°†æŒ‡å®šæˆ‘ä»¬å­˜å‚¨é’©å­çš„ç›®å½•(å½“å‰çš„`.githooks`ç›®å½•)ï¼Œç„¶åå®ƒå°†æŒ‡å®šåº”è¯¥ä½œä¸º`pre-commit`çš„ä¸€éƒ¨åˆ†è¿è¡Œçš„è„šæœ¬ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ª`areYouSure.sh`è„šæœ¬ã€‚

> ä½ å¯ä»¥å°†ä½ çš„è„šæœ¬ä»£ç ç›´æ¥ç¼–ç åˆ°`pre-commit`ä¸­ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†è¿™æ®µä»£ç æŠ½è±¡æˆå®ƒè‡ªå·±çš„è„šæœ¬ï¼Œä»¥å¢å¼ºå¯è¯»æ€§ã€å¯é‡ç”¨æ€§ï¼Œå¹¶ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨å°†æ¥è½»æ¾åœ°å‘æˆ‘ä»¬çš„`pre-commit`æ­¥éª¤æ·»åŠ æ›´å¤šè„šæœ¬ã€‚

æœ€åï¼Œé€šè¿‡è¿è¡Œ
ç¡®ä¿è¿™ä¸ªæ–°æ–‡ä»¶æ˜¯å¯æ‰§è¡Œçš„

```
chmod +x .githooks/pre-commit 
```

Enter fullscreen mode Exit fullscreen mode

### å‘Šè¯‰ Git ä½¿ç”¨æˆ‘ä»¬çš„å®šåˆ¶é’©å­

å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œæ‚¨åº”è¯¥æœ‰ä¸€ä¸ªæ–°çš„`.githooks`ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†`pre-commit`è„šæœ¬å’Œæˆ‘ä»¬æ–°çš„å®šåˆ¶è„šæœ¬`areYouSure.sh`ã€‚æˆ‘ä»¬å¯ä»¥ç»§ç»­å°†è¿™äº›æ–‡ä»¶æäº¤ç»™æºä»£ç ç®¡ç†ã€‚å¦‚æœæ‚¨ç°åœ¨è¿™æ ·åšï¼Œæ‚¨ä¼šæ³¨æ„åˆ°ï¼Œæ‚¨ä¸ä¼šåœ¨å‘½ä»¤è¡Œä¸­çœ‹åˆ°æˆ‘ä»¬çš„â€œæ‚¨ç¡®å®šå—â€å¼¹å‡ºçª—å£ã€‚

æˆ‘ä»¬çš„é’©å­æ²¡æœ‰è¿è¡Œçš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦é…ç½® Gitï¼Œè®©å®ƒçŸ¥é“æˆ‘ä»¬ä¸ºè¿™ä¸ªå­˜å‚¨åº“çš„`pre-commit`æ‰¾åˆ°äº†ä¸€ä¸ªæ–°ä½ç½®ã€‚ä¸ºæ­¤ï¼Œåœ¨ repo çš„æ ¹ç›®å½•ä¸‹è¿è¡Œè¿™ä¸ªå‘½ä»¤:

```
git config core.hooksPath .githooks 
```

Enter fullscreen mode Exit fullscreen mode

è¿™å‘Šè¯‰ Git å°†è¿™ä¸ª repo çš„é’©å­è·¯å¾„é…ç½®åˆ°æˆ‘ä»¬å®šåˆ¶çš„`.githooks`ç›®å½•ã€‚ç°åœ¨ï¼Œæ¯å½“ git è¿è¡Œ`pre-commit`æ­¥éª¤æ—¶ï¼Œå®ƒéƒ½ä¼šéµä»æˆ‘ä»¬è‡ªå·±çš„`pre-commit`è„šæœ¬ä¸­çš„è‡ªå®šä¹‰æ“ä½œã€‚

ç°åœ¨ï¼Œå½“æ‚¨å¼€å§‹ä¸€ä¸ªæ–°çš„`git commit`æ—¶ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æˆ‘ä»¬çš„`areYouSure.sh`æç¤ºã€‚ä¸€ä¸ª`Yes`ç­”æ¡ˆåº”è¯¥ç»§ç»­ä½ çš„æäº¤(ç»§ç»­æäº¤æ¶ˆæ¯æ­¥éª¤),è€Œä¸€ä¸ª`No`ç­”æ¡ˆåº”è¯¥ä¸­æ­¢ä½ çš„æäº¤ã€‚

### ä¸‹ä¸€æ­¥

æ­å–œä½ ã€‚ğŸ‰æ‚¨å·²ç»æˆåŠŸåœ°åœ¨å­˜å‚¨åº“ä¸­ç¼–å†™å¹¶é…ç½®äº†ä¸€ä¸ªå®šåˆ¶çš„`pre-commit`é’©å­ï¼

ç°åœ¨ï¼Œæ‚¨å¯ä»¥ç»§ç»­æ”¹è¿›æ‚¨çš„`pre-commit`å·¥ä½œæµï¼Œåªéœ€å‘`.githooks`æ·»åŠ æ–°çš„è„šæœ¬ï¼Œå¹¶åœ¨æ‚¨çš„å®šåˆ¶`pre-commit`è„šæœ¬ä¸­æŒ‡å®šæ‚¨æƒ³è¦è¿è¡Œçš„é’©å­ã€‚

ä¸€äº›æœ‰åŠ©äºç»§ç»­ Git æŒ‚é’©ä¹‹æ—…çš„èµ„æº:

*   [GitHooks.com](https://githooks.com)
*   [é¢„æäº¤](https://pre-commit.com)â€”â€”ä¸€ä¸ªä»è¿œç¨‹å›è´­ä¸­æå–å®šåˆ¶`pre-commit`è„šæœ¬çš„æ¡†æ¶
*   äº†è§£ç”¨äºæ‰§è¡Œç­–ç•¥çš„æœåŠ¡å™¨ç«¯ git æŒ‚é’©å’Œä¸€äº›å…¥é—¨çš„æœåŠ¡å™¨ç«¯è„šæœ¬

æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼Œå¦‚æœæ‚¨å¯¹`pre-commit` hooks æœ‰ä»»ä½•é—®é¢˜æˆ–æƒ³æ³•ï¼Œæˆ–è€…æƒ³åˆ†äº«æ‚¨ç”¨ git automation å®Œæˆçš„ä»¤äººæƒŠå¹çš„ä¸œè¥¿â€”â€”è¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ï¼

> *æˆ‘æœ€åˆåœ¨ AJ.dev ä¸Šå‘è¡¨äº†è¿™ç¯‡æ–‡ç« ï¼Œ[åœ¨é‚£é‡Œè¯»åˆ°çš„](https://ajkueterman.dev/posts/intro-to-custom-client-git-hooks-pre-commit/)ã€‚*