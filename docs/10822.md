# Kentico CMS å¿«é€Ÿæç¤º:é›†æˆæµ‹è¯•è§’è‰²

> åŸæ–‡ï¼š<https://dev.to/wiredviews/kentico-cms-quick-tip-integration-testing-roles-h6i>

<figure>

[![](img/2ed2c3f4d0a6ca1186cb19f0268e1403.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--0AOWvA2r--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/3m03fz5cuocblxc2hpu6.jpg)

<figcaption>Photo by [Jase Bloor](https://unsplash.com/@jasebloor) on [Unsplash](https://unsplash.com)</figcaption>

</figure>

## äº†è§£è‡ªå·±çš„è§’è‰²ï¼ğŸ§

å½“å›é¡¾æˆ‘ä»¬çš„ Kentico 12 MVC åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰ä¸€äº›ç±»ä¼¼å¦‚ä¸‹çš„ä»£ç è¡Œ:

```
int userId = ...

if (userManager.IsInRole(userId, "Manager"))
{
    IEnumerable<string> protectedData = GetTheData();

    return protectedData;
}
else
{
    return Enumerable.Empty<string>();
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†ä½¿ä»£ç æ­£ç¡®è¿è¡Œï¼Œå½“æ‚¨çš„ç«™ç‚¹è¿è¡Œæ—¶ï¼Œ`"Manager"`è§’è‰²å¿…é¡»å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œå¹¶è¢«åˆ†é…ç»™æ­£ç¡®çš„ç”¨æˆ·ã€‚

æˆ‘ä»¬æ€ä¹ˆçŸ¥é“ï¼Œåœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´ï¼Œè¿™æ˜¯çœŸçš„ï¼ŸğŸ˜•

å½“æˆ‘ä»¬å¯¹ä»£ç æˆ–æ•°æ®åº“ä¸­çš„è§’è‰²è¿›è¡Œæ›´æ”¹(æ·»åŠ ã€åˆ é™¤æˆ–é‡å‘½å)æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼ŸğŸ˜Ÿ

æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥è½»æ¾åœ°éªŒè¯æˆ‘ä»¬ä»£ç ä¸­çš„æ‰€æœ‰è§’è‰²éƒ½ä¸ CMS ä¸­å®šä¹‰çš„è§’è‰²ç›¸åŒ¹é…ï¼Ÿ

## é¿æ•£å¼¦

æˆ‘çš„ç¬¬ä¸€ä¸ªå»ºè®®æ˜¯é¿å…ä½¿ç”¨â€œåˆ†æ•£çš„å­—ç¬¦ä¸²â€ã€‚

åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­æœ‰å¤šå°‘è¿™æ ·çš„è¡Œï¼Ÿ

```
if (userManager.IsInRole(userId, "Manager")) { ... } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
userManager.AddToRole(userId, "SpecialUser")); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
userManager.RemoveFromRole(userId, "Admin")); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™äº›è§’è‰²åç§°ä¼šå¾ˆå¿«åˆ†æ•£åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™ä½¿å¾—å®ƒä»¬å¾ˆéš¾è·Ÿè¸ªå’Œæ›´æ–°ã€‚é”™åˆ«å­—å¾ˆå®¹æ˜“è¢«é—æ¼ï¼Œå³ä½¿æ˜¯ä»£ç å®¡æŸ¥ã€‚ğŸ˜£

è¿™äº›ä¸æ˜¯[ç¥å¥‡çš„å­—ç¬¦ä¸²](https://en.wikipedia.org/wiki/Magic_string),å› ä¸ºå®ƒä»¬çš„ç›®çš„å¾ˆæ˜ç¡®â€”â€”ä½†è¿™æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ— æ³•å¸®åŠ©æˆ‘ä»¬çš„å€¼ï¼Œå› ä¸º`string`å€¼æ²¡æœ‰å•†ä¸šæ„ä¹‰ã€‚

å°±ç¼–è¯‘å™¨è€Œè¨€ï¼Œè¾“å…¥é”™è¯¯çš„`string`ä¸å…·æœ‰æ­£ç¡®å€¼çš„`string`ç›¸åŒã€‚

> å¯¹äºå­˜å‚¨å…·æœ‰é‡è¦ä¸šåŠ¡æ„ä¹‰çš„å€¼ï¼ŒåŸºå…ƒç±»å‹å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚å¦‚æœä½ å‘ç°è‡ªå·±åœ¨ä»£ç åº“ä¸­é‡åˆ°åˆ†æ•£å­—ç¬¦ä¸²çš„é—®é¢˜ï¼Œä½ å¯èƒ½æœ‰ä¸€ç§[åŸå§‹ç—´è¿·](http://wiki.c2.com/?PrimitiveObsession)çš„æƒ…å†µ

æˆ‘ä»¬å¯ä»¥ç”¨åŒ…å«æˆ‘ä»¬æ‰€æœ‰è§’è‰²çš„é™æ€è§’è‰²ç±»æ¥ä»£æ›¿å®ƒä»¬ã€‚

```
public static class UserRoles
{
    public const string MANAGER = nameof(MANAGER);
    public const string SPECIAL_USER = nameof(SPECIAL_USER);
    public const string ADMIN = nameof(ADMIN);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> ä½¿ç”¨ [nameof()æ“ä½œç¬¦](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/operators/nameof)æœ‰åŠ©äºç¡®ä¿å¸¸é‡çš„åç§°å’Œå®ƒçš„å€¼æ°¸è¿œä¸ä¼šä¸åŒæ­¥ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨é€šå¸¸ä½¿ç”¨è§’è‰²åå­—ç¬¦ä¸²çš„åœ°æ–¹ä½¿ç”¨è¿™ä¸ªç±»ã€‚ğŸ˜‰

```
if (userManager.IsInRole(userId, UserRoles.MANAGER)) { ... } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡åœ¨æ·»åŠ ã€ç§»é™¤æˆ–æ›´æ–°è§’è‰²åç§°æ—¶ä¾é  C#è¯­è¨€å’Œ Visual Studio é‡æ„å·¥å…·ï¼Œé¿å…åˆ†æ•£çš„å­—ç¬¦ä¸²æœ‰åŠ©äºå‡å°‘è¾“å…¥é”™è¯¯å¹¶ä½¿æ›´æ”¹æ›´å®¹æ˜“ã€‚ğŸ˜€

ä½†æ˜¯ï¼Œè¿™å¹¶ä¸å¦¨ç¢æˆ‘ä»¬åœ¨ä»£ç ä¸­å®šä¹‰ä¸€ä¸ªæ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„è§’è‰²ã€‚ğŸ˜¯

* * *

## ç¼–å†™é›†æˆæµ‹è¯•

æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æ€»æ˜¯ç¬¦åˆæˆ‘ä»¬ä»£ç æœŸæœ›çš„æœ€å¥½æ–¹æ³•æ˜¯ç¼–å†™ï¼Œç„¶åè¿è¡Œä¸€äº›é›†æˆæµ‹è¯•ã€‚

> å¦‚æœæ‚¨ä»¥å‰æ²¡æœ‰ä¸ºæ‚¨çš„ Kentico ç«™ç‚¹ç¼–å†™è¿‡é›†æˆæµ‹è¯•ï¼Œè¯·æŸ¥çœ‹æˆ‘çš„å¸–å­â€œè®¾ç½®é›†æˆæµ‹è¯•â€:
> 
> [![seangwright](img/e9e13f3e057a4f58b01316c7a9d6eeea.png)](/seangwright) [## Kentico 12:è®¾è®¡æ¨¡å¼ç¬¬ 8 éƒ¨åˆ†â€”â€”è®¾ç½®é›†æˆæµ‹è¯•
> 
> ### Sean g . Wright 7 æœˆ 22 æ—¥ 1910 åˆ†é’Ÿé˜…è¯»
> 
> #dotnet #kentico #integrationtests #testing](/seangwright/kentico-12-design-patterns-part-8-setting-up-integration-tests-14jg)

é‚£ä¹ˆæˆ‘ä»¬çš„é›†æˆæµ‹è¯•ä¼šæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬çš„æ¯ä¸ªè§’è‰²æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶ç¡®ä¿å®ƒä¸æ˜¯`null` :

```
[TestFixture]
public class UserRolesTests : IntegrationTests
{
    private readonly int siteId = 1;

    [Test]
    public void UserRoles_Will_Be_In_The_Database()
    {    
        RoleInfo managerRole = RoleInfoProvider
            .GetRoleInfo(UserRoles.MANAGER, siteId);

        RoleInfo specialUserRole = RoleInfoProvider
            .GetRoleInfo(UserRoles.SPECIAL_USER, siteId);

        RoleInfo adminRole = RoleInfoProvider
            .GetRoleInfo(UserRoles.ADMIN, siteId);

        managerRole.Should().NotBeNull();
        specialUserRole.Should().NotBeNull();
        adminRole.Should().NotBeNull();
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> æˆ‘æ­£åœ¨ä½¿ç”¨[fluent assessments](https://fluentassertions.com/)æ¥è®©æˆ‘è®¿é—®è¡Œä¸ºé©±åŠ¨è®¾è®¡(BDD)é£æ ¼çš„`.Should()`æ‰©å±•æ–¹æ³•ã€‚

è¿™å¾ˆç®¡ç”¨ï¼ğŸ‘

å¦‚æœæˆ‘ä»¬æŸ¥è¯¢çš„ä»»ä½•è§’è‰²åœ¨æ•°æ®åº“ä¸­ç¼ºå¤±ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„é›†æˆæµ‹è¯•å°†ä¼šå¤±è´¥ã€‚ğŸ‘

ç„¶è€Œï¼Œåœ¨ä¸Šé¢çš„æµ‹è¯•ä¸­ï¼Œä¼¼ä¹å¾ˆå®¹æ˜“é—æ¼ä¸€ä¸ªè§’è‰²ï¼Œç‰¹åˆ«æ˜¯å½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­æœ‰å¤§é‡çš„è§’è‰²æ—¶ã€‚ğŸ’£

é‚£ä¸ªè§’è‰²æŸ¥è¯¢å’Œæ–­è¨€çœ‹èµ·æ¥ä¹Ÿåœ¨ä¸€éåˆä¸€éåœ°åšç€åŒæ ·çš„äº‹æƒ…ã€‚

æˆ‘ä»¬å†è¯•ä¸€æ¬¡:

```
[TestFixture]
public class UserRolesTests : IntegrationTests
{
    private readonly int siteId = 1;

    [Test]
    public void UserRoles_Will_Be_In_The_Database()
    {
        List<string> appRoleNames = typeof(UserRoles)
            .GetFields(BindingFlags.Public | BindingFlags.Static)
            .Select(f => f.Name)
            .ToList();

        List<string> roleNames = RoleInfoProvider.GetRoles()
            .WhereEquals(nameof(RoleInfo.SiteID), siteId)
            .WhereIn(nameof(RoleInfo.RoleName), userRoleNames)
            .Column(nameof(RoleInfo.RoleName))
            .AsEnumerable()
            .Select(r => r.RoleName)
            .ToList();

        roleNames.Should().BeEquivalentTo(appRoleNames);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åå°„æ¥æ”¶é›†`UserRoles`ç±»çš„æ‰€æœ‰å­—æ®µåç§°ã€‚ğŸ§ 

æˆ‘ä»¬ä½¿ç”¨`RoleInfoProvider.GetRoles()`æ–¹æ³•ï¼Œç»“åˆå¼ºå¤§çš„ [ObjectQuery](https://docs.kentico.com/k12sp/custom-development/retrieving-database-data-using-objectquery-api) æ‰©å±•æ–¹æ³•ï¼Œä»æ•°æ®åº“ä¸­æ£€ç´¢ç›¸åŒçš„è§’è‰²é›†ã€‚ğŸ’ª

ç„¶åï¼Œæˆ‘ä»¬æ–­è¨€è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²é›†åˆåŒ¹é…ã€‚

ä¸é”™ï¼ğŸ‰

> æ³¨æ„æˆ‘ä»¬å¦‚ä½•åœ¨`ObjectQuery`ä¸­ä½¿ç”¨`nameof()`æ“ä½œç¬¦ã€‚æˆ‘å»ºè®®æ‚¨ä½¿ç”¨å®ƒï¼Œè€Œä¸æ˜¯é”®å…¥æ•°æ®åº“åˆ—çš„å­—ç¬¦ä¸²åç§°ï¼Œä»¥é¿å…æˆ‘ä»¬åœ¨è§’è‰²ä¸­çœ‹åˆ°çš„åˆ†æ•£å­—ç¬¦ä¸²é—®é¢˜ã€‚
> 
> ç”±äº Kentico ä¸­çš„çº¦å®šæ˜¯å°†ç±»å±æ€§åå‘½åä¸ºä¸æ•°æ®åº“åˆ—åç›¸åŒçš„åç§°ï¼Œå› æ­¤,`nameof()`æ“ä½œç¬¦æ˜¯é¿å…è¾“å…¥é”™è¯¯çš„å¥½æ–¹æ³•ã€‚ğŸ¤—

* * *

## æ€»ç»“

æ•°æ®æºå’Œåº”ç”¨ç¨‹åºä»£ç ä¹‹é—´æ€»æ˜¯ä¼šæœ‰è„±èŠ‚ã€‚æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºé€šå¸¸è¢«è®¾è®¡æˆæ— çŠ¶æ€çš„ï¼Œä»¥å…è®¸ä¼¸ç¼©ï¼Œè€Œæˆ‘ä»¬çš„æ•°æ®æºæ˜¯æˆ‘ä»¬å­˜å‚¨æ‰€æœ‰å…±äº«åº”ç”¨ç¨‹åºçŠ¶æ€çš„åœ°æ–¹ã€‚

å½“æˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­æœ‰åŸºäºè¯¥çŠ¶æ€çš„é€»è¾‘æ—¶ï¼Œæˆ‘ä»¬å°†æ¥è‡ªæ•°æ®æºçš„å€¼(å¦‚è§’è‰²å)ç¼–ç åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ã€‚

é›†æˆæµ‹è¯•æ˜¯ç¡®ä¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„æœŸæœ›ä¸æ•°æ®æºæä¾›ç»™æˆ‘ä»¬çš„ç›¸åŒ¹é…çš„ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•ã€‚ğŸ˜

æ„Ÿè°¢é˜…è¯»ï¼

* * *

å¦‚æœæ‚¨æ­£åœ¨å¯»æ‰¾æ›´å¤šçš„ Kentico å†…å®¹ï¼Œè¯·åœ¨ DEV:

## # [è‚¯è’‚ç§‘](https://dev.to/t/kentico) <button name="button" type="button" data-info="{&quot;className&quot;:&quot;Tag&quot;,&quot;style&quot;:&quot;full&quot;,&quot;id&quot;:5339,&quot;name&quot;:&quot;kentico&quot;}" class="crayons-btn follow-action-button whitespace-nowrap c-btn--secondary fs-base " aria-label="Follow tag: kentico" aria-pressed="false">è·Ÿéš</button>

æˆ–è€…æˆ‘çš„ Kentico åšå®¢ç³»åˆ—:

*   [Kentico 12:è®¾è®¡æ¨¡å¼](https://dev.to/search?q=Kentico%2012%20-%20Design%20Patterns)
*   [Kentico CMS å¿«é€Ÿæç¤º](https://dev.to/search?q=Kentico%20CMS%20Quick%20Tip)