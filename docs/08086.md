# è®©æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªè´§å¸å…‘æ¢ç¬¬ä¸€éƒ¨åˆ†

> åŸæ–‡:[https://dev . to/Marlon Anthony/let-s-build-a-currency-exchange-part-I-52g 1](https://dev.to/marlonanthony/let-s-build-a-currency-exchange-part-i-52g1)

æˆ‘å¼€å§‹è¿™ä¸ªé¡¹ç›®æœ‰ä¸¤ä¸ªç›®æ ‡:

1.  å·©å›ºæˆ‘å¯¹ GraphQL çš„ç†è§£ã€‚

2.  å­¦ä¹ å¹¶å®ç° Apollo æœåŠ¡å™¨/å®¢æˆ·ç«¯ã€‚

æˆ‘å†³å®šæ·±å…¥ç ”ç©¶ Apolloï¼Œæ›´å¥½åœ°ç†è§£å®ƒçš„ç”¨ä¾‹ï¼Œå¹¶æ‰¾å‡ºå¦‚ä½•è®©å®ƒä¸å…¶ä»–æŠ€æœ¯é…åˆå¾—æ›´å¥½ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œå­¦ä¹ ä¸€é¡¹æŠ€æœ¯çš„æœ€å¥½æ–¹æ³•æ˜¯ç”¨è¿™é¡¹æŠ€æœ¯åšç‚¹ä»€ä¹ˆâ€”â€”ç„¶åå†™ä¸‹æ¥ã€‚

æˆ‘ä»¬å°†å»ºç«‹ä¸€ä¸ªæœ‰`GraphQL`æœåŠ¡å™¨çš„è´§å¸äº¤æ˜“æ‰€ã€‚æˆ‘ä»¬å°†ä½¿ç”¨`MongoDB/Mongoose`æ¥ä¿å­˜æˆ‘ä»¬çš„æ•°æ®ã€‚æˆ‘ä»¬å°†åœ¨åç«¯å®ç°`ApolloServer`ï¼Œåœ¨å‰ç«¯å®ç°`ApolloClient`ã€‚`ApolloClient`å°†ä¸ºæˆ‘ä»¬æä¾›æˆ‘ä»¬çš„è¿œç¨‹æ•°æ®â€” `React`ï¼Œæˆ‘ä»¬çš„æœ¬åœ°çŠ¶æ€ã€‚Apollo æä¾›äº†ä¸€ä¸ªæˆ‘ä»¬å°†åœ¨å‰ç«¯ä½¿ç”¨çš„`InMemoryCache`ã€‚

æˆ‘ä»¬å°†ä» [Alpha Vantage è´¢åŠ¡ API](https://www.alphavantage.co) ä¸­æå–è´§å¸æ•°æ®ã€‚å¦‚æœæ‚¨æ­£åœ¨å¯»æ‰¾æ›´å¹¿æ³›çš„é€‰æ‹©ï¼Œ[è¿™ç¯‡è¯„è®ºæ–‡ç« ](https://medium.com/@patrick.collins_58673/stock-api-landscape-5c6e054ee631)è¿˜æ¶µç›–äº†å…¶ä»–è‚¡ç¥¨å’Œè´§å¸ API ä¾›æ‚¨è€ƒè™‘ã€‚æœ‰äº†è¿™äº›æ•°æ®ï¼Œæˆ‘ä»¬å°†å…è®¸ç”¨æˆ·ä¹°å…¥æˆ–å–å‡ºå¤šå¤´è´§å¸å¯¹ã€‚ç¨åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`Chartjs`æ¥å®ç°ä¸€ä¸ªå›¾è¡¨ã€‚ğŸ˜‰

æˆ‘ä»¬å¼€å§‹å·¥ä½œå§ï¼

æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›ä¾èµ–é¡¹ã€‚å½“æˆ‘ä»¬éœ€è¦å®ƒä»¬æ—¶ï¼Œæˆ‘å°†æ·±å…¥æ£€æŸ¥æ¯ä¸€ä¸ªï¼Œä½†æ˜¯ç°åœ¨è®©æˆ‘ä»¬åªå®‰è£…å®ƒä»¬ã€‚

åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨æ‚¨çš„ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
 npm init -y 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬æœ‰äº† package.json æ–‡ä»¶ï¼Œè®©æˆ‘ä»¬å¼€å§‹å®‰è£…æˆ‘ä»¬çš„ä¾èµ–é¡¹ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°† nodemon å®‰è£…ä¸ºä¸€ä¸ªå¼€å‘ä¾èµ–é¡¹ã€‚

```
 npm i -D nodemon 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ä¸ºå…¶ä½™çš„:

```
 npm i apollo-datasource apollo-datasource-rest apollo-server-express bcryptjs express express-session graphql isemail mongoose 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿›å…¥`package.json`ï¼Œåˆ é™¤æµ‹è¯•è„šæœ¬å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
 "scripts": {
    "start": "nodemon index.js"
  }, 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ›å»ºä¸€ä¸ª`index.js`æ–‡ä»¶å¹¶æ·»åŠ ä¸‹é¢çš„ä»£ç :

```
 // index.js

  const app = require('express')()

  app.get('/', (req, res) => res.send('Hello world!'))

  const PORT = 4000

  app.listen(PORT, () => console.log(`Server running on port ${PORT}`)) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æ‚¨çš„ç»ˆç«¯ä¸­é”®å…¥`npm start`,ç„¶åå‰å¾€ localhost:4000ã€‚é—®å€™ä½ åº”è¯¥æ˜¯ä¸€ä¸ªå¤è€è€Œåº„ä¸¥çš„ä»ªå¼ï¼Œé‚£å°±æ˜¯ï¼Œâ€œä½ å¥½ï¼Œä¸–ç•Œï¼â€æŠ›å¼€ä»ªå¼ä¸Šçš„ç»†èŠ‚ï¼Œè®©æˆ‘ä»¬å¼€å§‹é˜¿æ³¢ç½—è®¡åˆ’ã€‚

ç°åœ¨æˆ‘ä»¬åªæ˜¯è¿è¡Œä¸€ä¸ªå¿«é€ŸæœåŠ¡å™¨ã€‚Apollo ä¸è¦æ±‚æˆ‘ä»¬å®‰è£… expressã€‚æˆ‘å†³å®šè¿™æ ·åšçš„åŸå› æ˜¯å› ä¸ºæˆ‘æƒ³æ•´åˆ`express-session`ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`express`å’Œ`apollo-server-express`ï¼Œè€Œä¸æ˜¯`apollo-server`ã€‚

å‰å¾€ [Alpha Vantage](https://www.alphavantage.co/,) å¹¶è·å–æ‚¨çš„ API å¯†é’¥ã€‚å¾ˆç®€å•ã€‚ç‚¹å‡»ç»¿è‰²çš„â€œç«‹å³è·å–å…è´¹ API å¯†åŒ™â€æŒ‰é’®ï¼Œä¸€åˆ‡å°±ç»ªã€‚

[![What is Apollo](../Images/03e6b1b7e1e5ddc1703083621e411b95.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--hBboKqqi--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/WhatisApollo.png%3Fraw%3Dtrue)

å½“æˆ‘ä»¬å¼€å§‹ä½¿ç”¨å®ƒçš„æ—¶å€™ï¼Œé˜¿æ³¢ç½—çš„ä¼˜åŠ¿å°±ä¼šæ˜¾ç°å‡ºæ¥ã€‚è½¬è‡³`index.js`å¹¶è¿›è¡Œä»¥ä¸‹è°ƒæ•´:

```
 // index.js

  const app = require('express')()
  const { ApolloServer } = require('apollo-server-express')

  const typeDefs = require('./typeDefs')
  const resolvers = require('./resolvers') 
  const CurrencyAPI = require('./datasources/currencies')

  const server = new ApolloServer({ 
    typeDefs,
    resolvers,
    dataSources: () => ({
      currencyAPI: new CurrencyAPI() 
    })
  })

  server.applyMiddleware({ app })

  app.listen(PORT, () => {
    console.log(`ğŸš€ Server ready at http://localhost:4000${server.graphqlPath}`)
  }) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä»`apollo-server-express`å¯¼å…¥`ApolloServer`ç±»ï¼Œå¹¶åœ¨åä¸º`server`çš„å˜é‡ä¸­å­˜å‚¨ä¸€ä¸ªæ–°å®ä¾‹ã€‚æˆ‘ä»¬è¿˜å¯¼å…¥äº†ä¸‰ä¸ªæˆ‘ä»¬ä»ç„¶éœ€è¦åˆ›å»ºçš„æœ¬åœ°æ–‡ä»¶ã€‚æˆ‘ä»¬å°† GraphQL æ¨¡å¼(æˆ– typeDefinitions)ä¼ é€’ç»™`ApolloServer`é…ç½®å¯¹è±¡çš„`typeDefs`å±æ€§ã€‚æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„è§£æå™¨å’Œ`dataSources`åšåŒæ ·çš„äº‹æƒ…(è¿™å°†è¢«è¯¦ç»†è§£é‡Š)ã€‚ä¹‹åï¼Œæˆ‘ä»¬æš‚æ—¶å°†`app`ä½œä¸ºæˆ‘ä»¬å”¯ä¸€çš„ä¸­é—´ä»¶ã€‚

åˆ›å»ºä¸€ä¸ªåä¸º`typeDefs.js`çš„æ–°æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
 // typeDefs.js

  const { gql } = require('apollo-server-express')

  const typeDefs = gql`
    type Query {
      currencyPairInfo(fc: String, tc: String): PairDisplay!
    }

    type PairDisplay {
      fromCurrency: String!
      fromCurrencyName: String
      toCurrency: String!
      toCurrencyName: String
      exchangeRate: String
      lastRefreshed: String
      timeZone: String
      bidPrice: String
      askPrice: String
    }
  `

  module.exports = typeDefs 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ REST API ä¸åŒï¼ŒGraphQL åªä½¿ç”¨ä¸€æ¡è·¯çº¿ã€‚æ‚¨ä¸éœ€è¦ä¸ºæ¯ä¸ªä»»åŠ¡ ping ä¸åŒçš„ç«¯ç‚¹ã€‚ç›¸åï¼Œæ¨¡å¼(æˆ– typeDefs)ç¡®åˆ‡åœ°æè¿°äº†æ‚¨æƒ³è¦ä»€ä¹ˆæ•°æ®ä»¥åŠæ‚¨æƒ³è¦å¦‚ä½•æ¥æ”¶å®ƒã€‚

ä½¿ç”¨ GraphQL æ—¶ï¼Œæœ‰ä¸‰ä»¶äº‹ä½ å¿…é¡»ç†è§£:æŸ¥è¯¢ã€å˜å¼‚å’Œè§£æå™¨ã€‚ä¸€åˆ‡éƒ½å›´ç»•ç€ä»–ä»¬ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆ GraphQL æŸ¥è¯¢æè¿°ä½ å¦‚ä½•`get`æ•°æ®ï¼ŒGraphQL å˜å¼‚æè¿°ä½ å¦‚ä½•å˜å¼‚(post/put/delete)æ•°æ®ã€‚æ‚¨å‡†ç¡®åœ°æè¿°äº†éœ€è¦ä»€ä¹ˆå˜é‡(å¦‚æœæœ‰çš„è¯)ä»¥åŠå“åº”åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­ã€‚è§£æå™¨åªæ˜¯å¤„ç†æŸ¥è¯¢å’Œå˜å¼‚æ‰§è¡Œçš„å‡½æ•°ã€‚

å£°æ˜ä½ æƒ³è¦ä»€ä¹ˆï¼Œç„¶åå†™å‡½æ•°æ¥å®ç°å®ƒã€‚

åœ¨ä¸Šé¢çš„æŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬è®© GraphQL çŸ¥é“æ¯å½“æˆ‘ä»¬è¯·æ±‚`currencyPairInfo`æ—¶ï¼Œè¿™ä¸¤ä¸ªå‚æ•°å¯èƒ½ä¼šä¹Ÿå¯èƒ½ä¸ä¼šè¢«æä¾›ã€‚åœ¨å†’å·ä¹‹åï¼Œæˆ‘ä»¬å£°æ˜å“åº”åº”è¯¥ä»¥æˆ‘ä»¬å‘½åä¸º`PairDisplay`çš„`type`æ‰€æè¿°çš„å½¢çŠ¶è¿”å›ã€‚ç»“å°¾çš„æ„Ÿå¹å·å£°æ˜éœ€è¦æ­¤å“åº”ã€‚

æˆ‘æ²¡æœ‰è¦æ±‚`currencyPairInfo`çš„å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬å°†åœ¨è¯·æ±‚ä¸Šè®¾ç½®é»˜è®¤å‚æ•°ã€‚æˆ‘ä»¬å°†æŠŠé»˜è®¤å‚æ•°`fc` (fromCurrency)è®¾ç½®ä¸º EURï¼Œå°†é»˜è®¤å‚æ•°`tc` (toCurrency)è®¾ç½®ä¸º USDã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›è¿™äº›å‚æ•°æ˜¯å¿…éœ€çš„ï¼Œæˆ‘ä»¬åªéœ€åœ¨`type`åé¢åŠ ä¸Šä¸€ä¸ªæ„Ÿå¹å·ï¼Œå°±åƒè¿™æ ·:`String!`ã€‚

è®©æˆ‘ä»¬æ·»åŠ æˆ‘ä»¬çš„è§£æå™¨ã€‚åˆ›å»ºä¸€ä¸ªåä¸º`resolvers.js`çš„æ–°æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹ä»£ç :

```
// resolvers.js

const resolvers = {
  Query: {
    currencyPairInfo: async (_, { fc, tc }, { dataSources }) => {
      try {
        const currencyPairs = await dataSources.currencyAPI.getCurrencyPair(fc, tc)
        return currencyPairs
      } catch (error) { throw err }
    }
  }
}

module.exports = resolvers 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ GraphQL ä¸­ï¼Œè§£æå™¨å¯ä»¥è®¿é—®`context`ã€‚ä¸Šä¸‹æ–‡æ˜¯æ‰€æœ‰è§£æå™¨å…±äº«çš„å¯¹è±¡ã€‚å®ƒæœ‰åŠ©äºè·Ÿè¸ªè¯¸å¦‚è®¤è¯ä¿¡æ¯ã€å½“å‰ç”¨æˆ·ã€æ•°æ®åº“è¿æ¥å’Œæ•°æ®æºç­‰ä¿¡æ¯ã€‚ä¸Šä¸‹æ–‡å¯ä½œä¸ºæ¯ä¸ªè§£æå™¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°ã€‚

è§£æå™¨å‡½æ•°ç­¾å:

1.  ç¬¬ä¸€ä¸ªå‚æ•°= parentã€‚
2.  ç¬¬äºŒä¸ªå‚æ•°= argsã€‚
3.  ç¬¬ä¸‰ä¸ªå‚æ•°=ä¸Šä¸‹æ–‡ã€‚

ä¿æŒè§£æå™¨å¹²å‡€ç®€æ´è¢«è®¤ä¸ºæ˜¯æœ€ä½³å®è·µï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ç¹é‡çš„å·¥ä½œæŠ½è±¡åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚è¿™æ˜¯æˆ‘ä»¬å¯¼å…¥åˆ°`index.js`ä¸­çš„æ–‡ä»¶ï¼Œä»ç„¶éœ€è¦åˆ›å»ºã€‚æ•°æ®æºå¯ä»¥è®¿é—® GraphQL ä¸Šä¸‹æ–‡ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸éœ€è¦æŠŠå®ƒå¯¼å…¥ resolvers.jsï¼Œæˆ‘ä»¬åªéœ€è¦ä»ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ææ„å®ƒã€‚

åˆ›å»ºä¸€ä¸ªåä¸º`datasources`çš„æ–°æ–‡ä»¶å¤¹ã€‚åœ¨é‡Œé¢æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå‘½åä¸º`currencies.js`ã€‚æ·»åŠ ä¸‹é¢çš„ä»£ç :

```
// currencies.js

const { RESTDataSource } = require('apollo-datasource-rest') 
const keys = require('../config/keys')

class CurrencyAPI extends RESTDataSource {
  constructor() {
    super() 
    this.baseURL = ''
  }

  async getCurrencyPair(fc='EUR', tc='USD') {
    try {
      const data = await this.get(`https://www.alphavantage.co/query?
function=CURRENCY_EXCHANGE_RATE&from_currency=${fc} &to_currency=${tc}&apikey=${keys.alphaVantageAPIKey}`),
            response = data['Realtime Currency Exchange Rate'],
            fromCurrency = response['1\. From_Currency Code'],
            fromCurrencyName = response['2\. From_Currency Name'],
            toCurrency = response['3\. To_Currency Code'],
            toCurrencyName = response['4\. To_Currency Name'],
            exchangeRate = response['5\. Exchange Rate'],
            lastRefreshed = response['6\. Last Refreshed'],
            timeZone = response['7\. Time Zone'],
            bidPrice = response['8\. Bid Price'],
            askPrice = response['9\. Ask Price']
      return data && response && {
          fromCurrency,
          fromCurrencyName,
          toCurrency,
          toCurrencyName,
          exchangeRate,
          lastRefreshed,
          timeZone,
          bidPrice,
          askPrice
        }
    } catch (err) { throw err }
  }
}

module.exports = CurrencyAPI 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä»`apollo-datasource-rest`å¯¼å…¥`RESTDataSource`ã€‚æˆ‘ä»¬æ‰©å±•è¿™ä¸ªç±»(åˆ›å»ºä¸€ä¸ªå­ç±»)æ¥å®šä¹‰æˆ‘ä»¬çš„æ•°æ®æºã€‚Apollo æ•°æ®æºæ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒå°è£…äº†æ‰€æœ‰çš„æ•°æ®è·å–é€»è¾‘ï¼Œä»¥åŠç‰¹å®šæœåŠ¡çš„ç¼“å­˜å’Œé‡å¤æ•°æ®åˆ é™¤ã€‚

ä»æ–‡æ¡£ä¸­:

> Apollo RESTDataSource è¿˜è®¾ç½®äº†ä¸€ä¸ªå†…å­˜ç¼“å­˜ï¼Œç”¨äºç¼“å­˜æ¥è‡ª REST èµ„æºçš„å“åº”ï¼Œæ— éœ€é¢å¤–è®¾ç½®ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸ºéƒ¨åˆ†æŸ¥è¯¢ç¼“å­˜ã€‚è¿™ä¸ªç¼“å­˜çš„ä¼Ÿå¤§ä¹‹å¤„åœ¨äºï¼Œæ‚¨å¯ä»¥é‡ç”¨ REST API å…¬å¼€çš„ç°æœ‰ç¼“å­˜é€»è¾‘ã€‚Apollo REST æ•°æ®æºä¹Ÿæœ‰å¯¹åº”äº HTTP åŠ¨è¯çš„ helper æ–¹æ³•ï¼Œæ¯”å¦‚`GET`å’Œ`POST`ã€‚

ä¸€æ—¦æˆ‘ä»¬åˆ°è¾¾`ApolloClient`ï¼Œæˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°è®¨è®ºè¿™ä¸ªç¼“å­˜ã€‚

è¿™ä¸ªæ–‡ä»¶æ‰€åšçš„å°±æ˜¯ä» Alpha Vantage API ä¸­è·å–ä¸€äº›æ•°æ®ã€‚æˆ‘ä»¬æ‰©å±•äº†`RESTDataSource`ç±»ï¼Œå¹¶åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–äº†`baseURL`ã€‚`baseURL`æ˜¯é˜¿æ³¢ç½—èµäºˆæˆ‘ä»¬çš„å±ˆè†ç¤¼ã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜è¿™æ˜¯å¦‚ä½•æœ‰ç”¨çš„ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¿™ä¸ªç±»ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ƒä»¬å¿…é¡»å‘½ä¸­åŒä¸€ä¸ª URL çš„ä¸åŒç«¯ç‚¹ã€‚

ä¾‹å¦‚:

```
 constructor() {
    super()
    this.baseURL = 'https://github.com/'
  }

  // Later in some method
  this.get('marlonanthony') // https://github.com/marlonanthony

  // In some other method
  this.get('peggyrayzis') // https://github.com/peggyrayzis 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨ä¹Ÿå¯ä»¥åŠ¨æ€è®¾ç½® URLã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ–‡æ¡£ä¸­çš„ä¸€ä¸ªä¾‹å­:

```
 get baseURL() {
    if (this.context.env === 'development') {
      return 'https://movies-api-dev.example.com/';
    } else {
      return 'https://movies-api.example.com/';
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æ„é€ å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬å®ç°äº†åœ¨è§£æå™¨ä¸­è°ƒç”¨çš„æ–¹æ³•`getCurrencyPair`ã€‚è¿™ä¸ªæ–¹æ³•è´Ÿè´£è·å–æˆ‘ä»¬çš„å®æ—¶è´§å¸æ±‡ç‡æ•°æ®ã€‚æˆ‘ä»¬åˆ©ç”¨ Alpha Vantage ç»™æˆ‘ä»¬çš„ URLï¼Œæ·»åŠ æˆ‘ä»¬çš„å‚æ•°å’Œ API å¯†é’¥ã€‚

Alpha Vantage API æ˜¯å…è´¹çš„ï¼Œè¿™æ„å‘³ç€æ–¹ä¾¿ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬çš„å‘½åçº¦å®šæœ‰ç‚¹æ„šè ¢ï¼Œéœ€è¦æˆ‘ä»¬ä½¿ç”¨æ‹¬å·ç¬¦å·ï¼Œå› æ­¤æ˜¾å¾—å†—é•¿ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œé˜¿æ³¢ç½—æœåŠ¡å™¨æ”¯æŒ [GraphQL Playground](http://localhost:4000/graphql) ã€‚Playground æ˜¯ä¸€ä¸ªäº¤äº’å¼çš„æµè§ˆå™¨å†… GraphQL IDEï¼Œç”¨äºæ¢ç´¢æ‚¨çš„æ¨¡å¼å’Œæµ‹è¯•æ‚¨çš„æŸ¥è¯¢/å˜åŒ–ã€‚æƒ³æƒ³é‚®å·®ï¼Œè€Œä¸æ˜¯ GraphQLã€‚

ç”¨`npm start`å¯åŠ¨æ‚¨çš„æœåŠ¡å™¨ã€‚ç„¶åè½¬åˆ° localhost:4000/graphql çœ‹ä¸€çœ‹ã€‚

[![currenyPairInfo query](../Images/1d4b7ee55513bcca0db2acb431a13ab9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--J2wVJRvI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/gqlplayground.png%3Fraw%3Dtrue)

åœ¨æ’­æ”¾æŒ‰é’®çš„å·¦è¾¹ï¼Œæˆ‘ä»¬å£°æ˜æˆ‘ä»¬æƒ³è¦`query`ä¸€äº›æ•°æ®ã€‚ç„¶åæˆ‘ä»¬è§£é‡Šå“ªä¸ªæŸ¥è¯¢å¹¶æä¾›å¿…è¦çš„å‚æ•°ã€‚å¦‚æœæ‚¨æŒ‰ control +ç©ºæ ¼é”®(åœ¨ Mac ä¸Š),æ‚¨åº”è¯¥ä¼šå¾—åˆ°å…³äºæ‚¨çš„æ¨¡å¼çš„è‡ªåŠ¨å®Œæˆå»ºè®®ã€‚ä¹‹åï¼Œæˆ‘ä»¬å£°æ˜æˆ‘ä»¬æƒ³è¦è¿”å›çš„æ•°æ®ã€‚ä¸€æ—¦ä½ æŒ‰ä¸‹æ’­æ”¾æŒ‰é’®ï¼Œä½ ä¼šåœ¨æ“åœºçš„å³åŠéƒ¨åˆ†çœ‹åˆ°å›åº”ã€‚

åœ¨æˆ‘ä»¬çš„`getCurrencyPair`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†è¿™ä¸ªæŸ¥è¯¢å¯èƒ½è¿”å›çš„æ‰€æœ‰å†…å®¹ã€‚GraphQL å’Œ REST ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼Œå¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œæˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„è¯·æ±‚é™åˆ¶åˆ°æˆ‘ä»¬å–œæ¬¢çš„ä»»ä½•æ•°æ®ç‰‡æ®µã€‚

å¤ªæ£’äº†ã€‚æˆ‘ä»¬ä» Alpha Vantage API ä¸­è·å–å®æ—¶è´§å¸æ±‡ç‡ï¼ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¿˜æ²¡è¯´å®Œã€‚æˆ‘å‰é¢è¯´è¿‡ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå›¾è¡¨æ¥æ˜¾ç¤ºè´§å¸å¯¹æ•°æ®çš„æ¯æœˆæ—¶é—´åºåˆ—ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‘ CurrencyAPI ç±»æ·»åŠ å¦ä¸€ä¸ªæ–¹æ³•ã€‚

```
 // currencies.js

  async getMonthlyTimeSeries(fc='EUR', tc='USD') {
    try {
      const data = await this.get(`https://www.alphavantage.co/query?
function=FX_MONTHLY&from_symbol=${fc}&to_symbol=${tc}&apikey=${keys.alphaVantageAPIKey}`),
            timeSeries = data && data['Time Series FX (Monthly)'],
            timesArray = timeSeries && Object.keys(timeSeries).reverse(),
            valuesArray = timeSeries && Object.values(timeSeries).map(val => val['4\. close']).reverse()

      return { timesArray, valuesArray }

    } catch (error) { throw error }
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ©ç”¨ä¸åŒçš„é˜¿å°”æ³•ä¼˜åŠ¿ç«¯ç‚¹ã€‚æˆ‘ä»¬åƒä»¥å‰ä¸€æ ·æä¾›å‚æ•°å’Œ API å¯†é’¥ã€‚æˆ‘ä»¬è¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæ•°ç»„çš„å¯¹è±¡ï¼Œå³ timesArray (x è½´)å’Œ valuesArray (y è½´)ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„å›¾è¡¨æ‰€éœ€è¦çš„ã€‚

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè§£æå™¨æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶å‘æˆ‘ä»¬çš„ typeDefs æ·»åŠ ä¸€ä¸ªæŸ¥è¯¢ã€‚è¿›å…¥`typeDefs.js`ï¼Œå°†æŸ¥è¯¢ç±»å‹è°ƒæ•´ä¸º:

```
// typeDefs.js 

  type Query {
    currencyPairInfo(fc: String, tc: String): PairDisplay!
    monthlyTimeSeries(fc: String, tc: String): TimeSeries!
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæˆ‘ä»¬æœŸæœ›æ”¶åˆ°ä¸€ä¸ª fromCurrency ( `fc`)å’Œ toCurrency ( `tc`)å‚æ•°ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¸éœ€è¦å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯åœ¨è¯·æ±‚ä¸­è®¾ç½®é»˜è®¤å‚æ•°ã€‚æˆ‘é€‰æ‹©è¿™æ ·åšçš„åŸå› æ˜¯ï¼Œå½“ç”¨æˆ·å¯¼èˆªåˆ°å›¾è¡¨æ—¶ï¼Œé¡µé¢å°†åŠ è½½æ•°æ®ï¼Œè€Œä¸æ˜¯ç©ºç™½ï¼Œç›´åˆ°ç”¨æˆ·è¾“å…¥è´§å¸å¯¹ã€‚

æˆ‘ä»¬çš„ monthlyTimeSeries æŸ¥è¯¢è¦æ±‚æˆ‘ä»¬è¿”å›ç±»å‹ä¸º`TimeSeries`çš„æ•°æ®ã€‚è®©æˆ‘ä»¬ç¡®åˆ‡åœ°å®šä¹‰è¿™æ˜¯ä»€ä¹ˆã€‚å°†ä»¥ä¸‹ç±»å‹æ·»åŠ åˆ°`typeDefs.js` :

```
// typeDefs.js 

  type TimeSeries {
    timesArray: [String!]!
    valuesArray: [String!]!
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæˆ‘ä»¬å£°æ˜å¿…é¡»è¿”å›ä¸¤ä¸ªæ•°ç»„ï¼Œå¹¶ä¸”è¿™äº›æ•°ç»„å¿…é¡»ç”¨å­—ç¬¦ä¸²å¡«å……ã€‚å­—ç¬¦ä¸²å’Œæ•°ç»„éƒ½æ˜¯å¿…éœ€çš„ã€‚).

æœ€åï¼Œè®©æˆ‘ä»¬æ·»åŠ è§£æå™¨ã€‚è°ƒæ•´`resolvers.js`ï¼Œä½¿å…¶ç±»ä¼¼å¦‚ä¸‹:

```
// resolvers.js

  const resolvers = {
    Query: {
      currencyPairInfo: async (_, { fc, tc }, { dataSources }) => {
        try {
          const currencyPairs = await dataSources.currencyAPI.getCurrencyPair(fc, tc)
          return currencyPairs
        } catch (error) { throw err }
      },
      monthlyTimeSeries: async (_, { fc, tc }, { dataSources }) => {
        try {
          const timeSeries = await dataSources.currencyAPI.getMonthlyTimeSeries(fc, tc)
          return timeSeries
        } catch (error) { throw error }
      }
    }
  }

module.exports = resolvers 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰“å¼€ GraphQL Playgroundï¼ŒæŸ¥è¯¢`monthlyTimeSeries`ã€‚

[![montly time series](../Images/e76ba8c9774f9631027fdb8c5659efee.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--QZZGBVGq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/mtseries.png%3Fraw%3Dtrue)

GraphQL æ¨¡å¼ç°åœ¨åº”è¯¥å˜å¾—æ¸…æ™°äº†ã€‚

*   åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢/å˜å¼‚ã€‚
*   åˆ›å»ºè§£æå™¨æ¥å¤„ç†æ‰€è¿°æŸ¥è¯¢/å˜å¼‚ã€‚

å°±è¿™æ ·ï¼Œæˆ‘ä»¬å®Œæˆäº† Alpha Vantage APIï¼

æˆ‘ä»¬æ…¢æ…¢ç†Ÿæ‚‰äº† GraphQL å’Œ Apolloã€‚è®©æˆ‘ä»¬æ›´è½»æ¾åœ°å¤„ç†èº«ä»½éªŒè¯é—®é¢˜ã€‚å¤„ç†è®¤è¯/æˆæƒæ˜¯ä¸€ä¸ªå¹¿æ³›è®¨è®ºçš„è¯é¢˜ã€‚æˆ‘ä»¬å°†åªå…³æ³¨ä¸ Apollo çš„é›†æˆã€‚

æˆ‘ä»¬åº”è¯¥åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ MongoDB/mongoseã€‚å‰å¾€ [MongoDB å›¾é›†](https://www.mongodb.com/cloud/atlas)æŠ¥å/ç­¾åˆ°ã€‚ç”¨ Atlas åˆ›å»ºè¿œç¨‹æ•°æ®åº“ç›¸å½“ç®€å•ã€‚ç™»å½•åï¼Œå•å‡»â€œæ–°å»ºé¡¹ç›®â€æŒ‰é’®ã€‚ä»è¿™é‡Œï¼Œåªéœ€é€‰æ‹©æ‚¨çš„äº‘æä¾›å•†ï¼Œé€‰æ‹©æ‚¨çš„åœ°åŒºï¼Œå¹¶å‘½åæ‚¨çš„é›†ç¾¤ã€‚æ„å»ºå¥½é›†ç¾¤åï¼Œå•å‡» connect æŒ‰é’®ã€‚å°†æ‚¨çš„ IP åœ°å€åˆ—å…¥ç™½åå•ï¼Œå¹¶ä¸ºè¯¥é¡¹ç›®åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ã€‚é€‰æ‹©â€œè¿æ¥æ‚¨çš„åº”ç”¨ç¨‹åºâ€é€‰é¡¹ï¼Œå¹¶å¤åˆ¶æä¾›çš„è¿æ¥å­—ç¬¦ä¸²ã€‚æœ€åï¼Œç‚¹å‡»â€œæ”¶è—â€æŒ‰é’®ã€‚è¿™æ˜¯æˆ‘ä»¬å°†çœ‹åˆ°æ•°æ®çš„åœ°æ–¹ã€‚

ç”¨æ‚¨çš„ç”¨æˆ·å¯†ç æ›¿æ¢æ‚¨çš„è¿æ¥å­—ç¬¦ä¸²ä¸­çš„`<password>`,ä½†æ˜¯å°†å®ƒå­˜å‚¨åœ¨ä¸€ä¸ªå˜é‡ä¸­ï¼Œå¹¶å°†å…¶æ”¾åœ¨ä¸€ä¸ª env æ–‡ä»¶æˆ– config æ–‡ä»¶å¤¹ä¸­ã€‚åªè¦ä¸æ¨ç»™ GitHubã€‚

è®©æˆ‘ä»¬è¿æ¥åˆ°æ•°æ®åº“å¹¶å®šä¹‰æˆ‘ä»¬çš„ç”¨æˆ·æ¨¡å¼ã€‚å›åˆ°`index.js`å¯¼å…¥`mongoose`ï¼Œå¯¼å…¥ä½ çš„ MongoDB å¯†ç ï¼Œç„¶åå°†`index.js`è°ƒæ•´ä¸ºå¦‚ä¸‹:

```
// index.js

const app = require('express')()
const { ApolloServer } = require('apollo-server-express')
const mongoose = require('mongoose')

const typeDefs = require('./typeDefs')
const resolvers = require('./resolvers') 
const CurrencyAPI = require('./datasources/currencies')
const { mongoPassword } = require('./config/keys')

const server = new ApolloServer({ 
  typeDefs,
  resolvers,
  dataSources: () => ({
    currencyAPI: new CurrencyAPI() 
  })
})

server.applyMiddleware({ app })

mongoose
.connect(`mongodb+srv://marlon:${mongoPassword}@cluster0-o028g.mongodb.net/forex?retryWrites=true&w=majority`, { useNewUrlParser: true })
.then(() => app.listen(4000, () => {
  console.log(`ğŸš€ Server ready at http://localhost:4000${server.graphqlPath}`)
})).catch(err => console.log(err)) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ ä¼šæ³¨æ„åˆ°ï¼Œåœ¨ URL çš„æœ«å°¾ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ç‚¹é…ç½®æ¥æ¶ˆé™¤è®¨åŒçš„ MongoDB/mongose è­¦å‘Šã€‚ä¸€æ—¦æ‚¨ä¿å­˜`index.js`ï¼Œæˆ‘ä»¬å°†è¿æ¥åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ã€‚

ç°åœ¨æ¥çœ‹æ¨¡å¼ã€‚åˆ›å»ºä¸€ä¸ªåä¸º`models`çš„æ–‡ä»¶å¤¹ã€‚åœ¨`models`ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`User.js`çš„æ–°æ–‡ä»¶ï¼Œå¹¶æ’å…¥ä»¥ä¸‹å†…å®¹:

```
// User.js

const mongoose = require('mongoose') 
const Schema = mongoose.Schema

const User = new Schema({
  email: {
    type: String,
    required: true 
  },
  password: {
    type: String,
    required: true 
  },
  name: {
    type: String,
    required: true 
  },
  bankroll: {
    type: Number,
    default: 1000000,
    required: true
  },
  pairs: [
    {
      type: Schema.Types.ObjectId,
      ref: 'Pair'
    }
  ]
}, {
  timestamps: true
})

module.exports = mongoose.model('User', User) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä»`mongoose`å¯¼å…¥äº†`Schema`ç±»ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå‘½åä¸º`User`ã€‚ä¹‹åï¼Œæˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„æ¨¡å¼ã€‚æ¯ä¸ªç”¨æˆ·éƒ½ä¼šæœ‰ä¸€ä¸ª MongoDB èµ‹äºˆä»–ä»¬çš„ IDï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å®šä¹‰å®ƒã€‚ç”¨æˆ·å¿…é¡»æä¾›ç”µå­é‚®ä»¶ã€å¯†ç å’Œå§“åã€‚æˆ‘ä»¬ç»™æ¯ä¸ªç”¨æˆ· 100 ä¸‡ç¾å…ƒâ€”â€”å› ä¸ºæˆ‘ä»¬å¯ä»¥ã€‚æ¯ä¸ªç”¨æˆ·éƒ½å¸Œæœ›è·Ÿè¸ªä»–ä»¬å·²ç»å¼€ç«‹çš„è´§å¸å¯¹å¤´å¯¸ã€‚æˆ‘ä»¬åˆ†é…ä¸€ä¸ª`pairs`å±æ€§ï¼Œä¸ºç”¨æˆ·æ‰“å¼€çš„æ¯ä¸€å¯¹æä¾›ä¸€ä¸ª id æ•°ç»„ã€‚æœ€åï¼Œé€šè¿‡å‘æˆ‘ä»¬çš„æ¨¡å¼æ·»åŠ `timestamps: true`ï¼ŒMongoose ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªå±æ€§:`createdAt`å’Œ`updatedAt`ã€‚

åœ¨ models æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘½åä¸º`Pair.js`ã€‚åœ¨é‡Œé¢å†™ä¸‹ä¸‹é¢çš„ä»£ç :

```
// Pair.js

const mongoose = require('mongoose') 
const Schema = mongoose.Schema

const Pair = new Schema({
  user: {
    type: Schema.Types.ObjectId,
    ref: 'User'
  },
  pair: {
    type: String,
    required: true 
  },
  lotSize: {
    type: Number,
    required: true 
  },
  position: {
    type: String,
    required: true 
  },
  openedAt: {
    type: Number,
    required: true 
  },
  closedAt: {
    type: Number,
  },
  pipDif: {
    type: Number,
  },
  profitLoss: {
    type: Number
  },
  open: {
    type: Boolean,
    required: true,
    default: false
  }
}, {
  timestamps: true
})

module.exports = mongoose.model('Pair', Pair) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†ç”¨æˆ· ID å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º`user`çš„å±æ€§ä¸­ã€‚`pair`å±æ€§çœ‹èµ·æ¥ç±»ä¼¼è¿™æ ·:EUR/USDã€‚`lotSize`æ˜¯ç”¨æˆ·æ”¾åœ¨å¤´å¯¸ä¸Šçš„é‡‘é¢ã€‚`position`ä¸æ˜¯â€œé•¿â€å°±æ˜¯â€œçŸ­â€`pipDif`ç¨åå°†è¯¦ç»†è§£é‡Šï¼Œä½†ç°åœ¨åªéœ€çŸ¥é“æˆ‘ä»¬å°†å¦‚ä½•è®¡ç®—è´§å¸å¯¹ä¹‹é—´çš„ç›¸å¯¹ä»·å€¼å·®å¼‚ï¼Œä»¥åŠå¤´å¯¸çš„ç›ˆäºã€‚`open`é€šçŸ¥æˆ‘ä»¬è¯¥å¤´å¯¸æ˜¯å¦å·²ç»å¹³ä»“ã€‚

æ‰“å¼€`typeDefs.js`ï¼Œå¢åŠ ä¸¤ç§ç±»å‹:`User`å’Œ`Pair`ã€‚

```
// typeDefs.js

  type User {
    id: ID!
    email: String!
    name: String!
    bankroll: Float!
    pairs: [Pair]
    createdAt: String!
    updatedAt: String!
  }

  type Pair {
    id: ID!
    user: ID!
    pair: String!
    lotSize: Int!
    position: String!
    openedAt: Float!
    closedAt: Float
    pipDif: Float
    profitLoss: Float
    open: Boolean!
    createdAt: String!
    updatedAt: String!
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¦‚æœæ¨¡å‹æ¨¡å¼ä¸­éœ€è¦æŸäº›ä¸œè¥¿ï¼Œé‚£ä¹ˆ GraphQL æ¨¡å¼ä¸­ä¹Ÿåº”è¯¥éœ€è¦ã€‚

æ˜¯æ—¶å€™åŠ å…¥æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªçªå˜äº†ã€‚åœ¨`typeDefs.js`å†…æ·»åŠ `Mutation`ç±»å‹ã€‚

```
// typeDefs.js

  type Mutation {
    register(email: String!, password: String!, name: String!): Boolean!
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨æˆ·å¿…é¡»æäº¤ç”µå­é‚®ä»¶ã€å¯†ç å’Œä»–ä»¬çš„åå­—ã€‚æˆ‘ä»¬æ ¹æ®ç”¨æˆ·æ³¨å†Œçš„æˆåŠŸè¿”å› true æˆ– falseã€‚

æˆ‘ä»¬å·²ç»å¤„ç†äº† typeDefsï¼Œç°åœ¨æ˜¯è§£æå™¨ã€‚æˆ‘ä»¬éœ€è¦å‘ resolvers å¯¹è±¡æ·»åŠ ä¸€ä¸ª`Mutation`å±æ€§ã€‚

```
// resolvers.js

const resolvers = {
  Query: {
    currencyPairInfo: async (_, { fc, tc }, { dataSources }) => {
      try {
        const currencyPairs = await dataSources.currencyAPI.getCurrencyPair(fc, tc)
        return currencyPairs
      } catch (error) { throw err }
    },
    monthlyTimeSeries: async (_, { fc, tc }, { dataSources }) => {
      try {
        const timeSeries = await dataSources.currencyAPI.getMonthlyTimeSeries(fc, tc)
        return timeSeries
      } catch (error) { throw error }
    }
  },

  Mutation: {
    register: async (_, { email, password, name }, { dataSources }) => {
      try {
        const newUser = await dataSources.userAPI.createNewUser({ email, password, name })
        return newUser
      } catch (error) { throw error }
    },
  }
}

module.exports = resolvers 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŒæ ·ï¼Œæˆ‘ä»¬ä¿æŒè§£æå™¨å¹²å‡€ï¼Œå¹¶å°†ç¹é‡çš„å·¥ä½œæŠ½è±¡åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä½†æ˜¯ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ`RESTDataSource`è´Ÿè´£ä» REST API è·å–æ•°æ®ã€‚è¿™ä¸æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œåšçš„ã€‚Apollo å…è®¸æˆ‘ä»¬ç”¨é€šç”¨çš„`apollo-datasource`åŒ…åˆ›å»ºå®šåˆ¶æ•°æ®æºã€‚è¿™æ˜¯æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ã€‚

åœ¨`datasources`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘½åä¸º`user.js`ã€‚

```
// user.js

const { DataSource } = require('apollo-datasource')
const { UserInputError } = require('apollo-server-express')
const isEmail = require('isemail')
const bcrypt = require('bcryptjs')

const User = require('../models/User') 

class UserAPI extends DataSource {

  // gain access to the GraphQL context
  initialize(config) {
    this.context = config.context
  }

  async createNewUser({ email, password, name }) {
    try {
      if(!isEmail.validate(email)) { throw new UserInputError('Invalid Email!') }
      const existingUser = await User.findOne({ email })
      if(existingUser) { throw new UserInputError('User already exist!') }
      const hashedPassword = await bcrypt.hash(password, 12)
      const user = await new User({
        name,
        email,
        password: hashedPassword
      })
      await user.save()
      return true 
    } catch (error) { throw error }
  }
}

module.exports = UserAPI 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–å…ˆï¼Œæˆ‘ä»¬å¯¼å…¥é˜¿æ³¢ç½—çš„`DataSource`ç±»ã€‚ç„¶åæˆ‘ä»¬é€šè¿‡æ‰©å±•`DataSource`åˆ›å»ºä¸€ä¸ªå­ç±»ï¼Œå¹¶å°†å…¶å‘½åä¸º`UserAPI`ã€‚é€šè¿‡æ·»åŠ `initialize`å‡½æ•°ï¼ŒApollo å…è®¸æˆ‘ä»¬ä»è¿™ä¸ªç±»å†…éƒ¨è®¿é—®ä¸Šä¸‹æ–‡ã€‚è¿™æ˜¯ä¸€ä¸ªç”± ApolloServer åœ¨è®¾ç½®æ—¶è°ƒç”¨çš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°é€šè¿‡æ•°æ®æºé…ç½®æ¥è°ƒç”¨ï¼ŒåŒ…æ‹¬ç¼“å­˜å’Œä¸Šä¸‹æ–‡ã€‚è¿™å…è®¸æˆ‘ä»¬åˆ©ç”¨`this.context`ï¼Œæˆäºˆæˆ‘ä»¬è®¿é—®è¯·æ±‚ä¸Šä¸‹æ–‡çš„æƒé™ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“å‘å‡ºè¯·æ±‚çš„ç”¨æˆ·ã€‚

æˆ‘ä»¬ä¹Ÿä»`apollo-server-express`å¯¼å…¥`UserInputError`ã€‚è¿™å…è®¸æˆ‘ä»¬åŒºåˆ†é”™è¯¯ç±»å‹ã€‚é˜¿æ³¢ç½—å®¢æˆ·ç«¯åŒºåˆ†äº†ä¸¤ç§é”™è¯¯:`graphQLErrors`å’Œ`networkError`ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹é˜¿æ³¢ç½—å›¢é˜Ÿå»å¹´å†™çš„ä¸€ç¯‡åšæ–‡ã€‚

[![graphQLError vs networkError](../Images/666a06a9f211c94c46a591b7d7e1e98b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--f5ArChQu--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/graphQLErrorvsnetworkError.png%3Fraw%3Dtrue)

æˆ‘ä»¬çš„è§£æå™¨ä¸­æŠ›å‡ºçš„è¿™äº› graphQLErrors æ€ä¹ˆåŠï¼Ÿè¿˜æ˜¯é‚£å¥è¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ç¯‡[åšæ–‡](https://blog.apollographql.com/full-stack-error-handling-with-graphql-apollo-5c12da407210)ã€‚

[![resolver errors](../Images/cbb0c8479b3f332f76850e3719e8d840.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--sySfSdQv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/apolloServerErrors.png%3Fraw%3Dtrue)

æˆ‘ä»¬å¯¼å…¥`isemail`ä»¥ç¡®ä¿æä¾›äº†æœ‰æ•ˆçš„ç”µå­é‚®ä»¶ã€‚åœ¨å°†ç”¨æˆ·å¯†ç ä¿å­˜åˆ°æ•°æ®åº“ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜å¯¼å…¥äº†`bcrypt`æ¥æ•£åˆ—ç”¨æˆ·å¯†ç ã€‚æœ€åï¼Œæˆ‘ä»¬å¯¼å…¥æˆ‘ä»¬çš„ç”¨æˆ·æ¨¡å¼ã€‚

è½¬åˆ° index.js å¹¶å¯¼å…¥æˆ‘ä»¬æ–°åˆ›å»ºçš„æ•°æ®æºã€‚ç„¶åå°†æˆ‘ä»¬çš„ UserAPI ç±»çš„ä¸€ä¸ªæ–°å®ä¾‹æ·»åŠ åˆ° ApolloServer çš„é…ç½®å¯¹è±¡:

```
// index.js

const UserAPI = require('./datasources/user')

const server = new ApolloServer({ 
  typeDefs,
  resolvers,
  dataSources: () => ({
    currencyAPI: new CurrencyAPI(),
    userAPI: new UserAPI()
  })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¿å­˜æ‚¨çš„æ–‡ä»¶ï¼Œçœ‹çœ‹ GraphQL æ“åœºã€‚

[![register mutation](../Images/f8a96793737becfd1d490231ec0023d9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--lg-feiLW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/register2.png%3Fraw%3Dtrue)

å¦‚æœæ‚¨å°è¯•æ³¨å†ŒåŒä¸€ä¸ªç”¨æˆ·ä¸¤æ¬¡ï¼Œæ‚¨åº”è¯¥å¾—åˆ°æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„`UserInputError`(â€œç”¨æˆ·å·²ç»å­˜åœ¨ï¼â€).æ‚¨è¿˜åº”è¯¥èƒ½å¤Ÿåœ¨æ•°æ®åº“ä¸­çœ‹åˆ°æˆ‘ä»¬æ–°åˆ›å»ºçš„ç”¨æˆ·ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥æ³¨å†Œç”¨æˆ·äº†ï¼Œè®©æˆ‘ä»¬è®©ä»–ä»¬ç™»å½•ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨`express-session`æ¥è·Ÿè¸ªæˆ‘ä»¬çš„ç”¨æˆ·ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯ï¼Œä¸€æ—¦ç”¨æˆ·æˆåŠŸç™»å½•ï¼Œæˆ‘ä»¬å°†æŠŠç”¨æˆ· id é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡çš„ä¼šè¯ä¸Šã€‚æˆ‘ä»¬å°†åœ¨è§£æå™¨ä¸­è®¿é—®ä¸Šä¸‹æ–‡å¯¹è±¡çš„è¯·æ±‚å¯¹è±¡ï¼Œæˆ–è€…é€šè¿‡`UserAPI`ç±»ä¸­çš„`this.context`â€”â€”ä¸€æ—¦æˆ‘ä»¬å°†å®ƒæ”¾åœ¨ä¸Šä¸‹æ–‡ä¸­ã€‚

è½¬è‡³`index.js`å¹¶è¿›è¡Œä»¥ä¸‹è°ƒæ•´:

```
// index.js

const app = require('express')()
const { ApolloServer } = require('apollo-server-express')
const mongoose = require('mongoose')
// Import express-session
const session = require('express-session')

const typeDefs = require('./typeDefs')
const resolvers = require('./resolvers') 
const CurrencyAPI = require('./datasources/currencies')
const UserAPI = require('./datasources/user')
// import your session secret
const { mongoPassword, secret } = require('./config/keys') 

const server = new ApolloServer({ 
  typeDefs,
  resolvers,
  dataSources: () => ({
    currencyAPI: new CurrencyAPI(),
    userAPI: new UserAPI()
  }),
  // add req Object to context
  context: ({ req }) => ({ req })
})

// add express-session to middleware
app.use(session({
  secret,
  resave: false,
  saveUninitialized: false
}))

// add cors to middleware
server.applyMiddleware({ 
  app, 
  cors: {
      credentials: true,
      origin: 'http://localhost:3000'
  }
})

mongoose
.connect(`mongodb+srv://marlon:${mongoPassword}@cluster0-o028g.mongodb.net/forex?retryWrites=true&w=majority`, { useNewUrlParser: true })
.then(() => app.listen(4000, () => {
  console.log(`ğŸš€ Server ready at http://localhost:4000${server.graphqlPath}`)
})).catch(err => console.log(err)) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¼å…¥`express-session`ç„¶ååˆ›å»ºå¹¶å¯¼å…¥æ‚¨çš„ä¼šè¯å¯†ç ã€‚ä»»ä½•å­—ç¬¦ä¸²éƒ½å¯ä»¥ã€‚ç„¶åå°†`request`å¯¹è±¡æ·»åŠ åˆ°`context`ä¸­ï¼Œå¹¶é€šè¿‡æˆ‘ä»¬çš„`express-session`å’Œ`cors`ä¸­é—´ä»¶ã€‚

è®©æˆ‘ä»¬å°†`login`æ·»åŠ åˆ°æˆ‘ä»¬çš„ typeDefs ä¸­ã€‚

```
// typeDefs.js

type Mutation {
  register(email: String!, password: String!, name: String!): Boolean!
  login(email: String!, password: String!): User
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`login`è§£æå™¨:

```
// resolvers.js 

Mutation: {
  register: async (_, { email, password, name }, { dataSources }) => {
    try {
      const newUser = await dataSources.userAPI.createNewUser({ email, password, name })
      return newUser
    } catch (error) { throw error }
  },
  login: async (_, { email, password }, { dataSources }) => {
    try {
      const user = await dataSources.userAPI.loginUser({ email, password })
      return user 
    } catch (error) { throw error }
  },
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è½¬åˆ°`datasources/user.js`ï¼Œå‘`UserAPI`ç±»æ·»åŠ ä¸€ä¸ªåä¸º`loginUser`çš„æ–¹æ³•ã€‚

```
// datasources/user.js

async loginUser({ email, password }) {
  try {
    if (!isEmail.validate(email)) { throw new UserInputError('Invalid Email') }
    const user = await User.findOne({ email }) 
    if(!user) { throw new UserInputError('Email or password is incorrect!') }
    const isEqual = await bcrypt.compare(password, user.password)
    if(!isEqual) { throw new UserInputError('Email or password is incorrect!') }
    this.context.req.session.userId = user.id 
    return user 
  } catch (error) { throw error }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ç”¨`isemail`éªŒè¯é‚®ä»¶ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç»™å®šçš„å¯†ç ä¸æ•°æ®åº“ä¸­çš„æ•£åˆ—å¯†ç è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæˆ‘ä»¬åœ¨`req.session`ä¸Šæ”¾ç½®ä¸€ä¸ª`userId`å±æ€§ã€‚è¿™æ˜¯æˆ‘ä»¬è·Ÿè¸ªç”¨æˆ·çš„æ–¹å¼ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘åœ¨è¿™é‡Œè¿”å›æ•´ä¸ªç”¨æˆ·å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç”Ÿäº§åº”ç”¨ç¨‹åºä¸­ï¼Œä½ æ°¸è¿œä¸ä¼šæƒ³è¦è¿”å›ç”¨æˆ·å¯†ç ã€‚

å‰å¾€ [GraphQL æ¸¸ä¹åœº](http://localhost:4000/graphql)å¹¶è¿è¡Œ`login`çªå˜ã€‚

[![login mutation](../Images/00469311647f7930393a6e9ff159bca2.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--uGm5dAfw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/login.png%3Fraw%3Dtrue)

æˆ‘ä»¬åœ¨å‰ç«¯è·Ÿè¸ªç”¨æˆ·çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª`me`æŸ¥è¯¢ã€‚è¿™ä¸ª`me`æŸ¥è¯¢å°†å‘Šè¯‰æˆ‘ä»¬å“ªä¸ªç”¨æˆ·æ­£åœ¨è¯•å›¾æ‰§è¡Œä¸€ä¸ªåŠ¨ä½œï¼Œå› æ­¤å…è®¸æˆ‘ä»¬å†³å®šè¿™ä¸ªç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡Œæ‰€è¿°åŠ¨ä½œçš„æˆæƒã€‚

æˆ‘ä»¬å¼€å§‹å§ï¼

é¦–å…ˆï¼Œå°†`me`æŸ¥è¯¢æ·»åŠ åˆ°`typeDefs.js`ä¸­ã€‚

```
// typeDefs.js

type Query {
  currencyPairInfo(fc: String, tc: String): PairDisplay!
  monthlyTimeSeries(fc: String, tc: String): TimeSeries!
  me: User
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†`me`æŸ¥è¯¢æ·»åŠ åˆ°è§£æå™¨`Query`å¯¹è±¡ã€‚

```
// resolvers.js 

me: async (_, __, { dataSources }) => {
  try {
    const user = await dataSources.userAPI.getMe()
    return user
  } catch (error) { throw error }
}, 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°†`getMe`æ–¹æ³•æ·»åŠ åˆ°æ•°æ®æºä¸­ã€‚è½¬åˆ°`datasources/user.js`å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
// datasources/user.js

  async getMe() {
    try {
      if(!this.context.req.session.userId) return null 
      const user = await User.findById(this.context.req.session.userId) 
      return user 
    } catch (error) { throw error }
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨å›åˆ° GraphQL æ¸¸ä¹åœºã€‚ç‚¹å‡»æ“åœºå³ä¸Šè§’çš„è®¾ç½®æ¡£ä½å›¾æ ‡ï¼Œå°†`"request.credentials"`è°ƒæ•´ä¸º:`"request.credentials":"include"`ã€‚ç™»å½•ï¼Œç„¶åæ‰§è¡Œ`me`æŸ¥è¯¢ï¼Œä½ åº”è¯¥å¾—åˆ°ç™»å½•çš„ç”¨æˆ·ã€‚

[![me query](../Images/635d51b7da3e393f6fcbb6f08dcb9a3d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--a5y-hOqc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/me.png%3Fraw%3Dtrue)

ç°åœ¨ç”¨ä¸åŒçš„ç”¨æˆ·ç™»å½•ï¼Œå½“æ‚¨æ‰§è¡Œ`me`æŸ¥è¯¢æ—¶ï¼Œå®ƒä¼šæä¾›æ–°ç”¨æˆ·çš„ä¿¡æ¯ã€‚è¿™æ˜¯å› ä¸ºæ¯ä¸ªè¯·æ±‚éƒ½æœ‰ä¸€ä¸ªæ–°çš„`context`è¢«æ„å»ºã€‚å› æ­¤ï¼Œ`req.session.userId`å°†æ°¸è¿œå±äºå‘å‡ºè¯·æ±‚çš„ç”¨æˆ·ã€‚

å¤ªæ£’äº†ã€‚è¿™æ˜¯åˆ›é€ `logout`çªå˜çš„å¥½æ—¶æœºã€‚æˆ‘ä»¬å¼€å§‹å§ï¼å‰å¾€`typeDefs.js`å¹¶æ·»åŠ `logout`çªå˜ã€‚

```
// typeDefs.js

type Mutation {
  register(email: String!, password: String!, name: String!): Boolean!
  login(email: String!, password: String!): User!
  logout: Boolean
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†`logout`æ·»åŠ åˆ°`resolvers.js`ä¸­çš„`Mutation`å¯¹è±¡ä¸­ã€‚

```
// resolvers.js

Mutation: {
  register: async (_, { email, password, name }, { dataSources }) => {
    try {
      const newUser = await dataSources.userAPI.createNewUser({ email, password, name })
      return newUser
    } catch (error) { throw error }
  },
  login: async (_, { email, password }, { dataSources }) => {
    try {
      const user = await dataSources.userAPI.loginUser({ email, password })
      return user 
    } catch (error) { throw error }
  },
  logout: async (_, __, { req }) => {
    try { req.session.destroy(() => false) } 
    catch (error) { throw error }
  },
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ç”¨æˆ·ç‚¹å‡»æ³¨é”€æ—¶ï¼Œæˆ‘ä»¬é”€æ¯ä¼šè¯å¹¶è¿”å› falseã€‚å½“ä½ æ‰§è¡Œ`logout`çªå˜æ—¶ï¼Œä½ åº”è¯¥å›åˆ°`null`ã€‚

çœ‹å“ªï¼ç”¨æˆ·å¯ä»¥æ³¨é”€ï¼

å› ä¸ºè¿™æ˜¯ä¸€ä¸ªè´§å¸å…‘æ¢ï¼Œå¦‚æœæˆ‘ä»¬å…è®¸ç”¨æˆ·å…‘æ¢è´§å¸å¯èƒ½æ˜¯æœ€å¥½çš„ã€‚ğŸ¤”æ‰“å¼€`typeDefs.js`å¹¶æ·»åŠ `openPosition`çªå˜ã€‚

```
// typeDefs.js

type Mutation {
  register(email: String!, password: String!, name: String!): Boolean!
  login(email: String!, password: String!): User!
  logout: Boolean
  openPosition(pair: String!, lotSize: Int, openedAt: Float!, position: String!): PairUpdateResponse!
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æŠŠ`PairUpdateResponse`åŠ åˆ°`typeDefs.js`ä¸Š:

```
// typeDefs.js

type PairUpdateResponse {
  success: Boolean!
  message: String!
  pair: Pair!
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ç”¨æˆ·è¯•å›¾æ‰“å¼€å¤´å¯¸(ä¹°å…¥/å–å‡ºä¸€ä¸ªè´§å¸å¯¹)æ—¶ï¼Œä»–ä»¬å°†å¾—åˆ°ä¸€ä¸ªæˆåŠŸå“åº”(å¯¹/é”™)ï¼Œä¸€æ¡æè¿°æ‰€é‡‡å–çš„æ“ä½œçš„æ¶ˆæ¯ï¼Œä»¥åŠå…³äºè´§å¸å¯¹çš„ä¿¡æ¯ã€‚

å°†`openPosition`çªå˜æ·»åŠ åˆ°`resolvers.js`ä¸­ã€‚

```
// resolvers.js

openPosition: async (_, { pair, lotSize, openedAt, position }, { dataSources }) => {
  try {
    const open = await dataSources.userAPI.newPosition({ 
      pair, 
      lotSize, 
      openedAt, 
      position 
    })
    return open 
  } catch (error) { throw error }
}, 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

éœ€è¦ä¸€äº›è®ºæ®ã€‚`pair`çœ‹èµ·æ¥ç±»ä¼¼äº:â€œæ¬§å…ƒ/ç¾å…ƒâ€ã€‚`lotSize`æ˜¯ä½ çš„ä»“ä½å¤§å°(ä½ åœ¨ä»“ä½ä¸ŠæŠ•å…¥äº†å¤šå°‘é’±)ã€‚`openedAt`æ˜¯ä½ ä¹°å…¥/å–å‡ºçš„ä»·æ ¼ã€‚`position`å°†æ˜¯â€œå¤šå¤´â€æˆ–â€œç©ºå¤´â€ï¼Œå–å†³äºç”¨æˆ·æ˜¯æƒ³ä¹°å¤šå¤´(èµŒä»·æ ¼ä¼šä¸Šæ¶¨)è¿˜æ˜¯å–ç©º(èµŒä»·æ ¼ä¼šä¸‹è·Œ)ã€‚

å°†`newPosition`æ–¹æ³•æ·»åŠ åˆ°`datasources/user.js`ï¼Œä½†æ˜¯é¦–å…ˆä»`apollo-server-express`å¯¼å…¥`AuthenticationError`å’Œ`ForbiddenError`ã€‚æˆ‘ä»¬è¿˜éœ€è¦å¯¼å…¥æˆ‘ä»¬çš„`Pair`æ¨¡å¼ã€‚

```
// datasources/user.js

const { 
  UserInputError, 
  AuthenticationError, 
  ForbiddenError 
} = require('apollo-server-express')

const Pair = require('../models/Pair')

async newPosition({ pair, lotSize, openedAt, position }) {
  try {
    const user = await User.findById(this.context.req.session.userId)
    if(!user) throw new AuthenticationError('Invalid Crendentials!')
    if(user.bankroll < lotSize) throw new ForbiddenError(`Insufficient funds!`)

    const newPair = new Pair({
      pair,
      lotSize,
      openedAt,
      position,
      open: true,
      user: this.context.req.session.userId
    })
    const pairResult = await newPair.save()
    user.pairs.unshift(pairResult)
    user.bankroll -= lotSize
    await user.save()
    const message = `Congrats ${user.name}! You've opened a ${position} position on ${pair} at ${openedAt}!`
    const success = true
    return { success, message, pair: pairResult }
  } catch (error) { throw error }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„é’±æ¥å®Œæˆäº¤æ˜“ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¯¹ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°`pairs`æ•°ç»„ä¸­ã€‚æˆ‘ä»¬ä»ç”¨æˆ·`bankroll`ä¸­å‡å»ä½ç½®å¤§å°ï¼Œå¹¶ä»¥`PairUpdateResponse`çš„å½¢å¼è¿”å›ä¸€ä¸ªå“åº”ã€‚

æ‰“å¼€ GraphQL Playgroundï¼Œç™»å½•å¹¶è¿è¡Œ`openPosition`çªå˜ã€‚

[![openPosition](../Images/6d5d8170f1ad34aad3e705a59c5bc0a5.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--CqyzRVrO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/openPosition.png%3Fraw%3Dtrue)

æ—¢ç„¶æˆ‘ä»¬çš„ç”¨æˆ·å¯ä»¥æ‰“å¼€ä¸€ä¸ªä½ç½®ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œæä¾›ä¸€ç§æ–¹æ³•æ¥å…³é—­ä¸Šè¿°ä½ç½®ã€‚æˆ‘ä»¬ç»™`typeDefs.js`åŠ ä¸€ä¸ª`closePosition`çªå˜ã€‚

```
// typeDefs.js

type Mutation {
  register(email: String!, password: String!, name: String!): Boolean!
  login(email: String!, password: String!): User!
  logout: Boolean
  openPosition(pair: String!, lotSize: Int, openedAt: Float!, position: String!): PairUpdateResponse!
  closePosition(id: ID!, closedAt: Float!): PairUpdateResponse!
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`closePosition`å˜å¼‚å°†å¯¹`id`å’Œé€€å‡ºä»·æ ¼(`closedAt`)ä½œä¸ºå‚æ•°ã€‚ç„¶åå®ƒä»¥`PairUpdateResponse`çš„å½¢å¼è¿”å›ä¸€ä¸ªå“åº”ã€‚

è®©æˆ‘ä»¬æ¥å¤„ç†åˆ†è§£å™¨ã€‚

```
// resolvers.js

closePosition: async(_, { id, closedAt }, { dataSources }) => {
  try {
    const close = await dataSources.userAPI.exitPosition({ id, closedAt })
    return close 
  } catch (error) { throw error }
}, 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å›åˆ°`datasource/user.js`æ‰§è¡Œ`exitPosition`æ–¹æ³•ã€‚

```
// datasources/user.js

async exitPosition({ id, closedAt }) {
  try {
    const user = await User.findById(this.context.req.session.userId) 
    if(!user) throw new AuthenticationError('Invalid credentials!')

    const pair = await Pair.findById(id) 
    if(!pair) throw new AuthenticationError('Invalid credentials!')
    if(!pair.open) throw new ForbiddenError('Transaction already complete!')
    let pipDifFloat
    pair.position === 'long' 
      ? pipDifFloat = (closedAt - pair.openedAt).toFixed(4) 
      : pipDifFloat = (pair.openedAt - closedAt).toFixed(4)   
    pair.pipDif = pipDifFloat
    pair.closedAt = closedAt
    pair.profitLoss = pipDifFloat * pair.lotSize
    pair.open = false 
    const savedPair = await pair.save()

    user.bankroll += (pair.lotSize + savedPair.profitLoss) 
    await user.save() 

    const success = true 
    const message = `${ savedPair.profitLoss > 0 
      ? 'Congrats!' 
      : ''
      }  ${user.name} you've closed your ${savedPair.position} position on ${savedPair.pair} at ${closedAt}${ savedPair.profitLoss > 0 
      ? '! For a profit of '+Math.round(savedPair.profitLoss)+'!' 
      : '. For a loss of '+Math.round(savedPair.profitLoss)+'.'}`
    return { success, message, pair: savedPair }
  }
  catch (error) { throw error }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦æˆ‘ä»¬æ‰¾åˆ°æˆ‘ä»¬çš„é…å¯¹ï¼Œæˆ‘ä»¬å°±åˆ›å»ºä¸€ä¸ªåä¸º`pipDifFloat`çš„å˜é‡ã€‚å¦‚æœ`position`å¾ˆé•¿ï¼Œæˆ‘ä»¬ä»`closedAt`ä»·æ ¼ä¸­å‡å»`openedAt`ä»·æ ¼ã€‚å¦‚æœ`position`æ˜¯ç©ºå¤´ï¼Œæˆ‘ä»¬ä»`openedAt`ä»·æ ¼ä¸­å‡å»`closedAt`ä»·æ ¼ã€‚æˆ‘ä»¬å°†ç»“æœå­˜å‚¨åœ¨`pipDifFloat`ä¸­ï¼Œç„¶åå°† pairs `pipDif`å±æ€§è®¾ç½®ä¸º`pipDifFloat`ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¾ç½®`closedAt`ä»·æ ¼ï¼Œå¹¶é€šè¿‡å°†`pipDifFloat`ä¹˜ä»¥`lotSize`æ¥è®¡ç®—`profitLoss`ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†`open`å±æ€§è®¾ç½®ä¸º`false`å¹¶ä¿å­˜æˆ‘ä»¬çš„é…å¯¹ã€‚ä¸€æ—¦æˆ‘ä»¬ä¿å­˜äº†é…å¯¹ï¼Œæˆ‘ä»¬å°±ç›¸åº”åœ°è°ƒæ•´ç”¨æˆ·`bankroll`ã€‚æœ€åï¼Œæˆ‘ä»¬è¿”å›`PairUpdateResponse`å¹¶å‘Šè¯‰ç”¨æˆ·å¥½/åæ¶ˆæ¯ã€‚

çœ‹çœ‹ GraphQL æ“åœº:

[![closePosition](../Images/2f73f21264b802ac3ba21d81972acb78.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--5Y6f_d_h--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/closePosition.png%3Fraw%3Dtrue)

æˆ‘ä»¬å–å¾—äº†ä¸€äº›é‡å¤§è¿›å±•ã€‚è®©æˆ‘ä»¬å¤šåšä¸€äº›ï¼

æˆ‘ä»¬è¿˜æœ‰ä¸¤ä¸ªç›¸å…³çš„æŸ¥è¯¢ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥å¤„ç†å®ƒä»¬ã€‚åœ¨`typeDefs.js`å†…éƒ¨ï¼Œå°†`Query`ç±»å‹è°ƒæ•´ä¸ºå¦‚ä¸‹:

```
// typeDefs.js

type Query {
  currencyPairInfo(fc: String, tc: String): PairDisplay!
  monthlyTimeSeries(fc: String, tc: String): TimeSeries!
  me: User
  findPair(id: ID!): Pair!
  getPairs: [Pair!]
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡ id è·å–ä¸€å¯¹çš„æŸ¥è¯¢ã€‚æ£€ç´¢æ‰€æœ‰ç”¨æˆ·å¯¹çš„å¦ä¸€ä¸ªæŸ¥è¯¢ã€‚è®©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è°ƒæ•´`Query`å¯¹è±¡ï¼Œä½¿å…¶ç±»ä¼¼äºä¸‹é¢çš„ä»£ç :

```
// resolvers.js

Query: {
  currencyPairInfo: async (_, { fc, tc }, { dataSources }) => {
    try {
      const currencyPairs = await dataSources.currencyAPI.getCurrencyPair(fc, tc)
      return currencyPairs
    } catch (error) { throw err }
  },
  monthlyTimeSeries: async (_, { fc, tc }, { dataSources }) => {
    try {
      const timeSeries = await dataSources.currencyAPI.getMonthlyTimeSeries(fc, tc)
      return timeSeries
    } catch (error) { throw error }
  },
  me: async (_, __, { dataSources }) => {
    try {
      const user = await dataSources.userAPI.getMe()
      return user
    } catch (error) { throw error }
  },
  findPair: async (_, { id }, { dataSources }) => {
    try {
      const foundPair = await dataSources.userAPI.getPair({ id })
      return foundPair
    } catch (error) { throw error }
  },
  getPairs: async (_, __, { dataSources }) => {
    try {
      const foundPairs = await dataSources.userAPI.findPairs()
      return [...foundPairs]
    } catch (error) { throw error }
  },
}, 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`datasources/user.js`ä¸Šå®šä¹‰`getPair`å’Œ`findPairs`ã€‚

```
// datasources/user.js

async getPair({ id }) {
  try {
    const pair = await Pair.findById(id)
    if(!pair || pair.user.toString() !== this.context.req.session.userId) { 
      throw new AuthenticationError('Invalid credentials!') 
    } 
    return pair
  } catch (error) { throw error }
}

async findPairs() {
  try {
    const pairs = await Pair
      .find({ user: this.context.req.session.userId })
      .sort({ updatedAt: -1 })
    if(!pairs.length) throw new UserInputError('Nothing to show!')
    return [...pairs] 
  } catch (error) { throw error }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨åº”è¯¥åœ¨ GraphQL Playground ä¸­çœ‹åˆ°ç±»ä¼¼çš„å†…å®¹:

[![findPair](../Images/96198ce412661161b489f72f9521a1b1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--fkjgCuQV--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/findpair.png%3Fraw%3Dtrue)

[![getPairs](../Images/c4470c5de12a587ebd034a10bcbff884.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--cRec1Nlx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/getpairs.png%3Fraw%3Dtrue)

æœ€åä¸€ä¸ªçªå˜ï¼Œæˆ‘ä»¬å®Œæˆäº†åç«¯ï¼æˆ‘ä»¬æœ€åçš„æ ‡æœ¬â€”â€”`addFunds`ã€‚ç”¨æˆ·ä¼šæƒ³æŠŠé’±åŠ åˆ°ä»–ä»¬çš„è´¦æˆ·ä¸Šã€‚æˆ‘ä»¬å†³ä¸ä¼šè®©ä»–ä»¬æ— æ‰€äº‹äº‹ã€‚

æˆ‘ä»¬å°†ä»`typeDefs.js`å¼€å§‹ã€‚åˆ›å»º`addFunds`çªå˜ï¼Œå¹¶å®šä¹‰å…¶å“åº”ç±»å‹â€” `AddFundsResponse`ã€‚

```
// typeDefs.js

type Mutation {
  register(email: String!, password: String!, name: String!): Boolean!
  login(email: String!, password: String!): User!
  logout: Boolean
  openPosition(pair: String!, lotSize: Int, openedAt: Float!, position: String!): PairUpdateResponse!
  closePosition(id: ID!, closedAt: Float!): PairUpdateResponse!
  addFunds(amount: Int!): AddFundsResponse!
}

  type AddFundsResponse {
    success: Boolean!
    message: String!
    user: User!
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`addFunds`å°†`amount`ä½œä¸ºå•ç‹¬çš„å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»é€šè¿‡`context`äº†è§£äº†ç”¨æˆ·ã€‚è®©æˆ‘ä»¬æ¥è§£å†³æœ€åä¸€ä¸ªè§£æå™¨ã€‚ä¸€æ—¦æˆ‘ä»¬å®ç°äº†`addFunds`ï¼Œæˆ‘ä»¬çš„`Mutation`å¯¹è±¡åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

```
// resolvers.js

Mutation: {
  register: async (_, { email, password, name }, { dataSources }) => {
    try {
      const newUser = await dataSources.userAPI.createNewUser({ email, password, name })
      return newUser
    } catch (error) { throw error }
  },
  login: async (_, { email, password }, { dataSources }) => {
    try {
      const user = await dataSources.userAPI.loginUser({ email, password })
      return user 
    } catch (error) { throw error }
  },
  logout: async (_, __, { req }) => {
    try { req.session.destroy(() => false) }
    catch (error) { throw error }
  },
  openPosition: async (_, { pair, lotSize, openedAt, position }, { dataSources }) => {
    try {
      const open = await dataSources.userAPI.newPosition({ pair, lotSize, openedAt, position })
      return open 
    } catch (error) { throw error }
  },
  closePosition: async(_, { id, closedAt }, { dataSources }) => {
    try {
      const close = await dataSources.userAPI.exitPosition({ id, closedAt })
      return close 
    } catch (error) { throw error }
  },
  addFunds: async (_, { amount }, { dataSources }) => {
    try {
      const weeee = await dataSources.userAPI.additionalFunds({ amount })
      return weeee
    } catch (error) { throw error }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`datasources/user.js`ä¸Š:

```
// datasources/user.js

async additionalFunds({ amount }) {
  try {
    const user = await User.findById(this.context.req.session.userId)
    if(!user) throw new AuthenticationError('Invalid credentials!')
    user.bankroll += amount 
    const savedUser = await user.save()
    const success = true
    const message = `Congrats ${user.name} you've added ${amount} to your bankroll!`
    return { bankroll: savedUser.bankroll, success, message } 
  } catch (error) { throw error }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨çš„ GraphQL æ“åœºåº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·:

[![addFunds](../Images/9cb6789caa2a5f57b61fa714ed20fa02.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--DqL45hYn--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://github.com/marlonanthony/currency_exchange/blob/master/images/addfunds.png%3Fraw%3Dtrue)

çœ‹å“ªï¼æˆ‘ä»¬å®Œæˆäº†åç«¯ï¼[å‰ç«¯](https://dev.to/marlonanthony/let-s-build-a-currency-exchange-part-ii-eh0)ç­‰å¾…ï¼

è¿™ä¸ªé¡¹ç›®çš„ä»£ç åœ¨æˆ‘çš„ GitHub ä¸Šã€‚

ä¼¸æ‰‹:[Twitter](https://twitter.com/marlonanthony10)|[Medium](https://medium.com/@marlonanthony)|[GitHub](https://github.com/marlonanthony)