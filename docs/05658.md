# RxJS ä¸­çš„â€œæ¬ºéª—æˆ–å–æ¶ˆè®¢é˜…â€:è‡ªå®šä¹‰è§’åº¦è£…é¥°å™¨

> åŸæ–‡:[https://dev . to/2 muchcoffeecom/trick-or-unsubscribe-in-rxjs-a-custom-angular-decorator-545 a](https://dev.to/2muchcoffeecom/trick-or-unsubscribe-in-rxjs-a-custom-angular-decorator-545a)

## [](#background)èƒŒæ™¯

ä¸ºä»€ä¹ˆå¯è§‚æµ‹é‡å¯¹æ‚¨çš„åº”ç”¨å¯èƒ½æ˜¯å±é™©çš„ï¼Ÿé™ä½é£é™©çš„é€‰æ‹©æœ‰å“ªäº›ï¼Ÿæ­£å¦‚ä½ å¯èƒ½å·²ç»çŒœåˆ°çš„é‚£æ ·ï¼Œæˆ‘å°†è°ˆè®ºâ€œunsubscribe()â€ï¼Œæˆ‘å°†å¾ˆè£å¹¸åœ°å‘ä½ ä»‹ç»æˆ‘çš„å®šåˆ¶è§£å†³æ–¹æ¡ˆï¼Œå®ƒæ‹¯æ•‘äº†æˆ‘çš„ä¸€ç”Ÿï¼Œä¹Ÿå¯èƒ½æ‹¯æ•‘äº†ä½ çš„ä¸€ç”Ÿã€‚

## [](#introduction-to-observables-world)å¯è§‚å¯Ÿä¸–ç•Œç®€ä»‹

Angular çš„ç¬¬ä¸€ä¸ªæ¦‚å¿µä¹‹ä¸€æ˜¯é€šè¿‡å¯è§‚æµ‹é‡çš„åŠŸèƒ½ååº”å¼ç¼–ç¨‹ã€‚Angular é€šè¿‡ RxJS åº“å¹¿æ³›ä½¿ç”¨ Observableï¼Œè¯¥åº“å¼•å…¥äº† Observable ç±»å‹çš„å®ç°ã€‚æˆ‘ä¸ä¼šåœ¨ Angular æˆ– RxJS åº“ä¸­è¯¦ç»†é˜è¿°ååº”å¼ç¼–ç¨‹çš„ä¸»é¢˜ï¼Œæˆ‘å°†åªä»‹ç»ä¸€äº›é«˜çº§åŸåˆ™ã€‚

æ ¹æ® <u>[å®˜æ–‡](http://reactivex.io/rxjs/manual/overview.html#introduction)</u>â€”â€”â€œå¯è§‚æµ‹é‡æ˜¯å¤šä¸ªå€¼çš„æ‡’æ¨é›†åˆâ€ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°æ®æµâ€”â€”ä»»ä½•æ—¶é—´å€¼çš„åºåˆ—ã€‚å› æ­¤ï¼Œå¯è§‚å¯Ÿå€¼æ˜¯æŸç§é«˜çº§æ‰¿è¯ºï¼Œéšç€æ—¶é—´æ¨ç§»ï¼Œå®ƒä¼šå°†å¤šä¸ªå€¼(è€Œä¸æ˜¯ä¸€ä¸ªå€¼)æ¨é€åˆ°å›è°ƒå‡½æ•°ã€‚

ä¸ºäº†é€šçŸ¥è§‚å¯Ÿå¯¹è±¡ä½•æ—¶å‘é€æ•°æ®ï¼Œå¹¶åœ¨å°†æ¥å¯¹æ–°æ•°æ®åšå‡ºååº”ï¼Œæˆ‘ä»¬éœ€è¦è®¢é˜…å®ƒï¼Œåªéœ€è°ƒç”¨â€œsubscribe()â€æ–¹æ³•ã€‚æ­£å¦‚æˆ‘ä¸Šé¢æåˆ°çš„ï¼Œå¯è§‚å¯Ÿå¯¹è±¡æ˜¯æŸç§æµæœ¬èº«ï¼Œè¿™æ„å‘³ç€åœ¨è®¢é˜…å®ƒä¹‹åï¼Œå®ƒçš„æ‰§è¡Œå°†æ˜¯æ— é™çš„ã€‚ä¸ºäº†å–æ¶ˆ/å®Œæˆå®ƒå¹¶â€œåƒå©´å„¿ä¸€æ ·ç¡è§‰â€ï¼Œæˆ‘ä»¬å¿…é¡»ç®€å•åœ°è°ƒç”¨ä¸€ä¸ªâ€œunsubscribe()â€æ–¹æ³•ã€‚éšå’Œå§ï¼Ÿ

ç„¶è€Œï¼Œè¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯ï¼Œå°¤å…¶æ˜¯åœ¨åˆçº§ç”¨æˆ·ä¸­ï¼Œå½“å¼€å‘äººå‘˜åªæ˜¯å¿˜è®°å–æ¶ˆè®¢é˜…æµå¹¶ç»§ç»­å‰è¿›æ—¶ã€‚ä¸€ä¸ªä¸å†è¢«ä½¿ç”¨çš„å¯è§‚å¯Ÿå¯¹è±¡ä»ç„¶ä¼šäº§ç”Ÿä»·å€¼ã€‚è¿™å°†ç›´æ¥å¯¼è‡´å·¨å¤§çš„å†…å­˜æ³„æ¼å’Œåº”ç”¨ç¨‹åºæœªæ¥ä¸å¯é¢„æµ‹çš„è¡Œä¸ºã€‚

## [](#what-are-the-advanced-options-to-unsubscribe)é€€è®¢æœ‰å“ªäº›ã€Œé«˜çº§ã€é€‰é¡¹ï¼Ÿ

æ­£å¦‚æˆ‘ä¸Šé¢æåˆ°çš„ï¼Œå¦‚æœä½ ä¸æƒ³å°„ä¼¤è‡ªå·±çš„è…¿ï¼Œä½ åº”è¯¥è®°å¾—é€€è®¢ï¼åœ¨ Angular ä¸­ï¼Œæœ€å¸¸è§çš„åœ°æ–¹æ˜¯åœ¨â€œngOnDestroyâ€ç”Ÿå‘½å‘¨æœŸæŒ‚é’©ä¸­ï¼Œä¸€æ—¦ç»„ä»¶ä¸å†ä½¿ç”¨ï¼ŒAngular å°±ä¼šæ‰§è¡Œè¯¥æŒ‚é’©ã€‚

å½“æ‚¨æœ‰ä¸€ä¸ªæˆ–ä¸¤ä¸ªè®¢é˜…æ—¶ï¼Œè¿™æ˜¯æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œä½†åœ¨çœŸæ­£çš„ Angular åº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨æœ‰å‡ åä¸ªè®¢é˜…ã€‚å½“ç„¶ï¼Œæ¯æ¬¡â€œæ‰‹åŠ¨â€é€€è®¢éƒ½å¾ˆç¹çã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿè®©æˆ‘ä»¬è€ƒè™‘ä¸€äº›å–æ¶ˆè®¢é˜…å¤šä¸ªå¯è§‚å¯Ÿå¯¹è±¡çš„â€œé«˜çº§â€å†…ç½®æ–¹æ³•:

### [](#1-chained-subscriptions)1ã€‚è¿é”è®¢é˜…:

å› ä¸º Subscription æ˜¯ä¸€ä¸ªæœ¬è´¨ä¸Šå…·æœ‰â€œunsubscribe()â€æ–¹æ³•çš„ç±»ï¼Œæ‰€ä»¥å®ƒä¹Ÿå…·æœ‰â€œadd()â€æ–¹æ³•ã€‚å®ƒå…è®¸å°†ä¸€ä¸ªè®¢é˜…â€œæ·»åŠ â€åˆ°å¦ä¸€ä¸ªè®¢é˜…ä¸­â€”â€”çˆ¶è®¢é˜…çš„å­è®¢é˜…ã€‚å› æ­¤ï¼Œæ‚¨åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ unsubscribe()æ–¹æ³•â€”â€”çˆ¶è®¢é˜…å–æ¶ˆæ‰€æœ‰å­è®¢é˜…ã€‚çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

```
export class HomeComponent implements OnInit, OnDestroy {
  sub: Subscription = new Subscription();

  constructor(
    private invoicesService: InvoicesService,
    private productsService: ProductsService,
    private customersService: CustomersService,
  ) {
  }
  ngOnInit() {
    this.sub
     .add(
       this.invoicesService.invoices$
         .subscribe(invoices => console.log(invoices))
     )
     .add(
       this.productsService.products$    
         .subscribe(products => console.log(products))
      )
     .add(
       this.customersService.products$    
         .subscribe(products => console.log(customers))
      );
  }
  ngOnDestroy() {
    this.sub.unsubscribe();
  } 
```

ç„¶è€Œï¼Œåœ¨é“¾æ¥ä¸­æœ‰ä¸€ä¸ªä¸åˆ©çš„å½±å“â€”â€”å¦‚æœä¸€ä¸ªé“¾æ¥çš„è®¢é˜…å®Œæˆäº†ï¼Œä¾‹å¦‚ products$ stream æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆå®ƒçš„ä¸‹ä¸€ä¸ªåä»£ï¼Œæˆ‘æŒ‡çš„æ˜¯ customers$ streamï¼Œå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚å› æ­¤ï¼Œæˆ‘å»ºè®®é¿å…é“¾æ¥ã€‚

### [](#2-an-array-of-subscriptions)2ã€‚ä¸€ç³»åˆ—è®¢é˜…:

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»å‹ä¸ºâ€œSubscription[]â€çš„å˜é‡ï¼Œä¾‹å¦‚â€œsubscriptionsâ€çš„åˆå§‹å€¼ä¸ºç©ºæ•°ç»„ã€‚ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª setterï¼Œä»¥é¿å…å°†æ¯ä¸ªè®¢é˜…æ‰‹åŠ¨åŒ…è£…åœ¨ä¸€ä¸ªâ€œæ¨é€â€ç»“æ„ä¸­ã€‚ä¹‹åï¼Œåœ¨ ngOnDestroy ç”Ÿå‘½å‘¨æœŸæŒ‚é’©ä¸­ï¼Œæˆ‘ä»¬ç®€å•åœ°è°ƒç”¨æ•°ç»„ä¸Šçš„ forEach()æ–¹æ³•ï¼Œå¹¶å¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªè®¢é˜…è°ƒç”¨ unsubscribe()æ–¹æ³•ã€‚æŸ¥çœ‹ä»£ç ç¤ºä¾‹:

```
export class HomeComponent implements OnInit, OnDestroy {

  subscriptions: Subscription[] = [];

  private set sub (sub: Subscription) {
    this.subscriptions.push(sub);
  }

  constructor(
    private invoicesService: InvoicesService,
    private productsService: ProductsService,
  ) {
  }

  ngOnInit() {
    this.sub = this.invoicesService.invoices$
      .subscribe(invoices => console.log(invoices));

    this.sub = this.productsService.products$
      .subscribe(products => console.log(products));
  }
  ngOnDestroy() {
    this.subscriptions.forEach(sub => sub.unsubscribe());
  }
} 
```

> ### [](#3-rxjs-subject-and-takeuntil-operator)3 .RxJSâ€œä¸»é¢˜â€å’Œ"ç›´åˆ°"è¿ç®—ç¬¦:

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå˜é‡/æµï¼Œä¾‹å¦‚ï¼Œç”¨ RxJS Subject çš„ä¸€ä¸ªæ–°å®ä¾‹æ¥å–æ¶ˆè®¢é˜…$ã€‚ç„¶åï¼Œåœ¨ä»»ä½•å…¶ä»–æµçš„ç®¡é“é“¾å†…éƒ¨ï¼Œæˆ‘ä»¬å£°æ˜â€œtakeUntilâ€æ“ä½œç¬¦ï¼Œåªéœ€å°†æˆ‘ä»¬çš„ unsubscribe$ stream ä¼ é€’ç»™å®ƒã€‚ä¹‹åï¼Œåœ¨ ngOnDestroy ç”Ÿå‘½å‘¨æœŸé’©å­ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ next()å’Œ complete()å›è°ƒæˆ‘ä»¬çš„ä¸»é¢˜ã€‚è¿™æ„å‘³ç€å½“æˆ‘ä»¬çš„ç»„ä»¶è¢«é”€æ¯æ—¶ï¼Œæ‰€æœ‰çš„è®¢é˜…è€…è‡ªåŠ¨åœæ­¢æ¥æ”¶æœªæ¥å€¼ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä¸»é¢˜å°†è¢«å®Œæˆã€‚è®©æˆ‘ä¸ºæ‚¨æä¾›ä¸€ä¸ªä»£ç ç¤ºä¾‹:

```
export class HomeComponent implements OnInit, OnDestroy {

  unsubscribe$: Subject<void> = new Subject();

  constructor(
    private invoicesService: InvoicesService,
    private productsService: ProductsService,
  ) {
  }

  ngOnInit() {
    this.invoicesService.invoices$
      .pipe(
        takeUntil(this.unsubscribe$)
      )
      .subscribe(invoices => console.log(invoices));

    this.productsService.products$
      .pipe(
        takeUntil(this.unsubscribe$)
      )
      .subscribe(products => console.log(products));
  }

  ngOnDestroy() {
    this.unsubscribe$.next();
    this.unsubscribe$.complete();
  }
} 
```

> ### 4ã€‚ Rxjs "Asynchronous Pipeline":

ç„¶è€Œï¼Œè¿™æ˜¯æœ€åä¸€ä¸ªï¼Œä¹Ÿæ˜¯ Observables ä¸­æœ€å¯é ã€æœ€ç®€æ´ã€æœ€æ­£ç¡®çš„å†…ç½®é€€è®¢é€‰é¡¹ã€‚â€œAsyncPipeâ€è‡ªåŠ¨è®¢é˜…ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ï¼Œè¿”å›å®ƒå‘å‡ºçš„æœ€æ–°å€¼ï¼Œå¹¶åœ¨ç»„ä»¶è¢«é”€æ¯æ—¶å–æ¶ˆè®¢é˜…ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹æƒ…ã€‚æ‰€æœ‰é¿å…å†…å­˜æ³„æ¼çš„æ¸…ç†é€»è¾‘éƒ½æ˜¯åœ¨å¹•åå®Œæˆçš„ã€‚å¤ªç¥å¥‡äº†ï¼è¯·çœ‹ä¸‹é¢çš„ä¸€ä¸ªä¾‹å­:

```
export class InvoicesComponent implements OnInit {

  invoices$: Observable<Invoice[]>;

  constructor(
    private invoicesService: InvoicesService,
  ) {
  }

  ngOnInit() {
    this.invoices$ = this.invoicesService.invoices$;
  }
} 
```

```
<main class="invoices-main">

    <mat-table [dataSource]='invoices$ | async'>
....
    </mat-table> 
<main/> 
```

## [](#why-have-i-come-to-a-custom-solution-and-what-are-the-decorators-itself)æˆ‘ä¸ºä»€ä¹ˆè¦å®šåˆ¶è§£å†³æ–¹æ¡ˆï¼Œè£…é¥°è€…æœ¬èº«æ˜¯ä»€ä¹ˆï¼Ÿ

AsyncPipe æ˜¯å¯é çš„ï¼Œè¿è¡Œè‰¯å¥½ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬ç»å¸¸ä¸ä»…ä»…æ˜¯ç®€å•åœ°è®¢é˜…ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡å¹¶å‘ˆç°è¾“å‡ºï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ subscribe()æ–¹æ³•ä¸­åŠ å…¥ä¸€äº›é€»è¾‘ã€‚å› æ­¤ï¼Œæ¯æ¬¡æˆ‘ä»¬éƒ½å¿…é¡»åœ¨ç»„ä»¶ä¸­é‡å¤å®ç°ä¸Šé¢æåˆ°çš„é«˜çº§é€€è®¢é€‰é¡¹ä¹‹ä¸€ã€‚

æ‰€ä»¥ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œæˆ‘å†³å®šä¸è¦åœ¨è®¸å¤šç»„ä»¶ä¸­æ‰‹å·¥åšâ€œçŒ´å­å·¥ä½œâ€ã€‚æˆ‘è®¤ä¸ºå°†æ‰€æœ‰å–æ¶ˆè®¢é˜…çš„é€»è¾‘æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œå¹¶åœ¨æˆ‘éœ€è¦æ—¶é‡ç”¨å®ƒä¼šå¾ˆå¥½ï¼Œæ­¤å¤–è¿˜å¯ä»¥ä½¿æˆ‘çš„ä»£ç æ›´å¹²å‡€å’Œå¯ç»´æŠ¤ã€‚è€Œä¸”ï¼Œå¤šäºäº†æ‰“å­—ç¨¿ï¼Œæˆ‘æ‰¾åˆ°äº†æ­£ç¡®ã€æ•´æ´å’Œâ€œæ£±è§’åˆ†æ˜â€çš„åœ°æ–¹â€”â€”ä¸€ä¸ªå®¤å†…è£…æ½¢å¸ˆã€‚ä½ å¯èƒ½å·²ç»çŸ¥é“è£…é¥°è€…åœ¨æ•´ä¸ª Angular ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœä½ ä¸çŸ¥é“è£…é¥°è€…æœ¬èº«æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”é—®ä½ è‡ªå·±å¼•æ“ç›–ä¸‹çš„é­”æ³•æ˜¯ä»€ä¹ˆï¼Œè®©æˆ‘éå¸¸ç®€è¦åœ°è§£é‡Šä¸€ä¸‹ã€‚

ä¸€èˆ¬æ¥è¯´ï¼ŒDecorator çš„ä¸»è¦æ€æƒ³æ˜¯æ‚¨å¯ä»¥åŠ¨æ€åœ°å‘å¯¹è±¡é™„åŠ é™„åŠ åŠŸèƒ½ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œåœ¨ Typescript ä¸­ï¼Œè£…é¥°å™¨æ˜¯ä¸€ä¸ªå¸¦æœ‰å‚æ•°çš„çº¯å‡½æ•°ï¼Œç”±@ sign è°ƒç”¨ï¼Œå¯ä»¥é™„åŠ åˆ°:

*   ç­çº§ï¼›

*   æ–¹æ³•ï¼›

*   å±æ€§ï¼›

*   å‚æ•°ï¼›

*   å­˜å–å™¨ã€‚

ä¸ºäº†ä»¥é˜²ä¸‡ä¸€ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„ç±»å†…ç¤ºä¾‹:

```
function Log() {
  console.log(arguments);
}

@Log
export class HomeComponent {
  ...
}
// printed to console:
// {'0': [Function: HomeComponent]} 
```

æ€»è€Œè¨€ä¹‹ï¼Œè£…é¥°è€…åªæ˜¯å¸®åŠ©å®šåˆ¶ä»–ä»¬åœ¨è®¾è®¡æ—¶é™„åŠ çš„ä¸œè¥¿ã€‚è®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘å¾ˆä¹æ„å±•ç¤ºå’Œæè¿°æˆ‘è‡ªå·±çš„å–æ¶ˆè®¢é˜… Observables çš„è£…é¥°å™¨ï¼Œæˆ‘ç§°ä¹‹ä¸ºâ€œDestroySubscribersâ€ã€‚

## [](#my-custom-destroysubscribers-decorator)æˆ‘çš„è‡ªå®šä¹‰@DestroySubscribers() decorator

æˆ‘çœŸçš„å¾ˆå–œæ¬¢ RxJSï¼Œä½†æˆ‘å·²ç»å†³å®šè‡ªåŠ¨åŒ–å–æ¶ˆè®¢é˜…è¿‡ç¨‹ï¼Œå¹¶åœ¨ç±»è£…é¥°å™¨å’Œâ€œè®¢é˜…æ•°ç»„â€æ–¹æ³•å®ç°çš„å¸®åŠ©ä¸‹æ¸…ç†æˆ‘çš„ä»£ç ã€‚

æŸ¥çœ‹â€œDestroySubscribersâ€è£…é¥°å™¨æœ¬èº«:

```
export function DestroySubscribers(params?) {

 return function (target) {
   params = {
     destroyFunc: 'ngOnDestroy',
     ...params
   };
   const unsubscribableLike: {subscriptions: Unsubscribable[], unsubscribe: () => void} = {
     subscriptions: [],
     unsubscribe,
   };
   const subscriber: string = Reflect.getMetadata('subscription:name', target.prototype, 'subscriber');

   Object.defineProperty(target.prototype, subscriber ? subscriber : 'subscriber', {
     get: () => unsubscribableLike,
     set: subscription => unsubscribableLike.subscriptions.push(subscription),
   });

   if (typeof target.prototype[params.destroyFunc] !== 'function') {
     throw new Error(`${target.prototype.constructor.name} must implement ${params.destroyFunc}() lifecycle hook`);
   }

   target.prototype[params.destroyFunc] = ngOnDestroyDecorator(target.prototype[params.destroyFunc]);

   function ngOnDestroyDecorator(f) {
     return function () {
       unsubscribe();
       return f.apply(this, arguments);
     };
   }

   function unsubscribe() {
     do {
       const sub: Unsubscribable = unsubscribableLike.subscriptions.shift();
       if ( sub && typeof sub.unsubscribe === 'function') { sub.unsubscribe(); }
     } while (unsubscribableLike.subscriptions.length);
   }

   return target;
 };
}

export function CombineSubscriptions(params?) {
 return function (target, propertyKey: string | symbol) {
   Reflect.defineMetadata('subscription:name', propertyKey, target, 'subscriber');
 };
} 
```

ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œâ€œ@DestroySubscribers()â€è£…é¥°å™¨ä»£è¡¨äº†ä¸€ä¸ªâ€œè®¢é˜…æ•°ç»„â€æ–¹æ³•ï¼Œç”¨â€œ@CombineSubscriptions()â€è£…é¥°å™¨è¿›è¡Œäº†æ‰©å±•ï¼Œç°åœ¨ä¸€åˆ‡éƒ½åœ¨å¹•åå®Œæˆäº†ã€‚æˆ‘æ¥ç®€å•æè¿°ä¸€ä¸‹å®ƒçš„ä¸»è¦ä»£ç ç‚¹ã€‚

é¦–å…ˆï¼Œæˆ‘ç”¨ä¸€ä¸ªç©ºæ•°ç»„åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨äºå°†æ¥çš„è®¢é˜…å’Œè‡ªå®šä¹‰çš„å–æ¶ˆè®¢é˜…æ–¹æ³•ï¼Œä»¥ä¾¿èƒ½å¤Ÿä¸€æ¬¡æ‰‹åŠ¨å–æ¶ˆæ‰€æœ‰è®¢é˜…ã€‚ç„¶ååœ¨ <u>[reflect-metadata](https://www.npmjs.com/package/reflect-metadata)</u> åº“å’Œâ€œ@CombineSubscriptionsâ€è£…é¥°å™¨çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»ç±»ä¸­è·å¾—äº†å½“å‰çš„å±æ€§åï¼Œæˆ–è€…å°†â€œsubscriberâ€æŒ‡å®šä¸ºé»˜è®¤åç§°ï¼Œå¹¶åˆ›å»º getter å’Œ setter æ–¹æ³•ã€‚ä¹‹åï¼Œæˆ‘åˆ›å»ºäº†å¦ä¸€ä¸ªç‰ˆæœ¬çš„ ngOnDestroy ç”Ÿå‘½å‘¨æœŸæŒ‚é’©ï¼Œé¦–å…ˆå–æ¶ˆå¯¹æ•°ç»„ä¸­æ‰€æœ‰è®¢é˜…çš„è®¢é˜…ï¼Œç„¶åè°ƒç”¨å¹¶è¿”å›é»˜è®¤çš„åŸå§‹ ngOnDestroy æ–¹æ³•æˆ–ä¼ é€’ç»™ Decorator çš„é…ç½®ä¸­æŒ‡å®šçš„å¦ä¸€ä¸ªâ€œé”€æ¯å‡½æ•°â€ã€‚å°±æ˜¯è¿™æ ·â€”â€”ç›¸å½“ç®€æ´æ˜“ç”¨ã€‚ğŸ¤“

å¹¶ä¸”è£…é¥°å™¨çš„å®ç°æ›´åŠ ç®€å•ã€‚çœ‹çœ‹è¿™ä¸ª:

```
@DestroySubscribers({
  destroyFunc: 'ngAfterViewInit',
})
export class HomeComponent implements OnInit, AfterViewInit {

  /*
   Within the @CombineSubscriptions Decorator, you can choose any custom name that you prefer.
   Without the @CombineSubscriptions Decorator, the name by default is 'subscriber'.
  */
  @CombineSubscriptions()
  private subscriber: Unsubscribable;

  constructor(
    private invoicesService: InvoicesService,
    private productsService: ProductsService,
  ) {
  }

  ngOnInit() {
    this.subscriber = this.invoicesService.invoices$
      .subscribe(invoices => console.log(invoices));

    this.subscriber = this.productsService.products$
      .subscribe(products => console.log(products));
  }

  /*
   This method must be declared, even if it's empty.
   Otherwise, the Decorator would throw an Error.
  */
  ngAfterViewInit() {
   console.log('for unsubscribing');
  }
} 
```

> ### Main definition of destroy subscribers decorator:

*   **â€œsubscriberâ€**-é»˜è®¤æƒ…å†µä¸‹ä»£è¡¨æ¯ä¸ªè®¢é˜…çš„åç§°çš„å˜é‡ï¼Œç¬¦åˆä¸å¯è®¢é˜…çš„æ¥å£ã€‚æ¯æ¬¡å½“ä½ ç»™â€œsubscribeâ€å˜é‡åˆ†é…ä¸€ä¸ªè®¢é˜…æ—¶â€”â€”å®ƒè¢«è‡ªåŠ¨æ¨é€åˆ°åº•å±‚çš„è®¢é˜…æ•°ç»„ä¸­ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨å¸Œæœ›åœ¨ç»„ä»¶é”€æ¯ä¹‹å‰ä¸€æ¬¡æ‰‹åŠ¨å–æ¶ˆè®¢é˜…æ‰€æœ‰è®¢é˜…ï¼Œå¯ä»¥å¯¹â€œsubscriberâ€å˜é‡è°ƒç”¨ unsubscribe()æ–¹æ³•ã€‚

*   **" @ combine subscriptions()" Decorator**-å¦‚æœæ‚¨æƒ³è¦æ›´æ”¹è®¢é˜…çš„é»˜è®¤å˜é‡å(â€œsubscriberâ€)å¹¶ä½¿ç”¨æ‚¨è‡ªå·±çš„è‡ªå®šä¹‰åç§°ï¼Œè¯·å®ç°æ­¤ Decoratorï¼Œå¦åˆ™ä¸è¦åº”ç”¨å®ƒã€‚

*   {destroyFunc:' ... '} -å°†æ­¤å‚æ•°æ·»åŠ åˆ°â€œ@ destroy subscribersâ€Decorator ä¸­ï¼Œå¸¦æœ‰ä¸€ä¸ªç”¨äºè‡ªåŠ¨é€€è®¢çš„é’©å­çš„åç§°ï¼Œä»¥é˜²æ‚¨æƒ³è¦æ›´æ”¹é»˜è®¤çš„é‚£ä¸ªâ€”â€”â€œngOnDestroyâ€ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œå¦åˆ™ä¸è¦åº”ç”¨å®ƒã€‚å½“ä¸€ä¸ªç»„ä»¶è¢«é”€æ¯æ—¶ï¼Œæ›´æ”¹è¢«è°ƒç”¨çš„å‡½æ•°çš„èƒ½åŠ›ä½¿æ‚¨æœ‰æœºä¼šä¸ä»…åœ¨ä¸€ä¸ªè§’åº¦èŒƒå›´å†…ä½¿ç”¨è¿™ä¸ªè£…é¥°å™¨ã€‚

### destroy subscribers è£…é¥°å™¨çš„å®ç°æ­¥éª¤:

é¦–å…ˆï¼Œæ‚¨å¿…é¡»ç”¨â€œ@ destroy subscribers()â€Decorator æ³¨é‡Šè¯¥ç±»ã€‚

å…¶æ¬¡ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªåä¸ºâ€œsubscriberâ€çš„å˜é‡ï¼Œé»˜è®¤æƒ…å†µä¸‹è¯¥å˜é‡çš„ç±»å‹ä¸º unsubscribeï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªå·±çš„è‡ªå®šä¹‰åç§°ï¼Œåªéœ€ç”¨â€œ@ combine subscriptions()â€Decorator æ³¨é‡Šè¯¥å˜é‡ã€‚

ç¬¬ä¸‰ï¼Œå½“ç»„ä»¶ä¸å†ä½¿ç”¨æ—¶ï¼Œæ‚¨åº”è¯¥å°†æ‚¨æƒ³è¦å–æ¶ˆè®¢é˜…çš„æ¯ä¸ªè®¢é˜…åˆ†é…ç»™è¯¥å˜é‡ã€‚

æœ€åï¼Œä½ å¿…é¡»åœ¨ä¸€ä¸ªç»„ä»¶ä¸­å£°æ˜ ngOnDestroy ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œå³ä½¿å®ƒæ˜¯ç©ºçš„ï¼Œå› ä¸º AOT ç¼–è¯‘ã€‚å¦åˆ™ï¼Œè£…é¥°å™¨ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚å¦‚æœæ‚¨å°†é»˜è®¤çš„ç”Ÿå‘½å‘¨æœŸæŒ‚é’©(ngOnDestroy)æ›´æ”¹ä¸ºå¦ä¸€ä¸ª(ngAfterViewInit ),é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å¿…é¡»åœ¨ä¸€ä¸ªç»„ä»¶ä¸­å£°æ˜ï¼Œå¹¶ä¸” ngOnDestroy æ˜¾ç„¶æ˜¯å¯é€‰çš„ã€‚æˆ‘å‘Šè¯‰è¿‡ä½ ï¼Œè¿™å¤ªå®¹æ˜“äº†ï¼

## [](#conclusion)ç»“è®º

æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘æƒ³æ¦‚è¿°ä¸€ä¸‹ï¼Œè£…é¥°è€…æœ¬èº«æ²¡æœ‰ä»€ä¹ˆå¯æ€•çš„ï¼Œè€Œæ˜¯ä½ åº”è¯¥ä½¿ç”¨çš„éå¸¸ç¥å¥‡çš„å·¥å…·ã€‚å®ƒä»¬è‚¯å®šä¼šä½¿ä½ çš„ä»£ç æ›´åŠ å¯é‡ç”¨ã€ç®€æ´å’Œå¯è¯»ï¼

æ­¤å¤–ï¼Œæ„Ÿè°¢ Angular ç¤¾åŒºéšç€æ—¶é—´çš„æ¨ç§»å‡ºç°äº†è®¸å¤šä¸åŒçš„é€€è®¢è§£å†³æ–¹æ¡ˆã€‚æ‰€æœ‰è¿™äº›éƒ½å€¼å¾—æ³¨æ„ï¼Œè®©æˆ‘ä»¬çš„æ—¥å¸¸ç”Ÿæ´»å˜å¾—æ›´åŠ è½»æ¾ï¼ä½†æ˜¯ï¼Œå¦‚æœä½ è§‰å¾—æˆ‘çš„æ–¹æ³•æœ‰ç”¨ï¼Œè¯·ä¸è¦çŠ¹è±«å‘è¡¨è¯„è®ºï¼Œé¼“æŒå¹¶å®‰è£…æ¥è‡ª<u>[NPM(ngx-destroy-subscribers](https://www.npmjs.com/package/ngx-destroy-subscribers)</u>)çš„â€œ@DestroySubscribers()â€è£…é¥°å™¨ã€‚

éå¸¸æ„Ÿè°¢ä½ ä»¬èŠ±æ—¶é—´é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼ğŸ‘

å–œæ¬¢å—ï¼Ÿæˆ‘ä»¬å·²ç»å°½åŠ›äº†ï¼å»æˆ‘ä»¬çš„ <u>[åšå®¢](https://2muchcoffee.com/blog/)</u> æ‰¾æ›´å¤šæœ‰ç”¨çš„æ–‡ç« ã€‚