# å‡å°‘ç²¾ç¥ç–²åŠ³:NestJS + ObjectionJS

> åŸæ–‡ï¼š<https://dev.to/thisdotmedia/reducing-mental-fatigue-nestjs-objectionjs-3aef>

## å¯¼è¨€

ä½ ä¼šå‘ç°è¿™ç¯‡æ–‡ç« çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½æ˜¯å…³äºä»€ä¹ˆè®©æˆ‘å–œæ¬¢æˆ‘çš„å·¥ä½œã€‚

ä½†æ˜¯ï¼Œæ‚¨è¿˜å°†å¼„æ¸…æ¥šå¦‚ä½•å¼€å§‹å¯¹ Nest ä½¿ç”¨å¼‚è®®ï¼Œä»¥åŠå®ƒä»¬éƒ½æ˜¯å…³äºä»€ä¹ˆçš„ã€‚æˆ‘ä¸ä¼šè¯¦ç»†è§£é‡Š Nest æˆ– Objection æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚æˆ‘è®¤ä¸ºè¿™ä¸¤ä¸ªæ–‡æ¡£éå¸¸æœ‰è¶£ï¼Œå€¼å¾—ç ”ç©¶ï¼Œä½†æ˜¯æˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä¸€èµ·ä½¿ç”¨å®ƒä»¬ğŸ˜Œ

## â˜ï¸å…ˆå†³æ¡ä»¶

æ‚¨éœ€è¦åœ¨æœ¬åœ°å®‰è£… PostgreSQLã€‚è¿™å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°ï¼Œä½†æˆ‘å»ºè®®ä¸¤ç§æ–¹æ³•:

1.  ä½ å¯ä»¥å®‰è£… docker [ [Windows](https://docs.docker.com/docker-for-windows/install/) ã€ [macOS](https://docs.docker.com/docker-for-mac/install/) ã€ [Ubuntu](https://linuxize.com/post/how-to-install-and-use-docker-on-ubuntu-18-04/) å¹¶æ‰§è¡Œæœ¬æ–‡åé¢æè¿°çš„`package.json`è„šæœ¬ã€‚å®ƒå®é™…ä¸Šæ˜¯åœ¨ docker å®¹å™¨ä¸­è¿è¡Œ PostgreSQLï¼Œä¸€æ—¦æ‚¨åœ¨ç»ˆç«¯ä¸­ç‚¹å‡»`ctrl+c`å°±ä¼šç ´åå®ƒ

2.  ä½ å¯ä»¥æŠŠå®ƒç›´æ¥å®‰è£…åœ¨ä½ çš„æœºå™¨ä¸Š(å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£…çš„è¯ï¼Œæˆ‘æ¨èé€‰æ‹© 1)

## ğŸ’†å¿ƒç†ç–²åŠ³

å¦‚ä»Šï¼Œè®¸å¤šç¨‹åºå‘˜åœ¨è½¯ä»¶å¼€å‘ä¸­é¢ä¸´ç²¾ç¥ç–²åŠ³ã€‚è¿™ä¸ä»…ä»…æ˜¯å› ä¸ºæ¯åˆ†é’Ÿéƒ½ä¼šå‡ºç°æ–°çš„å·¥å…·ã€æ–¹æ³•å’ŒèŒƒä¾‹ã€‚

å¯¹äºæ¯ä¸ªæ–°çš„è½¯ä»¶å¼€å‘é¡¹ç›®(å‡è®¾æ˜¯åç«¯åº”ç”¨ç¨‹åºï¼Œå› ä¸ºæˆ‘æ›´åƒæ˜¯åç«¯äººå‘˜)ï¼Œç¨‹åºå‘˜æˆ–å›¢é˜Ÿåº”è¯¥å†³å®šå„ç§äº‹æƒ…:

*   Web æ¡†æ¶
*   é¡¹ç›®ç»“æ„
*   æ—æŒºè§„åˆ™ã€ä»£ç æ ¼å¼(åŸºäºè°·æ­Œã€Airbnbã€å¾®è½¯æˆ–æœ¬åœŸæƒ¯ä¾‹)
*   æ•°æ®å­˜å‚¨(SQLï¼ŒNoSQL)
*   éƒ¨ç½²å¹³å°(äºšé©¬é€Šã€è°·æ­Œäº‘ã€Azureã€Netlify ç­‰ã€‚)
*   CI/CD
*   æµ‹è¯•å·¥å…·å’Œç­–ç•¥
*   è¯æ˜æ–‡ä»¶
*   è¯¸å¦‚æ­¤ç±»...

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œè¿™ä¸ªåˆ—è¡¨ä¼šè¶Šæ¥è¶Šé•¿ã€‚è¿™ä¸€è¿‡ç¨‹æ¶‰åŠå¤§é‡é«˜å±‚å†³ç­–ï¼Œè€Œä¸æ˜¯æ•°ç™¾ä¸‡ä¸ªå°å†³ç­–ã€‚

åšå‡ºçš„æ¯ä¸€ä¸ªå†³å®šéƒ½ä¼šè€—å°½æˆ‘ä»¬çš„ç²¾ç¥èƒ½é‡ï¼Œå³ä½¿æ˜¯å¾®ä¸è¶³é“çš„å†³å®šã€‚åœ¨åšäº†è®¸å¤šå°å†³å®šä¹‹åï¼Œæˆ‘ä»¬å°±ä¸å¤ªå¯èƒ½åšå‡ºå¥½çš„é‡å¤§å†³å®šäº†ã€‚

æˆ‘ä»¬ç°åœ¨åœ¨ JavaScript ä¸–ç•Œä¸­æ‹¥æœ‰çš„å·¥å…·æ™¯è§‚æ˜¯ä¸€ä»¶å¥½äº‹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä»¶åäº‹ã€‚ä¸€æ–¹é¢ï¼Œå®ƒä½¿æˆ‘ä»¬åšå‡ºæ›´å¤šçš„å†³å®šï¼Œå¦ä¸€æ–¹é¢ï¼Œå®ƒä¹Ÿä¸ºæˆ‘ä»¬å¸¦æ¥äº†è®¸å¤šå¥½çš„å†³å®šï¼Œè¿™äº›å†³å®šå¾—åˆ°äº†æˆåƒä¸Šä¸‡å¼€å‘äººå‘˜çš„ä¿¡ä»»ã€‚

é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åˆ©ç”¨è¿™ä¸ªæœºä¼šæ¥å‡å°‘æˆ‘ä»¬çš„ç²¾ç¥ç–²åŠ³ï¼Œå‡å°‘æˆ‘ä»¬é€šè¿‡é‡‡çº³ç»è¿‡å……åˆ†è¯æ˜çš„æ„è§è€Œåšå‡ºçš„å†³å®šçš„æ•°é‡å‘¢ï¼Ÿ

é€šè¿‡é€‰æ‹©æ­£ç¡®çš„å·¥å…·ï¼Œæˆ‘ä»¬æœ‰æœºä¼šå¼€å‘ä¸€ä¸ªæ˜“äºæ¨ç†å¹¶è®©æ–°äººå‚ä¸çš„é¡¹ç›®ã€‚

å‡ ä¹æ‰€æœ‰çš„åç«¯é¡¹ç›®éƒ½æ˜¯å»ºç«‹åœ¨æŸç§ web æ¡†æ¶å’Œ ORM ä¹‹ä¸Šçš„ï¼Œå®ƒä»¬ä¼šä¸¥é‡å½±å“æœªæ¥çš„é¡¹ç›®æ¶æ„ã€‚

æˆ‘ä»¬å°†çœ‹çœ‹å®ƒä»¬å¦‚ä½•ç®€åŒ–æˆ‘ä»¬åœ¨å¤´è„‘ä¸­å»ºç«‹çš„å¿ƒæ™ºæ¨¡å‹ï¼Œå¹¶å‡å°‘æˆ‘ä»¬é€šå¸¸å¿…é¡»åšå‡ºçš„å†³å®šçš„æ•°é‡ã€‚æˆ‘ä»¬å°†ä¸ºç¬”è®°åº”ç”¨ç¨‹åºå¼€å‘ä¸€ä¸ªç®€å•çš„(ä½†è¶³ä»¥å±•ç¤º Nest å’Œ Objection çš„å¼ºå¤§åŠŸèƒ½)åç«¯ã€‚

## ğŸ•¸ï¸ç½‘ç»œæ¡†æ¶

åœ¨ Node.js é¢†åŸŸæœ‰å¾ˆå¤šå¯ç”¨çš„ web æ¡†æ¶: *Expressã€å“ˆæ¯”ç¥ã€Koaã€Fastifyã€Restifyã€*ç­‰ã€‚ä»–ä»¬æ˜¯çµæ´»çš„å’Œç»è¿‡æ—¶é—´è€ƒéªŒçš„äººï¼Œå…è®¸ä½ ä»¥å¤šç§ä¸åŒçš„æ–¹å¼æ„å»ºä¸€ä¸ªé¡¹ç›®ã€‚

å› æ­¤ï¼Œæ‚¨éœ€è¦å†³å®šå¦‚ä½•ç»„ç»‡è·¯ç”±ã€å¤„ç†ç¨‹åºã€è§†å›¾ã€è®¤è¯ã€æœåŠ¡ã€å­˜å‚¨åº“ç­‰ã€‚è¿™ç»™äº†ä½ å¾ˆå¤šè‡ªç”±ï¼Œä½†ä¹Ÿæœ‰ä»£ä»·ã€‚æ‚¨éœ€è¦åšå‡ºå¤§é‡å†³ç­–æ¥æ­£ç¡®æ„å»ºåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”é¡¹ç›®çš„ç»„ç»‡æ–¹å¼åœ¨ä»»ä½•å…¶ä»–ä½¿ç”¨ç›¸åŒæ¡†æ¶æ„å»ºçš„é¡¹ç›®ä¸­éƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œå› ä¸ºæ–°é¡¹ç›®çš„å¼€å‘äººå‘˜åšå‡ºå†³ç­–çš„æ–¹å¼ç•¥æœ‰ä¸åŒã€‚

ä½ å¿…é¡»ä»å¤´å†æ¥ï¼ŒæŒæ¡è¿™ä¸ªæ¡†æ¶åœ¨ç‰¹å®šé¡¹ç›®ä¸­çš„ä½¿ç”¨æ–¹å¼ã€‚ä½ æ­£åœ¨å¤±å»ä½ åœ¨å‰ä¸€ä¸ªé¡¹ç›®ä¸­å‘å±•èµ·æ¥çš„é‚£ç§ç†Ÿæ‚‰æ„Ÿå’Œæ„è¯†ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œæ¡†æ¶çŸ¥è¯†è½¬æ¢çš„æ°´å¹³æ²¡æœ‰é‚£ä¹ˆé«˜ã€‚

å¯¹æˆ‘ä¸ªäººæ¥è¯´ï¼Œè¿™äº›æ¡†æ¶ç¼ºå°‘ä¸€ä¸ªé‡è¦çš„ä¸œè¥¿(å°½ç®¡æˆ‘è®¤ä¸ºå®ƒä»¬éå¸¸å¼ºå¤§)â€”â€”ä¸€ä¸ªå…±äº«çš„æ¦‚å¿µåŸºç¡€ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œä½ å¯ä»¥å¼€å§‹å‘å±•ä¸€ä¸ªå®é™…çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™ä¸ªåŸºç¡€å°†åœ¨é¡¹ç›®ä¹‹é—´é‡å¤ï¼Œå¹¶å…è®¸æ–°å¼€å‘äººå‘˜å¿«é€Ÿç†Ÿæ‚‰ä»£ç åº“ã€‚

è¿™æ ·çš„æ¦‚å¿µåŸºç¡€å…è®¸å¢åŠ æ¡†æ¶çš„çŸ¥è¯†è½¬æ¢ï¼Œå¹¶å‡å°‘å¼€å§‹ä½¿ç”¨å®ƒæ‰€éœ€çš„è„‘åŠ›åŠ³åŠ¨ã€‚

æˆ‘è¯´çš„**æ¦‚å¿µåŸºç¡€**æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå®ƒæ˜¯æ¡†æ¶ç»™ä½ çš„ä¸€ç»„æœ€å°çš„æ¦‚å¿µæˆ–æ„å»ºå—ã€‚å¦‚æœè¿™äº›æ„å»ºå—ä¸æ‚¨éœ€è¦å¼€å‘çš„ä¸œè¥¿å¾ˆå¥½åœ°ç»“åˆèµ·æ¥ï¼Œé‚£ä¹ˆå°±å¾ˆå®¹æ˜“å¯¹é¡¹ç›®è¿›è¡Œæ¨ç†ï¼Œå¹¶å°†å…¶ä¸åŒçš„éƒ¨åˆ†ä¼ è¾¾ç»™å…¶ä»–å›¢é˜Ÿæˆå‘˜(æ— è®ºæ˜¯ç»éªŒä¸°å¯Œçš„å¼€å‘äººå‘˜è¿˜æ˜¯æ–°æ‰‹)ã€‚

å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ ·çš„æ¡†æ¶å°±æ˜¯[å·¢](https://nestjs.com)ï¼å®ƒæ˜¯ç”¨æ‰“å­—ç¨¿å†™çš„ï¼Œæœ‰å¾ˆå¥½çš„ã€ç®€æ´çš„æ–‡æ¡£ã€‚æ‰€ä»¥å¯¹äºé‚£äº›ä¸å–œæ¬¢é˜…è¯»å†—é•¿æ‰‹å†Œçš„äºº(æˆ‘ä¸å–œæ¬¢)ï¼Œè¿™ç¯‡æ–‡æ¡£æä¾›äº†è¶³å¤Ÿçš„ä¿¡æ¯å’Œä¾‹å­æ¥å®Œæˆè¿™é¡¹å·¥ä½œâ€”â€”ä¸å¤šä¹Ÿä¸å°‘ã€‚

Nest çš„æ¨¡å—ç³»ç»Ÿæ·±å— Angular çš„å¯å‘ï¼Œæ‰€ä»¥ Angular å¼€å‘äººå‘˜é˜…è¯» Nest ä»£ç åº”è¯¥ä¼šå¾ˆèˆ’æœã€‚Angular å’Œ Nest é€šå¸¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç»„åˆï¼Œå› ä¸ºå®ƒä»¬çš„æ¦‚å¿µåŸºç¡€æœ‰å¾ˆé«˜çš„äº¤é›†ï¼Œä½ å¯ä»¥å°†ä½ çš„ä¸€äº›è§’åº¦çŸ¥è¯†è½¬ç§»åˆ° Nestã€‚

æˆ‘ä¸æƒ³é‡å¤è¿™äº›æ–‡ä»¶ï¼Œé¼“åŠ±ä½ è‡ªå·±å»çœ‹ä¸€çœ‹ã€‚

å°½ç®¡æˆ‘å°†æè¿° Nest çš„ä¸»è¦æ„ä»¶:

*   [Guard](https://docs.nestjs.com/guards) -ä¿æŠ¤ç³»ç»Ÿå…å—æœªç»è®¤è¯/æœªç»æˆæƒçš„è®¿é—®
*   [æ‹¦æˆªå™¨](https://docs.nestjs.com/interceptors)â€”â€”æ‹¦æˆªä¼ å…¥çš„è¯·æ±‚æˆ–ä¼ å‡ºçš„å“åº”
*   [æ§åˆ¶å™¨](https://docs.nestjs.com/controllers) -å¤„ç†è¯·æ±‚
*   æä¾›è€…(Provider)â€”â€”è¿™åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œä¸“é—¨ç”¨äºä¸€äº›ä»»åŠ¡é›†ï¼Œç”±äº Nest å†…ç½®çš„ä¾èµ–æ³¨å…¥åŠŸèƒ½ï¼Œå®ƒå¯ä»¥è¢«æ³¨å…¥åˆ—è¡¨ä¸­çš„ä»»ä½•å…¶ä»–å†…å®¹
*   [ç®¡é“](https://docs.nestjs.com/pipes) -è½¬æ¢/éªŒè¯ä¼ å…¥çš„è¯·æ±‚ä½“
*   [ä¸­é—´ä»¶](https://docs.nestjs.com/middleware) -ä¸­é—´ä»¶çš„ç›®çš„æ˜¯æ‹¦æˆªè¯·æ±‚ï¼Œæ‰§è¡Œä¸€äº›é€»è¾‘ï¼Œå¹¶å°†æ§åˆ¶æµä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
*   è¿™ä¸ªä¸œè¥¿æœ‰åŠ©äºç»„ç»‡ä½ çš„åº”ç”¨ç¨‹åºç»“æ„ï¼Œå®ƒå’Œ Angular æ¨¡å—æœ‰ç›¸åŒçš„ç”¨é€”

è¿˜æœ‰ï¼Œæˆ‘å»ºè®®åœ¨ [Nest.js ä¸ŠæŒ‰éƒ¨å°±ç­](https://www.bhaidar.dev/2019/06/nestjs-step-by-step-part1)é˜…è¯»è¿™ä¸€ç³»åˆ—æ–‡ç« ã€‚

> ä½ å¯ä»¥é—®æˆ‘â€œå¦‚æœæˆ‘æœ‰ä¸­é—´ä»¶ï¼Œä¸ºä»€ä¹ˆæˆ‘è¿˜éœ€è¦ä¸Šé¢åˆ—å‡ºçš„å…¶ä»–ä¸œè¥¿ï¼Ÿâ€ã€‚
> 
> ä¸­é—´ä»¶å¤ªæ™®é€šï¼Œè€Œè­¦å«ï¼Œæ‹¦æˆªç­‰ã€‚è‡´åŠ›äºä¸€é¡¹ç‰¹æ®Šçš„ä»»åŠ¡ã€‚æ‰€ä»¥å¬åˆ°â€œå®ˆå«â€è¿™ä¸ªè¯ï¼Œä½ å°±å·²ç»çŸ¥é“å®ƒè´Ÿè´£ä»€ä¹ˆäº†ã€‚
> 
> å¦‚æœä½ æƒ³å®ç°è¿™é‡Œåˆ—å‡ºçš„æ¦‚å¿µä¹‹å¤–çš„ä¸œè¥¿ï¼Œä½ å¯èƒ½éœ€è¦ä¸­é—´ä»¶ã€‚

ğŸ’¥**å¤§çˆ†ç‚¸ï¼**
ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘ä¸ä¼šæè¿°æˆ‘ä»¬æœªæ¥é¡¹ç›®çš„æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ä¼šä¸€è·¯å¼ºè°ƒå…³é”®æ¦‚å¿µã€‚

æˆ‘ä»¬ä» Nest åº”ç”¨ç¨‹åºå¼€å§‹ï¼Œå®ƒæœ‰æ‰€æœ‰çš„ç®¡é“ï¼Œä½†æ²¡æœ‰æ•°æ®åº“ã€‚è¿™æ ·å°±å¾ˆå®¹æ˜“è°ˆè®ºä¸‹ä¸€æ­¥çš„äº‹æƒ…ï¼Œç„¶åé€æ¸è½¬å‘åå¯¹ã€‚
æ­£å¦‚æˆ‘å·²ç»è¯´è¿‡çš„ï¼Œæˆ‘ä»¬å°†å¼€å‘ä¸€ä¸ª toy notes APIã€‚æˆ‘ä»¬çš„ç¬”è®°å¯ä»¥æœ‰ä¸»é¢˜å’Œæ ‡ç­¾ã€‚

è¿™æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç»“æ„æœ€åˆçš„æ ·å­:

[![Initial app structure](img/ff23716e6b775de4a02ef74b5781eb89.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--KJBVWA8D--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560199673077_Image.jpg)

ç»§ç»­è°ƒæŸ¥[æˆ‘ä»¬ç›®å‰æ‹¥æœ‰çš„ä»£ç ](https://github.com/rychkog/nest-objection-article/tree/31d178d4991f5fce3e76c90c39e83981b0d6307c) ( *ä»£ç åº“ç›®å‰åœ¨* [*åˆå§‹æäº¤*](https://github.com/rychkog/nest-objection-article/commit/31d178d4991f5fce3e76c90c39e83981b0d6307c)*)ã€‚æˆ‘ä»¬å°†åœ¨å®ƒçš„åŸºç¡€ä¸Šå¼€å§‹å»ºé€ ã€‚*

 *åªè¦çœ‹çœ‹ä»£ç åº“ä¸­çš„åå­—ï¼Œå°±èƒ½ç«‹åˆ»æ¸…æ¥šä¸åŒç±»çš„ç›®çš„å’ŒèŒè´£ã€‚

è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°çœ‹çœ‹`notes`æ–‡ä»¶å¤¹(å› ä¸º`tags`å’Œ`themes`çš„å·¥ä½œæ–¹å¼å®Œå…¨ç›¸åŒ)ã€‚

ç¬¬ä¸€ä»¶äº‹æ˜¯`NotesModule`

[![](img/c8ba7ece94f39f3a552a31b06d3e5790.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--ZEnqDxtP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560199752208_Image%2B10.jpg)

åœ¨`NotesModule`æˆ‘ä»¬å·²ç»æ³¨å†Œäº†`NotesService`ã€‚è¿™æ˜¯å®ƒçš„æ ·å­

[![](img/8c6941cb3fb86d98c5c3ad112f44900d.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--DGnZA_An--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560199798161_Image%2B12.jpg)

`NotesService`è¢«`NotesController`ä½¿ç”¨ï¼Œä¸€æ—¦å‘ç°åè€…ä¾èµ–äºå‰è€…ï¼Œå°±è¢« Nest æ³¨å…¥ã€‚

[![](img/5b5cd3b70af87d16f4395179bac814dc.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--kyCKPnjZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560199822090_Image%2B9.jpg)

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°`NotesService`(ä»¥åŠå…¶ä»–æœåŠ¡)ç›®å‰åªæ˜¯ä¸€ä¸ªå­˜æ ¹ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚åœ¨ä¸€æ¬¡å…³äº ORM çš„å°å¯¹è¯ä¹‹åï¼Œæˆ‘ä»¬å°†å¾ˆå¿«è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## è •è™«

å†å²ä¸Šï¼ŒORMs çš„ç›®çš„æ˜¯æ¶ˆé™¤[å¯¹è±¡å…³ç³»é˜»æŠ—ä¸åŒ¹é…](https://en.wikipedia.org/wiki/Object-relational_impedance_mismatch)ã€‚ä»–ä»¬é€šè¿‡å°½å¯èƒ½æŠ½è±¡å‡º RDBMS å’Œå…³ç³»æ¦‚å¿µæ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä»–ä»¬ç‰¹åˆ«æ“…é•¿å¯¹ä½ éšè— SQL å¹¶å¼ºè¿«ä½ ä½¿ç”¨ä»–ä»¬çš„ DSLï¼Œè¿™ä»ç„¶å¾ˆç³Ÿç³•ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ª[æ³„æ¼æŠ½è±¡çš„çªå‡ºä¾‹å­](https://en.wikipedia.org/wiki/Leaky_abstraction)ã€‚

æˆ‘è®°å¾—åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘èŠ±äº†å‡ ä¸ªå°æ—¶ä¸è¿™ç§ DSL è¿›è¡Œæ–—äº‰ï¼Œè¯•å›¾æ¨¡ä»¿ä¸€ä¸ªæˆ‘å·²ç»ç”¨ SQL ç¼–å†™çš„æŸ¥è¯¢(åœ¨è¿™ä¸Šé¢èŠ±äº†å‡ åˆ†é’Ÿ)ã€‚å³ä½¿æˆ‘ä»¬æˆåŠŸåœ°ç¼–å†™äº†ä¸€ä¸ªåˆé€‚çš„ DSLï¼Œå®ƒä»ç„¶å¯èƒ½è¢«è½¬æ¢æˆæ‚¨æ— æ³•æ§åˆ¶çš„ç•¸å½¢çš„(ä¸æ€»æ˜¯é«˜æ€§èƒ½çš„)SQLã€‚

å…³ç³»æ•°æ®åº“çš„çœŸæ­£å¨åŠ›æ¥è‡ª SQL åŠå…¶å£°æ˜æ€§è¡¨è¾¾èƒ½åŠ›ã€‚å®é™…ä¸Šï¼Œæˆ‘çš„å¤§å¤šæ•°åŒäº‹éƒ½éå¸¸ç†Ÿæ‚‰ RDBMS æ¦‚å¿µã€‚å¯¹äºä»–ä»¬æ¥è¯´ï¼Œä» SQL æŸ¥è¯¢çš„è§’åº¦æ¥è€ƒè™‘æ˜¯å¾ˆèˆ’æœçš„ï¼Œè€Œä¸”å¼€å‘äººå‘˜é€šå¸¸å¯¹ DB record åº”è¯¥å¦‚ä½•ä»¥ä»–ä»¬é€‰æ‹©çš„è¯­è¨€è¡¨ç¤ºä¸ºä¸€ä¸ªå¯¹è±¡(å­—å…¸ã€åœ°å›¾ï¼Œç­‰ç­‰)æœ‰ä¸€ä¸ªç›´è§‚çš„ç†è§£ã€‚

åœ¨ ORM ä¸­å¯¹å¼€å‘äººå‘˜éšè— SQL æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºæ‚¨ä»ç„¶éœ€è¦çŸ¥é“å®ƒï¼Œä»¥ä¾¿è‡³å°‘ä»æ•°æ®åº“ä¸­è·å–ä¸€äº›ä¸œè¥¿ï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–ï¼Œæ‚¨è¿˜éœ€è¦åœ¨å¤´è„‘ä¸­å¯ç”¨ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå°† DSL è½¬æ¢ä¸º SQLï¼Œä»¥ä¾¿äº†è§£æœ€ç»ˆå°†ç”Ÿæˆä»€ä¹ˆæ ·çš„æŸ¥è¯¢ï¼Œä»¥åŠå®ƒæ˜¯å¦ä¼šç»™å‡ºæ‚¨æƒ³è¦çš„ç»“æœã€‚

åŒé‡å·¥ä½œç»™ä½ çš„å¤§è„‘å¸¦æ¥äº†é¢å¤–çš„å‹åŠ›ï¼Œä½ çš„å¤§è„‘è¯•å›¾ä¿æŒå’Œåè°ƒä½ æ­£åœ¨åšçš„é¡¹ç›®ä¸­çš„æ— æ•°å…¶ä»–å°äº‹ã€‚

å¦‚æœä½ å·²ç»ç²¾é€š SQLï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å­¦ä¹ å¦ä¸€ç§è¯­è¨€(DSL)æ¥ä»æ•°æ®åº“ä¸­è·å–/æ›´æ–°æ•°æ®å‘¢ï¼ŸORMs å®ç°ä¸€ä¸ªå°½å¯èƒ½æ¥è¿‘ SQL çš„ APIï¼Œå…è®¸å°†ç°æœ‰å¼€å‘äººå‘˜çš„ SQL çŸ¥è¯†è½¬ç§»åˆ°é‚£ä¸ª APIï¼Œæ‹‰å¹³å­¦ä¹ æ›²çº¿ï¼Œä¸æ˜¯æ›´å¥½å—ï¼Ÿ
è¿™æ ·çš„ API å°†åˆ©ç”¨è‡ªåŠ¨å®Œæˆå’Œé™æ€ä»£ç åˆ†æç­‰è¯­è¨€ç‰¹æ€§ï¼ŒåŒæ—¶ä»ç„¶æ¥è¿‘ç”Ÿæˆçš„ SQLã€‚

åœ¨æˆ‘çœ‹æ¥ï¼Œåƒ Hibernateã€TypeORM å’Œç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆéƒ½æ˜¯è¶…è½½ã€ç¬¨é‡å’Œè¿‡äºå¤æ‚çš„ã€‚

è¿™å°±æ˜¯[åå¯¹](https://vincit.github.io/objection.js)çš„åŸå› ã€‚ä¸å…¶ä»– ORM ç›¸æ¯”ï¼Œå®ƒæ²¡æœ‰è¯•å›¾å°† SQL å’Œå…³ç³»æ¨¡å‹éšè—èµ·æ¥ã€‚å¼‚è®®å¼€å‘äººå‘˜æ˜¯è¿™æ ·æè¿°ä»–ä»¬çš„äº§å“çš„:

> Objection.js æ˜¯ [Node.js](https://nodejs.org/) çš„ä¸€ä¸ª [ORM](https://en.wikipedia.org/wiki/Object-relational_mapping) ,ç›®çš„æ˜¯ä¸ç¢äº‹ï¼Œå°½å¯èƒ½å®¹æ˜“åœ°ä½¿ç”¨ SQL å’Œåº•å±‚æ•°æ®åº“å¼•æ“çš„å…¨éƒ¨åŠŸèƒ½ï¼ŒåŒæ—¶ä»ç„¶ä½¿å¸¸è§çš„ä¸œè¥¿å˜å¾—å®¹æ˜“å’Œæœ‰è¶£ã€‚

## ğŸ½ï¸å°†å¼‚è®®ä¸åµŒå¥—ç›¸ç»“åˆ

**TLDRï¼›**å¦‚æœä½ åªæ˜¯æƒ³çŸ¥é“åº”è¯¥åšäº›ä»€ä¹ˆæ‰èƒ½åœ¨ Nest ä¸­è·å¾—å¼‚è®®æ”¯æŒï¼Œè¿™é‡Œæ˜¯[å·®å¼‚](https://github.com/rychkog/nest-objection-article/commit/5644b3295c8d5064606eff5e7c9296f90f3f2143)ï¼Œå®ƒæ˜¾ç¤ºäº†åº”è¯¥åœ¨æˆ‘ä»¬çš„åˆå§‹æäº¤ä¹‹ä¸Šåº”ç”¨çš„æ›´æ”¹ã€‚

1ï¸âƒ£ **å®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹**
`npm i @types/dotenv dotenv objection knex pg`

*   **dotenv** ç”¨`.env`æ–‡ä»¶ä¸­å®šä¹‰çš„ç¯å¢ƒå˜é‡å¡«å……`process.env`
*   **åå¯¹**â€”â€”ORM
*   knex æ˜¯ Objection åœ¨å¹•åä½¿ç”¨çš„ä¸€ä¸ª SQL æŸ¥è¯¢æ„å»ºå™¨ã€‚å®ƒè¿˜æä¾›äº†*è¿ç§»*å’Œ*æ•°æ®æ’­ç§*æ”¯æŒ(æˆ‘ä»¬ç¨åä¼šè°ˆåˆ°è¿™ä¸€ç‚¹)
*   pg æ˜¯ PostgreSQL æ•°æ®åº“çš„å®¢æˆ·ç«¯ã€‚

2ï¸âƒ£ **å…³ç³»æ¨¡å‹**
ä¸‹ä¸€æ­¥æ˜¯å®šä¹‰æˆ‘ä»¬çš„å…³ç³»æ¨¡å‹(ç°åœ¨åªè¦ç†Ÿæ‚‰æˆ‘ä»¬å°†è¦æ„å»ºçš„è¡¨)

[![Note app relational model](img/c139dd0d0772795e9782d1f695e179ff.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--cdUcvmQx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560075747688_postgres.png)

*   ç¬”è®°å¯èƒ½æœ‰ä¸€ä¸ªä¸»é¢˜
*   æ³¨é‡Šå¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾
*   ä¸€ä¸ªæ ‡ç­¾å¯ä»¥å±äºå¤šä¸ªæ³¨é‡Š

> **knex_migrations** å’Œ **knex_migrations_lock** æ˜¯ç”± knex åˆ›å»ºå’Œç®¡ç†çš„è¡¨ã€‚
> å®ƒä»¬ä¸æˆ‘ä»¬çš„æ•°æ®æ¨¡å‹æ— å…³ã€‚

3ï¸âƒ£ **ç”¨åŠ©æ‰‹è„šæœ¬æ‰©å±• package . JSON**
åœ¨æˆ‘ä»¬å¼€å§‹åˆ›å»ºè¿ç§»ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ·»åŠ å‡ ä¸ªå‘½ä»¤åˆ°æˆ‘ä»¬çš„`package.json`
åˆ«æ‹…å¿ƒï¼Œå®ƒä»¬çš„ç›®çš„å°†åœ¨åé¢çš„éƒ¨åˆ†å˜å¾—æ¸…æ¥šã€‚

[![](img/b297875b8864e26a68a1b868abfb7659.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--xWQyAsCs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560199864056_Image%2B13.jpg)

4ï¸âƒ£**knex file**T4ã€‘åœ¨ä¸Šé¢çš„`package.json`èŠ‚é€‰ä¸­ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°`--knexfile knexfile.ts`ã€‚è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ Knex é…ç½®æ–‡ä»¶çš„å‚æ•°ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºå®ƒã€‚

[![](img/27fab254343d1a825de8824974dd74c8.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--0tE8qJXV--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560199900514_Image%2B5.jpg)

**knexSnakeCaseMappers** å°†ä»£ç ä¸­çš„ *camelCase* åç§°è½¬æ¢ä¸ºæ•°æ®åº“ä¸­çš„ *snake_case* åç§°ã€‚
æ‰€ä»¥åœ¨æˆ‘ä»¬çš„æ•°æ®åº“æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰ **font_family** åˆ—çš„**ä¸»é¢˜**è¡¨ã€‚ä¸ºäº†ä»ä»£ç ä¸­æ›´æ–°è¯¥åˆ—ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ **fontFamily** æ¥å¼•ç”¨å®ƒï¼Œæ˜ å°„å™¨å°†é€šè¿‡è‡ªåŠ¨è½¬æ¢ **font_family â†’ fontFamily** æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œåä¹‹äº¦ç„¶ã€‚

è¿ç§»çš„*ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªæ•°æ®åº“æ¨¡å¼ä»¥åŠéšåå¯èƒ½å‡ºç°çš„å¯¹è¯¥æ¨¡å¼çš„æ›´æ”¹ã€‚è¿™å…è®¸å¯¹æ•°æ®åº“è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œå¹¶åœ¨éœ€è¦æ—¶å°†æ¨¡å¼å›æ»šåˆ°ä»¥å‰çš„çŠ¶æ€ã€‚*

å½“æ‚¨éœ€è¦ç”¨ä¸€äº›æ•°æ®å¡«å……æ•°æ®åº“æ—¶ï¼Œç§å­åœ¨å¼€å‘ç¯å¢ƒä¸­éå¸¸æœ‰ç”¨ã€‚

**migration.stub** å’Œ **seed.stub** æ˜¯*æ¨¡æ¿æ–‡ä»¶*ï¼ŒKnex ç”¨å®ƒæ¥ç”Ÿæˆæˆ‘ä»¬çš„è¿ç§»å’Œç§å­ã€‚å°†å®ƒä»¬æ”¾åœ¨é…ç½®ä¸­æŒ‡å®šçš„`database`æ–‡ä»¶å¤¹ä¸‹

[![migration.stub](img/e294bf223bbc27d88401db266f9863c2.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--MXApxbzl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560199940403_Image%2B6.jpg)

[![seed.stub](img/a7086b7425fae69f328bb1a1db5a0caf.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--xmfhJArs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560199985691_Image%2B14.jpg)

5ï¸âƒ£ **è¿ç§»**
ç°åœ¨ï¼Œå½“æˆ‘ä»¬åˆ›å»ºäº†`knexfile.ts`ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ä½¿ç”¨ä¹‹å‰æ·»åŠ åˆ°`package.json`ä¸­çš„ Knex å‘½ä»¤ã€‚

*   `npm run migrate:make CreateTags`
*   `npm run migrate:make CreateThemes`
*   `npm run migrate:make CreateNotes`
*   `npm run migrate:make CreateNoteTags`

è¿™äº›å°†ä½¿ç”¨æˆ‘ä»¬çš„`migration.stub`åœ¨`database/migrations`æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆè¿ç§»æ–‡ä»¶ã€‚

æ˜¯æ—¶å€™å®šä¹‰æˆ‘ä»¬çš„è¡¨äº†ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥å®Œæˆ`CreateNotes`è¿ç§»å§å…¶ä»–äººè¯·çœ‹ä¸€ä¸‹[æœ€ç»ˆè§£å†³æ–¹æ¡ˆ](https://github.com/rychkog/nest-objection-article/tree/master/src/database/migrations)ã€‚

[![](img/675fe7dae14dd0dc97f77d0a5ef182c0.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--pTD-Bfhc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200028805_Image%2B3.jpg)

6ï¸âƒ£ **ç”¨ object**
è¿æ¥æˆ‘ä»¬çš„æ¨¡å‹ä¸ºäº†åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­åæ˜ å…³ç³»è¡¨ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€å †é€‚å½“çš„ç±»ï¼Œç§°ä¸º*æ¨¡å‹*ã€‚ç›®å‰ï¼Œå®ƒä»¬åªæ˜¯ä½äº`database/models`ç›®å½•ä¸‹çš„æ™®é€šç±»å‹è„šæœ¬ç±»ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åœ¨å®ƒä»¬ä¸Šé¢æ·»åŠ ä¸€äº›*å¼‚è®®*ã€‚

**åŸºæœ¬å‹å·** ( `base.model.ts`)

[![](img/b360ab81b75ac44053801073ab0dcb4e.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--WC8tLMcx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200062684_Image%2B2.jpg)

**TagModel** ( `tag.model.ts`)

[![](img/e60892b946d36267a565f3a2ddc3b122.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--YuRyt5ma--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200081764_Image%2B15.jpg)

**NoteTagModel** ( `note-tag.model.ts`)

[![](img/424de685196e752b58321421065db78a.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--j9bzIbmQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200097152_Image%2B7.jpg)

**ä¸»é¢˜æ¨¡å‹** ( `theme.model.ts`)

[![](img/4c5325a3ba7a07e92229cc5a8f1966fb.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--5y1X7GCK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200134180_Image%2B16.jpg)

7ï¸âƒ£ **æ˜ å°„å…³ç³»**

[![](img/b1e1537d9966aeb7fe791f38a27d5d5c.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--eBn6uo49--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200146666_Image%2B8.jpg)

8ï¸âƒ£ **å°†æ¨¡å‹è¿æ¥åˆ°æ•°æ®åº“å’Œ database.module.ts**

æ¯ä¸ªæ¨¡å‹ç±»éƒ½å¯ä»¥ç”¨æ¥æ‰§è¡Œå„ç§ SQL æŸ¥è¯¢ï¼Œä½†æ˜¯ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›ç±»ä¸ Knex æ•°æ®åº“è¿æ¥èµ·æ¥ã€‚

ä¸€æ—¦å®ƒä»¬è¢«è¿æ¥èµ·æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™äº›ç±»ä½œä¸ºå¯æ³¨å…¥çš„æœåŠ¡å…¬å¼€ç»™å…¶ä»–æ¨¡å—ã€‚

[![](img/6120d4d8a7a47497d3b0670ce518916c.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--EFWMds4l--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200173729_Image%2B4.jpg)

DatabaseModule éœ€è¦åœ¨ä¸» ApplicationModule ä¸‹æ³¨å†Œï¼Œè¿™æ ·å®ƒå¯¼å‡ºçš„æ‰€æœ‰æœåŠ¡éƒ½å¯ä»¥ç”¨äºå…¶ä»–æ¨¡å—ã€‚

[![](img/9803eab26ad4236509386f000feafa08.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--vFIak_yi--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200194065_Image%2B1.jpg)

9ï¸âƒ£ **Implementing.service.ts æ–‡ä»¶**
ä¸ºäº†å¼€å§‹æ“ä½œæ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å®ç° **.service.ts** æ–‡ä»¶ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚

æ¯ä¸ªæœåŠ¡éƒ½ä¾èµ–äºæˆ‘ä»¬åœ¨ä¸Šé¢é€šè¿‡æ¨¡å—çš„*è¾“å‡º*å…¬å¼€çš„æ¨¡å‹ç±»ã€‚
ä¸‹é¢æ˜¯ NotesService å®ç°(`notes.service.ts`):

[![](img/f9c085212ba4707409c6b4fbd5f26a1f.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--AmMdwxXH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200245958_Image%2B11.jpg)

å¦‚æ‚¨æ‰€è§ï¼Œ`.query()`æ–¹æ³•æ˜¯æ„å»º[ä¸°å¯ŒæŸ¥è¯¢](https://vincit.github.io/objection.js/guide/query-examples.html#find-queries)çš„ä¸€ä¸ªé€”å¾„ã€‚
åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªäº‹åŠ¡ä¾‹å­ï¼Œæ‰€ä»¥åœ¨`transaction`å›è°ƒä¸­æŠ›å‡ºçš„ä»»ä½•é”™è¯¯éƒ½ä¼šå¯¼è‡´å›è°ƒä¸­è§¦å‘çš„æ•°æ®åº“æ›´æ”¹å›æ»šã€‚

ğŸ”Ÿ**åŠ è½½ç¥¨æ®å…³ç³»**
æˆ‘ä»¬æ¥çœ‹çœ‹[ç¥¨æ®æ§åˆ¶å™¨](https://github.com/rychkog/nest-objection-article/blob/master/src/notes/notes.controller.ts#L15)ä¸­çš„`findOne`æ–¹æ³•:

[![](img/f64f9724417f15129611e102259d7a6c.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--vg3CFimi--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200685418_findOne.png)

æœ€æ˜¾è‘—çš„å˜åŒ–æ˜¯`$loadRelated`è°ƒç”¨ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹è¿™ä¸ªç‰¹æ®ŠéŸ³ç¬¦çš„è´Ÿè½½å…³ç³»æå‡ºå¼‚è®®:

[![](img/cad7228c740c6d6af5f710d0411fddaf.png)](https://res.cloudinary.com/practicaldev/image/fetch/s---DVd4eIL--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200709346_findOne-zoom.png)

`tags`å’Œ`theme`æ˜¯åœ¨ **NoteModel** ç±»ä¸­å®šä¹‰çš„å…³ç³»çš„åç§°ã€‚è¿™å°±æ˜¯å¼‚è®®å¦‚ä½•çŸ¥é“å¦‚ä½•è·å–å®ƒä»¬ã€‚

æ‰€æœ‰æå–çš„å…³ç³»éƒ½è¢«è½¬æ¢æˆé€‚å½“çš„æ¨¡å‹å®ä¾‹ã€‚
ä¸€æ—¦è·å–ï¼ŒObjection å°†ä¸ºè¿™ä¸ªç‰¹å®šçš„ note å®ä¾‹åˆ›å»º**æ ‡ç­¾**å’Œ**ä¸»é¢˜**å­—æ®µã€‚

å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å…³ç³»éƒ½æ˜¯æŒ‰éœ€åŠ è½½çš„ã€‚

å¦‚æœä½ æƒ³è·å–å¤§é‡å¸¦æœ‰åŠ è½½å…³ç³»çš„å¯¹è±¡ï¼Œè¿˜æœ‰å¦ä¸€ç§æ–¹æ³•[ä½ å¯ä»¥ä½¿ç”¨](https://github.com/rychkog/nest-objection-article/blob/master/src/notes/notes.controller.ts#L11):

[![](img/248f45fb8f3053452dde76919f50f0ee.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--eXlfxQf_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200725807_findAll.png)

åœ¨è¿™é‡Œï¼Œä¸€æ—¦åŠ è½½äº†æ‰€æœ‰æ³¨é‡Šï¼Œå¼‚è®®å°†åŠ è½½æ‰€æœ‰æ³¨é‡Šçš„`tags`å…³ç³»ã€‚

1ï¸âƒ£ 1ï¸âƒ£ **ç§å­**
ç°åœ¨æˆ‘ä»¬å‡†å¤‡ç”Ÿæˆç§å­æ–‡ä»¶:

*   `npm run seed:make 01-Tags`
*   `npm run seed:make 02-Themes`
*   `npm run seed:make 03-Notes`
*   `npm run seed:make 04-NoteTags`

ä½¿ç”¨æˆ‘ä»¬çš„`seed.stub`åœ¨`database/seeds`æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆç§å­ã€‚

Knex æŒ‰é¡ºåºæ‰§è¡Œç§å­æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ç¡®ä¿å®ƒæ˜¯æ­£ç¡®çš„ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨ç§å­æ–‡ä»¶å‰é¢åŠ ä¸Šæ•°å­—çš„åŸå› :æˆ‘ä»¬å¸Œæœ›åœ¨ note-tags ä¹‹å‰åˆ›å»ºæ ‡ç­¾ï¼Œå› ä¸ºåè€…ä¾èµ–äºå‰è€…ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹`02-Themes.ts` seed çš„å®ç°

[![](img/e7d8d7cd19f975748aaeb7ffbec57788.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--mguz_FUB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560092333289_02-Themes.png)

1ï¸âƒ£2ï¸âƒ£**dotenv**
[dotenv](https://github.com/motdotla/dotenv)æ˜¯ä¸€ä¸ªä»**åŠ è½½ç¯å¢ƒå˜é‡çš„åº“ã€‚env** æ–‡ä»¶åˆ°`process.env`
ä¸­ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨å®ƒæ¥å®šä¹‰`DATABASE_URL` env å˜é‡ï¼Œç„¶åå°†åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ï¼ŒåŒ…æ‹¬è¿ç§»å’Œç§å­è„šæœ¬ã€‚

ä½ åªéœ€è¦

1.  åˆ›å»ºä¸€ä¸ª**ã€‚env** æ–‡ä»¶ï¼Œå¹¶å°†è¿™ä¸€è¡Œ DATABASE _ URL = postgres://postgres:docker @ localhost:5432/postgres

è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²æ˜¯åŸºäºæˆ‘ä»¬åœ¨`package.json`ä¸­çš„å‘½ä»¤æ„å»ºçš„ã€‚Postgres ä½¿ç”¨`postgres`ä½œä¸ºé»˜è®¤ç”¨æˆ·å’Œæ•°æ®åº“çš„åç§°ã€‚

[![](img/059352dc47bf0808acdcbefca48ef24d.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--sVOMT_n---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://paper-attachments.dropbox.com/s_1F921D6055F211537012522AC3AED06A165C5605936BC0BA49129723816F6EFE_1560200837212_run-docker.png)

1.  åœ¨ **knexfile.ts** å’Œ **main.ts** ![](img/a9052a369c15564e36b0bf5717fad639.png)çš„æœ€é¡¶ç«¯æ·»åŠ  **dotenv** import

1ï¸âƒ£ 3ï¸âƒ£ **è¿è¡Œ PostgreSQL**
æ­¤æ—¶æˆ‘ä»¬éœ€è¦å¯åŠ¨æˆ‘ä»¬çš„ PostgreSQL å®ä¾‹:

```
`npm run run:pg-docker` 
```

ç„¶ååˆ›å»ºæ¨¡å¼(é€šè¿‡æ‰§è¡Œè¿ç§»)å¹¶ç”¨æ•°æ®å¡«å……å®ƒ(é€šè¿‡æ‰§è¡Œç§å­):

```
`npm run migrate && npm run seed` 
```

## ğŸš€ç©åº”ç”¨ç¨‹åº

ç°åœ¨ï¼Œæ‚¨åº”è¯¥æœ‰ä¸€ä¸ªæ”¯æŒå¼‚è®®çš„å®Œå…¨æ­£å¸¸å·¥ä½œçš„ Nest åº”ç”¨ç¨‹åºäº†ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œå®ƒ

```
`npm run start` 
```

**README.md** åŒ…å«ç¤ºä¾‹ http è¯·æ±‚(ä½¿ç”¨ ***curl*** )ï¼Œæ‚¨å¯ä»¥é’ˆå¯¹æœåŠ¡å™¨ä¿®æ”¹å’Œæ‰§è¡Œè¿™äº›è¯·æ±‚ã€‚

æˆ‘ä»¬ç»“æŸäº†ğŸ‰

## æ‘˜è¦

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘åˆ†äº«äº†æˆ‘å¯¹ç²¾ç¥ç–²åŠ³çš„æƒ³æ³•ï¼Œä»¥åŠé€šè¿‡æ­£ç¡®çš„å·¥å…·ï¼Œå¯ä»¥åˆ©ç”¨æ¸…æ™°ç›´è§‚çš„æ¦‚å¿µæ¥å¸®åŠ©ä¸ä»–äººäº¤æµå’Œåˆ†äº«çŸ¥è¯†ï¼Œä»è€Œå‡è½»ç²¾ç¥ç–²åŠ³ã€‚

Nest é€šè¿‡æä¾›ä¸€ä¸ªæ¦‚å¿µåŸºç¡€æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¿™ä¸ä»…å¯¹äºé¡¹ç›®çš„æ¨ç†ï¼Œè€Œä¸”å¯¹äºå‘å…¶ä»–å¼€å‘äººå‘˜ä¼ è¾¾å®ƒçš„å·¥ä½œæ–¹å¼éƒ½æ˜¯éå¸¸å¥½çš„ã€‚

Objection ä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªæ¡†æ¶ï¼Œå…è®¸æ‚¨ç”¨ SQL æœ¯è¯­è¿›è¡Œæ€è€ƒï¼Œå¹¶é¿å…æµªè´¹æ—¶é—´è°ƒè¯•æ·±å¥¥çš„ DSLã€‚æˆ‘ç§°ä¹‹ä¸ºâ€œæ— ç—› ORMâ€ã€‚

æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œå¹¶å¯¹å¦‚ä½•å¼€å§‹åœ¨ Nest ä¸­ä½¿ç”¨ Objection æœ‰æ‰€äº†è§£ã€‚

ä½ å¯ä»¥åœ¨æˆ‘çš„ github ä¸Šæ‰¾åˆ°[å®Œæ•´é¡¹ç›®](https://github.com/rychkog/nest-objection-article)ã€‚

*è¿™ä¸ªå¸–å­ç”± [ThisDot](https://www.thisdot.co/) çš„ Georgii Rychko æ’°å†™ã€‚*

éœ€è¦ JavaScript å’¨è¯¢ã€æŒ‡å¯¼æˆ–åŸ¹è®­å¸®åŠ©å—ï¼Ÿåœ¨ [This Dot Labs](//thisdot.co) æŸ¥çœ‹æˆ‘ä»¬çš„æœåŠ¡åˆ—è¡¨ã€‚*