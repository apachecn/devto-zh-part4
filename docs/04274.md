# ç±»å‹è„šæœ¬ä¸­çš„å®‰å…¨å‡½æ•° IO:ç®€ä»‹

> åŸæ–‡:[https://dev . to/peterszerzo/safe-functional-io-in-typescript-an-introduction-1k mi](https://dev.to/peterszerzo/safe-functional-io-in-typescript-an-introduction-1kmi)

è¿™äº›å¤©æ¥ï¼Œæˆ‘å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç”¨ Elm ç¼–ç¨‹ï¼Œäº«å—ç€ç±»å‹å®‰å…¨ IO å’Œä¿è¯æ²¡æœ‰è¿è¡Œæ—¶å¼‚å¸¸çš„ä¸°å¯Œç±»å‹ç³»ç»Ÿã€‚ç„¶åï¼Œå°±åœ¨ä¸Šå‘¨ï¼Œä¸€ä¸ªç›¸å½“å¤æ‚çš„ TypeScript é¡¹ç›®è½åˆ°äº†æˆ‘çš„å¤´ä¸Šã€‚æ€€ç€å…´å¥‹å’Œä¹è§‚çš„å¿ƒæƒ…ï¼Œæˆ‘èŠ±äº†ä¸€äº›æ—¶é—´ä½¿ç”¨å¯çˆ±çš„ [io-ts](https://github.com/gcanti/io-ts) å’Œ [fp-ts](https://github.com/gcanti/fp-ts) åŒ…åœ¨è¿™ä¸ªæ–°çš„åœ°å½¢ä¸Šæä¾›åŒæ ·çš„ä¿è¯ã€‚

æœ¬ç³»åˆ—æ€»ç»“äº†è¿™ä¸€å­¦ä¹ ä¹‹æ—…ï¼Œåœ¨ TypeScript ä¸­å‘½åä¸º*å®‰å…¨åŠŸèƒ½ IOã€‚å®ƒä»¥æˆ‘ä»¥å‰çš„æ‰“å­—ç»å†ä¸­çš„ä¸€äº›æ£˜æ‰‹é—®é¢˜å¼€å§‹ï¼Œå¸Œæœ›èƒ½æœ‰æ‰€æ”¶è·ã€‚*

## [](#the-need-for-safe-io)å®‰å…¨ IO çš„éœ€è¦

TypeScript çš„ç±»å‹ç³»ç»Ÿå·²ç»å˜å¾—å¦‚æ­¤ä¹‹å¥½ï¼Œä»¥è‡³äºåœ¨ v3.1 å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œæˆ‘å¯ä»¥è½»æ¾åœ°å¯¹ 3000 loc React åº”ç”¨ç¨‹åºè¿›è¡Œå¤–ç§‘æ‰‹æœ¯å¼çš„ä¿®æ”¹ï¼Œåªéœ€è¦ä¾é ç¼–è¯‘å™¨å’Œå‡ åä¸ªå•å…ƒæµ‹è¯•ã€‚ç„¶è€Œï¼Œè¿™ç§å¥½å¤„åªæœ‰åœ¨è¿›å…¥åº”ç”¨ç¨‹åºçš„æ•°æ®æŒ‰ç…§æˆ‘å‡è®¾çš„æ–¹å¼è¿è¡Œæ—¶æ‰æœ‰æ•ˆ:

```
interface Fruit {
  name: string;
  sweetness: string;
}

fetch("https://some.endpoint/fruit.json")
  .then(res => res.json())
  .then((fruit: Fruit) => {
    // do something with `fruit`
    // although I'm a bit worried ğŸ˜¨
  }) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¿è¯`fruit`ä»æœåŠ¡å™¨è¿”å›æ—¶æ˜¯æ­£ç¡®çš„å½¢çŠ¶æ˜¯å¾ˆæ£˜æ‰‹çš„ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºå®ƒå¾ˆå®¹æ˜“ä¿¡ä»»åç«¯å›¢é˜Ÿçš„æ–‡æ¡£ï¼Œåƒä¸Šé¢çš„ä»£ç ç‰‡æ®µé‚£æ ·æ³¨é‡Š UI ä»£ç ï¼Œç„¶åç»§ç»­å‰è¿›ã€‚

ä½†æ˜¯æ¥ä¸‹æ¥ï¼Œä¸å¯é¿å…åœ°ä¼šå‡ºç°æ²Ÿé€šä¸ç•…ã€éƒ¨ç½²ç‰ˆæœ¬ä¸åŒ¹é…ã€ä¸å¯é¢„æµ‹çš„ç¼“å­˜ï¼Œç”±æ­¤äº§ç”Ÿçš„ bug åšäº† bug æœ€æ“…é•¿çš„äº‹æƒ…:çŒ›çƒˆæ”»å‡»å¹¶æä¾›ä¸€ç§æ¶ˆæ¯/å †æ ˆè·Ÿè¸ªï¼Œè¿™å¯¹äºç¼©å°å…¶ä½ç½®æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ã€‚

å¯¹æˆ‘æ¥è¯´ä¸æ˜¯ï¼Œå¯¹ä¸‹ä¸€ä¸ªäº§å“çš„ç”¨æˆ·æ¥è¯´ä¹Ÿä¸æ˜¯ã€‚

## [](#enter-raw-iots-endraw-)è¾“å…¥`io-ts`

è¿™ä¸ªèªæ˜çš„åŒ…å…¬å¼€äº†ä¸€ç§è¯­è¨€æ¥å®šä¹‰ä¸Šé¢çš„`Fruit`æ¥å£ï¼Œå®ƒä¸ä»…å‘ˆç°äº†ä¸€ä¸ªé™æ€ç±»å‹ï¼Œè¿˜å‘ˆç°äº†ä¸€ä¸ªéå¸¸ä¼˜é›…çš„è¿è¡Œæ—¶éªŒè¯å™¨ã€‚å¯¹äºæˆ‘ä»¬çš„ä¾‹å­ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·:

```
import * as t from "io-ts";

// Validator object, called `codec`
const Fruit = t.type({
  name: t.string,
  sweetness: t.string
});

// Static type, constructed from the codec
type Fruit = t.TypeOf<typeof Fruit>; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæœ‰ä¸€ç‚¹é«˜çº§çš„ TypeScript é­”æ³•ï¼Œä½†æ˜¯ç°åœ¨ï¼ŒçŸ¥é“æˆ‘ä»¬æœ‰ä¸€ä¸ªé™æ€çš„`Fruit`ç±»å‹å°±è¶³å¤Ÿäº†ï¼Œå®ƒçš„è¡Œä¸ºä¸ä¹‹å‰çš„ç®€å•æ¥å£ç›¸åŒã€‚æœ‰äº†`Fruit`å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡ŒéªŒè¯:

```
// Instead of the optimistic `Fruit`, we can now properly annotate as `unknown`
const someValue: unknown = {
  name: "apple",
  sweetness: "somewhat"
};

const validatedApple = Fruit.decode(someValue);
console.log(validatedApple); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ§åˆ¶å°é‡Œå‡ºæ¥çš„æ˜¯è¿™ä¸ª:

```
{  "_tag":  "Right",  "right":  {  "name":  "apple",  "sweetness":  "somewhat"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

çœ‹èµ·æ¥è¿™ä¸ªç‰©ä½“è¯•å›¾å‘Šè¯‰æˆ‘ï¼Œæœ‰äº›å°´å°¬å¹¶ä¸”é‡å¤äº†å¾ˆå¤šæ¬¡ï¼Œæœ‰äº›äº‹æƒ…æ˜¯å¯¹çš„ã€‚ä½†æ˜¯æˆ‘ä»¬çœŸçš„è¢«æœŸæœ›ä¸è¿™ä¸ªä¸€èµ·å·¥ä½œå—ï¼Ÿ

æ˜¯çš„ï¼Œæˆ‘ä»¬æœ‰ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šä¼˜é›…çš„å¸®åŠ©ï¼Œè€Œä¸”ç»å¯¹æ²¡æœ‰æ”¯ç¥¨ã€‚

## [](#enter-raw-fpts-endraw-)è¾“å…¥`fp-ts`

`io-ts`åœ¨å†…éƒ¨å’Œå…¬å…± API ä¸­ä½¿ç”¨é€šç”¨å‡½æ•°å¼ç¼–ç¨‹å·¥å…·åŒ…`fp-ts`çš„æ•°æ®ç»“æ„ã€‚ä½¿ç”¨è¿™ä¸ªåŒ…ï¼Œä¸Šé¢çš„å¯¹è±¡å¯ä»¥è¿™æ ·æ„é€ :

```
import * as either from "fp-ts/lib/either";

const validationFromBefore = either.right({
  name: "apple",
  sweetness: "somewhat"
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæˆ‘ä»¬å¯¹å®ƒè¿›è¡Œæ³¨é‡Šï¼Œå®ƒä¼šæ˜¯è¿™æ ·çš„:

```
either.Either<t.Errors, Fruit> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¡¨ç¤ºä¸€ä¸ªç±»å‹å¯ä»¥æœ‰ä¸¤æ¡è·¯å¯èµ°:å·¦è¾¹ï¼Œç”±ä¸€ä¸ªç»™å®šçš„ç±»å‹å‚æ•°åŒ–ï¼Œå³è¾¹ï¼Œç”±å¦ä¸€ä¸ªç»™å®šçš„ç±»å‹å‚æ•°åŒ–ã€‚è¦ä¹ˆæ˜¯ä¸€ä¸ªè£…ç€æ–‡æ¡£çš„æ–‡ä»¶å¤¹ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªè£…ç€è‹¹æœçš„ç¯®å­:æ€»æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œæ”¾å¿ƒé‚£ä¸ªæ–‡ä»¶å¤¹é‡Œä¸ä¼šæœ‰ä»»ä½•å‹æ‰çš„è‹¹æœã€‚

æ›´å…·ä½“åœ°è¯´ï¼Œå·¦è¾¹é€šå¸¸åŒ…å«ä¸€äº›é”™è¯¯(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯`t.Errors`)ï¼Œè€Œå³è¾¹åŒ…å«ä¸€äº›æˆåŠŸæ“ä½œäº§ç”Ÿçš„æœ‰æ•ˆè´Ÿè½½(`Fruit`)ã€‚åœ¨ Elm è¿™æ ·æ›´å‹å¥½çš„è¯­è¨€ä¸­ï¼Œå·¦-å³ä¸‰å…ƒç»„è¢«ç§°ä¸º result-err-okã€‚

> `Either`åœ¨ TypeScript ä¸­ä½¿ç”¨[åŒºåˆ†è”åˆ](https://www.typescriptlang.org/docs/handbook/advanced-types.html#discriminated-unions)ï¼Œè¿™æ ·ç¼–è¯‘å™¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ­£ç¡®ä½¿ç”¨è¿™äº›å®¹å™¨å’Œå€¼ã€‚

### [](#working-with-raw-either-endraw-)ä¸`Either`ä¸€èµ·å·¥ä½œ

æ­£å¦‚æˆ‘ä¹‹å‰æ‰¿è¯ºçš„ï¼Œ`fp-ts`å…¬å¼€äº†ä¸€äº›æ–¹ä¾¿çš„å‡½æ•°æ¥è½»æ¾åœ°ä½¿ç”¨`Either`å€¼ã€‚ä¸ºäº†å°†è§£ç åçš„ç»“æœè½¬æ¢æˆå‹å¥½çš„å­—ç¬¦ä¸²ä»¥æ˜¾ç¤ºåœ¨ UI ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„`either.fold`å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿˜å¸¦æœ‰ä¸¤ä¸ªå‡½æ•°:

*   `onLeft`:å°†è¯¯å·®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„å‡½æ•°
*   `onRight`:å°†è§£ç æˆåŠŸçš„æ°´æœå˜æˆå­—ç¬¦ä¸²çš„å‡½æ•°

æœ¬è´¨ä¸Šï¼Œç¼–è¯‘å™¨åªæ˜¯å¼ºè¿«æˆ‘ä»¬åœ¨ä¸ç¨‹åºäº¤äº’ä¹‹å‰å¤„ç†æˆåŠŸå’Œé”™è¯¯çš„æƒ…å†µã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·:

```
import * as t from "io-ts/lib/either";
import * as either from "fp-ts/lib/either";

// Decode an arbitrary value
const validation = Fruit.decode({
  name: "apple",
  sweetness: "somewhat"
});

const result: string = either.fold(
  (errors: t.Errors) => "Something went wrong",
  (fruit: Fruit) => `${fruit.name} ~ ${fruit.sweetness} sweet`
)(validation);

console.log(result);
// Logs "apple ~ somewhat sweet" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæˆ‘ä»¬å°†`sweetness`å­—æ®µä¸­çš„å€¼æ›¿æ¢ä¸º 65(åˆç†åœ°å‡è®¾ç”œåº¦åº”è¯¥åœ¨ 0-100 çš„èŒƒå›´å†…)ï¼ŒéªŒè¯å°†å¤±è´¥ï¼Œæ‚¨å°†å¾—åˆ°`"Something went wrong"`,æ­£å¦‚é¢„æœŸçš„é‚£æ ·ã€‚

> æˆ‘å»ºç«‹äº†ä¸€ä¸ªåŒ…å«è¿™äº›ä»£ç çš„ä»£ç æ²™ç®±ã€‚æ‚¨å¯ä»¥éšæ„åœ¨é‚£é‡Œè¿›è¡ŒéªŒè¯ã€‚å®ƒå¤šå°‘æœ‰äº›å˜åŒ–ï¼Œå¯èƒ½ä¼šåŒ…å«å„ç§å…¶ä»–çš„å¥½ä¸œè¥¿ï¼Œä½†æ˜¯è¿™æ ·ä¸æ˜¯æ›´æœ‰è¶£å—ğŸ¤“ã€‚

## [](#conclusion)ç»“è®º

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è®²è¿°äº†å¦‚ä½•ä½¿ç”¨`io-ts`åŒ…ç¡®ä¿ TypeScript ä¸­çš„éšæœºå€¼ç¬¦åˆé™æ€æ¥å£ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨`fp-ts`å¤„ç†æœ€ç»ˆçš„å®‰å…¨å€¼ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å°†è®¾ç½®ä¸€ä¸ªå°åº”ç”¨ç¨‹åºï¼Œå®ƒä¸æ¨¡æ‹ŸæœåŠ¡å™¨å¯¹è¯å¹¶å¤„ç†æ‰€æœ‰é”™è¯¯ã€‚`fp-ts`ä¸­ä¼šæœ‰ä¸€äº›çŠ¶æ€å»ºæ¨¡ï¼Œæœ‰æ›´å¤šçš„åŠŸèƒ½æ€§æ‹›æ•°å¯ä»¥äº«å—ã€‚ç›´åˆ°é‚£æ—¶ï¼