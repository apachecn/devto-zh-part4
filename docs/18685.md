# ç”¨ async/await å¤„ç†æ•°ç»„ä¸­çš„æ‰¿è¯º

> åŸæ–‡:[https://dev . to/afifsohaili/dealing-with-async-await-5d 7g å¤„ç†æ‰¿è¯ºæ•°ç»„](https://dev.to/afifsohaili/dealing-with-promises-in-an-array-with-async-await-5d7g)

Promises and `async/await`æ˜¯æ–°ç‰ˆæœ¬ JavaScript çš„ä¸€ä¸ªå—æ¬¢è¿çš„è¡¥å……ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰ä½¿ç”¨å®ƒï¼Œå¹¶ä¸”è¢«å›°åœ¨*å›è°ƒåœ°ç‹±*ï¼Œä½ å¯èƒ½æƒ³è¦æ£€æŸ¥å®ƒå¹¶ä¸”å·²ç»å¼€å§‹ä½¿ç”¨å®ƒã€‚ç›¸ä¿¡æˆ‘ï¼Œå¾ˆç‰›é€¼ï¼[MDN æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)å°†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ï¼Œå¹¶ä¸” [CSS-Tricks](https://css-tricks.com/using-es2017-async-functions/) ä¹Ÿæœ‰ä¸€ç¯‡å…³äºå®ƒçš„å¥½æ–‡ç« ã€‚

ä½†æ˜¯å½“ä½¿ç”¨`async/await`æ¥å¤„ç†ä¸€ç»„æ‰¿è¯ºæ—¶ï¼Œå°±æœ‰ç‚¹æ£˜æ‰‹äº†ã€‚è°¢å¤©è°¢åœ°ï¼Œè¿™æ˜¯æˆ‘æ ¹æ®è‡ªå·±çš„ç»éªŒå†™çš„å¯¹ä»˜å®ƒä»¬çš„å¤‡å¿˜å•ã€‚

*é™„:æ²¡æœ‰å¤–éƒ¨åº“ï¼*ğŸ˜‰

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹å¼‚æ­¥å‡½æ•°:

```
const resolveInTwoSeconds = () => {
  return new Promise((resolve) => {
    setTimeout(() => resolve(2), 2000);
  })
};

const resolveInThreeSeconds = () => {
  return new Promise((resolve) => {
    setTimeout(() => resolve(3), 3000);
  })
};

const resolveInFiveSeconds = () => {
  return new Promise((resolve) => {
    setTimeout(() => resolve(5), 5000);
  })
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#1-wait-for-all-promises-to-complete-with-promiseall)1ã€‚ç­‰å¾…æ‰€æœ‰æ‰¿è¯ºä»¥ Promise.all å®Œæˆ

æ¥å—ä¸€ä¸ªæ‰¿è¯ºæ•°ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„æ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºåªæœ‰åœ¨æ•°ç»„ä¸­çš„æ‰€æœ‰æ‰¿è¯ºéƒ½è¢«è§£æåæ‰è¢«è§£æã€‚æ‰¿è¯ºè§£æä¸ºæ¯ä¸ªæ‰¿è¯ºè¿”å›çš„æ‰€æœ‰å€¼çš„æ•°ç»„ã€‚

```
(async function() {
  const asyncFunctions = [
    resolveInTwoSeconds(),
    resolveInThreeSeconds(),
    resolveInFiveSeconds()
  ];
  const results = await Promise.all(asyncFunctions);
  // outputs `[2, 3, 5]` after five seconds
  console.log(results);
})(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#2-wait-for-at-least-one-promise-to-complete-with-promiserace)2ã€‚ç­‰å¾…è‡³å°‘ä¸€ä¸ªæ‰¿è¯ºï¼Œå®Œæˆæ‰¿è¯ºã€‚èµ›è·‘

æ¥å—ä¸€ä¸ªæ‰¿è¯ºæ•°ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„æ‰¿è¯ºï¼Œå½“æ•°ç»„ä¸­çš„ä¸€ä¸ªæ‰¿è¯ºè¢«è§£ææ—¶ï¼Œè¯¥æ‰¿è¯ºå°†ç«‹å³è§£æï¼Œå¹¶è¿”å›è¯¥æ‰¿è¯ºçš„å€¼ã€‚

```
(async function() {
  const asyncFunctions = [
    resolveInTwoSeconds(),
    resolveInThreeSeconds(),
    resolveInFiveSeconds()
  ];
  const result = await Promise.race(asyncFunctions);
  // outputs `2` after two seconds
  console.log(result);
})(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#3-wait-for-all-promises-to-complete-onebyone)3ã€‚ç­‰å¾…æ‰€æœ‰æ‰¿è¯ºé€ä¸€å®Œæˆ

å®ç°è¿™ä¸€ç‚¹æœ€ç®€å•ã€æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯ä½¿ç”¨æ™®é€šçš„è€å¼`for`å¾ªç¯ã€‚å®ƒå¯è¯»æ€§å¼ºï¼Œä¹Ÿå®¹æ˜“æ¨ç†ã€‚

```
(async function() {
  const asyncFunctions = [resolveInTwoSeconds, resolveInThreeSeconds, resolveInFiveSeconds];
  // outputs 2 after 2 seconds
  // outputs 3 after 5 seconds
  // outputs 5 after 8 seconds
  for (const asyncFn of asyncFunctions) {
    const result = await asyncFn();
    console.log(result);
  }
})(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æ›´æ–°:ä¸‹é¢çš„æ–¹æ³•æ˜¯å¸–å­ä¸­çš„åŸå§‹æ–¹æ³•ï¼Œä½†ç»è¿‡å¤šå¹´çš„æ–°ç»éªŒï¼Œæˆ‘å·²ç»æ„è¯†åˆ°è¿™ä¸å¿…è¦åœ°ä½¿äº‹æƒ…å˜å¾—å¤æ‚ï¼Œæˆ‘åªæ˜¯å°†`reduce`ç¼–ç¨‹ä¸ºç±»ä¼¼äº`for`å¾ªç¯çš„è¡Œä¸ºã€‚å»ºè®®:ä¸ºæ­¤åªä½¿ç”¨ for å¾ªç¯ã€‚æœ‰å…´è¶£çš„è¯è¿˜ç•™åœ¨è¿™é‡Œ*

åœ¨`Promise`ç±»ä¸­æ²¡æœ‰æœ¬åœ°æ–¹æ³•å¯ä»¥å¿«é€Ÿåšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨`Array.prototype.reduce`æ–¹æ³•æ¥å®ç°è¿™ä¸ªç›®æ ‡ã€‚

```
(async function() {
  const asyncFunctions = [resolveInTwoSeconds, resolveInThreeSeconds, resolveInFiveSeconds];
  // outputs 2 after 2 seconds
  // outputs 3 after 5 seconds
  // outputs 5 after 8 seconds
  await asyncFunctions.reduce(async (previousPromise, nextAsyncFunction) => {
    await previousPromise;
    const result = await nextAsyncFunction();
    console.log(result);
  }, Promise.resolve());
})(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ¯”ä»¥å‰çš„å®ç°ä¸å¤ªç›´æ¥ï¼Œä½†æ˜¯æˆ‘å°†å†™ä¸€ç¯‡å•ç‹¬çš„æ–‡ç« æ¥è§£é‡Šè¿™ä¸€ç‚¹ã€‚è®©æˆ‘ä»¬ä¿ç•™è¿™ä¸ªå¸–å­åªæ˜¯ä¸ºäº†å¿«é€Ÿæ£€æŸ¥ğŸ˜‰ã€‚

## [](#4-run-async-functions-batchbybatch-with-each-batch-of-functions-executed-in-parallel)4ã€‚é€æ‰¹è¿è¡Œå¼‚æ­¥å‡½æ•°ï¼Œæ¯æ‰¹å‡½æ•°å¹¶è¡Œæ‰§è¡Œ

å¦‚æœæ‚¨æƒ³é¿å…è¾¾åˆ°æŸäº› API æœåŠ¡çš„é€Ÿç‡é™åˆ¶ï¼Œè¿™çœŸçš„å¾ˆæœ‰å¸®åŠ©ã€‚è¿™åˆ©ç”¨äº†#3 ä¸­çš„ç›¸åŒæ¦‚å¿µï¼Œå…¶ä¸­æˆ‘ä»¬æœ‰ä¸€ä¸ªé¡ºåºè§£æçš„æ‰¿è¯ºæ•°ç»„ï¼Œç»“åˆäº†ä¸€ä¸ªäºŒç»´æ‰¿è¯ºæ•°ç»„å’Œ`Promise.all`çš„ä½¿ç”¨ã€‚

è¿™é‡Œçš„å…³é”®æ˜¯é¦–å…ˆåœ¨äºŒç»´æ•°ç»„ä¸­æ„å»ºå¼‚æ­¥å‡½æ•°çš„é›†åˆã€‚ä¸€æ—¦æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿­ä»£æ¯ä¸ªå¼‚æ­¥å‡½æ•°é›†åˆå¹¶å¹¶è¡Œæ‰§è¡Œå®ƒä»¬ï¼Œå¹¶ä½¿ç”¨`Promise.all`ç­‰å¾…æ¯ä¸ªå‡½æ•°å®Œæˆã€‚åœ¨å½“å‰æ‰¹ä¸­çš„æ‰€æœ‰æ‰¿è¯ºè§£å†³ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸ä¼šå¤„ç†ä¸‹ä¸€æ‰¹ã€‚

```
(async function() {
  const asyncFunctionsInBatches = [
    [resolveInTwoSeconds, resolveInTwoSeconds],
    [resolveInThreeSeconds, resolveInThreeSeconds],
    [resolveInFiveSeconds, resolveInFiveSeconds],
  ];

  // Outputs [2, 2] after two seconds
  // Outputs [3, 3] after five seconds
  // Outputs [5, 5] after eight seconds
  for (const currentBatch of asyncFunctionsInBatches) {
    const currentBatchPromises = currentBatch.map(asyncFn => asyncFn())
    const batchResults = await Promise.all(currentBatchPromises)
    console.log(batchResults)
  }
})(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æ›´æ–°:å†ä¸€æ¬¡ï¼Œä¸‹é¢çš„æ–¹æ³•æ˜¯å¸–å­ä¸­çš„åŸå§‹æ–¹æ³•ï¼Œä½†æ˜¯ç»è¿‡å¤šå¹´çš„æ–°ç»éªŒï¼Œæˆ‘å·²ç»æ„è¯†åˆ°è¿™ä¸å¿…è¦åœ°ä½¿äº‹æƒ…å˜å¾—å¤æ‚ï¼Œæˆ‘åªæ˜¯å°†`reduce`å˜æˆäº†ä¸€ä¸ª`for`å¾ªç¯ã€‚å»ºè®®:ä¸ºæ­¤åªä½¿ç”¨ for å¾ªç¯ã€‚æœ‰å…´è¶£çš„è¯è¿˜ç•™åœ¨è¿™é‡Œ*

ä¸‹é¢æ˜¯ä¸Šè¿°æ¦‚å¿µçš„å®Œæ•´å®ç°:

```
(async function() {
  const asyncFunctionsInBatches = [
    [resolveInTwoSeconds, resolveInTwoSeconds],
    [resolveInThreeSeconds, resolveInThreeSeconds],
    [resolveInFiveSeconds, resolveInFiveSeconds],
  ];

  // Outputs [2, 2] after two seconds
  // Outputs [3, 3] after five seconds
  // Outputs [5, 5] after eight seconds
  await asyncFunctionsInBatches.reduce(async (previousBatch, currentBatch, index) => {
    await previousBatch;
    console.log(`Processing batch ${index}...`);
    const currentBatchPromises = currentBatch.map(asyncFunction => asyncFunction())
    const result = await Promise.all(currentBatchPromises);
    console.log(result);
  }, Promise.resolve());
})(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·è®°ä½ï¼Œæˆ‘åœ¨è¿™é‡Œæ˜¯é€šè¿‡ç¡¬ç¼–ç æ¥æ„å»ºå¼‚æ­¥å‡½æ•°æ‰¹å¤„ç†çš„ã€‚åœ¨å®é™…çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨å¯èƒ½ä¼šä» API è°ƒç”¨ç­‰è¿”å›ä¸€ä¸ªåŠ¨æ€é•¿åº¦çš„æ•°ç»„ï¼Œæ‰€ä»¥æ‚¨å¿…é¡»è‡ªå·±å°†å®ƒä»¬åˆ†å¼€ã€‚è¯¥ä»»åŠ¡çš„å¿«é€Ÿå®ç°:

```
const splitInBatch = (arr, batchSize) => {
  return arr.reduce((accumulator, element, index) => {
    const batchIndex = Math.floor(index / batchSize);
    if (Array.isArray(accumulator[batchIndex])) {
      accumulator[batchIndex].push(element);
    } else {
      accumulator.push([element]);
    }
    return accumulator;
  }, []);
}

// outputs [[1, 2, 3], [4, 5, 6]]
console.log(splitInBatch([1, 2, 3, 4, 5, 6], 3)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©åƒ`lodash`è¿™æ ·çš„åº“æ¥å¸®åŠ©æ‚¨å®Œæˆè¿™é¡¹ä»»åŠ¡ã€‚

```
import chunk from 'lodash.chunk';

// outputs [[1, 2, 3], [4, 5, 6]]
console.log(chunk([1, 2, 3, 4, 5, 6], 3)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#5-bonus-tip-do-not-pass-an-async-function-to-foreach)5ã€‚é¢å¤–æç¤º:ä¸è¦å°†å¼‚æ­¥å‡½æ•°ä¼ é€’ç»™ forEach

è®°ä½ï¼Œ`Array.prototype.map`å’Œ`Array.prototype.forEach`çš„åŒºåˆ«åœ¨äºï¼Œåè€…å¹¶ä¸è¿”å›æ¯æ¬¡è¿­ä»£çš„ç»“æœã€‚å¦‚æœæˆ‘ä»¬å°†`async`å‡½æ•°ä¼ é€’ç»™`forEach`ï¼Œæˆ‘ä»¬å°±æ²¡æœ‰åŠæ³•å–å›è¿”å›çš„æ‰¿è¯ºæ¥åšä»»ä½•æœ‰ç”¨çš„äº‹æƒ…ã€‚é™¤éä½ æƒ³å¯åŠ¨å¼‚æ­¥å‡½æ•°å¹¶å¿˜æ‰å®ƒï¼Œå¦åˆ™å°†å¼‚æ­¥å‡½æ•°ä¼ é€’ç»™`forEach`æ°¸è¿œä¸æ˜¯ä½ æƒ³åšçš„äº‹æƒ…ã€‚

### [](#conclusion)ç»“è®º

è¿™å°±å¯¹äº†ã€‚è¿™æ˜¯å…³äºä¸€ç³»åˆ—æ‰¿è¯ºä¸­è¯¥åšä»€ä¹ˆå’Œä¸è¯¥åšä»€ä¹ˆçš„ 5 å¼ å¤‡å¿˜å•ã€‚æˆ‘å¸Œæœ›è¿™å¯¹ä½ ä»¬æ‰€æœ‰äººéƒ½æœ‰ç”¨ğŸ˜ï¼Œå¦‚æœæˆ‘æœ‰ä»€ä¹ˆéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œè¯·åœ¨è¯„è®ºåŒºå‘Šè¯‰æˆ‘ã€‚

å†è§ï¼