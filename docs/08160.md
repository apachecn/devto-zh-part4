# ç”¨çº¯ kotlin æ„å»ºä¸€ä¸ªå°å‹ S3 æµè§ˆå™¨

> åŸæ–‡:[https://dev . to/shavz/building-a-small-S3-browser-in-pure-kot Lin-em](https://dev.to/shavz/building-a-small-s3-browser-in-pure-kotlin-em)

(x-è´´è‡ªæˆ‘çš„åšå®¢[æ­¤å¤„](https://www.shiveenp.com/2019/07/29/S3-Browser-With-Kweb/))

## [](#background)èƒŒæ™¯

æœ€è¿‘ï¼Œæˆ‘å‘ç°è‡ªå·±æ‰‹å¤´æœ‰äº†ä¸€ç‚¹é¢å¤–çš„å¼€å‘æ—¶é—´ã€‚é€šå¸¸ï¼Œæˆ‘çš„å¤§éƒ¨åˆ†é¡¹ç›®éƒ½æ˜¯ä»ä¼Ÿå¤§çš„æƒ³æ³•å¼€å§‹çš„ï¼Œä¸€æ—¦æˆ‘å¼€å§‹ç€æ‰‹ï¼Œæˆ‘å°±ä¼šå¤±å»åŠ¨åŠ›æˆ–è€…ç”Ÿæ´»é˜»ç¢äº†æˆ‘ï¼Œäº‹æƒ…å°±åƒä¸€ä¸ªç§äºº github å›è´­ä¸€æ ·è¢«æç½®äº†ã€‚

ç„¶è€Œï¼Œæˆ‘å¶ç„¶å‘ç°äº† Kwebï¼Œè¿™æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ç«¯æ¸²æŸ“çš„ web åº”ç”¨æ„å»ºåº“ï¼Œä½†å®Œå…¨æ˜¯ç”¨ Kotlin ç¼–å†™çš„ã€‚Kweb æä¾›äº†ä¸€ä¸ªæ¼‚äº®çš„ [dsl](https://en.wikipedia.org/wiki/Domain-specific_language) å¼ç•Œé¢ï¼Œé€šè¿‡ç¼–ç¨‹å®šä¹‰åº”ç”¨ç¨‹åºçš„ html å…ƒç´ æ¥æ„å»º web åº”ç”¨ç¨‹åºï¼Œè€Œä¸æ˜¯æ‰‹å·¥ç¼–å†™ html å’Œ CSSã€‚å¯¹äºé‚£äº›ä¸çŸ¥é“çš„äººï¼ŒKotlin æä¾›äº†ä¸€ç§éå¸¸å¥½çš„æ–¹æ³•æ¥æ„å»º[ç±»å‹çš„å®‰å…¨å£°æ˜æ„å»ºå™¨](https://kotlinlang.org/docs/reference/type-safe-builders.html)ã€‚

å› ä¸ºå®ƒéƒ½æ˜¯åœ¨ kotlin ä»£ç ä¸­å£°æ˜æ€§åœ°åˆ›å»ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°äº† access åç¨‹ã€æ‰©å±•å’Œæ‰€æœ‰ä½¿ Kotlin å·¥ä½œå¦‚æ­¤æ„‰å¿«çš„å¥½ä¸œè¥¿ã€‚å¯¹äºé‚£äº›ä»¥å‰ä½¿ç”¨è¿‡åŸºäºçº¯ä»£ç çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“æ¡†æ¶çš„äººæ¥è¯´ï¼Œè¿™å¯èƒ½ä¼šè®©ä½ æƒ³èµ· [Vaadin](https://vaadin.com/) ï¼Œå®ƒæ˜¯è¿™ä¸ªé¢†åŸŸçš„è¡Œä¸šé¢†å¯¼è€…ï¼Œä½†æ˜¯ä½ å¯ä»¥åœ¨ [Kweb å¸¸è§é—®é¢˜è§£ç­”](http://docs.kweb.io/en/latest/faq.html)ä¸­æ‰¾åˆ°ç»†å¾®å’Œä¸å¤ªç»†å¾®çš„å·®å¼‚ã€‚

æµè§ˆä»–ä»¬çš„ä»£ç åº“ï¼Œæˆ‘è®¤ä¸ºè¿™å°†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æœºä¼šï¼Œå°è¯•é€šè¿‡ä½¿ç”¨çº¯ kotlin æ¥æ„å»ºä¸€ä¸ªå¿«é€Ÿç®€å•çš„åº”ç”¨ç¨‹åºã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆé—®ï¼Ÿå› ä¸ºå®ƒå¾ˆå¿«ï¼Œæˆ‘å¯ä»¥åœ¨å‡ ä¸ªå°æ—¶å†…æŠŠå®ƒæ‰“ç¢ã€‚

## [](#simple-kotlin-s3-client)ç®€å•çš„ç§‘ç‰¹æ— S3 å®¢æˆ·ç«¯

é¦–å…ˆï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªåŸºæœ¬çš„ S3 æµè§ˆç±»ï¼Œä»å°å¤„ç€æ‰‹â€”â€”æˆ‘å¤åˆ¶äº† AWS ç¤ºä¾‹ä¸­å…³äºåˆ›å»ºæ–° S#å®¢æˆ·ç«¯çš„ä»£ç ï¼Œç„¶åæ·»åŠ äº†åœ¨ç»™å®šæ¡¶ä¸­æœç´¢æ‰€æœ‰å…¬é’¥å¹¶è·å–ä¸€äº›å…ƒæ•°æ®å’Œä¸‹è½½é“¾æ¥çš„åŠŸèƒ½:

```
class S3Client(private val endpoint: String, private val bucketName: String) {

    private val client = AmazonS3ClientBuilder.standard()
        .withPathStyleAccessEnabled(true)
        .withEndpointConfiguration(AwsClientBuilder.EndpointConfiguration(endpoint, "ap-southeast-2"))
        .build()

    fun listAllKeys(): List<S3Data> {
        val req = ListObjectsV2Request().withBucketName(bucketName).withMaxKeys(10)
        val keyList = mutableListOf<S3Data>()
        client.listObjectsV2(req).objectSummaries.forEach {
            keyList.add(S3Data(it.key, "$endpoint/$bucketName/${it.key}", it.size.toString().toDouble() / 1000.0, it.lastModified.toString()))
        }
        return keyList
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`listAllKeys()`å‡½æ•°è¿”å›ç»™å®šæ¡¶ä¸­æ‰€æœ‰é”®çš„åˆ—è¡¨ï¼Œç„¶åæˆ‘å¯ä»¥å°†å®ƒæ˜ å°„åˆ°ä¸€ä¸ªå®šåˆ¶çš„ S3Data ç±»:

```
data class S3Data(
    val key: String,
    val downloadUrl: String,
    val size: Double,
    val lastModifiedAt: String
) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#building-the-ui-with-kweb)ç”¨ Kweb æ„å»º UI

å®Œæˆåï¼Œæˆ‘å¼€å§‹ç ´è§£ UI ç•Œé¢ã€‚æˆ‘æƒ³è¦ä¸€äº›å¿«é€Ÿç®€å•ï¼Œç”šè‡³ç²—ç³™çš„ä¸œè¥¿ï¼Œåªæ˜¯ä¸ºäº†è¯æ˜å®ƒéƒ½åƒæè®®çš„é‚£æ ·å·¥ä½œã€‚æ‰€ä»¥æˆ‘è®¾ç½®äº†ä¸€ä¸ªå®¹å™¨ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›è¡¨å•å­—æ®µã€ä¸€ä¸ªæœç´¢æŒ‰é’®å’Œä¸€ä¸ªè¡¨ï¼Œç”¨äºè¾“å…¥ S3 åœ°åŒºé“¾æ¥å’Œå­˜å‚¨æ¡¶çš„åç§°ã€‚

æˆ‘è¿˜éœ€è¦ä¸€ä¸ªè¡¨æ¥æ˜¾ç¤ºæ‰€æœ‰çš„é”®(æ²¡æœ‰åˆ†é¡µï¼Œè°ä¼šåœ¨ PoCs ä¸­æ„å»ºåˆ†é¡µå‘¢ï¼ŸğŸ¤ ).ä¸ºäº†èƒ½å¤Ÿä¿å­˜æ•°æ®ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªå«åš [KVAR](https://github.com/kwebio/kweb-core/blob/master/src/main/kotlin/io/kweb/state/KVar.kt) çš„ä¸œè¥¿ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªçŠ¶æ€å­˜å‚¨ï¼Œè¢« Kweb ç”¨æ¥æ”¯æŒé€šè¿‡[è§‚å¯Ÿè€…æ¨¡å¼](https://en.wikipedia.org/wiki/Observer_pattern)å°†çŠ¶æ€å˜åŒ–ä¼ æ’­åˆ° web åº”ç”¨ç¨‹åºã€‚

ä»¥ä¸‹ä»£ç ç‰‡æ®µè·å–å¹¶åˆå§‹åŒ– S3 æ•°æ® Kvar(æœ€åˆè®¾ç½®ä¸ºç©ºåˆ—è¡¨)ï¼Œæœ€ç»ˆå°†å…¶ä¼ æ’­åˆ°è¡¨æ ¼:

```
div(fomantic.ui.main.container).new {
    div(fomantic.ui.vertical.segment).new {
        div(fomantic.ui.header).text("Welcome to S3 Browser ğŸ’»")
    }

    val keyData = KVar(emptyList<S3Data>())

    val loader = div(mapOf("class" to "ui active text loader")).addText("Retrieving keys...")
    loader.setAttribute("class", "ui disabled text loader")
    createInputSegment(loader, keyData)
    createKeysTable(keyData)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œè¿™å°±æ˜¯ Kwebs ä¸ kotlin çš„æ·±åº¦é›†æˆçœŸæ­£æ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨ [kotlin åç¨‹](https://kotlinlang.org/docs/reference/coroutines-overview.html)æ¥å¤„ç†å…·æœ‰å¤§é‡ i/o çš„ä»»åŠ¡(æ¯”å¦‚ä» AWS æ¡¶ä¸­æ£€ç´¢æ•°æ®)ã€‚æˆ‘æœ€è¿‘å¼€å§‹åœ¨ç”Ÿäº§ä»£ç ä¸­é¢‘ç¹ä½¿ç”¨åç¨‹ï¼Œæ¯«æ— ç–‘é—®ï¼Œå®ƒä»¬æ˜¯ç¼–å†™å¼‚æ­¥ä»»åŠ¡è€Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹çš„æœ€ä½³æ–¹å¼ã€‚ä½æ¥è§¦è¯­æ³•è®¾ç½®å’Œç»“æœæ˜¯å¦‚æ­¤ç®€å•ï¼Œå‡ ä¹æ„Ÿè§‰åƒä½œå¼Šã€‚

ä¸‹é¢çš„ä»£ç ç‰‡æ®µä½¿ç”¨å‰é¢ä»‹ç»çš„`S3Client`æ¥å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æœç´¢æŒ‰é’®æ—¶ï¼Œæ˜¾ç¤ºä¸€ä¸ªåŠ è½½å›¾æ ‡ï¼Œç›´åˆ°æ£€ç´¢åˆ°æ‰€æœ‰æ•°æ®æˆ–è€…æŠ›å‡ºä¸€ä¸ªé”™è¯¯:

```
private fun ElementCreator<DivElement>.createInputSegment(
    loader: Element,
    keyData: KVar<List<S3Data>>
) {
    div(fomantic.ui.vertical.segment).new {
        div(fomantic.ui.input).new {
            val endpointInput = input(type = InputType.text, placeholder = "Enter S3 Endpoint Url")
            val bucketInput = input(type = InputType.text, placeholder = "Enter S3 Bucket Name")
            button(mapOf("class" to "ui primary button")).text("Search").on.click {
                GlobalScope.launch {
                    loader.setAttribute("class", "ui active text loader")
                    val s3Client =
                        S3Client(endpointInput.getValue().await(), bucketInput.getValue().await())
                    try {
                        keyData.value = s3Client.listAllKeys()
                    } catch (ex: Exception) {
                        p().execute(ERROR_TOAST)
                        loader.setAttribute("class", "ui disabled text loader")
                    }
                    if (keyData.value.isNotEmpty()) {
                        p().execute(SUCCESS_TOAST)
                        loader.setAttribute("class", "ui disabled text loader")
                    }
                }
            }
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ°ç›®å‰ä¸ºæ­¢ä¸€åˆ‡é¡ºåˆ©ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æˆåŠŸåœ°å°†æ•°æ®æ”¾å…¥äº† Kvar å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å‘ˆç°ä¸€ä¸ªè¡¨æ ¼äº†ã€‚ç°åœ¨ï¼Œæˆ‘è¿˜æƒ³æ˜¾ç¤ºä¸€ä¸ªæ¼‚äº®çš„å°å›¾æ ‡ï¼Œä»¥è¡¨æ˜æ£€ç´¢åˆ°çš„å¯¹è±¡æ˜¯ä¸€ä¸ªæ–‡ä»¶â€”â€”å¹¶ä¸”è¿˜å…è®¸ç”¨æˆ·å•å‡»ä½œä¸ºé“¾æ¥çš„é”®çš„åç§°ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥ä¸‹è½½ã€‚

ç°åœ¨ï¼Œæ®æˆ‘æ‰€çŸ¥ï¼ŒKweb æ²¡æœ‰èƒ½åŠ›é€šè¿‡ DSL å¯¹è±¡æ¥æŒ‡å®šï¼Œä½†æ˜¯ï¼Œå®ƒæä¾›äº†åœ¨è¡¨å…ƒç´ ä¸­æŒ‡å®šåµŒå¥— HTML çš„èƒ½åŠ›ï¼Œä»¥æ·»åŠ æˆ‘è‡ªå·±çš„è‡ªå®šä¹‰è¡Œä¸ºã€‚

```
private fun ElementCreator<DivElement>.createKeysTable(
    keyData: KVar<List<S3Data>>
) {
    table(mapOf("class" to "ui celled striped table")).new {
        thead().new {
            tr().new {
                th().text("Key")
                th().text("File Size (in KB)")
                th().text("Last Modified At")
            }
        }
        tbody().new {
            keyData.map {
                it.forEach {
                    tr().new {
                        td(mapOf("data-lable" to "Key")).innerHTML("<i class=\"file outline icon\"></i> <a target=\"_blank\" href=${it.downloadUrl} download=${it.key}>${it.key}</a>")
                        td(mapOf("data-lable" to "File Size")).text("${it.size} KB")
                        td(mapOf("data-lable" to "Last Modified At")).text(it.lastModifiedAt)

                    }
                }
            }
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªæ–°è¡¨ï¼Œå¹¶åœ¨è¡¨ä¸­ä¸ºæä¾›çš„ bucket ä¸­çš„æ¯ä¸ªå…¬é’¥ç”Ÿæˆäº†ä¸€ä¸ªæ–°è¡Œã€‚å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™ä¸ä¼šå‘ˆç°ä»»ä½•å†…å®¹ã€‚

è¿™å¯èƒ½ä¹Ÿæ˜¯æ—¶å€™ä¸º Kweb çš„åˆ›å»ºè€…ä»¬æä¾›ä¸€ä¸ªä¸é¢„é…ç½®äº†æ¼‚äº® UI å…ƒç´ çš„ [Fomantic UI](https://fomantic-ui.com/) çš„é›†æˆäº†ã€‚å°½ç®¡å¦‚æ­¤ï¼Œé›†æˆå¹¶æ²¡æœ‰å°±æ­¤ç»“æŸï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ APiï¼Œä»»ä½•äººéƒ½å¯ä»¥ç”¨ä»–ä»¬æœ€å–œæ¬¢çš„ UI å…ƒç´ åº“ç¼–å†™ä¸€ä¸ªæ–°çš„æ’ä»¶ã€‚

## [](#final-notes)æœŸæœ«ç¬”è®°

è¿™å°±æ˜¯ä½¿ç”¨ Kweb ç¼–å†™ä¸€ä¸ªç®€å•çš„ S3 æµè§ˆ web åº”ç”¨ç¨‹åºæ‰€éœ€çš„å…¨éƒ¨å†…å®¹ã€‚[è¿™é‡Œçš„](https://secure-scrubland-34237.herokuapp.com/)æ˜¯éƒ¨ç½²åœ¨ heroku ä¸Šçš„ appï¼Œå®Œæ•´çš„å·¥ä½œä»£ç åœ¨ [github](https://github.com/shavz/Bows3r) ä¸Šã€‚

Gif æ¼”ç¤º:

[![](../Images/4595e102389dd724246b8650b3f08c60.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--TPVvSEcH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://imgur.com/YoJdUxj.gif)