# WebGL æœˆä»½ã€‚ç¬¬ 27 å¤©ã€‚ç‚¹å‡»æ£€æµ‹ã€‚ç¬¬ä¸€éƒ¨åˆ†

> åŸæ–‡:[https://dev . to/lesnitsky/web GL-month-day-27-click-detection-part-I-5920](https://dev.to/lesnitsky/webgl-month-day-27-click-detection-part-i-5920)

è¿™æ˜¯ä¸€ç³»åˆ—ä¸ WebGL ç›¸å…³çš„åšæ–‡ã€‚æ¯å¤©éƒ½ä¼šæœ‰æ–°å¸–å­

[![GitHub stars](../Images/3ff55948c21c6468c418e8ea7b5806ff.png)](https://github.com/lesnitsky/webgl-month)
[![Twitter Follow](../Images/048d0e5c2caabc2543f4d2b7477db9df.png)T6ã€‘](https://twitter.com/lesnitsky_a)

[åŠ å…¥é‚®ä»¶åˆ—è¡¨](http://eepurl.com/gwiSeH),è®©æ–°é‚®ä»¶ç›´æ¥è¿›å…¥ä½ çš„æ”¶ä»¶ç®±

[æ­¤å¤„æä¾›æºä»£ç ](https://github.com/lesnitsky/webgl-month)

å»ºé€ äº

[![Git Tutor Logo](../Images/4a5fcbd1126401b65ca7fbe362404aa0.png)T2ã€‘](https://github.com/lesnitsky/git-tutor)

* * *

å˜¿ğŸ‘‹

æ˜¨å¤©æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•æ¸²æŸ“çº¹ç†ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èƒ½åŠ›ï¼Œå¯ä»¥åœ¨åœºæ™¯å®Œå…¨æ¸²æŸ“åäº§ç”Ÿä¸€äº›å¾ˆå¥½çš„æ•ˆæœï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å±å¹•å¤–æ¸²æŸ“æ¥åšå…¶ä»–äº‹æƒ…ã€‚

äº¤äº’å¼ 3D ä¸­ä¸€ä¸ªé‡è¦çš„äº‹æƒ…æ˜¯ç‚¹å‡»æ£€æµ‹ã€‚è™½ç„¶å®ƒå¯èƒ½æ˜¯ç”¨ javascript å®Œæˆçš„ï¼Œä½†å®ƒæ¶‰åŠä¸€äº›å¤æ‚çš„æ•°å­¦ã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥:

*   ä¸ºæ¯ä¸ªå¯¹è±¡æŒ‡å®šå”¯ä¸€çš„çº¯è‰²
*   å°†åœºæ™¯æ¸²æŸ“åˆ°çº¹ç†
*   è¯»å–å…‰æ ‡ä¸‹çš„åƒç´ é¢œè‰²
*   å°†é¢œè‰²ä¸å¯¹è±¡åŒ¹é…

å› ä¸ºæˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªå¸§ç¼“å†²åŒºï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŠ©æ‰‹ç±»

src/å½©ç°ç¼“å†²åŒº. js

```
export class RenderBuffer {
    constructor(gl) {
        this.framebuffer = gl.createFramebuffer();
        this.texture = gl.createTexture();
    }
} 
```

è®¾ç½®å¸§ç¼“å†²åŒºå’Œé¢œè‰²çº¹ç†

src/å½©ç°ç¼“å†²åŒº. js

```
 constructor(gl) {
          this.framebuffer = gl.createFramebuffer();
          this.texture = gl.createTexture();
+ 
+         gl.bindTexture(gl.TEXTURE_2D, this.texture);
+         gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.canvas.width, gl.canvas.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
+ 
+         gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
+         gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
+         gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
+ 
+         gl.bindFramebuffer(gl.FRAMEBUFFER, this.framebuffer);
+         gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, this.texture, 0);
      }
  } 
```

è®¾ç½®æ·±åº¦ç¼“å†²å™¨

src/å½©ç°ç¼“å†²åŒº. js

```
 gl.bindFramebuffer(gl.FRAMEBUFFER, this.framebuffer);
          gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, this.texture, 0);
+ 
+         this.depthBuffer = gl.createRenderbuffer();
+         gl.bindRenderbuffer(gl.RENDERBUFFER, this.depthBuffer);
+ 
+         gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, gl.canvas.width, gl.canvas.height);
+         gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, this.depthBuffer);
      }
  } 
```

å®ç°ç»‘å®šæ–¹æ³•

src/å½©ç°ç¼“å†²åŒº. js

```
 gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, gl.canvas.width, gl.canvas.height);
          gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, this.depthBuffer);
      }
+ 
+     bind(gl) {
+         gl.bindFramebuffer(gl.FRAMEBUFFER, this.framebuffer);
+     }
  } 
```

æ¸…æ™°

src/å½©ç°ç¼“å†²åŒº. js

```
 bind(gl) {
          gl.bindFramebuffer(gl.FRAMEBUFFER, this.framebuffer);
      }
+ 
+     clear(gl) {
+         this.bind(gl);
+         gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
+     }
  } 
```

ä½¿ç”¨æ–°çš„åŠ©æ‰‹ç±»

ğŸ“„src/minecraft.js

```
 import { setupShaderInput, compileShader } from './gl-helpers';
  import { GLBuffer } from './GLBuffer';
  import { createRect } from './shape-helpers';
+ import { RenderBuffer } from './RenderBuffer'; 
  const canvas = document.querySelector('canvas');
  const gl = canvas.getContext('webgl');

  mat4.fromTranslation(cameraFocusPointMatrix, cameraFocusPoint);

- const framebuffer = gl.createFramebuffer();
- 
- const texture = gl.createTexture();
- 
- gl.bindTexture(gl.TEXTURE_2D, texture);
- gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, canvas.width, canvas.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
- 
- gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
- gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
- gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
- 
- gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
- gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);
- 
- const depthBuffer = gl.createRenderbuffer();
- gl.bindRenderbuffer(gl.RENDERBUFFER, depthBuffer);
- 
- gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, canvas.width, canvas.height);
- gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, depthBuffer); + const offscreenRenderBuffer = new RenderBuffer(gl); 
  const vShader = gl.createShader(gl.VERTEX_SHADER);
  const fShader = gl.createShader(gl.FRAGMENT_SHADER);
  gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);

  function render() {
-     gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
- 
-     gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT); +     offscreenRenderBuffer.clear(gl); 
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, -30]);
      mat4.rotateY(cameraFocusPointMatrix, cameraFocusPointMatrix, Math.PI / 360);
      gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);

      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
-     gl.bindTexture(gl.TEXTURE_2D, texture); +     gl.bindTexture(gl.TEXTURE_2D, offscreenRenderBuffer.texture); 
      gl.drawElements(gl.TRIANGLES, indexBuffer.data.length, gl.UNSIGNED_BYTE, 0); 
```

æˆ‘ä»¬å¯ä»¥åªä¼ é€’å¯¹è±¡ç´¢å¼•ï¼Œè€Œä¸æ˜¯ä¼ é€’å¯¹è±¡çš„æ•´ä¸ªå”¯ä¸€é¢œè‰²ï¼Œè¿™æ˜¯ä¸€ä¸ª vec3

ğŸ“„src/shaders/3d-textured . v . glsl

```
 attribute vec3 position;
  attribute vec2 texCoord;
  attribute mat4 modelMatrix;
+ attribute float index; 
  uniform mat4 viewMatrix;
  uniform mat4 projectionMatrix; 
```

å¹¶å°†è¯¥æµ®ç‚¹è½¬æ¢ä¸ºç€è‰²å™¨ä¸­çš„é¢œè‰²

ğŸ“„src/shaders/3d-textured . v . glsl

```
 varying vec2 vTexCoord;

+ vec3 encodeObject(float id) {
+     int b = int(mod(id, 255.0));
+     int r = int(id) / 255 / 255;
+     int g = (int(id) - b - r * 255 * 255) / 255;
+     return vec3(r, g, b) / 255.0;
+ }
+ 
  void main() {
      gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.0); 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦å°†é¢œè‰²é€šè¿‡å˜é‡ä¼ é€’ç»™ç‰‡æ®µç€è‰²å™¨

ğŸ“„src/shaders/3d-textured . f . glsl

```
 uniform sampler2D texture;

  varying vec2 vTexCoord;
+ varying vec3 vColor; 
  void main() {
      gl_FragColor = texture2D(texture, vTexCoord * vec2(1, -1) + vec2(0, 1)); 
```

ğŸ“„src/shaders/3d-textured . v . glsl

```
 uniform mat4 projectionMatrix;

  varying vec2 vTexCoord;
+ varying vec3 vColor; 
  vec3 encodeObject(float id) {
      int b = int(mod(id, 255.0));
      gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.0);

      vTexCoord = texCoord;
+     vColor = encodeObject(index);
  } 
```

æˆ‘ä»¬è¿˜éœ€è¦æŒ‡å®šæˆ‘ä»¬æƒ³è¦æ¸²æŸ“ä»€ä¹ˆ:æœ‰çº¹ç†çš„ç‰©ä½“è¿˜æ˜¯æœ‰é¢œè‰²çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä¸ºå®ƒä½¿ç”¨ç»Ÿä¸€çš„é¢œè‰²

ğŸ“„src/shaders/3d-textured . f . glsl

```
 varying vec2 vTexCoord;
  varying vec3 vColor;

+ uniform float renderIndices;
+ 
  void main() {
      gl_FragColor = texture2D(texture, vTexCoord * vec2(1, -1) + vec2(0, 1));
+ 
+     if (renderIndices == 1.0) {
+         gl_FragColor.rgb = vColor;
+     }
  } 
```

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºç´¢å¼•æ•°ç»„

ğŸ“„src/minecraft-terrain.js

```
 State.modelMatrix = mat4.create();
      State.rotationMatrix = mat4.create();

+     const indices = new Float32Array(100 * 100);
+ 
      let cubeIndex = 0;

      for (let i = -50; i < 50; i++) { 
```

ç”¨æ•°æ®å¡«å……å®ƒå¹¶è®¾ç½®ä¸€ä¸ª GLBuffer

ğŸ“„src/minecraft-terrain.js

```
 matrices[cubeIndex * 4 * 4 + index] = value;
              });

+             indices[cubeIndex] = cubeIndex;
+ 
              cubeIndex++;
          }
      }

      State.matricesBuffer = new GLBuffer(gl, gl.ARRAY_BUFFER, matrices, gl.STATIC_DRAW);
+     State.indexBuffer = new GLBuffer(gl, gl.ARRAY_BUFFER, indices, gl.STATIC_DRAW); 
      State.offset = 4 * 4; // 4 floats 4 bytes each
      State.stride = State.offset * 4; // 4 rows of 4 floats 
```

ç”±äºæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–° setupAttribute å’Œ resetDivisorAngles å‡½æ•°

ğŸ“„src/minecraft-terrain.js

```
 State.ext.vertexAttribDivisorANGLE(State.programInfo.attributeLocations.modelMatrix + i, 1);
      }
+ 
+     State.indexBuffer.bind(gl);
+     gl.vertexAttribPointer(State.programInfo.attributeLocations.index, 1, gl.FLOAT, false, 0, 0);
+     State.ext.vertexAttribDivisorANGLE(State.programInfo.attributeLocations.index, 1);
  }

  function resetDivisorAngles() {
      for (let i = 0; i < 4; i++) {
          State.ext.vertexAttribDivisorANGLE(State.programInfo.attributeLocations.modelMatrix + i, 0);
      }
+ 
+     State.ext.vertexAttribDivisorANGLE(State.programInfo.attributeLocations.index, 0);
  }

  export function render(gl, viewMatrix, projectionMatrix) { 
```

æœ€åï¼Œæˆ‘ä»¬éœ€è¦æ¸²æŸ“å‡½æ•°çš„å¦ä¸€ä¸ªå‚æ•°æ¥åŒºåˆ†â€œæ¸²æŸ“æ¨¡å¼â€(çº¹ç†ç«‹æ–¹ä½“æˆ–å½©è‰²)

ğŸ“„src/minecraft-terrain.js

```
 State.ext.vertexAttribDivisorANGLE(State.programInfo.attributeLocations.index, 0);
  }

- export function render(gl, viewMatrix, projectionMatrix) {
+ export function render(gl, viewMatrix, projectionMatrix, renderIndices) {
      gl.useProgram(State.program);

      setupAttributes(gl);
      gl.uniformMatrix4fv(State.programInfo.uniformLocations.viewMatrix, false, viewMatrix);
      gl.uniformMatrix4fv(State.programInfo.uniformLocations.projectionMatrix, false, projectionMatrix);

+     if (renderIndices) {
+         gl.uniform1f(State.programInfo.uniformLocations.renderIndices, 1);
+     } else {
+         gl.uniform1f(State.programInfo.uniformLocations.renderIndices, 0);
+     }
+ 
      State.ext.drawArraysInstancedANGLE(gl.TRIANGLES, 0, State.vertexBuffer.data.length / 3, 100 * 100);

      resetDivisorAngles(); 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªæ¸²æŸ“ç¼“å†²åŒºæ¥æ¸²æŸ“å½©è‰²ç«‹æ–¹ä½“

ğŸ“„src/minecraft.js

```
 mat4.fromTranslation(cameraFocusPointMatrix, cameraFocusPoint);

  const offscreenRenderBuffer = new RenderBuffer(gl);
+ const coloredCubesRenderBuffer = new RenderBuffer(gl); 
  const vShader = gl.createShader(gl.VERTEX_SHADER);
  const fShader = gl.createShader(gl.FRAGMENT_SHADER); 
```

ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç‚¹å‡»ç›‘å¬å™¨

ğŸ“„src/minecraft.js

```
 requestAnimationFrame(render);
  }

+ document.body.addEventListener('click', () => {
+     coloredCubesRenderBuffer.bind(gl);
+ });
+ 
  (async () => {
      await prepareSkybox(gl);
      await prepareTerrain(gl); 
```

å¹¶åœ¨æ¯æ¬¡ç”¨æˆ·ç‚¹å‡»ç”»å¸ƒæ—¶å°†å½©è‰²ç«‹æ–¹ä½“æ¸²æŸ“åˆ°çº¹ç†ä¸­

ğŸ“„src/minecraft.js

```
 document.body.addEventListener('click', () => {
      coloredCubesRenderBuffer.bind(gl);
+ 
+     renderTerrain(gl, viewMatrix, projectionMatrix, true);
  });

  (async () => { 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå­˜å‚¨å™¨æ¥è¯»å–åƒç´ é¢œè‰²

ğŸ“„src/minecraft.js

```
 coloredCubesRenderBuffer.bind(gl);

      renderTerrain(gl, viewMatrix, projectionMatrix, true);
+ 
+     const pixels = new Uint8Array(canvas.width * canvas.height * 4);
  });

  (async () => { 
```

å¹¶å®é™…è¯»å–åƒç´ é¢œè‰²

ğŸ“„src/minecraft.js

```
 renderTerrain(gl, viewMatrix, projectionMatrix, true);

      const pixels = new Uint8Array(canvas.width * canvas.height * 4);
+     gl.readPixels(0, 0, canvas.width, canvas.height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
  });

  (async () => { 
```

å°±è¿™æ ·ï¼Œæˆ‘ä»¬ç°åœ¨å°†æ•´ä¸ªåœºæ™¯æ¸²æŸ“åˆ°ä¸€ä¸ªå±å¹•å¤–çš„çº¹ç†ä¸­ï¼Œæ¯ä¸ªç‰©ä½“éƒ½æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„é¢œè‰²ã€‚æˆ‘ä»¬æ˜å¤©å°†ç»§ç»­ç‚¹å‡»æ£€æµ‹

æ„Ÿè°¢é˜…è¯»ï¼ğŸ‘‹

* * *

[![GitHub stars](../Images/3ff55948c21c6468c418e8ea7b5806ff.png)](https://github.com/lesnitsky/webgl-month)
[![Twitter Follow](../Images/048d0e5c2caabc2543f4d2b7477db9df.png)T6ã€‘](https://twitter.com/lesnitsky_a)

[åŠ å…¥é‚®ä»¶åˆ—è¡¨](http://eepurl.com/gwiSeH),è®©æ–°é‚®ä»¶ç›´æ¥è¿›å…¥ä½ çš„æ”¶ä»¶ç®±

[æ­¤å¤„æä¾›æºä»£ç ](https://github.com/lesnitsky/webgl-month)

å»ºé€ äº

[![Git Tutor Logo](../Images/4a5fcbd1126401b65ca7fbe362404aa0.png)T2ã€‘](https://github.com/lesnitsky/git-tutor)