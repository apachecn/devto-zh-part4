# CSRF åœ¨è¡ŒåŠ¨ğŸ­

> åŸæ–‡ï¼š<https://dev.to/_smellycode/csrf-in-action-21n3>

> æœ€åˆå‘è¡¨äº[https://smellycode.com/csrf-in-action/](https://smellycode.com/csrf-in-action/)

[è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ (CSRF/XSRF)](https://en.wikipedia.org/wiki/Cross-site_request_forgery) æ˜¯åˆ©ç”¨æœåŠ¡å™¨çš„æœ€æµè¡Œçš„æ–¹å¼ä¹‹ä¸€ã€‚å®ƒé€šè¿‡å¼ºåˆ¶å®¢æˆ·ç«¯æ‰§è¡Œä¸éœ€è¦çš„æ“ä½œæ¥æ”»å‡»æœåŠ¡å™¨ã€‚è¿™ç§æ”»å‡»çš„ç›®æ ‡æ˜¯å®¢æˆ·ç«¯/ç”¨æˆ·å·²ç»ç™»å½•çš„åº”ç”¨ç¨‹åºã€‚å®ƒä¸»è¦é€šè¿‡æ— æ„ä¸­æ›´æ–°æˆ–ä¼ è¾“æ•°æ®æ¥æ”¹å˜æœåŠ¡å™¨çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œæ›´æ–°é‡è¦ä¿¡æ¯ï¼Œå¦‚ç”µå­é‚®ä»¶å’Œè”ç³»å·ç ç­‰ã€‚æˆ–è€…å°†æ•°æ®ä»ä¸€ä¸ªå®ä½“ä¼ è¾“åˆ°å¦ä¸€ä¸ªå®ä½“ã€‚

[![](img/8d12d2e139a4fe22b5908baa4c67b45a.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--7mP9_Fol--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://smellycode.com/static/0af882791a9890316f4527090a8cd1b6/19607/csrf-in-action-cover-img.jpg)

è¿™ç¯‡æ–‡ç« å±•ç¤ºäº† CSRF çš„æ”»å‡»ï¼Œå¹¶é˜è¿°äº†å›´ç»•å®ƒå¾˜å¾Šçš„æ¦‚å¿µã€‚å®ƒä½¿ç”¨ä¸€ä¸ªç®€å•çš„ todo åº”ç”¨ç¨‹åºå’Œä¸€ä¸ªé‚ªæ¶çš„å®¢æˆ·ç«¯â€”â€”æ›´æ–° todos çš„çŠ¶æ€â€”â€”è¿›è¡Œæ¼”ç¤ºã€‚ä½¿ç”¨çš„æŠ€æœ¯:

*   [å®¢æˆ·ç«¯çš„ååº”](https://reactjs.org/)ã€‚
*   [ExpressJs](https://expressjs.com/) å’Œå‡ ä¸ªæœåŠ¡å™¨ä¸­é—´ä»¶( [CORS](https://github.com/expressjs/cors) ã€ [body-parser](https://github.com/expressjs/body-parser) ã€ [cookie-parser](https://github.com/expressjs/cookie-parser) ç­‰)ã€‚
*   [MongoDb](https://www.mongodb.com/) ä½œä¸ºæ•°æ®åº“ï¼Œ[mongose](https://mongoosejs.com/)ç”¨äºæ•°æ®å»ºæ¨¡ã€‚
*   [JWT](https://jwt.io/) ç”¨äºæ— çŠ¶æ€ä¼šè¯ç®¡ç†ã€‚
*   è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ä¸œè¥¿ã€‚

ç¤ºä¾‹ todo åº”ç”¨ç¨‹åºä½¿ç”¨ JSON Web ä»¤ç‰Œè¿›è¡Œæ— çŠ¶æ€ä¼šè¯ç®¡ç†å’Œèº«ä»½éªŒè¯ã€‚å®ƒå°†ä»¤ç‰Œå­˜å‚¨åœ¨å¸¦æœ‰`httpOnly`æ ‡å¿—çš„ cookie ä¸­ï¼Œä½¿å¾—å®¢æˆ·ç«¯ä¸Šè¿è¡Œçš„ JavaScript æ— æ³•è®¿é—®ä»¤ç‰Œ[ã€‚ä¸‹å›¾æç»˜äº† app](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies) çš„æˆæƒæµç¨‹ã€‚

[![App auth flow without CSRF token](img/c47a4500a5ef2c29cbb476933355c43d.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--O4SZYAU9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://smellycode.com/static/9d9a303caf109383412d6d9474a645a0/dc6f3/basic-auth-flow.jpg)

è®©æˆ‘ä»¬çœ‹çœ‹åº”ç”¨ç¨‹åºçš„ä»£ç ç»„ç»‡ã€‚[ä»£ç åº“](https://github.com/hk-skit/csrf-in-action)æœ‰ä¸‰ä¸ªè§’è‰²â€”â€”æœåŠ¡å™¨ã€å®¢æˆ·ç«¯å’Œé‚ªæ¶å®¢æˆ·ç«¯ã€‚

**æœåŠ¡å™¨**ä¸º user( `/users`)å’Œ todo( `/todos`)ä¸Šçš„ CRUD æ“ä½œå…¬å¼€äº†å‡ ä¸ªç«¯ç‚¹ã€‚å®ƒä½¿ç”¨**mongose**åœ¨ **MongoDB** ä¸­å­˜å‚¨æ•°æ®ã€‚å®ƒè¿˜æ”¯æŒæ¥è‡ªè¿è¡Œåœ¨`localhost:3001`çš„å®¢æˆ·ç«¯çš„[è·¨æ¥æºè¯·æ±‚](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)(ä¸­é—´ä»¶ [cors](https://github.com/expressjs/cors) ç”¨äºå®ç°è·¨æ¥æºèµ„æºå…±äº«)ã€‚æœåŠ¡å™¨è¿è¡Œåœ¨ [http://localhost:3000](http://localhost:3000) ã€‚

**å®¢æˆ·ç«¯**æœ‰ä¸€ä¸ªç®€å•çš„*ç™»å½•è¡¨å•*å’Œä¸€ä¸ª*å¾…åŠäº‹é¡¹åˆ—è¡¨*ã€‚å®ƒä½¿ç”¨ ReactJs æ„å»º UIï¼Œå¹¶ä½¿ç”¨ [axios](https://github.com/axios/axios) è¿›è¡Œ ajax è°ƒç”¨ã€‚å½“åŠ è½½å®¢æˆ·ç«¯æ—¶ï¼Œå®ƒè·å–ç™»å½•ç”¨æˆ·çš„ todos(GETï¼Œ`/todos`)ã€‚å¦‚æœå‡ºç°èº«ä»½éªŒè¯é”™è¯¯(çŠ¶æ€ä»£ç ä¸º 401)ï¼Œå®ƒä¼šå¼•å¯¼ç”¨æˆ·ç™»å½•ã€‚ä»…å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œæ‰èƒ½æˆåŠŸæå–å¾…åŠäº‹é¡¹ã€‚

[![Simple todo app in action](img/482edccdad6cb5b0982383537d363649.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--thAqUsBS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://smellycode.com/sample-todo-app-832053812a926b2348fe3ca17d5d336e.gif)

**é‚ªæ¶å®¢æˆ·ç«¯**åœ¨ [http-server](https://www.npmjs.com/package/http-server) åŒ…çš„å¸®åŠ©ä¸‹è¿è¡Œåœ¨ [http://locahost:3002](http://locahost:3002) ã€‚å®ƒæœ‰ä¸€ä¸ªæ™®é€šçš„ HTML é¡µé¢å’Œä¸€ä¸ªè¡¨å•ã€‚è¡¨å•åœ¨ä¸€ä¸ªéšè—çš„ *iframe* ä¸­ä¸º[é™é»˜æäº¤](https://stackoverflow.com/questions/17940811/example-of-silently-submitting-a-post-form-csrf)æ‰“å¼€å®ƒçš„åŠ¨ä½œã€‚è¯¥åº”ç”¨ç¨‹åºå¼•è¯±ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®ï¼Œåˆºæ¿€è¡¨å•æäº¤ã€‚è¡¨å•æäº¤å¯¹[http://localhost:3000/todos/complete](http://localhost:3000/todos/complete)è¿›è¡Œ **post** è°ƒç”¨ï¼Œå°†å±äºç™»å½•ç”¨æˆ·çš„ todos æ ‡è®°ä¸ºå®Œæˆã€‚

```
<!DOCTYPE html>
<html>
  <body>
    <h1>Hey There!</h1>
    <p
      >Having a rough day! Don't worry, I have got a picture of a cute cat to
      cheer you up. <button id="btn_cat">Show me ğŸ±</button>
    </p>
    <iframe style="display:none" name="csrf-frame"></iframe>
    <form
      method="POST"
      action="http://localhost:3000/todos/complete"
      target="csrf-frame"
      id="csrf-form"
    >
    </form>
    <script type="text/javascript">
      document.getElementById('btn_cat').addEventListener('click', () => {
        document.getElementById('csrf-form').submit();
      });
    </script>
  </body>
</html> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‚ªæ¶çš„å®¢æˆ·åœ¨è¡ŒåŠ¨:

[![Evil client in action](img/a715ed449a3d1e905884c36863e1bdff.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--vgpDWBlx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://smellycode.com/evil-client-in-action-1ea7dda2ae58b69982bc7d632d5b990d.gif)

è®©æˆ‘ä»¬æ¥è§£å†³å¼•èµ·æ··ä¹±çš„é—®é¢˜ã€‚

**é—®:ä¸ºä»€ä¹ˆæ²¡æœ‰è®¤è¯é”™è¯¯ï¼Ÿ**ğŸ¤”

æœåŠ¡å™¨ä¸ä¼šæŠ›å‡ºä»»ä½•èº«ä»½éªŒè¯é”™è¯¯ï¼Œå› ä¸ºè¯·æ±‚åŒ…å«æœ‰æ•ˆçš„ JWT ä»¤ç‰Œã€‚è¯·æ±‚ä» cookies ä¸­è·å–ä»¤ç‰Œã€‚

> å½“æ¥æ”¶åˆ° HTTP è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€ä¸€ä¸ªå¸¦æœ‰å“åº”çš„`Set-Cookie`å¤´ã€‚cookie é€šå¸¸ç”±æµè§ˆå™¨å­˜å‚¨ï¼Œç„¶å cookie åœ¨ä¸€ä¸ª`Cookie` HTTP å¤´ä¸­ä¸å¯¹åŒä¸€æœåŠ¡å™¨çš„è¯·æ±‚ä¸€èµ·å‘é€ã€‚~ [è«å…¹æ‹‰](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)

å½“ç”¨æˆ·ç™»å½•æ—¶ï¼ŒJWT è¢«å­˜å‚¨åœ¨ä¸€ä¸ª`httpOnly` cookie ä¸­(å‚è§[è®¤è¯æµ](#basicAuthFlow))ã€‚*cookie ä¼šéšç€æ¯ä¸ªè¯·æ±‚å‘é€åˆ°åŒä¸€ä¸ªæœåŠ¡å™¨*ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼ŒJWT æˆä¸ºæ¯ä¸ªè¯·æ±‚çš„ä¸€éƒ¨åˆ†ğŸ¤–ã€‚

é—®:CORS çš„è®¾ç½®ä¸åº”è¯¥æœ‰æ‰€å¸®åŠ©å—ï¼Ÿ

åœ¨è·³åˆ°ç­”æ¡ˆä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è°ˆè°ˆ [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS) ã€‚æµè§ˆå™¨é™åˆ¶åŠ è½½åœ¨ä¸€ä¸ªæº(åè®®ã€åŸŸå’Œç«¯å£çš„å…ƒç»„)ä¸Šçš„è„šæœ¬æˆ–æ–‡æ¡£ä¸å¦ä¸€ä¸ªæºçš„äº¤äº’ï¼Œä»¥é¿å…ä¸›æ—ç»Ÿæ²»ã€‚ç”¨äºæ–½åŠ è¿™ç§é™åˆ¶çš„æœºåˆ¶è¢«ç§°ä¸º[åŒæºç­–ç•¥](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy)ã€‚å®ƒç¡®ä¿åº”ç”¨ç¨‹åºåœ¨éš”ç¦»çš„ç¯å¢ƒä¸­è¿è¡Œã€‚æœ‰æ—¶ï¼Œå¼€å‘äººå‘˜éœ€è¦æ”¾å®½åŒæºç­–ç•¥ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºå¯ä»¥ç›¸äº’äº¤äº’ã€‚è¿™å°±æ˜¯ç½—æ–¯(CORS)çš„æƒ³æ³•çš„æ¥æºã€‚åªæœ‰åœ¨`site-b`åŒæ„çš„æƒ…å†µä¸‹ï¼ŒCORS æ‰å…è®¸`site-a`ä¸`site-b`è¿›è¡Œäº¤äº’â€”â€”ç”¨é€‚å½“çš„ HTTP å¤´è¿›è¡Œå“åº”ã€‚ä¸ºäº†å¯ç”¨ CORSï¼ŒæœåŠ¡å™¨éœ€è¦åšä¸€äº›å·¥ä½œ(ç¤ºä¾‹ todo åº”ç”¨ç¨‹åºä½¿ç”¨ [cors](https://github.com/expressjs/cors) ä¸­é—´ä»¶æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½)ã€‚

åœ¨æµè§ˆå™¨é¢†åŸŸï¼Œajax è¯·æ±‚åˆ†ä¸ºä¸‰ç±»:

1.  ç®€å•çš„è¯·æ±‚
2.  éç®€å•è¯·æ±‚
3.  å°å‰æ£€æŸ¥è¯·æ±‚

æ›´å¤šç»†èŠ‚å¯ä»¥åœ¨[è¿™é‡Œ](https://frontendian.co/cors)æ‰¾åˆ°ã€‚

æ¯å½“ä½¿ç”¨éç®€å•è¯·æ±‚è¯·æ±‚è·¨æ¥æºèµ„æºæ—¶ï¼Œæµè§ˆå™¨éƒ½ä¼šå‘å‡ºä¸€ä¸ªé£è¡Œå‰`OPTIONS`è¯·æ±‚ã€‚æœåŠ¡å™¨ç”¨é€‚å½“çš„å“åº”æŠ¥å¤´æ¥å“åº”é£è¡Œå‰è¯·æ±‚ã€‚å¦‚æœæ¥æºå’Œè¯·æ±‚æ–¹æ³•å‡ºç°åœ¨`Access-Control-Allow-Origin`å’Œ`Access-Control-Allow-Methods`ä¸­ï¼Œæµè§ˆå™¨å‘èµ·ä¸»è¯·æ±‚ã€‚å¦åˆ™ï¼Œå°†æŠ›å‡ºä¸€ä¸ª cors é”™è¯¯å’Œä¸€æ¡ç›¸å…³æ¶ˆæ¯ã€‚

[![Preflight request](img/f8bb45229a2b0a20a140b363acf671c9.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--Ma9tTgUn--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://smellycode.com/static/380c0d72b7d2e187c8a39468756dc16b/26dcc/preflight_.png)

å¸¦æœ‰é¢„æ£€è¯·æ±‚çš„å¾…åŠäº‹é¡¹åº”ç”¨ç¨‹åºçš„ç½‘ç»œæ—¥å¿—ã€‚

[![Network logs of preflight request](img/223d8e93b5e9c2712088588751affcae.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--29pUkH7t--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://smellycode.com/static/c96b52fff3097ed31ce6a4e084f97c5e/e199c/prefligh_request_logs.png)

å¯¹äºç®€å•çš„è¯·æ±‚ï¼Œæµè§ˆå™¨ä¸ä¼šå‘èµ·ä»»ä½•ä¼˜å…ˆè¯·æ±‚ã€‚æ¶æ„å®¢æˆ·ç«¯åˆ©ç”¨è¿™ä¸€äº‹å®ï¼Œåœ¨ HTML è¡¨å•çš„å¸®åŠ©ä¸‹ç»•è¿‡åŒæºç­–ç•¥ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ CORS åœ¨è¿™é‡Œæ²¡æœ‰è®¾ç½®å¸®åŠ©ğŸ¤¯ã€‚

[![simple request](img/6a4ecd9db5ac59f24aa9e09ae4fdd57f.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--EHCR-Q39--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://smellycode.com/static/63958e7743ea262c379f4466c52844a6/42fef/simple_req.png)

é—®:å¦‚æœ WebStorage ç”¨æ¥å­˜å‚¨ JWT è€Œä¸æ˜¯ httpOnly cookie ä¼šæ€ä¹ˆæ ·ï¼Ÿ

å°† JWT å­˜å‚¨åœ¨[ç½‘ç»œå­˜å‚¨å™¨](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API)ä¸­ä¼šä½¿åº”ç”¨ç¨‹åºä¸é‚£ä¹ˆå®¹æ˜“å—åˆ° CSRF çš„æ”»å‡»ã€‚ä½†æ˜¯å®ƒå¢åŠ äº†ä»¤ç‰Œè¢«ç ´åçš„æœºä¼šã€‚è¿™æ˜¯å› ä¸ºå®¢æˆ·ç«¯ä¸Šè¿è¡Œçš„ä»»ä½• JavaScript éƒ½å¯ä»¥è®¿é—® web å­˜å‚¨ã€‚è¿™æ˜¯å±é™©çš„ğŸ›‘.

**é—®:å¦‚ä½•é¢„é˜² CSRFï¼Ÿ**

æœåŠ¡å™¨é¢ä¸´çš„æŒ‘æˆ˜æ˜¯éªŒè¯ä»¤ç‰Œå’Œè¯·æ±‚çš„æ¥æºï¼Œå³èµ·æºã€‚ä»¤ç‰ŒéªŒè¯å·²ç»å®ç°ã€‚æœåŠ¡å™¨éœ€è¦éªŒè¯ CSRF ä¿æŠ¤è¯·æ±‚çš„æ¥æºã€‚å¯ä»¥å€ŸåŠ©äº **CORS æ¥æºæŠ¥å¤´**æˆ– **XSRF ä»¤ç‰Œ**æ¥éªŒè¯æ¥æºã€‚ç”¨ XSRF ä»¤ç‰Œ(CSRF ä»¤ç‰Œ)å±è”½æœåŠ¡å™¨æ¯” [CORS åŸç‚¹å¤´](https://stackoverflow.com/questions/24680302/csrf-protection-with-cors-origin-header-vs-csrf-token)æ›´å¯é ï¼Œæ›´å—æ¬¢è¿ã€‚

XSRF ä»¤ç‰Œçš„å®ç°éå¸¸ç®€å•ã€‚å½“å®¢æˆ·ç«¯è¡¨ç¤ºæœ‰æ•ˆå‡­è¯æ—¶ï¼ŒæœåŠ¡å™¨ç”Ÿæˆä¸€ä¸ªéšæœºçš„ä¸å¯è®¿é—®çš„å”¯ä¸€å­—ç¬¦ä¸²ï¼Œåä¸º`xsrfToken`ã€‚å®ƒæŠŠ JWT çš„`xsrfToken`å’Œå…¶ä»–ç´¢èµ”æ”¾åœ¨ä¸€èµ·ã€‚æœåŠ¡å™¨è¿˜åœ¨ cookie ä¸­æ·»åŠ äº†ä¸€ä¸ª`xsrfToken`(ä¸ºä»€ä¹ˆæ˜¯ cookieï¼ŸåŸå› *cookie å—åŒæºæ”¿ç­–é™åˆ¶*ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå¸¦æœ‰`xsrfToken` :
çš„ JWT æœ‰æ•ˆè½½è·æ ·æœ¬

```
{  "sub":  "hk",  "xsrfToken":  "cjwt3tcmt00056tnvcfvnh4n1",  "iat":  1560336079  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®¢æˆ·ç«¯ä» cookies ä¸­è¯»å–ä»¤ç‰Œï¼Œå¹¶åœ¨å‘å‡ºè¯·æ±‚ä¹‹å‰å°†ä»¤ç‰Œä½œä¸º`X-XSRF-TOKEN`æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­ã€‚å½“æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå®ƒä» JWT æœ‰æ•ˆè½½è·ä¸­è¯»å–`xsrfToken`ï¼Œå¹¶ä¸`X-XSRF-TOKEN`æŠ¥å¤´è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸¤è€…ç›¸åŒï¼Œåˆ™è¿›ä¸€æ­¥å¤„ç†è¯·æ±‚ï¼Œå¦åˆ™ä»¥çŠ¶æ€ä»£ç  401 ç»ˆæ­¢ã€‚è¿™ç§æŠ€æœ¯ä¹Ÿè¢«ç§°ä¸º**åŒæäº¤ cookie**æ–¹æ³•ã€‚

å¸¦æœ‰ XSRF ä»¤ç‰Œçš„æˆæƒæµ:

[![JWT auth flow with CSRF](img/90d7838bb35dc6cea3ec0fe902cc828c.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--UyjrNGad--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://smellycode.com/static/f0cf82191e56c34d3b52595702d76626/a1765/auth-flow-csrf.jpg)

ä»£ç ç‰ˆæœ¬åŒ [express-jwt](https://github.com/auth0/express-jwt) :

```
const expressJwt = require('express-jwt');

// Paths without token.
const publicRoutes = ['/users/register', '/users/authenticate'];

const isRevoked = async (req, payload, done) => {
  const { xsrfToken } = payload;
  done(null, xsrfToken !== req.get('X-XSRF-TOKEN'));
};

module.exports = () =>
  expressJwt({
    secret: process.env.JWT_SECRET,

    getToken: req =>
      req.get('X-XSRF-TOKEN') && req.cookies.jwtToken
        ? req.cookies.jwtToken
        : null,
    isRevoked
  }).unless({
    path: publicRoutes
  }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¸¦æœ‰[è½´](https://github.com/axios/axios) :
çš„å®¢æˆ·ç«¯è¯·æ±‚æ‹¦æˆªå™¨

```
import axios from 'axios';

const getCookies = () =>
  document.cookie.split(';').reduce((cookies, item) => {
    const [name, value] = item.split('=');
    cookies[name] = value;
    return cookies;
  }, {});

const baseURL = 'http://localhost:3000';

const ajax = axios.create({
  baseURL,
  timeout: 5000,
  withCredentials: true
});

// Add a request interceptor
ajax.interceptors.request.use(function(config) {
  const xsrfToken = getCookies()['xsrfToken'];
  // CSRF Token.
  if (xsrfToken) config.headers['X-XSRF-TOKEN'] = xsrfToken;
  return config;
});

export default ajax; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„:*ç°å®ä¸–ç•Œçš„åº”ç”¨ç¨‹åºéœ€è¦ä¸€ç§æ›´ä¼˜é›…çš„æœºåˆ¶æ¥å¤„ç† CSRF ä»¤ç‰Œã€‚ä½ å¯èƒ½æƒ³ä½¿ç”¨ä¸­é—´ä»¶[csurf](https://github.com/expressjs/csurf)T3ã€‘ã€‚*

CSRF ä»¤ç‰Œåçš„é‚ªæ¶å®¢æˆ·:

[![Evil client after CSRF token](img/19608f9d8662f4f1c4d44a0c3bebabf9.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--ef7ikDau--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://smellycode.com/evil-client-after-csrf-fc47e6948f89fa58a2058ca3eac707d3.gif)

ç¤ºä¾‹åº”ç”¨ç¨‹åºçš„æœ€ç»ˆä»£ç ä¸Šä¼ åˆ°[è¿™é‡Œ](https://github.com/hk-skit/csrf-in-action)ã€‚æ„Ÿè°¢é˜…è¯»ğŸ™ğŸ»ã€‚