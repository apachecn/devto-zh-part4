# k3s HTTPS ä¸è®©æˆ‘ä»¬åŠ å¯†

> åŸæ–‡:[https://dev.to/pascalw/k3s-https-with-let-s-encrypt-den](https://dev.to/pascalw/k3s-https-with-let-s-encrypt-den)

[K3s](https://k3s.io/) æ˜¯ç»è¿‡è®¤è¯çš„ Kubernetes å‘è¡Œç‰ˆï¼Œä¸“ä¸ºæ— äººå€¼å®ˆã€èµ„æºæœ‰é™ã€è¿œç¨‹ä½ç½®æˆ–ç‰©è”ç½‘è®¾å¤‡å†…éƒ¨çš„ç”Ÿäº§å·¥ä½œè´Ÿè½½è€Œè®¾è®¡ã€‚
å®ƒæä¾›äº†ä¸€ä¸ªç°æˆçš„ Kubernetes å®ä¾‹ï¼Œæ‰“åŒ…æˆä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚

æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•é€šè¿‡â€œè®©æˆ‘ä»¬åŠ å¯†â€æ¥è½»æ¾è®¾ç½® k3s ä¸ HTTPSã€‚

(é˜…è¯»æ›´å¤š)

K3s è‡ªå¸¦ [Traefik](https://traefik.io/) å¼€ç®±ã€‚Traefik æœ¬èº«æ”¯æŒé€šè¿‡â€œè®©æˆ‘ä»¬åŠ å¯†â€å®ç°è‡ªåŠ¨ HTTPSï¼Œä½†æ˜¯ç”¨ k3s è®¾ç½®è¿™ä¸ªç›¸å½“éº»çƒ¦ã€‚ç›¸åï¼Œä½¿ç”¨ä¼˜ç§€çš„[è¯ä¹¦ç®¡ç†å™¨](https://github.com/jetstack/cert-manager)æ’ä»¶ï¼Œè¿™æ˜¯ä¸€ä»¶è½»è€Œæ˜“ä¸¾çš„äº‹ï¼

## [](#0-setup-k3s)0:è®¾ç½® k3sã€‚

æœ¬æŒ‡å—å‡è®¾æ‚¨æœ‰ä¸€ä¸ªå·¥ä½œçš„ k3s å®ä¾‹ï¼Œå¹¶ä¸”`kubectl`è¢«é…ç½®ä¸ºä¸æ‚¨çš„ k3s å®ä¾‹å¯¹è¯ã€‚å¦‚æœæ‚¨è¿˜æ²¡æœ‰ï¼Œåªéœ€è·Ÿéš[æ–‡æ¡£](https://github.com/rancher/k3s/blob/master/README.md)ï¼Œæ‚¨å°†åœ¨å‡ åˆ†é’Ÿå†…å¯åŠ¨å¹¶è¿è¡Œã€‚

## [](#1-install-helm)1ã€‚å®‰è£…èˆµ

Helm æ˜¯ Kubernetes çš„ä¸€ååŒ…è£…ç»ç†ã€‚å®ƒç”±ä¸€ä¸ªæœ¬åœ°å®¢æˆ·ç«¯å’Œä¸€ä¸ªæœåŠ¡å™¨ç»„ä»¶ç»„æˆã€‚
å®‰è£…èˆµéå¸¸ç®€å•ã€‚

å®‰è£…å®¢æˆ·ç«¯:

```
$ brew install kubernetes-helm 
```

åˆ›å»ºæœåŠ¡å¸æˆ·ï¼Œä»¥ä¾¿ Helm å¯ä»¥ä¸æ‚¨çš„ k3s å®ä¾‹äº¤äº’:

```
$ kubectl create serviceaccount tiller --namespace=kube-system 
```

æˆäºˆ it ç®¡ç†å‘˜æƒé™:

```
$ kubectl create clusterrolebinding tiller-admin --serviceaccount=kube-system:tiller --clusterrole=cluster-admin 
```

æ³¨æ„:æ ¹æ®é›†ç¾¤çš„è®¾ç½®ï¼Œæˆäºˆ Helm ç®¡ç†å‘˜æƒé™å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚é˜…è¯»[æ­¤å¤„](https://helm.sh/docs/using_helm/#role-based-access-control)äº†è§£æ›´å¤šè¯¦æƒ…ã€‚

åœ¨ k3s ä¸Šå®‰è£…èˆµ:

```
$ helm init --service-account=tiller 
```

## [](#2-install-certmanager)2ã€‚å®‰è£…è¯ä¹¦ç®¡ç†å™¨

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å®‰è£…äº†å¤´ç›”ï¼Œè®©æˆ‘ä»¬ç»§ç»­å®‰è£…`cert-manager`ã€‚
`cert-manager`æ˜¯ä¸€ä¸ª Kubernetes æ’ä»¶ï¼Œç”¨äºè‡ªåŠ¨ç®¡ç†å’Œå‘å¸ƒæ¥è‡ªå„ç§å‘å¸ƒæºçš„ TLS è¯ä¹¦ï¼Œå…¶ä¸­åŒ…æ‹¬åŠ å¯†ã€‚

ä»å®‰è£…`cert-manager` s CRDs:
å¼€å§‹

```
$ kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.8/deploy/manifests/00-crds.yaml 
```

æ·»åŠ `cert-manager`èˆµå›è´­:

```
$ helm repo add jetstack https://charts.jetstack.io && helm repo update 
```

å®‰è£…`cert-manager` :

```
$ helm install \
  --name cert-manager \
  --namespace cert-manager \
  --version v0.8.1 \
  jetstack/cert-manager 
```

è¿™å¯èƒ½éœ€è¦ä¸€åˆ†é’Ÿå·¦å³çš„æ—¶é—´ã€‚é€šè¿‡æ£€æŸ¥æ‰€æœ‰`cert-manager`åŠèˆ±æ­£åœ¨è¿è¡Œæ¥éªŒè¯å®‰è£…:

```
$ kubectl get all -n cert-manager 
```

## [](#3-configure-certmanager)3ã€‚é…ç½®è¯ä¹¦ç®¡ç†å™¨

å®‰è£…äº†`cert-manager`ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡åˆ›å»ºä¸€ä¸ª*è¯ä¹¦é¢å‘è€…* :
æ¥é…ç½®å®ƒä½¿ç”¨ Let's Encrypt

```
$ cat <<EOF > letsencrypt-prod-issuer.yaml
apiVersion: certmanager.k8s.io/v1alpha1
kind: Issuer
metadata:
 name: letsencrypt-prod
spec:
 acme:
   # The ACME server URL
   server: https://acme-v02.api.letsencrypt.org/directory
   # Email address used for ACME registration, update to your own.
   email: user@example.com
   # Name of a secret used to store the ACME account private key
   privateKeySecretRef:
     name: letsencrypt-prod
   # Enable the HTTP-01 challenge provider
   http01: {} EOF 
```

å¹¶åº”ç”¨:

```
$ kubectl apply -f letsencrypt-prod-issuer.yaml 
```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ`cert-manager`å·²ç»åšå¥½äº†å‡†å¤‡ï¼Œè®©æˆ‘ä»¬æ ¹æ®éœ€è¦åŠ å¯†è¯ä¹¦ã€‚

## [](#4-deploy-a-service-with-automatic-https)4ã€‚ä½¿ç”¨è‡ªåŠ¨ HTTPS éƒ¨ç½²æœåŠ¡

ä¸ºäº†éªŒè¯è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ªç®€å•çš„æœåŠ¡ã€‚æ‚¨åº”è¯¥æœ‰ä¸€ä¸ª DNS åç§°æŒ‡å‘æ‚¨çš„ k3s ç¾¤é›†ï¼Œè¿™æ ·æ‰èƒ½å·¥ä½œã€‚ä¸‹é¢çš„ä¾‹å­ä½¿ç”¨äº†`bootcamp.k3s.example.org`ï¼Œè¯·ç¡®ä¿å°†å…¶æ›´æ–°ä¸ºæ‚¨è‡ªå·±çš„ä¸»æœºåï¼

åˆ›å»ºæ¸…å•:

```
$ cat <<EOF > k8s-bootcamp.yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: k8s-bootcamp
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: k8s-bootcamp
  template:
    metadata:
      labels:
        app: k8s-bootcamp
    spec:
      containers:
      - name: k8s-bootcamp
        image: gcr.io/google-samples/kubernetes-bootcamp:v1
---
apiVersion: v1
kind: Service
metadata:
  name: k8s-bootcamp
  namespace: default
spec:
  ports:
  - name: http
    targetPort: 8080
    port: 80
  selector:
    app: k8s-bootcamp
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: k8s-bootcamp
  annotations:
    kubernetes.io/ingress.class: "traefik"
    certmanager.k8s.io/issuer: "letsencrypt-prod"
    certmanager.k8s.io/acme-challenge-type: http01

spec:
  tls:
  - hosts:
    # Change this to your own hostname
    - bootcamp.k3s.example.org
    secretName: bootcamp-k3s-example-org-tls
  rules:
  # Change this to your own hostname
  - host: bootcamp.k3s.example.org
    http:
      paths:
      - path: /
        backend:
          serviceName: k8s-bootcamp
          servicePort: http
EOF 
```

å¹¶åº”ç”¨:

```
$ kubectl apply -f k8s-bootcamp.yaml 
```

ç­‰ä¸€åˆ†é’Ÿå·¦å³ï¼Œæ‚¨çš„ç«¯ç‚¹åº”è¯¥å¯ä»¥ä½¿ç”¨ Let's Encrypt è¯ä¹¦äº†ï¼ğŸ‰