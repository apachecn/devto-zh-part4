# 4 ä¸ª MySQL é™·é˜±

> åŸæ–‡:[https://dev.to/michi/4-mysql-traps-1oa1](https://dev.to/michi/4-mysql-traps-1oa1)

> æœ€åˆå‘å¸ƒäº[michaelzanggl.com](https://michaelzanggl.com/articles/common-mysql-traps)ã€‚è®¢é˜…[æˆ‘çš„ç®€è®¯](https://michaelzanggl.com/)æ°¸è¿œä¸è¦é”™è¿‡æ–°å†…å®¹ã€‚

æ³¨æ„:å…¶ä¸­ä¸€äº›ä¹Ÿå¯èƒ½å­˜åœ¨äºå…¶ä»–æ•°æ®åº“ç³»ç»Ÿä¸­ã€‚

## [](#utf8-is-not-actually-utf8)utf8 å…¶å®ä¸æ˜¯ utf8

é‡åˆ°è¿‡è¿™ä¸ª SQL å¼‚å¸¸å—ï¼Ÿ`Incorrect string value: â€˜\xF0\x9F\x98\x83 <â€¦â€™ for column...`

ä½ å¯èƒ½å’Œè®¸å¤šäººä¸€æ ·é™·å…¥äº†åŒæ ·çš„é™·é˜±ã€‚åŸæ¥ mySQL çš„ utf8 å­—ç¬¦é›†åªèƒ½å­˜å‚¨æ‰€æœ‰å¯èƒ½çš„ unicode ç ä½çš„ 6%å·¦å³ã€‚è¿™ä¹Ÿæ’é™¤äº†ä¾‹å¦‚è¡¨æƒ…ç¬¦å·ã€‚

```
insert into emails(body) values ('ğŸ¦„ğŸ¦„ğŸ¦„'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ åº”è¯¥ç”¨`utf8mb4`æ¥ä»£æ›¿ã€‚

é˜…è¯»æ›´å¤šä¿¡æ¯ä»¥åŠå¦‚ä½•è¿ç§»:[https://mathiasbynens.be/notes/mysql-utf8mb4](https://mathiasbynens.be/notes/mysql-utf8mb4)

## [](#comparing-raw-varcharfield-endraw-with-raw-false-endraw-or-0)æ¯”è¾ƒ`varchar_field`ä¸`false`æˆ– 0

æƒ³è±¡ä¸‹é¢è¿™ä¸ªäººä¸ºçš„ä¾‹å­

```
function normalizeEmail(email) {
    if (!validate(email)) {
        return false
    }

    return normalize(email)
}

// somewhere in the code
await User.where('email', normalizeEmail(email)).first() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å‡æƒ³çš„ ORM å°†æ‰§è¡ŒæŸ¥è¯¢`select * from users where email = <prepared value> LIMIT 1`

å¦‚æœ`normalizeEmail`ä¸­çš„éªŒè¯æˆåŠŸï¼ŒæŸ¥è¯¢å°†æ˜¯`select * from users where email = 'normalized.email@test.com' LIMIT 1`ã€‚

å¦‚æœéªŒè¯ä¸æˆåŠŸï¼ŒæŸ¥è¯¢å°†æ˜¯`select * from users where email = false LIMIT 1`ã€‚

ç°åœ¨ç»§ç»­åœ¨ä½ çš„æ•°æ®åº“ç³»ç»Ÿä¸­è¿è¡Œç±»ä¼¼`select * from users where <varchar field> = false`çš„ä¸œè¥¿ã€‚

ç”±äºå­—æ®µä¸å…·æœ‰å¯æ¯”æ€§ï¼ŒMySQL ä¼šå°†ä¸€ä¸ªå­—æ®µè½¬æ¢ä¸ºå¦ä¸€ä¸ªå­—æ®µï¼Œä½¿å®ƒä»¬åŒ¹é…å¹¶è¿”å›æ‰€æœ‰ç”¨æˆ·ã€‚æˆ‘ä»¬çš„ ORM å°†ç®€å•åœ°é€‰æ‹©ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åç»§ç»­è¿™ä¸ªé€»è¾‘ã€‚ğŸ˜¬ç›¸å½“å±é™©ã€‚

> åŒæ ·çš„æƒ…å†µä¹Ÿå‘ç”Ÿåœ¨`field = 0`

## [](#-raw-insert-on-duplicate-key-update-endraw-creates-primary-key-holes)`insert on duplicate key update`åˆ›å»ºä¸»é”®å­”

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè¡¨`statistics`ï¼Œå…¶ä¸­åŒ…å«åˆ—`id`(AI)`fkid`ã€`title`ã€‚

```
INSERT INTO statistics (fkid, title) VALUES (1, 'first'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†æ’å…¥ä¸€ä¸ªå¸¦æœ‰`id` 1 çš„æ–°è®°å½•ã€‚è®©æˆ‘ä»¬æƒ³è±¡æœ‰ä¸€æ‰¹æ€»æ˜¯æ’å…¥æˆ–æ›´æ–°æ ‡é¢˜ã€‚å®ƒå¯èƒ½ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢:

```
INSERT INTO statistics (fkid, title) VALUES (1, 'second') ON DUPLICATE KEY UPDATE title = 'second';
INSERT INTO statistics (fkid, title) VALUES (1, 'third') ON DUPLICATE KEY UPDATE title = 'third';
INSERT INTO statistics (fkid, title) VALUES (1, 'fourth') ON DUPLICATE KEY UPDATE title = 'fourth'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œæˆ‘ä»¬æƒ³æ’å…¥ä¸€ä¸ªå¸¦æœ‰æ–° fkid çš„è®°å½•ã€‚

```
INSERT INTO statistics (fkid, title) VALUES (100, 'first') ON DUPLICATE KEY UPDATE title = 'first'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¼šåœ¨è¡¨ä¸­æ’å…¥ä¸€æ¡æ–°è®°å½•ï¼Œä½†æ˜¯çŒœçŒœ`id`æ˜¯ä»€ä¹ˆï¼Ÿæ‚¨å¯èƒ½å¸Œæœ›å®ƒæ˜¯ 2ï¼Œä½†å®é™…ä¸Šï¼Œæ¯æ¬¡`insert on duplicate key update`æ’å…¥å’Œå¤„ç†`update`å¤±è´¥æ—¶ï¼Œå®ƒéƒ½ä¼šåœ¨å†…éƒ¨å¢åŠ è‡ªåŠ¨å¢é‡ã€‚è¿™æ„å‘³ç€è¯¥è®°å½•çš„`id`å°†æ˜¯ 5ã€‚

id æ˜¯å¦çœŸçš„æ˜¯è¿ç»­çš„å¹¶ä¸å¤ªé‡è¦ï¼Œä½†æ˜¯æ‚¨å¯èƒ½æƒ³çŸ¥é“å®ƒçš„åŸå› æ˜¯ä»€ä¹ˆã€‚

äº†è§£æ›´å¤š:[https://stack overflow . com/questions/38347110/prevent-innodb-auto-increment-on-duplicate-key](https://stackoverflow.com/questions/38347110/prevent-innodb-auto-increment-on-duplicate-key)

## [](#int2-is-not-what-you-think-it-means)int(2)ä¸æ˜¯ä½ æƒ³çš„é‚£ä¸ªæ„æ€

æ•´æ•°çš„é•¿åº¦åœ¨ MySQL ä¸­æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œæ‚¨ä»ç„¶å¯ä»¥æ’å…¥åƒ 9999999 è¿™æ ·çš„å€¼ã€‚å®ƒä»¬åªé™åˆ¶å‘½ä»¤è¡Œå®¢æˆ·ç«¯ä¸­åº”è¯¥æ˜¾ç¤ºå¤šå°‘ä¸ªå­—ç¬¦ã€‚ğŸ¤¨

äº†è§£æ›´å¤šä¿¡æ¯:[https://stack overflow . com/questions/5634104/what-the-size-of-column-of-int 11-in-MySQL-in-bytes](https://stackoverflow.com/questions/5634104/what-is-the-size-of-column-of-int11-in-mysql-in-bytes)

ä½ è¿˜çŸ¥é“å…¶ä»–ä»€ä¹ˆé™·é˜±å—ï¼Ÿ