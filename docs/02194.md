# æƒ°æ€§åŠ è½½ç»„ä»¶- #2

> åŸæ–‡:[https://dev.to/negue/lazy-loaded-components-2-c7e](https://dev.to/negue/lazy-loaded-components-2-c7e)

æ‰©å±•äº†**ç»„ä»¶çº§æƒ°æ€§åŠ è½½å™¨**çš„ç‰¹æ€§ï¼Œè¿™å¾—ç›ŠäºğŸ‰å¸¸æ˜¥è—¤ğŸ‰

ä»ç¬¬ 1 éƒ¨åˆ†ç»§ç»­:

## [](#1-inject-services-into-lazyloaded-components)1ã€‚å°†æœåŠ¡æ³¨å…¥å»¶è¿ŸåŠ è½½çš„ç»„ä»¶:

å› ä¸ºåŠ è½½å™¨ä½¿ç”¨ç›¸åŒçš„æ³¨å…¥å™¨å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ³¨å…¥ä¸çˆ¶ç»„ä»¶ç›¸åŒçš„æœåŠ¡ã€‚

æ—æ³¨:é€šå¸¸çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒä»ç„¶åœ¨æƒ°æ€§åŠ è½½çš„ç»„ä»¶ä¸Šå·¥ä½œã€‚

## [](#2-raw-input-endraw-)2ã€‚`@Input()`

ä¸ºäº†åœ¨åŠ è½½çš„ç»„ä»¶ä¸Šè®¾ç½®è¾“å…¥ï¼ŒåŠ è½½å™¨ä½¿ç”¨`componentInputs: any`ä½œä¸º`@Input()`

```
 private setInputs() {
    if (this.componentInstance && this.componentInputs) {
      const inputs = Object.keys(this.componentInputs);

      for (const inputKey of inputs) {
        this.componentInstance[inputKey] = this.componentInputs[inputKey];
      }
    }
  } 
```

åœ¨ç»„ä»¶è¢«åˆ›å»ºåï¼Œ`setInputs`å°†è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªä¸º`componentInputs`è°ƒç”¨çš„`ngOnChanges`ä¸Šè¢«è°ƒç”¨ã€‚

ç°åœ¨ï¼Œæ‚¨è¿˜å¯ä»¥ä¸ºåŠ è½½çš„ç»„ä»¶è®¾ç½®è¾“å…¥ğŸ‰

## [](#3-raw-output-endraw-)3ã€‚`@Output()`

ä¸ºäº†ä½¿ç”¨ä½ åŠ è½½çš„ç»„ä»¶çš„è¾“å‡ºï¼Œä½ å¯ä»¥ç”¨
æ¥è®¾ç½®ä½ çš„å›è°ƒ

```
[componentOutputs]="{
 outputName: onYourCallbackMethod
}" 
```

ç”±äºè¿™ä¸ªå¯¹è±¡åªæ˜¯ä¸€ä¸ª`key: Function`çš„å­—å…¸ï¼Œè®¢é˜…åŠ è½½çš„ç»„ä»¶è¾“å‡ºç›¸å½“â€œå®¹æ˜“â€ã€‚ğŸ‰

```
 private unsubForOutputs$ = new Subject();
  private setOutputs () {
    this.unsubOutputs();

    if (this.componentInstance && this.componentOutputs) {
      const outputs = Object.keys(this.componentOutputs);

      for (const outputKey of outputs) {
        if (this.componentInstance[outputKey]) {
          const emitter = this.componentInstance[outputKey] as EventEmitter<any>;
            emitter.pipe(
              takeUntil(this.unsubForOutputs$),
            ).subscribe(this.componentOutputs[outputKey]);
        }
      }
    }
  }

  private unsubOutputs () {
    this.unsubForOutputs$.next();
  } 
```

## [](#4-prevent-loading-the-same-components-multiple-times)4ã€‚é˜²æ­¢å¤šæ¬¡åŠ è½½ç›¸åŒçš„ç»„ä»¶

å‰é¢çš„ä¾‹å­æ˜¯è¿™æ ·çš„:

```
const imported = await DynamicLoaderComponent.LazyComponents[this.component](); 
```

è¿™æ ·ï¼Œæ¯æ¬¡éƒ½ä¼šåŠ è½½(HTTP-call)è¯·æ±‚çš„ç»„ä»¶ã€‚

ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªç®€å•çš„ç¼“å­˜å¯¹è±¡æ¥ä¿å­˜å·²è§£æçš„æ‰¿è¯º(åŒæ ·ï¼Œæˆ‘é‡æ„äº†æ³¨å†Œ(å†æ¬¡ğŸ˜…)):

```
export class DynamicLoaderRegistry {
  // Registry
  public static LazyComponents: { [key: string]: () => Promise<any> } = {};
  // Loaded-Cache
  public static AlreadyLoaded: { [key: string]: Promise<any> } = {};
}

// cache the promises
    const importComponent = DynamicLoaderRegistry.AlreadyLoaded[this.component]
      || (DynamicLoaderRegistry.AlreadyLoaded[this.component] = DynamicLoaderRegistry.LazyComponents[this.component]());

    const imported = await importComponent; 
```

ç°åœ¨ï¼Œå¦‚æœè¯·æ±‚ç›¸åŒçš„ç»„ä»¶ï¼Œå®ƒåªåŠ è½½ä¸€æ¬¡ğŸ‰

## [](#finalizing-the-componentloader-tada-for-now-sweatsmile)å®Œæˆç»„ä»¶åŠ è½½å™¨ğŸ‰ï¼ˆ..ç›®å‰ğŸ˜…)

å‚è§:[å½“å‰ç‰ˆæœ¬](https://gist.github.com/negue/5f4435c7e1d2c11449691d342b39cdd5/d4a061ca399dc0c3ea0ff7149ffc765c0cbd9dfa)

å¾…ç»­/è¯•ç”¨/æµ‹è¯•:

*   å›è´­/é¡¹ç›®ç¤ºä¾‹
*   æ˜¾ç¤ºç»„ä»¶æ­£åœ¨åŠ è½½
*   å»¶è¿ŸåŠ è½½æ¨¡å—(åŠå…¶ç»„ä»¶ä¹‹ä¸€)

æœ‰ä»€ä¹ˆæƒ³æ³•/å»ºè®®/ä¸»æ„å—ï¼Ÿ