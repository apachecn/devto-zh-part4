# Windows 10 çš„ä¸€éƒ¨åˆ†ç°åœ¨è¿è¡Œåœ¨ WebAssembly ä¸Šï¼ŒåŸç”Ÿäº iOS å’Œ Android ä¸Š

> åŸæ–‡:[https://dev . to/uno-platform/a-piece-of-windows-10-is-now-running-on-web assembly-native-on-IOs-and-Android-3666](https://dev.to/uno-platform/a-piece-of-windows-10-is-now-running-on-webassembly-natively-on-ios-and-android-3666)

å‡ ä¸ªæœˆå‰ï¼Œå¾®è½¯[å¼€æºäº† Windows è®¡ç®—å™¨](https://blogs.windows.com/buildingapps/2019/03/06/announcing-the-open-sourcing-of-windows-calculator/)ï¼Œè¿™æ­£æ˜¯ Windows 10 é™„å¸¦çš„è®¡ç®—å™¨ã€‚

æˆ‘ä»¬å†³å®š[å°†å®ƒç§»æ¤åˆ° C#å’Œ Uno å¹³å°](https://github.com/nventive/calculator)ï¼Œè¿™æ · iOS å’Œ Android ç”¨æˆ·å¯ä»¥ä½¿ç”¨å®ƒï¼Œä¹Ÿå¯ä»¥é€šè¿‡ WebAssembly ä»ç½‘ç»œä¸Šä½¿ç”¨å®ƒã€‚ä¸ºä»€ä¹ˆâ€”â€”è¿™å°±æ˜¯æˆ‘ä»¬ Uno Platform çš„å·¥ä½œğŸ˜Šâ€“æ”¯æŒç›¸åŒçš„ C#å’Œ XAML ä»£ç åœ¨ç½‘ç»œã€æ‰‹æœºå’Œæ¡Œé¢ä¸Šè¿è¡Œã€‚

**æ‚¨ä»Šå¤©å¯ä»¥åœ¨:**ä½¿ç”¨å®ƒ

*   [è‹¹æœåº”ç”¨å•†åº—](https://apps.apple.com/app/id1464736591)
*   [Android Play å•†åº—](https://play.google.com/store/apps/details?id=uno.platform.calculator)
*   web assembly:[https://calculator . platform . uno](https://calculator.platform.uno/)
*   Windows 10â€”â€”å—¯ï¼Œåœ¨ Windows 10 ä¸Šæ‰“å¼€å®ƒå°±è¡Œäº†ğŸ˜Š

[![Calculator](../Images/17d7a81d6724c9176a2e81acc0f76521.png)T2ã€‘](https://github.com/nventive/Uno/blob/master/doc/blog/Assets/20190612-Calculator-01.png?raw=true)

## [](#anatomy-of-the-windows-calculator)è§£å‰– Windows è®¡ç®—å™¨

Windows è®¡ç®—å™¨æ˜¯ä¸€æ¬¾æœ‰è¶£è€Œä¸ç®€å•çš„è½¯ä»¶ã€‚ä½ åœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„ç®€å•çš„åˆå§‹ç”¨æˆ·ç•Œé¢å¯èƒ½å…·æœ‰æ¬ºéª—æ€§ã€‚å½“ç„¶ï¼Œè¿™æ˜¯å¾®è½¯åšå‡ºçš„ä¸€ä¸ªå¾ˆå¥½çš„ UX é€‰æ‹©ï¼Œå› ä¸ºè®¡ç®—å™¨çš„å¤§å¤šæ•°ç”¨é€”éƒ½ç›¸å½“ç®€å•ã€‚ç„¶è€Œï¼Œè¿™ä¸ªè®¡ç®—å™¨æ˜¯å¤æ‚çš„ï¼Œä¸ä»…å› ä¸ºå®ƒå¤šå¹´æ¥çš„ç¼–ç æ–¹å¼ï¼Œä¹Ÿå› ä¸ºå®ƒæ‹¥æœ‰çš„é«˜çº§åŠŸèƒ½ã€‚

é¦–å…ˆï¼Œå®ƒå®Œå…¨æ˜¯ä½¿ç”¨æ ‡å‡†çš„ C++ 11 å’Œ C++/CX æ„å»ºçš„ï¼Œå¸¦æœ‰ä¸€ä¸ªå¯ä»¥è¿½æº¯åˆ° 1995 å¹´çš„è®¡ç®—å¼•æ“ã€‚å†å²ä¸Šï¼Œéƒ¨åˆ† C++ä»£ç å®é™…ä¸Šæ˜¯ç”¨ C è¯­è¨€æ„å»ºçš„ã€‚

[![Calculator](../Images/e66bfbdb7d4199497a79edede72066f9.png)T2ã€‘](https://raw.githubusercontent.com/nventive/Uno/master/doc/blog/Assets/20190612-Calculator-02.png)

ç¬¬äºŒï¼Œè®¡ç®—å™¨åŒ…å«çš„åŠŸèƒ½æœ‰:æ ‡å‡†æ¨¡å¼ã€ç§‘å­¦æ¨¡å¼ã€å…·æœ‰å¤šåŸºæ•°è½¬æ¢çš„ç¨‹åºå‘˜æ¨¡å¼ã€ç§»ä½æ“ä½œå’Œäº¤äº’å¼ä½å­—æ®µè§†å›¾ã€æ—¥æœŸè®¡ç®—å™¨ã€å¤§é‡è½¬æ¢å™¨(è´§å¸ã€ä½“ç§¯ã€é•¿åº¦ã€æ¸©åº¦ã€è§’åº¦â€¦â€¦)ã€æ— é™ç²¾åº¦ç®—æœ¯è¿ç®—ã€å¸¦æ‹¬å·æ”¯æŒçš„è¡¨è¾¾å¼è§†å›¾ã€å…·æœ‰å¯é€‰é¡¹ç›®çš„å†å²è§†å›¾å’Œå¯ç¼–è¾‘çš„å†…å­˜è§†å›¾ã€‚å®ƒè¿˜æ‹¥æœ‰çª—å£å’Œæ–¹å‘æ„ŸçŸ¥è®¾å¤‡çš„å“åº”è®¾è®¡ï¼Œå…·æœ‰æŒ‰é’®å’Œå†å²åŠ¨æ€å¯è§æ€§ï¼Œ65 ç§è¯­è¨€çš„æœ¬åœ°åŒ–ï¼Œæ—ç™½/ç”»å¤–éŸ³è¾…åŠ©åŠŸèƒ½æ”¯æŒï¼Œå‰ªè´´æ¿æ”¯æŒç­‰â€¦

[![Calculator](../Images/eb777c003179975560a1d904b6ecf1c6.png)T2ã€‘](https://raw.githubusercontent.com/nventive/Uno/master/doc/blog/Assets/20190612-Calculator-03.png)

## [](#porting-the-engine-to-the-uno-platform)å°†å¼•æ“ç§»æ¤åˆ° Uno å¹³å°

Uno å¹³å°æ˜¯ç”¨ C#å¼€å‘çš„ï¼Œä¸ºäº†èƒ½å¤Ÿæ”¯æŒ iOSã€Android å’Œ WebAssembly ä¸Šçš„è®¡ç®—å™¨ï¼Œéœ€è¦å°†éƒ¨åˆ†ä»£ç ç¿»è¯‘æˆ C#ã€‚å…¶ä»–çš„éœ€è¦è°ƒæ•´ä»¥ç¬¦åˆ clang çš„ C++ 11 æ”¯æŒã€‚

åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†å‰–æé€šè¿‡ Uno å¹³å°çš„ WebAssembly æ”¯æŒï¼Œä»¥åŠåŸç”Ÿ iOS å’Œ Android åº”ç”¨ç¨‹åºï¼Œå°†è¿™äº›ä»£ç ç§»æ¤åˆ° Web æ‰€éœ€è§£å†³çš„æŒ‘æˆ˜ã€‚

### [](#challenge-1-adjusing-the-c-of-the-calculation-engine)æŒ‘æˆ˜#1:è°ƒæ•´è®¡ç®—å¼•æ“çš„ C++

ä¿æŒ C++ä»£ç åŸæ ·çš„ä¸»è¦åŸå› æ˜¯ä½¿ç”¨äº†ä¸å®¹æ˜“æ˜ å°„åˆ° C#çš„æŒ‡é’ˆå’Œä½çº§å†…å­˜æŠ€æœ¯ï¼Œè€Œä¸”è®¡ç®—å¼•æ“ä¸ç›´æ¥ä½¿ç”¨ä»»ä½• UIã€‚ä»£ç ä½¿ç”¨`CalculatorManager`ç±»å°è£…ï¼Œä¸€ä¸ª`IResourceProvider`å›è°ƒæ¥å£å’Œ`ICalcDisplay` UI æ›´æ–°å›è°ƒæ¥å£ã€‚

è¿™éƒ¨åˆ†ä»£ç å¤§éƒ¨åˆ†ä¸éœ€è¦æ›´æ–°ï¼Œé™¤äº†ä½¿ç”¨ C99 **[çµæ´»æ•°ç»„æˆå‘˜ç‰¹æ€§](https://en.wikipedia.org/wiki/Flexible_array_member)** ã€‚è¿™ä¸ªç‰¹æ€§åœ¨ C++ä¸­ä¸å—æ”¯æŒ(åŸå› å¾ˆå¥½)ï¼Œä½†æ˜¯å¾®è½¯å·¥ç¨‹å¸ˆä¸ºè¿™ä¸ªç‰¹æ€§æ·»åŠ äº†ä¸€ä¸ªæ’é™¤ã€‚ç„¶è€Œ Clang æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œä¾èµ–å®ƒçš„ä»£ç éœ€è¦ä¸€äº›è°ƒæ•´æ‰èƒ½ä½¿ç”¨æ™®é€šæ•°ç»„ã€‚

æ„å»ºè„šæœ¬ç”¨äº [iOS](https://github.com/nventive/calculator/blob/uno/src/CalcManager/build_ios.sh) å’Œ [WebAssembly](https://github.com/nventive/calculator/blob/uno/src/CalcManager/build.sh) ç”Ÿæˆå®ƒä»¬çš„æœ¬åœ°æœ‰æ•ˆè´Ÿè½½ï¼Œè€Œ Windows å’Œ Android ä½¿ç”¨å®ƒä»¬è‡ªå·±çš„`C++` Visual Studio é¡¹ç›®è¿›è¡Œé›†æˆã€‚

Android çš„ NDK ä¹Ÿæœ‰ä»¤äººæƒŠè®¶çš„åœ°æ–¹ï¼Œå¯¹äº ARM32 ABIs çš„ r19 ä»¥ä¸‹çš„ ndkï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸æ”¯æŒå¼‚å¸¸å¤„ç†ã€‚è®¡ç®—å¼•æ“ä¾é ä½¿ç”¨å¼‚å¸¸æ¥å¤„ç†è¯¸å¦‚è¢«é›¶é™¤ä¹‹ç±»çš„æƒ…å†µï¼Œä½¿å¾—åº”ç”¨ç¨‹åºåœ¨è¿™ç§æƒ…å†µä¸‹å´©æºƒã€‚å°†`-lunwind`åº“æ·»åŠ åˆ°é“¾æ¥å™¨è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

### [](#challenge-2-native-code-interop-specifics)æŒ‘æˆ˜ 2:æœ¬æœºä»£ç äº’æ“ä½œç»†èŠ‚

æ„å»ºå’Œä½¿ç”¨æœ¬æœºä»£ç æœ‰è®¸å¤šå¾®å¦™ä¹‹å¤„:

*   å¯¹äº iOSï¼Œ[éœ€è¦ä½¿ç”¨`__Internal`](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/src/Calculator.Shared/CalcManager/CalculatorManager.Interop.cs#L16) å·²çŸ¥åç§°ï¼Œå› ä¸ºæœ¬åœ°åº“æ˜¯é™æ€é“¾æ¥åˆ°ä¸»å¯æ‰§è¡Œæ–‡ä»¶çš„ã€‚
*   å¯¹äº Androidï¼Œé›†æˆ VS é¡¹ç›®ä¸ä¼šè‡ªåŠ¨ä¸ºæ‰€æœ‰ç›®æ ‡å¹³å°(x86ã€armv7 å’Œ arm64)æ„å»ºï¼Œè¿™æ„å‘³ç€å¿…é¡»æ‰§è¡Œ[é¢å¤–çš„ CI æ„å»ºæ­¥éª¤](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/.vsts-ci.Windows.yml#L37)ï¼Œä»¥ä¾¿åœ¨åˆ›å»ºæœ€ç»ˆ APK æ—¶ä¸€æ¬¡æ€§ä½¿ç”¨æ­£ç¡®çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œä¸èƒ½ä½¿ç”¨æ ‡å‡†çš„é¡¹ç›®ä¾èµ–å…³ç³»(å› ä¸ºæœ‰å¤šä¸ª ABI ç‰ˆæœ¬)ï¼Œå¹¶ä¸”å¿…é¡»åœ¨é¡¹ç›®ä¸­æ·»åŠ  [`AndroidNativeLibrary`](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/src/Calculator.Droid/Calculator.Droid.csproj#L101) é¡¹ã€‚
*   å¯¹äº WebAssemblyï¼Œéœ€è¦ä½¿ç”¨`-s SIDE_MODULE=1`æ”¯æŒæ¥æ„å»ºæ¨¡å—ï¼Œå¹¶é¢å¤–æ”¯æŒ C++æ ‡å‡†åº“ï¼Œå› ä¸ºå®ƒä¸æ˜¯ç”± em scriten ä¸ºåŠ¨æ€æ¨¡å—è‡ªåŠ¨æ·»åŠ çš„[ã€‚](https://github.com/emscripten-core/emscripten/wiki/Linking#system-libraries)

### æŒ‘æˆ˜ 3:å°† C++/CX ä»£ç è½¬æ¢æˆ C

åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ä½¿ç”¨å¾®è½¯çš„ C++/CX æ¥ä½¿ç”¨ WinRT APIsï¼Œå°¤å…¶æ˜¯ WinUI APIsã€‚è¿™ä½¿å¾—ä»£ç éå¸¸åƒ C#ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ç»„æ­£åˆ™è¡¨è¾¾å¼å°†`::`è½¬æ¢ä¸º`.`ï¼Œæˆ–è€…å°†`dynamic_cast<FrameworkElement>(fe)`è½¬æ¢ä¸º`((FrameworkElement)fe)`è½¬æ¢ä¸º C#ï¼Œå¹¶ä¸” WinRT API è°ƒç”¨çš„å…¶ä½™éƒ¨åˆ†ç›´æ¥åŒ¹é…ï¼Œå› ä¸º Uno å¹³å°æä¾›äº† WinRT çš„å®Œæ•´ API ç­¾åã€‚

è¿™ç§è½¬æ¢å°†å¤§çº¦ 80%çš„ C++/CX ä»£ç è½¬æ¢ä¸ºå…¼å®¹ C#çš„ä»£ç ï¼Œå¹¶è¿›è¡Œä¸€äº›æ‰‹åŠ¨è°ƒæ•´ä»¥è·å¾—å…¨åŠŸèƒ½çš„ C#ã€‚ä¾‹å¦‚ï¼ŒC++è¿­ä»£å™¨éœ€è¦è½¬æ¢æˆ`foreach`å¾ªç¯ï¼Œæˆ–è€…ä½¿ç”¨ã€‚å‡€å†…ç½®è½¬æ¢ã€‚

ä»£ç çš„æŸäº›å…¶ä»–éƒ¨åˆ†æ— æ³•æŒ‰åŸæ ·è½¬æ¢ï¼Œå°¤å…¶æ˜¯é‚£äº›ä¾èµ– Win32 APIs çš„éƒ¨åˆ†ï¼Œå¦‚è´§å¸æˆ–æ—¥å†åŠŸèƒ½ç­‰å½“å‰åŒºåŸŸæ€§å±æ€§ã€‚é‚£äº›éœ€è¦è½¬æ¢ä½¿ç”¨ã€‚NET è‡ªå·±çš„ APIã€‚

### [](#challenge-4-converting-the-xaml)æŒ‘æˆ˜å››:è½¬æ¢ XAML

è¿™ä¸€éƒ¨åˆ†éå¸¸ç®€å•:æ²¡æœ‰ä»€ä¹ˆè¦è½¬æ¢çš„ï¼

å”¯ä¸€éœ€è¦åšçš„å°±æ˜¯é€‚åº” Uno å¹³å°çš„å·®å¼‚ï¼Œæ¯”å¦‚ç¼ºå°‘å¯¹ä¸»é¢˜èµ„æºæˆ– RevealBrush çš„æ”¯æŒã€‚

[![Calculator](../Images/5dd8e3f5fddd187a682b343f72e5d33f.png)T2ã€‘](https://raw.githubusercontent.com/nventive/Uno/master/doc/blog/Assets/20190612-Calculator-07.png)

è®¡ç®—å™¨çš„ç•Œé¢å¸ƒå±€ä¹Ÿéå¸¸çµæ•ï¼Œå¯ä»¥æ ¹æ®è®¸å¤šæ–­ç‚¹è¿›è¡Œè°ƒæ•´ã€‚è¿™ä½¿å¾—åœ¨ iPad ä¸Šè¿›è¡Œå¤šä»»åŠ¡å¤„ç†å’Œå¯¹æ¥å˜å¾—éå¸¸å®¹æ˜“ã€‚

### [](#challenge-5-localization-resources)æŒ‘æˆ˜äº”:æœ¬åœ°åŒ–èµ„æº

Uno å¹³å°æ”¯æŒä½¿ç”¨ resw æ–‡ä»¶ï¼Œè¿™æ„å‘³ç€è¿™äº›æ–‡ä»¶ä¸åŸå§‹è®¡ç®—å™¨ä½¿ç”¨çš„æ–‡ä»¶å®Œå…¨ç›¸åŒã€‚

æ³¨æ„ï¼Œèµ„æºä½¿ç”¨[é™„åŠ å±æ€§è¯­æ³•](https://github.com/microsoft/calculator/blob/06c0dd9bd0f5971db9b17a782e1386037da38026/src/Calculator/Resources/de-DE/Resources.resw#L460)æ¥æ”¯æŒè®²è¿°äººå’Œå·¥å…·æç¤ºï¼Œä¾‹å¦‚:

```
\<data name="MemoryPivotItem.[using:Windows.UI.Xaml.Automation]AutomationProperties.Name" xml:space="preserve"\> \<value\>Arbeitsspeicher\</value\> \<comment\>The automation name for the Memory pivot item that is shown when Calculator is in wide layout.\</comment\> \</data\> 
```

-å½¢æˆæ— æ‚ä¹±çš„å±€éƒ¨ XAMLã€‚

Uno å¹³å°ä¹Ÿç›´æ¥æ”¯æŒå›¾åƒèµ„äº§ï¼Œå°½ç®¡ä¸€äº›åŸå§‹èµ„äº§ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä»¬ä½¿ç”¨ Uno å¹³å°å°šä¸æ”¯æŒçš„è¯­ä¹‰ç‰¹å¾ï¼Œä¾‹å¦‚é«˜å¯¹æ¯”åº¦ã€‚é‚£äº›æš‚æ—¶è¢«æ’é™¤äº†ã€‚

## [](#connecting-the-c-and-c-together)å°† C++å’Œ C#è¿æ¥åœ¨ä¸€èµ·

è¿™éƒ¨åˆ†æ˜¯åˆ©ç”¨ [P/Invoke](https://docs.microsoft.com/en-us/cpp/dotnet/how-to-call-native-dlls-from-managed-code-using-pinvoke?view=vs-2019) çš„ç§»æ¤å·¥ä½œçš„æ ¸å¿ƒã€‚

### [](#challenge-6-mono-for-webassembly-dynamic-and-static-linking-support)æŒ‘æˆ˜#6: Mono for WebAssembly åŠ¨æ€å’Œé™æ€é“¾æ¥æ”¯æŒ

ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ P/Invoke ç›´æ¥ä» C#è°ƒç”¨ WebAssembly ä»£ç ï¼Œ [Mono å¿…é¡»æ›´æ–°ä¸º](https://github.com/mono/mono/pull/14259)æ¥æ”¯æŒå®ƒã€‚æœ‰ä¸¤ç§æ¨¡å¼å¯ç”¨ï¼Œä¸€ç§ç”¨äºåŸºäºè§£é‡Šå™¨çš„æ„å»ºï¼Œå¦ä¸€ç§ç”¨äºåŸºäº AOT çš„æ„å»ºã€‚

åŸºäºè§£é‡Šå™¨çš„æ¨¡å¼ä½¿ç”¨ [emscripten çš„åŠ¨æ€é“¾æ¥ç‰¹æ€§](https://github.com/emscripten-core/emscripten/wiki/Linking#overview-of-dynamic-linking)ï¼Œå¹¶ä¸”éœ€è¦èƒ½å¤Ÿåœ¨ windows ä¸‹æ„å»º Wasm åº”ç”¨ï¼Œè€Œä¸å¿…ä¾èµ–äº emscripten çš„å·¥å…·ã€‚è¿™ç¡®ä¿äº†å¼€å‘å¾ªç¯å°½å¯èƒ½é«˜æ•ˆï¼Œå°½ç®¡ä»£ä»·æ˜¯è¿è¡Œæ—¶æ€§èƒ½ã€‚

åŸºäº AOT çš„æ¨¡å¼ä½¿ç”¨ emscripten å’Œ [Mono çš„é™æ€é“¾æ¥ç‰¹æ€§](https://github.com/mono/mono/pull/14253)ï¼Œå…¶ä¸­ Mono å°†ä¸€ç»„â€œå·²çŸ¥çš„ p/invokeâ€æ–¹æ³•ç”Ÿæˆåˆ° LLRM ä½ä»£ç æ¨¡å—ä¸­ã€‚è¿™ç§æ¨¡å¼æ•ˆç‡æœ€é«˜ï¼Œä½†ç”Ÿæˆé€Ÿåº¦ä¹Ÿæœ€æ…¢ã€‚é€šå¸¸æœ€å¥½åœ¨å‘å¸ƒ CI æ„å»ºä¸­ä½¿ç”¨å®ƒã€‚

[![Calculator](../Images/6a978f6d13a75f56ae041cf0b7603d1f.png)T2ã€‘](https://raw.githubusercontent.com/nventive/Uno/master/doc/blog/Assets/20190612-Calculator-06.png)

### [](#challenge-7-the-c-adaptation-layer)æŒ‘æˆ˜# 7:C é€‚é…å±‚

P/Invoke åªèƒ½è°ƒç”¨ C å‡½æ•°ï¼Œè¿™é‡Œé€šè¿‡`extern "C" { }` cdecl è°ƒç”¨çº¦å®šå…¬å¼€ã€‚è¿™æ„å‘³ç€ä¸ºäº†èƒ½å¤Ÿè°ƒç”¨è®¡ç®—å¼•æ“çš„ C++éƒ¨åˆ†ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ª [C åˆ° C++çš„è½¬æ¢å±‚](https://github.com/nventive/calculator/blob/uno/src/CalcManager/CCalcManager.h)ã€‚å®ƒå…¬å¼€äº†ä¸€ç»„å¯ä»¥[åˆ›å»º C++å®ä¾‹](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/src/CalcManager/CCalcManager.h#L86)çš„æ–¹æ³•ï¼Œå¹¶è¿”å›ä¸é€æ˜çš„æ ‡è¯†ç¬¦ï¼Œè¿™äº›æ ‡è¯†ç¬¦[éšåè¢«æ˜¾å¼](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/src/CalcManager/CCalcManager.h#L87)ä¼ é€’ç»™ C++ç±»å®ä¾‹æ–¹æ³•ã€‚

è¿™ç§æŠ€æœ¯éœ€è¦æ‰‹å·¥æ“ä½œï¼Œä½†æ˜¯ç”±äºè®¡ç®—å¼•æ“å¹¶ä¸ç‰¹åˆ«å¤æ‚ï¼Œæ‰€ä»¥æ·»åŠ æ‰€æœ‰éœ€è¦çš„æ–¹æ³•å¾ˆå®¹æ˜“ã€‚

### [](#challenge-8-the-case-of-c-to-c-callbacks)æŒ‘æˆ˜ 8:c++åˆ° C#å›è°ƒçš„æ¡ˆä¾‹

å›è°ƒä¸€èˆ¬é€šè¿‡ [`Marshal.GetFunctionPointerForDelegates`](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/src/Calculator.Shared/CalcManager/CalculatorManager.cs#L139) åœ¨ C#ä¸­å¤„ç†ã€‚

è™½ç„¶è¿™å¯¹äº JIT å…¼å®¹çš„å¹³å°(Android å’Œ Windows)é€šè¿‡åœ¨è¿è¡Œæ—¶åˆ›å»º stubs æˆ– trampolines å·¥ä½œå¾—å¾ˆå¥½ï¼Œä½† iOS å’Œ WebAssembly ä¸æ”¯æŒè¿™ä¸€ç‚¹ã€‚

å¯¹äº iOSï¼Œéœ€è¦æ·»åŠ  [`UnmanagedFuntionPointer`](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/src/Calculator.Shared/CalcManager/CalculatorManager.Interop.cs#L128) ï¼Œä»¥ä¾¿åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆå›è°ƒæŒ‡é’ˆã€‚

Mono-wasm è¿˜ä¸æ”¯æŒè¿™ä¸ªç‰¹æ€§ï¼Œè€Œä¸”[éœ€è¦ä¾é ](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/src/Calculator.Wasm/WasmScripts/CalcManager.js#L18)çš„ [emscripten ä¿ç•™å‡½æ•°æŒ‡é’ˆ](https://emscripten.org/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html#calling-javascript-functions-as-function-pointers-from-c)å’Œ`addFunction`å¸®åŠ©å‡½æ•°æ¥è·å¾— WebAssembly å¯¹ C#çš„å¯è°ƒç”¨å›è°ƒã€‚ç„¶åï¼Œæ¯ä¸ª Javascript æ³¨å†Œå‡½æ•°ä½¿ç”¨ Mono çš„ç»‘å®šåŠ©æ‰‹å›è°ƒ C#ã€‚

### [](#challenge-9-string-marshalling)æŒ‘æˆ˜ä¹:å­—ç¬¦ä¸²ç¼–ç»„

å­—ç¬¦ä¸²ç¼–ç»„æ˜¯ä¸€ä»¶æ£˜æ‰‹çš„äº‹æƒ…ã€‚Windows ç³»ç»Ÿä½¿ç”¨ UTF16 ç¼–ç ï¼Œè€Œ*nix ç³»ç»Ÿä½¿ç”¨ UTF32 ç¼–ç ã€‚é»˜è®¤çš„ p/invoke ç¼–ç»„ä¸æ”¯æŒä» UF32 åˆ° UF32 çš„éšå¼è½¬æ¢ï¼Œéœ€è¦æ·»åŠ ä¸€äº›å¯¹å­—ç¬¦ä¸²çš„[æ˜¾å¼ç®¡ç†æ¥æ”¯æŒ C++ `wchar_t`ç±»å‹ã€‚](https://github.com/nventive/calculator/blob/2657413f889ba26f2e3d78e82d384794fdad3aec/src/Calculator.Shared/CalcManager/CalculatorManager.Interop.cs#L326)

### [](#challenge-10-adding-features-to-uno-platform)æŒ‘æˆ˜#10:å‘ Uno å¹³å°æ·»åŠ åŠŸèƒ½

åœ¨ç§»æ¤è®¡ç®—å™¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ·»åŠ å¯¹è®¡ç®—å™¨æ‰€ä¾èµ–çš„è®¸å¤š XAML å’Œ WinRT ç‰¹æ€§çš„æ”¯æŒã€‚

è¯¸å¦‚ Grid çš„[RowDefinitions.MaxWith/MaxHeight æ”¯æŒ](https://github.com/nventive/Uno/pull/1048)ã€[ä½¿ç”¨èµ„æº](https://github.com/nventive/Uno/pull/966)çš„é™„åŠ å±æ€§æœ¬åœ°åŒ–ã€WebAssembly çš„[æ–‡æœ¬æµ‹é‡](https://github.com/nventive/Uno/pull/1034)å’Œ[ç¼“å­˜](https://github.com/nventive/Uno/pull/931)ç­‰ä¿®å¤ã€ä½¿ç”¨ [VisualState è§¦å‘å™¨](https://github.com/nventive/Uno/pull/1008)ã€ [Javascript å°é€](https://github.com/nventive/Uno/pull/970)çš„æ€§èƒ½æ”¹è¿›ä»¥åŠå¯¹æ–° [`x:Load`å±æ€§](https://github.com/nventive/Uno/pull/870)çš„æ”¯æŒæ˜¯æˆ‘ä»¬å¯¹ Uno å¹³å°çš„ä¸€äº›æ”¹è¿›ã€‚

ä¸ºäº†é€‚åº” Uno å¹³å°ï¼Œè¿˜å¯¹è®¡ç®—å™¨çš„åŸå§‹æºä»£ç è¿›è¡Œäº†å…¶ä»–è°ƒæ•´ï¼Œéšç€æˆ‘ä»¬é€æ¸å‘ Uno å¹³å°æ·»åŠ æ–°åŠŸèƒ½ï¼Œæˆ‘ä»¬å°†åœ¨æœªæ¥æ·»åŠ å¯¹è¿™äº›å†…å®¹çš„æ”¯æŒã€‚

## [](#additional-notes)é™„åŠ æ³¨é‡Š

è´§å¸è½¬æ¢å™¨ä½¿ç”¨ API è°ƒç”¨æ¥è·å–æœ€æ–°çš„æ±‡ç‡ï¼Œå¹¶ä¸”ç«¯ç‚¹ä¸æ”¯æŒ CORSï¼Œè¿™ä½¿å¾—ä» web æµè§ˆå™¨è°ƒç”¨å˜å¾—å›°éš¾ã€‚API è°ƒç”¨ç°åœ¨é€šè¿‡ [CORS-anywhere ç¤ºä¾‹åº”ç”¨](https://cors-anywhere.herokuapp.com/)è¿›è¡Œï¼Œä½†æœ€ç»ˆå¾®è½¯å¯èƒ½ä¼šæ›´æ–°å…¶ç«¯ç‚¹ä»¥æ­£ç¡®æ”¯æŒå®ƒã€‚

[![Calculator](../Images/be992a17b1845a699559831722341955.png)T2ã€‘](https://raw.githubusercontent.com/nventive/Uno/master/doc/blog/Assets/20190612-Calculator-05.png)

æ­¤å¤–ï¼Œå¦‚æœæ‚¨æ­£åœ¨å°è¯•è®¡ç®—å™¨ï¼Œæˆ–ä»»ä½•å…¶ä»– WASM ç›¸å…³çš„åº”ç”¨ç¨‹åºï¼Œç”±äº WebAssembly çš„é™åˆ¶ï¼Œæ‚¨åº”è¯¥è®°ä½ä»¥ä¸‹å‡ ç‚¹ã€‚

1.  WebAssembly æ­£åœ¨è¿›è¡Œä¸­â€”â€”éšç€ emscriptenã€LLVMã€Mono å’Œ Uno å¹³å°çš„æ”¹è¿›ï¼Œæ€§èƒ½è¶Šæ¥è¶Šå¥½ã€‚
2.  è®¸å¤šå¼€å‘è€…ä½¿ç”¨ Chrome ä½œä¸ºä»–ä»¬çš„ä¸»è¦æµè§ˆå™¨ã€‚ç›®å‰ Chrome è‡ªå·±å¯¹ WebAssembly çš„æ”¯æŒè¿˜ä¸å¤ªåˆ°ä½(ç›®å‰çš„ canary å¥½å¾—å¤šï¼)ï¼Œæ‰€ä»¥æ‚¨å¯èƒ½æƒ³ä½¿ç”¨å…¶ä»–æµè§ˆå™¨æ¥å°è¯•è®¡ç®—å™¨ã€‚

### [](#about-the-c-conversion)å…³äº C++è½¬æ¢

å°† C++ç¿»è¯‘æˆ C#å¯¹äºç†è§£ä»£ç éå¸¸æœ‰ç”¨ï¼Œå¹¶ä½¿å…¶æ›´ä¸ºä¸€èˆ¬ Windows å¼€å‘äººå‘˜æ‰€ç†Ÿæ‚‰ï¼Œä½†æ˜¯å®ƒçš„ç¼ºç‚¹æ˜¯ä½¿å¾—å¯¹åŸå§‹æºä»£ç çš„å˜æ›´è·Ÿè¸ªæ›´åŠ å›°éš¾ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬é€‰æ‹©å°½å¯èƒ½å°‘åœ°é‡æ„ä»£ç (ä¾‹å¦‚ï¼Œä¸åšä»»ä½•è°ƒæ•´ä»¥ç¬¦åˆ C#é€šç”¨å‘½åçº¦å®š)å¹¶å°½å¯èƒ½ä¿æŒ C#ä»£ç æ¥è¿‘åŸå§‹ C++ä»£ç ã€‚è¿™ç®€åŒ–äº†å°†ä¸Šæ¸¸ C++æ›´æ–°åº”ç”¨åˆ° C#ä»£ç åº“çš„è¿‡ç¨‹ã€‚

### [](#final-thoughts)æœ€åçš„æƒ³æ³•

è®¡ç®—å™¨çš„ç§»æ¤æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£çš„é¡¹ç›®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¯ä»¥åœ¨æ‰€æœ‰å¹³å°ä¸Šä½¿ç”¨çš„éå¸¸å¥½çš„è®¡ç®—å™¨ã€‚

ä½ å¯ä»¥å» GitHub repo å°è¯•è‡ªå·±æ„å»ºå®ƒ[ã€‚](https://github.com/nventive/calculator)

æˆ‘ä»¬å¸Œæœ›å¸®åŠ©å¼€å‘äººå‘˜ç¼–å†™èƒ½å¤Ÿåœ¨ Webã€ç§»åŠ¨å’Œæ¡Œé¢ä¸Šè¿è¡Œçš„å•ä»£ç åº”ç”¨ç¨‹åºã€‚ä¸ºäº†å¸®åŠ©ä½ åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬[åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„æ•™ç¨‹](https://platform.uno/docs/articles/getting-started-tutorial-1.html)ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨ä½ è‡ªå·±çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚å¦‚æœä½ èƒ½è¯•ä¸€è¯•ï¼Œæˆ‘ä»¬å°†ä¸èƒœæ„Ÿæ¿€ã€‚

è®©æˆ‘ä»¬çŸ¥é“ä½ çš„æƒ³æ³•ï¼

*ç‰¹åˆ«æ„Ÿè°¢*[](https://nventive.com/)**å›¢é˜Ÿä¸ºå®ç°è¯¥åº”ç”¨çš„ç§»æ¤æ‰€åšçš„è¾›å‹¤å·¥ä½œï¼**

 *å¸–å­[ä¸€ç‰‡ Windows 10 ç°åœ¨è¿è¡Œåœ¨ WebAssembly ä¸Šï¼ŒåŸç”Ÿåœ¨ iOS å’Œ Android ä¸Š](https://platform.uno/a-piece-of-windows-10-is-now-running-on-webassembly-natively-on-ios-and-android/)æœ€æ—©å‡ºç°åœ¨ [Uno å¹³å°](https://platform.uno)ã€‚*