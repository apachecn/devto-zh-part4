# å¦‚ä½•åœ¨ SQL ä¸­ç¼–å†™å¯é€‰è¿‡æ»¤å™¨

> åŸæ–‡:[https://dev . to/tiim/how-to-write-optional-filters-in-SQL-Fei](https://dev.to/tiim/how-to-write-optional-filters-in-sql-fei)

## [](#the-problem)é—®é¢˜

å‡è®¾æ‚¨æœ‰ä¸€ä¸ª rest APIï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç«¯ç‚¹ï¼Œå¯ä»¥è¿”å›æ•°æ®åº“ä¸­çš„æ‰€æœ‰ä¹¦ç±:

```
GET /book/ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨çš„ SQL æŸ¥è¯¢å¯èƒ½å¦‚ä¸‹æ‰€ç¤º

```
SELECT * 
FROM books 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¾‹å¦‚ï¼Œæœ‰æ—¶æ‚¨åªæƒ³åˆ—å‡ºæŸä¸ªç‰¹å®šä½œè€…çš„ä¹¦ç±ã€‚æˆ‘ä»¬å¦‚ä½•åœ¨ SQL ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ

## [](#naive-solution-string-concatenation-%E2%9C%82)å¤©çœŸè§£:å­—ç¬¦ä¸²ä¸²è”âœ‚

ä¸€ç§æ–¹æ³•æ˜¯è¿æ¥æ‚¨çš„ sql æŸ¥è¯¢ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
const arguments = [];
const queryString = 'SELECT * FROM books WHERE true';
if ( authorFilter != null) {
  queryString  += 'AND author = ?';
  arguments.push(authorFilter);
}
db.query(queryString, arguments); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä¸å¤ªå–œæ¬¢æ‰‹åŠ¨è¿æ¥å­—ç¬¦ä¸²ã€‚

## [](#the-coalesce-function)èšç»“åŠŸèƒ½ğŸŒŸ

å¤§å¤šæ•°æ•°æ®åº“éƒ½æœ‰å‡½æ•°`coalesce`ï¼Œå®ƒæ¥å—æ•°é‡å¯å˜çš„å‚æ•°ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªä¸ä¸ºç©ºçš„å‚æ•°ã€‚

```
-- Examle
SELECT coalesce(null, null, 'dev.to', null, '@TiimB') as example;

-- Will return 

example
---------
dev.to 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½†æ˜¯è¿™ä¸ªå‡½æ•°å°†å¦‚ä½•å¸®åŠ©æˆ‘ä»¬å‘¢ï¼Ÿ

## [](#optional-filters-with-the-coalesce-function)å¸¦åˆå¹¶åŠŸèƒ½çš„å¯é€‰è¿‡æ»¤å™¨

```
SELECT * 
FROM books
WHERE 
  author = coalesce(?, author); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœè¿‡æ»¤å™¨å€¼ä¸ºç©ºï¼Œåˆå¹¶è¡¨è¾¾å¼å°†è§£æä¸º`author`
ï¼Œæ¯”è¾ƒç»“æœ`author = author`å°†ä¸ºçœŸã€‚

å¦ä¸€æ–¹é¢ï¼Œå¦‚æœå€¼è¢«è®¾ç½®ä¸ºä¾‹å¦‚èå£«æ¯”äºšï¼Œé‚£ä¹ˆä½œè€…å°†è¢«ä¸èå£«æ¯”äºšè¿›è¡Œæ¯”è¾ƒã€‚

æˆ‘åªæ˜¯æœ€è¿‘æ‰å‘ç°è¿™ç§å®ç°å¯é€‰è¿‡æ»¤å™¨çš„æ–¹æ³•ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªæ›´ä¹ æƒ¯çš„æ–¹æ³•æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¯·è®©æˆ‘çŸ¥é“âœ¨

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·åœ¨è¿™é‡Œæˆ– Twitter ä¸Šå…³æ³¨æˆ‘ï¼Œå…³æ³¨æ ‡é¢˜ä¸º [@TiimB](https://twitter.com/TiimB) ğŸ˜