# ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç½‘ç»œéŸ³é¢‘ Api å’Œ Angular çš„éŸ³é¢‘åºåˆ—å™¨

> åŸæ–‡:[https://dev . to/elastic crash/a-simple-audio-sequencer-using-we B- audio-API-angular-n99](https://dev.to/elasticrash/a-simple-audio-sequencer-using-web-audio-api-angular-n99)

å‡ºäºå„ç§ä¸ªäººåŸå› ï¼Œæˆ‘å†³å®šå°†æˆ‘çš„å¸–å­ä» medium ç§»åˆ°è¿™é‡Œã€‚å½“æˆ‘ç§»åŠ¨å®ƒä»¬çš„æ—¶å€™ï¼Œæˆ‘ä¹Ÿä¼šæŠŠå®ƒä»¬ä»é‚£é‡Œåˆ é™¤ï¼Œæ²¡æœ‰ç†ç”±ä¸¤ä¸ªéƒ½ä¿ç•™ã€‚æˆ‘ä»æœ€ä¸å—æ¬¢è¿çš„å¼€å§‹ã€‚:D

å’Œå¤§å¤šæ•°å¼€å‘äººå‘˜ä¸€æ ·ï¼Œæˆ‘æŠŠç©ºé—²æ—¶é—´èŠ±åœ¨å¼€å‘ä¸Šâ€¦â€¦æˆ–è€…æ¸¸æˆä¸Š(å’³å’³)ï¼Œæˆ–è€…è‡ªä»æˆ‘æˆä¸ºçˆ¶æ¯ä¹‹åâ€¦â€¦æ›´å¤šçš„æ˜¯å¯»æ‰¾ç¡è§‰çš„æœºä¼šï¼Œè€Œä¸æ˜¯å¼€å‘ã€‚

ç„¶è€Œï¼Œè¿™æ¬¡æˆ‘å†³å®šåˆ›å»ºä¸€ä¸ªç®€å•çš„æœ€å°éŸ³é¢‘åºåˆ—ã€‚

å› æ­¤ï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘å®é™…ä¸Šç»™äº†è¿™ä¸ªé¡¹ç›®ä¸€ç‚¹æ€è€ƒï¼Œå¹¶åœ¨æˆ‘å¼€å§‹å¼€å‘ä¹‹å‰å†™ä¸‹äº†æˆ‘çš„éœ€æ±‚ã€‚

*   æƒ³è±¡ä»£è¡¨ä¸åŒå£°éŸ³çš„ n ä¸ªå…ƒç´ çš„åºåˆ—
*   è¿™äº›å…ƒç´ å¯ä»¥æ‰“å¼€å’Œå…³é—­(é™éŸ³/æ”¹å˜é¢œè‰²)
*   å°†æ‰§è¡Œåºåˆ—çš„å¼€å§‹æŒ‰é’®
*   æ‰§è¡Œæ¯ä¸ªå…ƒç´ æ—¶æ”¹å˜é¢œè‰²
*   å®Œæˆåï¼Œé‡ç½®æ¯ä¸ªå…ƒç´ çš„çŠ¶æ€å’Œé¢œè‰²

ä¸ºä»€ä¹ˆæœ‰æ£±è§’ï¼Ÿä¸ºä»€ä¹ˆä¸å‘¢ï¼Ÿåªæ˜¯ä¸ªäººå–œå¥½ã€‚

æˆ‘çš„åº”ç”¨ç¨‹åºæœ‰ä¸€ä¸ªç»„ä»¶å’Œä¸€ä¸ªæœåŠ¡ã€‚

```
> sequencer.component.ts
> sound.service.ts 
```

æˆ‘çš„å‹å·å¦‚ä¸‹

```
interface Block {
    color: string; // hex color
    state: true; // true = sound, false  = no sound
    note: Note;
} 
```

```
interface Note {
    name: string; // name of the note
    frequency: number; // frequency (hertz) of the note
    position: number; // I don't use it but its useful to know
                     // the octave this frequency corresponds to
} 
```

â€¦ç°åœ¨å›°éš¾çš„å·¥ä½œå·²ç»å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å®æ–½æƒ³æ³•çš„ç®€å•éƒ¨åˆ†äº†ã€‚

é¦–å…ˆæ˜¯æˆ‘ä»¬çš„æœåŠ¡ã€‚

```
@Injectable()
export class SoundService {
  // initially i had like 6 octaves but it was pretty pointless
  // so I trimmed it down to 2 (octave 4 and 5)
  public notes = [
  {
    name: 'C',
    position: 4,
    frequency: 261.63
  }, {
    name: 'C#',
    position: 4,
    frequency: 277.18
  }, {
    name: 'D',
    position: 4,
    frequency: 293.66
  } ... ] // I am not going to list all the notes
  private audioCtx = new (window['AudioContext'] || window['webkitAudioContext'])();
  private gainNode = this.audioCtx.createGain();
  public play(freq, time, delay) {
    const oscillator = this.audioCtx.createOscillator();
    oscillator.connect(this.gainNode);
    this.gainNode.connect(this.audioCtx.destination);
    oscillator.type = 'sine'; 
    oscillator.frequency.value = freq;
    oscillator.start(this.audioCtx.currentTime + delay);
    oscillator.stop(this.audioCtx.currentTime + delay + time);
  }
} 
```

æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä»¥ä¸‹å˜é‡ã€‚

*   ä¸€å¼ ä¾¿æ¡ğŸ¶å…·æœ‰ç›¸åº”é¢‘ç‡çš„å¯¹è±¡
*   éŸ³é¢‘ç¯å¢ƒğŸ¹å…¶å¤„ç†ä¿¡å·
*   æ§åˆ¶éŸ³é‡çš„å¢ç›ŠèŠ‚ç‚¹ğŸ”Š

æœ€åæ˜¯æˆ‘ä»¬çš„æ¸¸æˆåŠŸèƒ½ã€‚æˆ‘ä½¿ç”¨æ’­æ”¾åŠŸèƒ½çš„æ–¹å¼æœ‰ç‚¹å¥‡æ€ªã€‚å½“æˆ‘æƒ³è®©æ³¨é‡Šè¢«æ‰§è¡Œæ—¶ï¼Œæˆ‘ä¸æ˜¯å‘é€ä¸€ä¸ªæ³¨é‡Šï¼Œè€Œæ˜¯å»¶è¿Ÿå‘é€ä¸€ä¸ªæ³¨é‡Šï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥å‘é€æ•´ä¸ªåºåˆ—ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯åºåˆ—ä¸èƒ½è¢«åœæ­¢(å½“ç„¶ï¼Œå¦‚æœä½ æœ‰æ¥è‡ªæŒ¯è¡å™¨å¯¹è±¡çš„å¼•ç”¨é™¤å¤–)ã€‚

æˆ‘ä»¬çš„æ¨¡æ¿(sequencer.component.html)çœŸçš„å¾ˆç®€å•â€¦ç®€å•åˆ°æœ‰ç‚¹å‚»ğŸ”¥

```
<div class="pad">
  <div *ngFor="let block of blocks;let i = index" class="block">
    <div class="single-block"
         [ngStyle]="{'background-color': block.color}"
         (click)="changeState(i);">
      {{ block.note.name }}
    </div>
  </div>
</div>
<button class="btn" (click)="play()">start</button> 
```

ç°åœ¨æˆ‘ä»¬çš„ä¸»è¦éƒ¨åˆ†æ˜¯ sequencer.component.tsï¼

æˆ‘ä»¬å®šä¹‰ä¸€äº›å˜é‡

```
@Component({
  selector: 'sequencer-pad',
  templateUrl: './sequencer.component.html',
  styleUrls: ['./sequencer.component.css']
})
export class PadComponent implements OnInit {
  public blocks: Block[] = [];
  private blockSize = 13; // sequencer will use 13 notes
  private noteLength = 1; // duration of the note (1 second)
  constructor(private soundService: SoundService) { }
  ...
} 
```

*   ç§¯æœ¨æ˜¯æˆ‘ä»¬çš„å»ºç­‘ææ–™ğŸ˜ƒ
*   blockSize æ˜¯æˆ‘ä»¬åœ¨æœåŠ¡ä¸­å®šä¹‰çš„å¸Œæœ›åœ¨åºåˆ—ä¸­ä½¿ç”¨çš„éŸ³ç¬¦çš„æ•°é‡ã€‚æˆ‘è¿™æ ·åšæ˜¯ä¸ºäº†è®©è‡ªå·±å¬èµ·æ¥ä¸é‚£ä¹ˆæ— èŠã€‚å¦‚æœæˆ‘æƒ³åˆ›å»ºä¸€ä¸ªæ›´çœŸå®çš„éŸ³åºå™¨ï¼Œæˆ‘å¯èƒ½ä¼šæœ‰ä¸€ä¸ªå—æ•°ç»„çš„é›†åˆï¼Œæ¯ä¸ªæ•°ç»„éƒ½æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„å£°éŸ³ã€‚
*   æ³¨æ„é•¿åº¦ï¼Œè¿™åŸºæœ¬ä¸Šæ˜¯å£°éŸ³çš„æŒç»­æ—¶é—´ğŸµå‡ºå“ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ1 ç§’é’Ÿåº”è¯¥æ²¡é—®é¢˜ã€‚
*   åœ¨ ngOnInit()ä¸Šï¼Œæˆ‘åˆ›å»ºäº†æˆ‘çš„å—æ•°ç»„

```
ngOnInit() {
  // add default values to the blocks array
  for (let index = 0; index < this.blockSize; index++) {
    this.blocks.push({
      color: 'limegreen',
      state: true,
      note: this.soundService.notes[index]
    });
  }
} 
```

*   å½“ä½ ç‚¹å‡»ä¸€ä¸ªä¾¿ç¬ºæ—¶ï¼Œä½ éœ€è¦æ”¹å˜å®ƒçš„é¢œè‰²å’ŒçŠ¶æ€

```
/**
 * change the color of the div, and switch its state (on/off)
 * @param index
 */
public changeState(index: number) {
  this.blocks[index] = (this.blocks[index].color === 'limegreen') ?
  {
    color: 'tomato',
    state: false,
    note: this.blocks[index].note
  } : {
    color: 'limegreen',
    state: true,
    note: this.blocks[index].note
  };
} 
```

*   å½“åºåˆ—ç»“æŸæ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡ç½®é¢œè‰²å’ŒçŠ¶æ€

```
/**
 * when sequence ends this returns the colors but to limegreen
 */
private resetColor() {
  this.blocks.forEach(element => {
    element.color = 'limegreen';
    element.state = true;
    });
  }
} 
```

*   æ’­æ”¾åºåˆ—ï¼Œå¹¶é€‚å½“åœ°æ¶‚ä¸Šé¢œè‰²

```
/**
 * play the notes that have a true state
 */
public play() {
  this.blocks.forEach((element, index) => {
    if (element.state) {
      const note = this.soundService.notes[index];
      this.soundService.play(note.frequency,
      this.noteLength, index * this.noteLength);
    }
    // this is to emulate the progress
    setTimeout(() => {
      element.color = 'lightpink';
      if (index + 1 === this.blocks.length) {
        setTimeout(() => {
          this.resetColor();
        }, this.noteLength * 1000);
      }
    }, this.noteLength * 1000 * index);
  });
} 
```

å°±åƒæˆ‘ä¹‹å‰è¯´çš„ï¼Œæˆ‘æ­£åœ¨è¿­ä»£å—æ•°ç»„ï¼Œå¹¶ä»¥é€‚å½“çš„å»¶è¿Ÿå°†æ¯ä¸ªéŸ³ç¬¦å‘é€åˆ° soundServiceã€‚å› ä¸ºæˆ‘è®¾è®¡å®ƒçš„æ–¹å¼ï¼Œå½“ä¸€ä¸ªéŸ³è°ƒå¼€å§‹å’Œç»“æŸæ—¶ï¼Œæˆ‘æ²¡æœ‰æ¥è‡ª soundService çš„åé¦ˆï¼Œæ‰€ä»¥æˆ‘å¿…é¡»ä½¿ç”¨ setTimeout(ä¸¤æ¬¡)æ¥æ¨¡æ‹Ÿ UI ä¸­åºåˆ—çš„è¿›åº¦ã€‚

é¢å¤–æ”¶è·:æˆ‘ä½¿ç”¨çš„é£æ ¼

```
.pad {
margin-top: 20px;
display: flex;
flex-direction: row;
}
.single-block {
flex: auto;
min-height: 40px;
min-width: 40px;
display: inline-block;
border: none;
margin-right: 5px;
cursor: pointer;
border-radius: 5px;
text-align: center;
border-color: green;
border-style: solid;
}
.btn {
margin-top: 20px;
color: black;
background: #ffffff;
text-transform: uppercase;
padding: 20px;
border: 5px solid black;
border-radius: 6px;
display: inline-block;
}
.btn:hover {
color: #ffffff;
background: green;
transition: all 0.4s ease 0s;
} 
```