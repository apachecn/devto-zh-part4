# ä½¿ç”¨ RxJS finalize è¿ç®—ç¬¦æ­£ç¡®å¤„ç†åŠ¨ç”»

> åŸæ–‡:[https://dev . to/rxjs/handling-animations-proper-with-the-rxjs-finalize-operator-F9](https://dev.to/rxjs/handling-animations-properly-with-the-rxjs-finalize-operator-f9)

æˆ‘æœ€è¿‘åœ¨æ„å»ºä¸€ä¸ª Angular åº”ç”¨ç¨‹åºï¼Œå®ƒå¿…é¡»ä»ä¸€ä¸ª API è¯·æ±‚æ•°æ®ã€‚ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯ Angular HttpClientï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°æ®è¯·æ±‚çš„å“åº”è¢«åŒ…è£…åœ¨ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ä¸­ã€‚

æ¯å½“å‘èµ·å¯¹æ•°æ®çš„`GET`è¯·æ±‚æ—¶ï¼Œæˆ‘å¸Œæœ›æ˜¾ç¤ºä¸€ä¸ªåŠ¨ç”»çœç•¥å·ï¼Œè¡¨æ˜æ•°æ®æ£€ç´¢è¿‡ç¨‹æ­£åœ¨è¿›è¡Œã€‚å¦‚æœæ•°æ®æ£€ç´¢æˆåŠŸï¼Œæˆ–è€…åœ¨æ£€ç´¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼ŒåŠ¨ç”»çœç•¥å·å°†é€€å‡ºå±å¹•ã€‚

å¯è§‚å¯Ÿå¯¹è±¡æ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œå®ƒä¸æ–­åœ°å‘é™„å±äºå®ƒçš„è®¢æˆ·å‘é€æ•°æ®ã€‚è®¢æˆ·æ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œå®ƒä¼šæŒç»­ä¾¦å¬ä»å…¶è®¢é˜…çš„å¯è§‚å¯Ÿå¯¹è±¡å‘å‡ºçš„æ•°æ®ã€‚å½“è®¢é˜…è€…è®¢é˜…ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡æ—¶ï¼Œè®¢é˜…è€…æœ‰ä¸‰ä¸ªå¤„ç†ç¨‹åºæ¥å“åº”å¯è§‚å¯Ÿå¯¹è±¡å‘å‡ºçš„æ•°æ®ã€‚è¿™ä¸‰ä¸ªå¤„ç†ç¨‹åºæ˜¯:

*   `next`å¤„ç†ç¨‹åºâ€”â€”å½“å¯è§‚æµ‹æºä»å…¶æ•°æ®åºåˆ—ä¸­å‘å‡ºä¸€ä¸ªæ–°å€¼æ—¶æ‰§è¡Œï¼Œ
*   `error`å¤„ç†ç¨‹åºâ€”â€”å½“å¯è§‚å¯Ÿæ•°æ®åºåˆ—ä¸­çš„å€¼å‡ºç°é”™è¯¯æ—¶æ‰§è¡Œï¼Œä»¥åŠ
*   `complete`å¤„ç†ç¨‹åºâ€”â€”å½“å¯è§‚å¯Ÿåºåˆ—ä¸­æ²¡æœ‰æ›´å¤šå€¼å¯å‘å‡ºæ—¶æ‰§è¡Œ

å‡è®¾ä¸‹é¢çš„`getResults`æ–¹æ³•è¿”å›ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ï¼Œé‚£ä¹ˆ`next`ã€`error`å’Œ`complete`å¤„ç†ç¨‹åºåœ¨å…¶ subscribe æ–¹æ³•ä¸­ä¸¾ä¾‹è¯´æ˜ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µ
æ‰€ç¤º

```
getResults().subscribe(
  results => console.log('Next handler executed with results: ', results),
  error => console.error('Error handler executed with error: ', error),
  () => console.log(`Complete handler executed. All values have been emitted`),
); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½œä¸º observables çš„æ–°æ‰‹ï¼Œæˆ‘å°†éšè—åŠ¨ç”»çœç•¥å·çš„æ–¹æ³•æ”¾åœ¨äº†`complete`æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹é¢çš„ç‰‡æ®µæ‰€ç¤º

```
getResults().subscribe(
  results => displayResults(results),
  error => notifyOnError(error.message),
  () => hideAnimatedEllipses(),
); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŠ¨ç”»çœç•¥å·æ˜¯éšè—çš„(åªè¦è¯·æ±‚æ²¡æœ‰è¿”å›é”™è¯¯)ã€‚æ¯å½“å‡ºç°é”™è¯¯æ—¶ï¼ŒåŠ¨ç”»çœç•¥å·ä»ç„¶ä¼šåœ¨ç”¨æˆ·ç•Œé¢ä¸Šä¸æ˜¾ç¤ºçš„é”™è¯¯ä¿¡æ¯ä¸€èµ·è·³åŠ¨ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯åœ¨`complete`å’Œ`error`å¤„ç†ç¨‹åºä¸­æ‰§è¡Œ`hideAnimatedEllipses()`æ–¹æ³•ã€‚æ²¡é—®é¢˜ï¼å®ƒèµ·ä½œç”¨äº†ï¼Œä½†æ˜¯åæ¥æˆ‘å¼€å§‹äº†è§£ finalize æ“ä½œç¬¦ï¼Œè¿™æ˜¯å®Œæˆå·¥ä½œçš„ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•ã€‚

å­¦ä¹  finalize æ“ä½œç¬¦ä¸ä»…è§£å†³äº†æˆ‘çš„é—®é¢˜ï¼Œè¿˜æš´éœ²äº†æˆ‘å¯¹ä¸‰ä¸ªè®¢é˜…å¤„ç†ç¨‹åºç†è§£çš„é”™è¯¯ã€‚

æˆ‘å‘ç°åœ¨æ‰§è¡Œäº†`error`å¤„ç†ç¨‹åºä¹‹åï¼Œå¯¹`next`å¤„ç†ç¨‹åºçš„è¿›ä¸€æ­¥è°ƒç”¨å°†ä¸èµ·ä½œç”¨ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œäº†`complete`å¤„ç†ç¨‹åºä¹‹åï¼Œå¯¹`next`å¤„ç†ç¨‹åºçš„è¿›ä¸€æ­¥è°ƒç”¨ä¹Ÿå°†ä¸èµ·ä½œç”¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåŠ¨ç”»çœç•¥å·ä¸€å¼€å§‹å°±åœ¨ç”¨æˆ·ç•Œé¢ä¸Šè‡ªä¿¡åœ°è·³èˆï¼Œç”šè‡³åœ¨æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä¹‹åã€‚

> **å®Œæˆ**:å½“ä¸€ä¸ªå¯è§‚å¯Ÿçš„æºåœ¨å®Œæˆæˆ–å‡ºé”™æ—¶ç»ˆæ­¢æ—¶ï¼Œæ‰§è¡Œ`finalize`æ“ä½œç¬¦ã€‚

æˆ‘æ„è¯†åˆ°åœ¨æ‰§è¡Œ`finalize`è¿ç®—ç¬¦å‡½æ•°æ—¶`hideAnimatedEllipses()`å‡½æ•°åº”è¯¥æ­£ç¡®é©»ç•™ï¼Œå› æ­¤ä»£ç è¢«æ›´æ–°ä¸ºä¸‹é¢æ˜¾ç¤ºçš„ä»£ç ç‰‡æ®µ

```
getResults()
  .pipe(finalize(() => hideAnimatedEllipses()))
  .subscribe(results => displayResults(results), error => notifyOnError(error.message)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ¬è´¨ä¸Š

> å½“å¯è§‚æµ‹æºä»å…¶æ•°æ®åºåˆ—ä¸­å‘å‡ºæ–°å€¼æ—¶ï¼Œæ‰§è¡Œ **`next`** å¤„ç†ç¨‹åºï¼Œ
> 
> **`error`** å¤„ç†ç¨‹åºåœ¨å¯è§‚å¯Ÿå¯¹è±¡çš„æ•°æ®åºåˆ—ä¸­å‡ºç°é”™è¯¯æ—¶æ‰§è¡Œã€‚åœ¨å®ƒè¢«æ‰§è¡Œä¹‹åï¼Œå¯¹`next`çš„è¿›ä¸€æ­¥è°ƒç”¨å°†æ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œå¹¶ä¸”
> 
> å½“å¯è§‚å¯Ÿåºåˆ—ä¸­ä¸å†æœ‰å¯å‘å‡ºçš„å€¼æ—¶ï¼Œæ‰§è¡Œ **`complete`** å¤„ç†ç¨‹åºã€‚åœ¨å®ƒè¢«æ‰§è¡Œä¹‹åï¼Œå¯¹`next`çš„è¿›ä¸€æ­¥è°ƒç”¨å°†æ²¡æœ‰ä»»ä½•æ•ˆæœ
> 
> å½“ä¸€ä¸ªå¯è§‚å¯Ÿçš„æºåœ¨å®Œæˆæˆ–å‡ºé”™æ—¶ç»ˆæ­¢æ—¶ï¼Œæ‰§è¡Œ **`finalize`** æ“ä½œç¬¦ã€‚å½“è®¢é˜…è€…å–æ¶ˆè®¢é˜…ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡æ—¶ï¼Œ`finalize`æ“ä½œç¬¦ä¸­çš„ä»£ç ä¹Ÿè¢«æ‰§è¡Œï¼Œå› æ­¤`finalize`çš„è¡Œä¸ºç±»ä¼¼äºæ‰¿è¯ºçš„`finally`æ–¹æ³•æˆ–`try-catch-finally`é˜»å¡ã€‚åœ¨ RxJS v5.5 ä¹‹å‰ï¼Œè¡¨ç¤ºä¸º`finally`ã€‚

ä½ å¯ä»¥åœ¨ RxJS æ–‡æ¡£[ä¸­æ‰¾åˆ°å…³äº`finalize`æ“ä½œå‘˜çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·ç‚¹å‡»](http://reactivex.io/rxjs/file/es6/operators/finalize.js.html)

å¹²æ¯ï¼ğŸ˜ƒ