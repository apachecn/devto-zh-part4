# ä½¿ç”¨ fp-ts çš„å®‰å…¨ Node.js æ–‡ä»¶æ“ä½œ

> åŸæ–‡:[https://dev . to/wojciechmatuszewski/safe-node-js-file-operations-with-FP-ts-48ki](https://dev.to/wojciechmatuszewski/safe-node-js-file-operations-with-fp-ts-48ki)

å½“æˆ‘è¯•å›¾è®©è‡ªå·±ç†Ÿæ‚‰å‡½æ•°å¼ç¼–ç¨‹æ—¶ï¼Œæˆ‘æƒ³ï¼Œæˆ‘ä¸å¦¨æµ‹è¯•ä¸€ä¸‹æˆ‘ç›®å‰çš„æŠ€èƒ½ï¼Œå†™ä¸€äº›ä»£ç ã€‚

ç»è¿‡åå¤æ€è€ƒï¼Œæˆ‘å†³å®šä¸º Node.js åŸç”Ÿçš„`fs.readFile`å’Œ`fs.writeFile`æ–¹æ³•ç¼–å†™åŠŸèƒ½æ€§çš„ã€å®‰å…¨çš„ã€ä¸æ–‡ä»¶ç›¸å…³çš„(è¯»ã€å†™)åŒ…è£…å™¨ã€‚

> æœ¬æ–‡å‡è®¾æ‚¨äº†è§£ TypeScript çš„åŸºæœ¬çŸ¥è¯†å’Œå‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚ç»„åˆå’Œéƒ¨åˆ†åº”ç”¨ç¨‹åºï¼Œä»¥åŠå‡½å­å’Œå•å­çš„æ¦‚å¿µã€‚

# [](#first-things-first)å…ˆåšç¬¬ä¸€ä»¶äº‹

> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è·³è¿‡å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ä¸€äº›æ•°å­¦å†…å®¹ã€‚è™½ç„¶è¿™é‡Œçœç•¥äº†ï¼Œä½†å®ƒ**ä¸åº”è¯¥æ˜¯** *ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¿½ç•¥ä¸è®¡ã€‚

å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ç†Ÿæ‚‰`IO`ã€`Task`å’Œ`Either`åŠŸèƒ½ç»“æ„

## [](#either)è¦ä¹ˆ

ä¸¤è€…éƒ½æ˜¯å…·æœ‰ä¸¤ä¸ªå­ç±»å‹çš„ç»“æ„:

*   å·¦è¾¹çš„
*   æ­£ç¡®

è¿™ä¸¤ç§äºšå‹å¸¦æœ‰å¤±è´¥(`left`)å’ŒæˆåŠŸ(`right`)çš„æ¦‚å¿µã€‚

å®ƒä¸»è¦ç”¨äºä½¿è®¡ç®—å’Œè½¬æ¢å®‰å…¨ã€‚
å‡è®¾æˆ‘æƒ³å®ç°`safeParseInt`ã€‚`Either`æ˜¯è¿™æ ·åšçš„ç†æƒ³äººé€‰ã€‚

çœ‹çœ‹è¿™ä¸ª:

```
import { Either, left, map, right } from 'fp-ts/lib/Either';
import { increment } from 'fp-ts/lib/function';
import { compose } from 'ramda';

function safeParse(radix: number) {
  return function(strToParse: string): Either<string, number> {
    const n = parseInt(strToParse, radix);
    return isNaN(n) ? left('Parse failed') : right(n);
  };
}

const safeBaseTenParser = safeParse(10);

// You could also use fp-ts flow method
// flow works just like pipe, so you would have to switch the order of computations.
const res = compose(
  map(increment),
  safeBaseTenParser
)('123');

console.log(res);

// { _tag: 'Right', right: 124 }
// To get the actual value you probably should use the fold method. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”±äº *`Either`æ˜¯å³åçš„*ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„å˜æ¢(åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯`increment`)å°†åªåº”ç”¨äºå®é™…çš„ã€æ­£ç¡®çš„ã€*å³*å€¼ã€‚

ä¸€æ—¦æˆ‘ä»¬å¼•å…¥*å·¦*å€¼ï¼Œæ‰€æœ‰ç»§ç»­è¯¥å€¼çš„è½¬æ¢éƒ½å°†è¢«å¿½ç•¥:

```
// ... previous code ... //

const res = compose(
  map(val => {
    console.log('Im here');
    return val;
  }),
  safeBaseTenParser
)('js-is-awesome');

console.log(res) // { _tag: 'Left', left: 'Parse failed' } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`map`ä¸­çš„`console.log`ä»ä¸å¼€ç«ã€‚è¯¥è½¬æ¢è¢«å¿½ç•¥ï¼Œå› ä¸ºæˆ‘ä»¬ä»`safeBaseTenParser`æ¥æ”¶åˆ°*å·¦å€¼*ã€‚å¤šæ£’å•Šã€‚

ä¸ºäº†å®ç°å‰é¢æåˆ°çš„æ–‡ä»¶æ“ä½œï¼Œæˆ‘ä»¬ä¸æ‰“ç®—ç›´æ¥ä½¿ç”¨`Either`ï¼Œä½†æ˜¯ä¼šå‡ºç°*å·¦*å’Œ*å³*å€¼çš„æ¦‚å¿µã€‚

## [](#ioeither)IO_( *è¦ä¹ˆ*)

IO æ˜¯ä¸€ä¸ªç”¨äºåŒæ­¥è®¡ç®—çš„*è®¡ç®—ç”Ÿæˆå™¨*ã€‚è¿™å°±æ˜¯è®¡ç®—ï¼Œå®ƒä¼šåœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­äº§ç”Ÿå‰¯ä½œç”¨ã€‚

é€šè¿‡ä½¿ç”¨`IOEither`ï¼Œæˆ‘ä»¬æ­£åœ¨ä¼ è¾¾è¿™äº›è®¡ç®—å¯èƒ½ä¼šå¤±è´¥ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å¤„ç†*å³*å’Œ*å·¦*å€¼ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨`IOEither`æ¥è§£æ/å­—ç¬¦ä¸²åŒ–å€¼ã€‚

```
import { toError } from 'fp-ts/lib/Either'
import { IOEither, tryCatch as IOTryCatch } from 'fp-ts/lib/IOEither';

const stringifyData = (data: Todo[]) =>
  IOTryCatch(() => JSON.stringify(data), toError);

const parseStringifiedData = (data: string): IOEither<Error, Todo[]> =>
  IOTryCatch(() => JSON.parse(data), toError); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`IOTryCatch`åƒ`try{}catch{}`å—ä¸€æ ·å·¥ä½œï¼Œä½†æ˜¯è¿”å›`IOEither`,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»„åˆè¿™äº›æ“ä½œã€‚

æˆ‘ä»¬è¿˜ä½¿ç”¨`toError`å°†`JSON.parse/stringify`è¯¯å·®è½¬å‘åˆ°*å·¦å€¼*ã€‚

## [](#taskeither)ä»»åŠ¡ _(*)*

 *ä»»åŠ¡æ˜¯`IO`çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚
å› ä¸ºæˆ‘ä»¬æƒ³è·å¾—éé˜»å¡å¼‚æ­¥æ“ä½œçš„å¥½å¤„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿™ä¸ªç»“æ„æ¥åŒ…è£…`fs.readFile`å’Œ`fs.writeFile`æ–¹æ³•ã€‚

```
import { promisify } from 'util';
import fs from 'fs';
import { tryCatch as TaskEitherTryCatch } from 'fp-ts/lib/TaskEither';
import { toError } from 'fp-ts/lib/Either';

const readFromFile = promisify(fs.readFile);
const writeToFile = promisify(fs.writeFile);

export const getFileContents = (path: string) =>
  TaskEitherTryCatch(() => readFromFile(path, 'utf-8'), toError);

export const writeContentsToFile = (path: string) => (contents: string) =>
  TaskEitherTryCatch(() => writeToFile(path, contents), toError); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŒæ ·ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨äº†`tryCatch`å˜é‡ï¼Œè¿™ä½¿æˆ‘ä»¬ä¸å¿…æ‹…å¿ƒå®ç°æˆ‘ä»¬è‡ªå·±çš„`try{}catch{}`å—ã€‚

æˆ‘è¿˜å°†`writeContentsToFile`åˆ›å»ºä¸º*çš„é«˜é˜¶å‡½æ•°*ï¼Œä½¿å…¶æ›´åŠ å¯é‡ç”¨ï¼Œå¹¶èƒ½å¾ˆå¥½åœ°é…åˆåˆæˆã€‚

## [](#implementation)å®ç°

è¿™äº›æ˜¯ä¸»è¦çš„ç»„æˆéƒ¨åˆ†ã€‚ç°åœ¨è®©æˆ‘ä»¬æŠŠæ‰€æœ‰çš„ç¢ç‰‡æ‹¼åœ¨ä¸€èµ·:

```
 import { flow } from 'fp-ts/lib/function';
import {
  chain as TaskEitherChain,
  fromIOEither,
  map as TaskEitherMap
} from 'fp-ts/lib/TaskEither';

const FILE_NAME = 'data.json';
const FILE_PATH = path.join(__dirname, `./${FILE_NAME}`);

export const getFileData = flow(
  getFileContents,
  TaskEitherChain((rawString: string) =>
    fromIOEither(parseStringifiedData(rawString))
  )
);

export const saveData = (path: string) => (data: Todo) =>
  flow(
    getFileData,
    TaskEitherMap(append(data)),
    TaskEitherChain(todos => fromIOEither(stringifyData(todos))),
    TaskEitherChain(writeContentsToFile(FILE_PATH))
  )(path); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œéœ€è¦æ³¨æ„ä¸€äº›äº‹æƒ…:

*   æœ‰æ—¶å€™æˆ‘ä»¬ä¸å¾—ä¸ç”¨`fromIOEither`ã€‚è¿™æ˜¯å› ä¸º`IOEither`æ˜¯çº¯åŒæ­¥çš„ï¼Œè€Œ`TaskEither`ä¸æ˜¯ã€‚`fromIOEither`å…è®¸æˆ‘ä»¬å°†åŒæ­¥`IOEither`è½¬æ¢æˆåŒ¹é…çš„`TaskEither`ç»“æ„ã€‚

*   å¦‚æœä½ ä¸ç†Ÿæ‚‰`chain`æ–¹æ³•ï¼Œå®ƒå…è®¸æˆ‘ä»¬è½¬ä¹‰åµŒå¥—ç»“æ„ï¼Œå¹¶ä¸”ä»ç„¶*æ˜ å°„*ä¸€ä¸ªï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`TaskEither`åˆ°å¦ä¸€ä¸ªã€‚

*   `saveData`æ–¹æ³•æœ‰è¿™ä¸ª*å’–å–±æ ·çš„*ç­¾åï¼Œå…è®¸åˆ›å»ºç‹¬ç«‹çš„*ä¿å­˜ç®¡ç†å™¨*ï¼Œå®ƒæœ‰`path`å‰ç¼€ã€‚

*   æˆ‘è¿™é‡Œç”¨çš„æ˜¯`flow`çš„æ–¹æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†å°±åƒ`pipe`(ä»å·¦åˆ°å³)ã€‚

## [](#usage)ç”¨æ³•

ä¿å­˜æ•°æ®éå¸¸ç®€å•ã€‚æˆ‘ä»¬å¿…é¡»æä¾›`path`å’Œä¸€ä¸ª`Todo`ã€‚

```
saveData(FILE_PATH)({
  id: uuid(),
  isDone: false,
  content: 'content'
// getting the actual results using fold
})().then(either => fold(console.log, console.log)(either)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è·å–æ•°æ®ä¸ä¿å­˜æ•°æ®éå¸¸ç›¸ä¼¼ã€‚

```
getFileData(FILE_PATH)().then(either => fold(console.log, console.log)(either)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`saveData`å’Œ`getFileData`ä»£è¡¨ç”±äºå‰¯ä½œç”¨è€Œå¯èƒ½ä¸å®‰å…¨çš„è®¡ç®—ã€‚é€šè¿‡æ´å¼•å®ƒä»¬ï¼Œæˆ‘ä»¬æ­£åœ¨æ‹”æ‰æ‰‹æ¦´å¼¹çš„å¼•çº¿ï¼Œå¸Œæœ›å‡ºç°æœ€å¥½çš„ç»“æœã€‚

ä½†æ˜¯ï¼Œå¦‚æœå‘ç”Ÿäº†ä»»ä½•æŸåï¼Œæˆ‘ä»¬éå¸¸ç¡®å®šè¦å»å“ªé‡Œå¯»æ‰¾ç½ªçŠ¯ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨è¿™äº›å°çš„å¯ç»„åˆå‡½æ•°ä¸­åŒ…å«äº†æ‚è´¨ã€‚

## [](#summary)æ€»ç»“

æ‰€ä»¥ä½ æœ‰å®ƒã€‚

å‡½æ•°å¼ç¼–ç¨‹çš„ä¸–ç•Œéå¸¸å¹¿é˜”ï¼Œè™½ç„¶æˆ‘åœ¨è¿™æ–¹é¢åªæ˜¯ä¸ªåˆå­¦è€…ï¼Œä½†æˆ‘å·²ç»èƒ½å¤Ÿåœ¨æˆ‘çš„ä»£ç åº“ä¸­å¼•å…¥ä¸€ç‚¹å‡½æ•°å¼é­”æ³•äº†ã€‚

æˆ‘å¸Œæœ›æœ‰äº›äººä¼šè§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ã€‚

å¯ä»¥åœ¨ twitter å…³æ³¨æˆ‘: [@wm_matuszewski](https://twitter.com/wm_matuszewski)

è°¢è°¢ğŸ‘‹

## [](#additional-resources)é™„åŠ èµ„æº

*   æœ‰ä¸€ä¸ª[å¾ˆæ£’çš„ç³»åˆ—](https://dev.to/gcanti/getting-started-with-fp-ts-setoid-39f3)æ¶µç›–äº† fp-tsï¼Œæ¯”æˆ‘æ‰€èƒ½åšåˆ°çš„è¦è¯¦ç»†å¾—å¤šã€‚è¯»ä¸€ä¸‹å§ï¼

*   Kyle Simpson åœ¨ FrontendMasters ä¸Šæœ‰ä¸€ä¸ª[å¤§ç³»åˆ—](https://frontendmasters.com/courses/functional-javascript-v3/)

*   [è¿™ä¸ª git å›è´­](https://github.com/MostlyAdequate/mostly-adequate-guide)

## [](#footnotes)è„šæ³¨

*æœ‰äººå¯èƒ½ä¼šè¯´ï¼ŒçŸ¥é“å‡½æ•°å¼ç¼–ç¨‹ä¸æ•°å­¦çš„å…³ç³»æ˜¯æ²¡æœ‰ç”¨çš„ã€‚æˆ‘ä¹Ÿæœ‰åŒæ ·çš„è§‚ç‚¹ï¼Œä½†æ˜¯åœ¨å­¦ä¹ äº†è¶³å¤Ÿå¤šçš„ç®¡ç†è¿™äº›ç»“æ„çš„å®šç†å’Œæ•°å­¦è§„åˆ™åï¼Œæˆ‘å‘ç°å­¦ä¹ æ–°æ¦‚å¿µè¦å®¹æ˜“å¾—å¤šï¼Œå› ä¸ºå®ƒä»¬éƒ½é€šè¿‡æ•°å­¦è”ç³»åœ¨ä¸€èµ·ã€‚*