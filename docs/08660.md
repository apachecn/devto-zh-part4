# åŸºäºåœºæ™¯å’Œç‰©ç†çš„æ¸²æŸ“

> åŸæ–‡:[https://dev . to/chicio/scene kit-and-physical-based-rendering-1 i98](https://dev.to/chicio/scenekit-and-physically-based-rendering-1i98)

*è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ SceneKit åŠå…¶åŸºäºç‰©ç†çš„
æ¸²æŸ“ç‰¹æ€§æ¥æ„å»ºä¸€ä¸ªåœºæ™¯ã€‚*

SceneKit æ˜¯æˆ‘æœ€å–œæ¬¢çš„ iOS SDK å†…éƒ¨æ¡†æ¶ä¹‹ä¸€ã€‚ä»€ä¹ˆæ˜¯ SceneKitï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹æ¥è‡ª
å¼€å‘è€…è‹¹æœç½‘ç«™çš„å®šä¹‰:

> SceneKit å°†é«˜æ€§èƒ½æ¸²æŸ“å¼•æ“ä¸æè¿°æ€§ API ç›¸ç»“åˆï¼Œç”¨äºå¯¼å…¥ã€æ“çºµå’Œæ¸²æŸ“ 3D èµ„æºã€‚ä¸ Metal å’Œ OpenGL ç­‰è¦æ±‚æ‚¨ç²¾ç¡®å®ç°æ˜¾ç¤ºåœºæ™¯çš„æ¸²æŸ“ç®—æ³•çš„ä½çº§ API ä¸åŒï¼ŒSceneKit åªéœ€è¦æè¿°åœºæ™¯çš„å†…å®¹ä»¥åŠæ‚¨å¸Œæœ›å®ƒæ‰§è¡Œçš„åŠ¨ä½œæˆ–åŠ¨ç”»ã€‚

æ­£å¦‚ä½ ä»å®šä¹‰ä¸­çœ‹åˆ°çš„ï¼Œé‡Œé¢æœ‰å¾ˆå¤šä¸œè¥¿ã€‚åŸºæœ¬ä¸Šï¼Œé€šè¿‡ä½¿ç”¨ SceneKitï¼Œä½ å°†èƒ½å¤Ÿåˆ›å»ºæ¸¸æˆå’Œå…¶ä»– 3D åº”ç”¨ç¨‹åºï¼Œè€Œä¸éœ€è¦äº†è§£ä»»ä½•è®¡ç®—æœºå›¾å½¢ç®—æ³•ï¼Œç‰©ç†æ¨¡æ‹Ÿç­‰ç­‰ã€‚ä½ åŸºæœ¬ä¸Šæ˜¯ç”¨ç‰©ä½“å’Œç‰¹å¾æ¥æè¿°ä¸€ä¸ªåœºæ™¯ï¼Œè‹¹æœä¼šä¸ºä½ åšå¥½ä¸€åˆ‡ğŸ˜ã€‚

å…³äº SceneKit åœ¨è®¡ç®—æœºå›¾å½¢å­¦æ–¹é¢æœ€æœ‰è¶£çš„äº‹æƒ…ä¹‹ä¸€å·²ç»åœ¨ 2016 å¹´æ¨å‡º:åŸºäºç‰©ç†çš„æ¸²æŸ“(PBR)ã€‚
ğŸ˜‰).è¿™æ„å‘³ç€ SceneKit å¯ä»¥ä½¿ç”¨è‡ªå·±å…¨æ–°çš„åŸºäºç‰©ç†çš„æ¸²æŸ“å¼•æ“æ¥æ¸²æŸ“åŸºäºç‰©ç†çš„åœºæ™¯ã€‚å€¼å¾—å—ï¼Ÿå½“ç„¶å¯ä»¥ï¼ï¼ğŸ˜Šæ‰€ä»¥ï¼Œæˆ‘ä»¬æ¥è¯•è¯•å§ï¼åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ SceneKit ä¸­çš„ä¸»è¦ PBR åŠŸèƒ½ä»å¤´å¼€å§‹åˆ›å»ºä¸€ä¸ªåœºæ™¯ã€‚åœ¨è¿™ç¯‡æ–‡ç« çš„æœ€åï¼Œä½ å°†èƒ½å¤Ÿæ¸²æŸ“åŒ…å«åœ¨ä¸‹å›¾ä¸­çš„åœºæ™¯ã€‚æ‰€ä»¥
æ˜¯æ—¶å€™å¼€å§‹ç¼–ç äº†ï¼ï¼

[![Physically based scene right](../Images/7b785813278351ee17a0646db122ac5d.png "Physically based scene right")T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--CGDXeBVf--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.fabrizioduroni.it/assets/images/posts/physically-based-rendering-scene-right.jpg)

åœ¨åœºæ™¯æ„å»ºä¸­ä½¿ç”¨çš„ä¸€èˆ¬æ–¹æ³•å¦‚ä¸‹:å¯¹äºæ¯ä¸ªä¸»è¦çš„åœºæ™¯ç±»åˆ«ç»„ä»¶ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç±»æ¥å°è£…ç›¸åº”çš„`SCNNode`çš„åˆ›å»ºã€åŸºæœ¬çš„ SceneKit å•å…ƒå…ƒç´ åŠå…¶è®¾ç½®ï¼Œä»¥è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç‰¹å¾ã€‚

æˆ‘ä»¬è¦åˆ›å»ºçš„ç¬¬ä¸€ä¸ªç±»æ˜¯`Light`ç±»ï¼Œå®ƒå°è£…äº†æˆ‘ä»¬è®¾ç½®ç¯å…‰æ‰€éœ€çš„åŸºæœ¬ç‰¹æ€§:ä½ç½®ã€æ—‹è½¬å’Œé€šç”¨é¢œè‰²ã€‚åœºæ™¯ä¸­çš„å…‰çº¿ä½¿ç”¨`SCNLight`ç±»æ¥è¡¨ç¤ºã€‚

```
class Light {
    let node: SCNNode

    init(lightNode: SCNNode) {
        node = lightNode
    }

    init(lightFeatures: LightFeatures) {
        node = SCNNode()
        createLight()
        set(lightFeatures: lightFeatures)
    }

    func createLight() {
        node.light = SCNLight()
    }

    private func set(lightFeatures: LightFeatures) {
        node.light?.color = lightFeatures.color
        node.position = lightFeatures.position
        node.eulerAngles = lightFeatures.orientation;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…‰çº¿çš„åŸºæœ¬ç‰¹å¾å¿…é¡»åœ¨æ„å»ºæ—¶ä½¿ç”¨ä¸€ä¸ª`LightFeatures`å¯¹è±¡æ¥ä¼ é€’ã€‚

```
class LightFeatures {
    let position: SCNVector3
    let orientation: SCNVector3
    let color: UIColor

    init(position: SCNVector3, orientation: SCNVector3, color: UIColor) {
        self.position = position
        self.orientation = orientation
        self.color = color
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ç°åœ¨å‡†å¤‡åˆ›å»ºæˆ‘ä»¬çš„`PhysicallyBasedLight`ä½œä¸º`Light`ç±»çš„å­ç±»ã€‚æˆ‘ä»¬åŸºäºç‰©ç†çš„ç¯å°†æ˜¯`.directional`ç±»å‹ï¼Œæˆ‘ä»¬å°†å®šåˆ¶å®ƒçš„`intensity`å’Œ`temperature`ã€‚å¼ºåº¦æ˜¯å…‰çš„é€šé‡(åŒæ ·ï¼Œå¦‚æœä½ ä¸çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆï¼Œå»çœ‹çœ‹æˆ‘çš„ç¬¬ä¸€ç¯‡å…³äºç‰©ç†æ¸²æŸ“çš„æ–‡ç« ğŸ˜›)ï¼Œç¬¬äºŒä¸ªæ˜¯ç”¨å¼€å°”æ–‡è¡¨ç¤ºçš„è‰²æ¸©(è®°ä½:6500 K å¯¹åº”çš„æ˜¯çº¯ç™½å¤ªé˜³å…‰)ã€‚æˆ‘ä»¬æ¿€æ´»äº†å…¶ä»–æœ‰è¶£çš„åŠŸèƒ½:é€šè¿‡å°†`castsShadow`è®¾ç½®ä¸º`true`æˆ‘ä»¬æ¿€æ´»äº†ä½¿ç”¨é˜´å½±è´´å›¾æŠ€æœ¯çš„é˜´å½±æ¸²æŸ“ï¼Œé€šè¿‡å°†`orthographicScale`è®¾ç½®ä¸º`10`æˆ‘ä»¬ä»å…‰çº¿ä¸­æ‰©å±•äº†ä¸€ç‚¹åœºæ™¯çš„å¯è§åŒºåŸŸï¼Œå› æ­¤æˆ‘ä»¬æ­£åœ¨æ”¹è¿›é˜´å½±è´´å›¾çš„æ„é€ ã€‚

```
class PhysicallyBasedLight: Light {

    init(lightFeatures: LightFeatures, physicallyBasedLightFeatures: PhysicallyBasedLightFeatures) {
        super.init(lightFeatures: lightFeatures)
        set(physicallyBasedLightFeatures: physicallyBasedLightFeatures)
        activateShadow()
    }

    private func set(physicallyBasedLightFeatures: PhysicallyBasedLightFeatures) {
        node.light?.type = .directional
        node.light?.intensity = physicallyBasedLightFeatures.lumen
        node.light?.temperature = physicallyBasedLightFeatures.temperature
    }

    private func activateShadow() {
        node.light?.castsShadow = true
        node.light?.orthographicScale = 10        
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è‡³äºåŸºæœ¬ç¯å…‰ï¼Œæˆ‘ä»¬ä¹Ÿä¸ºåŸºäºç‰©ç†çš„ç‰¹å¾åˆ›å»ºäº†ä¸€ä¸ªç±»ï¼Œå®ƒå°†å­˜å‚¨é…ç½®ï¼Œå¹¶ä¸”å¿…é¡»åœ¨æ„å»ºæ—¶æ³¨å…¥(æ­£å¦‚ä½ å¯ä»¥ä»å‰é¢çš„ init ç±»ä¸­çœ‹åˆ°çš„)ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º`PhysicallyBasedLightFeatures`ã€‚

```
class PhysicallyBasedLightFeatures {
    let lumen: CGFloat
    let temperature: CGFloat

    init(lumen: CGFloat, temperature: CGFloat) {
        self.lumen = lumen
        self.temperature = temperature
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹äºåŸºäºç‰©ç†çš„æ¸²æŸ“ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¦ä¸€ç§ç…§æ˜è®¾ç½®æ¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚æˆ‘ä»¬éœ€è¦è®¾ç½®`SCNScene`ï¼ŒåŒ…å«åœºæ™¯ä¸­æ‰€æœ‰`SCNNode`å…ƒç´ çš„å¯¹è±¡ï¼Œä»¥åŠ`lightingEnviroment`å’Œ`background`å±æ€§ã€‚è¿™äº›è®© SceneKit æ›´ç²¾ç¡®åœ°è¿‘ä¼¼é—´æ¥ç…§æ˜è®¡ç®—ã€‚ä¸ºäº†è®¾ç½®è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç±»ï¼Œ`PhysicallyBasedLightingEnviroment`ï¼Œå®ƒå°†æ¥æ”¶è¦è®¾ç½®çš„åœºæ™¯ã€‚å°†åœ¨`lightingEnviroment.contents`å±æ€§ä¸Šè®¾ç½®ä¸€ä¸ªç«‹æ–¹ä½“è´´å›¾ï¼Œå¹¶åœ¨`lightingEnviroment.intensity`å±æ€§ä¸Šè®¾ç½®å®ƒçš„å¼ºåº¦ã€‚ä¸ºäº†åŒ¹é…è¿™ä¸ªç¯å…‰è®¾ç½®çš„ç»“æœï¼Œå®ƒå°†ä½¿ç”¨ä¸`lightingEnviroment.contents`å±æ€§ç›¸åŒçš„ç«‹æ–¹ä½“è´´å›¾æ¥è®¾ç½®`background.contents`ã€‚

```
class PhysicallyBasedLightingEnviroment {
    let cubeMap: [String]
    let intensity: CGFloat

    init(cubeMap: [String], intensity: CGFloat) {
        self.cubeMap = cubeMap
        self.intensity = intensity
    }

    func setLightingEnviromentFor(scene: SCNScene) {
        scene.lightingEnvironment.contents = cubeMap
        scene.lightingEnvironment.intensity = intensity
        scene.background.contents = cubeMap
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸‹ä¸€æ­¥:ç›¸æœºã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`Camera`ç±»ï¼Œå®ƒå°†å†æ¬¡åŒ…å«å¯¹å®šä¹‰äº†`SCNCamera`çš„`SCNNode`çš„å¼•ç”¨ã€‚å¯¹äºæ‘„åƒæœºï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è®¾ç½®ä¸€äº›å‡ ä½•å±æ€§ï¼Œå¦‚ä½ç½®ã€æ—‹è½¬å’Œæ¢è½´ç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»¬ä½œä¸ºæ‘„åƒæœºåŠ¨ç”»çš„å‚è€ƒã€‚æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬è®¾ç½®æ ‡å¿—`wantHDR`ä»¥åº”ç”¨[é«˜åŠ¨æ€èŒƒå›´](https://en.wikipedia.org/wiki/High_dynamic_range)åå¤„ç†æ¥è°ƒæ•´åœºæ™¯ç›¸å¯¹äºæ˜¾ç¤ºå™¨çš„æ€»ä½“äº®åº¦ã€‚

```
class Camera {
    let node: SCNNode

    init(cameraNode: SCNNode, wantsHDR: Bool = false) {
        node = cameraNode
        setAdvancedFeatures(wantsHDR: wantsHDR)
    }

    init(position: SCNVector3, rotation: SCNVector4, wantsHDR: Bool = false, pivot: SCNMatrix4? = nil) {
        node = SCNNode()
        createCameraOnNode()
        setAdvancedFeatures(wantsHDR: wantsHDR)
        set(position: position, rotation: rotation, pivot: pivot)
    }

    private func createCameraOnNode() {
        node.camera = SCNCamera()
    }

    private func setAdvancedFeatures(wantsHDR: Bool) {
        node.camera?.automaticallyAdjustsZRange = true
        node.camera?.wantsHDR = wantsHDR
    }

    private func set(position aPosition: SCNVector3, rotation aRotation: SCNVector4, pivot aPivot: SCNMatrix4?) {
        node.position = aPosition
        node.rotation = aRotation
        node.pivot = aPivot ?? node.pivot
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æ˜¯æ—¶å€™è€ƒè™‘æˆ‘ä»¬æƒ³è¦åœ¨åœºæ™¯ä¸­æ˜¾ç¤ºçš„å¯¹è±¡äº†ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`Object`ç±»æ¥è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦åœ¨åœºæ™¯ä¸­æ˜¾ç¤ºçš„æ¯ä¸€ç§å¯¹è±¡ã€‚æ˜¾ç„¶ï¼Œå¯¹äºå‰é¢çš„ç±»æ¥è¯´ï¼Œ`Object`ç±»ä¹Ÿå°†æš´éœ²ä¸€ä¸ªç±»å‹ä¸º`SCNNode`çš„`node`å±æ€§ï¼Œå®ƒä»£è¡¨æˆ‘ä»¬åœ¨åœºæ™¯ä¸­çš„å¯¹è±¡ã€‚æˆ‘ä»¬ç”¨å¤šä¸ªåˆå§‹åŒ–å™¨æ¥å®šä¹‰è¿™ä¸ªç±»ï¼Œè¿™äº›åˆå§‹åŒ–å™¨ä½¿ç”¨å„ç§é…ç½®æ¥åˆ›å»ºå¯¹è±¡å®ä¾‹:init ä½œä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œinit ä½¿ç”¨ä¸€ä¸ª`SCNGeometry`å®ä¾‹ï¼Œä½¿ç”¨ä¸€ä¸ªç½‘æ ¼åŠ è½½ä½œä¸ºä¸€ä¸ª`MDLObject`ä½¿ç”¨[æ¨¡å‹ I\O](https://developer.apple.com/documentation/modelio) è‹¹æœæ¡†æ¶ã€‚è¿™ä¸ªæ¡†æ¶å…è®¸æˆ‘ä»¬ä»¥å„ç§å¸¸è§çš„å¯ç”¨æ ¼å¼å¯¼å…¥/å¯¼å‡º 3D æ¨¡å‹ã€‚

```
class Object {
    let node: SCNNode

    init(position: SCNVector3, rotation: SCNVector4) {
        node = SCNNode()
        node.castsShadow = true
        set(position: position, rotation: rotation)
    }

    init(geometry: SCNGeometry, position: SCNVector3, rotation: SCNVector4) {
        node = SCNNode(geometry: geometry)
        node.castsShadow = true
        set(position: position, rotation: rotation)
    }

    init(mesh: MDLObject, position: SCNVector3, rotation: SCNVector4) {
        node = SCNNode(mdlObject: mesh)
        node.castsShadow = true
        set(position: position, rotation: rotation)
    }

    private func set(position: SCNVector3, rotation: SCNVector4) {
        node.position = position
        node.rotation = rotation
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬å‡†å¤‡å®šä¹‰ä¸€ä¸ª`PhysicallyBasedObject`ç±»ï¼Œå®ƒå°†ç»§æ‰¿`Object`ç±»çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶å°†è®¾ç½®ä½¿ç”¨åŸºäºç‰©ç†çš„æ¸²æŸ“æ¥æ¸²æŸ“å¯¹è±¡æ‰€éœ€çš„æ‰€æœ‰ç‰¹æ€§ã€‚å³ä½¿æ‰€æœ‰çš„åˆå§‹åŒ–å™¨å¯¹è¿™ä¸ªå­ç±»éƒ½æ˜¯å¯ç”¨çš„ï¼Œæˆ‘ä»¬åœ¨æ„é€ æ—¶ä¹Ÿéœ€è¦ä¸€ä¸ªç½‘æ ¼ä½œä¸º`MDLObject`ï¼Œå› ä¸ºæˆ‘ä»¬å°†æ˜¾ç¤ºä¸€äº›ç‰¹å®šçš„ç½‘æ ¼å¯¹è±¡(æˆ‘ä»¬å°†åœ¨åé¢è®¨è®ºå®ƒä»¬)ã€‚åœ¨å»ºé€ æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½ç½®å’Œæ—‹è½¬ä»¥åŠ`PhysicallyBasedMaterial`ææ–™ã€‚é€šè¿‡å°†å®ƒåˆ†é…ç»™æˆ‘ä»¬èŠ‚ç‚¹çš„`geometry`çš„`firstMaterial`å±æ€§ï¼Œæˆ‘ä»¬çš„å¯¹è±¡å°†ä½¿ç”¨åŸºäºç‰©ç†çš„ SceneKit æ¸²æŸ“å¼•æ“è¢«æ¸²æŸ“ä¸ºåŸºäºç‰©ç†çš„å¯¹è±¡ã€‚æ³¨æ„:æˆ‘ä»¬å°†ä½¿ç”¨çš„ç½‘æ ¼ä¸åŒ…å«ä»»ä½•ææ–™ï¼Œå› æ­¤é€šè¿‡åˆ†é…`firstMaterial`å±æ€§ï¼Œç½‘æ ¼å°†å¯¹æ•´ä¸ªè¡¨é¢ä½¿ç”¨å®ƒã€‚

```
class PhysicallyBasedObject: Object {

    init(mesh: MDLObject, material: PhysicallyBasedMaterial, position: SCNVector3, rotation: SCNVector4) {
        super.init(mesh: mesh, position: position, rotation: rotation)
        node.geometry?.firstMaterial = material.material
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥ï¼Œä¸‹ä¸€ä¸ªé—®é¢˜æ˜¯:æˆ‘ä»¬å¦‚ä½•å®šä¹‰`PhysicallyBasedMaterial`ç±»ï¼Ÿæˆ‘ä»¬ç”¨ç±»å‹ä¸º`SCNMaterial`çš„å•ä¸ªå±æ€§`material`åˆ›å»º`PhysicallyBasedMaterial`ã€‚åœ¨æ­¤ææ–™å±æ€§ä¸Šï¼Œæˆ‘ä»¬è®¾ç½®:

*   `lightingModel`åˆ°`.physicallyBased`ï¼Œä¸º SceneKit æ ‡è®°ä¸ºåŸºäºç‰©ç†çš„æè´¨
*   `diffuse.contents`å…·æœ‰é€‚å½“æ¼«å°„å€¼çš„å±æ€§ã€‚
*   `roughness.contents`å…·æœ‰é€‚å½“ç²—ç³™åº¦å€¼çš„å±æ€§ã€‚
*   `metalness.contents`å…·æœ‰é€‚å½“é‡‘å±åº¦å€¼çš„å±æ€§ã€‚
*   `normal.contents`å…·æœ‰é€‚å½“æ­£å¸¸å€¼çš„å±æ€§ã€‚
*   `ambientOcclusion.contents`å…·æœ‰é€‚å½“ç¯å¢ƒé®æŒ¡å€¼çš„å±æ€§

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬æ‹¥æœ‰äº†æˆ‘åœ¨[åŸºäºç‰©ç†æ¸²æŸ“çš„ä»‹ç»](https://www.fabrizioduroni.it/2017/12/07/physically-base-rendering-introduction.html)ä¸­è®¨è®ºè¿‡çš„æ‰€æœ‰å±æ€§ã€‚æˆ‘ä»¬ä¹Ÿæœ‰å…¶ä»–çš„å±æ€§æ¥å¸®åŠ©æˆ‘ä»¬æé«˜çœŸå®æ„Ÿï¼Œç‰¹åˆ«æ˜¯é—´æ¥ç…§æ˜å¯¹äº[ç¯å¢ƒé®æŒ¡](https://en.wikipedia.org/wiki/Ambient_occlusion)(è¿™ä¸ªå±æ€§/æŠ€æœ¯ä¸ PBR æ— å…³ï¼Œä½†æ˜¯æœ‰åŠ©äºæé«˜æœ€ç»ˆçš„æ¸²æŸ“)ã€‚å“ªç§ä»·å€¼è§‚æ¥å—è¿™ç§å±æ€§ï¼Ÿå¦‚ Apple æ–‡æ¡£ä¸­æ‰€è¿°ï¼Œæ‚¨å¯ä»¥ä¸º`contents`å±æ€§èµ‹å€¼:

*   ä¸€ç§é¢œè‰²(`NSColor` / `UIColor` / `CGColor`)
*   ä¸€ä¸ªæ•°å­—(`NSNumber`)
*   ä¸€ä¸ªå›¾åƒ(`NSImage` / `UIImage` / `CGImage`)
*   ä¸€æ ¹ç»³å­
*   ç­”`CALayer`
*   ä¸€ä¸ªçº¹ç†(`SKTexture` / `MDLTexture` / `MTLTexture` / `GLKTextureInfo`)
*   ç­”`SKScene`
*   ä¸€ä¸ªç”±å…­ä¸ªå›¾åƒç»„æˆçš„æ•°ç»„ï¼Œä»£è¡¨ä¸€ä¸ªç«‹æ–¹ä½“è´´å›¾(å°±åƒæˆ‘ä»¬å¯¹`lightingEnviroment.contents property`æ‰€åšçš„é‚£æ ·)ã€‚

```
class PhysicallyBasedMaterial {
    let material: SCNMaterial

    init(diffuse: Any, roughness: Any, metalness: Any, normal: Any, ambientOcclusion: Any? = nil) {
        material = SCNMaterial()
        material.lightingModel = .physicallyBased
        material.diffuse.contents = diffuse
        material.roughness.contents = roughness
        material.metalness.contents = metalness
        material.normal.contents = normal
        material.ambientOcclusion.contents = ambientOcclusion
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æ˜¯æ—¶å€™æ„å»ºæˆ‘ä»¬çš„åœºæ™¯äº†ğŸ˜Œï¼ï¼æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»`PhysicallyBasedScene`ï¼Œå®ƒæ˜¯`SCNScene`çš„å­ç±»ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶é»˜è®¤çš„åˆå§‹åŒ–ç¨‹åºï¼Œæ·»åŠ æˆ‘ä»¬åœºæ™¯çš„æ‰€æœ‰å…ƒç´ ï¼Œä¹Ÿå› ä¸ºé€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—®`SCNScene`çš„æ‰€æœ‰å±æ€§ã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ªåè®®`Scene`ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥ç®¡ç†ä¸€äº›æ‰‹åŠ¿å’ŒåŠ¨ç”»åœºæ™¯ã€‚æ‰€ä»¥åœ¨åˆå§‹åŒ–å™¨ä¸­ï¼Œæˆ‘ä»¬å°†è°ƒç”¨ä¸‰ä¸ªæ–¹æ³•:`createCamera()`ï¼Œæˆ‘ä»¬å°†åˆ›å»ºç›¸æœºï¼Œ`createLight()`ï¼Œæˆ‘ä»¬å°†åˆ›å»ºç¯å…‰ï¼Œ`createObjects()`ï¼Œæˆ‘ä»¬å°†åˆ›å»ºå¯¹è±¡ã€‚æ³¨æ„:æˆ‘ä»¬è¿˜éœ€è¦ç”¨ç¼–ç å™¨å®šä¹‰åˆå§‹åŒ–å™¨ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨å­ç±»åŒ–ä¸€ä¸ªé‡‡ç”¨`NSSecureCoding`çš„ç±»ï¼Œå®ƒæ˜¯`NSCoding`åè®®çš„æ‰©å±•ï¼Œæœ‰è¿™ä¸ªéœ€è¦çš„åˆå§‹åŒ–å™¨ã€‚

```
@objc class PhysicallyBasedScene: SCNScene, Scene {
    var camera: Camera!

    override init() {
        super.init()
        createCamera()
        createLight()
        createObjects()
    }

    required init?(coder aDecoder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }

    ...
    ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥æˆ‘ä»¬ä»åˆ¶é€ ç›¸æœºå¼€å§‹ã€‚æˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨åœºæ™¯çš„å‰é¢ï¼Œæ¢è½´ç§»åŠ¨äº†ä¸€ç‚¹ï¼ŒHDR åæœŸå¤„ç†è¢«æ¿€æ´»ã€‚

```
private func createCamera() {
    camera = Camera(
        position: SCNVector3Make(0, 2, 0),
        rotation: SCNVector4Make(1, 0, 0, GLKMathDegreesToRadians(-5)),
        wantsHDR: true,
        pivot: SCNMatrix4MakeTranslation(0, 0, -8)
    )
    rootNode.addChildNode(camera.node)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åæˆ‘ä»¬åˆ›é€ æˆ‘ä»¬çš„å…‰ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåŸºäºç‰©ç†çš„å…‰æºï¼ŒåŠŸç‡ä¸º 100 æµæ˜ï¼Œè‰²æ¸©ä¸º 4000Kã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åŒ¹é…åœºæ™¯ä¸­è®¾ç½®çš„ç…§æ˜ç¯å¢ƒæ‰€ä½¿ç”¨çš„ç«‹æ–¹ä½“è´´å›¾çš„æš–æ©™è‰²ã€‚

```
private func createLight() {
    rootNode.addChildNode(createPhysicallyBasedLight().node)
    createPhysicallyLightingEnviroment()
}

private func createPhysicallyBasedLight() -> PhysicallyBasedLight {
    let lightFeatures = LightFeatures(
        position: SCNVector3Make(-2, 5, 4),
        orientation: SCNVector3Make(GLKMathDegreesToRadians(-45), GLKMathDegreesToRadians(-25), 0),
        color: UIColor.white
    )
    let physicallyBasedLightFeatures = PhysicallyBasedLightFeatures(lumen: 100, temperature: 4000)
    let physicallyBasedLight = PhysicallyBasedLight(
        lightFeatures: lightFeatures,
        physicallyBasedLightFeatures: physicallyBasedLightFeatures
    )
    return physicallyBasedLight
}

private func createPhysicallyLightingEnviroment() {
    let enviroment = PhysicallyBasedLightingEnviroment(
        cubeMap: ["rightPBR.png", "leftPBR.png", "upPBR.png", "downPBR.png", "backPBR.png", "frontPBR.png"],
        intensity: 1.0
    )
    enviroment.setLightingEnviromentFor(scene: self)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥æ”¾ç½®æˆ‘ä»¬çš„ 4 ä¸ªç‰©ä½“:ä¸€ä¸ªåŸºæœ¬çš„å¹³é¢ç½‘æ ¼å’Œ 3 ä¸ªæ¥è‡ªæ–¯å¦ç¦æ‰«æåº“çš„ç½‘æ ¼ã€‚
è¿™äº›ç½‘æ ¼æ˜¯:é¾™ï¼Œå¿«ä¹çš„ä½›å’Œéœ²è¥¿ã€‚æ‰€æœ‰è¿™äº›ç½‘æ ¼å°†ä½¿ç”¨`PhysicallyBasedObject`æ¸²æŸ“ã€‚
æˆ‘ä»¬ä» [freepbr](https://freepbr.com) ç½‘ç«™ä¸Šè·å–ç”¨äºåˆ¶ä½œå„ç§æè´¨æ¨¡å‹çš„çº¹ç†ã€‚

```
private func createObjects() {
    addFloor()
    addDragon()
    addBuddha()
    addLucy()
}

private func addFloor() {
    let floor = PhysicallyBasedObject(
        mesh: MeshLoader.loadMeshWith(name: "Floor", ofType: "obj"),
        material: PhysicallyBasedMaterial(
            diffuse: "floor-diffuse.png",
            roughness: NSNumber(value: 0.8),
            metalness: "floor-metalness.png",
            normal: "floor-normal.png",
            ambientOcclusion: "floor-ambient-occlusion.png"
        ),
        position: SCNVector3Make(0, 0, 0),
        rotation: SCNVector4Make(0, 0, 0, 0)
    )
    rootNode.addChildNode(floor.node)
}

private func addDragon() {
    let dragon = PhysicallyBasedObject(
        mesh: MeshLoader.loadMeshWith(name: "Dragon", ofType: "obj"),
        material: PhysicallyBasedMaterial(
            diffuse: "rustediron-diffuse.png",
            roughness: NSNumber(value: 0.3),
            metalness: "rustediron-metalness.png",
            normal: "rustediron-normal.png"
        ),
        position: SCNVector3Make(-2, 0, 3),
        rotation: SCNVector4Make(0, 1, 0, GLKMathDegreesToRadians(20))
    )
    rootNode.addChildNode(dragon.node)
}

private func addBuddha() {
    let buddha = PhysicallyBasedObject(
        mesh: MeshLoader.loadMeshWith(name: "HappyBuddha", ofType: "obj"),
        material: PhysicallyBasedMaterial(
            diffuse: "cement-diffuse.png",
            roughness: NSNumber(value: 0.8),
            metalness: "cement-metalness.png",
            normal: "cement-normal.png",
            ambientOcclusion: "cement-ambient-occlusion.png"
        ),
        position: SCNVector3Make(-0.5, 0, 0),
        rotation: SCNVector4Make(0, 0, 0, 0)
    )
    rootNode.addChildNode(buddha.node)
}

private func addLucy() {
    let lucy = PhysicallyBasedObject(
        mesh: MeshLoader.loadMeshWith(name: "Lucy", ofType: "obj"),
        material: PhysicallyBasedMaterial(
            diffuse: "copper-diffuse.png",
            roughness: NSNumber(value: 0.0),
            metalness: "copper-metalness.png",
            normal: "copper-normal.png"
        ),
        position: SCNVector3Make(2, 0, 2),
        rotation: SCNVector4Make(0, 0, 0, 0)
    )
    rootNode.addChildNode(lucy.node)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç½‘æ ¼è¢«å­˜å‚¨ä¸º[æ³¢å‰ obj æ–‡ä»¶](https://en.wikipedia.org/wiki/Wavefront_.obj_file)(æœ‰å²ä»¥æ¥æœ€ç®€å•çš„æ–‡ä»¶æ ¼å¼ğŸ˜Œ).ä»å‰é¢çš„ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªåä¸º`MeshLoader`çš„ç±»ã€‚å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿå®ƒä½¿ç”¨[æ¨¡å‹ I/O](https://developer.apple.com/documentation/modelio) è‹¹æœæ¡†æ¶åŠ è½½ obj æ–‡ä»¶ä½œä¸º`MDLAsset`ï¼Œç„¶åæˆ‘ä»¬æå–ç¬¬ä¸€ä¸ª`MDLObject`ã€‚

```
class MeshLoader {

    static func loadMeshWith(name: String, ofType type: String) -> MDLObject {
        let path = Bundle.main.path(forResource: name, ofType: type)!
        let asset = MDLAsset(url: URL(fileURLWithPath: path))
        return asset[0]!
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å‡ ä¹å‡†å¤‡å¥½æ¸²æŸ“æˆ‘ä»¬çš„åœºæ™¯ã€‚æœ€åè¦åšçš„æ˜¯å®ç°`Scene`åè®®çš„æ–¹æ³•æ¥ç»™åœºæ™¯æ·»åŠ ä¸€äº›è¿åŠ¨ã€‚è¿™ä¸ªæ–¹æ³•å°†è¢«ä¸€ä¸ªé™„åŠ åˆ°ä¸»è§†å›¾çš„ç‚¹å‡»æ‰‹åŠ¿è°ƒç”¨ï¼Œè¿™ä¸ªä¸»è§†å›¾å°†æ¸²æŸ“æˆ‘ä»¬çš„åœºæ™¯(æˆ‘ä»¬ä¸€ä¼šå„¿å°±ä¼šçœ‹åˆ°å®ƒ)ã€‚åœ¨å®ƒé‡Œé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨æ–¹æ³•`runAction`æ¥å›´ç»•å®ƒçš„æ¢è½´æ—‹è½¬ç›¸æœºï¼Œæˆ‘ä»¬ä¹‹å‰ç§»åŠ¨è¿‡å®ƒæ¥æ‹¥æœ‰ä¸€ä¸ªæ—‹è½¬è½´æ¥å›´ç»•åœºæ™¯ç§»åŠ¨ç›¸æœºã€‚

```
func actionForOnefingerGesture(withLocation location: CGPoint, andHitResult hitResult: [Any]!) {
    self.camera.node.runAction(SCNAction.rotate(by: CGFloat(GLKMathDegreesToRadians(360)),
                                                around: SCNVector3Make(0, 1, 0),
                                                duration: 30))
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å‡†å¤‡æ¸²æŸ“æˆ‘ä»¬çš„åœºæ™¯ã€‚å°†æˆ‘ä»¬çš„`PhysicallyBasedScene`çš„ä¸€ä¸ªå®ä¾‹åˆ†é…ç»™ä¸€ä¸ª`SCNView`ï¼Œçœ‹çœ‹æˆ‘ä»¬å·¥ä½œçš„æ¼‚äº®ç»“æœã€‚ä¸‹é¢ä½ å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬åˆ›å»ºçš„åœºæ™¯çš„è§†é¢‘ã€‚

[https://www.youtube.com/embed/yDMdAtv-3Bg](https://www.youtube.com/embed/yDMdAtv-3Bg)

å°±æ˜¯è¿™æ ·ï¼ï¼ä½ æˆåŠŸäº†ï¼ï¼ç°åœ¨ï¼Œä½ å¯ä»¥å‘ä½ çš„æœ‹å‹å±•ç¤ºä½ åŸºäºç‰©ç†çš„åœºæ™¯ï¼Œå¹¶ä¸ºæ­¤æ„Ÿåˆ°è‡ªè±ªğŸ˜ã€‚ä½ å¯ä»¥åœ¨ github åº“çš„[ä¸­æ‰¾åˆ°è¿™ä¸ªä¾‹å­å’Œå…¶ä»–åœºæ™¯ã€‚](https://github.com/chicio/Exploring-SceneKit)

*åŸè½½äº[https://www . fabrizioduroni . it](https://www.fabrizioduroni.it/2018/01/03/scene-kit-physically-based-rendering.html)2018 å¹´ 1 æœˆ 3 æ—¥ã€‚*