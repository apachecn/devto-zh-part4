# OpenJDK 13 ä¸­çš„ Java å’Œæœ¬æœºä»£ç 

> åŸæ–‡:[https://dev . to/petarov/Java-and-native-code-in-open JDK-13-18em](https://dev.to/petarov/java-and-native-code-in-openjdk-13-18em)

# [](#contents)ç›®å½•

*   [ç®€ä»‹](#intro)
*   [åŠ¨æ‰‹](#hands-on)
    *   [libCurl åº”ç”¨](#libcurl)
    *   [libssh 2 åº”ç”¨](#libssh)
*   [æœ€ç»ˆæƒ³æ³•](#outro)
*   [å‚è€ƒæ–‡çŒ®](#refs)

# [](#intro)ç®€ä»‹

ä¸Šå‘¨ï¼Œæˆ‘è§‚çœ‹äº†ä¸€åœºéå¸¸é…·çš„ GOTO ä¼šè®®ï¼Œä¸ç”²éª¨æ–‡è½¯ä»¶å·¥ç¨‹æ€»ç›‘ Mikael Vidstedt è¿›è¡Œäº†äº¤è°ˆï¼Œä»–åœ¨ä¼šä¸Šä»‹ç»äº†è®¸å¤šå³å°†æ¨å‡ºå’Œæ­£åœ¨å¼€å‘çš„ Java ç‰¹æ€§ã€‚å…¶ä¸­ä¸€ä¸ªé¡¹ç›®ï¼ŒT2 é¡¹ç›®ï¼Œå¼•èµ·äº†æˆ‘çš„ç‰¹åˆ«å…´è¶£ã€‚

> ![GOTO Conferences profile image](../Images/d95c9b8d37b1f01053531bf2728b0441.png)GOTO Conferences@ GOTO con![twitter logo](../Images/65e26e35707d96169ec8af6b3cbf2003.png)[# Java](https://twitter.com/hashtag/Java)å»å¹´çš„å˜åŒ–æ¯”å‰äº”å¹´éƒ½å¤§ã€‚
> 
> åœ¨æœ¬æ¬¡ [#GOTOchgo](https://twitter.com/hashtag/GOTOchgo) è®¿è°ˆä¸­äº†è§£è¿™äº›å˜åŒ–ä»¥åŠ Java çš„æœªæ¥ï¼Œä¸ [@gsaab](https://twitter.com/gsaab) å’Œ[@ MikaelVidstedt](https://twitter.com/MikaelVidstedt)
> 
> [youtu.be/vJrHHe3IbQs?liâ€¦](https://t.co/QcX8MnEQZL)2019 å¹´ 6 æœˆ 12:30[![Twitter reply action](../Images/269095962147c28351274afdd5486a48.png)](https://twitter.com/intent/tweet?in_reply_to=1136248991254028289)[![Twitter retweet action](../Images/771160ecf06ae3d4d7a7815c29c819c2.png)T35ã€‘4](https://twitter.com/intent/retweet?tweet_id=1136248991254028289)[![Twitter like action](../Images/c077611ab2a5e0b4cd0c826ee7ae1e48.png)](https://twitter.com/intent/like?tweet_id=1136248991254028289)

*å…è´£å£°æ˜:å·´æ‹¿é©¬è®¡åˆ’ä»å¤„äºæ—©æœŸå¼€å‘é˜¶æ®µï¼Œå› æ­¤æœ¬æ–‡å†…å®¹å¯èƒ½æ— æ³•åæ˜ å…¶å½“å‰çŠ¶æ€ã€‚*

Project Panama åœ¨æ—©æœŸçš„ JDK 13 ç‰ˆæœ¬ä¸­å¯ç”¨ï¼Œæ˜¯ Java å’Œæœ¬åœ°ä»£ç ä¹‹é—´çš„æ¡¥æ¢ã€‚è¿™æœ‰ä»€ä¹ˆç”¨ï¼Ÿåœ¨æŸäº›ç”¨ä¾‹ä¸­ï¼Œä¸€éƒ¨åˆ†åŠŸèƒ½å¯ä»¥ä½œä¸ºç”¨ C æˆ– C++ç¼–å†™çš„åº“æ¥ä½¿ç”¨ï¼Œè€Œéœ€æ±‚æ˜¯å°†å®ƒé›†æˆåˆ° Java åº”ç”¨ç¨‹åºä¸­ã€‚å½“å‰çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ Java æœ¬åœ°æ¥å£(JNI)[ã€2ã€‘](#refs)ï¼Œè¿™å¯èƒ½éœ€è¦å¤§é‡çš„å·¥ä½œï¼Œå¹¶ä¸”ä¹Ÿå¾ˆå®¹æ˜“å‡ºé”™ã€‚æ‚¨éœ€è¦å¾ˆå¥½åœ°æŒæ¡åŸç”Ÿåº“çš„å†…éƒ¨ï¼Œç„¶åç¼–å†™æ‰€æœ‰éœ€è¦çš„å®ç°ï¼Œå°† Java æ¥å£ä¸åŸç”Ÿä»£ç è¿æ¥èµ·æ¥ã€‚æ ¹æ®æˆ‘çš„ç»éªŒï¼Œè°ƒç”¨å¯èƒ½åœ¨ä»¥åæŸä¸ªæ—¶é—´ç‚¹å‘ç”Ÿå˜åŒ–çš„æœ¬æœºåº“å‡½æ•°ä»¥åŠç®¡ç†å †å†…å­˜åˆ†é…å¯¹äº JNI æ¥è¯´å¯èƒ½æ˜¯ä¸€ä¸ªçœŸæ­£çš„æŒ‘æˆ˜ã€‚å¼•ç”¨ Mikael åœ¨è§†é¢‘ä¸­è¯´çš„è¯:

> è¿™é‡Œæœ‰å¤šå°‘äººå†™è¿‡ JNI æˆ–è€… JNIï¼Ÿæˆ‘ä»¬ä¸ºä½ æ„Ÿåˆ°éš¾è¿‡ï¼

è¿™å°±æ˜¯å·´æ‹¿é©¬å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚å®ƒæä¾›äº†æ–°çš„å·¥å…·å’Œ API æ¥ç®€åŒ– Java å’Œæœ¬æœºä»£ç ä¹‹é—´çš„è¿æ¥ã€‚å®ƒåŸºæœ¬ä¸Šå¯ä»¥å½’ç»“ä¸ºä»¥ä¸‹æ­¥éª¤:

1.  ä½¿ç”¨ **jextract** å·¥å…·ä»ç°æœ‰çš„ C å¤´æ–‡ä»¶ç”Ÿæˆ Java ç»‘å®š(æ¥å£)ã€‚
2.  ä½¿ç”¨ **java.foreign** API é€šè¿‡ jextracted Java æ¥å£è°ƒç”¨ C å‡½æ•°ã€‚

è¿™ä½¿æ‚¨èƒ½å¤Ÿä¸“æ³¨äºç¼–å†™åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒé€»è¾‘ï¼Œè€Œä¸æ˜¯æ‘†å¼„ç²˜åˆä»£ç å’Œé›†æˆç»†èŠ‚ã€‚

# [](#handson)äº‹å¿…èº¬äº²

å·´æ‹¿é©¬è®¡åˆ’çš„æ–‡æ¡£é¡µé¢å·²ç»æä¾›äº†å¤§é‡çš„ä¾‹å­ã€‚æˆ‘å°†å¿«é€Ÿæµè§ˆä¸€ä¸‹å¦‚ä½•æ¡¥æ¥å’Œè¿è¡Œä¸€ä¸ª *libCurl* Java åº”ç”¨ç¨‹åºï¼Œç„¶åæˆ‘å°†å±•ç¤ºä¸€ä¸ªæ›´è¯¦ç»†çš„ä¾‹å­â€”â€”ä¸€ä¸ªæˆ‘åŸºäº *libSSH2* ç¼–å†™çš„ç®€å• SSH å®¢æˆ·ç«¯ã€‚

æˆ‘åœ¨ macOS ä¸Šè¿è¡Œè¿™äº›ä¾‹å­ï¼Œä½†æ˜¯ç»è¿‡ä¸€äº›è°ƒæ•´ï¼Œæ‚¨ä¹Ÿåº”è¯¥èƒ½å¤Ÿåœ¨ Linux å®‰è£…ä¸Šè¿è¡Œå®ƒä»¬ã€‚

## [](#the-libcurl-app)The libCurl App

å¦‚ä½•ä½¿ç”¨åŸç”Ÿ Curl åº“çš„å®ç°ä¸‹è½½ç½‘é¡µï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è·å–å¹¶è§£å‹ç¼© Panama [OpenJDK build](http://jdk.java.net/panama/) æ¡£æ¡ˆã€‚

è®©æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª shellï¼Œå°†`JAVA_HOME`ç¯å¢ƒå˜é‡è®¾ç½®ä¸º OpenJDK æ„å»ºå½’æ¡£æ–‡ä»¶çš„è§£å‹ä½ç½®ã€‚

```
export JAVA_HOME=/opt/jdk-13.jdk 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦ç”Ÿæˆ Java æ¥å£ï¼Œå°† Java ä»£ç ç»‘å®šåˆ°æœ¬åœ°åº“çš„ç²˜åˆä»£ç ã€‚è¿™å°†äº§ç”Ÿä¸€ä¸ª`curl.jar`æ–‡ä»¶:

```
$JAVA_HOME/bin/jextract -t org.unix -L /usr/lib -lcurl \
  --record-library-path /usr/include/curl/curl.h \
  -o curl.jar 
```

å½“æˆ‘ä»¬æ£€æŸ¥ JAR æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ Curl API è°ƒç”¨ï¼Œä»¥åŠä¾èµ–ç»‘å®šã€‚Curl API å¯ä»¥é€šè¿‡æ–°çš„ **java.foreign** Java API è·å¾—ã€‚

[![curl.jar](../Images/38991fed1acd8a1f448062b36cc8057e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qB9AbWUL--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/5j56upyw7yz643tiwefx.png)

ç°åœ¨ä¸¾ä¸ªç®€å•çš„ä¾‹å­ã€‚è¿™é‡Œæœ‰ä¸€æ®µ Java ä»£ç ï¼Œå®ƒè·å–ä¸€ä¸ªç½‘é¡µå¹¶åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå…¶å†…å®¹ã€‚

```
import java.lang.invoke.*;
import java.foreign.*;
import java.foreign.memory.*;
import org.unix.curl.*;
import org.unix.curl_h;
import static org.unix.curl_h.*;
import static org.unix.easy_h.*;

public class Main {
   public static void main(String[] args) {
       try (Scope s = curl_h.scope().fork()) { 
           curl_global_init(CURL_GLOBAL_DEFAULT);
           Pointer<Void> curl = curl_easy_init();
           if(!curl.isNull()) {
               Pointer<Byte> url = s.allocateCString(args[0]);
               curl_easy_setopt(curl, CURLOPT_URL, url);
               int res = curl_easy_perform(curl);
               if (res != CURLE_OK) {
                 System.err.println("Error fetching from: " + args[0] + " ERR: " + Pointer.toString(curl_easy_strerror(res)));
                 curl_easy_cleanup(curl);
               }
           }
           curl_global_cleanup();
       }
    }
} 
```

è¿™é‡Œéœ€è¦æŒ‡å‡ºå‡ ä»¶äº‹ã€‚æ³¨æ„æˆ‘ä»¬ä¸èƒ½ç›´æ¥å°† Java `String`ä¼ é€’ç»™`curl_easy_setopt()`è°ƒç”¨ã€‚è¿™ä¸ªè°ƒç”¨æ¥å—ä¸€ä¸ªå†…å­˜åœ°å€æŒ‡é’ˆä½œä¸º`url`å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦ä½¿ç”¨`Scope`è¿›è¡ŒåŠ¨æ€å†…å­˜åˆ†é…æ“ä½œï¼Œå¹¶ä¼ é€’ä¸€ä¸ª`Pointer`æ¥å£å®ä¾‹ã€‚æ­£å¦‚ä½ å¯èƒ½åœ¨ Panama tech æ–‡æ¡£[ã€5ã€‘](#refs)ä¸­å‘ç°çš„ï¼Œ`Pointer`æ¥å£åœ¨å¤æ‚çš„ç±»ä¼¼ C è¯­è¨€çš„æŒ‡é’ˆæ“ä½œæ–¹é¢å¾ˆæœ‰å¸®åŠ©ï¼Œæ¯”å¦‚æŒ‡é’ˆç®—æ³•ã€ç±»å‹è½¬æ¢ã€å†…å­˜è§£å¼•ç”¨ç­‰ç­‰ã€‚`Scope`ç®¡ç†åŠ¨æ€åˆ†é…å†…å­˜çš„è¿è¡Œæ—¶ç”Ÿå‘½å‘¨æœŸã€‚

å¥½äº†ï¼Œç°åœ¨æœ‰äº†è¿™äº›çŸ¥è¯†ï¼Œä½ èƒ½æ‰©å±•è¿™ä¸ªä»£ç æŠŠä¸€ä¸ª Curl è·å–çš„ç½‘é¡µçš„å†…å®¹å†™åˆ°ä¸€ä¸ªæ–‡ä»¶æµä¸­å—ï¼Ÿ

## libssh 2 App

ä¸‹é¢æ˜¯ä¸€ä¸ªæ›´å®Œæ•´çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œå®ƒåˆ©ç”¨*lib SSH 2*[ã€4ã€‘](#refs)æ¥å®ç°ä¸€ä¸ªç®€å•çš„ SSH å®¢æˆ·ç«¯ã€‚

## ![GitHub logo](../Images/a73f630113876d78cff79f59c2125b24.png) [ä½©å¡”ç½—å¤«](https://github.com/petarov) / [çˆªå“‡-å·´æ‹¿é©¬-ssh2](https://github.com/petarov/java-panama-ssh2)

### é€šè¿‡å·´æ‹¿é©¬é¡¹ç›®ä½¿ç”¨ libssh2 çš„ Java SSH å®¢æˆ·ç«¯

<article class="markdown-body entry-content container-lg" itemprop="text">

# çˆªå“‡-å·´æ‹¿é©¬-ssh2

ä¸€ä¸ªç®€å•çš„ Java SSH2 å®¢æˆ·ç«¯ï¼Œä½¿ç”¨æœ¬åœ°åº“å’Œ JDK 13 é¡¹ç›®

æ³¨æ„:è¿™æ˜¯ä¸€ä¸ªå®éªŒé¡¹ç›®ã€‚ç¨³å®šæ€§å¾—ä¸åˆ°ä¿è¯ã€‚

## å®‰è£…

è¯¥å®¢æˆ·ç«¯å·²ç»åœ¨ macOS å’Œ Linux ä¸Šè¿›è¡Œäº†æµ‹è¯•ã€‚å®ƒåº”è¯¥ä¹Ÿå¯ä»¥åœ¨ Windows ä¸Šè¿è¡Œï¼Œä½†æ˜¯ï¼Œåœ¨è¿™ä¸ªæ–¹å‘ä¸Šè¿˜æ²¡æœ‰åšä»»ä½•å·¥ä½œã€‚æ¬¢è¿å…¬å…³ï¼

å®‰è£…`libssh2`ã€‚

*   macOS - `brew install libssh2`
*   CentOS - `yum install libssh2.x86_64 libssh2-devel.x86_64`

è·å¾—æœ€æ–°çš„å·´æ‹¿é©¬ [JDK å»ºé€ ](http://jdk.java.net/panama/)ã€‚

æ‰“å¼€æ§åˆ¶å°å¤–å£³ï¼Œé…ç½®`JAVA_HOME`å˜é‡æŒ‡å‘ JDK 13 å·ã€‚

ä»æœ¬åœ° libssh2 å¤´æ–‡ä»¶ç”Ÿæˆæ‰€éœ€çš„ Java æ¥å£:

```
./gen_bindings.sh 
```

## å¥”è·‘

è¦ç¼–è¯‘å’Œè¿è¡Œï¼Œè¯·ä½¿ç”¨:

```
./run.sh [-p|-k] hostname port username [path to ssh keys] 
```

*   `-p`ä½¿ç”¨å¯†ç ç™»å½•ã€‚ç³»ç»Ÿä¼šæç¤ºæ‚¨è¾“å…¥å¯†ç ã€‚
*   `-k`ä½¿ç”¨å…¬é’¥ç™»å½•ã€‚æ‚¨éœ€è¦æŒ‡å®šæ‚¨çš„é”®çš„è·¯å¾„ï¼Œä¾‹å¦‚`~/.ssh`ã€‚

## è®¸å¯è¯

â€¦

</article>

[View on GitHub](https://github.com/petarov/java-panama-ssh2)

å¦‚æœä½ æƒ³è¯•ä¸€è¯•ï¼Œå¹¶è°ƒæ•´å®ƒåœ¨ Windows ä¸Šè¿è¡Œï¼Œæˆ‘å°†éå¸¸æ„Ÿè°¢ä¸€ä¸ªå…¬å…³ã€‚

# [](#final-thoughts)æœ€åçš„æƒ³æ³•

æˆ‘åœ¨ä¸å·´æ‹¿é©¬åˆä½œæ—¶äº†è§£åˆ°æˆ–ä¸€ç›´åœ¨æ€è€ƒçš„å‡ ç‚¹ã€‚

*   è¿™ä¸ª`Scope`ç›¸å½“å¼ºå¤§ã€‚ä½ å¯ä»¥åˆ†é…å›è°ƒæŒ‡é’ˆï¼Œç»“æ„ï¼Œæ•°ç»„ã€‚å¸ƒå±€å’Œå¸ƒå±€ç±»å‹çš„æ¦‚å¿µå€¼å¾—æˆ‘èŠ±æ›´å¤šçš„æ—¶é—´å»å……åˆ†æ¢ç´¢å’ŒæŒæ¡ã€‚
*   æ¯«ä¸å¥‡æ€ªï¼Œä½¿ç”¨æœ¬åœ°åº“ç¼–å†™ Java ä»£ç æ›´åŠ å¹¿æ³›ï¼Œéœ€è¦æ ¼å¤–å°å¿ƒï¼Œå°¤å…¶æ˜¯åœ¨ä¸è¦å¿˜è®°è°ƒç”¨åº“æ‰€éœ€çš„æ¸…ç† API è°ƒç”¨æ—¶ã€‚
*   å¤§å¤šæ•°æœ¬åœ°åº“ä¸­çš„ I/O éœ€è¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™åœ¨ Java[ã€6ã€‘](#refs)ä¸­å¹¶ä¸å®¹æ˜“è·å¾—ã€‚ç„¶è€Œï¼Œè¿™ä¸ **java.foreign** API æ²¡æœ‰ç›´æ¥å…³ç³»ã€‚
*   ä¸€äº›åº“å®šä¹‰äº†ä¸å¸¦å‚æ•°çš„ C++é£æ ¼çš„å‡½æ•°åŸå‹ï¼Œè€Œä¸æ˜¯ C é£æ ¼çš„`Void`å‚æ•°ç±»å‹ã€‚å›½å¤–æ–‡çŒ®[ã€3ã€‘](#refs)æœ‰ä¸€ä¸ªä½¿ç”¨ TensorFlow C API æ—¶å…³äºè¿™ä¸ªæ¡ˆä¾‹çš„ä¾‹å­ã€‚
*   æˆ‘è¿˜æ²¡æœ‰æ¢ç´¢æ˜¯å¦æœ‰å¯èƒ½å°†å·´æ‹¿é©¬ä¸ Go æˆ– Rust åˆ›å»ºçš„æœ¬åœ°åº“ä¸€èµ·ä½¿ç”¨ã€‚é‚£ä¼šå¾ˆé…·ã€‚

æ„Ÿè°¢é˜…è¯»ï¼ğŸ»

# [](#references)å‚è€ƒæ–‡çŒ®

1.  [GOTO 2019 å·´æ‹¿é©¬é¡¹ç›®éƒ¨åˆ†](https://www.youtube.com/watch?v=vJrHHe3IbQs&t=2172)
2.  [Java æœ¬åœ°æ¥å£](https://en.wikipedia.org/wiki/Java_Native_Interface)
3.  [å·´æ‹¿é©¬å¤–å›½æ–‡ä»¶](https://hg.openjdk.java.net/panama/dev/raw-file/4810a7de75cb/doc/panama_foreign.html)
4.  libSSH2 -å®ç° SSH2 åè®®çš„å®¢æˆ·ç«¯ C åº“
5.  [å·´æ‹¿é©¬æ´»é¡µå¤¹æ–‡ä»¶ v3](https://cr.openjdk.java.net/~mcimadamore/panama/panama-binder-v3.html)
6.  [å°† Java å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™ C äºŒè¿›åˆ¶æ–‡ä»¶çš„æœ€æœ‰æ•ˆæ–¹å¼](https://stackoverflow.com/q/11455803/10364676)