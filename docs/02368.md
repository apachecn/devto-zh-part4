# NTP æ± é¡¹ç›®:å¦‚ä½•ä½¿ç”¨å’Œè´¡çŒ®

> åŸæ–‡:[https://dev . to/piraces/the-NTP-pool-project-how-to-use-and-contribute-58gl](https://dev.to/piraces/the-ntp-pool-project-how-to-use-and-contribute-58gl)

# [](#introduction)ç®€ä»‹

NTP æ± é¡¹ç›®æ˜¯ä¸€ä¸ªå¤§å‹è™šæ‹ŸæœåŠ¡å™¨åœºï¼Œä¸ºä»»ä½•äººæä¾› T2 NTP æœåŠ¡ã€‚è¯¥é¡¹ç›®ç”±ä¸€ä¸ª DNS ç³»ç»Ÿç»„æˆï¼Œè¯¥ç³»ç»Ÿå¯å¹³è¡¡ä¸–ç•Œå„åœ°è®¾å¤‡(å¹³æ¿ç”µè„‘ã€æ™ºèƒ½æ‰‹æœºã€ç”µè„‘ã€è·¯ç”±å™¨)çš„æ•°ç™¾ä¸‡æ¬¡æ—¶é—´åŒæ­¥æŸ¥è¯¢è´Ÿè½½...).åƒ Ubuntuã€[è¿™æ ·çš„ä¾›åº”å•†ä¹Ÿä¸ºå…¶æ‰€æœ‰çš„å®¢æˆ·ä½¿ç”¨è¿™é¡¹æœåŠ¡](https://help.ubuntu.com/lts/serverguide/NTP.html)(å®ƒä¹Ÿæ™®éç”¨äºè®¸å¤šå…¶ä»–çš„ Linux å‘è¡Œç‰ˆ)ã€‚å®é™…ç›®æ ‡æ˜¯ä¸ºè¿™äº›è®¾å¤‡æä¾›çœŸå®è€Œå‡†ç¡®çš„æ—¶é—´åŒæ­¥ï¼Œè¿™è¦å½’åŠŸäºå¤§é‡çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨å®ƒä»¬æ¥åˆ†é…æ± ä¸­çš„è´Ÿè½½ã€‚

å®é™…ä¸Šï¼Œè¿™ä¸ªæ± æœ‰å¤§çº¦ 4000 å°æœåŠ¡å™¨ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„*å±‚*ï¼Œåœ¨å®ƒä»¬ä¹‹é—´åŒæ­¥æ—¶é—´ï¼Œå¹¶æä¾›æ—¶é—´åŒæ­¥æœåŠ¡ã€‚

è¿™äº›æœåŠ¡å™¨ä½äºä¸åŒçš„*å±‚*ä¸­ï¼Œéµå¾ª NTP å±‚æ¬¡ç»“æ„:

<figure>

[![NTP Hierarchy](img/e4d71fe160b83f44e9251232bcc8fd1c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--PmbjXsnF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Network_Time_Protocol_servers_and_clients.svg/1920px-Network_Time_Protocol_servers_and_clients.svg.png)

<figcaption>Hierarchy of an NTP system</figcaption>

</figure>

è¦äº†è§£æ›´å¤šå…³äºä¸åŒå±‚å’Œæ¯ä¸ªå±‚æœåŠ¡å™¨çš„ç‰¹ç‚¹ï¼Œä½ å¯ä»¥çœ‹çœ‹[è¿™é‡Œ](https://en.wikipedia.org/wiki/Network_Time_Protocol#Clock_strata)ã€‚

# [](#using-the-pool)ä½¿ç”¨æ± 

å¦‚æœä½ æœ‰å…´è¶£ä½¿ç”¨è¿™ä¸ªä»¤äººæ•¬ç•çš„æœåŠ¡ï¼Œè¯·æŒ‰ç…§å®˜æ–¹é¡µé¢ä¸Šçš„æŒ‡ç¤º:[æˆ‘å¦‚ä½•ä½¿ç”¨ pool.ntp.orgï¼Ÿ](https://www.ntppool.org/en/use.html)

è¿™åŸºæœ¬ä¸Šå°†æ‚¨çš„ NTP æœåŠ¡å™¨æ›´æ”¹ä¸ºæŒ‡å‘æ± ä¸­çš„æœåŠ¡å™¨:

<figure>

```
server 0.pool.ntp.org
server 1.pool.ntp.org
server 2.pool.ntp.org
server 3.pool.ntp.org 
```

<figcaption>The 0, 1, 2 and 3.pool.ntp.org names point to a random set of servers that will change every hour</figcaption>

</figure>

# [](#contributing)æŠ•ç¨¿

> â€œå°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘ä»¬æ˜¯ä¸€æ»´æ°´ã€‚åˆåœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å°±æ˜¯ä¸€ç‰‡æµ·æ´‹ã€‚â€
> â€”â€”é¾™ä¹‹ä»‹Â·è¨å¤šç½—

è´¡çŒ®æ˜¯éå¸¸å®¹æ˜“çš„ï¼Œæ‰€ä»¥å¦‚æœä½ æƒ³è´¡çŒ®ï¼Œåªéœ€éµå¾ªä»¥ä¸‹æ­¥éª¤ã€‚

## [](#can-i-contribute)æˆ‘å¯ä»¥æŠ•ç¨¿å—ï¼Ÿ

è´¡çŒ®ä½ åªéœ€è¦ä¸€ä¸ªé™æ€çš„ IP å’Œæ°¸ä¹…çš„å…¬å…±ç½‘ç»œæ¥å…¥ã€‚å¦‚æœä½ æ»¡è¶³äº†è¿™äº›è¦æ±‚ï¼Œè¯•ç€æŒ‰ç…§æ•™ç¨‹ä¸ºè¿™ä¸ªé¡¹ç›®åšè´¡çŒ®å§ï¼

*æ³¨æ„:è¯·ä»”ç»†é˜…è¯»å®˜æ–¹é¡µé¢åŠ å…¥æ³³æ± ï¼Œç„¶åå†ç»§ç»­([https://www.pool.ntp.org/en/join.html](https://www.pool.ntp.org/en/join.html))*

## [](#setting-up-the-server)è®¾ç½®æœåŠ¡å™¨

ä¸‹é¢çš„è¯´æ˜æ˜¯é’ˆå¯¹ Linux å‘è¡Œç‰ˆçš„ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ Ubuntu/Debianï¼Œä½†æ˜¯è½¯ä»¶åŒ…å’Œé…ç½®æ–‡ä»¶åœ¨æ‰€æœ‰å‘è¡Œç‰ˆä¸­å‡ ä¹æ˜¯ä¸€æ ·çš„ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å°†é…ç½®ä¸€å° stratum 3 æœåŠ¡å™¨ï¼Œä½†å¯¹äº stratum 4 æˆ– stratum 2 æœåŠ¡å™¨ï¼Œè¯´æ˜å‡ ä¹æ˜¯ç›¸åŒçš„ã€‚

### [](#1-install-the-ntp-daemon)1ã€‚å®‰è£… NTP å®ˆæŠ¤ç¨‹åº

åªéœ€æ‰§è¡Œå®‰è£…å‘½ä»¤:
`sudo apt-get install ntp`

### [](#2-choosing-static-ntp-servers)2ã€‚é€‰æ‹©é™æ€ NTP æœåŠ¡å™¨

é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»æœç´¢è¦åŒæ­¥çš„ç¬¬äºŒå±‚æœåŠ¡å™¨ã€‚
**é€‰æ‹©è‡³å°‘ 4 å°** *stratum 2 æœåŠ¡å™¨*å¾ˆé‡è¦ï¼Œè¿™äº›æœåŠ¡å™¨åœ¨åœ°ç†ä¸Šç¦»æˆ‘ä»¬çš„æœåŠ¡å™¨å¾ˆè¿‘(è‡³å°‘åœ¨åŒä¸€ä¸ªå›½å®¶)ã€‚

å¯ä»¥åœ¨è¿™ä¸ªå®˜æ–¹åˆ—è¡¨ä¸­æœç´¢æœåŠ¡å™¨:[http://support . NTP . org/bin/view/Servers/StratumTwoTimeServers](http://support.ntp.org/bin/view/Servers/StratumTwoTimeServers)

å¦‚æœä½ æƒ³é…ç½®ä¸€ä¸ª stratum 2 æœåŠ¡å™¨ï¼Œä» Stratum 1 åˆ—è¡¨ä¸­é€‰æ‹©ä¸€äº›æœåŠ¡å™¨:
[http://support . NTP . org/bin/view/Servers/StratumOneTimeServers](http://support.ntp.org/bin/view/Servers/StratumOneTimeServers)

*æ³¨æ„:ä»…é€‰æ‹©â€œOpenAccessâ€æœåŠ¡å™¨ï¼Œé™¤éæ‚¨å·²ç»è·å¾—é€‰æ‹©å…¶ä»–ç±»å‹æœåŠ¡å™¨çš„æ‰¹å‡†ã€‚*

ä¸€æ—¦æˆ‘ä»¬æœ‰äº†æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“å®ƒçš„ IPv4 å’Œ IPv6 åœ°å€ã€‚æœ‰æ—¶å®ƒçš„ IP åœ°å€åœ¨åˆ—è¡¨ä¸­è¢«é€šçŸ¥ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯æˆ–è€…ä½ æƒ³è¦ç¡®è®¤ IPï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œä¸€ä¸ªåŸºæœ¬çš„ *dig* å‘½ä»¤æ¥æå–è¿™ä¸ªä¿¡æ¯ã€‚ä¾‹å¦‚:

`dig 6.ntp.snails.email ANY`

å®ƒäº§ç”Ÿä»¥ä¸‹è¾“å‡º:

```
;; ANSWER SECTION:
6.ntp.snails.email. 5999    IN  A   139.162.170.219
6.ntp.snails.email. 5999    IN  AAAA 2a01:7e01::f03c:91ff:fe8b:e9e0 
```

### [](#3-configure-the-ntp-daemon)3ã€‚é…ç½® NTP å®ˆæŠ¤ç¨‹åº

ä¸€æ—¦æˆ‘ä»¬è·å¾—äº†æ‰€é€‰æœåŠ¡å™¨çš„æ‰€æœ‰ IP åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥é…ç½® NTP å®ˆæŠ¤ç¨‹åºäº†ã€‚

ä¿®æ”¹ NTP çš„é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ä½äº`/etc/ntp.conf`ä¸­ã€‚åˆ é™¤é»˜è®¤æƒ…å†µä¸‹ä»¥ *pool* å•è¯å¼€å¤´çš„æ‰€æœ‰è¡Œï¼Œç„¶åæŒ‰ç…§ä»¥ä¸‹æ ¼å¼é€è¡Œç²˜è´´æœåŠ¡å™¨:

`server ntp_server_1 iburst`

å…¶ä¸­*â€˜NTP _ server _ 1â€™*æ˜¯æœåŠ¡å™¨çš„ IP åœ°å€(æ¯è¡Œä¸€ä¸ªåœ°å€)ã€‚

å¦å¤–ï¼Œç¡®ä¿æ‚¨çš„é…ç½®æ–‡ä»¶æœ‰ä¸€ä¸ª`driftfile`å¹¶ä¸”`noquery`é€‰é¡¹å‡ºç°åœ¨é…ç½®æ–‡ä»¶çš„é™åˆ¶è¡Œä¸­ã€‚

`driftfile`é€‰é¡¹æœ‰åŠ©äºè·å¾—ç¨³å®šå‡†ç¡®çš„æ—¶é—´ï¼Œå­˜å‚¨é¢‘ç‡åç§»å’Œæ‰€éœ€é¢‘ç‡ï¼Œä»¥ä¿æŒä¸æ­£ç¡®æ—¶é—´åŒæ­¥ã€‚

`noquery`é€‰é¡¹ä¸å…è®¸ç®¡ç†æŸ¥è¯¢ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢æ”»å‡»æˆ–æ˜“å—å¯èƒ½ä¿®æ”¹æœåŠ¡å™¨çŠ¶æ€çš„æŸ¥è¯¢çš„æ”»å‡»ã€‚

æœ€ç»ˆçš„é…ç½®æ–‡ä»¶åº”è¯¥æ˜¯è¿™æ ·çš„:

```
driftfile /var/lib/ntp/ntp.drift

server ntp_server_1 iburst
server ntp_server_2 iburst
server ntp_server_3 iburst
server ntp_server_4 iburst
server ntp_server_5 iburst

# By default, exchange time with everybody, but don't allow configuration.
restrict -4 default kod notrap nomodify nopeer noquery limited
restrict -6 default kod notrap nomodify nopeer noquery limited

# Local users may interrogate the ntp server more closely.
restrict 127.0.0.1
restrict ::1 
```

æœåŠ¡å™¨åé¢çš„`iburst`é€‰é¡¹æ˜¯å› ä¸º NTP æ± å»ºè®®è€Œå­˜åœ¨çš„ã€‚ä½¿ç”¨æ­¤é€‰é¡¹ï¼Œå¦‚æœæœåŠ¡å™¨ä¸å¯è¾¾ï¼Œè¿™å°†å‘é€å…«ä¸ªåŒ…è€Œä¸æ˜¯ä¸€ä¸ªåŒ…(ä»…ç¬¬ä¸€æ¬¡)ã€‚

### [](#4-restarting-the-ntp-daemon-and-testing-the-config)4ã€‚é‡æ–°å¯åŠ¨ NTP å®ˆæŠ¤ç¨‹åºå¹¶æµ‹è¯•é…ç½®

é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬åªéœ€é‡å¯æœåŠ¡æ¥åŠ è½½æ–°çš„é…ç½®:

`sudo systemctl restart ntp`

é‡å¯æœåŠ¡åï¼Œç­‰å¾… 5 åˆ†é’Ÿå·¦å³ï¼Œç›´åˆ°æ—¶é—´æºç¨³å®šï¼Œç¡®ä¿ 123 ç«¯å£(UDP)æ‰“å¼€ï¼Œç„¶å[æµ‹è¯•](https://servertest.online/ntp)ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨å‘½ä»¤`ntpq -p`æµ‹è¯•æœåŠ¡ï¼Œæˆ–è€…ä½¿ç”¨`ntpdate -q SERVER_IP`ä»å…¶ä»–æœåŠ¡å™¨æµ‹è¯•æœåŠ¡ã€‚

### [](#5-add-the-server-to-the-ntp-pool)5ã€‚å°†æœåŠ¡å™¨æ·»åŠ åˆ° NTP æ± ä¸­

è¿™æ˜¯æœ€åä¸€æ­¥ã€‚æˆ‘ä»¬çš„æœåŠ¡å™¨æ­£åœ¨è¿è¡Œå¹¶ä¸”é…ç½®æ­£ç¡®ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å°†å®ƒæ·»åŠ åˆ°æ± ä¸­ã€‚

*   è¿›å…¥[ntppool.org](https://www.ntppool.org)ï¼Œç‚¹å‡»[â€œç®¡ç†æœåŠ¡å™¨â€](https://manage.ntppool.org/manage)ã€‚
*   æ³¨å†Œ(å¦‚æœæ‚¨å·²ç»æœ‰å¸æˆ·ï¼Œè¯·ç™»å½•)ã€‚
*   å†™ä¸‹ NTP æœåŠ¡å™¨çš„ä¸»æœºåæˆ–å…¶ IPv4 / IPv6 é™æ€åœ°å€ä¹‹ä¸€ã€‚
*   æäº¤å§ï¼

å¦‚æœæ‚¨ä¹Ÿæœ‰ä¸€ä¸ª IPv6 åœ°å€ï¼Œé‚£ä¹ˆåœ¨æ·»åŠ æœåŠ¡å™¨æ—¶ä¹Ÿæäº¤å®ƒã€‚

å®Œæˆåï¼Œæ‚¨çš„æœåŠ¡å™¨å¿…é¡»å‡ºç°åœ¨[â€œæ‚¨çš„æœåŠ¡å™¨â€](https://manage.ntppool.org/manage/servers)åˆ—è¡¨ä¸­ï¼Œåœ¨è¿™é‡Œæ‚¨å¯ä»¥è°ƒæ•´æœåŠ¡å™¨çš„ç½‘é€Ÿä»¥æ»¡è¶³è¦æ±‚ã€‚

æœ€åï¼Œæ‚¨çš„æœåŠ¡å™¨çš„å½“å‰å¾—åˆ†å°†éšç€æ—¶é—´çš„æ¨ç§»è€Œæé«˜ã€‚æœ€åˆï¼Œæ‚¨çš„æœåŠ¡å™¨å¯èƒ½ä¼šæœ‰è´Ÿçš„æˆ–ä½äº 10 åˆ†çš„åˆ†æ•°ï¼Œè¿™æ„å‘³ç€å®ƒå°†è¢«æ’é™¤åœ¨æ± å¤–ã€‚ä½†æ˜¯ï¼Œè®©æœåŠ¡ä»æºåŒæ­¥æ—¶é—´ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°æ± ä¸­ã€‚

### [](#6-congrats)6ã€‚æ­å–œä½ ã€‚

æ‚¨çš„æœåŠ¡å™¨æ˜¯æ± çš„ä¸€éƒ¨åˆ†ï¼Œæ­£åœ¨å¸®åŠ©åŒæ­¥å‡ ä¸ªè®¾å¤‡çš„æ—¶é—´ã€‚

æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ï¼ğŸ‰

[![Feels good!](img/7823eda5c0e003c612ff971d9e348468.png)T2ã€‘](https://i.giphy.com/media/d7c56SbLa9PRC/giphy.gif)

*åŸå‘äºæˆ‘çš„ä¸ªäººåšå®¢:[https://piraces . dev/posts/the-NTP-pool-project-how-to-use-and-contribute/](https://piraces.dev/posts/the-ntp-pool-project-how-to-use-and-contribute/)T3ã€‘*