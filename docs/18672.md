# å¦‚ä½•åœ¨ iOS ä¸­ä½¿ç”¨ AWS Amplify è¿›è¡Œè®¤è¯

> åŸæ–‡:[https://dev . to/calin _ crist/how-do-authentic ation-using-AWS-amplify-in-IOs-4kb 6](https://dev.to/calin_crist/how-to-do-authentication-using-aws-amplify-in-ios-4kb6)

æˆ‘æ—¢é«˜å…´åˆç´§å¼ åœ°å‘å¸ƒäº†æˆ‘çš„ç¬¬ä¸€ä¸ªæ•™ç¨‹ã€‚ğŸ˜Šæ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å§ï¼

å¦‚æœä½ æ˜¯ä¸€åå¼€å‘äººå‘˜ï¼Œä½ æœ‰ 99%çš„æœºä¼šå¤„ç†åº”ç”¨ç¨‹åºç”¨æˆ·çš„è®¤è¯é—®é¢˜ã€‚è®¤è¯æµç¨‹éœ€è¦å®‰å…¨ã€æ˜“äºé›†æˆå’Œå¯å®šåˆ¶ã€‚è¿™å¬èµ·æ¥å¯èƒ½å¾ˆå®¹æ˜“ã€‚ä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¤„ç†è¿™ä¸ªç‰¹æ€§éœ€è¦æ¯”æˆ‘ä»¬æƒ³è¦çš„æ›´å¤šçš„å·¥ä½œã€‚è¿™å°±æ˜¯ AWS Amplify å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚å®ƒä½¿å¾—è¿™ç§ä½“éªŒå¯¹å¼€å‘è€…æ¥è¯´æ˜¯å¯è¡Œçš„ï¼Œå¯¹ç”¨æˆ·æ¥è¯´æ˜¯æ— é£é™©çš„ã€‚

åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘æƒ³é€šè¿‡å±•ç¤ºæˆ‘å¦‚ä½•å°† AWS Amplify Auth ç»„ä»¶é›†æˆåˆ°æˆ‘çš„ iOS åº”ç”¨ç¨‹åºä¸­æ¥è¯æ˜è¿™ä¸€ç‚¹ã€‚

### [](#aws-amplify)**AWS æ”¾å¤§**

AWS Amplify æ˜¯ä¸€ä¸ªå¼€æºåº“ï¼Œé¢å‘å¸Œæœ›é›†æˆå¼ºå¤§çš„ AWS æœåŠ¡(Authã€APIã€S3 å­˜å‚¨ç­‰)çš„å¼€å‘äººå‘˜ã€‚)åˆ°ä»–ä»¬çš„ç§»åŠ¨/ç½‘ç»œåº”ç”¨ç¨‹åºä¸­ã€‚

å®ƒæœ‰ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿:ä½ ä¸éœ€è¦å¾ˆå¼ºçš„åç«¯çŸ¥è¯†æ¥éƒ¨ç½²å’Œé›†æˆã€‚é€šè¿‡ä½¿ç”¨è¿™ä¸ªï¼Œä½ å¯ä»¥æ›´ä¸“æ³¨äºæ„å»ºä½ çš„åº”ç”¨è€Œä¸æ˜¯é…ç½®ã€‚

### [](#auth)**Auth**

> â€œAWS Amplify èº«ä»½éªŒè¯æ¨¡å—ä¸ºæƒ³è¦åˆ›å»ºç”¨æˆ·èº«ä»½éªŒè¯ä½“éªŒçš„å¼€å‘äººå‘˜æä¾›äº†èº«ä»½éªŒè¯ API å’Œæ„å»ºæ¨¡å—ã€‚â€([https://aws-amplify.github.io/docs/js/authentication](https://aws-amplify.github.io/docs/js/authentication)

å®ƒæœ‰ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿:ä½ ä¸éœ€è¦å¾ˆå¼ºçš„åç«¯çŸ¥è¯†æ¥éƒ¨ç½²å’Œé›†æˆã€‚é€šè¿‡ä½¿ç”¨è¿™ä¸ªï¼Œä½ å¯ä»¥æ›´ä¸“æ³¨äºæ„å»ºä½ çš„åº”ç”¨è€Œä¸æ˜¯é…ç½®ã€‚

### [](#whathow-will-i-implement)**æˆ‘å°†å¦‚ä½•å®ç°**

æˆ‘è®¡åˆ’åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ iOS åº”ç”¨ç¨‹åºï¼Œå¹¶å‘å…¶æ·»åŠ èº«ä»½éªŒè¯æµç¨‹:

*   æ³¨å†Œ
*   ç­¾çº¦é›‡ç”¨
*   é‡ç½®å¯†ç 

ä¸ºäº†æ›´å®¹æ˜“ç†è§£ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå›¾è¡¨:

[![](../Images/2f1f36e9b9d96b384d2c5969c56ae9b6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Lz8XID8C--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/jkuj0epudrbq9v57px95.png)

### [](#create-basic-ios-app-project)**åˆ›å»ºåŸºç¡€ iOS app é¡¹ç›®**

æˆ‘åˆ›å»ºäº†ä¸€ä¸ª SingleView Swift é¡¹ç›®ï¼Œå¹¶å°†å…¶å‘½åä¸º *aws_amplify_integration* ã€‚

| ![](../Images/8455d5b70c12de20f02c79bbc013e458.png) | ![](../Images/0208acb9aaa2f0374758c261fa05c8ab.png) |
| --- | --- |

### [](#folder-structure)**æ–‡ä»¶å¤¹ç»“æ„**

ä¸‹é¢æ˜¯æˆ‘å»ºè®®çš„æ–‡ä»¶å¤¹ç»“æ„çš„æˆªå›¾:

[![](../Images/70e021b5e30eae4b5a72f53914d75bf0.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--CwmKC4yA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/m6e803ezcx4t9vplruhg.png)

### [](#customise-ui)**è‡ªå®šä¹‰ UI**

å¯¹äºæœ¬æ•™ç¨‹æ¥è¯´ï¼ŒUI æ˜¯éå¸¸åŸºæœ¬çš„ã€‚

å¦‚æœä½ æƒ³çœ‹ä¸€ä¸‹ xib æ–‡ä»¶ï¼Œåˆ°è¯¥é¡¹ç›®çš„ Github é“¾æ¥å¯ä»¥æ»¡è¶³ä½ çš„å¥½å¥‡å¿ƒã€‚

### [](#add-aws-amplify-libs)**æ·»åŠ  AWS æ”¾å¤§ libs**

éœ€è¦åšä»€ä¹ˆåœ¨ AWS Amplify æ–‡æ¡£([https://aws-amplify.github.io/docs/ios/start](https://aws-amplify.github.io/docs/ios/start))ä¸Šæœ‰å¾ˆå¥½çš„è§£é‡Šã€‚ä½†æˆ‘ä¼šæ‘˜å½•é‡è¦çš„æ­¥éª¤ã€‚

### [](#install-aws-amplify)**å®‰è£… AWS æ”¾å¤§å™¨**

å®‰è£… Nodejs å’Œ npmï¼Œç„¶åè¿è¡Œ:

```
npm install -g @aws-amplify/cli
amplify configure 
```

å®‰è£… Cocoapods:

```
sudo gem install cocoapods
pod init 
```

æ‰“å¼€ pod æ–‡ä»¶å¹¶æ·»åŠ  pod ä»¥ä½¿ AWS Mobile SDK å·¥ä½œ:

```
platform :ios, '11.0'

target 'aws_amplify_integration' do
    use_frameworks!
    pod 'AWSCore', '~> 2.9.0'
    pod 'AWSMobileClient', '~> 2.9.0'
end 
```

å®‰è£…ä¾èµ–é¡¹:

```
pod install --repo-update 
```

è®°å¾—æ‰“å¼€æ–°åˆ›å»ºçš„*AWS _ amplify _ integration . workspace .*

åœ¨ Xcode ä¸­æ„å»ºé¡¹ç›®ã€‚

### [](#setup-aws-services)**è®¾ç½® AWS æœåŠ¡**

éœ€è¦åšçš„æ˜¯åˆ›å»ºæ–°çš„ AWS åç«¯èµ„æºã€‚ä¹‹åï¼Œå°† AWS æœåŠ¡é…ç½®å¯¼å…¥åº”ç”¨ç¨‹åºã€‚

åœ¨ç»ˆç«¯çª—å£ä¸­ï¼Œå¯¼èˆªåˆ°æ‚¨çš„é¡¹ç›®æ–‡ä»¶å¤¹(åŒ…å« xcodeproj æ–‡ä»¶çš„æ–‡ä»¶å¤¹)ã€‚

è¿è¡Œä»¥ä¸‹å‘½ä»¤(å¯¹äºæ­¤åº”ç”¨ç¨‹åºï¼Œæ¥å—æ‰€æœ‰é»˜è®¤è®¾ç½®æ˜¯å¯ä»¥çš„):

```
 amplify init        #accept defaults
    amplify push        #creates configuration file 
```

åœ¨ Finder ä¸­ï¼Œå°†`awsconfiguration.json`æ‹–åˆ°é¡¶éƒ¨é¡¹ç›®å¯¼èˆªå™¨æ–‡ä»¶å¤¹ä¸‹çš„ Xcode ä¸­(æ–‡ä»¶å¤¹åç§°åº”è¯¥ä¸æ‚¨çš„ Xcode é¡¹ç›®åç§°åŒ¹é…)ã€‚å½“å‡ºç°`Options`å¯¹è¯æ¡†æ—¶ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

*   æ¸…é™¤`Copy items if needed`å¤é€‰æ¡†ã€‚
*   é€‰æ‹©`Create groups`ï¼Œç„¶åé€‰æ‹©`Next`ã€‚

### [](#add-auth)**æ·»åŠ æˆæƒ**

è¦äº«å—è‡ªåŠ¨è®¾ç½®ï¼Œè¯·åœ¨é¡¹ç›®çš„æ ¹æ–‡ä»¶å¤¹ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚

CLI æç¤ºå°†å¸®åŠ©æ‚¨ä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºè‡ªå®šä¹‰èº«ä»½éªŒè¯æµç¨‹ã€‚

```
 amplify add auth 
```

é…ç½®æ‚¨çš„è®¤è¯é€‰é¡¹åï¼Œæ›´æ–°æ‚¨çš„åç«¯:

```
 amplify push 
```

ç°åœ¨ï¼Œ`awsconfiguration.json`ç”¨ Cognito é…ç½®æ›´æ–°:

[![](../Images/e5104d11591e9ab517a11f672e341761.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--nlgXmqjz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/gpegddteqeh6yqw7tb5w.png)

å¦‚æœä¸æ˜¯ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç»å°†è¯¥æ–‡ä»¶æ·»åŠ åˆ°é¡¹ç›®ä¸­ã€‚

## [](#integrate-amplify-auth)**ç§¯åˆ†æ”¾å¤§è®¤è¯**

### [](#check-for-auth-state)æ£€æŸ¥æˆæƒçŠ¶æ€

é¦–å…ˆï¼Œéœ€è¦å¯¼å…¥ AWSMobileClient æ¥ä½¿ç”¨å®¢æˆ·ç«¯æ£€æŸ¥èº«ä»½éªŒè¯çŠ¶æ€ã€‚

é€šè¿‡è°ƒç”¨ *sharedInstance()* ä» *awsconfiguration.json ä¸­æå–é…ç½®ã€‚*è¿™ç®¡ç†ç”¨æˆ·çš„æˆæƒä»»åŠ¡ä¼šè¯ï¼Œå¦‚è‡ªåŠ¨å‡­è¯ç®¡ç†å’Œåˆ·æ–°ä¾‹ç¨‹ã€‚

æ–¹æ³•å°†å¯åŠ¨ä¸€ä¸ªæ–°çš„ä¼šè¯ã€‚ç»“æœåŒ…å«ä¸€ä¸ªå…¬å¼€å½“å‰ç”¨æˆ·çŠ¶æ€çš„æšä¸¾å€¼:

```
 public enum UserState: String {
        case signedIn, signedOut, signedOutFederatedTokensInvalid, signedOutUserPoolsTokenInvalid, guest, unknown
    } 
```

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªå·¥ä½œæµæ¥å†³å®šå‘ç”¨æˆ·å‘ˆç°ä»€ä¹ˆã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ *signedInã€‚*

å¦‚æœç”¨æˆ·ç™»å½•ï¼Œæˆ‘ä»¬å¯ä»¥é‡å®šå‘åˆ°*ä¸»è§†å›¾æ§åˆ¶å™¨ï¼Œ*å¦åˆ™åˆ°*ç™»å½•è§†å›¾æ§åˆ¶å™¨ã€‚*

```
 import UIKit
    import AWSMobileClient

    class SplashViewController: UIViewController {

        override func viewDidLoad() {
            super.viewDidLoad()

            AWSMobileClient.sharedInstance().initialize { (userState, error) in
                if let error = error {
                    print("error: \(error.localizedDescription)")
                    return
                }

                guard let userState = userState else {
                    return
                }

                print("The user is \(userState.rawValue).")

                // Check user availability
                switch userState {
                case .signedIn:
                    // Show home page
                    let mainViewController = MainViewController()
                    UIApplication.setRootView(mainViewController)
                    break

                default:
                    // Show login page
                    let loginViewController = LoginViewController()
                    UIApplication.setRootView(loginViewController)
                    break
                }
            }
        }
    } 
```

åœ¨ AppDelegate.swift çš„æ–¹æ³• didFinishLaunchingWithOptions ä¸­ï¼Œæˆ‘ä»¬æä¾›äº† SplashScreenViewControllerã€‚

```
 func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {

        window = UIWindow(frame: UIScreen.main.bounds)

        if let window = window {
            window.backgroundColor = #colorLiteral(red: 0.9960784314, green: 0.9960784314, blue: 0.9960784314, alpha: 1)

            let splashViewController = SplashViewController()
            window.makeKeyAndVisible()
            window.rootViewController = splashViewController

        }

        return true
    } 
```

### [](#login-flow)ç™»å½•æµç¨‹

å½“ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œæ˜¾ç¤ºç™»å½•å±å¹•ã€‚

ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥:

*   è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ç™»å½•
*   è½¬åˆ°æ³¨å†Œæµç¨‹
*   è½¬åˆ°é‡ç½®å¯†ç æµ

ç½‘ç‚¹å‚ç…§ *UITextFields* å’Œ *touch up inside äº‹ä»¶*å‚ç…§ç™»å½•æ–¹æ³•ã€‚

ç°åœ¨ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ *AWSMobileClient* ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç ç™»å½•ã€‚å½“ç»“æœå¯ç”¨æ—¶ï¼Œæ­¤æ“ä½œè°ƒç”¨å®Œæˆå¤„ç†ç¨‹åºã€‚

```
 public func signIn(username: String, 
                                         password: String, 
                                         validationData: [String: String]? = nil, 
                                         completionHandler: @escaping ((SignInResult?, Error?) -> Void)) 
```

è¯¥é”™è¯¯æ˜¯ä¸€ä¸ª *AWSMobileClientError* æšä¸¾å€¼ã€‚è¿™ä¸ªæšä¸¾æœ‰ 42 ä¸ªäº‹ä¾‹ã€‚

é€šå¸¸ï¼Œæ‚¨çš„éœ€æ±‚ä¸ä¼šè§¦åŠæ‰€æœ‰çš„å®¢æˆ·ç«¯é”™è¯¯ã€‚ä½†æ˜¯å¤„ç†å¤§éƒ¨åˆ†é—®é¢˜ä»¥ç»™ç”¨æˆ·é€‚å½“çš„åé¦ˆæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®è·µã€‚

```
 /// The error enum for `AWSMobileClient` errors.
    public enum AWSMobileClientError: Error {
        case aliasExists(message: String)
        case codeDeliveryFailure(message: String)
        case codeMismatch(message: String)
        case expiredCode(message: String)
        case groupExists(message: String)
        case internalError(message: String)
        case invalidLambdaResponse(message: String)
        case invalidOAuthFlow(message: String)
        case invalidParameter(message: String)
        case invalidPassword(message: String)
        case invalidUserPoolConfiguration(message: String)
        case limitExceeded(message: String)
        case mfaMethodNotFound(message: String)
        case notAuthorized(message: String)
        case passwordResetRequired(message: String)
        case resourceNotFound(message: String)
        case scopeDoesNotExist(message: String)
        case softwareTokenMFANotFound(message: String)
        case tooManyFailedAttempts(message: String)
        case tooManyRequests(message: String)
        case unexpectedLambda(message: String)
        case userLambdaValidation(message: String)
        case userNotConfirmed(message: String)
        case userNotFound(message: String)
        case usernameExists(message: String)
        case unknown(message: String)
        case notSignedIn(message: String)
        case identityIdUnavailable(message: String)
        case guestAccessNotAllowed(message: String)
        case federationProviderExists(message: String)
        case cognitoIdentityPoolNotConfigured(message: String)
        case unableToSignIn(message: String)
        case invalidState(message: String)
        case userPoolNotConfigured(message: String)
        case userCancelledSignIn(message: String)
        case badRequest(message: String)
        case expiredRefreshToken(message: String)
        case errorLoadingPage(message: String)
        case securityFailed(message: String)
        case idTokenNotIssued(message: String)
        case idTokenAndAcceessTokenNotIssued(message: String)
        case invalidConfiguration(message: String)
        case deviceNotRemembered(message: String)
    } 
```

å½“æ²¡æœ‰é”™è¯¯æ—¶ï¼Œ *SignInResult* åŒ…å«ç”¨æˆ·çš„çŠ¶æ€ã€‚

```
 public enum SignInState: String {
        case unknown = "UNKNOWN"
        case smsMFA = "CONFIRMATION_CODE"
        case passwordVerifier = "PASSWORD_VERIFIER"
        case customChallenge = "CUSTOM_CHALLENGE"
        case deviceSRPAuth = "DEVICE_SRP_AUTH"
        case devicePasswordVerifier = "DEVICE_PASSWORD_VERIFIER"
        case adminNoSRPAuth = "ADMIN_NO_SRP_AUTH"
        case newPasswordRequired = "NEW_PASSWORD_REQUIRED"
        case signedIn = "SIGN_IN_COMPLETE"
    } 
```

ä¸‹é¢æ˜¯æ•´ä¸ªå®ç°å’Œå¤„ç†ã€‚
ç™»å½•å®Œæˆåï¼Œé‡å®šå‘åˆ° *MainViewControllerã€‚*T3ã€‘

```
 import UIKit
    import AWSMobileClient

    class LoginViewController: UIViewController {

        @IBOutlet weak var usernameTextField: UITextField!
        @IBOutlet weak var passwordTextField: UITextField!

        @IBAction func login(_ sender: Any) {

            guard let username = usernameTextField.text,
                let password = passwordTextField.text  else {
                print("Enter some values please.")
                return
            }

            print("\(username) and \(password)")

            AWSMobileClient.sharedInstance().signIn(username: username, password: password) { 
                            (signInResult, error) in

                    if let error = error  {
                        print("There's an error : \(error.localizedDescription)")
                        print(error)
                        return
                    }

                    guard let signInResult = signInResult else {
                        return
                    }

                    switch (signInResult.signInState) {
                    case .signedIn:
                        print("User is signed in.")

                        DispatchQueue.main.async {
                            let mainViewController = MainViewController()
                            UIApplication.setRootView(mainViewController)
                        }

                    case .newPasswordRequired:
                        print("User needs a new password.")
                    default:
                        print("Sign In needs info which is not et supported.")
                    }
            }
        }
    } 
```

### [](#sign-up-flow)**æŠ¥åæµç¨‹**

è¿™é‡Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªå±å¹•æ¥å®Œæˆè¿™ä¸ªæµç¨‹:

1.  è¾“å…¥æ‚¨çš„å¸æˆ·è¯¦ç»†ä¿¡æ¯(å…¨åã€ç”µå­é‚®ä»¶ã€ç”¨æˆ·åå’Œå¯†ç )
    *   *ç­¾åå¥³å­©æ§åˆ¶å™¨*
2.  ç¡®è®¤éªŒè¯ç 
    *   *ConfirmSignUpViewController*

åœ¨ AWS Amplify ä¸­ï¼Œæ³¨å†Œå’Œç¡®è®¤ä¸ç™»å½•è¿‡ç¨‹éå¸¸ç›¸ä¼¼ã€‚

å”¯ä¸€ä¸åŒçš„æ˜¯ç»“æœã€‚å®ƒä½¿ç”¨åŒ…å«æ³¨å†Œç¡®è®¤çŠ¶æ€çš„*æ³¨å†Œç»“æœ*ã€‚

```
 /// Indicates the state of user during the sign up operation.
    public enum SignUpConfirmationState {
        case confirmed, unconfirmed, unknown
    } 
```

å½“çŠ¶æ€ä¸º*æœªç¡®è®¤æ—¶ï¼Œ* Cognito å‘é€éªŒè¯ç ã€‚å®ƒå¯ä»¥é€šè¿‡çŸ­ä¿¡æˆ–ç”µå­é‚®ä»¶ï¼Œå–å†³äºå¦‚ä½•é…ç½® Cognitoã€‚

ç„¶åï¼Œåº”ç”¨ç¨‹åºè¿›å…¥ç¡®è®¤å±å¹•ã€‚

```
 import AWSMobileClient

    class SignUpViewController: UIViewController {

        @IBOutlet weak var passwordTextField: UITextField!
        @IBOutlet weak var usernameTextField: UITextField!
        @IBOutlet weak var emailTextField: UITextField!
        @IBOutlet weak var fullNameTextField: UITextField!

            @IBAction func createAccount(_ sender: Any) {

            guard let fullName = fullNameTextField.text,
                let email = emailTextField.text,
                let username = usernameTextField.text,
                let password = passwordTextField.text else {
                return
            }

            AWSMobileClient.sharedInstance().signUp(username: username,
                                                    password: password,
                                                    userAttributes: ["email" : email, "name": fullName],
                                                    completionHandler: signUpHandler);
        }

        func signUpHandler(signUpResult: SignUpResult?, error: Error?) {

            if let error = error {
                if let error = error as? AWSMobileClientError {
                    switch(error) {
                    case .usernameExists(let message):
                        print(message)
                    default:
                        break
                    }
                }
                print("There's an error on signup: \(error.localizedDescription), \(error)")
            }

            guard let signUpResult = signUpResult else {
                return
            }

            switch(signUpResult.signUpConfirmationState) {
            case .confirmed:
                print("User is signed up and confirmed.")

                DispatchQueue.main.async {
                    let mainViewController = MainViewController()
                    UIApplication.setRootView(mainViewController)
                }

            case .unconfirmed:
                let alert = UIAlertController(title: "Code sent",
                                              message: "Confirmation code sent via \(signUpResult.codeDeliveryDetails!.deliveryMedium) to: \(signUpResult.codeDeliveryDetails!.destination!)",
                    preferredStyle: .alert)

                alert.addAction(UIAlertAction(title: "Dismiss", style: .cancel) { _ in
                    guard let username = self.usernameTextField.text else {
                        return
                    }
                    let confirmSignupViewController = ConfirmSignUpViewController(username: username)
                    self.navigationController?.pushViewController(confirmSignupViewController, animated: true)
                })

                DispatchQueue.main.async {
                    self.present(alert, animated: true, completion: nil)
                }

            case .unknown:
                print("Unexpected case")
            }
        }

        @IBAction func dismissModal(_ sender: Any) {
            self.navigationController?.dismiss(animated: true, completion: nil)
        }
    } 
```

ConfirmSignUpViewController:

```
 import AWSMobileClient

    class ConfirmSignUpViewController: UIViewController {

        @IBOutlet weak var verificationCodeTextField: UITextField!
        var username: String?

        init(username: String, nibName nibNameOrNil: String? = nil, bundle nibBundleOrNil: Bundle? = nil) {
            self.username = username
            super.init(nibName:nibNameOrNil, bundle: nibBundleOrNil)
        }

        required init?(coder aDecoder: NSCoder) {
            fatalError("init(coder:) has not been implemented")
        }

            @IBAction func confirmSignUp(_ sender: Any) {

            guard let verificationCode = verificationCodeTextField.text,
                let username = self.username else {
                print("No username")
                return
            }

            AWSMobileClient.sharedInstance().confirmSignUp(username: username,
                                                           confirmationCode: verificationCode,
                                                           completionHandler: handleConfirmation)
        }

            func handleConfirmation(signUpResult: SignUpResult?, error: Error?) {
            if let error = error {
                print("\(error)")
                return
            }

            guard let signUpResult = signUpResult else {
                return
            }

            switch(signUpResult.signUpConfirmationState) {
            case .confirmed:
                print("User is signed up and confirmed.")

                DispatchQueue.main.async {
                    let mainViewController = MainViewController()
                    UIApplication.setRootView(mainViewController)
                }

            case .unconfirmed:
                print("User is not confirmed and needs verification via \(signUpResult.codeDeliveryDetails!.deliveryMedium) sent at \(signUpResult.codeDeliveryDetails!.destination!)")
            case .unknown:
                print("Unexpected case")
            }
        }

        @IBAction func resendCode(_ sender: Any) {
            guard let username = self.username else {
                print("No username")
                return
            }

            AWSMobileClient.sharedInstance().resendSignUpCode(username: username,
                                                              completionHandler: resendSignUpHandler)
        }

        func resendSignUpHandler(result: SignUpResult?, error: Error?) {
            if let error = error {
                print("\(error)")
                return
            }

            guard let signUpResult = result else {
                return
            }

            let message = "A verification code has been sent via \(signUpResult.codeDeliveryDetails!.deliveryMedium) at \(signUpResult.codeDeliveryDetails!.destination!)"
            let alert = UIAlertController(title: "Code Sent",
                                          message: message,
                                          preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "Dismiss", style: .cancel, handler: { _ in
                //Cancel Action
            }))

            DispatchQueue.main.async {
                self.present(alert, animated: true, completion: nil)
            }
        }

        @IBAction func dismissModal(_ sender: Any) {
            self.navigationController?.dismiss(animated: true, completion: nil)
        }
    } 
```

### [](#reset-password-flow)é‡ç½®å¯†ç æµç¨‹

è¯¥æµç¨‹åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ã€‚

é¦–å…ˆï¼Œç”¨æˆ·å¿…é¡»é€šè¿‡ç”µå­é‚®ä»¶æˆ–çŸ­ä¿¡æ¥æ”¶ç¡®è®¤ç ã€‚è¿™æ˜¯é€šè¿‡è°ƒç”¨ forgotPassword(ç”¨æˆ·å:ç”¨æˆ·å)æ¥å®Œæˆçš„ã€‚å¯ä»¥ä»å“åº”ä¸­åŒ…å«çš„ UserCodeDeliveryDetails ä¸­æ£€ç´¢æœ‰å…³å¦‚ä½•å‘é€ä»£ç çš„è¯¦ç»†ä¿¡æ¯ã€‚

```
 /// Indicates the state of forgot password operation.
    public enum ForgotPasswordState {
        case done, confirmationCodeSent
    }

    /// Contains the result of the forgot password operation.
    public struct ForgotPasswordResult {
        public let forgotPasswordState: ForgotPasswordState
        public let codeDeliveryDetails: UserCodeDeliveryDetails?

        internal init(forgotPasswordState: ForgotPasswordState, codeDeliveryDetails: UserCodeDeliveryDetails?) {
            self.forgotPasswordState = forgotPasswordState
            self.codeDeliveryDetails = codeDeliveryDetails
        }
    } 
```

ç„¶åï¼Œè¯¥ä»£ç ç”¨äºç¡®è®¤æ–°å¯†ç ã€‚

```
 confirmForgotPassword(username: username, 
                       newPassword: newPassword, 
                  confirmationCode: confirmationCode) 
```

è¿™é‡Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªå±å¹•:

1.  è¾“å…¥ç”¨æˆ·å
    *   ResetPasswordViewController
2.  ç¡®è®¤éªŒè¯ç å¹¶è¾“å…¥æ–°å¯†ç 
    *   NewPasswordViewController

ResetPasswordViewController:

```
 import UIKit
    import AWSMobileClient

    class ResetPasswordViewController: UIViewController {

        @IBOutlet weak var usernameTextField: UITextField!

        @IBAction func submitUsername(_ sender: Any) {

            guard let username = usernameTextField.text else {
                print("No username")
                return
            }

            AWSMobileClient.sharedInstance().forgotPassword(username: username) { (forgotPasswordResult, error) in
                if let forgotPasswordResult = forgotPasswordResult {
                    switch(forgotPasswordResult.forgotPasswordState) {
                    case .confirmationCodeSent:
                        guard let codeDeliveryDetails = forgotPasswordResult.codeDeliveryDetails else {
                            return
                        }

                        let alert = UIAlertController(title: "Code sent",
                                                      message: "Confirmation code sent via \(codeDeliveryDetails.deliveryMedium) to: \(codeDeliveryDetails.destination!)",
                                                      preferredStyle: .alert)

                        DispatchQueue.main.async {
                            self.present(alert, animated: true, completion: nil)
                        }

                    default:
                        print("Error: Invalid case.")
                    }
                } else if let error = error {
                    print("Error occurred: \(error.localizedDescription)")
                }
            }

        }

        @IBAction func dismiss(_ sender: Any) {
            self.navigationController?.dismiss(animated: true, completion: nil)
        }
    } 
```

NewPasswordViewController:

```
 import UIKit
    import AWSMobileClient

    class NewPasswordViewController: UIViewController {

        @IBOutlet weak var verificationCodeTextField: UITextField!
        @IBOutlet weak var newPasswordTextField: UITextField!

        var username: String?

        init(username: String, nibName nibNameOrNil: String? = nil, bundle nibBundleOrNil: Bundle? = nil) {
            self.username = username
            super.init(nibName:nibNameOrNil, bundle: nibBundleOrNil)
        }

        required init?(coder aDecoder: NSCoder) {
            fatalError("init(coder:) has not been implemented")
        }

        @IBAction func verifyCode(_ sender: Any) {

            guard let username = username,
                let newPassword = newPasswordTextField.text,
                let confirmationCode = verificationCodeTextField.text else {
                return
            }

            AWSMobileClient.sharedInstance().confirmForgotPassword(username: username,
                                                                   newPassword: newPassword,
                                                                   confirmationCode: confirmationCode) { (forgotPasswordResult, error) in
                if let forgotPasswordResult = forgotPasswordResult {
                    switch(forgotPasswordResult.forgotPasswordState) {
                    case .done:
                        self.dismiss(self)
                    default:
                        print("Error: Could not change password.")
                    }
                } else if let error = error {
                    print("Error occurred: \(error.localizedDescription)")
                }
            }
        }

        @IBAction func dismiss(_ sender: Any) {
            self.navigationController?.dismiss(animated: true, completion: nil)
        }
    } 
```

### [](#sign-out-action)ç­¾é€€åŠ¨ä½œ

ä¸å¤šè¯´äº†:)è°ƒç”¨ä»¥ä¸‹ï¼Œé€šè¿‡æ¸…é™¤æœ¬åœ°é’¥åŒ™ä¸²å­˜å‚¨ï¼Œç”¨æˆ·å°†ä»å½“å‰è®¾å¤‡æ³¨é”€ã€‚

```
 AWSMobileClient.sharedInstance().signOut() 
```

æ­¤å¤–ï¼Œè¿™å¯ä»¥æ˜¯ä»æ‰€æœ‰æ´»åŠ¨ä¼šè¯(æ‰€æœ‰è®¾å¤‡)ä¸­æ³¨é”€ç”¨æˆ·çš„å…¨å±€æ“ä½œã€‚å®ƒä½¿æ‰€æœ‰ä»¤ç‰Œæ— æ•ˆ:id ä»¤ç‰Œã€è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œã€‚

å°½ç®¡ä»¤ç‰Œè¢«æ’¤é”€ï¼Œä½† AWS å‡­æ®å°†ä¿æŒæœ‰æ•ˆï¼Œç›´åˆ°è¿‡æœŸ(é»˜è®¤ä¸º 1 å°æ—¶)ã€‚

è¿™ä¸æ˜¯é»˜è®¤è¡Œä¸ºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ signOut options å¯¹è±¡æ¥æŒ‡å®šç­¾å‡ºé€‰é¡¹:

```
 /// Signout options to change the default behavior.
    public struct SignOutOptions {
        let invalidateTokens: Bool
        let signOutGlobally: Bool

        /// Initializer: Signout options to change the default behavior.
        ///
        /// - Parameters:
        ///   - signOutGlobally: Invalidate all active sessions with the service. The user will be logged out of all devices.
        ///   - invalidateTokens: If functionality available, the access token, refresh token and id token will be invalidated and won't be usable.
        public init(signOutGlobally: Bool = false, invalidateTokens: Bool = true) {
            self.signOutGlobally = signOutGlobally
            self.invalidateTokens = invalidateTokens
        }
    } 
```

```
 AWSMobileClient.sharedInstance().signOut(options: SignOutOptions(signOutGlobally: true)) { (error) in
        print("Error: \(error.debugDescription)")
    } 
```

ä¸»è§†å›¾æ§åˆ¶å™¨:

```
 import UIKit
    import AWSMobileClient

    class MainViewController: UIViewController {

        @IBOutlet weak var logOutButton: UIButton!

        @IBAction func logOut(_ sender: Any) {
            AWSMobileClient.sharedInstance().signOut() { error in
                if let error = error {
                    print(error)
                    return
                }
            }

            let loginViewController = LoginViewController()
            UIApplication.setRootView(loginViewController)
        }

    } 
```

å½“ *signOut()* åŠ¨ä½œå®Œæˆæ—¶ï¼Œæ˜¾ç¤ºç™»å½•å±å¹•ã€‚

## [](#conclusion)**ç»“è®º**

å°±æ˜¯è¿™æ ·ï¼å®ƒåªæ˜¯ä¼—å¤šç»„ä»¶ä¸­çš„ä¸€ä¸ªã€‚

å°±å¼€å‘é€Ÿåº¦å’Œå¯é æ€§è€Œè¨€ï¼ŒAmplify åº“æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ¸¸æˆè§„åˆ™æ”¹å˜è€…ã€‚ä¸‹ä¸€æ­¥å°†æ˜¯ä½¿ç”¨å’Œå¤„ç†å…¶ä»– AWS æœåŠ¡ï¼Œå¦‚å­˜å‚¨ã€æ¨é€é€šçŸ¥æˆ– APIã€‚

ä¸“æ³¨äºå®ç°ç‰¹æ€§è€Œä¸æ˜¯åº“çœŸçš„å¾ˆå¥½ã€‚

*   github link[calin crist/AWS _ amplify _ integration](https://github.com/calincrist/aws_amplify_integration.git)