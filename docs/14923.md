# æˆ‘çš„ä¸€ç³»åˆ—ä¸å¹¸çš„é”™è¯¯(åœ¨å†™æµ‹è¯•æ—¶)

> åŸæ–‡:[https://dev . to/briwa/a-series-of-my-successful-missons-when-writing-tests-h8m](https://dev.to/briwa/a-series-of-my-unfortunate-mistakes-when-writing-tests-h8m)

å¾ˆä¹…ä»¥å‰ï¼Œå½“æˆ‘å¼€å§‹å†™æµ‹è¯•çš„æ—¶å€™(å®é™…ä¸Šï¼Œä¸æ˜¯å¾ˆä¹…ï¼Œå¯èƒ½æ˜¯å‡ å¹´å‰)ï¼Œæˆ‘æ˜¯ä¸€ä¸ªå¤©çœŸçš„å¹´è½»äººã€‚æˆ‘è®¨åŒ bug æ‰€ä»¥æˆ‘å†™æµ‹è¯•ï¼Œè€Œä¸”æ˜¯æ ¹æ®æˆ‘å½“æ—¶æœ‰é™çš„çŸ¥è¯†å†™çš„ã€‚

å¤©çœŸå’Œä¸äº†è§£æœ€æ–°çš„å‚è€ƒèµ„æ–™æ˜¯æœ‰ä»£ä»·çš„ã€‚ä»æ¯ä¸€ä¸ªè¢«æ‹’ç»çš„å…¬å…³å®¡æŸ¥æˆ–å›å½’é”™è¯¯ä¸­ï¼Œæˆ‘ä»æˆ‘çš„é”™è¯¯ä¸­å­¦åˆ°äº†å¾ˆå¤šï¼Œè¿™è®©æˆ‘æ„è¯†åˆ°æˆ‘è¿˜æœ‰å¾ˆå¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œä¸å¾—ä¸é€šè¿‡å°è¯•å’Œé”™è¯¯æ¥å­¦ä¹ ç¡®å®æ˜¯ä¸å¹¸çš„ï¼Œä½†å¯¹ä½ æ¥è¯´ä¸ä¸€å®šæ˜¯ä¸å¹¸çš„ï¼

æˆ‘è¯´ï¼Œå¼€å‘äººå‘˜ä»¬ï¼Œå¦‚æœä½ ä»¬è§‰å¾—ä½ ä»¬çš„æµ‹è¯•ä¸å¤Ÿå¥½ï¼Œæˆ–è€…ä½ ä»¬çš„ PRs ç”±äºæµ‹è¯•è´¨é‡çš„ç¼ºä¹è€Œè¢« QA å›¢é˜Ÿæ‹’ç»äº†å¤ªå¤šæ¬¡ï¼Œä¹Ÿè®¸ä½ ä»¬ä¼šå‘ç°è¿™ç¯‡æ–‡ç« å¾ˆæœ‰ç”¨ã€‚æˆ‘å°†ä¸ä½ åˆ†äº«æˆ‘åœ¨ç¼–å†™æµ‹è¯•æ—¶çŠ¯çš„äº”å¤§é”™è¯¯ï¼Œä»¥åŠä¸ºä»€ä¹ˆä½ åº”è¯¥é¿å…å®ƒä»¬ã€‚

* * *

åœ¨æ­¤ä¹‹å‰ï¼Œå£°æ˜:ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯ä½¿ç”¨ Jest ä½œä¸ºæµ‹è¯•æ¡†æ¶ç”¨ Javascript ç¼–å†™çš„ã€‚æˆ‘çš„é‡ç‚¹åªæ˜¯ Javascriptï¼Œæ‰€ä»¥æˆ‘ä¸èƒ½å¯¹å…¶ä»–çš„åšå¤ªå¤šè¯„è®ºï¼Œä¸ç¡®å®šå®ƒæ˜¯å¦å¯ä»¥åº”ç”¨ã€‚æ­¤å¤–ï¼Œè¿™äº›åªæ˜¯ç®€åŒ–çš„ç¤ºä¾‹ï¼Œå¹¶ä¸ä»£è¡¨å®é™…çš„ä½¿ç”¨æ¡ˆä¾‹ã€‚åªæ˜¯ä¸ºäº†è®©å¤§å®¶æ˜ç™½è¿™ä¸€ç‚¹ã€‚

å¥½å§ã€‚ç›´æ¥çœ‹è¿™ä¸ªä¾‹å­ã€‚æŒ‰è¯´æˆ‘åœ¨å†™è¿™ä¸ªç±»:

```
class Account {
  constructor (initialBalance = 0) {
    this.balance = initialBalance
  }

  deposit (money) {
    this.balance += money
  }

  withdraw (money) {
    this.balance -= money
  }
} 
```

ç°åœ¨ï¼Œè¿™ä¸ªç±»å¾ˆç®€å•ã€‚å®ƒæœ‰åŠæ³•å­˜å…¥å’Œå–å‡ºä¸€ç¬”é’±æ¥æ”¹å˜æ”¶æ”¯å¹³è¡¡ã€‚æˆ‘ç¼–å†™æµ‹è¯•çš„æ—…ç¨‹ä»è¿™é‡Œå¼€å§‹ã€‚

## [](#1-not-keeping-the-test-simple)1ã€‚æµ‹è¯•ä¸ç®€å•

æˆ‘æƒ³æµ‹è¯•çš„ç¬¬ä¸€ä»¶äº‹æ˜¯`.deposit`æ–¹æ³•ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œæµ‹è¯•å¿…é¡»éå¸¸å…·ä½“ï¼Œå…¶ä»–é˜…è¯»æµ‹è¯•çš„äººç”šè‡³ä¸éœ€è¦çœ‹åˆ°å®é™…çš„ä»£ç ã€‚

```
const account = new Account()

describe('Account class', () => {
  describe('.deposit', () => {
    test('Should increment the account balance by the amount', () => {
      const increment = 200
      const originalBalance = account.balance
      account.deposit(increment)
      expect(account.balance).toBe(originalBalance + increment)
    })
  })
}) 
```

æµ‹è¯•çœ‹èµ·æ¥ä¸é”™ï¼Œå¯¹å§ï¼Ÿå®ƒæœ‰åŸå§‹ä½™é¢ï¼Œå®ƒæœ‰è¦å¢åŠ çš„é‡‘é¢ï¼Œå®ƒæ–­è¨€åŸå§‹ä½™é¢åŠ ä¸Šå¢é‡ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæˆ‘æƒ³æ”¹å˜å¢é‡çš„æ•°é‡ï¼Œæˆ‘åªéœ€è¦æ”¹å˜`increment`å˜é‡ï¼Œæµ‹è¯•ä»ç„¶ä¼šé€šè¿‡ã€‚å°±æ˜¯è¿™æ ·ã€‚è¶…çº§ç®€å•ã€‚

ç„¶åå‡ºç°äº†ä¸€ä¸ªæ–°çš„è¦æ±‚ã€‚ä½œä¸ºå¥–åŠ±ï¼Œæ¯å­˜å…¥ä¸€ç¬”é‡‘é¢ï¼Œéƒ½ä¼šåœ¨é‡‘é¢çš„åŸºç¡€ä¸Šå¢åŠ  2%(ä¸è¦é—®æˆ‘ä¸ºä»€ä¹ˆï¼Œè¿™æ˜¯ PM...).

```
 deposit (money) {
    this.balance += (money * 1.02)
  } 
```

å—¯ï¼Œæ˜¯çš„ï¼Œå¥½å§ã€‚æ‰€ä»¥æµ‹è¯•åº”è¯¥æ˜¯....

```
 test('Should increment the account balance by the amount plus 2% incentive', () => {
      const increment = 200
      const originalBalance = account.balance
      // PLEASE SEE TEH CODE FOR THE CLASS FOR REFERENCE
      const incrementPlusIncentive = increment * 1.02
      account.deposit(increment)
      expect(account.balance).toBe(originalBalance + incrementPlusIncentive)
    }) 
```

å¤©å•Šï¼Œè¿™æ˜¯ä»€ä¹ˆæ€ªç‰©ï¼Ÿæˆ‘çš„æƒ³æ³•æ˜¯æŠŠå®ƒå¼„æ¸…æ¥šï¼Œä½†æˆ‘æœ€ç»ˆæŠŠå®ƒå¼„å¾—æ›´å¤æ‚äº†ã€‚æ­¤å¤–ï¼Œæˆ‘å°†ä»£ç ä¸­çš„é€»è¾‘å¤åˆ¶åˆ°æµ‹è¯•ä¸­ã€‚è¿™æ˜¯ä¸å¯¹çš„ã€‚

å®é™…ä¸Šï¼Œæµ‹è¯•ä»£ç åº”è¯¥åªæ˜ç¡®åœ°é™ˆè¿°ä½ æ­£åœ¨æµ‹è¯•çš„å†…å®¹(è¾“å…¥->è¾“å‡º)ã€‚é‚£é‡Œä¸åº”è¯¥æœ‰é€»è¾‘ä»£ç ï¼›å®ƒå±äºä½ æ­£åœ¨æµ‹è¯•çš„ä»£ç ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œä¸€ä¸ªæ”¹è¿›çš„ç‰ˆæœ¬åº”è¯¥æ˜¯:

```
 test('Should increment the account balance by the amount plus 2% incentive', () => {
      account.deposit(100)
      expect(account.balance).toBe(102)
    }) 
```

ç»™ä½ ã€‚ä¿æŒç®€å•ã€‚æˆ‘å­˜äº† 100 è‹±é•‘ï¼Œç°åœ¨æˆ‘çš„ä½™é¢æ˜¯ 102 è‹±é•‘ã€‚ç¬¦åˆè¦æ±‚å—ï¼Ÿç»å¯¹çš„ï¼è¿™æ‰æ˜¯æœ€é‡è¦çš„ã€‚

## [](#2-not-maintaining-a-clean-state-on-each-tests)2ã€‚æ¯æ¬¡æµ‹è¯•éƒ½æ²¡æœ‰ä¿æŒå¹²å‡€çš„çŠ¶æ€

æˆ‘çš„ä¸‹ä¸€ä¸ªä»»åŠ¡æ˜¯ç¼–å†™æµ‹è¯•çš„å‰©ä½™éƒ¨åˆ†ã€‚çš„ç¡®å¦‚æ­¤ã€‚

```
const account = new Account()

describe('Account class', () => {
  describe('.deposit', () => {
    test('Should increment the account balance by the amount plus 2% incentive', () => {
      account.deposit(100)
      expect(account.balance).toBe(102)
    })
  })

  describe('.withdraw', () => {
    test('Should decrement the account balance by the amount', () => {
      account.withdraw(100)
      expect(account.balance).toBe(2)
    })
  })
}) 
```

å—¯ï¼Œæ˜¯çš„ï¼Œçœ‹èµ·æ¥ä¸é”™ã€‚ç„¶è€Œï¼Œä½ ä»¬ä¸­çš„ä¸€äº›äººå¯èƒ½å·²ç»æ³¨æ„åˆ°äº†:æœ‰ä¸€è‚¡ä»£ç çš„å‘³é“ã€‚ä¸ºä»€ä¹ˆæµ‹è¯•å…±äº«ä¸€ä¸ª`account`å®ä¾‹ï¼Ÿè¿™éš¾é“ä¸ä¼šè®©æµ‹è¯•çš„é¡ºåºå˜å¾—é‡è¦å—ï¼Ÿå¦‚æœæˆ‘ä»¬è°ƒæ¢é¡ºåºï¼Œå®ƒè‚¯å®šä¼šåæ‰ã€‚è¿™æ˜¯ä¸å¯¹çš„ã€‚

```
describe('Account class', () => {
  describe('.deposit', () => {
    test('Should increment the account balance by the amount plus 2% incentive', () => {
      const account = new Account()
      account.deposit(100)
      expect(account.balance).toBe(102)
    })
  })

  describe('.withdraw', () => {
    test('Should decrement the account balance by the amount', () => {
      const account = new Account()
      account.withdraw(100)
      expect(account.balance).toBe(-100)
    })
  })
}) 
```

é€šè¿‡åœ¨æ¯ä¸ªæµ‹è¯•ä¸­åˆ›å»º`account`å®ä¾‹ï¼Œå¯ä»¥ç¡®ä¿æµ‹è¯•ä»ä¸€ä¸ªå¹²å‡€çš„çŸ³æ¿å¼€å§‹ã€‚å®ƒå¯ä»¥éšæ„ä¿®æ”¹ï¼Œå› ä¸ºå®ƒåŒ…å«åœ¨ç‰¹å®šæµ‹è¯•çš„èŒƒå›´å†…ï¼Œå¹¶ä¸”æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚è¿™æ ·ï¼Œæµ‹è¯•çš„é¡ºåºå°±æ— å…³ç´§è¦äº†ã€‚æ¯”æ–¹è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¹¶è¡Œè¿è¡Œçš„æµ‹è¯•è¿è¡Œç¨‹åºï¼Œå¹¶éšæœºå®‰æ’æµ‹è¯•çš„é¡ºåºï¼Œå®ƒä»ç„¶ä¼šé¡ºåˆ©é€šè¿‡ã€‚

é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿˜æœ‰ [`beforeEach/afterEach`(æˆ–`setup/teardown` )](https://jestjs.io/docs/en/setup-teardown.html) åŠ©æ‰‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨å®ƒæ¥åˆå§‹åŒ–å’Œæ¸…ç†æ¯ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œä½†åœ¨è¿™é‡Œè§£é‡Šèµ·æ¥ç›¸å½“å¤æ‚ï¼Œæ‰€ä»¥å¯èƒ½ä¼šåœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»ã€‚

## [](#3-not-asserting-the-state-properly)3ã€‚æ²¡æœ‰æ­£ç¡®åœ°å£°æ˜çŠ¶æ€

æ¥ä¸‹æ¥ï¼Œè¿™ä¸ªé¡¹ç›®å˜å¤§äº†ï¼Œæ˜¾ç„¶æœ‰ä¸€äº›å†…åŠ¡å¤„ç†åœ¨è¿›è¡Œï¼Œç°åœ¨æ‰€æœ‰çš„ä»£ç éƒ½è¦è¢«æ³¨é‡Šï¼Œæ”¾å…¥ä¸€ä¸ªåˆé€‚çš„æ–‡ä»¶ç­‰ç­‰ã€‚

```
/**
 * Account class.
 */
class Account {
  /**
   * Constructor function.
   * 
   * This sets the initial balance when initializing the instance.
   * 
   * @param {Number} initialBalance 
   */
  constructor (initialBalance = 0) {
    this.balance = initialBalance
  }

  /**
   * Increment the balance by the given sum of the amount.
   * An incentive of 2% of the amount will be added
   * for each deposited amount.
   * 
   * @param {Number} money 
   */
  public deposit (money) {
    this.balance = (money * 1.02)
  }

  /**
   * Decrement the balance by the given amount.
   * 
   * @param {Number} money 
   */
  public withdraw (money) {
    this.balance -= money
  }
} 
```

å¥½äº†ï¼Œå®Œæˆäº†ã€‚æˆ‘æ²¡æœ‰æ³¨æ„åˆ°ä»»ä½•é—®é¢˜(æˆ–è€…æˆ‘æœ‰å—ï¼ŸğŸ˜ä½ å¾ˆå¿«å°±ä¼šçŸ¥é“äº†)ã€‚æˆ‘æ£€æŸ¥äº† Jest æ§åˆ¶å°ï¼Œå®ƒè¯´...

```
Account class
  .deposit
    âœ“ Should increment the account balance by the amount plus 2% incentive (5ms)
  .withdraw
    âœ“ Should decrement the account balance by the amount 
```

å¾ˆæ˜æ˜¾ï¼Œè¿˜æ²¡é€šè¿‡ã€‚å’„ã€‚æäº¤ã€PR å®¡æŸ¥ã€CI æ„å»ºé€šè¿‡ã€åˆå¹¶å’Œéƒ¨ç½²ã€‚é‚£æ˜¯ä¸€ä¸ªæœ‰è¶£çš„æ˜ŸæœŸä¸€ã€‚

...ä½†ä¹Ÿä¸å°½ç„¶ã€‚ç”¨æˆ·å°–å«ç€è¯´ä»–ä»¬çš„ä½™é¢è¢«é‡ç½®ä¸ºä»–ä»¬å­˜å…¥çš„é‡‘é¢ã€‚å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿå½“æµ‹è¯•é€šè¿‡æ—¶ï¼Œè¿™æ˜¯æ€ä¹ˆå‘ç”Ÿçš„ï¼Ÿ

æˆ‘çœ‹äº†çœ‹æˆ‘çš„ä»£ç ï¼Œçœ‹äº†çœ‹æµ‹è¯•ï¼Œä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚æ˜¯åˆå§‹ä½™é¢å—ï¼Ÿå› ä¸ºæˆ‘æ²¡æœ‰ä¸ºæ­¤è¿›è¡Œæµ‹è¯•(å“å‘€)ã€‚æ‰€ä»¥æˆ‘ç»§ç»­æ›´æ–°æµ‹è¯•å¦‚ä¸‹:

```
 describe('.deposit', () => {
    test('Should increment the account balance by the amount plus 2% incentive', () => {
      const account = new Account(100)

      account.deposit(100)
      expect(account.balance).toBe(202)
    })
  }) 
```

ç§ï¼Œä¸ä»…ä»…æ˜¯ç”¨æˆ·ï¼ŒJest ç°åœ¨ä¹Ÿåœ¨å°–å«(ï¼Ÿ)

```
 â— Account class â€º .deposit â€º Should increment the account balance 
    by the amount plus 2% incentive

    expect(received).toBe(expected) // Object.is equality

    Expected: 202
    Received: 102

      11 |
      12 |       account.deposit(100)
    > 13 |       expect(account.balance).toBe(202)
         |                               ^
      14 |     })
      15 |   })
      16 |

      at Object.toBe (__tests__/index.test.js:13:31) 
```

bug å‡ºç°äº†ï¼è¿™æ­£æ˜¯ç”¨æˆ·æŠ¥å‘Šçš„å†…å®¹ã€‚ç°åœ¨æµ‹è¯•å®é™…ä¸Šå¤±è´¥äº†ã€‚åœ¨æŸ¥çœ‹ä»£ç å(æ‚¨å¯ä»¥ä¸æœ¬èŠ‚å¼€å¤´çš„ä»£ç è¿›è¡Œæ¯”è¾ƒ)ï¼Œæˆ‘æ³¨æ„åˆ°äº†ä¸€ä¸ªå°é”™è¯¯:

```
 deposit (money) {
    // The plus was missing ğŸ¤®
    this.balance += (money * 1.02)
  } 
```

æ˜¯çš„ï¼Œç»™ä½ ã€‚ä¸€ä¸ªè¢«è®¤ä¸ºæ— å®³çš„é‡æ„å¯¼è‡´äº†ä¸€ä¸ª bugï¼Œå¯èƒ½åŠ å·è¢«æ„å¤–åˆ é™¤äº†ã€‚è€Œä¸”æµ‹è¯•ä¹ŸæŠ“ä¸ä½ã€‚æˆ‘åº”è¯¥ä¸€å¼€å§‹å°±ç”¨æ­£ç¡®çš„æ–¹å¼å†™å‡ºæ¥ã€‚

å¦‚æœä»£ç æ˜¯å…³äºå€¼çš„ç´¯åŠ (è€Œä¸æ˜¯å€¼çš„èµ‹å€¼)ï¼Œé‚£ä¹ˆå®ƒ*æœ‰*è¦ä»¥è¿™æ ·çš„æ–¹å¼è¿›è¡Œæµ‹è¯•ï¼Œå³å…ˆå‰çš„å€¼ä¸ç»™å®šçš„å€¼ç´¯åŠ ã€‚å‰é¢çš„æ–­è¨€æœ‰äº›ä¸å®Œæ•´ï¼Œå› ä¸ºå®ƒåªæ˜¯åœ¨æµ‹è¯•èµ‹å€¼ã€‚

```
 // ğŸ¤” 
  describe('.deposit âŒ', () => {
    test('Should increment the account balance by the amount plus 2% incentive', () => {
      const account = new Account() //... What's the previous value?

      account.deposit(100) // Amount is 100
      expect(account.balance).toBe(102) // Final value is 102...?
    })
  })

  // ğŸ˜
  describe('.deposit âœ…', () => {
    test('Should increment the account balance by the amount plus 2% incentive', () => {
      const account = new Account(100) // Previous value is 100

      account.deposit(100) // Amount is 100
      expect(account.balance).toBe(202) // Final value is 202
    })
  }) 
```

ä¸ºäº†æ‰“å¥½è¿™ä¸ªç»“ï¼Œè¿˜å¿…é¡»æµ‹è¯•æ„é€ å‡½æ•°ã€‚è¿™ç¡®ä¿äº†å®ä¾‹åŒ–éƒ¨åˆ†è¢«æ­£ç¡®åœ°è¦†ç›–(ä¹Ÿè®¸å¦‚æœæ„é€ å‡½æ•°æœ‰ä¸€äº›é€»è¾‘ï¼Œå®ƒä¹Ÿå¯ä»¥è¢«æ–­è¨€)ã€‚

```
 describe('constructor', () => {
    test('Should set the initial balance when instantiated', () => {
      const account = new Account(100)
      expect(account.balance).toBe(100)
    })
  }) 
```

ä¹Ÿè®¸è¿™ä¸€èŠ‚ç›¸å½“å…·ä½“ï¼Œä½†é‡ç‚¹æ˜¯ï¼Œæ€»æ˜¯æµ‹è¯•çŠ¶æ€çš„æ•´ä¸ªæµç¨‹(ä¹‹å‰/ä¹‹åï¼ŒI/O)ï¼Œè€Œä¸ä»…ä»…æ˜¯éƒ¨åˆ†ã€‚è‡³å°‘è¿™æ˜¯æˆ‘å­¦åˆ°çš„ã€‚

## [](#4-not-structuring-the-tests-properly)4ã€‚æ²¡æœ‰æ°å½“åœ°ç»„ç»‡æµ‹è¯•

æˆ‘ä» QA å›¢é˜Ÿé‚£é‡Œå¾—çŸ¥ï¼Œæˆ‘æ²¡æœ‰æ­£ç¡®åœ°æ•æ‰åˆ°è¾¹ç¼˜æ¡ˆä¾‹ã€‚`.deposit`ä¸­çš„å€¼å¯ä»¥æ˜¯ä»»ä½•å€¼ï¼Œå¹¶ä¸”é”™è¯¯ä¸å¤Ÿç›´è§‚ã€‚

æ­¤å¤–ï¼Œæ–°çš„è¦æ±‚æ¥äº†:è¯¥å¸æˆ·åº”è¯¥èƒ½å¤Ÿå­˜æ¬¾è¶…è¿‡ä¸€ä¸ªå•ä¸€çš„æ•°é¢ï¼Œç„¶åä½œå‡ºäº†ä¸€ç¬”ã€‚

å¥½å§ã€‚`.deposit`ä»£ç ç°åœ¨çœ‹èµ·æ¥åƒè¿™æ ·:

```
 /**
   * Increment the balance by the given sum of the amount.
   * An incentive of 2% of the amount will be added
   * for each deposited amount.
   * Only number is allowed, otherwise an error is thrown.
   * Also, the number should be greater than 0.
   * 
   * @param {Number[]} ...args 
   */
  deposit (...args) {
    if (args.length === 0) {
      throw new Error('Please provide at least one argument.')
    }

    const amount = args.reduce((total, value) => {
      const number = parseInt(value, 10)
      if (isNaN(number)) {
        throw new Error('Please specify a number as the argument.')
      }

      if (number <= 0) {
        throw new Error('Please specify a number greater than 0.')
      }

      return total + (number * 1.02)
    })

    this.balance += amount
  } 
```

...ä½†æ˜¯æµ‹è¯•çœ‹èµ·æ¥å¹¶ä¸é‚£ä¹ˆå¥½

```
 describe('.deposit', () => {
    test('Should throw an error when no amount is given', () => {
      const account = new Account()
      expect(() => account.deposit()).toThrowError('Please provide at least one argument.')
    })

    test('Should throw an error when amount given is not a number', () => {
      const account = new Account()
      expect(() => account.deposit('a', 'b', 'c')).toThrowError('Please specify a number as the argument.')
    })

    test('Should increment the account balance by the sum of the amount plus 2% incentive, only when the amount is greater than 0 otherwise it should throw', () => {
      const account = new Account(100)

      account.deposit(100, 200)
      expect(account.balance).toBe(406)

      // ...but not less than 0!
      expect(() => account.deposit(0, 400, -200)).toThrowError('Please specify a number greater than 0.')
    })
  }) 
```

å“‡ï¼Œè€ƒè¯•çš„æœ€åä¸€éƒ¨åˆ†ç›¸å½“éš¾ã€‚æ— è®ºä»€ä¹ˆğŸ™„ã€‚ä»»åŠ¡å®Œæˆäº†ï¼Œæµ‹è¯•é€šè¿‡äº†ã€‚

```
 .deposit
    âœ“ Should throw an error when no amount is given (4ms)
    âœ“ Should throw an error when amount given is not a number (1ms)
    âœ“ Should increment the account balance by the sum of the amount plus 2% incentive, only when the amount is greater than 0 otherwise it should throw (5ms) 
```

ç„¶è€Œï¼ŒQA å›¢é˜Ÿè¯´æµ‹è¯•ä¸€å›¢ç³Ÿï¼å¾ˆéš¾ç†è§£ï¼Œæœ€åä¸€éƒ¨åˆ†æµ‹è¯•åšçš„å¤ªå¤šäº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ€å¥½å°†æµ‹è¯•åˆ’åˆ†åˆ°å¤šä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™æ ·å°±æœ‰å¤šå±‚æ¡ä»¶è¦æ–­è¨€ï¼Œå¹¶ä¸”ä¸€ä¸ªæµ‹è¯•åº”è¯¥ç®€å•åœ°åŸºäºä¸Šä¸‹æ–‡åšä¸€ä»¶äº‹æƒ…ã€‚

ä¸€ä¸ªæ”¹è¿›çš„ç‰ˆæœ¬å°†æ˜¯:

```
 describe('.deposit', () => {
    describe('When no argument is provided', () => {
      test('Should throw an error', () => {
        const account = new Account()
        expect(() => account.deposit()).toThrowError('Please provide at least one argument.')
      })
    })

    describe('When the arguments are provided', () => {
      describe('And the arguments are invalid', () => {
        test('Should throw an error', () => {
          const account = new Account()
          expect(() => account.deposit('a', 'b', 'c')).toThrowError('Please specify a number as the argument.')
        })
      })

      describe('And the arguments are valid', () => {
        describe('And the arguments are less than zero', () => {
          test('Should throw an error', () => {
            const account = new Account()
            expect(() => account.deposit(0, 400, -200)).toThrowError('Please specify a number greater than 0.')
          })
        })

        describe('And the arguments are all more than zero', () => {
          test('Should increment the account balance by the sum of the amount plus 2% incentive', () => {
            const account = new Account(100)
            expect(account.balance).toBe(100)

            account.deposit(100, 200)
            expect(account.balance).toBe(406)
          })
        })
      })
    })
  }) 
```

å½“ä»£ç å˜å¾—æ›´åŠ å¤æ‚æ—¶ï¼Œå¤šå±‚ä¸Šä¸‹æ–‡éå¸¸æœ‰ç”¨ã€‚å½“å®ƒå·²ç»åƒé‚£æ ·è¢«åˆ†å‰²æˆå±‚æ—¶ï¼Œæ·»åŠ æ›´å¤šçš„ä¸Šä¸‹æ–‡å°±æ›´å®¹æ˜“äº†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘è¦æ·»åŠ ä¸€ä¸ªæ–°çš„éªŒè¯(ä¹Ÿè®¸åº”è¯¥æœ‰ä¸€ä¸ªå­˜æ”¾çš„æœ€å¤§æ•°é‡)ï¼Œå¹¶ä¸”æˆ‘åº”è¯¥ä¸ºæ­¤æ·»åŠ ä¸€ä¸ªæµ‹è¯•ï¼Œæˆ‘çŸ¥é“åº”è¯¥æŠŠå®ƒä»¬æ”¾åœ¨ç»“æ„ä¸­çš„ä»€ä¹ˆåœ°æ–¹ï¼Œæ•´æ´ç¾è§‚ã€‚

å±‚çš„é¡ºåºä¸»è¦æ˜¯æˆ‘çš„åå¥½ã€‚æˆ‘å–œæ¬¢åœ¨é¡¶éƒ¨çœ‹åˆ°è¾¹ç¼˜æƒ…å†µï¼Œåœ¨åº•éƒ¨çœ‹åˆ°å®é™…çš„é€»è¾‘ï¼Œæœ‰ç‚¹åƒä»£ç ä¸­å¦‚ä½•ç¼–å†™ä¿æŠ¤(æˆ–å®é™…çš„éªŒè¯)ã€‚

ä¸‹é¢æ˜¯ Jest è¾“å‡ºçš„æ ·å­:

```
 .deposit
    When no argument is provided
      âœ“ Should throw an error (7ms)
    When the arguments are provided
      And the arguments are invalid
        âœ“ Should throw an error (2ms)
      And the arguments are valid
        And the arguments are less than zero
          âœ“ Should throw an error (2ms)
        And the arguments are all more than zero
          âœ“ Should increment the account balance by the sum of the amount plus 2% incentive (2ms) 
```

ç°åœ¨æˆ‘ä¸å¾—ä¸åŒæ„ QA å›¢é˜Ÿçš„è§‚ç‚¹ã€‚

## [](#5-not-trusting-the-libraries-youre-using)5ã€‚ä¸ä¿¡ä»»æ‚¨æ­£åœ¨ä½¿ç”¨çš„åº“

åˆ©ç›Šç›¸å…³è€…è¯´ï¼Œæœ‰é»‘å®¢ä»è´¦æˆ·ä¸­æå–ä¸å±äºä»–ä»¬çš„é’±ã€‚ç”±äºè¿™ä¸ªé—®é¢˜ï¼Œ`.withdraw`å‡½æ•°ä¸ä¼šç®€å•åœ°æ‰£é™¤ä½™é¢ï¼›å®ƒå¿…é¡»é€šè¿‡ä¸€äº›éªŒè¯è„šæœ¬é­”æœ¯ï¼Œä»¥ä¾¿å®ƒçŸ¥é“å®ƒæ˜¯å¦è¢«é»‘å®¢ç¯¡æ”¹(æˆ‘ä¸çŸ¥é“å¦‚ä½•ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç )ã€‚

```
 /**
   * Decrement the balance by the given amount.
   * It is now using a validator from backend
   * which I don't know how it works.
   * 
   * @param {Number} money 
   */
  withdraw (money) {
    const currentBalance = this.validateAndWithdraw(money)
    this.balance = currentBalance
  }

  validateAndWithdraw (money) {
    // This validator might throw an error if the transaction is invalid!!!
    return superDuperValidatorFromBackend(money)
  } 
```

ç”±äºåœ¨ Jest ä¸­å®é™…è¿è¡Œå®ƒçš„æ˜‚è´µæˆæœ¬ï¼Œæˆ‘å®æ„¿å˜²ç¬‘åšéªŒè¯çš„å‡½æ•°ã€‚åªè¦å®ƒä¸ä¼šç»™æˆ‘ä¸€ä¸ªé”™è¯¯ï¼Œå¹¶ç»™æˆ‘å®é™…çš„å¹³è¡¡ï¼Œå®ƒåº”è¯¥æ˜¯å¥½çš„ã€‚

```
 describe('.withdraw', () => {
    describe('Given a valid withdrawal', () => {
      test('Should set the balance after withdrawal', () => {
        const account = new Account(300)

        // Override this function to avoid having to actually request from backend.
        // It should just return the balance without any error thrown.
        jest.spyOn(account, 'validateAndWithdraw').mockImplementationOnce(() => 200)

        expect(() => account.withdraw(100)).not.toThrow()
        expect(account.validateAndWithdraw).toHaveBeenCalledWith(100)
        expect(account.balance).toBe(200)
      })
    })
  }) 
```

æˆ‘åœ¨é‚£é‡Œæ·»åŠ äº†`not.toThrow()`,è¿™æ ·æˆ‘å°±çŸ¥é“å½“æˆ‘è°ƒç”¨`.withdraw`å‡½æ•°æ—¶ï¼Œä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºæˆ‘å˜²ç¬‘äº†å®ƒã€‚å¯¹å—ï¼Ÿå¯¹å—ï¼Ÿ

> ä¸å¯¹ã€‚-è´¨é‡ä¿è¯å›¢é˜Ÿ

æœ€ç»ˆï¼Œæˆ‘äº†è§£åˆ°æˆ‘å†™çš„æµ‹è¯•åº”è¯¥åªè¦†ç›–æˆ‘çš„ä»£ç çš„ä¸šåŠ¡é€»è¾‘ã€‚æµ‹è¯•å®ƒæ˜¯å¦è¢«æŠ›å‡ºä¸åº”è¯¥æ˜¯æˆ‘æµ‹è¯•çš„è´£ä»»ï¼Œå› ä¸ºå‡½æ•°å®ç°å·²ç»è¢« Jest å˜²è®½äº†ï¼Œæ­£å¦‚æˆ‘åœ¨æµ‹è¯•ä¸­æŒ‡å®šçš„é‚£æ ·ï¼Œè¿™æ ·é”™è¯¯å°±ä¸ä¼šè¢«æŠ›å‡ºã€‚ä¸éœ€è¦æ–­è¨€å®ƒè¯¥ä¸è¯¥æ‰”ï¼Œå› ä¸ºå®ƒç»å¯¹ä¸ä¼šæ‰”ï¼

> ...ä½†æ˜¯ä½ æ€ä¹ˆèƒ½è¿™ä¹ˆç¡®å®šå‘¢ï¼Ÿ-æˆ‘ç¬¨æ‹™çš„æµ‹è¯•æŠ€å·§

ä½ å¯ä»¥éšæ—¶æ£€æŸ¥ Jest çš„çŸ¥è¯†åº“ã€æºä»£ç ä»¥åŠä»–ä»¬æ˜¯å¦‚ä½•æµ‹è¯•å®ƒä»¬çš„ï¼Œä»¥åŠå®ƒæ˜¯å¦é€šè¿‡äº†æµ‹è¯•ã€‚ç”šè‡³å¯èƒ½æœ‰ç¡®åˆ‡çš„ä»£ç ï¼Œè°çŸ¥é“å‘¢ã€‚å…³é”®æ˜¯ï¼Œæˆ‘å¿…é¡»ä¿¡ä»»æˆ‘æ­£åœ¨ä½¿ç”¨çš„åº“ï¼Œç¡®ä¿ä»–ä»¬çš„ä»£ç å·¥ä½œæ˜¯ä»–ä»¬çš„æµ‹è¯•è´£ä»»ï¼Œè€Œä¸æ˜¯æˆ‘çš„ã€‚æˆ‘çš„æµ‹è¯•åº”è¯¥é›†ä¸­åœ¨æˆ‘ä»£ç çš„å®é™…é€»è¾‘ä¸Šã€‚

```
 describe('.withdraw', () => {
    describe('Given a valid withdrawal', () => {
      test('Should set the balance after withdrawal', () => {
        const account = new Account(300)

        // Override this function to avoid having to actually request from backend.
        // It should just return the balance without any error thrown.
        jest.spyOn(account, 'validateAndWithdraw').mockImplementationOnce(() => 200)

        account.withdraw(100)
        expect(account.validateAndWithdraw).toHaveBeenCalledWith(100)
        expect(account.balance).toBe(200)
      })
    })
  }) 
```

å°±æ˜¯è¿™æ ·ã€‚åªå…è®¸ä¸šåŠ¡é€»è¾‘ã€‚

* * *

ç°åœ¨ï¼Œæˆ‘çš„æ—…ç¨‹åˆ°æ­¤ç»“æŸã€‚è°çŸ¥é“æœªæ¥ä¼šå‘ç”Ÿä»€ä¹ˆ(é”™è¯¯)...

æ­¤å¤–ï¼Œå…¶ä¸­ä¸€äº›é”™è¯¯å¯èƒ½å¾ˆæ˜æ˜¾ã€‚ä½†æ˜¯è¿™äº›è§‚ç‚¹ä»ç„¶æœ‰æ•ˆã€‚æˆ‘åªæ˜¯æƒ³åˆ†äº«ä¸€ä¸‹ã€‚å¦‚æœä½ å¯¹è¿™äº›å»ºè®®æœ‰ä»»ä½•åé¦ˆï¼Œæˆ–è€…ä¹Ÿè®¸è¿™æ ¹æœ¬ä¸æ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œè®©æˆ‘ä»¬åœ¨ä¸‹é¢çš„è¯„è®ºåŒºè®¨è®ºå§ã€‚

æˆ‘å¸Œæœ›ä½ å–œæ¬¢é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œè°¢è°¢ä½ ï¼

* * *

å°é¢å›¾ç‰‡ç”±[æ°ç±³è¡—](https://unsplash.com/@jamie452?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)åœ¨ [Unsplash](https://unsplash.com/search/photos/mistakes?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) æ‹æ‘„ã€‚