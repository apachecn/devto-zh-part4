# MongoDB å…¥é—¨æŒ‡å—ã€‚èšåˆ()

> åŸæ–‡:[https://dev . to/manda puttra/åˆå­¦è€…æŒ‡å—-on-mongodb-aggregate-337g](https://dev.to/mandaputtra/beginner-guide-on-mongodb-aggregate-337g)

è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ä»Šå¹´åœ¨ NoSQL æ•°æ®åº“ä¸Šçš„æ—…ç¨‹ï¼Œæ‰€ä»¥è¿™æ˜¯ä»åˆå­¦è€…åˆ°åˆå­¦è€…çš„æŒ‡å—ã€‚

MongoDB æˆ– NoSQL å·²ç»æˆä¸ºè¶‹åŠ¿ï¼Œä½†å‡ºäºæŸç§åŸå› ï¼Œæˆ‘ä»ç„¶å–œæ¬¢ SQL æ•°æ®åº“ã€‚ç„¶è€Œï¼ŒMongoDB æœ‰ä¸€ä¸ªå¾ˆæ£’çš„æŸ¥è¯¢è¯­æ³•(å°½ç®¡åœ¨æ€§èƒ½ç­‰æ–¹é¢)ã€‚)é‚£æˆ‘æ‰¿è®¤æˆ‘çˆ±ä¸Šäº†é‚£ä¸ªã€‚æˆ‘ä¸€ç›´åœ¨ä½¿ç”¨ MongoDBï¼Œç°åœ¨æˆ‘æƒ³åˆ†äº«ä¸€äº›ä½¿ç”¨ aggregate æŠ€å·§ï¼MongoDB ä¸­çš„å¼ºå¤§åŠŸèƒ½ã€‚

å“¦ï¼Œæ˜¯çš„ï¼Œä½ ä¼šå¯¹è¯­æ³•æ„Ÿåˆ°å›°æƒ‘ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·:

```
.aggregate([{{{{{{{{{ }}}}}}}}}]) // I love aggregate, better use your space and get ready 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨`$facet`ã€`$match`ã€`$unwind`ã€`$project`å’Œ`$group`ã€‚è¿™é‡Œå…ˆæä¾›ä¸€äº›æ•°æ®:

```
//  Just  a  simple  chat  schema  here  for  a  real-world  example  //  RoomID  for  chat  room  since  it  chatting  room  //  Clients  contains  all  clients  on  a  room  ~  {  "_id"  :  ObjectId("5d1449db6f934a2926c175d1"),  "clients"  :  [  "rooberduck@mail.com",  "sillybilly@mail.com"  ],  "roomId"  :  1,  "message"  :  [  {  "time"  :  ISODate("2019-06-27T04:44:49.528Z"),  "status"  :  "SEND",  "text"  :  "Hello!",  "sender"  :  "sillybilly@mail.com",  "receiver"  :  "rooberduck@mail.com",  "_id"  :  ObjectId("5d1449db6f934a2926c175d2")  },  {  "time"  :  ISODate("2019-06-27T04:54:49.528Z"),  "status"  :  "READ",  "text"  :  "Hello Wow Are You?",  "sender"  :  "rooberduck@mail.com",  "receiver"  :  "sillybilly@mail.com",  "_id"  :  ObjectId("5d1449ff6f934a2926c175d3")  }  ],  "__v"  :  0  ....  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#1st-case-get-all-message-from-one-user-and-return-his-last-message)ç¬¬ä¸€ç§æƒ…å†µ:è·å–ä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œå¹¶è¿”å›ä»–çš„æœ€åä¸€æ¡æ¶ˆæ¯

å¥½çš„ï¼Œä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ å¯ä»¥ä½¿ç”¨`$match: { clients: "sillybilly@mail.com" }`ï¼Œä½†æ˜¯å¦‚ä½•åªæ˜¾ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯ï¼Œä½ å¯ä»¥ä½¿ç”¨`$project`

åœ¨è¿™é‡Œï¼Œproject åªè·å–ä½ æ‰€è¯·æ±‚çš„å­—æ®µï¼Œä½¿ç”¨ aggregate å°±åƒä½¿ç”¨*æµ*æˆ–*ç®¡é“*ä¸€æ ·ï¼Œä½ åº”è¯¥å…³å¿ƒå®ƒçš„æ¯ä¸€æ­¥ã€‚

```
db.chat.aggregate([
  { $match: { clients: "sillybilly@mail.com" } },
  { $project: { _id: "$roomId", message: { $slice: ["$message", -1] } } }
])

// result
[{
    "_id" : 1,
    "message" : [
        {
            "time" : ISODate("2019-06-27T04:54:49.528Z"),
            "status" : "SEND",
            "text" : "Hello!",
            "sender" : "sillybilly@mail.com",
            "receiver" : "rooberduck@mail.com",
            "_id" : ObjectId("5d1449ff6f934a2926c175d3")
        }
    ]
}, ... more other result ] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥`$project`è·å–å…ˆå‰ç»“æœçš„å­—æ®µæˆ–ç»“æœå¹¶æŠ•å½±å®ƒï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨â€œ$â€è·å¾—ç»“æœçš„å…ˆå‰å€¼ï¼Œåªè¦å®ƒä¸ç»“æœå­—æ®µçš„åŒ¹é…ã€‚

â€œä½†æ˜¯æ•°æ®æ€ä¹ˆä¼šæ²¡é—®é¢˜å‘¢ï¼Ÿä½ åªæœ‰ä¸€æ¡ä¿¡æ¯ï¼Œä¸ºä»€ä¹ˆä½ éœ€è¦ä¸€ä¸ªæ•°ç»„ï¼Ÿæˆ‘ä¸éœ€è¦é‚£ä¸ªï¼ä»¥åŠä¸ºä»€ä¹ˆæˆ‘åº”è¯¥å»`message`å­—æ®µå–æ•°ç»„[0]å¹¶å¾—åˆ° senderâ€â€”â€”ä¸€ä¸ªå¥åº·çš„å‰ç«¯å¼€å‘è€…ã€‚

### [](#2nd-case-get-what-that-frontend-developer-wants)ç¬¬äºŒç§æƒ…å†µ:å¾—åˆ°å‰ç«¯å¼€å‘è€…æƒ³è¦çš„ä¸œè¥¿

å‡è®¾æ‚¨åªé€‰æ‹© sillybilly ä½œä¸ºå‘é€è€…ï¼Œå³ä½¿ç”¨æ‚¨çš„åº”ç”¨ç¨‹åºçš„å‘é€è€…ï¼Œè€Œåœ¨**å®¢æˆ·ç«¯é˜µåˆ—**ä¸Šçš„å…¶ä»–ç”¨æˆ·æ˜¯å…¶ä»–ç”¨æˆ·ã€‚`$unwind`å»è¥æ•‘ã€‚

```
db.getCollection('chats').aggregate([
    { $match: { clients: "sillybilly@mail.com" } },
    { $unwind: "$clients" }
]) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æŸ¥è¯¢ç»“æœå°†ç»™å‡ºåŒ¹é…æ–‡æ¡£çš„è§£æ„æ•°ç»„å…ƒç´ ã€‚

```
[{ foo: [bar, baz] }] // not using unwind
[{ foo: bar }, {foo: baz}] // using unwind $foo
// get that? so now every documents are decoupled 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ¥æ”¶è€…çš„åå­—:

```
db.getCollection('chats').aggregate([
    { $match: { clients: "sillybilly@mail.com" } },
    { $unwind: "$clients" },
    { $match: { clients: { $ne: 'sillybilly@mail.com' } } },
    { $project: {
      _id: "$roomId",
      receiver: "$clients",
      message: { $slice: ["$message", -1]
      }
    }}
])

// result

[{
    "_id" : 1,
    "receiver" : "rooberduck@mail.com",
    "message" : [
        {
            "time" : ISODate("2019-06-27T04:54:49.528Z"),
            "status" : "SEND",
            "text" : "Hello!",
            "sender" : "sillybilly@mail.com",
            "reciever" : "rooberduck@mail.com",
            "_id" : ObjectId("5d1449ff6f934a2926c175d3")
        }
    ]
} ... another result] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¥½çš„ï¼Œç°åœ¨å†ç»™å‰ç«¯å¼€å‘è€…å‘ä¸€æ¡æ¶ˆæ¯ã€‚ä½†æ˜¯ç­‰ä¸€ä¸‹ï¼Œä½ å†æ¬¡çœ‹åˆ°è®¾è®¡ï¼Œå®ƒå¾—åˆ°äº†æœªè¯»ä¿¡æ¯å¾½ç« ...ä½ åº”è¯¥æ•°ä¸€æ•°ã€‚å—¯ã€‚ä½ åˆåä¸‹æ¥æ€è€ƒ..

### [](#3rd-case-count-unread-message-inside-an-array-of-messages-object)ç¬¬ä¸‰ç§æƒ…å†µ:å¯¹ messages å¯¹è±¡æ•°ç»„å†…çš„æœªè¯»æ¶ˆæ¯è¿›è¡Œè®¡æ•°

ä½ å·²ç»æ„Ÿè§‰åˆ°å®ƒçš„è¯­æ³•äº†å—ï¼Ÿ:lol:ã€‚

ä½ å·²ç»`$unwind`äº†å®¢æˆ·ï¼Œä½ åº”è¯¥å†`$unwind`ä¸€éä¿¡æ¯å—ï¼Ÿæ˜¯çš„ã€‚è¿™å°±åƒæ˜¯åœ¨ç”¨æµå·¥ä½œï¼Œæ‰€ä»¥ä½ åº”è¯¥éµå¾ªä½ åˆ›é€ çš„æ¨¡å¼ã€‚

å› ä¸ºåœ¨`$project`ä¸­ä½¿ç”¨`$sum`éœ€è¦å¤§é‡çš„`$cond`ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨`$group`æ¥ç®€åŒ–æŸ¥è¯¢ã€‚`$group`æœ‰å¾ˆå¤š[ç´¯åŠ å™¨](https://docs.mongodb.com/manual/reference/operator/aggregation/group/#accumulator-operator)æ“ä½œç¬¦ï¼Œå¯ä»¥ç”¨æ¥æ£€æµ‹`$last` / `$first`å…ƒç´ ã€‚

```
//  unwind it again
db.getCollection('chats').aggregate([
    { $match: { clients: "sillybilly@mail.com" } },
    { $unwind: "$clients" },
    { $match: { clients: { $ne: 'sillybilly@mail.com' } } },
    { $unwind: "$message" }, // messages decoupled her
    { $match: "$message.status": 'SEND' }
    { $group: {
      _id: '$_id', // we group it by _id
      roomId: { $first: '$roomId' }, // accumulator must be used otherwise error will thrown
      receiver: { $first: '$clients' },
      unread: { $sum: 1 },
      message: { $last: '$message.text' },
      time: { $last: '$message.time' }
    }
  }
])

// result
[{
    "_id" : ObjectId("5d1449ff6f934a2926c175d3"),
    "receiver" : "rooberduck@mail.com",
    "unread": 1,
    "message" : "Hello!",
    "time": ISODate("2019-06-27T04:54:49.528Z")
}... another result] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> æˆ‘è®¤ä¸ºè¿™ä¸ªæŸ¥è¯¢æ‰§è¡Œå¾—ä¸å¥½ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ‚¨æœ‰ 1000 æ¡æ¶ˆæ¯ï¼Œæ‚¨å°†å±•å¼€ 1000 æ¡æ¶ˆæ¯ï¼Œè¿™ä¼šå½±å“æ€§èƒ½å—ï¼Ÿå¦‚æœä½ çŸ¥é“æœ€å¥½çš„æ–¹æ³•ï¼Œè¯·åœ¨ä¸‹é¢è¯„è®ºğŸ˜

ç°åœ¨ï¼Œæ‚¨ä»æ•°æ®åº“ä¸­è·å¾—äº†ä¸€ä¸ªæ¼‚äº®çš„å“åº”ï¼Œæ‚¨åœ¨è®¾è®¡ UI ä¸­å”¯ä¸€ç¼ºå°‘çš„å°±æ˜¯åˆ†é¡µï¼

### [](#4th-case-paginate-aggregate-using-facet)ç¬¬ 4 ç§æƒ…å†µ:åˆ†é¡µã€‚ä½¿ç”¨$facet èšåˆ()

å…³äº`$facet`çš„æ–‡æ¡£æ˜¯è¿™æ ·è¯´çš„:â€œåœ¨åŒä¸€ç»„è¾“å…¥æ–‡æ¡£çš„å•ä¸ªé˜¶æ®µä¸­å¤„ç†å¤šä¸ªèšåˆç®¡é“â€ã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨`$unwind`ä¸€æ ·åœ¨`$facet`ä¸­ä½¿ç”¨èšåˆã€‚ä½†æ˜¯æˆ‘ä»¬ä¸éœ€è¦å†æ¬¡å±•å¼€ï¼Œè¦é€šè¿‡`$facet`è¿›è¡Œåˆ†é¡µï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŸ¥è¯¢:

```
db.getCollection('chats').aggregate([
    { $match: { clients: "sillybilly@mail.com" } },
    { $unwind: "$clients" },
    { $match: { clients: { $ne: 'sillybilly@mail.com' } } },
    { $unwind: "$message" },
    { $match: "$message.status": 'SEND' }
    { $group: {
        _id: '$_id',
        roomId: { $first: '$roomId' },
        receiver: { $first: '$clients' },
        unread: { $sum: 1 },
        message: { $last: '$message.text' },
        time: { $last: '$message.time' }
      }
    },
    {
      $facet: {
          metadata: [{ $count: 'total' }, { $addFields: { page: 1 } }],
          data: [
            { $skip: 0 },
            { $limit: 15 }
          ]
        }
    }
  ])

// result: now you got a paginated response
[{
    "metadata": [ { $count: 'total' }, { page: 1 } ],
    "data": [
      {
        "_id" : ObjectId("5d1449ff6f934a2926c175d3"),
        "receiver" : "rooberduck@mail.com",
        "unread": 1,
        "message" : "Hello!",
        "time": ISODate("2019-06-27T04:54:49.528Z")
      }
    ]
}... another result] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±è¿™æ ·ï¼Œä½ å¾—åˆ°äº†æ¼‚äº®çš„å“åº” APIï¼Œç°åœ¨ä½ æ¥åˆ°å‰ç«¯å¼€å‘äººå‘˜é¢å‰è¯´ï¼Œä½ å®Œæˆäº†ï¼Œä»–/å¥¹æ¥å—ä½ çš„ API å“åº”ã€‚

ä¸‹ä¸€ç¯‡æ–‡ç« å†è§ï¼Œç¥ä½ ä»Šå¤©æ„‰å¿«:)

éšæ—¶æ¬¢è¿åé¦ˆã€‚