# SwiftUI å’Œ Combine å…¥é—¨ã€‚

> åŸæ–‡ï¼š<https://dev.to/kevinmaarek/getting-started-with-swiftui-and-combine-dd8>

ç¼–è¾‘:ä¸º XCode 11.1 æ›´æ–°ã€‚

å› æ­¤ï¼Œæˆ‘å·²ç»ä¸º iOS å¼€å‘äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œæˆ‘å†³å®šæ¶‰è¶³è‹¹æœå‡ å¤©å‰åœ¨ WWDC 2019 ä¸Šæ¨å‡ºçš„æ–°çš„è¶…çº§æ–°é²œæ¡†æ¶:SwiftUI å’Œ Combineã€‚

å¦‚æœä½ é”™è¿‡äº†ï¼ŒSwiftUI æ˜¯ä¸€ç§ä»¥å£°æ˜æ–¹å¼åˆ¶ä½œ UI çš„æ–°æ–¹æ³•ã€‚Combine ä¸ SwiftUI ä¸€èµ·å·¥ä½œï¼Œå¹¶ä¸ºå¤„ç† UI æˆ–ç½‘ç»œäº‹ä»¶ç­‰å€¼æä¾›å£°æ˜æ€§ Swift APIã€‚

æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬åŠ¨æ‰‹å°è¯•ä¸€ä¸‹å§ï¼

é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ‰¾ä¸€ä¸ª API æ¥è°ƒç”¨å’Œä½¿ç”¨ã€‚æˆ‘å‘ç°äº† [JSONPlaceholder](https://jsonplaceholder.typicode.com/) ï¼Œä»–ä»¬æä¾›äº†ä¸€ä¸ªæˆ‘é€‰æ‹©å®ç°çš„ [todo API](https://jsonplaceholder.typicode.com/todos) :å®ƒè¿”å› 200 ä¸ª todo é¡¹ï¼Œçœ‹èµ·æ¥åƒ:

```
 [{
    "userId": 1,
    "id": 1,
    "title": "delectus aut autem",
    "completed": false
 }] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒèƒ½å®Œæˆä»»åŠ¡ã€‚æˆ‘å°†ä½¿ç”¨ [Quicktype](https://app.quicktype.io/) ä¸ºæˆ‘çš„ Todo æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆæˆ‘çš„å¯ç¼–ç ç»“æ„ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹ä¸€ä¸ªæ–°çš„ XCode é¡¹ç›®ã€‚ä¸è¦å¿˜è®°â€œä½¿ç”¨ SwiftUIâ€å¤é€‰æ¡†ğŸ˜‡ã€‚
æˆ‘ä»¬å°†æ·»åŠ æˆ‘ä»¬çš„ todo æ¨¡å‹ï¼Œä¸€ä¸ªæ¥è‡ª Quicktype ç»“æœçš„å‰¯æœ¬/pastï¼Œå¹¶æ·»åŠ `Identifiable`ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª`id`ï¼Œæˆ‘ä»¬ç¨åå°†éœ€è¦å®ƒã€‚

```
public class Todo: Codable, Identifiable {
    public let userID: Int
    public let id: Int
    public let title: String
    public let completed: Bool

    enum CodingKeys: String, CodingKey {
        case userID = "userId"
        case id = "id"
        case title = "title"
        case completed = "completed"
    }

    public init(userID: Int, id: Int, title: String, completed: Bool) {
        self.userID = userID
        self.id = id
        self.title = title
        self.completed = completed
    }
}

public typealias Todos = [Todo] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`Identifiable`æ˜¯ä¸€ä¸ªåè®®(SwiftUI æ¡†æ¶é™„å¸¦çš„)ï¼Œç”¨äºæ¯”è¾ƒå’Œè¯†åˆ«å…ƒç´ ã€‚å®ƒéœ€è¦ and `id`å’Œä¸€ä¸ªé»˜è®¤è¿”å›`Self`çš„`identifiedValue`ï¼Œæˆ‘ä»¬å°†ä¿æŒè¿™ç§æ–¹å¼ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬å°±çŸ¥é“æ¯ä¸ª`Todo`å¯¹è±¡éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚
æ³¨æ„ï¼Œä½¿ç”¨`List`æˆ–`ForEach`æ—¶éœ€è¦ã€‚

ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­åˆ›å»ºæˆ‘ä»¬çš„è§†å›¾ï¼Œä¸€ä¸ªç®€å•çš„åˆ—è¡¨å’Œå•å…ƒæ ¼ï¼Œä» todo å•å…ƒæ ¼å¼€å§‹ã€‚æ°´å¹³å †å å°±å¯ä»¥äº†:

[![](img/644337c91c8f1c0acf7aee3d0a8da4c1.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--1mijQy1Z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/k4e04c0cvb2lzpyl7fh3.png) 
(å¯ä»¥åœ¨æ–‡æœ«ä¸‹è½½å®Œæ•´é¡¹ç›®)

ç„¶åï¼Œåˆ—è¡¨ï¼Œéå¸¸åŸºæœ¬ï¼Œä¸è¦å¿˜è®°`Todos`ä½œä¸ºå­˜å‚¨å±æ€§(ç°åœ¨):

```
 var todos: Todos
    var body: some View {
        NavigationView {
            List(self.todos) { todo in
                TodoCell(todo: todo)
            }
     } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬åº”è¯¥åœ¨è§†å›¾æ¨¡å‹ä¸Šå·¥ä½œã€‚åˆ›å»ºä¸€ä¸ªåä¸º TodoViewModel çš„ç±»ï¼Œè®©æˆ‘ä»¬ç»™å®ƒæ·»åŠ ä¸€äº›å‡½æ•°ã€‚æ¯”æ–¹è¯´ï¼Œæˆ‘ä»¬éœ€è¦(æ˜¾ç„¶)ä¸‹è½½å¾…åŠäº‹é¡¹åˆ—è¡¨ï¼Œå¹¶åˆ›å»ºå¦ä¸€ä¸ªå‡½æ•°æ¥æ‰“ä¹±åˆ—è¡¨(å› ä¸ºä¸ºä»€ä¹ˆä¸å‘¢ï¼Œå½“è°ˆåˆ°å¾…åŠäº‹é¡¹åˆ—è¡¨çš„ç‰¹æ€§æ—¶ï¼Œæˆ‘ç¼ºä¹æƒ³æ³•)ã€‚

è¿™æ˜¯ä½ ç°åœ¨åº”è¯¥æœ‰çš„:

```
public class TodoViewModel {
    var todos: Todos = [Todo]()

    func shuffle() {
        self.todos = self.todos.shuffled()
    }

    func load() {
        guard let url = URL(string: "https://jsonplaceholder.typicode.com/todos/") else { return }
        URLSession.shared.dataTask(with: url) { (data, response, error) in
            do {
                guard let data = data else { return }
                let todos = try JSONDecoder().decode(Todos.self, from: data)
                DispatchQueue.main.async {
                    self.todos = todos
                }
            } catch {
                print("Failed To decode: ", error)
            }
        }.resume()
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨åˆ°äº†æ£˜æ‰‹çš„éƒ¨åˆ†ã€‚
æˆ‘ä»¬éœ€è¦ä½¿ ViewModel ç¬¦åˆ`ObservableObject`ã€‚è¿™æ˜¯ä¸€ä¸ªåè®®ï¼Œå®ƒå°†å¸®åŠ©æˆ‘ä»¬åœ¨å€¼å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥ä»»ä½•è®¢æˆ·ã€‚
å®ƒå°†å…è®¸æˆ‘ä»¬ç”¨å±æ€§åŒ…è£…å™¨æ ‡è®°ä»»ä½•éœ€è¦å¯¹è®¢æˆ·è¿›è¡Œæ›´æ–°çš„å±æ€§(åœ¨è¿™ç¯‡[å¸–å­](https://dev.tohttp://) ) `@Published`ä¸­æœ‰æ›´å¤šå…³äºå±æ€§åŒ…è£…å™¨çš„å†…å®¹)ã€‚

`@Published`å±æ€§åŒ…è£…å™¨é€šè¿‡å‘å±æ€§æ·»åŠ ä¸€ä¸ª`Publisher`æ¥å·¥ä½œã€‚

```
 @Published var todos: Todos = [Todo]() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ ·ï¼Œæ¯æ¬¡è®¾ç½®`todos`å±æ€§æ—¶ï¼Œè§‚å¯Ÿæˆ‘ä»¬è§†å›¾æ¨¡å‹çš„ä»»ä½•ä¸œè¥¿éƒ½ä¼šè¢«é€šçŸ¥ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è°ˆè®ºä¸€ä¸ª SwiftUI `View`ï¼Œå®ƒå°†è‡ªåŠ¨åˆ·æ–°(ç”¨ä¸€äº›å¹³æ»‘çš„ SwiftUI é­”æœ¯)ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ viewModel å®ä¾‹æ›¿æ¢ todos å±æ€§ï¼Œè€Œä¸æ˜¯åœ¨è§†å›¾ä¸­å­˜å‚¨ Todos åˆ—è¡¨ã€‚

ä¸ºäº†è®©æˆ‘ä»¬çš„è§†å›¾è§‚å¯Ÿ VieModelï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªå±æ€§åŒ…è£…å™¨ã€‚

```
@ObservedObject var viewModel: TodoViewModel = TodoViewModel() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æˆ‘ä»¬çš„ NavigationView ä¸­ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå¯¼èˆªæ¡æŒ‰é’®ï¼Œå¦‚ä¸‹:

```
.navigationBarItems(leading:
    Button(action: {
        self.viewModel.shuffle()
    }, label: {
        Text("Shuffle")
    }),
trailing:
    Button(action: {
        self.viewModel.load()
    }, label: {
        Image(systemName: "arrow.2.circlepath")
    })
) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€ä¸ª shuffle æŒ‰é’®å’Œä¸€ä¸ª Reload æŒ‰é’®ï¼Œè°ƒç”¨æˆ‘ä»¬çš„ ViewModel çš„ç›¸åº”æ–¹æ³•ã€‚

å¯¹äºæˆ‘ä»¬çš„åˆ—è¡¨ï¼Œæˆ‘ä»¬ç°åœ¨å°†è¿­ä»£ viewModel çš„ todos æ•°ç»„ã€‚

```
List(self.viewModel.todos) { todo in
    TodoCell(todo: todo)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å®Œäº‹äº†ã€‚

åœ¨`onAppear`å—ä¸Šï¼Œä¸è¦å¿˜è®°è°ƒç”¨ load å‡½æ•°æ¥å¼€å§‹ä¸‹è½½å¾…åŠäº‹é¡¹åˆ—è¡¨:

```
 NavigationView {
            // ...
        }.onAppear {
            self.viewModel.load()
        } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œå½“æ‚¨ç‚¹å‡»åˆ·æ–°æŒ‰é’®æ—¶ï¼Œå®ƒå°†è°ƒç”¨åŠ è½½å‡½æ•°ï¼Œå¹¶æ›´æ–°å¾…åŠäº‹é¡¹åˆ—è¡¨ã€‚å½“å¾…åŠäº‹é¡¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ send å‡½æ•°ï¼ŒUI ä¼šè‡ªåŠ¨æ›´æ–°ã€‚

å¸Œæœ›ä½ å–œæ¬¢è¿™ä¸ªå…³äº SwiftUI+Combine èƒ½åšä»€ä¹ˆçš„å°ä»‹ç»ã€‚ä½ å¯ä»¥åœ¨æˆ‘çš„ github ä¸Šä¸‹è½½é¡¹ç›®æ–‡ä»¶[ã€‚](https://github.com/Que20/ToDoSwiftUI)

å¿«ä¹ç¼–ç ğŸ˜„