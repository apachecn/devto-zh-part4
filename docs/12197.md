# ä½¿ç”¨æ··åˆç‰ˆæœ¬éƒ¨ç½² Phoenix åº”ç”¨ç¨‹åº

> åŸæ–‡ï¼š<https://dev.to/render/deploy-a-phoenix-app-with-mix-releases-1e6d>

è¿™æ˜¯ä¸€ä¸ªåœ¨[æ¸²æŸ“](https://render.com)ä¸Šéƒ¨ç½²å¸¦æœ‰ [Mix ç‰ˆæœ¬](https://hexdocs.pm/mix/Mix.Tasks.Release.html)çš„[å‡¤å‡°](https://phoenixframework.org)åº”ç”¨ç¨‹åºçš„æŒ‡å—ï¼Œè¿™æ˜¯ä¸€ä¸ªæ–°çš„äº‘å¹³å°ï¼Œå…·æœ‰å¯¹ Elixir çš„æœ¬åœ°æ”¯æŒã€‚

æœ¬ä¾‹çš„å®Œæˆä»£ç æ˜¯ GitHub ä¸Šçš„[ã€‚](https://github.com/render-examples/phoenix_hello)

## å…¥é—¨

åœ¨ç»ˆç«¯ä¸­åˆ›å»ºæ–°çš„ Phoenix åº”ç”¨ç¨‹åºã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ•°æ®åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æŠŠ`--no-ecto`æ ‡å¿—ä¼ é€’ç»™`mix`ã€‚

```
 # install phx.new; feel free to change 1.4.9 to a different version
   $ mix archive.install hex phx_new 1.4.9
   $ mix phx.new phoenix_hello --no-ecto # also fetch and install dependencies
   $ cd phoenix_hello 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## é…ç½®æ··åˆå‘å¸ƒ

åˆ›å»º Mix å‘å¸ƒæ‰€éœ€çš„è¿è¡Œæ—¶é…ç½®ã€‚

1.  å°†`config/prod.secret.exs`é‡å‘½åä¸º`config/releases.exs`ã€‚
2.  å°†æ–°çš„`config/releases.exs`æ–‡ä»¶ä¸­çš„`use Mix.Config`æ›´æ”¹ä¸º`import Config`ã€‚
3.  å–æ¶ˆ`config/releases.exs`ä¸­ä»¥ä¸‹è¡Œçš„æ³¨é‡Š:

```
 config :phoenix_hello, PhoenixHelloWeb.Endpoint, server: true # uncomment me! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

1.  æœ€åæ›´æ–°`config/prod.exs`åˆ é™¤åº•éƒ¨çš„è¡Œ`import_config "prod.secret.exs"`ã€‚

## åˆ›å»ºä¸€ä¸ªæ„å»ºè„šæœ¬

æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡æ¨é€ Git repo æ—¶è¿è¡Œä¸€ç³»åˆ—å‘½ä»¤æ¥æ„å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ„å»ºè„šæœ¬æ¥å®Œæˆè¿™ä¸€ä»»åŠ¡ã€‚åœ¨ repo çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`build.sh`çš„è„šæœ¬:

```
 #!/usr/bin/env bash
   # Initial setup
   mix deps.get --only prod
   MIX_ENV=prod mix compile

   # Compile assets
   npm install --prefix ./assets
   npm run deploy --prefix ./assets
   mix phx.digest

   # Remove the existing release directory and build the release
   rm -rf "_build"
   MIX_ENV=prod mix release 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨å°†è„šæœ¬ç­¾å…¥ g it ä¹‹å‰ï¼Œç¡®ä¿è„šæœ¬æ˜¯å¯æ‰§è¡Œçš„:

```
 $ chmod a+x build.sh 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## æ›´æ–°ä½ çš„åº”ç”¨ç¨‹åºè¿›è¡Œæ¸²æŸ“

æ›´æ–°`config/prod.exs`ä»¥æ›´æ”¹ä¸‹é¢çš„è¡Œã€‚

```
 config :phoenix_hello, PhoenixHelloWeb.Endpoint,
     url: [host: "example.com", port: 80],
     cache_static_manifest: "priv/static/cache_manifest.json" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹æ­¤:

```
 config :phoenix_hello, PhoenixHelloWeb.Endpoint,
     url: [host: System.get_env("RENDER_EXTERNAL_HOSTNAME") || "localhost", port: 80],
     cache_static_manifest: "priv/static/cache_manifest.json", 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Render ä¸º`config/prod.exs`å¡«å……`RENDER_EXTERNAL_HOSTNAME`ã€‚

å¦‚æœæ‚¨å°†è‡ªå®šä¹‰åŸŸæ·»åŠ åˆ°æ¸²æŸ“åº”ç”¨ç¨‹åºï¼Œè¯·ä¸è¦å¿˜è®°å°†ä¸»æœºæ›´æ”¹ä¸ºæ‚¨çš„æ–°åŸŸã€‚

## åœ¨æœ¬åœ°æ„å»ºå¹¶æµ‹è¯•æ‚¨çš„ç‰ˆæœ¬

é€šè¿‡è¿è¡Œ`./build.sh`åœ¨æœ¬åœ°ç¼–è¯‘æ‚¨çš„ç‰ˆæœ¬ã€‚è¾“å‡ºåº”è¯¥æ˜¯è¿™æ ·çš„:

```
 * assembling phoenix_hello-0.1.0 on MIX_ENV=prod
   * using config/releases.exs to configure the release at runtime
   * skipping elixir.bat for windows (bin/elixir.bat not found in the Elixir installation)
   * skipping iex.bat for windows (bin/iex.bat not found in the Elixir installation)

   Release created at _build/prod/rel/phoenix_hello!

       # To start your system
       _build/prod/rel/phoenix_hello/bin/phoenix_hello start

   Once the release is running:

       # To connect to it remotely
       _build/prod/rel/phoenix_hello/bin/phoenix_hello remote

       # To stop it gracefully (you may also send SIGINT/SIGTERM)
       _build/prod/rel/phoenix_hello/bin/phoenix_hello stop

   To list all commands:

       _build/prod/rel/phoenix_hello/bin/phoenix_hello 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å¹¶å¯¼èˆªåˆ° [http://localhost:4000](http://localhost:4000) æ¥æµ‹è¯•æ‚¨çš„ç‰ˆæœ¬ã€‚

```
SECRET_KEY_BASE=`mix phx.gen.secret` _build/prod/rel/phoenix_hello/bin/phoenix_hello start 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½ï¼ŒæŠŠä½ çš„æ”¹å˜æ¨è¿›åˆ°ä½ çš„å›è´­ä¸­ã€‚æ‚¨ç°åœ¨å¯ä»¥åœ¨ç”Ÿäº§ä¸­éƒ¨ç½²æ‚¨çš„åº”ç”¨ç¨‹åºäº†ï¼ğŸ‰

## éƒ¨ç½²æ¸²æŸ“

1.  åœ¨ Render ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ **Web æœåŠ¡**ï¼Œå¹¶æˆäºˆ Render è®¿é—® Phoenix repo çš„æƒé™ã€‚

2.  åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ä»¥ä¸‹å€¼:

    | ç”° | ä»·å€¼ |
    | --- | --- |
    | **ç¯å¢ƒ** | `Elixir` |
    | **æ„å»ºå‘½ä»¤** | `./build.sh` |
    | **å¼€å§‹å‘½ä»¤** | `_build/prod/rel/phoenix_hello/bin/phoenix_hello start` |

    åœ¨**é«˜çº§**éƒ¨åˆ†ä¸‹ï¼Œæ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡:

    | é’¥åŒ™ | ä»·å€¼ |
    | --- | --- |
    | `SECRET_KEY_BASE` | ä¸€ä¸ªè¶³å¤Ÿå¼ºå¤§çš„ç§˜å¯†ã€‚é€šè¿‡è¿è¡Œ`mix phx.gen.secret`åœ¨æœ¬åœ°ç”Ÿæˆå®ƒ |

å°±æ˜¯è¿™æ ·ï¼æ„å»ºå®Œæˆåï¼Œç”¨ Mix ç‰ˆæœ¬æ„å»ºçš„ Phoenix web æœåŠ¡å°†ç«‹å³å‡ºç°åœ¨æ‚¨çš„æ¸²æŸ“ URL ä¸Šã€‚ä»Šåï¼ŒGitHub repo çš„æ¯ä¸€æ¬¡æ¨é€éƒ½å°†è‡ªåŠ¨æ›´æ–°å’Œéƒ¨ç½²æ‚¨çš„åº”ç”¨ï¼Œè€Œä¸ä¼šåœæœºã€‚ğŸ’¯