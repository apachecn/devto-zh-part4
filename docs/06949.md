# ä½¿ç”¨ pytest å’Œ pytest-factoryboy ç¼–å†™æµ‹è¯•

> åŸæ–‡:[https://dev . to/aduranil/writing-tests-with-pytest-and-factory-k7](https://dev.to/aduranil/writing-tests-with-pytest-and-factory-k7)

ç”¨ python æµ‹è¯•å¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ï¼Œæ‰€ä»¥æˆ‘åˆ—å‡ºäº†é€‚åˆæˆ‘çš„æ–¹æ³•ã€‚æˆ‘å–œæ¬¢ä½¿ç”¨ [pytest](https://docs.pytest.org/en/latest/) å’Œ [pytest-factoryboy](https://github.com/pytest-dev/pytest-factoryboy) æ¥ç”Ÿæˆæµ‹è¯•æ•°æ®ã€‚æ˜¯ä¸€ç§æ¯”åœ¨æµ‹è¯•æ•°æ®åº“ä¸­ç»´æŠ¤å¤¹å…·æ›´å®¹æ˜“çš„æµ‹è¯•æ–¹æ³•ã€‚

## [](#define-the-factories-they-look-very-similar-to-models)å®šä¹‰å·¥å‚ã€‚ä»–ä»¬çœ‹èµ·æ¥å¾ˆåƒæ¨¡ç‰¹ã€‚

```
# tests/factories.py 
import factory
from faker import Factory as FakerFactory

from django.contrib.auth.models import User
from django.utils.timezone import now

from app.models import Game, Message, GamePlayer, Round, Move

faker = FakerFactory.create()

class UserFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = User

    email = factory.Faker("safe_email")
    username = factory.LazyAttribute(lambda x: faker.name())

    @classmethod
    def _prepare(cls, create, **kwargs):
        password = kwargs.pop("password", None)
        user = super(UserFactory, cls)._prepare(create, **kwargs)
        if password:
            user.set_password(password)
            if create:
                user.save()
        return user

class GameFactory(factory.django.DjangoModelFactory):
    room_name = factory.LazyAttribute(lambda x: faker.name())
    game_status = "active"
    created_at = factory.LazyAttribute(lambda x: now())
    updated_at = factory.LazyAttribute(lambda x: now())
    round_started = False
    is_joinable = True

    class Meta:
        model = Game

class GamePlayerFactory(factory.django.DjangoModelFactory):
    followers = 0
    selfies = 3
    user = factory.SubFactory(UserFactory)
    started = False
    game = factory.SubFactory(GameFactory)

    class Meta:
        model = GamePlayer

class MessageFactory(factory.django.DjangoModelFactory):
    game = factory.SubFactory(GameFactory)
    username = None
    message = factory.LazyAttribute(lambda x: faker.sentence())
    created_at = factory.LazyAttribute(lambda x: now())
    message_type = None

    class Meta:
        model = Message

# etc 
```

## [](#in-a-raw-conftestpy-endraw-file-i-register-the-factories)åœ¨ä¸€ä¸ª`conftest.py`æ–‡ä»¶é‡Œæˆ‘æ³¨å†Œäº†å·¥å‚ã€‚

åœ¨ [`conftest.py`](https://stackoverflow.com/questions/34466027/in-pytest-what-is-the-use-of-conftest-py-files) æ–‡ä»¶ä¸­å®šä¹‰çš„å¤¹å…·å°†åœ¨ä»»ä½•æµ‹è¯•æ–‡ä»¶ä¸­è¢«è¯†åˆ«ã€‚â€œæ³¨å†Œâ€å·¥å‚å…è®¸æ‚¨ç”¨ä¸€ä¸ª**å°å†™ä¸‹åˆ’çº¿ç±»åå°†å®ƒä»¬æ³¨å…¥åˆ°æ‚¨çš„æµ‹è¯•ä¸­ã€‚åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ç”¨æˆ‘å°†åœ¨æµ‹è¯•ä¸­ä½¿ç”¨çš„`@pytest.fixture()`æ¥å®šä¹‰ fixturesï¼Œå¹¶ç”¨æˆ‘åˆšåˆšæ³¨å†Œçš„å·¥å‚æ¥æ³¨å…¥å®ƒä»¬ã€‚** 

```
# tests/conftest.py import pytest
from pytest_factoryboy import register

from .factories import (
    UserFactory,
    GameFactory,
    GamePlayerFactory,
    MoveFactory,
    RoundFactory,
)

register(UserFactory)
register(GameFactory)
register(GamePlayerFactory)
register(MoveFactory)
register(RoundFactory)

@pytest.fixture()
def game(game_factory):
    return game_factory()

@pytest.fixture()
def rnd(game, round_factory):
    return round_factory(game=game, started=True)

@pytest.fixture()
def p_1(game, user_factory, game_player_factory):
    return game_player_factory(game=game, user=user_factory(), started=True)

#etc...more player fixtures defined 
```

## [](#write-tests)å†™æµ‹è¯•

æˆ‘åœ¨è¿™é‡Œå†™æµ‹è¯•ã€‚æˆ‘å°†æˆ‘çš„å¤¹å…·æ•°æ®ä¼ å…¥æˆ‘çš„æµ‹è¯•æ–¹æ³•ï¼Œè¿˜ä¼ å…¥ä¸€ä¸ªåä¸º`move`çš„å·¥å‚ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘åœ¨è¿™é‡Œä¸»è¦æµ‹è¯•çš„å†…å®¹ã€‚ä¸ºäº†æµ‹è¯•ç©å®¶çš„ç§»åŠ¨ï¼Œæˆ‘é¦–å…ˆéœ€è¦åˆ›å»ºç©å®¶ã€æ¸¸æˆå’Œå›åˆï¼Œè¿™å°±æ˜¯æˆ‘åœ¨æˆ‘çš„`conftest.py`æ–‡ä»¶ä¸­æ‰€åšçš„ã€‚æˆ‘åªéœ€è¦è¿™æ ·åšä¸€æ¬¡ï¼Œå¹¶ä¸”æˆ‘ä¸éœ€è¦å¯¼å…¥ fixturesï¼Œå› ä¸ºåœ¨`conftest.py`ä¸­å£°æ˜çš„ä»»ä½•ä¸œè¥¿å¯¹æµ‹è¯•æ–‡ä»¶éƒ½æ˜¯å¯è§çš„ã€‚

```
# tests/test_round_service.py 
import pytest

from app.services.round_service import (
    RoundTabulation,
    LEAVE_COMMENT,
    CALL_IPHONE,
    DISLIKE,
    GO_LIVE,
    POST_SELFIE,
    DONT_POST,
    NO_MOVE,
    DISLIKE_DM,
    POST_SELFIE_PTS,
    POST_SELFIE_DM,
    GO_LIVE_DM,
    NO_MOVE_DM,
)
from app.services import round_service, message_service
from app.models import Move, Message, GamePlayer

@pytest.mark.django_db
def test_iphone_go_live_do_selfie(rnd, p_1, p_2, p_3, move_factory):
    """if a girl calls a girl who is trying to take a selfie, she sustains go
    live damage"""
    move_factory(round=rnd, action_type=GO_LIVE, player=p_1, victim=None)
    move_factory(round=rnd, action_type=CALL_IPHONE, player=p_2, victim=p_3)
    move_factory(round=rnd, action_type=POST_SELFIE, player=p_3, victim=None)
    tab = RoundTabulation(rnd).tabulate()
    assert tab[p_1.id] == 0
    assert tab[p_2.id] == GO_LIVE_DM
    assert tab[p_3.id] == GO_LIVE_DM

@pytest.mark.django_db
def test_go_live_with_call(rnd, p_1, p_2, p_3, p_4, p_5, move_factory):
    """message was created, points are corrected, player is removed from player
    points array, they have one less story"""
    move_factory(round=rnd, action_type=GO_LIVE, player=p_1, victim=None)
    move = move_factory(round=rnd, action_type=CALL_IPHONE, player=p_2, victim=p_1)
    move_factory(round=rnd, action_type=DISLIKE, player=p_3, victim=p_1)
    move_factory(round=rnd, action_type=DISLIKE, player=p_4, victim=p_1)
    move_factory(round=rnd, action_type=LEAVE_COMMENT, player=p_5, victim=p_1)
    tab = RoundTabulation(rnd).tabulate()
    assert message(rnd.game, p_2.user.username) in message_service.iphone_msg(
        move, p_1.user.username
    )
    p_1 = GamePlayer.objects.get(id=p_1.id)
    assert p_1.go_live == 1
    assert tab[p_1.id] == -50 
```

## [](#execute-the-tests)æ‰§è¡Œæµ‹è¯•

ç°åœ¨æ‚¨çš„æµ‹è¯•å¯ä»¥ä½¿ç”¨æµ‹è¯•æ•°æ®è¿è¡Œäº†ï¼

```
[17:59:32] (master) selfies
ğŸ™‹ docker exec -it 5c93db3f3183 bash
root@5c93db3f3183:/selfies# pytest app/tests/test_round_service.py
======================================= test session starts ========================================
platform linux -- Python 3.7.4, pytest-5.0.1, py-1.8.0, pluggy-0.12.0
Django settings: selfies.settings (from ini file)
rootdir: /selfies, inifile: pytest.ini
plugins: factoryboy-2.0.3, django-3.5.1
collected 15 items                                                                                 

app/tests/test_round_service.py ............... 
```