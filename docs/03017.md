# åœ°å½¢æ¡ä»¶èµ„æºğŸ‘·å¦‚ä½•åœ¨ terraform ä¸­åˆ¶ä½œæ¡ä»¶èµ„æºï¼Ÿ

> åŸæ–‡ï¼š<https://dev.to/tbetous/how-to-make-conditionnal-resources-in-terraform-440n>

æˆ‘æƒ³ç”¨è¿™ç¯‡çŸ­æ–‡åˆ†äº«æˆ‘åœ¨ terraform ä¸­å…³äºæ¡ä»¶èµ„æºçš„ç»éªŒã€‚

## ç”¨ä¾‹ğŸ¤”

è¿™æ˜¯æˆ‘çš„ä½¿ç”¨æ¡ˆä¾‹ã€‚æˆ‘ç›®å‰æ­£åœ¨ä¸ºä¸€ä¸ªé¡¹ç›®å®éªŒ lambdas (AWS äº‘åŠŸèƒ½)ã€‚æˆ‘çš„é—®é¢˜æ˜¯ä¸çŸ¥é“å“ªç§ç¼–ç¨‹è¯­è¨€æœ€é€‚åˆæˆ‘çš„ç”¨ä¾‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘æƒ³ä¸ºæ¯ç§è¯­è¨€åˆ¶å®šä¸€ä¸ªå…³äºæ‰§è¡Œæ—¶é—´å’Œå†…å­˜æ¶ˆè€—çš„åŸºå‡†ã€‚

æˆ‘æƒ³è¦çš„æ˜¯åˆ›å»ºä¸€ä¸ª terraform é…ç½®ï¼Œå®ƒèƒ½å¤Ÿé€šè¿‡å°†å‚æ•°è®¾ç½®ä¸º`"javascript"`æˆ–`"java"`æ¥å°†æˆ‘çš„ lambda ä» javascript åˆ‡æ¢åˆ° javaã€‚

## è§£ğŸ¤¯

æˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨[å…ƒå‚æ•°](https://www.terraform.io/docs/configuration/resources.html#meta-arguments)ã€‚[è®¡æ•°](https://www.terraform.io/docs/configuration/resources.html#count-multiple-resource-instances-by-count)å…ƒå‚æ•°å…è®¸æŒ‡å®šæ‚¨æƒ³è¦åˆ›å»ºå¤šå°‘ä¸ªå®ä¾‹ã€‚

### ğŸ‘‰æ­¥éª¤ 1:åˆ›å»ºè¾“å…¥å‚æ•°

```
variable "lambda_type" {
  type    = "string"
  default = "java"
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### ğŸ‘‰ç¬¬äºŒæ­¥:åˆ›å»ºä½ çš„èµ„æº

```
locals {
  my_function_name = "awesome-function"
}

resource "aws_lambda_function" "my_lambda_java" {
  filename         = "lambda.jar"
  function_name    = "${local.my_function_name}"
  handler          = "Handler"
  runtime          = "java8"
  count            = "${var.lambda_type == "java" ? 1 : 0}"
}

resource "aws_lambda_function" "my_lambda_javascript" {
  filename         = "lambda.jar"
  function_name    = "${local.my_function_name}"
  handler          = "index.handler"
  runtime          = "nodejs10.x"
  count            = "${var.lambda_type == "javascript" ? 1 : 0}"
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„åœ¨`lambda_type`å€¼çš„å‡½æ•°ä¸­å°†`count`è®¾ç½®ä¸º 0 æˆ– 1 çš„ä¸‰è¿›åˆ¶æ¡ä»¶ã€‚

### ğŸ‘‰æ­¥éª¤ 3:åˆ›å»ºä¸€ä¸ªæ•°æ®å˜é‡ï¼Œä»åŒä¸€ä¸ª id è®¿é—®æ‚¨çš„æ¡ä»¶èµ„æº

```
data "aws_lambda_function" "my_lambda" {
  function_name = "${local.my_function_name}"
  depends_on    = ["aws_lambda_function.my_lambda_java", "aws_lambda_function.my_lambda_javascript"]
}

// For instance if your lambda is attached to another resource, 
// you just have to use the same resource id for both (java & javascript)
resource "aws_lambda_permission" "my_lambda_permission" {
  statement_id  = "AllowExecutionFromSNS"
  action        = "lambda:InvokeFunction"
  function_name = "${data.aws_lambda_function.my_lambda.arn}"
  principal     = "sns.amazonaws.com"
  source_arn    = "${aws_sns_topic.topic.arn}"
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·æ³¨æ„ï¼Œ`depends_on`å±æ€§çœŸçš„å¾ˆé‡è¦ã€‚å¦‚æœä½ ä¸ä½¿ç”¨é‚£ä¸ªå±æ€§ï¼Œterraform ä¼šå°è¯•è·å–å°šä¸å­˜åœ¨çš„ lambda å‡½æ•°ã€‚å¦å¤–ï¼Œè¿™åªé€‚ç”¨äº terraform 0.12ï¼Œå®ƒå…è®¸[ä½¿ç”¨`depends_on`å’Œ`count = 0`](https://github.com/hashicorp/terraform/issues/15285#issuecomment-447971852) çš„èµ„æºã€‚

### ğŸ‘‰ç¬¬å››æ­¥:è®¡åˆ’å’Œåº”ç”¨ä½ çš„åœ°å½¢

æœ€åï¼Œä½ åªéœ€è¦ç”¨åˆé€‚çš„å‚æ•°åº”ç”¨ä½ çš„åœ°å½¢é…ç½®:

```
# For javascript
$ terraform plan --var "lambda-type=javascript"
# If the plan is correct to what you expect :
$ terraform apply --var "lambda-type=javascript"

# For java
$ terraform plan --var "lambda-type=java"
# If the plan is correct to what you expect :
$ terraform apply --var "lambda-type=java" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### ğŸ‘‰æ­¥éª¤ 5:æ¸…ç†èµ„æº(å¯é€‰)

å¦‚æœæ‚¨æŒ‰ç…§æœ¬æ–‡åšäº†ä¸€äº›æµ‹è¯•ï¼Œä¸è¦å¿˜è®°é€šè¿‡ç ´åèµ„æºæ¥æ¸…ç†æ‚¨çš„ç¯å¢ƒï¼

```
$ terraform destroy 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## æ­å–œæ­å–œï¼ğŸ‰

æ­å–œä½ ï¼ä½ åšåˆ°äº†ï¼ç°åœ¨ä½ å¯ä»¥æ·»åŠ èµ„æºæ¡ä»¶ï¼Œä»è€Œä½¿ä½ çš„åœ°å½¢é…ç½®æ›´å…·å‚æ•°åŒ–ï¼

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ä¸è¦çŠ¹è±«:

*   åœ¨æ¨ç‰¹ä¸Šå…³æ³¨æˆ‘: [@tbetous](https://twitter.com/tbetous)
*   åˆ†äº«è¿™ä¸ªå¸–å­ï¼

æ„Ÿè°¢æ‚¨çš„å…³æ³¨å’Œé˜…è¯»ğŸ‰