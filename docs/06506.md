# ç”¨ Jest å’Œ Cypress æµ‹è¯•æ‚¨çš„ Amplify åº”ç”¨ç¨‹åº

> åŸæ–‡:[https://dev . to/rakan nimer/testing-your-amplify-application-with jest-and-cypress-1g0i](https://dev.to/rakannimer/testing-your-amplify-application-with-jest-and-cypress-1g0i)

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºä¸€ä¸ªéƒ¨ç½²äº† Amplify æ§åˆ¶å°çš„ web åº”ç”¨ç¼–å†™é™æ€ã€å•å…ƒã€é›†æˆå’Œç«¯åˆ°ç«¯(e2e)æµ‹è¯•ï¼Œè¯¥åº”ç”¨ä½¿ç”¨ Amplify ç”Ÿæˆçš„ AppSync GraphQL API æ¥æŸ¥è¯¢ã€å˜å¼‚å’Œè®¢é˜…æ•°æ®ã€‚

æˆ‘ä»¬æ­£åœ¨æµ‹è¯•çš„åº”ç”¨ç¨‹åºå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å’Œæµ‹è¯•çš„æœ€ç»ˆä»£ç [è¿™é‡Œ](https://github.com/rakannimer/pagination-and-sorting-with-aws-amplify/)ã€‚

*   [ç®€ä»‹](#introduction)
*   [é™æ€æµ‹è¯•](#static-tests)
    *   [æ‰“å­—ç¨¿](#typescript)
    *   [ESLint](#eslint)
    *   [æ›´æ¼‚äº®](#prettier)
*   [ç”¨ TypeScript å’Œ ESLint å»ºç«‹ Jestã€‘](#setting-up-jest-with-typescript-and-eslint)
    *   [1ã€‚è®¾ç½®ä¸å·´åˆ«å¡”çš„ç©ç¬‘](#1-setup-jest-with-babel)
    *   [2ã€‚ä¸º Babel æ·»åŠ ç±»å‹è„šæœ¬æ”¯æŒ](#2-add-typescript-support-to-babel)
    *   [3ã€‚ç”¨ Jest](#3-configure-eslint-with-jest) é…ç½® ESLint
*   [å•å…ƒæµ‹è¯•](#unit-tests)
    *   [æµ‹è¯•å‡é€Ÿå™¨](#testing-the-reducer)
*   [é›†æˆæµ‹è¯•](#integration-tests)
    *   [é€‰æ‹©å˜²ç¬‘ä»€ä¹ˆ](#choosing-what-to-mock)
    *   [æ¨¡ä»¿æ¥è‡ªä¸‹ä¸€ä¸ª/è·¯ç”±å™¨çš„ç”¨æˆ·è·¯ç”±å™¨](#mocking-userouter-from-nextrouter)
    *   [å˜²è®½ååº”-äº¤é›†-è§‚å¯Ÿè€…](#mocking-react-intersection-observer)
    *   [ç”¨æ¨¡æ‹Ÿæ¨¡å‹æµ‹è¯•åº”ç”¨](#testing-the-app-with-mocked-models)
    *   [æ‰¿è¯ºé€€è´§æ–¹å¼](#promise-returning-methods)
    *   [å¯è§‚å¯Ÿçš„è¿”å›æ–¹æ³•](#observable-returning-methods)
*   [ç«¯åˆ°ç«¯æµ‹è¯•](#end-to-end-tests)
    *   [å‡†å¤‡æµ‹è¯•ç¯å¢ƒ](#preparing-the-test-environment)
    *   [æ·»åŠ æµ‹è¯•](#adding-tests)
*   [å°†æµ‹è¯•è„šæœ¬æ·»åŠ åˆ°`package.json`](#adding-test-scripts-to-packagejson)
*   [åœ¨æ¯æ¬¡æäº¤æ—¶ä» Amplify æ§åˆ¶å°è¿è¡Œæµ‹è¯•](#running-tests-from-the-amplify-console-on-every-commit)
*   [ç»“æŸ](#wrapping-up)

## [](#introduction)ç®€ä»‹

åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œå¦‚æœä½ ä¸ç¡®å®šä¸åŒç±»å‹çš„æµ‹è¯•ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæˆ–è€…æ¯ç§ç±»å‹æ„å‘³ç€ä»€ä¹ˆï¼Œé‚£ä¹ˆè¯·é˜…è¯» [@kentcdodds](https://dev.to/kentcdodds) çš„[è¿™ç¯‡æ–‡ç« ](https://kentcdodds.com/blog/unit-vs-integration-vs-e2e-tests)(è€å®è¯´ï¼Œå³ä½¿ä½ çŸ¥é“ï¼Œä½ ä¹Ÿåº”è¯¥è¯»ä¸€è¯»)ã€‚

é™æ€æµ‹è¯•ä¸æ˜¯é€šè¿‡æ‰§è¡Œä»£ç æ¥å®Œæˆçš„ï¼Œè€Œæ˜¯é€šè¿‡é˜…è¯»ä»£ç ã€è§£æä»£ç å¹¶è¯•å›¾å‘ç°å…¶ä¸­çš„é—®é¢˜æ¥å®Œæˆçš„ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ TypeScriptï¼ŒESLint å’Œæ›´æ¼‚äº®çš„é™æ€æµ‹è¯•ã€‚

å•å…ƒæµ‹è¯•ç¡®ä¿å„ä¸ªä»£ç å•å…ƒ(å‡½æ•°ã€ç»„ä»¶ã€ç±»...)ä¸ºç»™å®šçš„è¾“å…¥äº§ç”Ÿæ­£ç¡®çš„è¾“å‡º(å’Œæ•ˆæœ)ã€‚æˆ‘ä»¬å°†å¯¹åº”ç”¨çš„ React reducer è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œè¿™æ˜¯ä¸€ä¸ªçº¯å‡½æ•°(ç¡®å®šæ€§çš„ï¼Œæ²¡æœ‰å‰¯ä½œç”¨)ã€‚

é›†æˆæµ‹è¯•ç»™äº†æˆ‘ä»¬ä¿¡å¿ƒï¼Œè®©æˆ‘ä»¬ç›¸ä¿¡ä¸åŒçš„ä»£ç å•å…ƒæŒ‰ç…§æˆ‘ä»¬çš„æœŸæœ›ååŒå·¥ä½œã€‚æˆ‘ä»¬å°†ä½¿ç”¨ [React æµ‹è¯•åº“](https://testing-library.com/docs/react-testing-library/intro)æµ‹è¯•æˆ‘ä»¬çš„ routes ç»„ä»¶

æœ€åï¼Œe2e æµ‹è¯•ä¸æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿›è¡Œäº¤äº’ï¼Œå°±åƒæˆ‘ä»¬çš„æœ€ç»ˆç”¨æˆ·ä¸€æ ·ã€‚æˆ‘ä»¬å°†æ„å»ºæˆ‘ä»¬çš„ä»£ç ï¼Œç„¶åä¸å®ƒäº¤äº’ï¼Œå¹¶ç”¨ [cypress](https://www.cypress.io) å’Œ [Cypress æµ‹è¯•åº“](https://testing-library.com/docs/cypress-testing-library/intro)åœ¨å…¶ä¸Šè¿è¡Œæ–­è¨€ã€‚

## [](#static-tests)é™æ€æµ‹è¯•

### [](#typescript)æ‰“å­—ç¨¿

æˆ‘ä»¬æ­£åœ¨æµ‹è¯•çš„åº”ç”¨ç¨‹åºä½¿ç”¨ Next.jsã€‚ä»ç‰ˆæœ¬ 9 å¼€å§‹ï¼ŒNext.js å…·æœ‰å¼€ç®±å³ç”¨çš„ç±»å‹è„šæœ¬æ”¯æŒï¼Œæ— éœ€é…ç½®([æ›´å¤šä¿¡æ¯](https://nextjs.org/blog/next-9))ã€‚

> å¦‚æœä½ æ˜¯ä»é›¶å¼€å§‹è¿è¡Œ:`npx create-next-app --example with-typescript`

å› æ­¤ï¼Œæˆ‘ä»¬å°†åªåœ¨ TypeScript ä¸­ç¼–å†™ä»£ç ï¼Œå¹¶è¿è¡Œ TypeScript ç¼–è¯‘å™¨æ¥éªŒè¯åœ¨æ¯æ¬¡æ¨é€ä¹‹å‰æ²¡æœ‰é”™è¯¯ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ª git æŒ‚é’©ï¼Œåœ¨æ¯æ¬¡æ¨é€ä¹‹å‰è¿è¡Œ TypeScript ç¼–è¯‘å™¨ï¼Œé˜²æ­¢æˆ‘ä»¬åœ¨ä»£ç ç¼–è¯‘å‡ºé”™æ—¶æ¨é€ã€‚

Husky ä½¿æ·»åŠ å’Œé…ç½® git æŒ‚é’©å˜å¾—ç®€å•ã€‚

æˆ‘ä»¬ä»æ·»åŠ  husky ä½œä¸ºå¼€å‘ä¾èµ–é¡¹å¼€å§‹:

```
npm i -D husky # Or yarn add -D husky 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨`package.json`ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªé…ç½®äº† git é’©å­çš„ husky éƒ¨åˆ†

```
{  "husky":  {  "pre-push":  "tsc"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹äº TypeScript æ¥è¯´å°±æ˜¯è¿™æ ·ï¼Œç°åœ¨ä»»ä½•æ—¶å€™æˆ‘ä»¬è¯•å›¾æ¨é€æ— æ³•ç¼–è¯‘çš„ä»£ç ï¼Œhusky éƒ½ä¼šæŠ›å‡ºå¹¶é˜»æ­¢æˆ‘ä»¬è¿™æ ·åšã€‚

### [](#eslint)ESLint

ä» [2019](https://eslint.org/blog/2019/01/future-typescript-eslint) å¼€å§‹ï¼ŒESLint å¾—åˆ°äº†å®Œæ•´çš„ TypeScript æ”¯æŒã€‚TSLint [å°†å¾ˆå¿«è¢«å¼ƒç”¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ ESLint](https://github.com/palantir/tslint#readme) ï¼Œæ‰€ä»¥åœ¨æ–°é¡¹ç›®ä¸­ä½¿ç”¨ ESLint å¯èƒ½æ›´æ˜æ™ºã€‚

è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä»ç”¨ JavaScript è®¾ç½® ESLint å¼€å§‹ï¼Œç„¶åæ·»åŠ ç±»å‹è„šæœ¬æ”¯æŒ

é¦–å…ˆå®‰è£… eslintã€eslint react æ’ä»¶å’Œ typescript è§£æå™¨

```
yarn add -D eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-plugin-react # npm i -D eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-plugin-react 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åç”¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶`.eslintrc.js`åˆå§‹åŒ– eslint:

```
module.exports = {
  extends: [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended"
  ],
  parserOptions: {
    ecmaFeatures: {
      jsx: true,
      modules: true
    },
    ecmaVersion: 2018,
    sourceType: "module"
  },
  parser: "@typescript-eslint/parser",
  plugins: ["react"],
  rules: {
    // I usually turn off these rules out of personal, feel free to delete the rules section in your project
    "@typescript-eslint/explicit-function-return-type": "off",
    "react/prop-types": "off"
  }
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦ lint æ‚¨çš„ä»£ç ï¼Œè¿è¡Œ:

```
# Lint all ts or tsx files in src/ and src/{any}/
yarn eslint src/**/*.ts*  src/*.ts* # or $(npm bin)/eslint src/**/*.ts*  src/*.ts 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…åœ¨`package.json`ä¸­æ·»åŠ ä¸€ä¸ªè„šæœ¬æ¥è¿è¡Œå‘½ä»¤:

```
{  "scripts":  {  "lint":  "eslint src/**/*.ts*  src/*.ts*"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”±äºè¯¥é¡¹ç›®ä½¿ç”¨ Amplify Codegenï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ eslint å¿½ç•¥ cli ä½¿ç”¨`.eslintignore`æ–‡ä»¶ç”Ÿæˆçš„ä»£ç ã€‚

é¡¾åæ€ä¹‰ï¼Œé™¤äº† eslintï¼Œå®ƒçš„è¡Œä¸ºç±»ä¼¼äº`.gitignore`ã€‚

```
# Path to code generated by Amplify
src/graphql/
src/API.ts 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œä¸‹è½½å¹¶å®‰è£…ä¸€ä¸ª eslint æ’ä»¶ï¼Œè®©æ‚¨çš„ç¼–è¾‘å™¨åœ¨æ‚¨é”®å…¥ä»£ç æ—¶çœ‹åˆ°è­¦å‘Šå’Œé”™è¯¯ã€‚[å¦‚æœä½ ä½¿ç”¨ VSCode](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint) ï¼Œé“¾æ¥åˆ°æ’ä»¶ã€‚

### [](#prettier)æ¼‚äº®äº›

ä½¿ç”¨ prettier æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå®ƒä¹Ÿå¯ä»¥ç®—ä½œä¸€ç§é™æ€æµ‹è¯•ï¼Œå› ä¸ºå®ƒè§£æä»£ç å¹¶åœ¨ä¸èƒ½è§£ææ—¶æŠ›å‡ºã€‚

```
yarn add -D prettier # npm i -D prettier 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨ä½ çš„ä»£ç ç¼–è¾‘å™¨ä¸­æ·»åŠ æ›´æ¼‚äº®çš„ä»£ç ï¼Œå†ä¹Ÿä¸ç”¨è€ƒè™‘æ ¼å¼åŒ–äº†ã€‚

`package.json`ä¸­æœ€åä¸€ä¸ª git é’©å­å˜æˆäº†:

```
{  "husky":  {  "pre-commit":  "prettier --write \"src/*.ts\"  \"src/**/*.ts*\"",  "pre-push":  "tsc && yarn lint"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·æ³¨æ„ï¼Œè¿™åœ¨æ‚¨çš„æ•´ä¸ªä»£ç åº“ä¸Šè¿è¡Œèµ·æ¥æ›´æ¼‚äº®ï¼Œå¦‚æœæ‚¨æ­£åœ¨å¤„ç†ä¸€ä¸ªå¤§çš„ä»£ç åº“ï¼Œé‚£ä¹ˆä½¿ç”¨ [lint-staged](https://github.com/okonet/lint-staged) æ¥åªéªŒè¯æ›´æ”¹çš„æ–‡ä»¶å¯èƒ½æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚

## [](#setting-up-jest-with-typescript-and-eslint)ç”¨ TypeScript å’Œ ESLint è®¾ç½® Jest

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¾ç½® Jest å’Œ typescriptï¼Œæ‚¨å¯ä»¥åœ¨è¿è¡Œä»£ç ä¹‹å‰ä½¿ç”¨ babel å»é™¤ç±»å‹(æ²¡æœ‰ç±»å‹æ£€æŸ¥),æˆ–è€…åœ¨è¿è¡Œä»£ç ä¹‹å‰ä½¿ç”¨ TypeScript ç¼–è¯‘å™¨ç¼–è¯‘ä»£ç ã€‚å®˜æ–¹æ–‡æ¡£ä¼¼ä¹æŠŠç”¨æˆ·æŒ‡å‘äº† Babelï¼ŒJest ä½¿ç”¨ Babel æ¯” ts-jest ä½¿ç”¨ tsc è¦å¿«å¾—å¤šã€‚æ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨ Babel å¹¶ä½¿ç”¨é¢„æäº¤é’©å­æ¥å¤„ç†ç±»å‹æ£€æŸ¥ã€‚

### [](#1-setup-jest-with-babel)1ã€‚è·Ÿå·´åˆ«å¡”å¼€ç©ç¬‘

è¿è¡Œ

```
yarn add -D jest @types/jest babel-jest @babel/core @babel/preset-env @babel/preset-react 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª`babel.config.js`æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­æ·»åŠ :

```
module.exports = {
  presets: [
    [
      "@babel/preset-env",
      {
        targets: {
          node: "current"
        }
      }
    ],
    "@babel/preset-react"
  ]
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#2-add-typescript-support-to-babel)2ã€‚å‘ Babel æ·»åŠ ç±»å‹è„šæœ¬æ”¯æŒ

```
yarn add -D @babel/preset-typescript 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶ä¸”åœ¨`babel.config.js` :

```
- "@babel/preset-react" + "@babel/preset-react",
+ "@babel/preset-typescript" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#3-configure-eslint-with-jest)3ã€‚ç”¨ Jest é…ç½® ESLint

å®‰è£…`eslint-plugin-jest`

```
yarn add -D eslint-plugin-jest # npm i -D eslint-plugin-jest 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨. eslintrc.js æ–‡ä»¶ä¸­ï¼Œæ·»åŠ  jest æ’ä»¶å’Œ jest å…¨å±€å˜é‡(describeï¼Œtestï¼Œexpect...):

```
module.exports = {
  env: {
    browser: true,
-    es6: true +    es6: true,
+    "jest/globals": true
  },
-  plugins: ["@typescript-eslint", "react"], +  plugins: ["@typescript-eslint", "react", "jest"], } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­¤æ—¶ï¼ŒJest åº”è¯¥ç”¨ ESLint å’Œ TypeScript æ­£ç¡®è®¾ç½®äº†ã€‚

è¿è¡Œæµ‹è¯•åŒ…æ‹¬åœ¨`__tests__`ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ª ts æ–‡ä»¶å¹¶æ‰§è¡Œ:

```
 yarn jest # $(npm bin)/jest # npx jest 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#unit-tests)å•å…ƒæµ‹è¯•

å•å…ƒæµ‹è¯•ç¡®ä¿åœ¨ç»™å®šä¸€äº›è¾“å…¥çš„æƒ…å†µä¸‹ï¼Œå‡½æ•°çš„è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚

çº¯å‡½æ•°éå¸¸é€‚åˆå•å…ƒæµ‹è¯•ã€‚

æˆ‘ä»¬ä½¿ç”¨çš„ React reducer åŒ…å«äº† app çš„ä¸»è¦é€»è¾‘ï¼Œæ˜¯ä¸€ä¸ªçº¯å‡½æ•°ã€‚å¯¹äºæ¯ä¸ªç»™å®šçš„çŠ¶æ€å’ŒåŠ¨ä½œçš„ç»„åˆï¼Œå‡½æ•°è¿”å›ä¸€ä¸ªæ–°çš„çŠ¶æ€ã€‚

Jest æ˜¯ä¸€ä¸ªä¾§é‡äºç®€å•æ€§çš„æµ‹è¯•æ¡†æ¶ï¼Œå°†ç”¨äºå•å…ƒå’Œé›†æˆæµ‹è¯•ã€‚

### [](#testing-the-reducer)æµ‹è¯•å‡é€Ÿå™¨

æµ‹è¯• reducer å‡½æ•°åŒ…æ‹¬ç”¨ä¸åŒçš„åŠ¨ä½œå’ŒçŠ¶æ€è°ƒç”¨ reducerï¼Œå¹¶åœ¨è¾“å‡ºä¸Šè¿è¡Œæ–­è¨€ã€‚

æˆ‘ä»¬å°†æ¯ä¸ªæµ‹è¯•å®šä¹‰ä¸ºä»¥ä¸‹ç±»å‹:

```
type ReducerTest = {
  state: State;
  action: Action;
  assertions: (newState: State, state: State, action: Action) => void;
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¾‹å¦‚ï¼Œä¸€ä¸ªç®€å•çš„æµ‹è¯•æ¥ç¡®ä¿æ·»åŠ ä¸€ä¸ªé€šé“æ˜¯å¯è¡Œçš„ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
import cases from "jest-in-case";

const reducerTest = {
  name: "Can append channel to empty state"
  state: getInitialState(),
  action: {
    type: "append-channels",
    payload: { items: [createChannel()], nextToken: null }
  },
  assertions: (newState, state, action) => {
    expect(newState.channels.items.length).toEqual(1);
  }
};

const tests = [reducerTest];

const runTest = reducerTest => {
  const newState = reducer(reducerTest.state, reducerTest.action);
  reducerTest.assertions(newState, reducerTest.state, reducerTest.action);
};

cases("works", runTest, tests); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ·»åŠ æµ‹è¯•åŒ…æ‹¬å‘æµ‹è¯•æ•°ç»„ä¸­æ·»åŠ é¡¹ç›®ã€‚

> [jest-in-case](https://github.com/atlassian/jest-in-case) æ˜¯ä¸€ä¸ªâ€œjest å·¥å…·ï¼Œç”¨äºåˆ›å»ºç›¸åŒæµ‹è¯•çš„å˜ä½“â€

æ›´å¤šæµ‹è¯•å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°[ã€‚](https://github.com/rakannimer/pagination-and-sorting-with-aws-amplify/blob/master/__tests__/state.test.ts)

## [](#integration-tests)é›†æˆæµ‹è¯•

è¿™å°†ç»™æˆ‘ä»¬ä¿¡å¿ƒï¼Œè®©æˆ‘ä»¬ç›¸ä¿¡æˆ‘ä»¬çš„ç»„ä»¶ä¼šåƒé¢„æœŸçš„é‚£æ ·ä¸€èµ·å·¥ä½œã€‚æˆ‘ä»¬å°†åœ¨è·¯ç”±ç»„ä»¶ä¸Šæµ‹è¯•å’Œè¿è¡Œæ–­è¨€ã€‚

ä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å˜²è®½ã€‚

### [](#choosing-what-to-mock)é€‰æ‹©å˜²ç¬‘ä»€ä¹ˆ

æ¨¡ä»¿åŒ…æ‹¬ç”¨å…·æœ‰ç›¸åŒ API ä½†æ•ˆæœä¸åŒçš„ä»£ç æ›¿æ¢ä¸€ä¸ªä»£ç å•å…ƒã€‚

ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦æ¨¡ä»¿æ¥è‡ª`@aws-amplify/api`çš„ API å¯¹è±¡ã€‚

è¯¥åº”ç”¨ç¨‹åºåªä½¿ç”¨äº† API çš„`graphql`æ–¹æ³•å’Œ graphqlOperation æ–¹æ³•ï¼Œå› æ­¤æ¨¡ä»¿å®ƒå°±è¶³å¤Ÿäº†ã€‚

`@aws-amplify/api`æ˜¯ä¸€ä¸ª npm æ¨¡å—ï¼Œä¸ºäº†æ¨¡æ‹Ÿå®ƒï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ ¹ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª`__mocks__`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ª`@aws-amplify`æ–‡ä»¶å¤¹å’Œä¸€ä¸ªåä¸º`api.ts`çš„æ–‡ä»¶ã€‚

`__mocks__/@aws-amplify/api.ts`åº”è¯¥æ˜¯è¿™æ ·çš„:

```
const API = {
  graphql: operation => {
    if (isSubscription(operation)) return Observable;
    else return Promise;
  }
};
export const graphqlOperation = (query, variables) => ({ query, variables });
export default API; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½†æ˜¯è¿™ç§ä½æ°´å¹³çš„å˜²ç¬‘ä¼šè®©æµ‹è¯•æ­£ç¡®çš„è¡Œä¸ºå˜å¾—æ›´åŠ å›°éš¾ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ mount ä¸Šï¼Œä¸€ä¸ªç»„ä»¶è°ƒç”¨`API.graphql` 3 æ¬¡ï¼Œä¸€æ¬¡ç”¨äºçªå˜ï¼Œä¸€æ¬¡ç”¨äºæŸ¥è¯¢ï¼Œä¸€æ¬¡ç”¨äºè®¢é˜…ã€‚

ä¸ºäº†æµ‹è¯•å®ƒï¼Œæˆ‘ä»¬éœ€è¦ä½¿ API.graphql æ¨¡æ‹Ÿç›¸å¯¹å¤æ‚ï¼Œå®ƒéœ€è¦åœ¨æ¯æ¬¡è°ƒç”¨æ—¶è§£ææŸ¥è¯¢ï¼Œå¹¶æ ¹æ®å®ƒè¿”å›é€‚å½“çš„æ•°æ®ç±»å‹),æ‰€ä»¥æˆ‘ä»¬å°†æ›´ä¸Šä¸€å±‚æ¥¼ã€‚

æˆ‘ä»¬å°†æ¨¡ä»¿æˆ‘ä»¬çš„æ¨¡å‹ï¼Œè€Œä¸æ˜¯æ¨¡ä»¿`@aws-amplify/api`æ¨¡å—ã€‚

æ­¤åº”ç”¨ç¨‹åºä¸­çš„æ¨¡å‹æ˜¯ UI ä¸è¿œç¨‹ API äº¤äº’çš„å”¯ä¸€å¯ç”¨æ¥å£ã€‚ç»„ä»¶ä¸å…è®¸ä½¿ç”¨`@aws-amplify/api`ï¼Œå®ƒä»¬ä½¿ç”¨ä¸ API å¯¹è¯çš„æ¨¡å‹ï¼Œåœ¨éœ€è¦æ—¶å¤„ç†æ•°æ®ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªå¯è§‚å¯Ÿçš„æˆ–æ‰¿è¯ºå°†æ•°æ®è¿”å›ç»™è°ƒç”¨è€…ã€‚

ä¾‹å¦‚ï¼Œè¦è·å¾—ä¸€ä¸ªåˆ—å‡ºæ‰€æœ‰æ¸ é“çš„æ‰¿è¯ºï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™:

åœ¨ App.tsx ä¸­

```
import * as React from "react";
import { models } from "./models/ModelsContext";

const App = () => {
  const [channels, setChannels] = React.useState({ items: [], nextToken: "" });
  React.useEffect(() => {
    models.Channels.getChannels().then(chans => {
      setChannels(c => ({
        items: [...c.items, ...chans.items],
        nextToken: chans.nextToken
      }));
    });
  }, []);
  const loadMore = () => {
    models.Channels.getChannels(channels.nextToken).then(chans => {
      setChannels(c => ({
        items: [...c.items, ...chans.items],
        nextToken: chans.nextToken
      }));
    });
  };
  return (
    <Some>
      <ReactTree
        onEndReached={() => {
          loadMore();
        }}
      >
        {channels.items.map(chan => (
          <ChannelCard channel={chan} />
        ))}
      </ReactTree>
    </Some>
  );
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶ä¸”åœ¨ models/Channels.tsx :

```
import API, { graphqlOperation } from "@aws-amplify/api";
import { queryToGetChannels } from "path/to/generated/graphql/queries";

const EMPTY_CHANNELS = { items: [], nextToken: "" }

export const getChannels = async () => {
  try {
    const channels = await API.graphql(graphqlOperation(queryToGetChannels));
    if (isValidChannelsData(channels))){
      return channels;
    }
    return EMPTY_CHANNELS;
  } catch (err) {
    return EMPTY_CHANNELS;
  }
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> å¦‚æœä½ ä¸ç¡®å®š`nextToken`æ˜¯æ€ä¹ˆå›äº‹ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒï¼Œè¯·å‚è€ƒæˆ‘åœ¨
> æ—©å…ˆçš„åšå®¢ä¸­å…³äº[ç”¨ AWS Amplify](https://dev.to/rakannimer/pagination-sorting-with-aws-amplify-4l37) åˆ†é¡µå’Œæ’åºçš„æ–‡ç« ã€‚

æ¨¡æ‹Ÿæ¨¡å‹ä¼šç»™æˆ‘ä»¬ä¿¡å¿ƒï¼Œå¦‚æœ Amplify API åƒé¢„æœŸçš„é‚£æ ·å·¥ä½œï¼Œåº”ç”¨ç¨‹åºå°±ä¼šå·¥ä½œï¼Œè¿™å¯¹äºé›†æˆæµ‹è¯•æ¥è¯´åº”è¯¥è¶³å¤Ÿäº†ã€‚

é™¤äº†æ¨¡å‹ä¹‹å¤–ï¼Œä¾èµ–äº JSDOM ä¸­æ²¡æœ‰çš„æµè§ˆå™¨ç‰¹æ€§çš„ä¾èµ–é¡¹ä¹Ÿåº”è¯¥è¢«å˜²ç¬‘ã€‚è¿™ç§ç±»å‹çš„å”¯ä¸€ä¾èµ–é¡¹æ˜¯`react-intersection-observer`ï¼Œå®ƒä¾èµ–äº IntersectionObserver APIï¼Œä»¥åŠ`next/router`ï¼Œå®ƒåœ¨ JSDOM ç¯å¢ƒä¸­è¿”å›ä¸€ä¸ªç©ºè·¯ç”±å™¨ã€‚æ¨¡ä»¿å‰è€…åº”è¯¥å¾ˆç®€å•ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„ React é’©å­ï¼Œæ¨¡ä»¿åè€…ç”šè‡³æ›´ç®€å•ï¼Œå› ä¸ºå®ƒåªæ˜¯ä¸€ä¸ª useContext è°ƒç”¨ã€‚

### [](#mocking-userouter-from-nextrouter)å˜²è®½[ç”¨æˆ·è·¯ç”±å™¨æ¥è‡ªä¸‹ä¸€ä¸ª/è·¯ç”±å™¨](https://github.com/zeit/next.js/#userouter)

å¦‚æœä½ çœ‹ä¸€ä¸‹[ç”¨æˆ·è·¯ç”±å™¨](https://github.com/zeit/next.js/blob/f41f630d19a1f87265fd77ae884b003d85915847/packages/next/client/router.ts#L115)çš„ä»£ç ï¼Œå®ƒåªæ˜¯å¯¹è·¯ç”±å™¨ä¸Šä¸‹æ–‡
çš„ä¸€ä¸ª`React.useContext`è°ƒç”¨

```
import { RouterContext } from "next-server/dist/lib/router-context";
export function useRouter() {
  return React.useContext(RouterContext);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦ç”¨ Jest æ¥å˜²ç¬‘ useRouterï¼Œæˆ‘ä»¬åªéœ€è¦å°†æˆ‘ä»¬çš„æµ‹è¯•åŒ…è£…åœ¨ä¸€ä¸ªæ–°çš„ RouterContext ä¸­ã€‚æä¾›å•†å’Œå­ç»„ä»¶å°†åœ¨æ¯æ¬¡æµ‹è¯•ä¸­è·å¾—ä¸€ä¸ªè‡ªå®šä¹‰è·¯ç”±å™¨ã€‚

```
import { RouterContext } from "next-server/dist/lib/router-context";

render(
  <RouterContext.Provider
    value={{
      pathname: "/",
      push: jest.fn()
      //...
    }}
  >
    <App />
  </RouterContext.Provider> ); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œå½“è°ƒç”¨`useRouter()`æ—¶ï¼Œåº”ç”¨ç¨‹åºå°†è®¿é—®ä¸Šé¢æä¾›çš„ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚

å¦‚æœæ‚¨ä»¥å‰æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œè¯·åŠ¡å¿…é˜…è¯»ä¸Šä¸‹æ–‡ä¸­çš„ [React æ–‡æ¡£ã€‚](https://reactjs.org/docs/context.html)

### [](#mocking-reactintersectionobserver)å˜²è®½[ååº”-äº¤é›†-è§‚å¯Ÿè€…](https://github.com/thebuilder/react-intersection-observer#readme)

[ç”¨ Jest](https://jestjs.io/docs/en/manual-mocks#mocking-node-modules) å˜²è®½ npm ä¾èµ–å…³ç³»éå¸¸ç›´æ¥:

1.  åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`__mocks__`çš„æ–‡ä»¶å¤¹ã€‚
2.  æ·»åŠ ä¸€ä¸ªåä¸º`react-intersection-observer.ts`çš„æ–‡ä»¶ã€‚
3.  åœ¨å®ƒå†…éƒ¨æ¨¡æ‹Ÿæ¨¡å—çš„è¡Œä¸ºã€‚

åœ¨`__mocks__/react-intersection-observer.ts`é‡Œã€‚

```
import * as React from "react";

export const useInView = jest.fn().mockImplementation(() => {
  return [React.useRef(), true];
});

export default {
  useInView
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ Jest å®ç”¨å‡½æ•°ï¼Œç”¨æ¥åˆ›å»ºå¯å®šåˆ¶çš„ã€å¯è¦†ç›–çš„å’Œå¯æ£€æŸ¥çš„æ¨¡æ‹Ÿå‡½æ•°ã€‚

ä½¿ç”¨ useInView å¯¹ç»„ä»¶è¿›è¡Œæµ‹è¯•çš„ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤º:

**ç»„ä»¶:**

```
import * as React from "react";
// When running this code in our tests, the import will be replaced with the code from __mocks/react-intersection-observer
import { useInView } from "react-intersection-observer";

export const Comp = () => {
  const [ref, inView] = useInView();
  return <div ref={ref}>{inView ? "Visible" : "Hidden"}</div>;
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**è€ƒè¯•:**

```
import * as React from "react";
import { render } from "@testing-library/react";

import { useInView } from "../__mocks__/react-intersection-observer";
import { Comp } from "../components/Comp";

describe("Comp with use-in-view", () => {
  test("is displayed when inView true", () => {
    useInView.mockImplementation(() => {
      return [React.useRef(), true];
    });
    const { getByText } = render(<ComponentUsingInView />);
    getByText("Visible");
  });
  test("is hidden when inView false", () => {
    useInView.mockImplementation(() => {
      return [React.useRef(), false];
    });
    const { getByText } = render(<ComponentUsingInView />);
    getByText("Hidden");
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> ç‚¹å‡»é˜…è¯»æ›´å¤šå…³äº`@testing-library/react` [çš„ä¿¡æ¯ã€‚](https://testing-library.com/docs/react-testing-library/intro)

### [](#testing-the-app-with-mocked-models)ç”¨æ¨¡æ‹Ÿæ¨¡å‹æµ‹è¯•åº”ç”¨

[ç”¨ Jest](https://jestjs.io/docs/en/manual-mocks#mocking-user-modules) æ¨¡ä»¿ç”¨æˆ·æ¨¡å—ç±»ä¼¼äºæ¨¡ä»¿èŠ‚ç‚¹æ¨¡å—:

1.  åœ¨æ‚¨æƒ³è¦æ¨¡ä»¿çš„æ–‡ä»¶æˆ–ç›®å½•çš„åŒä¸€ä¸ªç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`__mocks__`çš„æ–‡ä»¶å¤¹ã€‚
2.  åœ¨`__mocks__`ä¸­æ·»åŠ ä¸€ä¸ªä¸ä½ æƒ³è¦æ¨¡ä»¿çš„æ–‡ä»¶åŒåçš„æ–‡ä»¶ã€‚
3.  å¦‚æœæµ‹è¯•ä»£ç ä¹Ÿä½¿ç”¨æ¨¡æ‹Ÿï¼Œé‚£ä¹ˆåœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰é€šè¿‡è°ƒç”¨`jest.mock('./path/to/module')`æ¥è®¾ç½®å®ƒ

ä¸ Amplify API äº¤äº’çš„æ¨¡å‹å°†è¿”å›ä¸€ä¸ªæ‰¿è¯º(å¯¹äºæŸ¥è¯¢å’Œçªå˜)æˆ–ä¸€ä¸ªå¯è§‚å¯Ÿå€¼(å¯¹äºè®¢é˜…)ã€‚

ä¸€æ—¦æ‰¿è¯ºå…‘ç°æˆ–å¯è§‚å¯Ÿå¯¹è±¡å‘å‡ºä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬å°†æ›´æ–°çŠ¶æ€ä»¥åæ˜ å˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå½“`getChannels`è§£ææ—¶ï¼Œapp ä»£ç å°†è§¦å‘çŠ¶æ€æ›´æ–°ä»¥æ˜¾ç¤ºæ–°æ•°æ®ã€‚

åœ¨è¿™äº›æ‰¿è¯º/å¯è§‚å¯Ÿåˆ°çš„äº‹ç‰©è§£å†³/å‘å‡ºä¹‹å‰å’Œä¹‹åï¼Œåº”ç”¨ç¨‹åºçš„ UI çœ‹èµ·æ¥ä¼šæœ‰æ‰€ä¸åŒã€‚å¦‚æœèƒ½åœ¨å®ƒå‘ç”Ÿä¹‹å‰å’Œä¹‹åè¿è¡Œæ–­è¨€å°±å¥½äº†ã€‚

```
const { getAllByLabelText } = render(<Component />);
const allChannels = getAllByLabelText("channel");

// before getChannels resolves
expect(allChannels.length).toEqual(0);
// Do something here ğŸ‘‡ to resolve getChannels
// ...
// after getChannels resolves
expect(allChannels.length).toEqual(4); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªæµ‹è¯•æˆ–æµ‹è¯•å¥—ä»¶æä¾›å®šåˆ¶çš„æ¨¡æ‹Ÿï¼Œä»¥å®ç°é‚£äº›æ‰¿è¯ºå’Œå¯è§‚å¯Ÿæ€§ã€‚

#### [](#promise-returning-methods)æ‰¿è¯ºé€€è´§æ–¹å¼

æ¨¡å‹çš„æ¨¡æ‹Ÿæ˜¯ç®€å•çš„ jest æ¨¡æ‹ŸåŠŸèƒ½ã€‚æµ‹è¯•å¥—ä»¶è´Ÿè´£æä¾›æ­£ç¡®çš„å®ç°å’Œæ•°æ®ã€‚

ä¾‹å¦‚ï¼Œ`getChannels`æ¨¡æ‹Ÿæ˜¯`src/models/__mocks__/Channels.ts` :
ä¸­çš„ä¸€è¡Œç¨‹åº

```
export const getChannels = jest.fn(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`__tests__/channels.test.tsx`ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨å‘ˆç°æˆ‘ä»¬çš„ç»„ä»¶ä¹‹å‰ä¸ºè¿™ä¸ªæ¨¡æ‹Ÿæä¾›æ­£ç¡®çš„è¡Œä¸º:

```
import * as React from "react";
import { act } from "react-dom/test-utils";
import { render } from "@testing-library/react";
import { getChannels } from "../src/models/__mocks__/Channels.ts";

const dataBank = {
  channels: () => [
    {
      id: "channel-1"
      //,...otherFields
    }
  ]
};
type TestUtils = ReturnType<typeof render>

const selectors = {
  channelList: (testUtils:TestUtils) => testUtils.getAllByTestId("Channel Card");
}

describe("channels", () => {
  let resolveGetChannels;
  getChannels.mockImplementation(() => {
    return new Promise(resolve => {
      // Now a test can resolve getChannels whenever and with any data
      resolveGetChannels = resolve;
    });
  });
  test("works", async () => {
    const testUtils = render(<Channels />);

    // Expect getChannels to be called ( it's called on mount )
    expect(getChannels.toBeCalled());

    // And getChannels hasn't resolved yet because we haven't called resolveGetChannels
    expect(() => {
      selectors.channelList(testUtils)
    }).toThrow();

    // Wait for promise to resolve and ui to update
    await act(async () => {
      resolveGetChannels(dataBank.channels());
    });

    // Make sure that channels are visible
    expect(selectors.channelList(testUtils).length).toEqual(1);
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä½ ä¸ç¡®å®š [`act`](https://reactjs.org/docs/test-utils.html#act) æ˜¯ä»€ä¹ˆï¼Œæˆ–è€…å®ƒåœ¨åšä»€ä¹ˆï¼Œé‚£ä¹ˆè¯·é˜…è¯»@threepointone çš„è¿™ç¯‡[ç²¾å½©è®²è§£](https://github.com/threepointone/react-act-examples/blob/master/sync.md)

#### [](#observable-returning-methods)å¯è§‚å¯Ÿçš„è¿”å›æ–¹æ³•

åƒæ‰¿è¯ºå›æŠ¥æ¨¡å‹ä¸€æ ·ï¼Œæˆ‘ä»¬é¦–å…ˆå°†æ–¹æ³•å®šä¹‰ä¸º:

```
export const onCreateChannel = jest.fn(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†åœ¨æµ‹è¯•å¥—ä»¶ä¸­å®šä¹‰æ­£ç¡®çš„å®ç°ã€‚

å¯¹äº GraphQL è®¢é˜…ï¼ŒAWS Amplify API åº“è¿”å›ä¸€ä¸ªå¯è§‚å¯Ÿå€¼ã€‚å›¾ä¹¦é¦†ä½¿ç”¨ [`zen-observable`](https://github.com/zenparsing/zen-observable) åˆ›é€ å¯è§‚æµ‹é‡ã€‚ä½†è¿™åªæ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ RxJS æˆ–ä»»ä½•å…¶ä»–å¯è§‚å¯Ÿçš„å®ç°æ¥æ¨¡æ‹Ÿè¿”å›ç±»å‹ã€‚

å¦‚æœä½ æ²¡æœ‰å’Œ RxJS æˆ–è€… Observables åˆä½œè¿‡ï¼Œä½ åªéœ€è¦æŠŠä¸€ä¸ª Observables æƒ³è±¡æˆä¸€ä¸ªæ‰¿è¯º

1.  å¯ä»¥ä¸æ­¢ä¸€æ¬¡è§£å†³ã€‚
2.  å¯ä»¥ç”¨`subscribe`ä»£æ›¿`then`æ¥å¬ã€‚

> è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦è¿™ä¸ªèŒä½ã€‚
> è¦è·å¾—æ›´æ·±å…¥çš„è§£é‡Šï¼Œè¯·æŸ¥çœ‹ [Andre Staltz](https://twitter.com/andrestaltz) çš„[ä½ ä¸€ç›´é”™è¿‡çš„](https://gist.github.com/staltz/868e7e9bc2a7b8c1f754)çš„ã€Šååº”å¼ç¼–ç¨‹å…¥é—¨ã€‹ã€‚

```
// Creating a promise that is invoked after {ms}ms
const delay = ms => {
  return new Promise(resolve => {
    setTimeout(resolve, ms);
  });
};
// Creating an observable that emits every {ms}ms
const interval = ms => {
  return new Observable(observer => {
    setInterval(() => observer.next(), ms);
  });
};

// Getting the resolved value from a promise
// Fires only once
delay(10).then(value => {});

// Getting the resolved value from a observable
// Fires indefinitely
interval(1000).subscribe(value => {}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æˆ‘ä»¬çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦åŠ«æŒ observer.next æ–¹æ³•ï¼Œå¹¶å°†å…¶æä¾›ç»™ä¸€ä¸ªå•ç‹¬çš„æµ‹è¯•ï¼Œä»¥ä¾¿éšæ—¶è°ƒç”¨:

```
import * as React from "react";
import { act } from "react-dom/test-utils";
import { Observable } from "rxjs"; // or 'zen-observable'
import { render } from "@testing-library/react";

import { onCreateChannel } from "../src/models/__mocks__/Channels.ts";

const dataBank = {
  channel: () => ({
    id: "channel-1"
    //,...otherFields
  })
};

describe("channels", () => {
  let emitOnCreateChannel;
  onCreateChannel.mockImplementation(() => {
    return new Observable(observer => {
      // Now a test can emit new channels whenever and with any data
      emitOnCreateChannel = v => observer.next(v);
    });
  });
  test("works", () => {
    const { getAllByTestId } = render(<Channels />);
    // Expect onCreateChannel to be called ( it's called on mount )
    expect(onCreateChannel.toBeCalled());
    // The list of channels should be empty before data is fetched with models, 
    expect(() => {
      getAllByTestId("Channel Card");
    }).toThrow();

    // Wait for the observer to emit and ui to update
    act(() => {
      emitOnCreateChannel(dataBank.channel());
    });

    // Make sure that the added channel is visible
    expect(getAllByTestId("Channel Card").length).toEqual(1);
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°æ›´å¤šçš„æµ‹è¯•ã€‚

## [](#end-to-end-tests)ç«¯åˆ°ç«¯æµ‹è¯•

æˆ‘ä»¬å°†ä½¿ç”¨ [Cypress](https://www.cypress.io/) è¿›è¡Œæˆ‘ä»¬çš„ E2E æµ‹è¯•ï¼Œå› ä¸ºå®ƒæœ‰ç›¸å¯¹æ›´å¥½çš„å¼€å‘ä½“éªŒ(åœ¨æˆ‘çœ‹æ¥),ä½†æ˜¯å¦‚æœä½ éœ€è¦åœ¨å¤šç§æµè§ˆå™¨ä¸­è¿è¡Œä½ çš„æµ‹è¯•æˆ–è€…ä¸æ˜¯ç‰¹åˆ«å–œæ¬¢ä½¿ç”¨ Cypressï¼Œé‚£ä¹ˆ [testcafe](https://devexpress.github.io/testcafe/) å¯èƒ½æ˜¯ä½ æ›´å¥½çš„é€‰æ‹©ã€‚

[![Cypress running tests](../Images/f5142c03200d4a3d3940d1b808db99dc.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--W010_PyF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/7huy0zlmb5mz89hp6eun.gif)

### [](#preparing-the-test-environment)å‡†å¤‡æµ‹è¯•ç¯å¢ƒ

æˆ‘ä»¬å°†ä½¿ç”¨ Amplify cli çš„[å†…ç½®çš„`mock`æ–¹æ³•](https://aws.amazon.com/blogs/aws/new-local-mocking-and-testing-with-the-amplify-cli/)æ¥æ¨¡æ‹Ÿæ•´ä¸ª Amplify APIã€‚

ç¡®ä¿æ‚¨æ‹¥æœ‰çš„ amplify ç‰ˆæœ¬> = 1.11.0(å¸¦`amplify --version`)å¹¶ä¸”å®‰è£…äº† java(API mock ä½¿ç”¨çš„ DynamoDBLocal æ˜¯ä¸€ä¸ª Java åº”ç”¨ç¨‹åº)ã€‚

ä¸”åœ¨åˆå§‹åŒ–æ”¾å¤§é¡¹ç›®è¿è¡Œä¸­:`amplify mock api`

è¿™å°†åœ¨æ‚¨çš„æœ¬åœ°æœºå™¨ä¸Šåˆ›å»ºæ‚¨çš„åº”ç”¨çš„äº‘ç¯å¢ƒçš„å‰¯æœ¬ï¼Œå¹¶æ›´æ–°åº”ç”¨é…ç½®ä»¥æŒ‡å‘å®ƒ(é€šè¿‡æ›´æ–°`src/aws-exports.js`)ã€‚

è¿è¡Œè¯¥å‘½ä»¤åï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨åº”ç”¨ç¨‹åº(`npm run dev`)ï¼Œå®ƒå°†å®Œå…¨æŒ‰ç…§ä»¥å‰çš„æ–¹å¼å·¥ä½œï¼Œä½†å°†è¿æ¥åˆ°æœ¬åœ°æ•°æ®åº“ï¼Œè€Œä¸æ˜¯è¿œç¨‹æ•°æ®åº“ã€‚

å®‰è£…æ”¯æŒ TypeScript çš„ Cypress éå¸¸ç®€å•:

1.  å®‰è£… Cypress å¹¶åˆå§‹åŒ–:`yarn add -D cypress && yarn cypress --init`
2.  å®‰è£…[`add-typescript-to-cypress`T3:`yarn add -D @bahmutov/add-typescript-to-cypress`](https://github.com/bahmutov/add-typescript-to-cypress)
3.  ğŸ‘å°†ç±»å‹è„šæœ¬æµ‹è¯•æ·»åŠ åˆ°`cypress/integration/`ç›®å½•ä¸­

### [](#adding-tests)æ·»åŠ æµ‹è¯•

E2E æµ‹è¯•åº”è¯¥åƒç”¨æˆ·æµè§ˆåº”ç”¨ç¨‹åºä¸€æ ·ã€‚
æˆ‘ä»¬å°†ä½¿ç”¨ [`@testing-library/cypress`](https://testing-library.com/docs/cypress-testing-library/intro) åœ¨ Cypress å’Œ Jest æµ‹è¯•ä¹‹é—´å…±äº«ä»£ç (ui é€‰æ‹©å™¨)ã€‚ä¸€ä¸ªç¡®ä¿ç”¨æˆ·å¯ä»¥é˜…è¯»å’Œç¼–è¾‘ä»–ä»¬çš„ä¸ªäººèµ„æ–™ä¿¡æ¯çš„ cypress æµ‹è¯•å¥—ä»¶çš„ä¾‹å­å¦‚ä¸‹:

```
 // Note that the code for our selectors is almost identical to the selectors used with Jest
// This is thanks to @testing-library/react & @testing-library/cypress 
// Profile selectors
const profile = {
  form: (cypress = cy) => cypress.getByLabelText("Profile Form"),
  submit: () => cy.getByLabelText("Profile Form Submit Button"),
  username: () => cy.getByLabelText("Username"),
  bio: () => cy.getByLabelText("Bio"),
  url: () => cy.getByLabelText("Url")
};

// Header selectors
const header = {
  root: () => cy.getByLabelText("Header Navigation").should("be.visible"),
  me: () =>
    header
      .root()
      .within(() => cy.getByText("My Profile"))
      .should("be.visible"),
  channels: () =>
    header
      .root()
      .within(() => cy.getByText("Channels"))
      .should("be.visible")
};

describe("My Profile", () => {
  beforeEach(() => {
    cy.visit(BASE_URL);
  });
  afterEach(() => {
    // For video to better capture what happened
    cy.wait(1000);
  });
  it("Can visit profile and set information", () => {
    const user = {
      name: "Test username",
      url: "https://test-url.test",
      bio: "Bio Test @ Test BIO"
    };
    header.me().click();
    cy.location("href").should("contain", "/me");
    profile.username().type(`${user.name}{enter}`);
    cy.title().should("contain", `${user.name}'s Profile`);
    profile.bio().type(`${user.bio}{enter}`);
    profile.url().type(`${user.url}`);
    profile.submit().click();

    // Make sure data is persisted between sessions
    cy.reload();
    profile.username().should("contain.value", user.name);
    profile.bio().should("contain.value", user.bio);
    profile.url().should("contain.value", user.url);
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°æ›´å¤šçš„ TypeScript Cypress æµ‹è¯•[ã€‚](https://github.com/rakannimer/pagination-and-sorting-with-aws-amplify/tree/master/cypress/integration)

## [](#adding-test-scripts-to-raw-packagejson-endraw-)æ·»åŠ æµ‹è¯•è„šæœ¬åˆ°`package.json`

å›é¡¾ç”¨äºè¿è¡Œæˆ‘ä»¬ä¸åŒæµ‹è¯•çš„è„šæœ¬:

```
{  "scripts":  {  "test:static":  "yarn lint && yarn tsc",  "test:jest":  "yarn jest",  "test:e2e":  "(amplify mock api &) && wait-on http-get://localhost:20002 && kill-port 3000 && (yarn dev &) && wait-on http-get://localhost:3000 && cypress run --env PORT=3000",  "test:e2e:dev":  "(amplify mock api &) && wait-on http-get://localhost:20002 && kill-port 3000 && (yarn dev &) && wait-on http-get://localhost:3000 && cypress open --env PORT=3000",  "test":  "yarn test:static && yarn test:jest"  },  "hooks":  {  "pre-commit":  "prettier --write \"src/*.ts\"  \"src/**/*.ts*\"",  "pre-push":  "yarn test"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#running-tests-from-the-amplify-console-on-every-commit)åœ¨æ¯æ¬¡æäº¤æ—¶ä» Amplify æ§åˆ¶å°è¿è¡Œæµ‹è¯•

æˆ‘ä»¬åªéœ€è¦å‘Šè¯‰ Amplify Console åœ¨æ¯æ¬¡æäº¤ä¹‹å‰è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸‹é¢çš„`amplify.yml`

```
version: 0.1
frontend:
  phases:
    preBuild:
      commands:
        - yarn install
    build:
      commands:
        # This makes sure that the commit is not deployed if the tests fail.
        - yarn run test && yarn run build
  artifacts:
    baseDirectory: build
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/* 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#wrapping-up)åŒ…è£…å®Œæ¯•

æˆ‘ä»¬åœ¨ç°æœ‰çš„èŠå¤©åº”ç”¨ä¸­æ·»åŠ äº†é™æ€ã€å•å…ƒã€é›†æˆå’Œç«¯åˆ°ç«¯æµ‹è¯•ï¼Œè¯¥åº”ç”¨ä½¿ç”¨ Amplify APIï¼Œå¹¶åœ¨æäº¤å’Œæ¨é€ä»£ç ä¹‹å‰ä½¿ç”¨ git hooks è¿è¡Œè¿™äº›æµ‹è¯•ï¼Œåœ¨éƒ¨ç½² Amplify æ§åˆ¶å°ä¹‹å‰åœ¨äº‘ä¸Šè¿è¡Œè¿™äº›æµ‹è¯•ã€‚

å¦‚æœä½ æƒ³æ›´æ·±å…¥ï¼Œç¡®ä¿å…‹éš†ä»£ç åº“å¹¶åœ¨æœ¬åœ°è¿›è¡Œ Jest å’Œ Cypress æµ‹è¯•ã€‚

å¹²æ¯ï¼