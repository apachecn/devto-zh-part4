# ç”¨ 40 è¡Œä»£ç æ„å»ºè‡ªå·±çš„ç±»ä¼¼ MobX çš„çŠ¶æ€ç®¡ç†åº“

> åŸæ–‡:[https://dev . to/michalczaplinski/build-your-own-mobx-like-state-management-library-in-40-lines-of-code-43i 6](https://dev.to/michalczaplinski/build-your-own-mobx-like-state-management-library-in-40-lines-of-code-43i6)

âš ï¸ **æ³¨æ„:è¿™ç¯‡æ–‡ç« å‡è®¾è¯»è€…å¯¹ react** éå¸¸ç†Ÿæ‚‰ã€‚ä½ ä¸éœ€è¦æˆä¸ºä¸“å®¶ï¼Œå¦‚æœä½ ä»¥å‰ç”¨è¿‡ï¼Œæˆ‘ä¿è¯ä½ ä¼šåšå¾—å¾ˆå¥½ğŸ™‚ã€‚

å¦‚æœä½ å–œæ¬¢è§†é¢‘ç‰ˆæœ¬ï¼Œçœ‹çœ‹è¿™ç¯‡åšæ–‡æ‰€åŸºäºçš„æˆ‘çš„ [meetup talk](https://youtu.be/S2x4WrbVYEk?t=5167) (ä¸å¹¸çš„æ˜¯ï¼Œè§†é¢‘è´¨é‡ä¸æ˜¯å¾ˆå¥½)ã€‚è¿˜æœ‰ï¼Œè¿™æ˜¯æ¥è‡ª https://czaplinski.io/blog/make-your-own-mobx/çš„[çš„æ¨ªå¸–ï¼](https://czaplinski.io/blog/make-your-own-mobx/)

### [](#what-the-big-deal-is-about-)æœ‰ä»€ä¹ˆå¤§ä¸äº†çš„ï¼Ÿ

æ‚¨æ˜¯å¦ä¸€ç›´åœ¨ä½¿ç”¨ MobX æˆ–ç±»ä¼¼çš„çŠ¶æ€ç®¡ç†åº“ï¼Œå¹¶ä¸”æƒ³çŸ¥é“å½“æ‚¨çš„ä¸€äº›æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒæ˜¯å¦‚ä½•â€œçŸ¥é“â€å¦‚ä½•ä»¥åŠä½•æ—¶æ›´æ–°æ‚¨çš„ç»„ä»¶çš„ï¼Ÿçœ‹çœ‹ä¸‹é¢è¿™ä¸ªç›´æ¥æ¥è‡ª MobX [æ–‡æ¡£](https://mobx.js.org/refguide/observer-component.html)çš„ä»£ç ç¤ºä¾‹:

```
import {observer} from "mobx-react";

var timerData = observable({
  secondsPassed: 0
});

setInterval(() => {
  timerData.secondsPassed++;
}, 1000);

@observer class Timer extends React.Component {
  render() {
    return (
      <span>
        Seconds passed: {this.props.timerData.secondsPassed} 
      </span>
    )
  }
};

ReactDOM.render(<Timer timerData={timerData} />, document.body); 
```

react *å®é™…ä¸Š*æ˜¯å¦‚ä½•çŸ¥é“`secondsPassed`çš„å˜åŒ–åº”è¯¥è§¦å‘é‡æ–°æ¸²æŸ“çš„å‘¢ï¼Ÿå¥½äº†ï¼Œä¸è¦å†æƒ³äº†ï¼Œå› ä¸ºä»Šå¤©æˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åˆ›å»ºæ‚¨è‡ªå·±çš„çŠ¶æ€ç®¡ç†åº“ï¼Œå®ƒå°†è¦†ç›– 90%çš„ç”¨ä¾‹ï¼å½“ç„¶ï¼Œå¦å¤–çš„ 10%æ˜¯ä¼—å¤šè¾¹ç¼˜æƒ…å†µã€å¥‡æ€ªçš„æµè§ˆå™¨é”™è¯¯ã€å‘ç”¨æˆ·æä¾›æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯ç­‰ç­‰çš„åŸå› ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰è®©å®ƒå‡†å¤‡å¥½æŠ•å…¥ç”Ÿäº§ï¼Œåªæ˜¯è¯•å›¾é€†å‘å·¥ç¨‹çŠ¶æ€ç®¡ç†çš„å·¥ä½œæ–¹å¼ï¼Œå¹¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å­¦ä¹ ä¸€äº›ä¸œè¥¿ï¼æˆ‘ä»¬èµ°å§ï¼

#### [](#caveats)è¯´æ˜:

*   æˆ‘ä»¬ä½¿ç”¨ react ä½œä¸ºä¸€ä¸ªè§†å›¾åº“ï¼Œä½†æ˜¯æ²¡æœ‰ç†ç”±å®ƒä¸èƒ½ä¸å…¶ä»–åŸºäºç»„ä»¶çš„åº“(Vueï¼ŒAngularï¼Œæ— è®ºä»€ä¹ˆ)ä¸€èµ·å·¥ä½œğŸ™‚).
*   å®ƒåªèƒ½ä¸ react çš„ç±»ç»„ä»¶ä¸€èµ·å·¥ä½œã€‚æ²¡æœ‰æŠ€æœ¯ä¸Šçš„åŸå› ä¸ºä»€ä¹ˆå®ƒä¸èƒ½ä¸åŠŸèƒ½ç»„ä»¶ä¸€èµ·å·¥ä½œï¼Œä½†æ˜¯æˆ‘ä»¬è¯•å›¾å°½å¯èƒ½åœ°ä¿æŒæœ€å°çš„å®ç°ã€‚ä½¿*å’Œ*ä¸å‡½æ•°ç»„ä»¶ä¸€èµ·å·¥ä½œå®é™…ä¸Šä¼šèŠ±è´¹ä¸¤å€çš„ä»£ç (ç»§ç»­é˜…è¯»ï¼Œæ›´å¤šç»†èŠ‚è§ä¸‹æ–‡)
*   æˆ‘ä»¬å°†åªå…è®¸æ¯ä¸ªåº”ç”¨ç¨‹åºä¸€ä¸ªæ•°æ®å­˜å‚¨ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»å°†æ‰€æœ‰çŠ¶æ€å­˜å‚¨åœ¨ä¸€ä¸ª JS å¯¹è±¡ä¸­ã€‚åŒæ ·ï¼Œè¿™æ˜¯æˆ‘ä¸ºäº†å…³æ³¨æ ¸å¿ƒç®—æ³•è€Œè®¾ç½®çš„ä»»æ„é™åˆ¶ã€‚

### [](#our-api)æˆ‘ä»¬çš„ API

åº“ä½œè€…åº”è¯¥é—®è‡ªå·±çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯:â€œæˆ‘å¸Œæœ›æˆ‘çš„ API æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿâ€ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å°†ç”¨æˆ·éœ€è¦å­¦ä¹ çš„æ¦‚å¿µæ•°é‡ä¿æŒåœ¨ç»å¯¹æœ€ä½æ°´å¹³ã€‚è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œå—[ååº”ç®€å•çŠ¶æ€](https://github.com/solkimicreb/react-easy-state/)çš„å¯å‘ï¼Œæˆ‘å¸Œæœ›æˆ‘ä»¬çš„åº“åªåŒ…å«ä¸¤ä¸ªå‡½æ•°:`store`å’Œ`view`:

*   å‡½æ•°åŒ…è£…äº†ä¸€ä¸ªåŒ…å«æˆ‘ä»¬çŠ¶æ€çš„å¯¹è±¡ã€‚
*   `view`å‡½æ•°åŒ…è£…ä¸€ä¸ª react ç»„ä»¶ï¼Œå¹¶ä½¿å…¶*å¯¹çŠ¶æ€å˜åŒ–åšå‡ºååº”*ã€‚

è®©æˆ‘ä»¬ç§°æˆ‘ä»¬çš„å›¾ä¹¦é¦†ä¸º`observablabla`ã€‚è¿™æ˜¯ä½¿ç”¨`observablabla`çš„â€œHello Worldâ€åº”ç”¨ç¨‹åºçš„å¤–è§‚:

```
import React from "react";
import { store, view } from "observablabla";

const state = store({ text: "Hello World!" });

class Hello extends React.Component {
  render() {
    return <div> {state.text} </div>
  }
}; 
```

ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬ç»§ç»­å®é™…æ„å»ºè¿™ä¸ªä¸œè¥¿ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦èµ°ä¸€ç‚¹å¼¯è·¯ï¼Œç†è§£ javascript [ä»£ç†](https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Proxy)æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå› ä¸ºå®ƒä»¬æ˜¯è®©æˆ‘ä»¬çš„ç»„ä»¶*å¯¹æˆ‘ä»¬çš„`store`å˜åŒ–åšå‡ºååº”*çš„ç§˜æ–¹ã€‚å¦‚æœä½ å·²ç»ç†Ÿæ‚‰å®ƒä»¬çš„æ„Ÿè§‰ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°[å®ç°](#implementation)ã€‚

### [](#proxies)ä»£ç†äºº

ES2015 æ ‡å‡†å°†ä»£ç†æ·»åŠ åˆ° javascript ä¸­ï¼Œä½†ä¸[ç±»](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/class)æˆ–[ç®­å¤´å‡½æ•°](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions)ä¸åŒï¼Œå®ƒä»¬å¹¶æ²¡æœ‰è¢«å¹¿æ³›è®¨è®ºï¼Œæ‰€ä»¥å¦‚æœä½ ä»æœªå¬è¯´è¿‡å®ƒä»¬ï¼Œä¸è¦éš¾è¿‡ğŸ™‚ã€‚

å®ƒä»¬å…è®¸ä½ å®šåˆ¶ä¸€ä¸ªå¯¹è±¡çš„è¡Œä¸ºã€‚æˆ‘ä»¬è¿™æ ·è¯´æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæ‚¨å¯èƒ½ç†Ÿæ‚‰ [getters](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get) å’Œ [setters](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/set) ï¼Œå®ƒä»¬å…è®¸æ‚¨å®šä¹‰åœ¨æŸ¥æ‰¾(getters)æˆ–è®¾ç½®(setters)å¯¹è±¡å±æ€§æ—¶è°ƒç”¨çš„è‡ªå®šä¹‰å‡½æ•°ã€‚ä»£ç†å°±åƒç±»å›ºé†‡ä¸Šçš„ getters å’Œ settersã€‚å®ƒä»¬å…è®¸ä½ ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡è¡Œä¸ºçš„æ¯ä¸€ä¸ªæ–¹é¢ï¼Œè€Œä¸ä»…ä»…æ˜¯å±æ€§çš„è®¾ç½®å’Œè·å–ã€‚è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„ä»£ç ä¾‹å­æ¥çœ‹çœ‹è¿™æ„å‘³ç€ä»€ä¹ˆ:

```
const target = {
  number: 42,
};

const handler = {};

const proxy = new Proxy(target, handler);
proxy.number;  // 42 
```

è¿™æ˜¯â€œä½ å¥½ä¸–ç•Œï¼â€ä»£ç†â€”â€”**ç›®æ ‡**å’Œ**ä»£ç†**å¯¹è±¡åœ¨ç»“æ„ä¸Šæ˜¯ç›¸åŒçš„ã€‚å› è€Œ:

```
JSON.stringify(proxy) === JSON.stringify(target) // true 
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™æˆ‘ä»¬çš„`handler`å¯¹è±¡æ·»åŠ **é™·é˜±**æ¥è®©æˆ‘ä»¬çš„ä»£ç†å˜å¾—æ›´æœ‰è¶£ä¸€ç‚¹ã€‚é™·é˜±åªæ˜¯å®šåˆ¶`get`ã€`set`ã€`delete`æ“ä½œç­‰è¡Œä¸ºçš„å¸¸è§„æ–¹æ³•ã€‚è®©æˆ‘ä»¬ä¿®æ”¹ä»£ç ç¤ºä¾‹:

```
// highlight-range{7-9}
const target = {
  number: 42,
};

const handler = {
  // `obj` is the proxied object, `prop` is the property being accessed.
  get: (obj, prop) => {
    return obj[prop] + 1;
  },
};

const proxy = new Proxy(target, handler);

target.number; //=>  This is still 42
proxy.number;  //=>  This now returns 43 ! 
```

æˆ‘ä»¬æœ€åˆçš„å¯¹è±¡æ˜¯æœªä¿®æ”¹çš„ï¼Œä½†æ˜¯ç°åœ¨å½“æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬çš„`proxy`å¯¹è±¡æ—¶ï¼Œå®ƒâ€œä»£ç†â€é€šè¿‡`get`é™·é˜±è®¿é—®çš„æ¯ä¸ªå±æ€§ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥å¯¹`set`æ“ä½œ:
åšåŒæ ·çš„äº‹æƒ…

```
// highlight-range{5-8}
const handler = {
  get: (obj, prop) => {
    return obj[prop] + 1;
  },
  set: (obj, prop, value) => {
    obj[prop] = value;
    obj.greeting = `Hello, ${value}!`;
  },
};

proxy.name = "Michal";
proxy.name;       //=>  Michal
proxy.greeting;   //=>  Hello, Michal! 
```

å¦‚æœä»£ç†ä»ç„¶ä¸ä¸ºä½ ç‚¹å‡»ï¼Œè¯»è€…ï¼Œç»§ç»­é˜…è¯»[è¿™ç¯‡æ–‡ç« ](https://ponyfoo.com/articles/es6-proxies-in-depth)ï¼Œæˆ‘ä¼šåœ¨è¿™é‡Œç­‰å¾…ğŸ™‚ã€‚

### [](#implementation)å®ç°

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬æ˜ç™½äº†ä»£ç†æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å®ç°å®ƒå‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå›¾è¡¨:

[![architecture](../Images/5b1f9e9bbb9b8798f6ef5be3874de90b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Qus24V_1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/8s47fwl0wb4pc5nkl4jt.png)

ä½ å¯ä»¥æƒ³è±¡ç»¿è‰²ã€è“è‰²å’Œçº¢è‰²çš„æ¡†å¯¹åº”ç€å„è‡ª react ç»„ä»¶çš„æ¸²æŸ“æ–¹æ³•ã€‚**å•†åº—**åªæ˜¯ä¸€ä¸ªåŒ…è£…æœ‰`store`åŠŸèƒ½çš„æ™®é€šå¯¹è±¡ã€‚æ¯å½“è¿™ä¸ªå­˜å‚¨ä¸­çš„æŸä¸ªå€¼è¢«æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›**é‡æ–°å‘ˆç°**ä½¿ç”¨è¯¥çŠ¶æ€çš„æ¯ä¸ªç»„ä»¶ã€‚æˆ‘ä»¬å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ

ç­”æ¡ˆåœ¨å³æ‰‹è¾¹ï¼æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„åº“åœ¨å•†åº—ä¸­å¯ç”¨çš„æ¯ä¸ªå±æ€§å’Œå½“å±æ€§æ”¹å˜æ—¶åº”è¯¥é‡æ–°å‘ˆç°çš„ç»„ä»¶åˆ—è¡¨ä¹‹é—´å»ºç«‹æ˜ å°„ã€‚æˆ‘ä»¬å°†æŠŠè¿™ä¸ªæ˜ å°„å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º`reactionsMap`çš„å˜é‡ä¸­ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬çš„å›¾ä¸­ï¼Œæ¯å½“`store.text`æ›´æ–°çš„æ—¶å€™ï¼Œ`Component1`å’Œ`Component3`åº”è¯¥é‡æ–°æ¸²æŸ“ï¼Œä½†æ˜¯*ä¸æ˜¯* `Component3`ã€‚

æœ‰äº†è¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å‹¾ç”»è¿™ä¸ªåº“çš„å®ç°äº†:

```
// highlight-range{3-6}
const reactionsMap = {};

// It will point to a component instance that is being rendered. 
// We are going to use it later on ğŸ™‚
let currentlyRenderingComponent;

// The handler currently does nothing so far...
const handler = {
  get: function(target, key) {
    return target[key];   
  },
  set: function(target, key, value) {
    target[key] = value;
    return true;
  }
};

// For now, this just does nothing
export function store(object) {
  return new Proxy(object, handler);
}

// And this also does not do anything yet...
export function view(MyComponent) {
  return MyComponent;
} 
```

è®©æˆ‘ä»¬é¦–å…ˆç”¨é¢å¤–çš„åŠŸèƒ½æ¥æ‰©å……`view`å‡½æ•°...

```
// highlight-range{19-28}
const reactionsMap = {};
let currentlyRenderingComponent;

const handler = {
  get: function(target, key) {
    return target[key];   
  },
  set: function(target, key, value) {
    target[key] = value;
    return true;
  }
};

export function store(object) {
  return new Proxy(object, handler);
}

export function view(MyComponent) {
  return class Observer extends MyComponent {
    ID = `${Math.floor(Math.random() * 10e9)}`;

    render() {
      currentlyRenderingComponent = this;
      const renderValue = super.render();
      currentlyRenderingComponent = undefined;
      return renderValue;
    }
  };
} 
```

æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ç±»ç»§æ‰¿æ¥æ‰©å±•`MyComponent`çš„åŠŸèƒ½ã€‚æˆ‘ä»¬çš„`view`å‡½æ•°åªæœ‰åœ¨æˆ‘ä»¬å°†ä¸€ä¸ªç±»ç»„ä»¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒæ—¶æ‰ä¼šèµ·ä½œç”¨ã€‚å¦‚æœæˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªâ€œä¸¥è‚ƒâ€çš„åº“ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä»£ç æ¥æ£€æŸ¥`MyComponent`æ˜¯å¦æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœæ˜¯ï¼Œå°±è‡ªåŠ¨å°†å®ƒåŒ…è£…åœ¨ä¸€ä¸ªç±»ä¸­([ï¼Œè¿™æ˜¯ MobX åœ¨](https://github.com/mobxjs/mobx-react/blob/master/src/observer.js#L339:L341)çš„å¹•åå®é™…åšçš„äº‹æƒ…)ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨ä¸æ‰“ç®—è¿™ä¹ˆåšï¼ŒåŸå› åªæ˜¯æƒ³è®©äº‹æƒ…å˜å¾—ç®€å•ã€‚

æˆ‘ä»¬åˆ†é…ç»™ç»„ä»¶çš„`ID`å°†åœ¨ä»¥åè¢«ç”¨åˆ°ã€‚ç°åœ¨ï¼Œåªè¦çŸ¥é“æˆ‘ä»¬éœ€è¦å®ƒï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è·Ÿè¸ªç»„ä»¶çš„èº«ä»½ã€‚

æœ‰è¶£çš„äº‹æƒ…å‘ç”Ÿåœ¨`render`å‡½æ•°çš„å†…éƒ¨**ã€‚è¯•ç€æƒ³è±¡ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬å‘ˆç°ä¸€ä¸ªç”¨æˆ‘ä»¬çš„`view`å‡½æ•°åŒ…è£…çš„ç»„ä»¶æ—¶ï¼Œé‡‡å–äº†ä»€ä¹ˆæ­¥éª¤ã€‚æˆ‘ä»¬**è®¾ç½®**å’Œ**å–æ¶ˆè®¾ç½®** `currentlyRenderingComponent`çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥è·Ÿè¸ªå“ªä¸ªç»„ä»¶æ­£åœ¨è¢«æ¸²æŸ“ä»¥åŠä½•æ—¶è¢«æ¸²æŸ“ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦è¿™æ ·åšï¼Ÿ**

é€šè¿‡æŸ¥çœ‹`store`å‡½æ•°çš„æ›´æ–°å®ç°:
ï¼Œè¿™ä¸€ç‚¹å°†å˜å¾—å¾ˆæ¸…æ¥š

```
// highlight-range{2-23}
const handler = {
  get: function(target, key) {
    // If there is no component currently rendering it means that 
    // we have accessed the store from outside of a react component. 
    // We can just return the value for the given key
    if (typeof currentlyRenderingComponent === "undefined") {
      return target[key];
    }
    // In case we don't track the `key` yet, start tracking it
    // and set its value to currently rendering component 
    if (!reactionsMap[key]) {
      reactionsMap[key] = [currentlyRenderingComponent];
    }
    // We already track the `key`, so let's check 
    // if we track the currentlyRendering component for that key.
    const hasComponent = reactionsMap[key].find(
      comp => comp.ID === currentlyRenderingComponent.ID
    );
    if (!hasComponent) {
      reactionsMap[key].push(currentlyRenderingComponent);
    }
    return target[key];
  },
  set: function(target, key, value) {
    target[key] = value;
    return true;
  }
};

export function store(object) {
  return new Proxy(object, handler);
} 
```

æˆ‘ä»¬çš„æ–°å®ç°æœ‰ä¸€ä¸ªæ–°çš„æœ‰è¶£çš„å‰¯ä½œç”¨:æ¯å½“æˆ‘ä»¬è®¿é—®æˆ‘ä»¬å•†åº—çš„ä¸€äº›å±æ€§æ—¶ï¼Œå®ƒæ£€æŸ¥ä»€ä¹ˆç»„ä»¶æ˜¯**å½“å‰æ­£åœ¨å‘ˆç°çš„**ã€‚ä½¿ç”¨è¿™ä¸ªèªæ˜çš„æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•åœ°æ£€æŸ¥æ¯ä¸ªè¢«è®¿é—®çš„å•†åº—å±æ€§çš„å€¼æ¥æ„å»ºæˆ‘ä»¬çš„`reactionsMap`ã€‚

å¾ˆå¥½ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å»ºç«‹äº†æˆ‘ä»¬çš„ååº”å›¾(å°†åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶å‘ç”Ÿ)ã€‚ä½†æ˜¯æˆ‘ä»¬ä»ç„¶éœ€è¦ä¸€ç§æ–¹æ³•æ¥å‘Šè¯‰ react åœ¨æˆ‘ä»¬çš„å•†åº—ä¸­æ·»åŠ æ–°çš„å±æ€§æ—¶æ›´æ–°ç»„ä»¶ã€‚è®°ä½ï¼Œæˆ‘ä»¬åªæƒ³æ›´æ–°**ä½¿ç”¨**æ›´æ–°å±æ€§çš„ç»„ä»¶ã€‚å—¯ï¼Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨æ¥è‡ªæˆ‘ä»¬`reactionsMap` :
çš„æ•°æ®

```
// highlight-range{21-25}
const reactionsMap = {};
let currentlyRenderingComponent;

const handler = {
  get: function(target, key) {
    if (typeof currentlyRenderingComponent === "undefined") {
      return target[key];
    }
    if (!reactionsMap[key]) {
      reactionsMap[key] = [currentlyRenderingComponent];
    }
    const hasComponent = reactionsMap[key].find(
      comp => comp.ID === currentlyRenderingComponent.ID
    );
    if (!hasComponent) {
      reactionsMap[key].push(currentlyRenderingComponent);
    }
    return target[key];
  },

  set: function(target, key, value) {
    reactionsMap[key].forEach(component => component.forceUpdate());
    target[key] = value;
    return true;
  }
};

export function store(object) {
  return new Proxy(object, handler);
}

export function view(MyComponent) {
  return class Observer extends MyComponent {
    ID = `${Math.floor(Math.random() * 10e9)}`;

    render() {
      currentlyRenderingComponent = this;
      const renderValue = super.render();
      currentlyRenderingComponent = undefined;
      return renderValue;
    }
  };
} 
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å®é™…ä¸Šå·²ç»å®Œæˆäº†å®æ–½ï¼ğŸ‰

ä½ å¯ä»¥åœ¨ [Codesandbox](https://codesandbox.io/s/v191wkn77) ä¸ŠæŸ¥çœ‹ä¸€ä¸ªå®æ—¶ç‰ˆæœ¬ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚

å¦‚æœä½ å–œæ¬¢è¿™ä¸ªï¼Œä½ å¯ä»¥åœ¨ twitter ä¸Šå…³æ³¨æˆ‘ï¼Œäº†è§£æ›´å¤šå…³äº JS çš„äº‹æƒ…ã€‚å¦‚æœä½ è®¨åŒå®ƒï¼Œä½ å¯ä»¥åœ¨[æ¨ç‰¹](https://twitter.com/c_z_a_p_l_a)ä¸Šå…³æ³¨æˆ‘ï¼Œå‘Šè¯‰æˆ‘ä¸ºä»€ä¹ˆå®ƒå¾ˆç³Ÿç³•ğŸ˜›ã€‚è¯´çœŸçš„ï¼Œæˆ‘æ€»æ˜¯è¶…çº§é«˜å…´å¬åˆ°ä½ çš„æƒ³æ³•ï¼Œæ²¡æœ‰è¯„è®ºå¤ªå°æˆ–å¤ªå‚»ï¼å¦‚æœä½ å‘ç°ä»»ä½•é”™è¯¯ï¼Œè®©æˆ‘çŸ¥é“ã€‚è¿™ä¸ªå¸–å­çš„æ¥æºå°±åœ¨è¿™é‡Œ:[https://github . com/michalczaplinski/michalczaplinski . github . io](https://github.com/michalczaplinski/michalczaplinski.github.io)

æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œæˆ‘æƒ³å¯¹ [MobX](https://github.com/mobxjs/mobx/) å’Œ [react-easy-state](https://github.com/mobxjs/mobx/) è¿™ä¸¤ä¸ªä»¤äººæ•¬ç•çš„çŠ¶æ€ç®¡ç†åº“ä»¥åŠè¿™ç¯‡æ–‡ç« çš„ä¸»è¦çµæ„Ÿè¡¨ç¤ºæ„Ÿè°¢ã€‚