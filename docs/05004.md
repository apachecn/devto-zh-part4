# è°ƒæŸ¥æœ‰é—®é¢˜çš„ Rails API ç«¯ç‚¹çš„æ€§èƒ½

> åŸæ–‡:[https://dev . to/mculp/investigating-the-performance-of-a-problem-rails-API-endpoint-3a 65](https://dev.to/mculp/investigating-the-performance-of-a-problematic-rails-api-endpoint-3a65)

æœ€è¿‘æˆ‘æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬çš„ä¸€ä¸ª API ç«¯ç‚¹å ç”¨äº†å¤§é‡èµ„æºï¼Œæ¯ä¸ªè¯·æ±‚éœ€è¦ 3 ç§’é’Ÿæ‰èƒ½å®Œæˆã€‚æˆ‘èƒ½å¤Ÿå°†å¹³å‡å†…å­˜ä½¿ç”¨é‡ä» 85mb å‡å°‘åˆ° 7mbï¼Œå¹¶å°†å¹³å‡è¯·æ±‚æŒç»­æ—¶é—´ä» 3000 æ¯«ç§’å‡å°‘åˆ° 150 æ¯«ç§’ã€‚æˆ‘å°†åœ¨è¿™ç¯‡æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»è¿™ä¸ªè¿‡ç¨‹ã€‚

[![latency graph before / after deployment](../Images/ecdb287684d351de8a955a8b428e0037.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--XqXldkz7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/s696d3znldxme6fcb241.png)

è®©æˆ‘ä»¬ä»å®‰è£…æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„å·¥å…·å¼€å§‹ã€‚

# [](#set-up-bullet)è®¾ç½®å­å¼¹

[bullet](https://github.com/flyerhzm/bullet) æ˜¯ä¸€å—å®çŸ³ï¼Œå¯ä»¥å¸®åŠ©æ‚¨è¯†åˆ«å’Œçº æ­£ N+1 ä¸ªæŸ¥è¯¢ã€‚

æˆ‘ä»¬å°†æŠŠå®ƒæ·»åŠ åˆ°æˆ‘ä»¬çš„ Gemfile:

```
group :development do
  gem 'bullet'
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯ç»™æˆ‘ä»¬çš„`config/application.rb` :

```
 config.after_initialize do
    Bullet.enable = true
    Bullet.rails_logger = true
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#set-up-rackminiprofiler)è®¾ç½®æœºæ¶å¾®å‹å‰–é¢ä»ª

[rack-mini-profiler](https://github.com/MiniProfiler/rack-mini-profiler) æ˜¯ä¸€ä¸ªæä¾›æ•°æ®åº“å’Œå†…å­˜åˆ†æçš„ä¸­é—´ä»¶ã€‚è®©æˆ‘ä»¬è®¾ç½®ä¸€ä¸‹ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ›´æ·±å…¥åœ°äº†è§£æ˜¯ä»€ä¹ˆå¯¼è‡´äº†æˆ‘ä»¬çš„é—®é¢˜ã€‚

æˆ‘ä»¬éœ€è¦å°†`rack-mini-profiler`å’Œ`memory_profiler`æ·»åŠ åˆ°æ•°æ®åº“ gem ä¸‹é¢çš„ Gemfile **ä¸­ï¼Œå¹¶è¿è¡Œ`bundle`æ¥å®‰è£…å®ƒã€‚** 

```
gem 'pg'
gem 'rack-mini-profiler'
gem 'memory_profiler' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒæ·»åŠ åˆ°`config/initializers/mini_profiler.rb` :

```
Rack::MiniProfiler.config.authorization_mode = :allow_all 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯ç”¨ rack-mini-profiler åï¼Œå®ƒä¼šä¿å­˜ä»¥å‰è¯·æ±‚çš„åˆ†æå™¨è¾“å‡ºï¼Œå¹¶åœ¨ä¸‹ä¸€ä¸ªåŠ è½½çš„ HTML é¡µé¢ä¸­æ’å…¥ä¸€ä¸ªæ ‡è®°ã€‚ä½†æˆ‘ä»¬åœ¨ä¸€ä¸ªåªæœ‰ API çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ‰€ä»¥ä¸ºäº†çœ‹åˆ°å¾½ç« ï¼Œæˆ‘ä»¬å¿…é¡»æä¾›ä¸€ä¸ª HTML é¡µé¢ã€‚

æ³¨æ„:å¦‚æœæ‚¨è®¡åˆ’å°†è¿™ä¸ªä»£ç ç­¾å…¥åˆ°æ‚¨çš„å›è´­åè®®ä¸­ï¼Œæ‚¨å°†å¸Œæœ›åœ¨`authorize_request` å‘¨å›´æ·»åŠ æŸç§[æˆæƒã€‚](https://github.com/MiniProfiler/rack-mini-profiler#access-control-in-non-development-environments)

è¿™æ˜¯æˆ‘çš„`PerformanceTestsController` :

```
class PerformanceTestsController < ActionController::Base
  before_action do
    Rack::MiniProfiler.authorize_request
  end

  def index
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`app/views/performance_tests/index.html` :

```
<body></body> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`config/routes.rb` :

```
 get '/performance_tests', to: 'performance_tests#index' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®¾ç½®å¥½ä¹‹åï¼Œå¦‚æœä½ åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€`/performance_tests`ï¼Œä½ åº”è¯¥ä¼šåœ¨å·¦ä¸Šè§’çœ‹åˆ°è¿™ä¸ªå¾½ç« ã€‚

[![Alt Text](../Images/4f35235352a5f9b04f557704200f0450.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--3dGD5cNz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/9aygp42wje3h2whm7w3g.png)

# [](#recreate-the-environment)å†ç°ç¯å¢ƒ

å½“æ‚¨åœ¨è°ƒæŸ¥ç”Ÿäº§æ€§èƒ½é—®é¢˜æ—¶ï¼Œæ‚¨å¸Œæœ›æµ‹è¯•ç¯å¢ƒå°½å¯èƒ½ä¸ç”Ÿäº§ç¯å¢ƒç›¸ä¼¼ã€‚åœ¨ Rails çš„å¼€å‘æ¨¡å¼ä¸­ï¼Œç±»ç¼“å­˜æ˜¯ç¦ç”¨çš„ï¼Œå› æ­¤å®Œæˆè¯·æ±‚æ‰€éœ€çš„æ—¶é—´å¯èƒ½ä¼šæœ‰å¾ˆå¤§å·®å¼‚ã€‚æˆ‘åœ¨æœ¬åœ°æœºå™¨ä¸Šä»¥ç”Ÿäº§æ¨¡å¼è¿è¡Œè¿™äº›æµ‹è¯•ï¼Œä½¿ç”¨çš„æ•°æ®é›†ä¸ prod db ä¸­çš„ç›¸ä¼¼ã€‚

# [](#isolate)éš”ç¦»

æˆ‘ä»¬ä½¿ç”¨ Ember ä½œä¸ºæˆ‘ä»¬çš„å‰ç«¯æ¡†æ¶ï¼Œå®ƒå¯ä»¥åœ¨é¡µé¢åŠ è½½æ—¶å¤šæ¬¡è°ƒç”¨ APIã€‚æˆ‘æƒ³éš”ç¦»æœ‰é—®é¢˜çš„ API è°ƒç”¨ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥å°½å¯èƒ½å¿«åœ°é‡å¤å®ƒã€‚ç«¯ç‚¹éœ€è¦ä¸€ä¸ªè®¤è¯å¤´ï¼Œæ‰€ä»¥æˆ‘åªæ˜¯ä½¿ç”¨ Chrome çš„ Copy as cURL å‡½æ•°ï¼Œåœ¨ä¸€ä¸ªå‘½ä»¤ä¸­è·å–æˆ‘éœ€è¦çš„ä¸€åˆ‡ã€‚

[![Copy as cURL](../Images/3e9091487d5353cf5f536ac3dd09d636.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ByUagWuu--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/t58p4g7uf14rs2qsq0y2.png)

# [](#benchmark)åŸºå‡†

ç°åœ¨æˆ‘ä»¬å·²ç»è®¾ç½®å¥½äº†ç¯å¢ƒå’Œå·¥å…·ï¼Œæ˜¯æ—¶å€™åŠ¨æ‰‹äº†ï¼Œè¯•ç€å¼„æ¸…æ¥šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚æ‰€è®¨è®ºçš„ç«¯ç‚¹æ˜¯`UsersController#index` :

```
def index
  users = User.joins(:roles).where(roles: { title: params[:roles] })          

  respond_with users, include: %w[roles groups]
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æˆ‘ä»¬å¼€å§‹è¿›è¡Œæ›´æ”¹ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åšçš„æ˜¯è·å¾—ä¸€ä¸ªåŸºå‡†æ§ä»¶ï¼Œå…¶ä»£ç å¤„äºå½“å‰çŠ¶æ€ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½ç¡®ä¿æˆ‘ä»¬è¦åšçš„æ”¹å˜æ˜¯çœŸæ­£çš„æ”¹è¿›ã€‚

rack-mini-profiler æœ‰[å‡ ä¸ªé€‰é¡¹](https://github.com/MiniProfiler/rack-mini-profiler#flamegraphs)å¯ä»¥é€šè¿‡`pp=`æŸ¥è¯¢å‚æ•°ä¼ é€’ï¼Œä½†æ˜¯æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ä¸¤ä¸ªé€‰é¡¹æ˜¯`pp=profile-memory`å’Œ`pp=enable`ã€‚

ç¬¬ä¸€ä¸ªè¯·æ±‚ä¼¼ä¹æ€»æ˜¯æ¯”åç»­è¯·æ±‚å ç”¨æ›´å¤šçš„èµ„æºï¼Œæ‰€ä»¥æˆ‘æ€»æ˜¯è§¦å‘è¯·æ±‚ä¸¤æ¬¡ï¼Œå¹¶ä»ç¬¬äºŒä¸ªè¯·æ±‚ä¸­è·å–åŸºå‡†ã€‚

å¥½äº†ï¼Œè®©æˆ‘ä»¬æ¥æ§åˆ¶ä¸€ä¸‹æˆ‘ä»¬çš„è®°å¿†:

```
# All Users (`/users?pp=profile-memory`)
Total allocated: 60047355 bytes (744989 objects)
Total retained:  1356020 bytes (8851 objects) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é™¤äº†å†…å­˜ä½¿ç”¨æƒ…å†µä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ£€æŸ¥ rack-mini-profiler æ ‡è®°ï¼Œå®ƒæ˜¾ç¤ºå…³äºå“åº”æ—¶é—´å’Œ SQL æŸ¥è¯¢çš„ä¿¡æ¯ã€‚æˆ‘ä»¬é€šè¿‡ä½¿ç”¨`pp=enable`æŸ¥è¯¢å‚æ•°ç„¶åæ‰“å¼€`/performance_tests`æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œå¦‚ä¸Šé¢ rack-mini-profiler è®¾ç½®éƒ¨åˆ†æ‰€è¿°ã€‚

```
# All Users (`/users?pp=enable`)
Total Duration: 7795ms
SQL Duration: 373ms
SQL Queries: 1139 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ğŸ˜±

è¿™å¤ªç³Ÿç³•äº†ï¼è®©æˆ‘ä»¬ä¿®ç†å®ƒã€‚

# [](#eliminating-n1-queries)æ¶ˆé™¤ N+1 ä¸ªæŸ¥è¯¢

æ¯ä¸ªè¯·æ±‚æ‰§è¡Œçš„ SQL æŸ¥è¯¢çš„æ•°é‡è¡¨æ˜æˆ‘ä»¬æœ‰ä¸€äº› N+1 é—®é¢˜ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ã€‚æˆ‘ä»¬å°†è¿›è¡Œä¸€é¡¹æ›´æ”¹ï¼Œç„¶åå†æ¬¡è¿è¡ŒåŸºå‡†æµ‹è¯•ã€‚

è®©æˆ‘ä»¬å°†`joins(:roles)`æ›´æ”¹ä¸º`includes(:roles, :groups)`,è¿™æ ·æˆ‘ä»¬çš„è§’è‰²å’Œç»„å°†ä¼šå¾ˆå¿«åŠ è½½ã€‚

```
def index
  users = User.includes(:roles, :groups).where(roles: { title: params[:roles] })

  respond_with users, include: %w[roles groups]
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»¥ä¸‹æ˜¯å¸¦æœ‰`includes` :
çš„åŸºå‡†æµ‹è¯•

```
Total allocated: 436705757 bytes (4119179 objects)
Total retained:  4646110 bytes (33480 objects)

Total Duration: 7209ms
SQL Duration: 355ms
SQL Queries: 1130 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ€¥åˆ‡åœ°åŠ è½½æ‰€æœ‰è¿™äº›è§’è‰²å®é™…ä¸Šå¯¼è‡´å†…å­˜ä½¿ç”¨é‡å¢åŠ äº† 7 å€ï¼æŒç»­æ—¶é—´å’ŒæŸ¥è¯¢æœ‰æ‰€å‡å°‘ï¼Œä½†è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›çš„è§£å†³æ–¹æ¡ˆã€‚

è®©æˆ‘ä»¬ä½¿ç”¨ rack-mini-profiler HTML æ ‡è®°æ¥æŸ¥çœ‹æ­£åœ¨æ‰§è¡Œçš„æŸ¥è¯¢ã€‚

[![rack-mini-profiler](../Images/336f4689bf8c5685ae51a1c11d4be5ad.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--W1NgsMyo--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/3aracu0rx0m71mabf2pz.png)

å½“æˆ‘å±•å¼€`1130 sql`é“¾æ¥çš„æ—¶å€™ï¼Œæˆ‘çœ‹åˆ°äº†å¾ˆå¤šç±»ä¼¼è¿™æ ·çš„æ¡ç›®:

```
app/serializers/user_serializer.rb:72:in `employee_id'
app/controllers/v1/users_controller.rb:53:in `index'
app/controllers/application_controller.rb:48:in `set_current_attrs'
SELECT  "employees".* FROM "employees" WHERE "employees"."user_id" = $1 LIMIT $2; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘è®¤ä¸ºé—®é¢˜ä¸»è¦å‡ºåœ¨åºåˆ—åŒ–å™¨å†…éƒ¨ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹é‚£é‡Œå‘ç”Ÿäº†ä»€ä¹ˆã€‚

```
class UserSerializer < ActiveModel::Serializer
  attributes :id,
             :email,
             :first_name,
             :last_name,
             :last_login_at,
             :employee_id

  has_one :employee
  has_many :assignments
  has_many :direct_roles
  has_many :roles, through: :assignments
  has_many :group_assignments
  has_many :groups, through: :group_assignments

  def employee_id
    object.employee&.id
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬æœ‰æ‰€å‘ç°äº†ï¼æ¯å½“ä¸€ä¸ª`User`å¯¹è±¡è¢«åºåˆ—åŒ–æ—¶ï¼Œæˆ‘ä»¬å°±å¯¹è¿™é‡Œåˆ—å‡ºçš„æ¯ä¸ªå…³è”å‘å‡ºæŸ¥è¯¢ã€‚æˆ‘ä»¬å¯ä»¥å°è¯•ç”¨`includes`åŠ è½½è¿™äº›å…³è”ä¸­çš„æ¯ä¸€ä¸ªï¼Œä½†æ˜¯å¦‚æœå¯¹äº`index`åŠ¨ä½œæˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦è¿™äº›å…³è”å‘¢ï¼Ÿ

å¾ˆå¿«çš„ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹`UsersController`ä¸­`index`æ—è¾¹çš„`show`åŠ¨ä½œã€‚

```
 def index
    users = User.includes(:roles, :groups).where(roles: { title: params[:roles] })

    respond_with users, include: %w[roles groups]
  end

  def show
    respond_with @user, include: %i[roles roles_tags assignments groups group_assignments groups.roles]
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`show`é€šè¿‡åŒä¸€ä¸ª`UserSerializer`ç±»åºåˆ—åŒ–ã€‚çœ‹èµ·æ¥è¿™äº›å…³è”å¼€å§‹è¢«æ·»åŠ åˆ°åºåˆ—åŒ–ç¨‹åºä¸­ï¼Œå› æ­¤å®ƒä»¬å°†è¢«åŒ…å«åœ¨`show`ç«¯ç‚¹ä¸­ã€‚

ç›®å‰ï¼Œæˆ‘åªå¯¹`index`è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ‰€ä»¥`show`å’Œå…¶ä»–ä»»ä½•ä½¿ç”¨`UserSerializer`çš„åŠ¨ä½œéƒ½ä¸ä¼šå—åˆ°å½±å“ã€‚æˆ‘è®¤ä¸ºå‰è¿›çš„é“è·¯æ˜¯åˆ›å»ºä¸€ä¸ªå…·æœ‰ç¨€ç–å­—æ®µé›†çš„ç‰¹å®šäº`index`çš„åºåˆ—åŒ–ç¨‹åºâ€”â€”æˆ‘ä»¬å°†åªåœ¨å“åº”ä¸­åŒ…å«æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚

```
# app/controllers/users_controller.rb
def index
  users = User.includes(:roles, :groups).where(roles: { title: params[:roles] })

  respond_with users, include: [:roles, :groups], each_serializer: Users::Index::UserSerializer
end

# app/serializers/users/index/user_serializer.rb
class Users::Index::UserSerializer < ActiveModel::Serializer
  attributes :id,
             :email,
             :first_name,
             :last_name,
             :last_login_at,
             :employee_id

  has_many :roles, through: :assignments
  has_many :groups, through: :group_assignments

  def employee_id
    object.employee&.id
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘åˆ é™¤äº†æ‰€æœ‰å…³è”ï¼Œé™¤äº†æˆ‘ä»¬æƒ³è¦åŠ è½½çš„å…³è”ï¼Œ`roles`å’Œ`groups`ã€‚è®©æˆ‘ä»¬æ£€æŸ¥æˆ‘ä»¬çš„æ•°å­—ã€‚

```
Total allocated: 242932074 bytes (2392253 objects)
Total retained:  2511484 bytes (18008 objects)

Total Duration: 3650ms
SQL Duration: 202ms
SQL Queries: 571 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé‡å¤§æ”¹è¿›ï¼æ­¤æ—¶ï¼Œæˆ‘æ£€æŸ¥äº†è¿™ä¸ªç«¯ç‚¹åœ¨æˆ‘ä»¬çš„å‰ç«¯åº”ç”¨ç¨‹åºä¸­è¢«è°ƒç”¨çš„ä½ç½®ï¼Œå¹¶éªŒè¯äº†æˆ‘ä»¬ä¸éœ€è¦è¢«ç§»é™¤çš„å…³è”ã€‚

ä½†æ˜¯ï¼Œ571 ä¸ªæŸ¥è¯¢ã€‚è®©æˆ‘ä»¬æ£€æŸ¥ Rails æ—¥å¿—çš„è¾“å‡ºï¼Œçœ‹çœ‹å®ƒæ˜¯å¦è¯†åˆ«äº†ä»»ä½• N+1 ä¸ªæŸ¥è¯¢ã€‚

```
USE eager loading detected
  User => [:employee]
  Add to your finder: :includes => [:employee]
Call stack
  /Users/mculp/sf/cs/app/serializers/users/index/user_serializer.rb:66:in `employee_id'

USE eager loading detected
  User => [:group_assignments]
  Add to your finder: :includes => [:group_assignments]
Call stack
  /Users/mculp/sf/cs/app/models/user.rb:229:in `roles'

USE eager loading detected
  User => [:assignments]
  Add to your finder: :includes => [:assignments]
Call stack
  /Users/mculp/sf/cs/app/controllers/v1/users_controller.rb:49:in `index' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ²¡é”™ã€‚è®©æˆ‘ä»¬å¼€å§‹åŠ è½½`employee`ã€`group_assignments`å’Œ`assignments`ã€‚

```
 def index
    users = User
              .includes(:roles, :groups, :employee, :group_assignments, :assignments)
              .where(roles: { title: params[:roles] })

    respond_with users, each_serializer: Users::Index::UserSerializer, include: [:roles, :groups]
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ•°å­—:

```
Total allocated: 80137296 bytes (825840 objects)
Total retained:  761444 bytes (5371 objects)

Total Duration: 1580ms
SQL Duration: 58ms
SQL Queries: 124 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆä¸€å¤§è¿›æ­¥ã€‚åœ¨é“è·¯æ—¥å¿—ä¸­ï¼Œå­å¼¹ä¸å†å‘æˆ‘ä»¬å°–å«ã€‚

åœ¨æ£€æŸ¥ rack-mini profiler ä¹‹åï¼Œæˆ‘çœ‹åˆ°æˆ‘ä»¬ä»ç„¶æœ‰ä¸€ä¸ª N+1:

```
app/models/user.rb:476:in `last_login_at'
app/controllers/v1/users_controller.rb:49:in `index'
app/controllers/application_controller.rb:48:in `set_current_attrs'
SELECT  "authentication_tokens".* FROM "authentication_tokens" WHERE "authentication_tokens"."user_id" = $1 AND "authentication_tokens"."on_behalf" = $2 ORDER BY "authentication_tokens"."id" DESC LIMIT $3; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸‹é¢æ˜¯`last_login_at` :
çš„ä»£ç 

```
 def last_login_at
    token = authentication_tokens.where(on_behalf: false).last
    token&.last_used_at
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªé—®é¢˜æ›´éš¾è§£å†³ã€‚æˆ‘ä»¬ä¸èƒ½ç®€å•åœ°æ€¥åˆ‡åŠ è½½`authentication_tokens`,å› ä¸ºè¿™ä¸ªæ–¹æ³•åœ¨æ¯æ¬¡è¢«è°ƒç”¨æ—¶éƒ½ä¼šå‘å‡ºä¸€ä¸ªæŸ¥è¯¢ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬èƒ½åšçš„æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸå…³è”å¹¶åŠ è½½å®ƒã€‚

```
 # app/models/user.rb
  has_one :last_login_authentication_token,
    -> { where(on_behalf: false) },
    class_name: 'AuthenticationToken'

  def last_login_at
    last_login_authentication_token&.last_used_at
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
 # app/controllers/users_controller.rb
  def index
    eager_load_associations = [
      :roles, :groups, :employee, :group_assignments,
      :assignments, :last_login_authentication_token
    ]

    users = User.includes(eager_load_associations).where(roles: { title: params[:roles] })

    respond_with users, each_serializer: Users::Index::UserSerializer, include: [:roles, :groups]
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™åº”è¯¥å¯ä»¥è§£å†³æˆ‘ä»¬æœ€åçš„ N+1 é—®é¢˜ã€‚æˆ‘ä»¬æ¥ç¡®è®¤ä¸€ä¸‹:

```
Total allocated: 69663419 bytes (872929 objects)
Total retained:  302956 bytes (1818 objects)

Total Duration: 1250ms
SQL Duration: 26ms
SQL Queries: 12 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä» SQL çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒçœ‹èµ·æ¥ä¸é”™ï¼å…¶ä½™çš„æ—¶é—´ç”¨äºå®ä¾‹åŒ–å’Œåºåˆ—åŒ–å¯¹è±¡ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨è¿™æ–¹é¢æˆ‘ä»¬èƒ½åšäº›ä»€ä¹ˆæ¥æ”¹è¿›ã€‚

# [](#further-optimizations)è¿›ä¸€æ­¥ä¼˜åŒ–

### [](#fastjsonapi)å›ºå®š _jsonapi

[`fast_jsonapi`](https://github.com/Netflix/fast_jsonapi) æ˜¯ç”±ç½‘é£çš„å·¥ç¨‹å›¢é˜Ÿå¼€å‘çš„å®çŸ³ï¼Œå®ƒæ‰¿è¯ºæ¯”`ActiveModel::Serializers`å¿« 25 å€çš„åºåˆ—åŒ–é€Ÿåº¦ã€‚

> æˆ‘ä»¬å¸Œæœ›ç¡®ä¿è¯¥åº“ä¸­çš„æ¯ä¸€é¡¹æ›´æ”¹ï¼Œåœ¨å½“å‰ 1000 æ¡è®°å½•çš„åŸºå‡†æµ‹è¯•ä¸­ï¼Œåºåˆ—åŒ–æ—¶é—´è‡³å°‘æ¯”ä¸»åŠ¨æ¨¡å‹åºåˆ—åŒ–ç¨‹åºå¿« 25 å€ã€‚

é‚£å¬èµ·æ¥å¥½å¾—ä¸åƒçœŸçš„ï¼Œä½†æ˜¯è¯•ä¸€è¯•ä¹Ÿæ— å¦¨ï¼

```
 # app/controllers/users_controller.rb
  def index
    eager_load_associations = [
      :roles, :groups, :employee, :group_assignments,
      :assignments, :last_login_authentication_token
    ]

    users = User.includes(eager_load_associations).where(roles: { title: params[:roles] })

    respond_with users, 
      each_serializer: Fast::Users::Index::UserSerializer,
      include: [:roles, :groups]
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
# app/serializers/fast/users/index/user_serializer.rb
class Fast::Users::Index::UserSerializer
  include FastJsonapi::ObjectSerializer

  attributes :id,
             :email,
             :first_name,
             :last_name,
             :employee_id,
             :last_login_at

  has_many :roles, through: :assignments, serializer: Fast::Users::Index::RoleSerializer
  has_many :groups, through: :group_assignments, serializer: Fast::Users::Index::GroupSerializer

  attribute :employee_id do |object|
    object.employee&.id
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
# app/serializers/fast/users/index/role_serializer.rb
class Fast::Users::Index::RoleSerializer
  include FastJsonapi::ObjectSerializer

  attributes :id, :title, :description
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
# app/serializers/fast/users/index/group_serializer.rb
class Fast::Users::Index::GroupSerializer
  include FastJsonapi::ObjectSerializer

  attributes :title, :description, :archived
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ•°å­—:

```
Total allocated: 54130985 bytes (698850 objects)
Total retained:  189166 bytes (935 objects)

Total Duration: 707ms
SQL Duration: 21ms
SQL Queries: 6 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è™½ç„¶ä¸æ˜¯ 25 å€ï¼Œä½†è¿™ä»ç„¶æ˜¯ä¸€ä¸ªç›¸å½“å¯è§‚çš„è¿›æ­¥ã€‚æˆ‘ä»¬è¦é¡ºå…¶è‡ªç„¶ã€‚

### [](#caching)ç¼“å­˜

`fast_jsonapi`è¿˜å†…ç½®äº†å¯¹è±¡ç¼“å­˜ï¼Œå®ƒä½¿ç”¨ Rails çš„`cache_key`æ¥å®ç°ç¼“å­˜å¤±æ•ˆã€‚æˆ‘è®¤ä¸ºå®ƒå¾ˆé€‚åˆæˆ‘ä»¬çš„ç”¨ä¾‹ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è¯•è¯•å§ã€‚

æˆ‘ä»¬ä½¿ç”¨ Redis ä½œä¸ºç¼“å­˜å­˜å‚¨ï¼Œå®ƒæ˜¯åœ¨`config/environments/production.rb` :
ä¸­è®¾ç½®çš„

```
 if ENV['REDIS_URL']
    config.cache_store = :redis_store, ENV['REDIS_URL'], { expires_in: 12.hours }
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯å°†è¿™ä¸ª`cache_options`è¡Œæ·»åŠ åˆ°æˆ‘ä»¬çš„åºåˆ—åŒ–ç¨‹åºä¸­ï¼Œä»¥ç¼“å­˜æ¯ä¸ª`User`å¯¹è±¡:

```
# app/serializers/fast/users/index/user_serializer.rb
class Fast::Users::Index::UserSerializer
  include FastJsonapi::ObjectSerializer

  cache_options enabled: true, cache_length: 12.hours

  attributes :id,
             :email,
             :first_name,
             :last_name,
             :employee_id,
             :last_login_at

  has_many :roles, through: :assignments, serializer: Fast::Users::Index::RoleSerializer
  has_many :groups, through: :group_assignments, serializer: Fast::Users::Index::GroupSerializer

  attribute :employee_id do |object|
    object.employee&.id
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥ç®—ä¸€ä¸‹æ•°å­—ã€‚

```
Total allocated: 10239567 bytes (92500 objects)
Total retained:  413751 bytes (2609 objects)

Total Duration: 165ms
SQL Duration: 17ms
SQL Queries: 6 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ğŸ¥³ğŸ‰