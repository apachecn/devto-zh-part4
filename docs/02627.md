# ä½¿ç”¨ SSO ç™»å½•åˆ›å»º Flask åº”ç”¨ç¨‹åº

> åŸæ–‡:[https://dev . to/simple log in/create-a-flask-application-with-SSO-log in-f9m](https://dev.to/simplelogin/create-a-flask-application-with-sso-login-f9m)

åº”ç”¨ç¨‹åºä¸­é€šå¸¸éœ€è¦æŸç§ç™»å½•åŠŸèƒ½ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥ä¿å­˜æ•°æ®æˆ–åˆ›å»ºè‡ªå·±çš„ä¸ªäººèµ„æ–™ã€‚æˆ–è€…å¯èƒ½åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æ‰èƒ½è®¿é—®ä¿ç•™çš„å†…å®¹ã€‚åœ¨ç°ä»£åº”ç”¨ä¸­ï¼Œç”¨æˆ·å¸Œæœ›æ‹¥æœ‰æ ‡å‡†çš„ç™»å½•ç›¸å…³åŠŸèƒ½ï¼Œå¦‚ç”µå­é‚®ä»¶éªŒè¯ã€å¯†ç é‡ç½®ã€å¤šå› ç´ èº«ä»½éªŒè¯ç­‰ã€‚è¿™äº›åŠŸèƒ½è™½ç„¶å¿…è¦ï¼Œä½†ä¸å®¹æ˜“åšå¥½ï¼Œé€šå¸¸ä¹Ÿä¸æ˜¯åº”ç”¨çš„ä¸»è¦ä¸šåŠ¡ã€‚

åœ¨ç”¨æˆ·æ–¹é¢ï¼Œä»–ä»¬ä¹Ÿä¸æƒ³ç»å†å†—é•¿çš„æ³¨å†Œè¿‡ç¨‹ï¼Œå› ä¸ºä»–ä»¬éœ€è¦åˆ›å»ºå¹¶è®°ä½å¦ä¸€ä¸ªç”µå­é‚®ä»¶/å¯†ç ã€‚å¦‚æœæ²¡æœ‰é€‚å½“çš„å¯†ç ç®¡ç†å™¨ï¼Œç”¨æˆ·å¾€å¾€ä¼šé‡å¤ä½¿ç”¨åŒä¸€ä¸ªå¯†ç ï¼Œè¿™åœ¨å®‰å…¨æ€§æ–¹é¢æ˜¯éå¸¸ç³Ÿç³•çš„ã€‚

SSO(å•ç‚¹ç™»å½•)ï¼Œé€šå¸¸ä¸ºå…¬ä¼—æ‰€çŸ¥çš„æ˜¯ä½¿ç”¨è„¸ä¹¦/è°·æ­Œ/æ¨ç‰¹æŒ‰é’®çš„éšå¤„**ç™»å½•ï¼Œè¢«å‘æ˜å‡ºæ¥ä½œä¸ºè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œä»–ä»¬ä¸å¿…ç»å†ç—›è‹¦çš„æ³¨å†Œè¿‡ç¨‹:åªéœ€ä¸€æ¬¡ç‚¹å‡»ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œä¸ºç”¨æˆ·æ¶ˆé™¤æ‘©æ“¦æ€»æ˜¯ä¸€ä¸ªå·¨å¤§çš„èƒœåˆ©ï¼Œæ­¤å¤–ï¼Œæ‰€æœ‰ä¸ç™»å½•ç›¸å…³çš„åŠŸèƒ½ç°åœ¨éƒ½è¢«*å§”æ‰˜ç»™**èº«ä»½æä¾›å•†**(å³è„¸ä¹¦/è°·æ­Œ/æ¨ç‰¹)ã€‚æ‚¨çš„åº”ç”¨ç¨‹åºåªéœ€*ä¿¡ä»»*èº«ä»½æä¾›è€…æ¥å®ŒæˆéªŒè¯ç”¨æˆ·èº«ä»½çš„å·¥ä½œã€‚***

SSO é€šå¸¸ç”± OIDC (OpenId Connect)æˆ– SAML åè®®æä¾›æ”¯æŒã€‚SAML ä¸»è¦ç”¨äºä¼ä¸šåº”ç”¨ç¨‹åºã€‚OIDC å»ºç«‹åœ¨ OAuth2 ä¹‹ä¸Šï¼Œç”±è„¸ä¹¦ã€è°·æ­Œç­‰ç¤¾äº¤èº«ä»½æä¾›å•†ä½¿ç”¨ã€‚åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨ OIDC/OAuth2 åè®®ã€‚

è¿™ç¯‡æ–‡ç« æä¾›äº†ä¸€ä¸ªåˆ†æ­¥æŒ‡å—ï¼Œä½¿ç”¨ç®€å•ç™»å½•å’Œè„¸ä¹¦ä½œä¸ºèº«ä»½æä¾›è€…ï¼Œå°† SSO ç™»å½•æŒ‰é’®æ·»åŠ åˆ° Flask åº”ç”¨ç¨‹åºä¸­ã€‚è¿™å¯ä»¥åœ¨ä¸ä½¿ç”¨ä»»ä½•å¤–éƒ¨åº“çš„æƒ…å†µä¸‹å®Œæˆï¼Œä½†æ˜¯ä¸ºäº†ä¸å¤ªæ‹…å¿ƒ OAuth ç»†èŠ‚ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [Requests-OAuthlib](https://github.com/requests/requests-oauthlib) ï¼Œä¸€ä¸ªé›†æˆ OAuth æä¾›è€…çš„åº“ã€‚å¦‚æœä½ æœ‰å…´è¶£ä»å¤´å¼€å§‹å®ç°å•ç‚¹ç™»å½•ï¼Œè¯·æŸ¥çœ‹[ä»¥åŸå§‹æ–¹å¼å®ç°å•ç‚¹ç™»å½•](https://docs.simplelogin.io/docs/code-flow/)ã€‚

åœ¨æœ¬æ–‡ç»“æŸæ—¶ï¼Œæ‚¨åº”è¯¥æœ‰ä¸€ä¸ªåŒ…å«ä»¥ä¸‹é¡µé¢çš„ Flask åº”ç”¨ç¨‹åº:

*   ä¸»é¡µ:åªæœ‰**ç™»å½•**æŒ‰é’®
*   ç”¨æˆ·ä¿¡æ¯é¡µé¢:æˆåŠŸç™»å½•åï¼Œç”¨æˆ·å°†èƒ½å¤Ÿçœ‹åˆ°å§“åï¼Œç”µå­é‚®ä»¶ï¼Œå¤´åƒç­‰ä¿¡æ¯ã€‚

æœ¬æ•™ç¨‹çš„æ‰€æœ‰æ­¥éª¤éƒ½å¯ä»¥åœ¨[flask-social-log in-example repository](https://github.com/nguyenkims/flask-social-login-example)ä¸Šæ‰¾åˆ°ã€‚

åœ¨[https://nguyenkims-flask-social-log in-example . Glitch . me](https://nguyenkims-flask-social-login-example.glitch.me)ä¸Šä¹Ÿæœ‰æ¼”ç¤ºï¼Œå¯ä»¥éšæ„**é‡æ–°æ··åˆ [Glitch](https://glitch.com/~nguyenkims-flask-social-login-example) ä¸Šçš„ä»£ç ğŸ˜‰ã€‚**

## [](#step-1-bootstrap-flask-app)ç¬¬ä¸€æ­¥:è‡ªä¸¾çƒ§ç“¶ app

å®‰è£…`flask`å’Œ`Requests-OAuthlib`ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨`virtualenv`æˆ–è€…`pipenv`æ¥éš”ç¦»ç¯å¢ƒã€‚

> pip å®‰è£…çƒ§ç“¶è¯·æ±‚ _oauthlib

åˆ›å»º`app.py`å’Œåœ¨ä¸»é¡µæ˜¾ç¤ºç™»å½•æŒ‰é’®çš„è·¯çº¿:

```
import flask

app = flask.Flask(__name__)

@app.route("/")
def index():
    return """
    <a href="/login">Login</a>
    """

if __name__ == '__main__':
    app.run(debug=True) 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬è¿è¡Œè¿™ä¸ªåº”ç”¨ç¨‹åºï¼ŒéªŒè¯ä¸€åˆ‡æ­£å¸¸:

> python app.py

æ‰“å¼€ [http://localhost:5000](http://localhost:5000) åº”è¯¥ä¼šçœ‹åˆ°è¿™ä¸ªé¡µé¢ã€‚å®Œæ•´ä»£ç åœ¨ [step1.py](https://github.com/nguyenkims/flask-social-login-example/blob/master/step1.py) ä¸Š

[![Alt Text](img/3fcf96afbf0414c89b9f55fc0ad5716a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--WSc7hRZn--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/o6ydih137sm0cmzz6joc.png)

## [](#step-2-identity-provider-credential)ç¬¬äºŒæ­¥:èº«ä»½æä¾›å•†å‡­è¯

ç›®å‰æœ‰æ•°ç™¾å®¶(å¦‚æœä¸æ˜¯æ•°åƒå®¶)èº«ä»½æä¾›å•†ï¼Œæœ€å—æ¬¢è¿çš„æ˜¯è„¸ä¹¦ã€è°·æ­Œã€Githubã€Instagram ç­‰ã€‚å¯¹äºè¿™ç¯‡æ–‡ç« ï¼Œ [SimpleLogin](https://simplelogin.io) è¢«é€‰ä¸­æ˜¯å› ä¸ºå®ƒçš„**å¼€å‘è€…å‹å¥½æ€§**ã€‚ç›¸åŒçš„ä»£ç å°†ä¸ä»»ä½• OAuth2 èº«ä»½æä¾›å•†(è„¸ä¹¦ï¼Œè°·æ­Œç­‰)è™½ç„¶å·¥ä½œã€‚å£°æ˜:æˆ‘ç¢°å·§æ˜¯ SimpleLogin çš„è”åˆåˆ›å§‹äººï¼Œæ‰€ä»¥è¿™ä¸ªé€‰æ‹©æ˜¾ç„¶æ˜¯ä¸»è§‚çš„ã€‚

ç”±äºè¦ç»å†è„¸ä¹¦ã€è°·æ­Œã€Twitter çš„è®¾ç½®ï¼Œç™»å½•æœ‰ç‚¹å¤æ‚(æ¯ä¸ªä½¿ç”¨è°·æ­Œäº‘æ§åˆ¶å°çš„äººéƒ½èƒ½æ„Ÿå—åˆ°è¿™ç§ç—›è‹¦ğŸ˜…)å¹¶éœ€è¦é¢å¤–çš„æ­¥éª¤ï¼Œå¦‚è®¾ç½® SSLã€é€‰æ‹©æ­£ç¡®çš„èŒƒå›´ç­‰ï¼Œè¿™äº›è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ã€‚ä¸è„¸ä¹¦çš„**ç™»å½•ä¸€èŠ‚æ˜¯ä½œä¸ºæ–‡ç« ç»“å°¾çš„é™„å½•æä¾›çš„ã€‚**

è¯·å‰å¾€[ç®€å•ç™»å½•](https://app.simplelogin.io)å¹¶åˆ›å»ºä¸€ä¸ªå¸æˆ·(å¦‚æœæ‚¨è¿˜æ²¡æœ‰)ï¼Œç„¶ååœ¨**å¼€å‘è€…**é€‰é¡¹å¡ä¸­åˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨ã€‚

åœ¨åº”ç”¨ç¨‹åºè¯¦ç»†ä¿¡æ¯é¡µé¢ï¼Œè¯·å¤åˆ¶æ‚¨çš„ AppID å’Œ AppSecretï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å˜é‡ç¯å¢ƒä¸­ã€‚åœ¨ OAuth æœ¯è¯­ä¸­ï¼Œ **client** å®é™…ä¸Šæ˜¯æŒ‡ç¬¬ä¸‰æ–¹ appï¼Œä¹Ÿå°±æ˜¯ä½ çš„ appã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™äº›å€¼ç›´æ¥æ”¾åœ¨ä»£ç ä¸­ï¼Œä½†æ˜¯å°†å‡­è¯ä¿å­˜åˆ°**å˜é‡ç¯å¢ƒ**ä¸­æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åšæ³•ã€‚è¿™ä¹Ÿæ˜¯[ä¸­çš„ç¬¬ä¸‰ä¸ªå› ç´ ](https://12factor.net)åäºŒä¸ªå› ç´ ã€‚

[![Alt Text](img/489eff18f6c490ee1c3a69b15849c874.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--2APvGsmG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/zeymjg5a5areaoh39dtw.png)T3ã€‘

```
export CLIENT_ID={your AppID}
export CLIENT_SECRET={your AppSecret} 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`app.py`ä¸­ï¼Œè¯·å°†è¿™äº›è¡Œæ·»åŠ åˆ°æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œä»¥è·å¾—`client id`å’Œ`client secret`T3ã€‘

```
import os
CLIENT_ID = os.environ.get("CLIENT_ID")
CLIENT_SECRET = os.environ.get("CLIENT_SECRET") 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¹Ÿè¯·å°†è¿™äº› OAuth URLs æ·»åŠ åˆ°`app.py`çš„é¡¶éƒ¨ï¼Œå®ƒä»¬å°†åœ¨ä¸‹ä¸€æ­¥ä¸­ä½¿ç”¨ã€‚å®ƒä»¬ä¹Ÿå¯ä»¥åœ¨ **OAuth ç«¯ç‚¹**é¡µé¢ä¸Šå¤åˆ¶ã€‚

```
AUTHORIZATION_BASE_URL = "https://app.simplelogin.io/oauth2/authorize"
TOKEN_URL = "https://app.simplelogin.io/oauth2/token"
USERINFO_URL = "https://app.simplelogin.io/oauth2/userinfo" 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”±äºæˆ‘ä»¬ç°åœ¨ä¸æƒ³æ‹…å¿ƒè®¾ç½® SSLï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å‘Šè¯‰`Requests-OAuthlib`ä½¿ç”¨æ™®é€š HTTP:
æ˜¯å¯ä»¥çš„

```
# This allows us to use a plain HTTP callback os.environ["OAUTHLIB_INSECURE_TRANSPORT"] = "1" 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åƒå¾€å¸¸ä¸€æ ·ï¼Œè¿™ä¸€æ­¥çš„ä»£ç åœ¨ [step2.py](https://github.com/nguyenkims/flask-social-login-example/blob/master/step2.py) ä¸Š

## [](#step-3-login-redirection)ç¬¬ä¸‰æ­¥:ç™»å½•é‡å®šå‘

å½“ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®æ—¶:

1.  ç”¨æˆ·å°†è¢«é‡å®šå‘è‡³**èº«ä»½ç™»å½•æä¾›å•†**æˆæƒé¡µé¢ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦å¸Œæœ›ä¸æ‚¨çš„åº”ç”¨å…±äº«å…¶ä¿¡æ¯ã€‚

2.  åœ¨ç”¨æˆ·æ‰¹å‡†åï¼Œä»–ä»¬å°†è¢«é‡å®šå‘å›ä½ çš„åº”ç”¨ç¨‹åºçš„é¡µé¢ï¼ŒåŒæ—¶åœ¨ URL ä¸­æœ‰ä¸€ä¸ª`code`ï¼Œä½ çš„åº”ç”¨ç¨‹åºå°†ä½¿ç”¨å®ƒæ¥äº¤æ¢ä¸€ä¸ª`access token`ï¼Œä»¥ä¾¿ä½ ç¨åä»æœåŠ¡æä¾›å•†é‚£é‡Œè·å¾—ç”¨æˆ·ä¿¡æ¯ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤æ¡è·¯ç”±:ä¸€æ¡æ˜¯å°†ç”¨æˆ·é‡å®šå‘åˆ°èº«ä»½æä¾›è€…çš„`login`è·¯ç”±ï¼Œå¦ä¸€æ¡æ˜¯æ¥æ”¶`code`å¹¶äº¤æ¢`access token`çš„`callback`è·¯ç”±ã€‚å›è°ƒè·¯ç”±è¿˜è´Ÿè´£æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ã€‚

```
@app.route("/login")
def login():
    simplelogin = requests_oauthlib.OAuth2Session(
        CLIENT_ID, redirect_uri="http://localhost:5000/callback"
    )
    authorization_url, _ = simplelogin.authorization_url(AUTHORIZATION_BASE_URL)

    return flask.redirect(authorization_url)

@app.route("/callback")
def callback():
    simplelogin = requests_oauthlib.OAuth2Session(CLIENT_ID)
    simplelogin.fetch_token(
        TOKEN_URL, client_secret=CLIENT_SECRET, authorization_response=flask.request.url
    )

    user_info = simplelogin.get(USERINFO_URL).json()
    return f"""
    User information: <br>
    Name: {user_info["name"]} <br>
    Email: {user_info["email"]} <br>
    Avatar <img src="{user_info.get('avatar_url')}"> <br>
    <a href="/">Home</a>
    """ 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç‚¹å‡»**ç™»å½•**æŒ‰é’®å°†å¼•å¯¼æ‚¨å®Œæˆä»¥ä¸‹æµç¨‹ã€‚å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨ [Github - step3.py](https://github.com/nguyenkims/flask-social-login-example/blob/master/step3.py) ä¸Šæ‰¾åˆ°

[![Alt Text](img/069f9704df2be762892cb28b182c6032.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--bEwtCm7f--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/f23w5cnhuhqbjej12nak.png)

## [](#conclusion)ç»“è®º

æ­å–œğŸ‰æ‚¨å·²æˆåŠŸå°† **SSO ç™»å½•**é›†æˆåˆ° Flask app ä¸­ï¼

ä¸ºäº†ç®€å•èµ·è§ï¼Œæœ¬æ•™ç¨‹æ²¡æœ‰æåŠå…¶ä»– OAuth æ¦‚å¿µï¼Œå¦‚[èŒƒå›´](https://oauth.net/2/scope/)å’Œ[çŠ¶æ€](https://spring.io/blog/2011/11/30/cross-site-request-forgery-and-oauth2)ï¼Œè¿™å¯¹äºé˜²å¾¡* *è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ** æ”»å‡»å¾ˆé‡è¦ã€‚æ‚¨å¯èƒ½è¿˜éœ€è¦å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­ï¼Œè¿™åœ¨æœ¬æ–‡ä¸­æ²¡æœ‰æ¶‰åŠã€‚

è¯¥åº”ç”¨ç¨‹åºè¿˜éœ€è¦åœ¨ https ä¸Šæä¾›æœåŠ¡ï¼Œè¿™åœ¨ä»Šå¤©å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡[è®©æˆ‘ä»¬åŠ å¯†](https://letsencrypt.org)æ¥å®Œæˆã€‚

ç¥ä½ å†™ä½œæ„‰å¿«ï¼

* * *

## [](#appendix-login-with-facebook)é™„å½•:ç™»å½•è„¸ä¹¦

å¦‚å‰æ‰€è¿°ï¼Œè¯·åœ¨ä¸‹é¢æ‰¾åˆ°å°†**ç™»å½•ä¸è„¸ä¹¦**æŒ‰é’®æ•´åˆçš„æ­¥éª¤ğŸ™‚ã€‚é™¤äº†ç›¸å½“å¤æ‚çš„ç”¨æˆ·ç•Œé¢ï¼Œé›†æˆè„¸ä¹¦æœ€å›°éš¾çš„éƒ¨åˆ†å¯èƒ½æ˜¯æ‰¾åˆ°ä¸€ç§æ–¹æ³•åœ¨æœ¬åœ° https ä¸ŠæœåŠ¡ä½ çš„ web åº”ç”¨ï¼Œå› ä¸ºè„¸ä¹¦ SDK çš„æ–°ç‰ˆæœ¬ä¸å…è®¸æœ¬åœ°æ™®é€š HTTPã€‚æˆ‘æ¨èä½¿ç”¨ [Ngrok](https://ngrok.com) ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥å¿«é€Ÿè·å¾— https URL çš„å…è´¹å·¥å…·ã€‚

### [](#step-1-create-a-facebook-app)ç¬¬ä¸€æ­¥:åˆ›å»ºè„¸ä¹¦ app:

è¯·å‰å¾€[https://developers.facebook.com](https://developers.facebook.com)åˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨

[![Alt Text](img/d3608661454d541f6a86aa677f57e66d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--D26o89Y2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/pi7i5raswmt9nwqpn01s.png)

ç„¶ååœ¨ä¸‹ä¸€ä¸ªå±å¹•ä¸Šé€‰æ‹©â€œé›†æˆè„¸ä¹¦ç™»å½•â€

[![Alt Text](img/77f767b9a951d3cd6c4630f6f668e4f1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--3M9DJ1cm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/n4vvf2y1vq6mi2adboit.png)

### [](#step-2-facebook-oauth-credential)ç¬¬äºŒæ­¥:è„¸ä¹¦ OAuth å‡­è¯

ç‚¹å‡»å·¦ä¾§çš„â€œè®¾ç½®/åŸºæœ¬â€ï¼Œå¤åˆ¶*åº”ç”¨ ID* å’Œ*åº”ç”¨ç§˜å¯†*ï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯ OAuth å®¢æˆ·ç«¯ ID å’Œå®¢æˆ·ç«¯ç§˜å¯†ã€‚

[![Alt Text](img/1ed2f16ea29020b7854cb9aa377a63ac.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--WQmzcZ3c--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/8u6jlnoakwpc2ut28ll1.png)

æ›´æ–°å®¢æˆ·ç«¯ id å’Œå®¢æˆ·ç«¯å¯†ç 

```
export FB_CLIENT_ID={your facebook AppId}
export FB_CLIENT_SECRET={your facebook AppSecret} 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ›´æ–°æˆæƒ _ åŸºç¡€ _URL å’Œä»¤ç‰Œ _URL:

```
FB_AUTHORIZATION_BASE_URL = "https://www.facebook.com/dialog/oauth"
FB_TOKEN_URL = "https://graph.facebook.com/oauth/access_token" 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–é¡µ

```
@app.route("/")
def index():
    return """
    <a href="/fb-login">Login with Facebook</a>
    """ 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#step-3-login-and-callback-endpoints)ç¬¬ä¸‰æ­¥:ç™»å½•å’Œå›å«ç«¯ç‚¹

å¦‚æœä½¿ç”¨`ngrok http 5000`å‘½ä»¤åœ¨`ngrok`ä¹‹åæä¾›åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦å°†å½“å‰ url è®¾ç½®ä¸º ngrok url

```
# Your ngrok url, obtained after running "ngrok http 5000" URL = "https://abcdefgh.ngrok.io" 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·ç¡®ä¿å°† URL[https://abcdefgh.ngrok.io/fb-callback](https://abcdefgh.ngrok.io/fb-callback)æ·»åŠ åˆ°æ‚¨çš„è„¸ä¹¦ç™»å½•/è®¾ç½®ä¸­ï¼Œæœ‰æ•ˆçš„ OAuth é‡å®šå‘ URIs è®¾ç½®:

[![Alt Text](img/66601bf38a23a21e831551fcc9fb2eca.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--EBpo2ptd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/vzs5e4lywrq0vasirw0x.png)

ä¸ºäº†è®¿é—®ç”¨æˆ·é‚®ç®±ï¼Œæ‚¨éœ€è¦å°†`email`æ·»åŠ åˆ°`scope`

```
FB_SCOPE = ["email"]

@app.route("/fb-login")
def login():
    facebook = requests_oauthlib.OAuth2Session(
        FB_CLIENT_ID, redirect_uri=URL + "/fb-callback", scope=FB_SCOPE
    )
    authorization_url, _ = facebook.authorization_url(FB_AUTHORIZATION_BASE_URL)

    return flask.redirect(authorization_url) 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`callback`è·¯çº¿ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºè„¸ä¹¦éœ€è¦ä¸€ä¸ªåˆè§„ä¿®æ­£:

```
from requests_oauthlib.compliance_fixes import facebook_compliance_fix

@app.route("/fb-callback")
def callback():
    facebook = requests_oauthlib.OAuth2Session(
        FB_CLIENT_ID, scope=FB_SCOPE, redirect_uri=URL + "/fb-callback"
    )

    # we need to apply a fix for Facebook here
    facebook = facebook_compliance_fix(facebook)

    facebook.fetch_token(
        FB_TOKEN_URL,
        client_secret=FB_CLIENT_SECRET,
        authorization_response=flask.request.url,
    )

    # Fetch a protected resource, i.e. user profile, via Graph API 
    facebook_user_data = facebook.get(
        "https://graph.facebook.com/me?fields=id,name,email,picture{url}"
    ).json()

    email = facebook_user_data["email"]
    name = facebook_user_data["name"]
    picture_url = facebook_user_data.get("picture", {}).get("data", {}).get("url")

    return f"""
    User information: <br>
    Name: {name} <br>
    Email: {email} <br>
    Avatar <img src="{picture_url}"> <br>
    <a href="/">Home</a>
    """ 
```

<svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg viewBox="0 0 448 512" class="highlight-action highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œå½“ç”¨è„¸ä¹¦ç‚¹å‡»**ç™»å½•æ—¶ï¼Œä½ åº”è¯¥èƒ½å¤Ÿæµè§ˆæ•´ä¸ªæµç¨‹ã€‚**

[![Alt Text](img/c166856855a978457813bde341a925b6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--44GneNu6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/do5acziteu8fwxb5oesc.png)

å®Œæ•´ä»£ç åœ¨ [facebook.py](https://github.com/nguyenkims/flask-social-login-example/blob/master/facebook.py)

æ•´åˆ`Login with Google/Twitter/...`æŒºåƒçš„ã€‚è¯·è®©æˆ‘çŸ¥é“åœ¨è¯„è®ºä¸­ï¼Œå¦‚æœä½ æƒ³æœ‰è¿™äº›ç¤¾ä¼šç™»å½•æä¾›å•†ç±»ä¼¼çš„éƒ¨åˆ†ï¼