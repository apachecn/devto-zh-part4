# å¸¦ PORO çš„ active _ model _ serializers(æ™®é€šçš„ Ruby å¯¹è±¡)

> åŸæ–‡:[https://dev . to/danimal 141/activemodelserializer-with-poro-plain-old-ruby-object-20ij](https://dev.to/danimal141/activemodelserializers-with-poro-plain-old-ruby-object-20ij)

æœ€è¿‘ï¼Œæˆ‘å‚ä¸äº†ä¸€ä¸ª Rails API é¡¹ç›®ã€‚

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘è·å–äº†å¤–éƒ¨æ•°æ®ï¼Œå¹¶ç”¨è¿™äº›æ•°æ®åˆ¶ä½œäº†ç¬¦åˆ[active _ model _ serializer](https://github.com/rails-api/active_model_serializers)çš„ POROsã€‚
ç„¶åæˆ‘ä»¬çš„ API è¿”å›äº†åºåˆ—åŒ–çš„ POROsã€‚

ä»Šå¤©æˆ‘ç¨å¾®ä»‹ç»ä¸€ä¸‹å¼€å‘æµç¨‹ã€‚

## [](#environment)ç¯å¢ƒ

*   rails 6 . 0 . 0 beta 3
*   æ´»åŠ¨æ¨¡å‹åºåˆ—åŒ–ç¨‹åº 0.10.9
*   å·¥å‚æœºå™¨äºº 5.0.2

## [](#directory-structure)ç›®å½•ç»“æ„

*   åº”ç”¨ç¨‹åº/å‹å·
    *   åŠ£ç­‰çŸ³ç°çŸ³
*   åº”ç”¨ç¨‹åº/åºåˆ—åŒ–ç¨‹åº
    *   åºåˆ—åŒ–ç¨‹åº
*   åº”ç”¨ç¨‹åº/æ§åˆ¶å™¨
    *   ç«¯ç‚¹

## [](#model)å‹å·

ä½œä¸ºä¸€ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬è€ƒè™‘æœ‰ä¸€ä¸ª URL å’Œå¤§å°ä¿¡æ¯çš„`Image`æ¨¡å‹ã€‚

`active_model_serializers`ä¸ºåƒ[è¿™ç§](https://github.com/rails-api/active_model_serializers/tree/0-10-stable#what-does-a-serializable-resource-look-like)çš„ POROs æä¾›`ActiveModelSerializers::Model`ï¼Œå¤ªå¥½ç”¨äº†ã€‚

å¦‚æœä½ éœ€è¦å¤„ç†ä¸€ä¸ªæ›´å¤æ‚çš„æƒ…å†µï¼Œä½ å°†èƒ½å¤Ÿå®ç°å¹¶ä½¿ç”¨ä¸€ä¸ªç¬¦åˆè¿™ä¸ªè§„èŒƒçš„æ¨¡å‹ã€‚

```
# app/models/image.rb
class Image < ActiveModelSerializers::Model
  attributes :url, :size
end

# app/models/image/size.rb
class Image::Size < ActiveModelSerializers::Model
  attributes :width, :height
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#serializer)ä¸²è¡Œå™¨

```
# app/serializers/image_serializer.rb
class ImageSerializer < ActiveModel::Serializer
  attributes :url, :type
  has_one :size
end

# app/serializers/image/size_serializer.rb
class Image::SizeSerializer < ActiveModel::Serializer
  attributes :width, :height
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®šä¹‰ç±»ä¼¼äº`has_one`çš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç«¯ç‚¹ä¸Šæ–¹ä¾¿åœ°ä½¿ç”¨[åŒ…å«é€‰é¡¹](https://github.com/rails-api/active_model_serializers/blob/0-10-stable/docs/general/adapters.md#include-option)ã€‚

ä¾‹å¦‚ï¼Œ`render json: image, include: '*'`è¿”å›åŒ…å«`size`çš„ JSONï¼Œ`render json: image, include: ''`è¿”å›ä¸åŒ…å«`size`çš„ JSONã€‚

## [](#controller)æ§åˆ¶å™¨

æˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å™¨ä¸­è½»æ¾ä½¿ç”¨åºåˆ—åŒ–å™¨ã€‚æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ¨¡å‹å®ä¾‹ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™`render`æ–¹æ³•ã€‚

ç„¶å`active_model_serializers`ä¸ºç»™å®šçš„å®ä¾‹æ‰¾åˆ°åˆé€‚çš„åºåˆ—åŒ–å™¨å¹¶åºåˆ—åŒ–ï¼Œå“åº”è¿”å›ã€‚

```
# app/controllers/v1/images_controller.rb
module V1
  class ImagesController < ApplicationController
    def show
      render json: image, include: params[:include]
    end

    private

    def image
      @image ||= Image.new(image_attrs)
    end

    def image_attrs
      @image_attrs ||= fetch_data_somehow # Fetch external data
    end
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#testing)æµ‹è¯•

å½“æµ‹è¯•`ActiveRecord`æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`factory_bot`å¹¶ä½¿å·¥å‚å–œæ¬¢:

```
FactoryBot.define do
  factory :user do
    name { Faker::Name.name }
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨æ³•:

```
> user = FactoryBot.create(:user) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`FactoryBot#create`ä¸èƒ½å¾ˆå¥½åœ°å·¥ä½œï¼Œå› ä¸ºæ²¡æœ‰å­˜å‚¨(æ­¤å¤–ï¼Œä¹Ÿä¸éœ€è¦å­˜å‚¨å®ƒä»¬)ã€‚

å¦å¤–ï¼Œ`ActiveModelSerializers::Model`æ˜¯åŸºäº`ActiveModel`çš„ï¼Œæ‰€ä»¥åˆå§‹åŒ–å™¨éœ€è¦ä¸€ä¸ªåä¸º`attributes`çš„æ•£åˆ—ã€‚

å¦‚æœæˆ‘ä»¬çœç•¥å‚æ•°`attributes`ï¼Œ`attributes = {}`å°†ä½œä¸ºç¼ºçœå€¼ç»™å‡ºï¼Œé‚£ä¹ˆåºåˆ—åŒ–å°±ä¸ä¼šåƒé¢„æœŸçš„é‚£æ ·å·¥ä½œã€‚

```
# spec/factories/images.rb
FactoryBot.define do
  factory :image do
    url { Faker::Internet.url }
    size { build(:image_size) }
  end
end

# spec/factories/image/sizes.rb
FactoryBot.define do
  factory :image_size, class: 'Image::Size' do
    width { rand(100..500) }
    height { rand(100..500) }
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨æ³•:

```
> image = FactoryBot.create(:image)
=> NoMethodError: undefined method `save!`...

> image = FactoryBot.build(:image)
> image.attributes
=> {}

> image.to_json
=> "{}" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`factory_bot`æä¾› [initialize_with](https://github.com/thoughtbot/factory_bot/blob/master/GETTING_STARTED.md#custom-construction) æ¥è¦†ç›–åˆå§‹åŒ–å™¨ã€‚

æ­¤å¤–ï¼Œå®ƒè¿˜æä¾›äº† [skip_create](https://github.com/thoughtbot/factory_bot/blob/master/GETTING_STARTED.md#custom-methods-to-persist-objects) æ¥è·³è¿‡åˆ›å»ºã€‚

```
# spec/factories/images.rb
FactoryBot.define do
  factory :image do
    skip_create
    initalize_with { new(attributes) }

    url { Faker::Internet.url }
    size { build(:image_size) }
  end
end

# spec/factories/image/sizes.rb
FactoryBot.define do
  factory :image_size, class: 'Image::Size' do
    skip_create
    initalize_with { new(attributes) }

    width { rand(100..500) }
    height { rand(100..500) }
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨æ³•:

```
> image = FactoryBot.create(:image)
=> #<Image:...> The result is the same as one from `build`ğŸ™Œ

> image = FactoryBot.build(:image)
> image.attributes
=> { "url" => ..., "size" => ... }

> image.to_json
=> "{\"url\":...,\"size\":...}" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†é¿å…å¤šæ¬¡ç¼–å†™`initialize_with`å’Œ`skip_create`ï¼Œæˆ‘æœ€ç»ˆå‡†å¤‡äº†ä¸€ä¸ªç‰¹å®šçš„ DSLï¼Œæ¯”å¦‚:

```
if defined?(FactoryBot)
  module FactoryBot
    module Syntax
      module Default
        class DSL
          # Custom DSL for ActiveModelSerializers::Model
          # Original: https://github.com/thoughtbot/factory_bot/blob/v5.0.2/lib/factory_bot/syntax/default.rb#L15-L26
          def serializers_model_factory(name, options = {}, &block)
            factory = Factory.new(name, options)
            proxy = FactoryBot::DefinitionProxy.new(factory.definition)
            if block_given?
              proxy.instance_eval do
                skip_create
                initialize_with { new(attributes) }
                instance_eval(&block)
              end
            end
            FactoryBot.register_factory(factory)

            proxy.child_factories.each do |(child_name, child_options, child_block)|
              parent_factory = child_options.delete(:parent) || name
              serializers_model_factory(child_name, child_options.merge(parent: parent_factory), &child_block)
            end
          end
        end
      end
    end
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å·¥å‚å®ç°ç»“æœå¦‚ä¸‹:

```
# spec/factories/images.rb
FactoryBot.define do
  serializers_model_factory :image do
    url { Faker::Internet.url }
    size { build(:image_size) }
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨è§„èŒƒä¸­ä½¿ç”¨å®ƒï¼Œæ¯”å¦‚:

```
# spec/serializers/image_serializer_spec.rb
require 'rails_helper'

RSpec.describe ImageSerializer, type: :serializer do
  let(:resource) { ActiveModelSerializers::SerializableResource.new(model, options) }
  let(:model) { build(:image) }
  let(:options) { { include: '*' } }

  describe '#url' do
    subject { resource.serializable_hash[:url] }

    it { is_expected.to eq model.url }
  end
  ...
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#summary)æ€»ç»“

æ²¡æœ‰`ActiveRecord`æˆ‘ä»¬ä¹Ÿå¯ä»¥è½»æ¾ä½¿ç”¨`active_model_serializers`ã€‚

## [](#references)å‚è€ƒæ–‡çŒ®

*   [https://github . com/rails-API/active _ model _ serializer/tree/0-10-stable # what-do-a-serializable-resource-look-like](https://github.com/rails-api/active_model_serializers/tree/0-10-stable#what-does-a-serializable-resource-look-like)
*   [https://github . com/rails-API/active _ model _ serializer/blob/0-10-stable/docs/general/adapters . MD # include-option](https://github.com/rails-api/active_model_serializers/blob/0-10-stable/docs/general/adapters.md#include-option)
*   [https://github . com/thought bot/factory _ bot/blob/master/GETTING _ started . MD](https://github.com/thoughtbot/factory_bot/blob/master/GETTING_STARTED.md)