# ä½¿ç”¨ Auth0 ä¿æŠ¤æ‚¨çš„ NestJS åº”ç”¨ç¨‹åº

> åŸæ–‡:[https://dev . to/Matthias/use-auth 0-to-secure-your-nestjs-application-MBO](https://dev.to/matthias/use-auth0-to-secure-your-nestjs-application-mbo)

**TLï¼›DR:** åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•ç”¨ [Auth0](https://auth0.com) ä¿æŠ¤ä½ çš„åŸºäº [NestJS](https://nestjs.com) çš„ APIã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜åŒ…æ‹¬ Auth0 ç®¡ç† API æ¥æ¥æ”¶å½“å‰ç™»å½•ç”¨æˆ·çš„é…ç½®æ–‡ä»¶ã€‚
å¦‚æœä½ ä¸æƒ³è¯»è¿™ç¯‡æ–‡ç« ï¼Œä½ å¯ä»¥ç›´æ¥å‰å¾€ [GitHub åº“](https://github.com/fullstack-to/nestjs-auth0-jwt)ã€‚

* * *

ä¸Šå‘¨ï¼Œæˆ‘åŠªåŠ›å°† Auth0 è¿æ¥åˆ°æˆ‘çš„ NestJS é¡¹ç›®ã€‚æˆ‘æƒ³é™åˆ¶æˆ‘çš„ API çš„æŸäº›ç«¯ç‚¹å¯¹å…¬ä¼—å¼€æ”¾ã€‚
ç”±äºä¸æƒ³åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šå­˜å‚¨ç”¨æˆ·æ•°æ®å’Œå¯†ç ï¼Œæ‰€ä»¥å†³å®šä½¿ç”¨ Auth0ã€‚

æˆ‘ä½¿ç”¨ NestJS ä½œä¸ºåç«¯åº”ç”¨ç¨‹åºçš„æ¡†æ¶å·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ã€‚NestJS è®©æ–°ç”¨æˆ·éå¸¸å®¹æ˜“ä¸Šæ‰‹ã€‚å®ƒæä¾›äº†ä¸€ä¸ªæˆç†Ÿçš„ CLIï¼Œè®¸å¤šæœ‰ç”¨çš„åŠŸèƒ½å·²ç»å¯ç”¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦é›†æˆåˆ°é¡¹ç›®ä¸­(ä¾‹å¦‚ï¼Œæ•°æ®åº“è¿æ¥ã€éªŒè¯ã€æ—¥å¿—æˆ– http è¯·æ±‚)ã€‚

æˆ‘ç»æœ›äº†ï¼Œæ‰¾ä¸åˆ°å¯è¡Œçš„è§£å†³åŠæ³•ã€‚æˆ‘åœ¨ Twitter å’Œ dev.to ä¸Šå¯»æ±‚å¸®åŠ©:

## æ–‡ç« ä¸å†å¯ç”¨

æ¶²ä½“é”™è¯¯:å†…éƒ¨

æˆ‘æ”¶åˆ°äº†ä¸€äº›ç›´æ¥çš„ä¿¡æ¯ï¼Œåœ¨é‚£é‡Œæˆ‘å¾—åˆ°äº†éå¸¸æœ‰ç”¨çš„å»ºè®®ã€‚ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘æ— æ³•åšåˆ°ï¼Œæ‰€ä»¥æˆ‘å†³å®šä¼‘æ¯å‡ å¤©ï¼Œä¸å†å»æƒ³å®ƒã€‚
è¿™è¢«è¯æ˜æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¸»æ„ï¼Œæœ€ç»ˆæˆ‘è§£å†³äº†ğŸ¥³.çš„é—®é¢˜

## [](#configure-auth0)é…ç½® Auth0

å¦‚æœä½ è¿˜æ²¡æœ‰ä¸€ä¸ª Auth0 å¸æˆ·ï¼Œä½ åº”è¯¥å»ä»–ä»¬çš„[æ³¨å†Œ](https://auth0.com/signup)é¡µé¢åˆ›å»ºä¸€ä¸ªã€‚
Auth0 æä¾›äº†ä¸€ä¸ªæ…·æ…¨çš„å…è´¹å±‚ï¼Œæä¾›æ— å¯†ç ç”¨æˆ·è´¦æˆ·ã€ä¸¤ä¸ªç¤¾äº¤èº«ä»½æä¾›å•†(å¦‚è°·æ­Œã€è„¸ä¹¦ã€Twitter æˆ– GitHub)ä»¥åŠä»–ä»¬çš„[ç¤¾åŒº](https://community.auth0.com/)çš„æ”¯æŒã€‚å¯¹äºæœ¬æ•™ç¨‹å’Œè¾ƒå°çš„è¾…åŠ©é¡¹ç›®ï¼Œè‡ªç”±è®¡åˆ’åº”è¯¥è¶³å¤Ÿäº†ã€‚

### [](#create-api)åˆ›å»º API

å½“æ‚¨ç™»å½•åˆ°æ‚¨çš„ä»ªè¡¨æ¿æ—¶ï¼Œå¯¼èˆªåˆ°*API*éƒ¨åˆ†ï¼Œç‚¹å‡»*åˆ›å»º API* æŒ‰é’®åˆ›å»ºä¸€ä¸ªæ–°çš„ APIã€‚

[![Create API](../Images/5425d19d491d474cb5754af471dbbb66.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--_jtreUK---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/j0ub4dnfcnyi7nhy3apk.png)

ç„¶åæç¤ºæ‚¨è¾“å…¥ API åç§°å’Œæ ‡è¯†ç¬¦ã€‚Auth0 å»ºè®®ä½¿ç”¨ url ä½œä¸º API çš„æ ‡è¯†ç¬¦å’Œå‹å¥½åç§°ã€‚
ç­¾åç®—æ³•åº”ä¿ç•™é»˜è®¤é€‰é¡¹(RS256)ã€‚

[![Create API](../Images/b495db2cbda94219f65e3454750ee9b8.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--HKKlEVl3--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/0ny6w1m005plfhzspvbg.png)

### [](#create-application)åˆ›å»ºåº”ç”¨ç¨‹åº

åˆ›å»ºæ–°åº”ç”¨ç¨‹åºæ—¶ï¼ŒAuth0 ä¼šè¯¢é—®ç±»å‹ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œç±»å‹å¹¶ä¸é‡è¦ã€‚å¯¹äºä¸€ä¸ªå…¬å¼€å¯ç”¨çš„åº”ç”¨ç¨‹åºï¼Œæ‚¨å¯èƒ½æƒ³è¦é˜…è¯»æ›´å¤šå…³äº[åº”ç”¨ç¨‹åºç±»å‹](https://auth0.com/docs/applications/concepts/app-types-auth0)çš„ä¿¡æ¯ï¼Œä»¥é€‰æ‹©ä¸€ä¸ªé€‚åˆæ‚¨çš„ç›®çš„çš„ç±»å‹ã€‚

[![Create Application](../Images/eacd209d17b707226eac0d369286a502.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--qt5fx-Of--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/fe542x2850n2v0hfw4rh.png)
[![Create Application](../Images/2e6acc726810e361177173668097f9ed.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--eCscMcki--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/shfxkru40u5nlvx20dty.png)
[![Create Application](../Images/84321437df455c591d481af53e3938da.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--C8o2TBx2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/j5ec6rc0024pwodtdghe.png)

åˆ›å»ºåº”ç”¨ç¨‹åºåï¼Œæ‚¨éœ€è¦é…ç½®ä¸€ä¸ªå…è®¸çš„å›è°ƒ URLã€‚å›è°ƒ URL æ˜¯ç”¨æˆ·åœ¨æˆåŠŸé€šè¿‡èº«ä»½éªŒè¯åå¯ä»¥è¢«é‡å®šå‘åˆ°çš„ä½ç½®ã€‚

[![Add Callback URL](../Images/8c327480729e3bc2cf07d39d3e476a04.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--2imRHbPS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/u25uf4bjvv7sdjvgg8ck.png)

### [](#enable-auth0-management-api)å¯ç”¨æˆæƒ 0 ç®¡ç† API

å› ä¸ºæˆ‘ä»¬ç¨åè¿˜æƒ³è¯»å–ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·çš„é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä¸ºåˆšåˆšåˆ›å»ºçš„åº”ç”¨ç¨‹åºæ¿€æ´» Auth0 ç®¡ç† APIã€‚
æ¿€æ´» Auth0 ç®¡ç† API çš„é…ç½®å¯ä»¥åœ¨*API*é€‰é¡¹å¡ä¸­æ‰¾åˆ°ã€‚
æ­¤å¤–ï¼Œ*æ˜¾ç¤º:å¿…é¡»é€‰æ‹©ç”¨æˆ·*èŒƒå›´ã€‚

[![Enable Auth0 Management API ](../Images/56405d5bc76761fde23bee1400f530aa.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--q1s_Wwgz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/85m0yysugi3k8eghna8f.png)

### [](#login)ç™»å½•

æˆ‘ä»¬å°†éœ€è¦ç”Ÿæˆä¸€ä¸ªè®¿é—®ä»¤ç‰Œï¼Œä»¥ä¾¿ç¨åä½¿ç”¨è¯¥ APIã€‚ä»¤ç‰Œæ˜¯é€šè¿‡ Auth0 ç™»å½•è¡¨å•ç”Ÿæˆçš„ã€‚
ç™»å½•è¡¨å•ç”± Auth0 æä¾›ï¼Œå¯åœ¨æ‚¨çš„ Auth0 ç§Ÿæˆ·åŸŸä¸Šè®¿é—®ã€‚
æ‚¨è¿˜éœ€è¦æ‚¨çš„ Auth0 å®¢æˆ·ç«¯ idã€‚è¿™ä¸¤ä¸ªå€¼éƒ½å¯ä»¥ä»åº”ç”¨ç¨‹åºé…ç½®é¡µé¢ä¸­å¤åˆ¶ã€‚

[![Get Variables](../Images/e2b05148085ac8dff3a9f18b02ab6252.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--DSqYDMh5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/dml6voyppxw5by3y5b3x.png)

æ›¿æ¢ URL ä¸­çš„å€¼ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å®ƒã€‚

`https://$AUTH0_DOMAIN/authorize?audience=http://localhost:3000&scope=SCOPE&response_type=code&client_id=$AUTH0_CLIENT_ID&redirect_uri=http://localhost:4200/login&state=STATE?prompt=none`

[![Login](../Images/9bde591b454872cda89e216d5036f700.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--AIw5r7Oq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/n9u595lkwfcfyrsk9oa0.png)

åœ¨æ‚¨ç™»å½• SSO æä¾›å•†(é»˜è®¤é…ç½® Google)æˆ–ä½¿ç”¨ç”µå­é‚®ä»¶å’Œå¯†ç åã€‚
ç™»å½•è¡¨å•ä¼šå°†ä½ é‡å®šå‘åˆ°[http://localhost:4200/log in](http://localhost:4200/login)ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¹‹å‰é…ç½®çš„ã€‚
æˆ‘ä»¬ä¸å…³å¿ƒæ˜¯å¦æœ‰ web åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œä½†æ˜¯æ‚¨éœ€è¦å¤åˆ¶`code`æŸ¥è¯¢å‚æ•°çš„å€¼å¹¶ä¿å­˜å®ƒä»¥å¤‡åç”¨ã€‚
éœ€è¦`code`æ¥ç”Ÿæˆä¸è®°åä»¤ç‰Œã€‚

[![Login](../Images/fc67d1da07ffff017075a3682c19263c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--sgSe1k7x--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/72t8wtk1f9ghtw6di5oa.png)

### [](#upate-user-metadata)æ›´æ–°ç”¨æˆ·å…ƒæ•°æ®

Auth0 çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œæ‚¨å¯ä»¥å°†å…ƒæ•°æ®é™„åŠ åˆ°ç”¨æˆ·é…ç½®æ–‡ä»¶ä¸­ã€‚ä½ å¯ä»¥ä½¿ç”¨ç”¨æˆ·å…ƒæ•°æ®å°†ç”¨æˆ·æ¡£æ¡ˆé“¾æ¥åˆ°å…¶ä»–æœåŠ¡(ä¾‹å¦‚ GitHub æˆ– dev . to profile)â€”â€”æˆ‘ç›¸ä¿¡ä½ ä¼šæ‰¾åˆ°è®¸å¤šå…¶ä»–çš„ç”¨ä¾‹ã€‚

[![User](../Images/083456bd74fc23b470177f7e247fe2c5.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--ZnVTTq7---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/l3dphqlgqgex9rp83mpj.png)
[![User](../Images/12b51e13c7a50698de8515145ccb9c8e.png)T6ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ZiTWotr9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/r80kcbob70v8c3lr58sn.png)

* * *

## [](#create-new-nestjs-application)åˆ›å»ºæ–°çš„ NestJS åº”ç”¨

```
$ npm i -g @nestjs/cli
$ nest new nestjs-auth0-jwt 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œä¸€ä¸ªæ–°çš„ NestJS åº”ç”¨ç¨‹åºå°±åˆ›å»ºå¥½äº†ï¼Œå…¶ç›®å½•ç»“æ„å¦‚ä¸‹:

```
nestjs-auth0-jwt
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ app.controller.spec.ts
â”‚Â Â  â”œâ”€â”€ app.controller.ts
â”‚Â Â  â”œâ”€â”€ app.module.ts
â”‚Â Â  â”œâ”€â”€ app.service.ts
â”‚Â Â  â””â”€â”€ main.ts
â”œâ”€â”€ test
â”‚Â Â  â”œâ”€â”€ app.e2e-spec.ts
â”‚Â Â  â””â”€â”€ jest-e2e.json
â”œâ”€â”€ README.md
â”œâ”€â”€ nest-cli.json
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.build.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ tslint.json 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#run-application)è¿è¡Œåº”ç”¨

å¯¼èˆªåˆ°æ–°ç›®å½•å¹¶å¯åŠ¨ API:

```
$ cd nestjs-auth0-jwt
$ npm run start:dev 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦åº”ç”¨ç¨‹åºå¼€å§‹è¿è¡Œï¼Œæ‚¨å°±å¯ä»¥æ‰“å¼€æµè§ˆå™¨ï¼Œè¿›å…¥ [http://localhost:3000](http://localhost:3000) ã€‚

[![Run Application](../Images/4e39064442f31b0905d245f0a5a792c0.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--axb2xOol--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/p0c9xtcpjbve39suhhmk.png)

### [](#add-dependencies)æ·»åŠ ä¾èµ–å…³ç³»

```
$ npm install --save @nestjs/passport passport passport-jwt jwks-rsa auth0
$ npm install --save-dev @types/passport-jwt @types/auth0 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#create-auth-module)åˆ›å»ºæˆæƒæ¨¡å—

```
$ nest generate module auth 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#create-jwt-strategy)æ‰“é€  JWT æˆ˜ç•¥

```
$ touch auth/jwt.strategy.ts 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
import { passportJwtSecret } from 'jwks-rsa';
import { ExtractJwt, Strategy, VerifiedCallback } from 'passport-jwt';

import { Injectable, UnauthorizedException } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      secretOrKeyProvider: passportJwtSecret({
        cache: true,
        rateLimit: true,
        jwksRequestsPerMinute: 5,
        jwksUri: `https://${process.env.AUTH0_DOMAIN}/.well-known/jwks.json`
      }),

      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(), // 1
      audience: 'http://localhost:3000',
      issuer: `https://${process.env.AUTH0_DOMAIN}/`
    });
  }

  validate(payload: any, done: VerifiedCallback) {
    if (!payload) {
      done(new UnauthorizedException(), false); // 2
    }

    return done(null, payload);
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

1: `ExtractJwt.fromAuthHeaderAsBearerToken()`:åˆ›å»ºä¸€ä¸ªæ–°çš„æå–å™¨ï¼Œè¯¥æå–å™¨ä½¿ç”¨â€œbearerâ€æ–¹æ¡ˆåœ¨æˆæƒå¤´ä¸­æŸ¥æ‰¾ JSON Web ä»¤ç‰Œã€‚

2:å¦‚æœæ²¡æœ‰æ¥æ”¶åˆ°æœ‰æ•ˆè½½è·ï¼Œåˆ™è®¤è¯å¤±è´¥ã€‚

### [](#update-authmodule)æ›´æ–°æˆæƒæ¨¡å—

```
import { Module } from '@nestjs/common';
import { PassportModule } from '@nestjs/passport';

import { JwtStrategy } from './jwt.strategy';

@Module({
  imports: [PassportModule],
  providers: [JwtStrategy],
  exports: [JwtStrategy]
})
export class AuthModule {} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#create-api-endpoints)åˆ›å»º API ç«¯ç‚¹

```
import { ManagementClient, User } from 'auth0';
import * as express from 'express';

import { Controller, Get, Request, UseGuards } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello(); // 1
  }

  @Get('secret')
  @UseGuards(AuthGuard('jwt')) // 2
  secretEndpoint(@Request() req: express.Request): string {
    return 'this endpoint should be protected';
  }

  @Get('profile')
  @UseGuards(AuthGuard('jwt')) // 2
  async profile(@Request() req: express.Request): Promise<any> {
    const authZero = new ManagementClient({
      // 3
      domain: process.env.AUTH0_DOMAIN,
      clientId: process.env.AUTH0_CLIENT_ID,
      clientSecret: process.env.AUTH0_CLIENT_SECRET,
      scope: 'read:users update:users'
    });

    const response = await authZero
      .getUser({ id: req.user.sub }) // 4
      .then((user: User) => {
        return user;
      })
      .catch(err => {
        return err;
      });

    return response;
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

1:å…¬å…±å¯ç”¨ API ç«¯ç‚¹ã€‚

2: `@UseGuards(AuthGuard('jwt'))`

3:åˆ›å»º Auth0 ç®¡ç† API å®¢æˆ·ç«¯ã€‚

4:JWT å“åº”ä¸­çš„ä¸»é¢˜ä¸ Auth0 ç”¨æˆ· ID ç›¸åŒã€‚å› æ­¤ï¼Œ`sub`å±æ€§è¢«ç”¨ä½œ`getUser`è°ƒç”¨çš„`id`å‚æ•°ï¼Œè¯¥è°ƒç”¨è¿”å›æ•´ä¸ªç”¨æˆ·é…ç½®æ–‡ä»¶ã€‚

### [](#use-login-code-to-retrieve-bearertoken)ä½¿ç”¨ç™»å½•ç æ£€ç´¢ä¸è®°åä»¤ç‰Œ

```
$ export AUTH0_DOMAIN=${AUTH0_DOMAIN}
$ export AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
$ export AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
$ export CODE=${CODE}

$ curl -X POST -H 'content-type: application/json' -d '{
  "grant_type": "authorization_code",
  "client_id": "'$AUTH0_CLIENT_ID'",
  "client_secret": "'$AUTH0_CLIENT_SECRET'",
  "code": "'$CODE'",
  "redirect_uri": "http://localhost:4200"
}' https://$AUTH0_DOMAIN/oauth/token 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
{  "access_token":  "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik9EQXpOMEZHTWpBd1FVUTJORFpETXpBMVJETXdSRUUyTjBSRE5qRXpNemRFUWtNMk5URTFNUSJ9.eyJpc3MiOiJodHRwczovL25lc3Rqcy1hdXRoMC1qd3QuYXUuYXV0aDAuY29tLyIsInN1YiI6Imdvb2dsZS1vYXV0aDJ8MTEzMDc2NzYwNTUyNTQ5MTY1ODQ5IiwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwIiwiaWF0IjoxNTY1OTg1MzU3LCJleHAiOjE1NjYwNzE3NTcsImF6cCI6IjR0eFZVSm5ZVlRhbzRsczA2dFozRGNCdm5JVk9uY01RIn0.U3dVcaFPY5ZHlz9sntx3O2Svz_HfapBpryrUB9ipIdoIHgu_Skp40FGaLu0Fx-_Uo2GE4pfvM-XR1bQgQGyVbMhALpe2CZrKKCe9k1v4VZ_zxwhYDdV8WNr99jmbMtnm_I9rZIz3YU9dyjWlV_ktHV0bPHj1wIjBUrUc9P_EF5Vw3CeNMxlFXZ2xYldT9XdYUotJHIoJ-e_KWo0hMn_qF5xvWxD-RJIQL7G2ZxEcsmMe9JovwZoAnoqaIyutMP8g7X1UfoTGs-Fa6B1xXhtrYBms--sm_FrM5w0rjIyOuyujulPTeXO8_CbuL1Yz5kCcBsuJdXTiyTcTV9R8W0f4Rg",  "expires_in":  86400,  "token_type":  "Bearer"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#run-application)è¿è¡Œåº”ç”¨

ç”¨ä¹‹å‰ä¿å­˜çš„å€¼æ›¿æ¢å˜é‡`${AUTH0_DOMAIN}`ã€`${AUTH0_CLIENT_ID}`å’Œ`${AUTH0_CLIENT_SECRET}`ï¼Œå¹¶å¯åŠ¨ NestJS åº”ç”¨ç¨‹åºã€‚

```
$ export AUTH0_DOMAIN=${AUTH0_DOMAIN}
$ export AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
$ export AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
$ npm run start:dev 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#make-requests-without-authentication)å‘å‡ºè¯·æ±‚è€Œä¸è¿›è¡Œè®¤è¯

åº”ç”¨ç¨‹åºè¿è¡Œåï¼Œä½¿ç”¨ cURL è®¿é—® API ç«¯ç‚¹`/secret`å’Œ`/profile`ã€‚
æ‚¨å°†å¾—åˆ°ä¸€ä¸ª 401(æœªæˆæƒ)é”™è¯¯ï¼Œå› ä¸ºä¸¤ä¸ªç«¯ç‚¹éƒ½è¢«æ ‡ä¸Šäº†`AuthGuard`æ³¨é‡Šï¼Œå› æ­¤ä¸èƒ½å…¬å¼€ä½¿ç”¨ã€‚

```
$ curl http://localhost:3000/secret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
$ curl http://localhost:3000/profile 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#make-requests-with-authentication)æå‡ºè®¤è¯è¯·æ±‚

ç°åœ¨æ‚¨å¯ä»¥è¿è¡Œç›¸åŒçš„è¯·æ±‚ï¼Œä½†æ˜¯é€šè¿‡`Authorization`å¤´æä¾›è®¿é—®ä»¤ç‰Œã€‚

å› ä¸ºæ‚¨ä¹‹å‰æˆæƒäº†è‡ªå·±ï¼Œæ‰€ä»¥ç°åœ¨å¯ä»¥å¯»å€ä¸¤ä¸ªç§æœ‰ç«¯ç‚¹`/secret`å’Œ`/profile`ã€‚

`/profile`ç«¯ç‚¹è¿˜ä» Auth0 è¿”å›æ‚¨çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼Œè¿™æ˜¯æˆ‘ä»¬ä» Auth0 ç®¡ç† API æ¥æ”¶çš„ã€‚

Auth0 ç®¡ç† API ä½¿ç”¨ JWT å“åº”ä¸­çš„`sub`(ä¸»é¢˜)å­—æ®µæ¥æ£€ç´¢æ‚¨çš„ç”¨æˆ·é…ç½®æ–‡ä»¶ã€‚
ç”±äºæ–‡æ¡£çš„åŸå› ï¼Œç¤ºä¾‹åº”ç”¨ç¨‹åºä¸­çš„ JWT å“åº”è¢«è®°å½•åˆ°æ§åˆ¶å°ã€‚

```
$ curl http://localhost:3000/secret \
  -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik9EQXpOMEZHTWpBd1FVUTJORFpETXpBMVJETXdSRUUyTjBSRE5qRXpNemRFUWtNMk5URTFNUSJ9.eyJpc3MiOiJodHRwczovL25lc3Rqcy1hdXRoMC1qd3QuYXUuYXV0aDAuY29tLyIsInN1YiI6Imdvb2dsZS1vYXV0aDJ8MTEzMDc2NzYwNTUyNTQ5MTY1ODQ5IiwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwIiwiaWF0IjoxNTY1OTg1MzU3LCJleHAiOjE1NjYwNzE3NTcsImF6cCI6IjR0eFZVSm5ZVlRhbzRsczA2dFozRGNCdm5JVk9uY01RIn0.U3dVcaFPY5ZHlz9sntx3O2Svz_HfapBpryrUB9ipIdoIHgu_Skp40FGaLu0Fx-_Uo2GE4pfvM-XR1bQgQGyVbMhALpe2CZrKKCe9k1v4VZ_zxwhYDdV8WNr99jmbMtnm_I9rZIz3YU9dyjWlV_ktHV0bPHj1wIjBUrUc9P_EF5Vw3CeNMxlFXZ2xYldT9XdYUotJHIoJ-e_KWo0hMn_qF5xvWxD-RJIQL7G2ZxEcsmMe9JovwZoAnoqaIyutMP8g7X1UfoTGs-Fa6B1xXhtrYBms--sm_FrM5w0rjIyOuyujulPTeXO8_CbuL1Yz5kCcBsuJdXTiyTcTV9R8W0f4Rg' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
$ curl http://localhost:3000/profile \
  -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik9EQXpOMEZHTWpBd1FVUTJORFpETXpBMVJETXdSRUUyTjBSRE5qRXpNemRFUWtNMk5URTFNUSJ9.eyJpc3MiOiJodHRwczovL25lc3Rqcy1hdXRoMC1qd3QuYXUuYXV0aDAuY29tLyIsInN1YiI6Imdvb2dsZS1vYXV0aDJ8MTEzMDc2NzYwNTUyNTQ5MTY1ODQ5IiwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwIiwiaWF0IjoxNTY1OTg1MzU3LCJleHAiOjE1NjYwNzE3NTcsImF6cCI6IjR0eFZVSm5ZVlRhbzRsczA2dFozRGNCdm5JVk9uY01RIn0.U3dVcaFPY5ZHlz9sntx3O2Svz_HfapBpryrUB9ipIdoIHgu_Skp40FGaLu0Fx-_Uo2GE4pfvM-XR1bQgQGyVbMhALpe2CZrKKCe9k1v4VZ_zxwhYDdV8WNr99jmbMtnm_I9rZIz3YU9dyjWlV_ktHV0bPHj1wIjBUrUc9P_EF5Vw3CeNMxlFXZ2xYldT9XdYUotJHIoJ-e_KWo0hMn_qF5xvWxD-RJIQL7G2ZxEcsmMe9JovwZoAnoqaIyutMP8g7X1UfoTGs-Fa6B1xXhtrYBms--sm_FrM5w0rjIyOuyujulPTeXO8_CbuL1Yz5kCcBsuJdXTiyTcTV9R8W0f4Rg' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

* * *

æˆ‘å¸Œæœ›æœ¬æ–‡èƒ½è®©æ‚¨äº†è§£å¦‚ä½•åœ¨æ‚¨çš„ NestJS åº”ç”¨ç¨‹åºä¸­å®ç°åƒ Auth0 è¿™æ ·çš„èº«ä»½éªŒè¯æä¾›è€…ã€‚

å¯¹æˆ‘æ¥è¯´ï¼Œåœ¨æˆ‘çš„é¡¹ç›®ä¸­é›†æˆ Auth0 å’Œ authentication éå¸¸éº»çƒ¦ï¼Œä½†æœ€ç»ˆæˆ‘è®©å®ƒå·¥ä½œäº†ï¼Œè¿™æ„Ÿè§‰çœŸçš„å¾ˆæ£’ã€‚

> ![Matthias ğŸ§” profile image](../Images/b1ec38a41528706423a4675eddade26c.png)é©¬æäºšæ–¯Â·ğŸ§”@ full stack _ to![twitter logo](../Images/4c8a2313941dda016bf4d78d103264aa.png)[@ nest framework](https://twitter.com/nestframework)[@ auth 0](https://twitter.com/auth0)[@ kammysliwiec](https://twitter.com/kammysliwiec)ğŸ¥³æˆ‘ç»ˆäºæå®šäº†ï¼
> 
> ç°åœ¨æˆ‘å¯ä»¥ç”¨ Auth0 ä¿æŠ¤ä¸€ä¸ª API ç«¯ç‚¹ï¼Œå¹¶ä¸”æˆ‘æœ‰äº†å¦ä¸€ä¸ªç«¯ç‚¹ï¼Œå…¶ä¸­ JWT ä»¤ç‰Œæ‰€æœ‰è€…çš„é…ç½®æ–‡ä»¶æ˜¯ä» Auth0 è·å–çš„ğŸ‘
> 
> æˆ‘å°†åœ¨ [dev.to](https://t.co/5lD2d1RTb8) ä¸Šå†™å‡ è¡Œæˆ‘æ˜¯å¦‚ä½•å®Œæˆçš„ï¼ğŸ“2019 å¹´ 8 æœˆ 15 æ—¥ä¸‹åˆ 18:25[![Twitter reply action](../Images/44d8b042100e231770330321e5b63d65.png)](https://twitter.com/intent/tweet?in_reply_to=1162067806109732864)[![Twitter retweet action](../Images/93d9c70ccc54851d2e8e881b53c21dae.png)](https://twitter.com/intent/retweet?tweet_id=1162067806109732864)[![Twitter like action](../Images/2e93f7775eadefab8bcd34a4542cc5a7.png)](https://twitter.com/intent/like?tweet_id=1162067806109732864)

> ![Matthias ğŸ§” profile image](../Images/b1ec38a41528706423a4675eddade26c.png)é©¬æäºšæ–¯Â·ğŸ§”@ full stack _ to![twitter logo](../Images/4c8a2313941dda016bf4d78d103264aa.png)[@ nest framework](https://twitter.com/nestframework)[@ auth 0](https://twitter.com/auth0)[@ kammysliwiec](https://twitter.com/kammysliwiec)è¿™äº›æ—¶åˆ»æé†’æˆ‘ä¸ºä»€ä¹ˆæˆ‘çƒ­çˆ±ç¼–ç â¤ï¸
> è€Œä¸”ï¼Œæœ‰æ—¶åœæ­¢æŸä¸ªç‰¹å®šé—®é¢˜ä¸€æ®µæ—¶é—´çš„å·¥ä½œä»¥è·å¾—æ–°çš„è§†è§’æ˜¯æœ‰æ„ä¹‰çš„ã€‚2019 å¹´ 8 æœˆ 15 æ—¥ä¸‹åˆ 18:27[![Twitter reply action](../Images/44d8b042100e231770330321e5b63d65.png)](https://twitter.com/intent/tweet?in_reply_to=1162068298395258880)[![Twitter retweet action](../Images/93d9c70ccc54851d2e8e881b53c21dae.png)](https://twitter.com/intent/retweet?tweet_id=1162068298395258880)[![Twitter like action](../Images/2e93f7775eadefab8bcd34a4542cc5a7.png)](https://twitter.com/intent/like?tweet_id=1162068298395258880)

[![matthias profile image](../Images/c388b8fe3100715731da3d929f42f97f.png) ](/matthias) [ Matthias ğŸ¤– ](/matthias) â€¢ [<time datetime="2019-08-17T07:45:24Z"> Aug 17 '19 </time>](https://dev.to/matthias/comment/e8an) 

æˆ‘æ— æ³•åœ¨æˆ‘çš„ NestJS é¡¹ç›®ä¸­è·å¾— Auth0 è®¤è¯ã€‚æˆ‘ä¹Ÿåœ¨è¿™é‡Œå¯»æ±‚å¸®åŠ©:

[![fullstack_to image](../Images/1be7c3a03ee5af90f231eb5d35ad56d2.png)](/fullstack_to) [## å¯¹ NestJS ä½¿ç”¨ JWT èº«ä»½éªŒè¯(Auth0)ğŸ”

### é©¬æäºšğŸ¤–8 æœˆ 14 æ—¥ 1 åˆ†é’Ÿè¯»å–

#help #webdev #security](/fullstack_to/using-jwt-authentication-auth0-with-nestjs-54oo)

æˆ‘åœ¨è¿™ä¸ªé—®é¢˜ä¸ŠæŒ£æ‰äº†å‡ å¤©ï¼Œç„¶åä¼‘æ¯äº†ä¸€æ®µæ—¶é—´ï¼Œä¸€å¤©å·¦å³æ²¡æœ‰ç¢°æˆ‘çš„ä»£ç ã€‚æˆ‘å¸¦ç€å¹²å‡€çš„å¤´è„‘é‡æ–°å¼€å§‹ï¼Œå¹¶èƒ½åœ¨ä¸€å°æ—¶å†…è§£å†³é—®é¢˜ğŸ¥³.

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œå½“ä½ æœ‰æ‰€æˆå°±çš„æ—¶å€™ï¼Œä½ æ€»ä¼šæœ‰è¿™ç§ä¼Ÿå¤§çš„æ—¶åˆ»ğŸ’ª
å’Œ*é€šå¸¸*æ¯éš”å‡ ä¸ªå°æ—¶æˆ–å‡ å¤©(å–å†³äºä½ çš„é¡¹ç›®è§„æ¨¡)ä½ å°±ä¼šæœ‰è¿™ä¸ªå°å°çš„çªç ´ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯æˆ‘å·¥ä½œä¸­æœ€æœ‰åŠ¨åŠ›çš„äº‹æƒ…ï¼

é¡ºä¾¿è¯´ä¸€å¥:æˆ‘æ­£åœ¨å†™ä¸€ç¯‡å…³äºæˆ‘å¦‚ä½•è§£å†³å®ƒçš„æ–‡ç« ğŸ˜‰ã€‚

æˆ‘è¿˜è®¤ä¸ºå…³äºè®¤è¯çš„ NestJS æ–‡æ¡£å¯ä»¥æ”¹è¿›ï¼Œä½¿äººä»¬æ›´å®¹æ˜“æ­£ç¡®åœ°å®ç°å®ƒï¼Œé¿å…å®‰å…¨æ¼æ´ã€‚ç„¶è€Œï¼Œæˆ‘ä¸æŠ±æ€¨ï¼ŒNestJS æ˜¯å¼€æºçš„ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥[æ”¹è¿›æ–‡æ¡£ã€‚](https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/authentication.md)

å¦‚æœä½ å¯¹ NestJSã€Auth0 æˆ–å…¶ä»–è¯é¢˜æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·ä¸è¦çŠ¹è±«ï¼Œåœ¨ [Twitter](https://twitter.com/fullstack_to) ã€ [dev.to](https://dev.to/connect/@fullstack_to) ä¸Šç»™æˆ‘å†™ DMï¼Œæˆ–è€…ç»™æˆ‘å†™é‚®ä»¶: [yo@fullstack.to](//mailto:yo@fullstack.to) ã€‚æˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ ï¼

## [](#links)é“¾æ¥

*   [NestJS æ–‡æ¡£](https://docs.nestjs.com/)
*   [Auth0](https://auth0.com)
*   [Auth0 ç®¡ç† API æ–‡æ¡£](https://auth0.com/docs/api/management/v2)

* * *

å¦‚æœä½ å–œæ¬¢æˆ‘çš„å†…å®¹ï¼Œä½ å¯èƒ½æƒ³åœ¨ Twitter ä¸Šå…³æ³¨æˆ‘ï¼Ÿï¼ [@fullstack_to](https://twitter.com/fullstack_to)

[un plash](https://unsplash.com/photos/8yYAaguVDgY)ä¸Š [Jason Blackeye](https://unsplash.com/@jeisblack) çš„å°é¢å›¾ç‰‡