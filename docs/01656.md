# æˆ‘å†™äº†æˆ‘çš„æ¨¡å—æ†ç»‘å™¨

> åŸæ–‡:[https://dev.to/tanhauhau/i-wrote-my-module-bundler-23cl](https://dev.to/tanhauhau/i-wrote-my-module-bundler-23cl)

åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘è§£é‡Šäº†æ¨¡å—æ†ç»‘å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚æˆ‘ä½¿ç”¨äº† [webpack](https://webpack.js.org) å’Œ [rollup](https://rollupjs.org) ä½œä¸ºä¾‹å­ï¼Œå®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªéƒ½ç»™äº†æˆ‘ä»¬ä¸€ä¸ªä¸åŒçš„è§†è§’ï¼Œå‘Šè¯‰æˆ‘ä»¬å¦‚ä½•æ†ç»‘æˆ‘ä»¬çš„ JavaScript åº”ç”¨ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºæˆ‘æ˜¯å¦‚ä½•ç¼–å†™æˆ‘çš„æ¨¡å— bundler çš„ã€‚æ¨¡å—æ†æ‰æœºæœ¬èº«å¹¶ä¸é€‚åˆç”Ÿäº§ï¼Œä½†æˆ‘é€šè¿‡ç»ƒä¹ å­¦åˆ°äº†å¾ˆå¤šï¼Œè€Œä¸”æˆ‘è¶Šæ¥è¶Šæ¬£èµç°ä»£æ¨¡å—æ†æ‰æœºæ‰€æä¾›çš„ä¸œè¥¿ã€‚

* * *

âš ï¸ **è­¦å‘Š:å‰æ–¹æœ‰å¤§é‡çš„ JavaScript ä»£ç ã€‚ğŸ™ˆğŸ˜±ğŸ˜¨** âš ï¸

* * *

# [](#getting-started)å…¥é—¨

æˆ‘åœ¨æˆ‘çš„å‰ä¸€ç¯‡æ–‡ç« ä¸­è°ˆåˆ°äº†æ¨¡å—æ†ç»‘å™¨çš„è¾“å…¥(JavaScript æ¨¡å—)å’Œè¾“å‡º(æ†ç»‘çš„ JavaScript æ–‡ä»¶)ã€‚ç°åœ¨æ˜¯æ—¶å€™ç¼–å†™ä¸€ä¸ªæ¥æ”¶è¾“å…¥å¹¶äº§ç”Ÿè¾“å‡ºçš„æ¨¡å—æ†ç»‘å™¨äº†ã€‚

ä¸€ä¸ª*åŸºæœ¬*æ¨¡å—æ†æ‰æœºå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:

*   ç†è§£ä»£ç å¹¶æ„å»ºä¾èµ–å›¾**(ä¾èµ–è§£æ)**
*   å°†æ¨¡å—ç»„è£…æˆä¸€ä¸ª(æˆ–å¤šä¸ª)JavaScript æ–‡ä»¶ **(Bundle)**

> **ä¾èµ–å›¾**æ˜¯æ¨¡å—é—´ä¾èµ–å…³ç³»çš„å›¾å½¢è¡¨ç¤ºã€‚

## [](#the-input)è¾“å…¥

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ä»¥ä¸‹æ–‡ä»¶ä½œä¸ºæˆ‘å¯¹ bundler çš„è¾“å…¥:

```
// filename: index.js
import squareArea from './square.js';
import circleArea from './circle.js';

console.log('Area of square: ', squareArea(5));
console.log('Area of circle', circleArea(5)); 
```

```
// filename: square.js
function area(side) {
  return side * side;
}
export default area; 
```

```
// filename: circle.js
const PI = 3.141;
function area(radius) {
  return PI * radius * radius;
}
export default area; 
```

æˆ‘å·²ç»åœ¨ [Github](https://github.com/tanhauhau/byo-bundler/tree/master/fixture) ä¸Šåˆ›å»ºäº†è¿™ä¸ªé¡¹ç›®ï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰å…´è¶£äº²è‡ªå°è¯•ä¸€ä¸‹ï¼Œä½ å¯ä»¥å…‹éš†å®ƒå¹¶æ£€æŸ¥`fixture-1`æ ‡ç­¾ã€‚è¾“å…¥æ–‡ä»¶åœ¨`fixture/`æ–‡ä»¶å¤¹ä¸­ã€‚

# [](#writing)å†™ä½œ

æˆ‘ä»æ¨¡å—æ†ç»‘å™¨çš„ä¸»è¦ç»“æ„å¼€å§‹:

```
function build({ entryFile, outputFolder }) {
  // build dependency graph
  const graph = createDependencyGraph(entryFile);
  // bundle the asset
  const outputFiles = bundle(graph);
  // write to output folder
  for(const outputFile of outputFiles) {
    fs.writeFileSync(
      path.join(outputFolder, outputFile.name),
      outputFile.content,
      'utf-8'
    )
  }
} 
```

> **ä¾èµ–å›¾**æ˜¯ä¸€ä¸ª[æœ‰å‘å›¾](https://en.wikipedia.org/wiki/Directed_graph)ï¼Œå…¶ä¸­é¡¶ç‚¹æ˜¯æ¨¡å—ï¼Œæœ‰å‘è¾¹æ˜¯æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚

```
function createDependencyGraph(entryFile) {
  const rootModule = createModule(entryFile);
  return rootModule;
} 
```

æ‰€ä»¥ï¼Œå…¥å£æ¨¡å—æ˜¯å›¾çš„â€œæ ¹â€ã€‚

åœ¨`createModule`ä¸­ï¼Œæˆ‘å®ä¾‹åŒ–äº†ä¸€ä¸ªæ–°çš„`Module`å®ä¾‹:

```
function createModule(filePath) {
  return new Module(filePath);
} 
```

ç±»`Module`å°†ç”¨äºè®°å½•æ¨¡å—å±æ€§ï¼Œä¾‹å¦‚å†…å®¹ã€ä¾èµ–å…³ç³»ã€å¯¼å‡ºçš„å¯†é’¥ç­‰ã€‚

```
class Module {
  constructor(filePath) {
    this.filePath = filePath;
    this.content = fs.readFileSync(filePath, 'utf-8');
    this.dependencies = [];
  }
} 
```

è™½ç„¶`content`æ˜¯æ¨¡å—çš„å­—ç¬¦ä¸²å†…å®¹ï¼Œä¸ºäº†ç†è§£å®ƒçš„å®é™…å«ä¹‰ï¼Œæˆ‘ä½¿ç”¨[å·´åˆ«å¡”](http://babeljs.io)åˆ°*å°†å†…å®¹*è§£ææˆ AST(æŠ½è±¡è¯­æ³•æ ‘):

```
// highlight-next-line
const babel = require('@babel/core');

class Module {
  constructor(filePath) {
    this.filePath = filePath;
    this.content = fs.readFileSync(filePath, 'utf-8');
    // highlight-next-line
    this.ast = babel.parseSync(this.content);
  }
} 
```

æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦æ‰¾å‡ºè¿™ä¸ªæ¨¡å—çš„ä¾èµ–:

```
class Module {
  constructor(filePath) {
    this.filePath = filePath;
    this.content = fs.readFileSync(filePath, 'utf-8');
    this.ast = babel.parseSync(this.content);
    // highlight-start
    this.dependencies = this.findDependencies();
  }
  findDependencies() {
    //
  }
  // highlight-end
} 
```

é‚£ä¹ˆï¼Œæˆ‘æ€ä¹ˆçŸ¥é“è¿™ä¸ªæ¨¡å—çš„ä¾èµ–å…³ç³»æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

æˆ‘å¯ä»¥åœ¨
[babel-ast-explorer](https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjQuNSJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImltcG9ydCBzcXVhcmVBcmVhIGZyb20gJy4vc3F1YXJlLmpzJztcbmltcG9ydCBjaXJjbGVBcmVhIGZyb20gJy4vY2lyY2xlLmpzJztcblxuY29uc29sZS5sb2coJ0FyZWEgb2Ygc3F1YXJlOiAnLCBzcXVhcmVBcmVhKDUpKTtcbmNvbnNvbGUubG9nKCdBcmVhIG9mIGNpcmNsZScsIGNpcmNsZUFyZWEoNSkpO1xuIn0=) çš„å¸®åŠ©ä¸‹ä» AST ä¸­æŸ¥æ‰¾`import`è¯­å¥ã€‚

[![babel-ast-explorer](img/cd376bc4a4abfdaf36fedd46ed84d909.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--J1WhJ4kO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://lihautan.com/static/87b78a845870fcfa5bb6756e80815d95/7a439/ast-import.png) 
*é€šè¿‡å·´åˆ«å¡”å¯è§†åŒ– AST-AST-explorer*

æˆ‘å‘ç° AST ä¸­çš„`import`è¯­å¥è¢«ç§°ä¸º`ImportDeclaration`ã€‚å®ƒæœ‰`specifiers`å’Œ`source`ï¼Œ`source.value`å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªæ¨¡å—æ˜¯ä»ä»€ä¹ˆåœ°æ–¹å¯¼å…¥çš„:

```
findDependencies() {
  // highlight-start
  return this.ast.program.body
    .filter(node => node.type === 'ImportDeclaration')
    .map(node => node.source.value)
  // highlight-end
} 
```

æ‰€ä»¥æˆ‘æœ‰äº†æ¨¡å—è¯·æ±‚çš„è·¯å¾„ï¼Œä½†æ˜¯å®ƒå¯èƒ½æ˜¯ç›¸å¯¹äºå½“å‰æ–‡ä»¶çš„ï¼Œä¾‹å¦‚`"./foo/bar"`ï¼Œæˆ–è€…æ¥è‡ª`node_modules`ï¼Œä¾‹å¦‚:`"lodash"`ã€‚æˆ‘å¦‚ä½•çŸ¥é“æ¨¡å—è¯·æ±‚çš„**å®é™…æ–‡ä»¶è·¯å¾„**æ˜¯ä»€ä¹ˆï¼Ÿ

åŸºäºè¯·æ±‚è·¯å¾„è®¡ç®—å‡ºå®é™…è·¯å¾„çš„æ­¥éª¤è¢«ç§°ä¸º**â€œè§£æâ€** :

```
findDependencies() {
  return this.ast.program.body
    .filter(node => node.type === 'ImportDeclaration')
    .map(node => node.source.value)
  // highlight-next-line
    .map(relativePath => resolveRequest(this.filePath, relativePath))
}

// highlight-start
// resolving
function resolveRequest(requester, requestedPath) {
  //
} 
```

*è§£æè·¯å¾„åˆ°å®é™…æ–‡ä»¶è·¯å¾„*

## [](#resolving)è§£æ

å…ˆè¯´åŒ–è§£ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­â€œå¯¼å…¥â€`./b.js`å°†å¯¼è‡´è·å¾—ä¸€ä¸ªä¸åŒçš„æ–‡ä»¶ï¼Œå› ä¸ºå½“æˆ‘ä»¬æŒ‡å®š`./`æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç›¸å¯¹äºå½“å‰æ–‡ä»¶â€œå¯¼å…¥â€çš„ã€‚

```
// filename: project/a.js
import './b.js'; 
```

```
// filename: project/foo/a.js
import './b.js'; 
```

é‚£ä¹ˆï¼Œè§£æä¸€ä¸ªæ¨¡å—çš„è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

Node.js æ–‡æ¡£å·²ç»åˆ—å‡ºäº†æ¨¡å—è§£æç®—æ³•çš„[è¯¦ç»†æ­¥éª¤:](http://nodejs.org/api/modules.html#modules_all_together)

å½“æˆ‘ä»¬æŒ‡å®šä¸€ä¸ªç›¸å¯¹è·¯å¾„`./b`æ—¶ï¼ŒNode.js å°†é¦–å…ˆå‡è®¾`./b`æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœå®ƒä¸å®Œå…¨åŒ¹é…æ–‡ä»¶åï¼Œå°±å°è¯•ä¸‹é¢çš„æ‰©å±•å:

```
b
b.js
b.json
b.node 
```

å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒNode.js å°†å°è¯•å°†`./b`è§†ä¸ºä¸€ä¸ªç›®å½•ï¼Œå¹¶å°è¯•ä»¥ä¸‹æ“ä½œ:

```
"main" in b/package.json
b/index.js
b/index.json
b/index.node 
```

å¦‚æœæˆ‘ä»¬æ”¹ä¸ºæŒ‡å®š`import 'b'`ï¼ŒNode.js å°†æŠŠå®ƒè§†ä¸º`node_modules/`ä¸­çš„ä¸€ä¸ªåŒ…ï¼Œå¹¶å…·æœ‰ä¸åŒçš„è§£æç­–ç•¥ã€‚

é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè§£å†³`import './b'`å¹¶ä¸åƒçœ‹èµ·æ¥é‚£ä¹ˆç®€å•ã€‚é™¤äº†é»˜è®¤çš„ Node.js è§£æè¡Œä¸ºï¼Œ [webpack æä¾›äº†æ›´å¤šçš„å®šåˆ¶é€‰é¡¹](https://webpack.js.org/configuration/resolve/)ï¼Œæ¯”å¦‚å®šåˆ¶æ‰©å±•ã€åˆ«åã€æ¨¡å—æ–‡ä»¶å¤¹ç­‰ç­‰ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘å‘æ‚¨å±•ç¤ºäº†*â€œæœ€ç®€å•çš„â€*è§£æå™¨ï¼Œå®ƒåªè§£æç›¸å¯¹è·¯å¾„:

```
const path = require('path');
// highlight-start
// resolving
function resolveRequest(requester, requestedPath) {
  return path.join(path.dirname(requester), requestedPath);
} 
```

> <small>**æ³¨æ„:**ä½ åº”è¯¥è¯•ç€ä»`node_modules/`</small> å†™ä¸€ä¸ªå®Œæ•´çš„èŠ‚ç‚¹è§£æå™¨ï¼Œæ—¢å¯ä»¥ç›¸å¯¹è§£æä¹Ÿå¯ä»¥ç»å¯¹è§£æ

ç°åœ¨æˆ‘çŸ¥é“äº†å®é™…è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç„¶åæˆ‘ç”¨å®ƒä»¬åˆ›å»ºæ¨¡å—ã€‚

```
findDependencies() {
  return this.ast.program.body
    .filter(node => node.type === 'ImportDeclaration')
    .map(node => node.source.value)
    .map(relativePath => resolveRequest(this.filePath, relativePath))
    // highlight-next-line
    .map(absolutePath => createModule(absolutePath))
} 
```

å› æ­¤ï¼Œå¯¹äºæ¯ä¸ªæ¨¡å—ï¼Œæˆ‘æ‰¾åˆ°å®ƒä»¬çš„ä¾èµ–é¡¹ï¼Œè§£æå®ƒä»¬ï¼Œæ‰¾åˆ°æ¯ä¸ªä¾èµ–é¡¹çš„ä¾èµ–é¡¹ï¼Œä¹Ÿè§£æå®ƒä»¬ï¼Œæ‰¾åˆ°å®ƒä»¬çš„ä¾èµ–é¡¹ï¼Œä»¥æ­¤ç±»æ¨ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹çš„æœ€åï¼Œæˆ‘å¾—åˆ°äº†ä¸€ä¸ªæ¨¡å—ä¾èµ–å›¾ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·:

```
Module {
  filePath: '/Projects/byo-bundler/fixture/index.js',
  content:
   'import squareArea from \'./square.js\';\nimport circleArea from \'./circle.js\';\n\nconsole.log(\'Area of square: \', squareArea(5));\nconsole.log(\'Area of circle\', circleArea(5));\n',
  ast:
   Node { /*...*/ },
  dependencies:
   [ Module {
       filePath: '/Projects/byo-bundler/fixture/square.js',
       content:
        'function area(side) {\n return side * side;\n}\nexport default area;\n',
       ast: Node {/* ... */},
       dependencies: []
      },
     Module {
       filePath: '/Projects/byo-bundler/fixture/circle.js',
       content:
        'const PI = 3.141;\nfunction area(radius) {\n return PI * radius * radius;\n}\nexport default area;\n',
       ast: Node {/* ... */},
       dependencies: []
      }
   ]
} 
```

å›¾çš„æ ¹æ˜¯æˆ‘ä»¬çš„å…¥å£æ¨¡å—ï¼Œä½ å¯ä»¥é€šè¿‡æ¨¡å—çš„`dependencies`éå†å›¾ã€‚å¦‚æ‚¨æ‰€è§ï¼Œ`index.js`æœ‰ä¸¤ä¸ªä¾èµ–é¡¹ï¼Œ`square.js`å’Œ`circle.js`ã€‚

> <small>**æ³¨æ„:**å¦‚æœæ‚¨æ­£åœ¨è·Ÿè¿›ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥æ ‡ç­¾`feat-1-module-dependency-graph`ï¼ŒæŸ¥çœ‹æˆ‘åˆ°ç›®å‰ä¸ºæ­¢ç¼–å†™çš„ä»£ç ã€‚</small>

## [](#bundling)æ†ç»‘

æœ‰äº†æ¨¡å—ä¾èµ–å›¾ï¼Œæ˜¯æ—¶å€™å°†å®ƒä»¬æ†ç»‘åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­äº†ï¼

æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ˜¯ä»¥**â€œweb pack æ–¹å¼â€**è¿˜æ˜¯ä»¥**â€œroll up æ–¹å¼â€**è¿›è¡Œæ†ç»‘ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºæˆ‘æ˜¯å¦‚ä½•åšåˆ°çš„**â€œç½‘ç»œåŒ…æ–¹å¼â€**ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†åœ¨**â€œroll up wayâ€**ä¸­è®¨è®ºæ†ç»‘ã€‚

> å¦‚æœä½ ä¸çŸ¥é“ä»€ä¹ˆæ˜¯**ã€**ã€**ã€**ã€[ä¸Šä¸€ç¯‡æ–‡ç« ](https://lihautan.com/what-is-module-bundler-and-how-does-it-work/)ä¸­æˆ‘å·²ç»â€œåˆ›é€ â€äº†è¿™ä¸ªæœ¯è¯­ï¼Œå¹¶æœ‰è¯¦ç»†çš„è§£é‡Šï¼

è®©æˆ‘ä»¬çœ‹çœ‹æœ€ç»ˆçš„æ†ç»‘æ–‡ä»¶ä¼šæ˜¯ä»€ä¹ˆæ ·å­:

```
const modules = {
  'circle.js': function(exports, require) {
    const PI = 3.141;
    exports.default = function area(radius) {
      return PI * radius * radius;
    };
  },
  'square.js': function(exports, require) {
    exports.default = function area(side) {
      return side * side;
    };
  },
  'app.js': function(exports, require) {
    const squareArea = require('square.js').default;
    const circleArea = require('circle.js').default;
    console.log('Area of square: ', squareArea(5));
    console.log('Area of circle', circleArea(5));
  },
};

webpackStart({
  modules,
  entry: 'app.js',
}); 
```

è®©æˆ‘ä»¬æŠŠå®ƒåˆ†æˆå‡ ä¸ªæ­¥éª¤:

*   **å°†æ¨¡å—åˆ†ç»„åˆ°æ–‡ä»¶ä¸­**
*   **åˆ›å»ºæ¨¡å—å›¾**å¹¶å°†æ¯ä¸ªæ¨¡å—åŒ…è£…åœ¨ä¸€ä¸ªâ€œç‰¹æ®Šçš„â€æ¨¡å—å·¥å‚å‡½æ•°ä¸­
*   **åˆ›å»ºâ€œè¿è¡Œæ—¶â€**ï¼Œå°†å„ä¸ªæ¨¡å—è¿æ¥åœ¨ä¸€èµ·çš„ç²˜åˆå‰‚ã€‚

### [](#grouping-modules-into-files)å°†æ¨¡å—åˆ†ç»„æˆæ–‡ä»¶

è¿™ä¸€æ­¥æ˜¯å†³å®šå“ªä¸ªæ¨¡å—å»å“ªä¸ªæ–‡ä»¶ã€‚ç”±äºåŠ¨æ€å¯¼å…¥å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨¡å—åˆ†æˆä¸åŒçš„æ–‡ä»¶ï¼Œä¾‹å¦‚ webpack çš„[å—åˆ†å‰²](https://webpack.js.org/plugins/split-chunks-plugin/)ã€‚

ä»¥åæˆ‘ä¼šæ”¯æŒä»£ç æ‹†åˆ†ã€‚ç°åœ¨ï¼Œæˆ‘å°†æ‰€æœ‰æ¨¡å—åˆ†ç»„åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚

ä¸ºäº†å°†æ¨¡å—å›¾ä¸­çš„æ‰€æœ‰æ¨¡å—æ”¶é›†åˆ°ä¸€ä¸ªæ¨¡å—åˆ—è¡¨ä¸­ï¼Œæˆ‘åšäº†ä¸€ä¸ªå›¾éå†:

```
function bundle(graph) {
  // highlight-next-line
  collectModules(graph);
  return [];
}

// highlight-start
function collectModules(graph) {
  const modules = [];
  collect(graph, modules);
  return modules;

  function collect(module, modules) {
    modules.push(module);
    module.dependencies.forEach(dependency => collect(dependency, modules));
  }
} 
```

...æˆ‘ç”¨æ¨¡å—åˆ—è¡¨åˆ›å»ºäº†ä¸€ä¸ªæ¨¡å—å›¾ã€‚

### [](#creating-module-map)åˆ›å»ºæ¨¡å—å›¾

æˆ‘åˆ›å»ºçš„æ¨¡å—æ˜ å°„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒå°†è¢«å†…è”åˆ°æœ€ç»ˆçš„åŒ…æ–‡ä»¶ä¸­ã€‚

æˆ‘éå†äº†æ¯ä¸ªæ¨¡å—ï¼Œä½¿ç”¨`module.filePath`ä½œä¸ºé”®ï¼Œä½¿ç”¨`module.content`ä½œä¸ºå€¼ã€‚

æˆ‘ä¸ä½¿ç”¨`JSON.stringify(moduleMap)`è€Œæ˜¯æ‰‹åŠ¨è¿æ¥æ¥æ„å»ºæ¨¡å—æ˜ å°„çš„åŸå› æ˜¯å› ä¸º JSON åªèƒ½æ¥å— [JSON åŸå§‹æ•°æ®ç±»å‹](https://documentation.progress.com/output/ua/OpenEdge_latest/index.html#page/dvjsn/json-data-types.html)ä½œä¸ºå€¼ï¼Œä½†æ˜¯æˆ‘åœ¨è¿™é‡Œæ„å»ºçš„æ˜¯ä¸€ä¸ª JavaScript æ˜ å°„ï¼Œä»¥`function`ä½œä¸ºå€¼ï¼Œä½†æ˜¯åœ¨å­—ç¬¦ä¸²ä¸­ã€‚

```
function bundle(graph) {
  const modules = collectModules(graph);
  // highlight-next-line
  const moduleMap = toModuleMap(modules);
  return [];
}

// highlight-start
function toModuleMap(modules) {
  let moduleMap = '';
  moduleMap += '{';

  for (const module of modules) {
    moduleMap += `"${module.filePath}": `;
    moduleMap += `function(exports, require) { ${module.content} },`;
  }

  moduleMap += '}';
  return moduleMap;
} 
```

åŒ…è£…`module.content`çš„å‡½æ•°è¢«ç§°ä¸ºæ¨¡å—å·¥å‚å‡½æ•°ã€‚å®ƒå‘æ¨¡å—æä¾› 2 ä¸ªå‚æ•°:

*   `exports`ï¼Œæ¨¡å—å¯ä»¥å°†å…¶å¯¼å‡ºå€¼èµ‹ç»™çš„å¯¹è±¡
*   `require`ï¼Œæ¨¡å—å¯ä»¥ç”¨æ¨¡å—è·¯å¾„è°ƒç”¨çš„å‡½æ•°ï¼Œä»å¦ä¸€ä¸ªæ¨¡å—å¯¼å…¥å¯¼å‡ºå€¼

æ¨¡å—å›¾ç°åœ¨ä¸æ˜¯å¯ä»¥æ‰§è¡Œçš„ä¸œè¥¿:

```
{
  "index.js": function(exports, require) {
    import squareArea from './square.js';
    import circleArea from './circle.js';

    console.log('Area of square: ', squareArea(5));
    console.log('Area of circle', circleArea(5));
  },
  "square.js": function(exports, require) {
    function area(side) {
      return side * side;
    }
    export default area;
  },
  "circle.js": function(exports, require) {
    const PI = 3.141;
    function area(radius) {
      return PI * radius * radius;
    }
    export default area;
  },
} 
```

å› ä¸ºå®ƒè¿˜æ˜¯ç”¨`import`å’Œ`export`ã€‚æˆ‘å¿…é¡»è½¬æ¢å®ƒä»¬æ¥ä½¿ç”¨æˆ‘ä»¬ä¼ å…¥çš„`exports`å’Œ`require`ã€‚

ä¸ºäº†è½¬æ¢ä»£ç ï¼Œæˆ‘å†æ¬¡ä½¿ç”¨äº†æ¨¡å—çš„ ast:è½¬æ¢ ast å¹¶ä»è½¬æ¢åçš„ AST ç”Ÿæˆæ–°ä»£ç ã€‚

æˆ‘éœ€è¦çš„æ˜¯æŠŠä¸‹é¢çš„â€œä»â€è½¬æ¢æˆâ€œåˆ°:

```
// #1
// from
import a, { b, c } from 'foo';
// to
const { default: a, b, c } = require('foo');

// #2
export default a;
export const b = 2;
export { c };
// to
exports.default = a;
exports.b = 2;
exports.c = c; 
```

> æˆ‘å†™äº†ä¸€ç¯‡å…³äºå¦‚ä½•å†™å·´åˆ«å¡”å˜æ¢çš„[å¾ªåºæ¸è¿›æŒ‡å—](https://lihautan.com/step-by-step-guide-for-writing-a-babel-transformation)ï¼Œè¯·åŠ¡å¿…æŸ¥çœ‹ã€‚

çŸ¥é“äº† AST ä¸Šçš„ç›®æ ‡**å’Œ**è½¬æ¢åçš„ AST çœ‹èµ·æ¥å¦‚ä½•**ï¼Œæˆ‘ç¼–å†™äº†æˆ‘çš„è½¬æ¢ä»£ç :** 

```
for (const module of modules) {
  // highlight-next-line
  module.transformModuleInterface();
  moduleMap += `"${module.filePath}": function(exports, require) { ${module.content} },`;
}
// ...
class Module {
  // ...
  // highlight-start
  transformModuleInterface() {
    const { ast, code } = babel.transformFromAstSync(this.ast, this.content, { ... });
    this.ast = ast;
    this.content = code;
  }
  // highlight-end
} 
```

æˆ‘çœç•¥äº†å®é™…çš„ babel è½¬æ¢ä»£ç ï¼Œå› ä¸ºå®ƒå¾ˆé•¿ã€‚å¦‚æœä½ æœ‰å…´è¶£é˜…è¯»å®ƒï¼Œä½ å¯ä»¥ä»æˆ‘çš„ Github repo ä¸­æŸ¥çœ‹

æ‰€ä»¥ï¼Œç°åœ¨æ¨¡å—å›¾çœ‹èµ·æ¥å‡†å¤‡å¥½äº†:

```
{
  "index.js": function(exports, require) {
    const { default: squareArea } = require('square.js');
    const { default: circleArea } = require('circle.js');

    console.log('Area of square: ', squareArea(5));
    console.log('Area of circle', circleArea(5));
  },
  "square.js": function(exports, require) {
    function area(side) {
      return side * side;
    }
    exports.default = area;
  },
  "circle.js": function(exports, require) {
    const PI = 3.141;
    function area(radius) {
      return PI * radius * radius;
    }
    exports.default = area;
  },
} 
```

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¯¹äº`require`è¯­å¥ï¼Œæˆ‘å°†è¯·æ±‚è·¯å¾„æ›¿æ¢ä¸ºå®é™…è§£æè·¯å¾„ï¼Œå› ä¸ºæˆ‘ä½¿ç”¨å®é™…è§£æè·¯å¾„ä½œä¸ºæ¨¡å—æ˜ å°„çš„é”®ã€‚

### [](#create-the-runtime)**åˆ›å»ºâ€œè¿è¡Œæ—¶â€**

ç°åœ¨æ˜¯æ—¶å€™åˆ›å»ºè¿è¡Œæ—¶äº†ã€‚è¿è¡Œæ—¶æ˜¯ä½œä¸ºè¾“å‡ºåŒ…ä¸€éƒ¨åˆ†çš„ä¸€æ®µä»£ç ï¼Œå®ƒåœ¨åº”ç”¨ç¨‹åºä»£ç è¿è¡Œæ—¶è¿è¡Œï¼Œå› æ­¤ä¹Ÿæ˜¯è¿è¡Œæ—¶ã€‚

è¿è¡Œæ—¶ä»£ç å¯ä»¥æ¥è‡ªæ¨¡æ¿æ–‡ä»¶ï¼Œä½†æ˜¯ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘å°†è¿è¡Œæ—¶ä»£ç ä¿å­˜ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²:

```
function bundle(graph) {
  const modules = collectModules(graph);
  const moduleMap = toModuleMap(modules);
  // highlight-next-line
  const moduleCode = addRuntime(moduleMap, modules[0].filePath);
  return [];
}
// highlight-start
function addRuntime(moduleMap, entryPoint) {
  return trim(`
    const modules = ${moduleMap};
    const entry = "${entryPoint}";
    function webpackStart({ modules, entry }) {
      const moduleCache = {};
      const require = moduleName => {
        // if in cache, return the cached version
        if (moduleCache[moduleName]) {
          return moduleCache[moduleName];
        }
        const exports = {};
        // this will prevent infinite "require" loop
        // from circular dependencies
        moduleCache[moduleName] = exports;

        // "require"-ing the module,
        // exported stuff will assigned to "exports"
        modules[moduleName](exports, require);
        return moduleCache[moduleName];
      };

      // start the program
      require(entry);
    }

    webpackStart({ modules, entry });`);
}

// trim away spaces before the line
function trim(str) {
  const lines = str.split('\n').filter(Boolean);
  const padLength = lines[0].length - lines[0].trimLeft().length;
  const regex = new RegExp(`^\\s{${padLength}}`);
  return lines.map(line => line.replace(regex, '')).join('\n');
} 
```

ä¸Šé¢çš„ä»£ç æ˜¯ä¸è¨€è‡ªæ˜çš„ï¼Œé™¤éä½ ä¸çŸ¥é“`webpackStart()`æ˜¯åšä»€ä¹ˆçš„ï¼Œä½ å¯ä»¥åœ¨[æˆ‘ä¹‹å‰çš„æ–‡ç« ](https://lihautan.com/what-is-module-bundler-and-how-does-it-work/)ä¸­è¯»åˆ°æ›´å¤šã€‚

æœ€åï¼Œæˆ‘ä»`bundle`å‡½æ•°ä¸­è¿”å›äº†æ¨¡å—ä»£ç :

```
function bundle(graph) {
  const modules = collectModules(graph);
  const moduleMap = toModuleMap(modules);
  const moduleCode = addRuntime(moduleMap, modules[0].filePath);
  // highlight-next-line
  return [{ name: 'bundle.js', content: moduleCode }];
} 
```

ç°åœ¨æˆ‘è¿è¡Œæˆ‘çš„ bundlerï¼Œå®ƒç”Ÿæˆä¸€ä¸ª`output/bundle.js`æ–‡ä»¶ã€‚æˆ‘ç”¨ node è¿è¡Œç”Ÿæˆçš„æ–‡ä»¶ï¼Œæˆ‘çœ‹åˆ°:

```
Area of square:  25
Area of circle 78.525 
```

å°±æ˜¯è¿™æ ·ï¼ä¸€ä¸ªå·¥ä½œæ¨¡å—æ†ç»‘å™¨ï¼

å½“ç„¶ï¼Œæˆ‘åœ¨è¿™é‡Œå±•ç¤ºçš„æ¨¡å—æ†ç»‘å™¨**ä¸ webpack** ç›¸å·®ç”šè¿œã€‚Webpack æ”¯æŒæ›´å¤šçš„æ¨¡å—ç³»ç»Ÿã€è§£æç­–ç•¥ã€åŠ è½½ç­–ç•¥ã€æ’ä»¶ç³»ç»Ÿã€ä¼˜åŒ–ç­‰ç­‰ã€‚

# ä¼˜åŒ–

æˆ‘æ‘†å¼„äº†ä¸€ä¸‹æˆ‘çš„æ¨¡å—æ†ç»‘å™¨ï¼Œå¾ˆå¿«å‘ç°äº†ä¸€ä¸ª bug: **å¾ªç¯ä¾èµ–**ã€‚

è¿™æ˜¯æˆ‘è°ƒæ•´è¿‡çš„è¾“å…¥æ–‡ä»¶:

```
// filename: index.js
import squareArea from './square.js';
import circleArea from './circle.js';

// highlight-next-line
export const PI = 3.141;

console.log('Area of square: ', squareArea(5));
console.log('Area of circle', circleArea(5)); 
```

```
// filename: circle.js
// highlight-start
// const PI = 3.141;
import { PI } from './index.js';
// highlight-end

function area(radius) {
  return PI * radius * radius;
}
export default area; 
```

å½“æˆ‘åœ¨æˆ‘çš„æ¨¡å— bunlder ä¸­è¿è¡Œå®ƒæ—¶ï¼Œå®ƒç«‹å³é‡åˆ°äº†å †æ ˆæº¢å‡º:

```
RangeError: Maximum call stack size exceeded 
```

## [](#circular-dependency)å¾ªç¯ä¾èµ–

ä»£ç è¿›è¡Œé€’å½’éå†æœ‰ä¸¤ä¸ªåœ°æ–¹å¯¼è‡´äº†æ— é™å¾ªç¯:

*   ç”Ÿæˆä¾èµ–å›¾
*   ç”¨äºæ†ç»‘çš„éå†æ¨¡å—å›¾

```
// fixing circular dependencies when generating module graph
// highlight-next-line
const MODULE_CACHE = new Map();

function createModule(filePath) {
 // highlight-next-line
 if (!MODULE_CACHE.has(filePath)) {
   const module = new Module(filePath);
   // highlight-next-line
   MODULE_CACHE.set(filePath, module);
   // highlight-next-line
   module.initDependencies();
 }
 // highlight-next-line
 return MODULE_CACHE.get(filePath);
}

class Module {
  ...
  // highlight-next-line
  initDependencies() {
    // highlight-next-line
    this.dependencies = this.findDependencies();
  // highlight-next-line
  }
}

// fixing circular dependencies when traversing module graph
function collectModules(graph) {
  // highlight-next-line
  const modules = new Set();
  collect(graph, modules);
  // highlight-next-line
  return Array.from(modules);

  // highlight-start
  function collect(module, modules) {
    if (!modules.has(module)) {
      modules.add(module);
      module.dependencies.forEach(dependency => collect(dependency, modules));
    }
  }
} 
```

ç”¨æœ€æ–°çš„ä»£ç æ†ç»‘ï¼Œæ ˆæº¢å‡ºå°±æ²¡äº†ã€‚ç„¶è€Œï¼Œå½“æˆ‘æ‰§è¡Œè¾“å‡ºåŒ…æ—¶ï¼Œæˆ‘çœ‹åˆ°äº†

```
$ node output/bundle.js
Area of square:  25
Area of circle NaN 
```

æ‰€ä»¥æˆ‘çœ‹äº†ä¸€ä¸‹è¾“å‡ºåŒ…:

```
{
  'index.js': function(exports, require) {
    const { default: squareArea } = require('square.js');
    // 1\. require circle.js
    const { default: circleArea } = require('circle.js');
    // 3\. define PI on exports
    exports.PI = 3.141;
    console.log('Area of square: ', squareArea(5));
    // 4\. call `circleArea`
    console.log('Area of circle', circleArea(5));
  },
  'circle.js': function(exports, require) {
    // 2\. at the point of executing this, PI is not yet defined
    const { PI: PI } = require('index.js');
    function area(radius) {
      // 5\. PI is undefined
      return PI * radius * radius;
    }
    exports.default = area;
  },
} 
```

æ‰€ä»¥ï¼Œé—®é¢˜æ˜¯æˆ‘åœ¨å®šä¹‰ä¹‹å‰ä»`index.js`çš„å¯¼å‡ºä¸­ææ„äº†`PI`ï¼Œæ‰€ä»¥è‡ªç„¶åœ°ï¼Œ`circle.js`ä¸­çš„`PI`åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ä¿æŒä¸º`undefined`ã€‚ç„¶è€Œåœ¨æˆ‘è°ƒç”¨`circleArea`ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨`index.js`çš„è¾“å‡ºä¸Šå®šä¹‰äº†`PI`ï¼Œæˆ‘å¸Œæœ›å®ƒæ˜¯å¯ç”¨çš„ã€‚

æ‰€ä»¥æˆ‘ç”¨ webpack æ„å»ºäº†æˆ‘çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ç ”ç©¶äº† webpack æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚

```
{
  'index.js': function(exports, require) {
    const square_import = require('square.js');
    // 1\. require circle.js
    const circle_import = require('circle.js');
    // 3\. define PI on exports
    exports.PI = 3.141;
    console.log('Area of square: ', square_import['default'](5));
    // 4\. call `circleArea`
    console.log('Area of circle', circle_import['default'](5));
  },
  'circle.js': function(exports, require) {
    // 2\. we keep a reference of the `index.js`'s `exports` object
    const index_import = require('index.js');
    function area(radius) {
      // 5\. we get PI from the `exports`
      return index_import['PI'] * radius * radius;
    }
    exports.default = area;
  },
} 
```

å¤ªæ£’äº†ã€‚å…³é”®æ˜¯éœ€è¦çš„æ—¶å€™æ‡’æ‡’çš„è·å–`PI`çš„å€¼ï¼

æˆ‘æ”¹å˜äº†æˆ‘çš„å·´åˆ«å¡”è½¬æ¢ä»£ç ï¼Œæˆ‘æ²¡æœ‰åœ¨è¿™é‡Œå±•ç¤ºå®ƒã€‚å¦‚æœä½ è¶³å¤Ÿå¥½å¥‡ï¼Œå¯ä»¥çœ‹çœ‹[æˆ‘ä» Github](https://github.com/tanhauhau/byo-bundler/compare/feat-2-bundling...feat-3-circular-dependency) åšçš„æ”¹åŠ¨ã€‚

# [](#summary)æ€»ç»“

æ¨¡å—æ†ç»‘åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ:**ä¾èµ–è§£æ**å’Œ**æ†ç»‘**ã€‚

æˆ‘å‘æ‚¨å±•ç¤ºäº†å¦‚ä½•é€šè¿‡æŸ¥æ‰¾å¯¼å…¥è¯­å¥å’Œè§£ææ¨¡å—æ¥æ„å»ºä¾èµ–å›¾ã€‚æˆ‘åˆ†äº«äº†æˆ‘å¦‚ä½•åœ¨**æ†ç»‘**æœŸé—´åˆ›å»ºæ¨¡å—æ˜ å°„å’Œè½¬æ¢å¯¼å…¥/å¯¼å‡ºè¯­æ³•ã€‚æœ€åï¼Œæˆ‘ä¿®å¤äº†æˆ‘çš„æ¨¡å—æ†ç»‘å™¨çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸­çš„å¾ªç¯ä¾èµ–é”™è¯¯ã€‚

### [](#whats-next)æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

æˆ‘æœ‰ä¸€äº›æƒ³æ³•è¦æ·»åŠ åˆ°æˆ‘çš„æ¨¡å—æ†ç»‘å™¨ä¸­ï¼Œä¾‹å¦‚:

*   ä»£ç æ‹†åˆ†
*   è§‚å¯Ÿæ¨¡å¼å’Œé‡æ–°åŠ è½½

å½“å®ƒä»¬å‡†å¤‡å¥½æ—¶ï¼Œæˆ‘å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»å®ƒä»¬ã€‚

åœ¨é‚£ä¹‹å‰ã€‚å¹²æ¯ã€‚ğŸ˜

# [](#further-readings)è¿›ä¸€æ­¥é˜…è¯»

*   [Ronen Amielï¼Œå»ºç«‹ä½ è‡ªå·±çš„ç½‘ç»œåŒ…â€”â€”ä½ ä¼šçˆ±ä¸Š Frontend 2018](https://www.youtube.com/watch?v=Gc9-7PBqOC8)
*   [Luciano Mamminoï¼Œè§£å¼€ JavaScript æ¨¡å— bundler-Dublin js 2018 å¹´ 7 æœˆ](https://slides.com/lucianomammino/unbundling-the-javascript-module-bundler-dublinjs)
*   [Adam Kellyï¼Œè®©æˆ‘ä»¬å­¦ä¹ æ¨¡å—æ†ç»‘å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œç„¶åè‡ªå·±å†™ä¸€ä¸ª](https://www.freecodecamp.org/news/lets-learn-how-module-bundlers-work-and-then-write-one-ourselves-b2e3fe6c88ae/)

* * *

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œå¹¶å¸Œæœ›é˜…è¯»æ›´å¤šç±»ä¼¼çš„æ–‡ç« ï¼Œè¯·åœ¨ Twitter ä¸Šå…³æ³¨æˆ‘