# ä» ELK å †æ ˆå¼€å§‹

> åŸæ–‡:[https://dev.to/oktadev/get-started-with-the-elk-stack-52p3](https://dev.to/oktadev/get-started-with-the-elk-stack-52p3)

å¥½çš„è®¾è®¡åŸåˆ™è¦æ±‚å¾®æœåŠ¡æ¶æ„æ˜¯å¯è§‚å¯Ÿçš„ï¼Œå¹¶æä¾›é›†ä¸­çš„ç›‘æ§å·¥å…·ã€‚è¯¥å·¥å…·å…è®¸å¼€å‘å›¢é˜ŸéªŒè¯æ•´ä¸ªç³»ç»Ÿçš„å¥åº·çŠ¶å†µï¼Œæ£€æŸ¥æ—¥å¿—å’Œé”™è¯¯ï¼Œå¹¶åœ¨éƒ¨ç½²åè·å¾—åé¦ˆã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯å¼¹æ€§(æˆ– ELK)å †æ ˆï¼Œä¸ºä»€ä¹ˆå®ƒæ˜¯æ»¡è¶³è¿™ä¸€éœ€æ±‚çš„ç»ä½³é€‰æ‹©ï¼Ÿ

åœ¨è¿™ç¯‡æ•™ç¨‹æ–‡ç« ä¸­ï¼Œä½ å°†å­¦ä¹ å¦‚ä½•â€¦

*   åœ¨ Docker å®¹å™¨ä¸­è®¾ç½®å¹¶è¿è¡Œ ELK å †æ ˆ
*   è®¾ç½® JHipster æ§åˆ¶å°ä»¥ç›‘æ§å¾®æœåŠ¡åŸºç¡€è®¾æ–½
*   ç”¨ JHipster åˆ›å»ºå¾®æœåŠ¡æ¶æ„
*   å¯ç”¨ JHipster æ§åˆ¶å°ç›‘æ§
*   ä¸ºå¾®æœåŠ¡é…ç½® OpenID è¿æ¥èº«ä»½éªŒè¯

## [](#the-evolution-of-the-elastic-stack)å¼¹æ€§å åŠ çš„æ¼”å˜

é¦–å­—æ¯ç¼©å†™ ELK ä»£è¡¨ *Elasticsearchã€Logstash å’Œ Kibana* ï¼Œè¿™ä¸‰ä¸ªå¼€æºé¡¹ç›®å½¢æˆäº†ä¸€ä¸ªå¼ºå¤§çš„å †æ ˆï¼Œç”¨äºæ—¥å¿—æ‘„å–å’Œå¯è§†åŒ–ã€æ—¥å¿—æœç´¢ã€äº‹ä»¶åˆ†æä»¥åŠç›‘æ§åº”ç”¨ç¨‹åºçš„æœ‰ç”¨å¯è§†åŒ–æŒ‡æ ‡ã€‚

è¿™ä¸ªå †æ ˆçš„æ ¸å¿ƒæ˜¯:ä¸€ä¸ªåŸºäº JSON çš„æœç´¢å’Œåˆ†æå¼•æ“ï¼Œæ˜¯åˆ†å¸ƒå¼çš„ï¼Œå¯æ‰©å±•çš„ã€‚å®ƒæ„å»ºåœ¨ Apache Lucene ä¹‹ä¸Šï¼Œæä¾› JSON REST APIã€é›†ç¾¤ç®¡ç†ã€é«˜å¯ç”¨æ€§å’Œå®¹é”™ã€‚

***L** ogstash* æ˜¯ä¸€ä¸ª ETL(æå–ã€è½¬æ¢ã€åŠ è½½)å·¥å…·ï¼Œç”¨æ¥ä¸°å¯Œæ–‡æ¡£ï¼Œè¿è¡Œæ•°æ®å¤„ç†ç®¡é“ã€‚è¿™äº›ç®¡é“ä»å¤šä¸ªæ¥æºæ‘„å–æ•°æ®ï¼Œè½¬æ¢å¹¶å°†å…¶å‘é€åˆ° Elasticsearchã€‚

***K** ibana* æä¾›äº†å¯è§†åŒ–å‰ç«¯ï¼Œä¸€ä¸ªè¿›å…¥å¼¹æ€§å †æ ˆçš„çª—å£ã€‚å€ŸåŠ©ä»ªè¡¨ç›˜å’Œå¯è§†åŒ–å…ƒç´ ï¼Œå¯ä»¥æ¢ç´¢ã€æ±‡æ€»å’Œåˆ†æå­˜å‚¨åœ¨ Elasticsearch ä¸­çš„æ•°æ®ã€‚

ä»ç‰ˆæœ¬ 7 å¼€å§‹ï¼ŒELK Stack æ”¹åä¸º [Elastic Stack](https://www.elastic.co/elk-stack) å¹¶åœ¨ Stack ä¸­åŠ å…¥äº† Beatsã€‚Beats æ˜¯ä¸€ä¸ªè½»é‡çº§æ•°æ®ä¼ é€å™¨å®¶æ—ï¼Œä¸ Elasticsearch å’Œ Logstash ä¸€èµ·å·¥ä½œã€‚

## [](#set-up-the-elastic-stack)è®¾ç½®å¼¹æ€§å †æ ˆ

Elastic å·²ç»å‘å¸ƒäº†ä¸€ä¸ª Docker Compose é…ç½®,æ¥æ¼”ç¤ºå•ä¸ªæœºå™¨ä¸Šçš„å †æ ˆç»„ä»¶ã€‚å®‰è£…[å¯¹æ¥å™¨](https://docs.docker.com/install/)å’Œ[å¯¹æ¥å™¨ç»„åˆ](https://docs.docker.com/compose/install/)ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å¯åŠ¨å †æ ˆ:

> Windows ç”¨æˆ·å¿…é¡»é…ç½® 2 ä¸ªç¯å¢ƒå˜é‡ï¼ŒæŸ¥çœ‹[**stack-docker**github repository](https://github.com/elastic/stack-docker)ä¸Šçš„è¯´æ˜ã€‚
> 
> å…è®¸å®¹å™¨è‡³å°‘æœ‰ 4GB çš„å†…å­˜ï¼ŒåŒæ—¶æŸ¥çœ‹æ‚¨çš„ç¯å¢ƒçš„è¯´æ˜ã€‚

*   å…‹éš†`stack-docker`å­˜å‚¨åº“

```
 git clone https://github.com/elastic/stack-docker.git 
```

*   ä½¿ç”¨ Docker Compose è®¾ç½®å †æ ˆ

```
 cd stack-docker
 docker-compose -f setup.yml up 
```

å½“è®¾ç½®å®Œæˆåï¼Œä¼šè¾“å‡º**å¼¹æ€§**ç”¨æˆ·çš„**å¯†ç **ã€‚åœ¨æ…¢é€Ÿè¿æ¥ä¸Šï¼Œè¿™å¯èƒ½éœ€è¦ 20 åˆ†é’Ÿã€‚å½“å®ƒå®Œæˆæ—¶ï¼Œæ‚¨å°†çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—:

```
 setup_1 | Setup completed successfully. To start the stack please run:
 setup_1 | docker-compose up -d
 setup_1 |
 setup_1 | If you wish to remove the setup containers please run:
 setup_1 | docker-compose -f docker-compose.yml -f docker-compose.setup.yml down --remove-orphans
 setup_1 |
 setup_1 | You will have to re-start the stack after removing setup containers.
 setup_1 |
 setup_1 | Your 'elastic' user password is: Z8GFVXu9UVsBrM6nup5fHw==
 stack-docker_setup_1 exited with code 0 
```

*   å¯åŠ¨å †æ ˆ

åœ¨å‰å°å¯åŠ¨å †æ ˆæ¥æŸ¥çœ‹å®¹å™¨æ—¥å¿—:

```
 docker-compose up 
```

å½“æ‚¨çœ‹åˆ° Kibana è®°å½•å¯¹ Beats å®¶æ—å‘é€çš„å¥åº·æ£€æŸ¥è¯·æ±‚çš„å“åº”ï¼Œå¹¶ä¸”åœ¨æ—¥å¿—ä¸­çœ‹åˆ°è‡³å°‘ä¸€ä¸ªå¿ƒè·³æ¡ç›®æ—¶ï¼Œæ‚¨å¯ä»¥å°è¯•ç™»å½•:

```
 kibana | {"type":"response","@timestamp":"2019-09-23T20:38:47Z","tags":[],"pid":1,"method":"get","statusCode":200,"req":{"url":"/login?next=%2F","method":"get","headers":{"host":"kibana:5601","user-agent":"Go-http-client/1.1","referer":"http://kibana:5601"},"remoteAddress":"172.25.0.9","userAgent":"172.25.0.9","referer":"http://kibana:5601"},"res":{"statusCode":200,"responseTime":30,"contentLength":9},"message":"GET /login?next=%2F 200 30ms - 9.0B"}
 ...
 heartbeat | 2019-09-23T20:38:52.213Z   INFO    [monitoring]    log/log.go:144  Non-zero metrics in the last 30s    {"monitoring": {"metrics": {"beat":{"cpu":{"system":{"ticks":160,"time":{"ms":50}},"total":{"ticks":430,"time":{"ms":120},"value":430},"user":{"ticks":270,"time":{"ms":70}}},"handles":{"limit":{"hard":1048576,"soft":1048576},"open":9},"info":{"ephemeral_id":"d8d4f6a2-39fa-41cb-9e9c-520438d49a9e","uptime":{"ms":93132}},"memstats":{"gc_next":4194304,"memory_alloc":3365792,"memory_total":12191384,"rss":327680}},"libbeat":{"config":{"module":{"running":0}},"output":{"events":{"acked":24,"batches":6,"total":24},"read":{"bytes":5970},"write":{"bytes":16878}},"pipeline":{"clients":4,"events":{"active":0,"published":24,"total":24},"queue":{"acked":24}}},"system":{"load":{"1":4.83,"15":2.43,"5":3.44,"norm":{"1":1.2075,"15":0.6075,"5":0.86}}}}}} 
```

> æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°æ—¥å¿—è¾“å‡ºä¸­çš„å¼‚å¸¸ã€‚å¯¹äºæœ¬æ¼”ç¤ºï¼Œå¯ä»¥å®‰å…¨åœ°å¿½ç•¥å®ƒä»¬ã€‚å¦‚æœä½ åœ¨ docker ä¸Šé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œä½ å¯ä»¥é‡æ–°å¼€å§‹:
> 
> ```
> docker container ls -a | cut -c1-12 | xargs docker container rm --force
> docker images | cut -c69-80 | xargs docker rmi
> docker system prune -a 
> ```
> 
> **æ³¨æ„:**è¿™ä¼šç ´åæ‰€æœ‰ docker å®¹å™¨ã€å›¾åƒå’Œç½‘ç»œï¼Œæ‰€ä»¥ä½¿ç”¨é£é™©è‡ªæ‹…ã€‚

*   å‰å¾€ [http://localhost:5601](http://localhost:5601/) ç™»å½• Kibanaã€‚

ç™»å½•å(ä½¿ç”¨ä¸Šé¢æ•è·çš„ **elastic** ç”¨æˆ·å’Œå¯†ç ),é€šè¿‡å·¦ä¾§çš„èœå•ä»ä»ªè¡¨æ¿éƒ¨åˆ†æµè§ˆå·²å®‰è£…çš„ä»ªè¡¨æ¿ã€‚Heartbeat æ˜¯ beat æœåŠ¡ä¹‹ä¸€ï¼Œå®ƒä»æä¾›çš„ URL åˆ—è¡¨ä¸­ç›‘æ§æ‚¨çš„æœåŠ¡çš„æ­£å¸¸è¿è¡Œæ—¶é—´ã€‚æ‰“å¼€ä»ªè¡¨æ¿ *Heartbeat HTTP monitoring* ï¼ŒæŸ¥çœ‹æ•°æ®å¯è§†åŒ–å †æ ˆçš„å¼ºå¤§åŠŸèƒ½ã€‚

[![Heartbeat HTTP Monitoring](img/0066b9f33cecaa4d381375aa58a7b5aa.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--AhTaM7Z---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://d33wubrfki0l68.cloudfront.net/72ead612a4bddcce64c6d7d1e4732572362733f0/dff94/assets-jekyll/blog/getting-started-with-elk/http-heartbeat-035b09e1def6d90ce65a7547cb58a481e05e8693ea8275d20eefa41d1800f786.png)

## JHipster æ§åˆ¶å°

Jhipster æ§åˆ¶å°æ˜¯ä¸€ä¸ªåŸºäºå¼¹æ€§å †æ ˆçš„å‡ºè‰²ç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œå®ƒå…è®¸éšæ—¶å¯è§†åŒ–å’Œåˆ†æ JHipster åº”ç”¨ç¨‹åºæŒ‡æ ‡ã€‚æ§åˆ¶å°æä¾›é¢„é…ç½®çš„ä»ªè¡¨ç›˜æ¥ç›‘æ§å¾®æœåŠ¡åŸºç¡€æ¶æ„ã€‚æ‚¨å¯ä»¥åœ¨[j ipster æ§åˆ¶å°çš„æ–‡æ¡£](https://www.jhipster.tech/monitoring/#jhipster-console)ä¸­æŸ¥çœ‹å®Œæ•´çš„åŠŸèƒ½åˆ—è¡¨ã€‚

ä» JHipster æ§åˆ¶å°å¼€å§‹çš„ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•æ˜¯éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œå¹¶ä½¿ç”¨ [docker-compose å­ç”Ÿæˆå™¨](https://www.jhipster.tech/docker-compose/)å¯ç”¨ç›‘æ§ã€‚æ‚¨å°†ä½¿ç”¨å®ƒæ¥:

*   ç”¨ JHipster åˆ›å»ºå¾®æœåŠ¡æ¶æ„
*   å¯ç”¨ JHipster æ§åˆ¶å°ç›‘æ§
*   é…ç½® OpenID Connect ä»¥å¯¹å¾®æœåŠ¡è¿›è¡Œèº«ä»½éªŒè¯

## [](#create-a-java-microservices-architecture-with-jhipster)ç”¨ JHipster æ‰“é€  Java å¾®æœåŠ¡æ¶æ„

> è¦å®‰è£…å¯ä»¥åœ¨è¿™é‡Œå·¥ä½œçš„ JHipster ç‰ˆæœ¬ï¼Œæ‚¨éœ€è¦å®‰è£… [Node.js](https://nodejs.org/) ã€‚

### [](#install-jhipster)å®‰è£… JHipster

```
npm install -g generator-jhipster@6.3.1
jhipster --version 
```

version å‘½ä»¤åº”è¯¥è¾“å‡ºç±»ä¼¼è¿™æ ·çš„å†…å®¹:

```
INFO! Using JHipster version installed globally
6.3.1 
```

ä¸ºé¡¹ç›®åˆ›å»ºä¸€ä¸ªç›®å½•:

```
mkdir jhipster
cd jhipster 
```

ç”¨ JHipster é¢†åŸŸè¯­è¨€(JDL)åˆ›å»º`apps.jh`æ¥å®šä¹‰å•†åº—ã€åšå®¢å’Œç½‘å…³å¾®æœåŠ¡ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†é‡æ–°åˆ›å»ºåœ¨ä¹‹å‰æ„å»ºçš„åŸºäº Java çš„å¾®æœåŠ¡æ¶æ„ç¤ºä¾‹[ã€‚](https://developer.okta.com/blog/2019/05/23/java-microservices-spring-cloud-config) 

```
application  {  config  {  baseName  gateway,  packageName  com.okta.developer.gateway,  applicationType  gateway,  authenticationType  oauth2,  prodDatabaseType  postgresql,  serviceDiscoveryType  eureka,  testFrameworks  [protractor]  }  entities  Blog,  Post,  Tag,  Product  }  application  {  config  {  baseName  blog,  packageName  com.okta.developer.blog,  applicationType  microservice,  authenticationType  oauth2,  prodDatabaseType  postgresql,  serverPort  8081,  serviceDiscoveryType  eureka  }  entities  Blog,  Post,  Tag  }  application  {  config  {  baseName  store,  packageName  com.okta.developer.store,  applicationType  microservice,  authenticationType  oauth2,  databaseType  mongodb,  devDatabaseType  mongodb,  prodDatabaseType  mongodb,  enableHibernateCache  false,  serverPort  8082,  serviceDiscoveryType  eureka  }  entities  Product  }  entity  Blog  {  name  String  required  minlength(3),  handle  String  required  minlength(2)  }  entity  Post  {  title  String  required,  content  TextBlob  required,  date  Instant  required  }  entity  Tag  {  name  String  required  minlength(2)  }  entity  Product  {  title  String  required,  price  BigDecimal  required  min(0),  image  ImageBlob  }  relationship  ManyToOne  {  Blog{user(login)}  to  User,  Post{blog(name)}  to  Blog  }  relationship  ManyToMany  {  Post{tag(name)}  to  Tag{post}  }  paginate  Post,  Tag  with  infinite-scroll  paginate  Product  with  pagination  microservice  Product  with  store  microservice  Blog,  Post,  Tag  with  blog 
```

ç°åœ¨ï¼Œåœ¨ä½ çš„`jhipster`æ–‡ä»¶å¤¹ä¸­ï¼Œè¿è¡Œ [**import-jdl** ç”Ÿæˆå™¨](https://www.jhipster.tech/jdl/#importingjdl)ã€‚

```
jhipster import-jdl apps.jh 
```

### [](#deploy-monitoring-using-raw-dockercompose-endraw-)éƒ¨ç½²ç›‘æ§ä½¿ç”¨`docker-compose`

åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼Œä¸º`docker-compose`é…ç½®åˆ›å»ºä¸€ä¸ªå­æ–‡ä»¶å¤¹ï¼Œå¹¶è¿è¡Œå­ç”Ÿæˆå™¨ã€‚

```
mkdir docker-compose
cd docker-compose
jhipster docker-compose 
```

ç”Ÿæˆå™¨å°†è¦æ±‚æ‚¨å®šä¹‰ä»¥ä¸‹é…ç½®:

1.  åº”ç”¨ç±»å‹:**å¾®æœåŠ¡åº”ç”¨**
2.  ç½‘å…³ç±»å‹:**åŸºäº Zuul çš„ j ipster**
3.  åŒ…æ‹¬å“ªäº›åº”ç”¨:**åšå®¢**ã€**ç½‘å…³**ã€**å•†åº—**
4.  å¦‚æœæ•°æ®åº“æ˜¯é›†ç¾¤åŒ–çš„:**å¦**
5.  å¦‚æœå¿…é¡»å¯ç”¨ç›‘æ§:**æ˜¯ï¼Œä½¿ç”¨ JHipster æ§åˆ¶å°**
6.  ç”¨äºç›‘æ§çš„é™„åŠ æŠ€æœ¯: **Zipkin**
7.  JHipster æ³¨å†Œè¡¨çš„å¯†ç :**é»˜è®¤ä¸º**

[![asciicast](img/efcc096593e4dcc9fea1445cc0495582.png)T2ã€‘](https://asciinema.org/a/261254)

å½“ç”Ÿæˆå™¨å‡ ä¹å®Œæˆæ—¶ï¼Œè¾“å‡ºä¸­æ˜¾ç¤ºä¸€æ¡è­¦å‘Š:

```
WARNING! Docker Compose configuration generated, but no Jib cache found
If you forgot to generate the Docker image for this application, please run:
To generate the missing Docker image(s), please run:
  ./mvnw package -Pprod verify jib:dockerBuild in /home/indiepopart/jhipster/blog
  ./mvnw package -Pprod verify jib:dockerBuild in /home/indiepopart/jhipster/gateway
  ./mvnw package -Pprod verify jib:dockerBuild in /home/indiepopart/jhipster/store 
```

æ‚¨å¯ä»¥æŒ‰ç…§ä¸Šé¢çš„è¯´æ˜åˆ›å»ºå¾®æœåŠ¡æ˜ åƒï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªèšåˆå™¨`pom.xml`å¹¶ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤æ¥æ„å»ºæ‰€æœ‰æ˜ åƒï¼Œå¦‚æˆ‘ä»¬åœ¨ Java å¾®æœåŠ¡ä¸Šçš„å¸–å­[ä¸­æ‰€è¿°ã€‚](https://developer.okta.com/blog/2019/05/23/java-microservices-spring-cloud-config)

### [](#setup-okta-openid-connect-oidc-authentication-for-your-microservices)ä¸ºæ‚¨çš„å¾®æœåŠ¡è®¾ç½® Okta OpenID Connect (OIDC)è®¤è¯

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¾®æœåŠ¡æ¶æ„æ ¹æ® Keycloak è¿›è¡Œèº«ä»½éªŒè¯ã€‚æ›´æ–°è®¾ç½®ä»¥ä½¿ç”¨ [Okta](https://developer.okta.com) ä½œä¸ºè®¤è¯æä¾›è€…:

é¦–å…ˆå» Okta åŠä¸€ä¸ª[å…è´¹å¼€å‘è€…è´¦å·](https://developer.okta.com/signup/)ã€‚

ä¸€æ—¦ä½ ç™»å½•ï¼Œç‚¹å‡»**ä½ çš„ç»„ç»‡**ï¼Œå®ƒå°†å¸¦ä½ åˆ°**å¼€å‘è€…æ§åˆ¶å°**ã€‚è½¬åˆ°**åº”ç”¨ç¨‹åº**éƒ¨åˆ†ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„ **Web åº”ç”¨ç¨‹åº**ã€‚è®¾ç½®ä»¥ä¸‹èº«ä»½éªŒè¯è®¾ç½®:

*   åç§°:ä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºå‘½å
*   åŸºåœ° URIs: `http://localhost:8761`å’Œ`http://localhost:8080`
*   ç™»å½•é‡å®šå‘ URIs: `http://localhost:8080/login/oauth2/code/oidc`å’Œ`http://localhost:8761/login/oauth2/code/oidc`
*   å…è®¸çš„æˆæƒç±»å‹:æˆæƒç å’Œåˆ·æ–°ä»¤ç‰Œ

> ä¸ºç®€å•èµ·è§ï¼Œæœ¬æ•™ç¨‹ä»…åˆ›å»º Web Appï¼Œå…¶å‡­è¯å°†ç”¨äºæ‰€æœ‰æœåŠ¡ã€‚åœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œæ¯ä¸ªæœåŠ¡å¿…é¡»ç”¨è‡ªå·±çš„å‡­è¯æ¥æ ‡è¯†è‡ªå·±ï¼Œæ‚¨åº”è¯¥åœ¨ Okta æ§åˆ¶å°ä¸­ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºæˆ–æœåŠ¡ã€‚

å¤åˆ¶**å®¢æˆ·ç«¯ ID** å’Œ**å®¢æˆ·ç«¯ç§˜å¯†**ï¼Œå› ä¸ºæˆ‘ä»¬å°†åœ¨åº”ç”¨ç¨‹åºçš„è®¾ç½®ä¸­ä½¿ç”¨å®ƒã€‚åœ¨ Okta ä»ªè¡¨ç›˜çš„å³ä¸Šè§’æ‰¾åˆ°**ç»„ç»‡çš„ç½‘å€**ã€‚

ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»ºä¸€ä¸ª`docker-compose/.env`æ–‡ä»¶:

```
OIDC_CLIENT_ID=<client_id>
OIDC_CLIENT_SECRET=<client_secret>
RESOURCE_ISSUER_URI=<org_url>/oauth2/default 
```

ç¼–è¾‘`docker-compose/docker-compose.yml`å¹¶æ›´æ–°`blog-app`ã€`gateway-app`å’Œ`store-app` :
æœåŠ¡çš„`SECURITY_*`è®¾ç½®

```
SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI=${RESOURCE_ISSUER_URI}
SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET} 
```

å¿…é¡»ä¸º JHipster æ³¨å†Œä¸­å¿ƒè®¾ç½®ç›¸åŒçš„èº«ä»½éªŒè¯ã€‚ç¼–è¾‘`docker-compose/jhipster-registry.yml`å¹¶è®¾ç½®ä¸`gateway-app`çš„ç¯å¢ƒéƒ¨åˆ†ç›¸åŒçš„å€¼ã€‚

JHipster åº”ç”¨ç¨‹åºéœ€è¦ ID ä»¤ç‰Œä¸­å£°æ˜çš„ç‰¹å®šç”¨æˆ·è§’è‰²`ROLE_USER`å’Œ`ROLE_ADMIN`ã€‚åœ¨ Okta å¼€å‘è€…æ§åˆ¶å°ä¸­ï¼Œè½¬åˆ°**ç”¨æˆ·** > **ç»„**å¹¶ä¸ºæ¯ä¸ª JHipster è§’è‰²åˆ›å»ºä¸€ä¸ªç»„ï¼Œå¹¶å°†ç”¨æˆ·æ·»åŠ åˆ°æ¯ä¸ªç»„ä¸­ã€‚

ç°åœ¨è½¬åˆ° **API** > **æˆæƒæœåŠ¡å™¨**ï¼Œé€‰æ‹©**é»˜è®¤**æœåŠ¡å™¨å’Œ**æ·»åŠ å£°æ˜**ï¼Œè®¾ç½®å¦‚ä¸‹:

1.  åç§°:ç»„
2.  åŒ…æ‹¬åœ¨ä»¤ç‰Œç±»å‹ä¸­:ID ä»¤ç‰Œï¼Œå§‹ç»ˆ
3.  å€¼ç±»å‹:ç»„
4.  è¿‡æ»¤å™¨:åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ï¼Œå°†æ­£åˆ™è¡¨è¾¾å¼è®¾ç½®ä¸º`.*`

### [](#enable-debug-logs-and-zipkin)å¯ç”¨è°ƒè¯•æ—¥å¿—å’Œ Zipkin

è¦å°†è°ƒè¯•æ—¥å¿—å‘é€åˆ° JHipster æ§åˆ¶å°ï¼Œè®©æˆ‘ä»¬æ›´æ–° prod é…ç½®æ–‡ä»¶ä¸­çš„æ—¥å¿—çº§åˆ«ã€‚ç¼–è¾‘`src/main/resources/config/application-prod.yml`å°†`com.okta.developer.*`è®°å½•å™¨çš„æ¯ä¸ªæœåŠ¡(`blog-app`ã€`store-app`å’Œ`gateway-app`)çš„çº§åˆ«è®¾ç½®ä¸º**è°ƒè¯•**ã€‚ä¾‹å¦‚ï¼Œåœ¨åšå®¢çš„`application-prod.yml` :

```
logging:
    level:
        com.okta.developer.blog: DEBUG 
```

æ­¤å¤–ï¼Œå¯¹äºæ¯ä¸ªæœåŠ¡ï¼Œæ›´æ–°`LoggingAspectConfiguration`ä»¥åœ¨ prod æ¦‚è¦æ–‡ä»¶æ¿€æ´»æ—¶åŠ è½½ã€‚æ›´æ”¹`@Profile`æ³¨é‡Š:

```
@Configuration
@EnableAspectJAutoProxy
public class LoggingAspectConfiguration {

    @Bean
    @Profile({JHipsterConstants.SPRING_PROFILE_DEVELOPMENT, JHipsterConstants.SPRING_PROFILE_PRODUCTION})
    public LoggingAspect loggingAspect(Environment env) {
        return new LoggingAspect(env);
    }
} 
```

Zipkin æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œæœ‰åŠ©äºè§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ã€‚éšç€ traceId ä»ä¸€ä¸ªæœåŠ¡ä¼ æ’­åˆ°å¦ä¸€ä¸ªæœåŠ¡ï¼Œå¯¹ä¸åŒæœåŠ¡çš„è°ƒç”¨å¯ä»¥ä½œä¸ºåŒä¸€ä¸ªæµçš„ä¸€éƒ¨åˆ†è¿›è¡Œå…³è”å’Œåˆ†æã€‚Zipkin æœåŠ¡å™¨å’Œ UI éš JHipster æ§åˆ¶å°æä¾›ï¼ŒJHipster åº”ç”¨å¯ä»¥é€šè¿‡ [Spring Cloud Sleuth](https://cloud.spring.io/spring-cloud-sleuth/reference/html/#sleuth-with-zipkin-via-http) ä¸ Zipkin é›†æˆã€‚è¦å¯ç”¨ Zipkin è·Ÿè¸ªï¼Œå°†`zipkin`é…ç½®æ–‡ä»¶æ·»åŠ åˆ°`docker-compose/docker-compose.yml`ä¸­çš„`blog-app`ã€`gateway-app`å’Œ`store-app`ã€‚

```
- SPRING_PROFILES_ACTIVE=prod,swagger,zipkin 
```

æ‚¨è¿˜éœ€è¦ä½¿ç”¨ä»¥ä¸‹ Maven å‘½ä»¤ä¸º`blog-app`ã€`store-app`å’Œ`gateway-app`é‡å»ºå¸¦æœ‰`zipkin`æ¦‚è¦æ–‡ä»¶çš„ Docker æ˜ åƒ:

```
./mvnw package -Pprod -Pzipkin verify jib:dockerBuild -DskipTests 
```

> ProTip:å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ bash shell ç³»ç»Ÿï¼Œæ¯”å¦‚ Linux æˆ– MacOsï¼Œæ‚¨å¯ä»¥ä»`jhipster`æ–‡ä»¶å¤¹ä¸­ä¸€æ¬¡æ„å»ºæ¯ä¸ªé¡¹ç›®:
> 
> ```
> for i in blog gateway store
> do 
> cd $i 
> ./mvnw package -Pprod -Pzipkin verify jib:dockerBuild -DskipTests
> cd ..
> done 
> ```

### [](#run-the-monitored-microservices-architecture)è¿è¡Œè¢«ç›‘æ§çš„å¾®æœåŠ¡æ¶æ„

ä½ å‡†å¤‡å¥½äº†å—ï¼Ÿè½¬åˆ°`docker-compose`æ–‡ä»¶å¤¹ï¼Œç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨æœåŠ¡:

```
docker-compose up 
```

åœ¨æ¯ä¸ªæœåŠ¡å¯åŠ¨æ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°å¤§é‡çš„æ—¥å¿—è®°å½•ã€‚

```
jhipster-registry_1 | ----------------------------------------------------------
jhipster-registry_1 | Application 'jhipster-registry' is running! Access URLs:
jhipster-registry_1 | Local: http://localhost:8761
jhipster-registry_1 | External: http://172.20.0.2:8761
jhipster-registry_1 | Profile(s): [composite, dev, swagger, oauth2]
jhipster-registry_1 | ---------------------------------------------------------- 
```

ä½¿ç”¨ Okta ç”¨æˆ·å‡­è¯åœ¨`http://localhost:8761`ç™»å½• JHipster æ³¨å†Œä¸­å¿ƒï¼Œå¹¶æ£€æŸ¥æœåŠ¡çš„å¥åº·çŠ¶å†µã€‚

[![JHipster Registry](img/b3d66ab6343e7d5c1f353409b8ea5960.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ZMtcuIq2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://d33wubrfki0l68.cloudfront.net/342b9f032ef0e3b986eea8f216af7e6517271ebf/9b9e3/assets-jekyll/blog/getting-started-with-elk/registry-7ee3d98030a1808568ec18b06931d2348140cda7be6add80664a02219310dbe9.png)

ä¸€æ—¦æ‰€æœ‰æœåŠ¡éƒ½å¯åŠ¨äº†ï¼Œç™»å½•åˆ°ç½‘å…³åº”ç”¨ç¨‹åºï¼Œåˆ›å»ºä¸€äº›åšå®¢å’Œå¸–å­æ¥äº§ç”Ÿæµé‡ã€‚ä¸ºæ­¤ï¼Œä½¿ç”¨åº”ç”¨ç¨‹åºå·¦ä¸Šè§’çš„**å®ä½“**èœå•ã€‚å›å®¶çš„é€šé“åœ¨`http://localhost:8080`ã€‚

æœ‰è¶£çš„éƒ¨åˆ†ï¼åœ¨`http://localhost:5601`è®¿é—® JHipster æ§åˆ¶å°ã€‚è½¬åˆ°ä»ªè¡¨æ¿éƒ¨åˆ†ï¼Œæ‰“å¼€**è¯·æ±‚-ä»ªè¡¨æ¿**ã€‚æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€äº›æ¼‚äº®çš„æ›²çº¿:

[![Requests Dashboard](img/82be2e22296b5de8c28cda165b3d7d81.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--lkvictcb--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://d33wubrfki0l68.cloudfront.net/90d48fa35b1a90465fdc7931d8ddc49e422e0820/84f1c/assets-jekyll/blog/getting-started-with-elk/requests-dashboard-149c81b627dceb51460dacc9f02ead1dfd5fed0b7d2ae279192a0d73bd2bae62.png)

å› ä¸ºæ‚¨å°† JHipster æ§åˆ¶å°ä¸ Zipkin UI é›†æˆåœ¨ä¸€èµ·ï¼Œæ‰€ä»¥åœ¨ traces-dashboard ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨å·¦ä¾§æ‰¾åˆ°æœ€é•¿çš„è·Ÿè¸ªæŒç»­æ—¶é—´ã€‚å¦‚æœæ‚¨å•å‡»å³è¾¹çš„ traceIdï¼Œå®ƒå°†åœ¨ UI ä¸­æ‰“å¼€è·Ÿè¸ªï¼Œæ‚¨å°†èƒ½å¤Ÿæ£€æŸ¥æµã€‚

[![zipkin ui](img/9ef8be8b69e0fae93d7e1b9be16daee3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--j2zzkU4G--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://d33wubrfki0l68.cloudfront.net/9b4580fa95d1aa3f39c55f4b4682adda17e6e9ae/4ead5/assets-jekyll/blog/getting-started-with-elk/zipkin-ui-ff18b2fb146f66da5f8265a42da16f6e2bd0f8853a66e93823b863fc6a6054ba.png)

## [](#learn-more-about-jhipster-and-elastic-stack)äº†è§£ JHipster å’Œ Elastic Stack çš„æ›´å¤šä¿¡æ¯

æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ•™ç¨‹ï¼Œä»¥åŠç”¨äºç›‘æ§å¾®æœåŠ¡æ¶æ„çš„**å¼¹æ€§å †æ ˆ**å’Œ **JHipster æ§åˆ¶å°**çš„å¼ºå¤§åŠŸèƒ½ã€‚è¦ç»§ç»­æ‰©å±•æ‚¨åœ¨ JHipster ç›‘æ§å’Œ Okta ä¸ Elastic Stack é›†æˆæ–¹é¢çš„çŸ¥è¯†ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é“¾æ¥:

*   [Github ä¸Šçš„ JHipster æ§åˆ¶å°](https://github.com/jhipster/jhipster-console)
*   [j ipster ç›‘æ§æ–‡æ¡£](https://www.jhipster.tech/monitoring/)
*   [SAML è®¤è¯å’Œå¼¹æ€§å †æ ˆ](https://www.elastic.co/blog/how-to-enable-saml-authentication-in-kibana-and-elasticsearch)
*   [åŸºå·´çº³è®¤è¯](https://www.elastic.co/guide/en/kibana/current/kibana-authentication.html)

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œä½ å¯èƒ½ä¼šå–œæ¬¢æˆ‘ä»¬å…³äº JHipster å’Œå¾®æœåŠ¡çš„å…¶ä»–æ–‡ç« :

*   [æ›´å¥½ã€æ›´å¿«ã€æ›´è½»ä¾¿çš„ Java ä¸ Java 12 å’Œ JHipster 6](https://developer.okta.com/blog/2019/04/04/java-11-java-12-jhipster-oidc)
*   é€šè¿‡å‡çº§ Spring å®‰å…¨ OAuth å’Œ JUnit æµ‹è¯•ğŸ‘€ä¸€ä¸ª Java æ½®äººçš„
*   [Java å¾®æœåŠ¡ä¸ Spring Boot å’Œæ˜¥äº‘](https://developer.okta.com/blog/2019/05/22/java-microservices-spring-boot-spring-cloud)
*   [é‡‡ç”¨ Spring Cloud Config å’Œ JHipster çš„ Java å¾®æœåŠ¡](https://developer.okta.com/blog/2019/05/23/java-microservices-spring-cloud-config)
*   [é€šè¿‡ Spring Cloud Gateway ä¿æŠ¤ååº”å¼å¾®æœåŠ¡](https://developer.okta.com/blog/2019/08/28/reactive-microservices-spring-cloud-gateway)

ä¸ºäº†åœ¨æˆ‘ä»¬å‘å¸ƒæ–°å¸–å­æ—¶å¾—åˆ°é€šçŸ¥ï¼Œ[åœ¨ Twitter ä¸Šå…³æ³¨@ okta dev](https://twitter.com/oktadev)ã€‚æˆ‘ä»¬è¿˜å®šæœŸå‘[æˆ‘ä»¬çš„ YouTube é¢‘é“](https://www.youtube.com/c/oktadev)å‘å¸ƒæˆªå±ã€‚

[![](img/1a38deab57210dc8201f9f282c5c0bee.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qX0f-pbv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/http://feeds.feedburner.com/%257Er/OktaDeveloperBlog/%257E4/s86SIvj5TeE)