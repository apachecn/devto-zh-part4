# æ·±å…¥æ¢è®¨ç”¨ Webpack æ›¿æ¢çƒ­æ¨¡å—(ç¬¬äºŒéƒ¨åˆ†â€”â€”å¤„ç†æ›´æ–°)

> åŸæ–‡ï¼š<https://dev.to/stanimiravlaeva/a-deep-dive-into-hot-module-replacement-with-webpack-part-two-handling-updates-3c1f>

æœ¬æ–‡æ˜¯å…³äºä½¿ç”¨ [webpack](https://webpack.js.org/) è¿›è¡Œçƒ­æ¨¡å—æ›´æ¢çš„â€œæ·±å…¥æ¢è®¨â€ç³»åˆ—çš„ç¬¬äºŒéƒ¨åˆ†ã€‚

*   ç¬¬ä¸€éƒ¨åˆ†:[åŸºç¡€çŸ¥è¯†](https://dev.to/stanimiravlaeva/a-deep-dive-into-hot-module-replacement-with-webpack-part-one-the-basics-39hn)
*   ç¬¬ 2 éƒ¨åˆ†:ä½¿ç”¨ module.hot API å¤„ç†çƒ­æ›´æ–°

# ç¬¬ 2 éƒ¨åˆ†:ç”¨ module.hot API å¤„ç†çƒ­æ›´æ–°

åœ¨ HMR ç³»åˆ—çš„ç¬¬ä¸€ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†*çƒ­æ¨¡å—æ›´æ¢*è¿‡ç¨‹çš„å››ä¸ªé˜¶æ®µã€‚

[![Hot Module Replacement process](img/62a2008bf69c1c0bd6a56e7182986a23.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--dGLKc9AW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/j27uvbdlva5xt0eqg0sn.png)

ä»Šå¤©ï¼Œæˆ‘ä»¬å°†å…³æ³¨æœ€åä¸€ä¸ªé˜¶æ®µã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•æŒ‡ç¤ºåº”ç”¨ç¨‹åºä¸­çš„æ¨¡å—åœ¨æ”¶åˆ°çƒ­æ›´æ–°æ—¶è¿›è¡Œè‡ªæˆ‘åˆ·æ–°ã€‚

*çƒ­æ›´æ–°å¤„ç†ç¨‹åº*æ—¢å¯ä»¥åœ¨æ„å»ºæœŸé—´ç”± webpack åŠ è½½å™¨æ³¨å…¥ï¼Œä¹Ÿå¯ä»¥ç”±æ‚¨æ‰‹åŠ¨æ·»åŠ ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†åªè®¨è®ºç¬¬äºŒç§æ–¹æ³•ã€‚Webpack å…¬å¼€äº†ä¸€ä¸ªæ¥è‡ª`module.hot`å¯¹è±¡çš„å…¬å…±æ¥å£ã€‚è®©æˆ‘ä»¬æ¥æ¢ç´¢ä¸€ä¸‹å§ï¼

# æ¨¡å—.çƒ­ API

å¯¹äºæˆ‘ä»¬çš„æ¼”ç¤ºï¼Œæˆ‘ä»¬å°†ä¿®è¡¥ä¸€ä¸ªç®€å•çš„ç½‘é¡µã€‚å¦‚æœä½ å…‹éš†äº†è¿™ä¸ªé¡¹ç›®å¹¶æŒ‰ç…§è¯´æ˜å»åšæ˜¯æœ€å¥½çš„ï¼Œä½†è¿™ä¸æ˜¯å¼ºåˆ¶æ€§çš„ã€‚ä½ ä¹Ÿå¯ä»¥çœ‹çœ‹åšå®¢ï¼Œç›¸ä¿¡æˆ‘ä¸€åˆ‡æ­£å¸¸ã€‚

ä»[https://github.com/sis0k0/christmas-tree](https://github.com/sis0k0/christmas-tree)å…‹éš†å­˜å‚¨åº“ã€‚å¦‚æœä½ æ˜¯å‘½ä»¤è¡Œç•Œé¢çš„ç²‰ä¸ï¼Œæ‰§è¡Œ:

```
git clone https://github.com/sis0k0/christmas-tree.git 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¼èˆªåˆ°å…‹éš†çš„æ–‡ä»¶å¤¹å¹¶å®‰è£…ä¾èµ–é¡¹:

```
cd christmas-tree
npm install 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦è¿è¡Œå¼€å‘æœåŠ¡å™¨ï¼Œè¯·æ‰§è¡Œ:

```
npm run watch 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ„å»ºå®Œæˆåï¼Œæµè§ˆå™¨ä¸­å°†ä¼šæ‰“å¼€ä¸€ä¸ªæ–°çš„é€‰é¡¹å¡ã€‚åˆ‡æ¢ devtools æ§åˆ¶å°ã€‚

[![Devtools: Hot Module Replacement enabled](img/51ee1bbbaa7546e0fc2c485c8d250f46.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--1csUiFcc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/i18g1nxgwnmd6pljdiy0.gif)

åœ£è¯å¿«ä¹ï¼æ˜¯çš„ï¼Œæˆ‘çŸ¥é“ç°åœ¨æ˜¯ä¹æœˆã€‚ä½†æ˜¯å†¬å¤©æ¥äº†ã€‚

æˆ‘å¸Œæœ›å¤§å®¶æ³¨æ„ä¸¤ä»¶äº‹:

1.  `npm run watch`å¯åŠ¨ç”± webpack-dev-server åŒ…æä¾›çš„ webpack å¼€å‘æœåŠ¡å™¨ã€‚
2.  æ§åˆ¶å°æ˜¾ç¤º*çƒ­æ¨¡å—æ›´æ¢*å·²å¯ç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¸æ˜¯ã€‚è¿™ä¸ªé¡¹ç›®æ˜¯*é…ç½®*ä¸ HMR ä¸€èµ·è¿è¡Œã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­äº†è§£å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚

# é¡¹ç›®é‡Œæœ‰ä»€ä¹ˆï¼Ÿ

ä¸‹å›¾æ˜¾ç¤ºäº†é¡¹ç›®ç»“æ„(ä¸åŒ…æ‹¬`node_modules`):

[![Project structure](img/3f55151cedbfc23b63f629785ee245b3.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--8hweM3fp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/wmbg4sfstxw1f5frh39c.png)

`source`ç›®å½•æ˜¯æˆ‘ä»¬å°†è¦è¿›è¡Œæ›´æ”¹çš„åœ°æ–¹:

*   `index.js`å¯¼å…¥æ‰€æœ‰æºæ–‡ä»¶ã€‚é‚£æ˜¯ webpack çš„*å…¥å£*æ¨¡å—ï¼›
*   ä¸ºåœ£è¯æ ‘åˆ›é€ é—ªçƒæ•ˆæœï¼›
*   ç»˜åˆ¶æ ‘æœ¬èº«ã€‚

`dist`ç›®å½•æ‰˜ç®¡å‡†å¤‡è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚

*   `main.js`æ˜¯å•è¾“å‡º*åŒ…*ï¼Œç”± webpack ç”Ÿäº§ï¼›
*   `index.html`æ˜¯åŠ è½½ main.js çš„ç½‘é¡µã€‚

æœ¬å¸–ä¸è®¨è®º`package.json`å’Œ`package-lock.json`ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œè¯·æŸ¥çœ‹ [npm æ–‡æ¡£](https://docs.npmjs.com/files/package.json)ã€‚

æœ€åï¼Œ`webpack.config.js` -æˆ‘ä»¬æŒ‡å¯¼ webpack å¦‚ä½•*æ†ç»‘*æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„åœ°æ–¹ã€‚åº”ç”¨ç¨‹åºä½¿ç”¨ *HMR* è¿è¡Œï¼Œå› ä¸º*çƒ­æ¨¡å—æ›¿æ¢*æ’ä»¶æ˜¯é…ç½®
çš„ä¸€éƒ¨åˆ†

```
const path = require('path');
const webpack = require('webpack');

module.exports = (env, argv) => {
    const config = {
        entry: './src/index.js',
        output: {
            filename: 'main.js',
            path: path.resolve(__dirname, 'dist')
        },
        devServer: {
            contentBase: './dist',
            hot: true,
        },
        plugins: [],
    };

    if (argv.mode === 'development') {
        config.plugins.push(
            new webpack.HotModuleReplacementPlugin()
        );
    }

    return config;
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# è‡ªæ¥å—æ¨¡å—

ç†è®ºå¤Ÿäº†ï¼Œè®©æˆ‘ä»¬å›åˆ°æµè§ˆå™¨ã€‚devtools æ§åˆ¶å°æ˜¾ç¤º*çƒ­æ¨¡å—æ›¿æ¢*æ­£åœ¨è¿è¡Œã€‚ä½†æ˜¯çœŸçš„ç®¡ç”¨å—ï¼ŸğŸ¤”

æ‰“å¼€`src/tree.js`å¹¶å¢åŠ `rowsCount`çš„å€¼ã€‚

æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ›´å¤§çš„æ ‘ï¼Œä½†ä¹Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„é¡µé¢é‡æ–°åŠ è½½ã€‚å¯èƒ½å¾ˆéš¾æ³¨æ„åˆ°ã€‚æŸ¥çœ‹æ§åˆ¶å°ä¸­çš„æ¶ˆæ¯â€”â€”å½“é‡æ–°åŠ è½½å¼€å§‹æ—¶ï¼Œå®ƒä»¬æ¶ˆå¤±äº†ã€‚å½“é¡µé¢ä¸Šçš„è„šæœ¬é‡æ–°æ‰§è¡Œæ—¶ï¼Œæ¶ˆæ¯å†æ¬¡å‡ºç°ã€‚HMR çš„ç›®æ ‡æ˜¯é¿å…æ•´é¡µé‡è½½ã€‚

[![HMR: The tree isn't updated on change.](img/379c43a84b32cd96716d3b389669ef82.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--jqd7bg0X--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/fyv1t0tuol99wq9uiat1.gif)

ç›®å‰ï¼Œåº”ç”¨ç¨‹åºä¸æ¥å—*çƒ­æ›´æ–°*ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æŒ‡ç¤ºå®ƒè¿™æ ·åšã€‚å› æ­¤ï¼Œ`webpack-dev-server`é€€å›åˆ°å…¨é¡µé¢é‡è½½ã€‚

å¤„ç†ä¼ å…¥æ›´æ–°çš„æœ€ç®€å•æ–¹æ³•æ˜¯é€šè¿‡*è‡ªæ¥å—*æ¥è‡ªå·²æ›´æ”¹æ¨¡å—çš„æ›´æ–°ã€‚è¿™å°†å¯¼è‡´ webpack æ‰§è¡Œæ¨¡å—çš„æ–°ç‰ˆæœ¬ã€‚æˆ‘ä»¬éœ€è¦è¡¥å……çš„æ˜¯:

```
// src/tree.js

module.hot.accept(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶è€Œï¼Œ`module.hot`å±æ€§ä»…åœ¨ HMR å¯ç”¨æ—¶å®šä¹‰ã€‚å¦‚æœæˆ‘ä»¬åœ¨æ²¡æœ‰ HMR çš„æƒ…å†µä¸‹ä¸ºç”Ÿäº§æ„å»ºåº”ç”¨ç¨‹åºï¼Œä¸Šé¢çš„ä»£ç å°†ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚æˆ‘ä»¬éœ€è¦æ£€æŸ¥:

```
// src/tree.js

if (module.hot) {
    module.hot.accept();
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¯•ç”¨ä¹‹å‰ï¼Œæœ€åä¸€ä¸ªæ³¨æ„äº‹é¡¹â€”â€”å½“æˆ‘ä»¬ä¸ºç”Ÿäº§è€Œæ„å»ºæ—¶ï¼Œwebpack çŸ¥é“`module.hot`æ˜¯`undefined`,å¹¶ä¸”ç”± if è¯­å¥ä¿æŠ¤çš„ä»£ç å—æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚webpack çš„ *UglifyJS/Terser* æ’ä»¶ä¼šå°†å…¶ä»æ†ç»‘åŒ…ä¸­ç§»é™¤ã€‚æˆ‘ä»¬ä¸å¿…æ‹…å¿ƒæˆ‘ä»¬çš„å¼€å‘è®¾ç½®ä¼šåœ¨ç”Ÿäº§ä¸­ç»ˆæ­¢ã€‚

è®©æˆ‘ä»¬å†æ¬¡æ”¹å˜`rowsCount`ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚é¡µé¢æ²¡æœ‰å®Œå…¨é‡æ–°åŠ è½½ï¼Œä½†æ˜¯æ ‘ä»ç„¶ä¼šæ›´æ–°ï¼Œå› ä¸ºæ‰§è¡Œäº†æ–°çš„`tree.js`æ¨¡å—ã€‚

[![HMR: Tree is updated on change.](img/b972af14f828229e99bc8c52001c4c13.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--yhZXVk3i--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/q2yun2dz1m7itpszwhpi.gif)

# æ—§æ¨¡å—çš„å¤„ç†

åœ¨æˆ‘ä»¬ç®€å•çš„åº”ç”¨ç¨‹åºä¸­è¿˜æœ‰ä¸€ä¸ªæ¨¡å—- `src/lights.js`ï¼Œå®ƒâ€œç…§äº®â€äº†è¿™æ£µæ ‘ã€‚

```
// src/lights.js

import fir from './tree.js';

/**
 * Changes the look of
 * some 'needles' in the tree
 * every 1000ms
 */
function turnOn() {
    const blinkRate = 1000;
    const rowsCount = fir.rowsCount;
    const needles = fir.getNeedles();

    setInterval(() =>
        blink(rowsCount, needles),
        blinkRate
    );
}

turnOn();
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†ä½¿`lights.js`æˆä¸ºä¸€ä¸ªè‡ªæ¥å—çš„æ¨¡å—ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä¹‹å‰ç”¨äº`tree.js`çš„ç›¸åŒä»£ç æ¥æ‰©å±•å®ƒ:

```
// src/lights.js

if (module.hot) {
    module.hot.accept();
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¯•ç€å‡å°‘`blinkRate`æ¥è®©ç¯å…‰å˜å¾—æ›´å¿«ï¼Œå¢åŠ å®ƒæ¥è¾¾åˆ°ç›¸åçš„æ•ˆæœã€‚

[![Decrease blinkrate](img/f7dafae26a66ca9c5224bd80cfb8bf1a.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--nT-PrGp9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/hfdm8ox14g2obifpf6wu.gif)

æˆ‘ä»¬æ²¡æœ‰å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„è¡Œä¸ºã€‚éšç€æ¯ä¸€æ¬¡å˜åŒ–ï¼Œç¯æ³¡å˜å¾—è¶Šæ¥è¶Šå¤šã€‚æ¯å½“éœ€è¦*çƒ­æ›´æ–°*æ—¶ï¼Œ*è‡ªæ¥å—*ä½¿ webpack æ‰§è¡Œè¯¥æ¨¡å—ã€‚

```
// src/lights.js

function turnOn() {
...
    setInterval(() =>
        blink(rowsCount, needles),
        blinkRate
    );
}

turnOn();  // <-- gets called every time the module is changed 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰§è¡Œä¸Šé¢çš„ä»£ç æœ‰ä¸€ä¸ªå‰¯ä½œç”¨â€”â€”å®ƒé€šè¿‡è°ƒç”¨`setInterval`è§¦å‘äº†ä¸€ä¸ªé‡å¤çš„åŠ¨ä½œã€‚æˆ‘ä»¬ä»ä¸å–æ¶ˆå·²ç»å¼€å§‹çš„è¡ŒåŠ¨ï¼Œè€Œæ˜¯ä¸æ–­è§¦å‘æ–°çš„è¡ŒåŠ¨ã€‚å¹¸è¿çš„æ˜¯ï¼Œwebpack æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œè®© T1 åœ¨æ›¿æ¢æ—§æ¨¡å—ä¹‹å‰å¤„ç†æ‰ T2 æ—§æ¨¡å—ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜å¼€å§‹åŠ¨ä½œçš„ ID:

```
// src/lights.js

let lightsInterval;
function turnOn() {
...
    lightsInterval = setInterval(() =>
        blink(rowsCount, needles),
        blinkRate
    );
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œæ–°æ¨¡å—ä¹‹å‰*æ¸…é™¤å®ƒ:* 

```
// src/lights.js

if (module.hot) {
    module.hot.accept();
    module.hot.dispose(_data => {
      clearInterval(lightsInterval);
    });
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å†æ¬¡å°è¯•æ”¹å˜`blinkRate`:

[![Lights Dispose](img/785da248489455c83f31504494e9ca78.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--TMdcOtU_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/6d9erzo6hayhtnap57gt.gif)

# çˆ¶çº§æ¥å—çš„æ¨¡å—

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æŒ‡ç¤º webpack åœ¨æˆ‘ä»¬ä¿®æ”¹ä»£ç æ—¶æ‰§è¡Œ`tree.js`å’Œ`lights.js`æ¨¡å—ã€‚å½“æ›´æ”¹çš„æ•°æ®æ˜¯å†…éƒ¨æ•°æ®æ—¶ï¼Œçƒ­æ¨¡å—æ›¿æ¢ä¼¼ä¹å‡ºå¥‡åœ°æœ‰æ•ˆã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä¿®æ”¹æ¨¡å—çš„å…¬å…±æ¥å£ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿä¾èµ–äºè¯¥æ¥å£çš„å…¶ä»–æ¨¡å—ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µğŸ˜±ï¼Ÿ

`tree.js`æ¨¡å—å¯¼å‡ºå•ä¸ªå¯¹è±¡- `fir`:

*   å‡½æ•°å°†å®¹å™¨ DOM å…ƒç´ ä¸­çš„æ ‘å¯è§†åŒ–ã€‚å®ƒç”¨ span elements é’ˆå¤´æ›¿æ¢å®¹å™¨ä¸­çš„å†…å®¹ç‰©ã€‚æ¯æ ¹é’ˆå¾—åˆ°ä¸€ä¸ªç­‰äº`NEEDLE_CLASS`å¸¸æ•°çš„å€¼çš„`className`ï¼›
*   `fir.getNeedles()`å‡½æ•°è¿”å›æ‰€æœ‰å¸¦æœ‰ä¸Šè¿°`className`çš„ DOM å…ƒç´ ã€‚

`lights.js`æ¨¡å—å¯¼å…¥ tree.js å¹¶ä½¿ç”¨`fir.getNeedles()`è·å¾—æ–°ç»˜åˆ¶çš„ DOM å…ƒç´ åˆ—è¡¨ã€‚è¿™ä»½æ¸…å•å¯¹äºç‚¹äº®åœ£è¯æ ‘è‡³å…³é‡è¦ã€‚ä¾èµ–å…³ç³»å›¾å¦‚ä¸‹æ‰€ç¤º:

[![index.js -> lights.js -> tree.js](img/667e0df422ab4dd8ae176aa326404737.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--nYsldTK5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/c9dzun9ldkf2vfyj7dv8.png)

è®©æˆ‘ä»¬é€šè¿‡ä¿®æ”¹`tree.js`ä¸­`NEEDLE_CLASS`çš„å€¼æ¥æµ‹è¯• HMR è¿‡ç¨‹ã€‚

[![Update NEEDLE_CLASS](img/fe9ff41cbe8013b60c8e903b3fa2e929.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--MN9kRbjQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/hjvzwzqbsetu36226xpc.gif)

æˆ‘ä»¬çš„ç¯ç†„ç­äº†ï¼HMR è¿›ç¨‹æ‚²æƒ¨åœ°å¤±è´¥äº†ã€‚

å½“æˆ‘ä»¬æ”¹å˜å®ƒæ—¶ï¼ŒWebpack æ‰§è¡Œäº†`tree.js`ã€‚`fir.draw()`åŠŸèƒ½åˆ›å»ºäº†å…¨æ–°çš„æŒ‡é’ˆï¼Œå…¶`classNames`ä¸`NEEDLE_CLASS`çš„æ–°å€¼ç›¸åŒ¹é…ã€‚ä¹Ÿæ‘†è„±äº†ä¹‹å‰çš„æ‰é’ˆã€‚

ç„¶è€Œ`lights.js`é‡Œä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿã€‚å®ƒçš„é’ˆåˆ—è¡¨ä»ç„¶å¼•ç”¨æ—§çš„ã€å·²ç»ç§»é™¤çš„é’ˆã€‚å½“`tree.js`æ”¹å˜æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥åˆ·æ–°åˆ—è¡¨ã€‚

*parent accept* API å…è®¸æˆ‘ä»¬å¤„ç†ä»å…¶ä»–æ¨¡å—å¯¼å…¥çš„æ¨¡å—çš„çƒ­æ›´æ–°ã€‚æˆ‘ä»¬å¯ä»¥æ‰©å±•`lights.js`ä¸­çš„ HMR é€»è¾‘ï¼Œåœ¨`tree.js`æ”¹å˜æ—¶é‡å¯ç¯æ³¡:

```
// src/lights.js

if (module.hot) {
    module.hot.accept(['./tree.js'], function() {
        clearInterval(lightsInterval);
        turnOn();
    });
    ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬åœ¨ä¸¤ä¸ªåœ°æ–¹æœ‰äº†`tree.js`çš„æ›´æ–°å¤„ç†é€»è¾‘:

*   *æ¯æ¥å—`lights.js`ä¸­çš„*ï¼›
*   *è‡ªæˆ‘æ¥å—`tree.js`æ¨¡å—ä¸­çš„*æœ¬èº«ã€‚

ä½†æ˜¯å“ªä¸€ä¸ªä¼šæ›´å—é’çå‘¢ï¼Ÿ

# åˆ·æ–°ç­–ç•¥

è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹`tree.js`æ‰€æœ‰å¯èƒ½çš„æ›´æ–°å¤„ç†åœºæ™¯ã€‚

## åœ¨ tree.js ä¸­è‡ªæˆ‘æ¥å—

å¦‚æœ`tree.js`ä¸­æœ‰*è‡ªæ¥å—*ï¼Œwebpack æ‰§è¡Œè¯¥æ¨¡å—ã€‚å¯¼å…¥`tree.js`(å®ƒçš„â€œçˆ¶æ¯â€)çš„æ¨¡å—æ²¡æœ‰è¢«é€šçŸ¥è¿™ä¸ªå˜åŒ–ã€‚

[![Self accept by tree.js](img/cea8982bba9c7657656dd6dfe4416c91.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--v7gpf-EV--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ghgqp40sg77131if6asi.gif)

## åœ¨ lights.js ä¸­çˆ¶æ¥å—

å¦‚æœåœ¨`tree.js`ä¸­æ²¡æœ‰*è‡ªæ¥å—*ï¼Œwebpack ä¼šåœ¨å¯¼å…¥å®ƒçš„æ¨¡å—ä¸­å¯»æ‰¾æ›´æ–°å¤„ç†ç¨‹åºã€‚

`lights.js`æ¨¡å—å¯¼å…¥`tree.js`ã€‚å‡è®¾å®ƒæœ‰ä¸€ä¸ªå¤„ç†ç¨‹åº:

```
// src/lights.js

module.hot.accept(['./tree.js'], function updateHandler() {
    ...
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Webpack å°†:

*   æ‰§è¡Œ`tree.js`ï¼›
*   æ›´æ–°`lights.js`ä¸­çš„`tree.js`å¯¼å…¥ä»¥æŒ‡å‘æ–°æ¨¡å—ï¼›
*   æ‰§è¡Œ`updateHandler()`ã€‚

[![parent accept in lights.js](img/2fd4a6ce7933ccdadb94eb38412dc1b1.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--WI9UMzyP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/tmjpkyiam4kdam5fdjiv.gif)

## index . js ä¸­çš„çˆ¶æ¥å—

å¦‚æœ`lights.js`ä¸­æ²¡æœ‰`tree.js`çš„å¤„ç†ç¨‹åºï¼Œwebpack å°†ç»§ç»­æŸ¥æ‰¾ä¾èµ–å›¾ã€‚

`index.js`æ¨¡å—å¯¼å…¥`lights.js`ã€‚Webpack å°†æ£€æŸ¥å®ƒæ˜¯å¦åŒ…å«ä¸€ä¸ª`lights.js`çš„å¤„ç†ç¨‹åºã€‚æˆ‘æƒ³å¼ºè°ƒè¿™ä¸€éƒ¨åˆ†â€”â€”å®ƒä¸ä¼šæ£€æŸ¥`tree.js`(æ›´æ”¹åçš„æ¨¡å—)çš„å¤„ç†ç¨‹åºï¼Œè€Œæ˜¯æ£€æŸ¥`lights.js`(å®ƒå®é™…å¯¼å…¥çš„æ¨¡å—)ã€‚è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹`index.js`æœ‰ä¸€ä¸ªå¤„ç†ç¨‹åº:

```
// src/index.js

module.hot.accept(['./lights.js'], function updateHandler() {
    ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Webpack å°†:

*   æ‰§è¡Œ`tree.js`ï¼›
*   æ‰§è¡Œ`lights.js`(æ›´æ–°å¯¼å…¥çš„`tree.js`æ¨¡å—)
*   æ›´æ–°å¯¹`index.js`å†…`lights.js`çš„å¼•ç”¨ï¼›
*   æ‰§è¡Œ`updateHandler()`ã€‚

[![parent accept in index.js](img/9e231ef7ccc3794f93bc57254c8b920b.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--YiatBKVd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/310wsll80byt82ho1lyn.gif)

## tree . js æ²¡æœ‰æ›´æ–°å¤„ç†ç¨‹åº

Webpack ç»§ç»­å¯»æ‰¾å¤„ç†ç¨‹åºï¼Œç›´åˆ°å®ƒæ‰¾åˆ°ä¸€ä¸ª*â€˜æ ¹â€™*æ¨¡å—â€”â€”ä¸€ä¸ªæ²¡æœ‰åœ¨ä»»ä½•å…¶ä»–æ¨¡å—ä¸­å¯¼å…¥çš„æ¨¡å—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`webpack-dev-server`å°†é€€å›åˆ°å…¨é¡µé¢é‡æ–°åŠ è½½ï¼Œè€Œåœ¨**çš„æƒ…å†µä¸‹ï¼Œ**å°†é‡å¯åº”ç”¨ç¨‹åºã€‚

[![missing update handler](img/ce34918f49b709e8ce02ff518c6dbda3.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--UqcpK51u--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/k3itc5utmurf4q5rdrlt.gif)

# é€‰æ‹©æ›´æ–°å¤„ç†ç¨‹åº

å›åˆ°æ ‘â€”â€”æˆ‘ä»¬æ³¨æ„åˆ°`tree.js`æœ‰ä¸¤ä¸ªæ›´æ–°å¤„ç†ç¨‹åºã€‚æˆ‘ä»¬å¸Œæœ› webpack ä½¿ç”¨`lights.js`ä¸­çš„æ–°é€»è¾‘ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¿…é¡»ä»`tree.js`ä¸­ç§»é™¤è‡ªæˆ‘æ¥å—ã€‚

```
// src/tree.js

// comment or simply delete the code below
// if (module.hot) {
//     module.hot.accept();
// } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬å†æ¬¡å°è¯•æ›´æ”¹`NEEDLE_CLASS`çš„å€¼:

[![Change causes full page reload](img/c9ea382ce4a671edbb3d25b543338673.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--UmWs3_dR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/0ocxo9m1vfsopdgi5u0t.gif)

Aaaand...HMR è¿›ç¨‹å¤±è´¥äº†ã€‚æˆ‘ä»¬å¾—åˆ°çš„ä¸æ˜¯åˆ·æ–°ï¼Œè€Œæ˜¯æ•´é¡µé‡è½½ã€‚

æˆ‘å¿…é¡»æ‰¿è®¤æˆ‘å¯¹ä½ æ’’äº†è°ã€‚`tree.js`æ¨¡å—å®é™…ä¸Šä¸ä»…åœ¨`lights.js`ä¸­å¯¼å…¥ï¼Œä¹Ÿåœ¨`index.js`ä¸­å¯¼å…¥ã€‚è¿™æ˜¯çœŸæ­£çš„ä¾èµ–å…³ç³»å›¾:

[![lights.js -> tree.js -> index.js -> lights.js](img/6f749865ace29de025bb97da206f04d0.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--fGOnw4AL--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/0lnt3xuf2z010y6d79qo.png)

æ›´æ”¹åçš„æ¨¡å—åº”è¯¥åœ¨å…¶ä¾èµ–å›¾çš„æ¯ä¸ªåˆ†æ”¯çš„**ä¸­æœ‰ä¸€ä¸ªæ›´æ–°å¤„ç†ç¨‹åºã€‚ç›®å‰ï¼Œæˆ‘ä»¬ä¸æ¥å—å¯¹`index.js`ä¸­`tree.js`çš„æ›´æ”¹ï¼Œå³å°†åˆ°æ¥çš„çƒ­æ›´æ–°è¢«æ‹’ç»ã€‚**

[![hot update is rejected](img/47042eb0e7abce3d8e13a501246a03bc.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--P_kMXPTj--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/5pj0uzd1uayi6f9q34em.gif)

> æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬åªæœ‰ä¸€ä¸ªæ ¹æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªåº”ç”¨ç¨‹åºèŒƒå›´çš„æ›´æ–°å¤„ç†ç¨‹åºã€‚æˆ‘ä»¬æš‚æ—¶ä¸ä¼šåœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­è¿™æ ·åšã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨ Angularï¼Œä½ çš„ä»»åŠ¡ä¼šç¨å¾®å®¹æ˜“ä¸€ç‚¹ï¼Œå› ä¸ºå¤§å¤šæ•° **Angular** åº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„å…¥å£æ¨¡å—- `main.ts`ï¼Œå®ƒå¼•å¯¼åº”ç”¨ç¨‹åºã€‚å¦‚æœæ²¡æœ‰æ‡’æƒ°åŠ è½½çš„*ng æ¨¡å—*ï¼Œ`main.ts`å°†æ˜¯å”¯ä¸€çš„æ ¹æ¨¡å—ã€‚å‘å®ƒæ·»åŠ ä»¥ä¸‹å¤„ç†ç¨‹åºå°†æ•è·åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰çƒ­æ›´æ–°:

```
// main.ts

if (module.hot) {
    module.hot.accept(["./app/app.module"], function() { ... });
}

import { AppModule } from "./app/app.module";
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å›åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸Šæ¥â€”â€”æˆ‘ä»¬éœ€è¦ä¸€ä¸ª*çˆ¶ä»£æ¥å—`index.js`ä¸­`tree.js`çš„*ã€‚æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦å›ç”µã€‚

```
// src/index.js

if (module.hot) {
    module.hot.accept(['./tree.js']);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œå¤„ç†ç¨‹åºæŸ¥æ‰¾è¿‡ç¨‹å°†ä¼šæˆåŠŸï¼Œå› ä¸º tree.js çš„çƒ­æ›´æ–°åœ¨å®ƒçš„æ‰€æœ‰çˆ¶ä»£ä¸­éƒ½è¢«æ¥å—ã€‚

[![Hot update is accepted](img/599c60748ef58e23189d4b4d059addf1.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--7p9zFVUg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/2685kirvvzqwm5dio01c.gif)

åœ¨æˆ‘ä»¬æ”¾å¼ƒä¹‹å‰ï¼Œè®©æˆ‘ä»¬æœ€åä¸€æ¬¡å°è¯•æ›´æ”¹`NEEDLE_CLASS`çš„å€¼:

[![Parent update works](img/19777051ba5ee40dbc72df4c76082cee.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--dnAmvHqQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/0r167lvn0c6qps56kw7e.gif)

# é‡æ„

Yeyyyï¼æœ‰ç”¨ï¼ä½†æ˜¯...

æˆ‘ä»¬å†™çš„ä»£ç å¹¶ä¸çœŸçš„...å¯¹æˆ‘æ„Ÿè§‰å¾ˆå¥½ã€‚`index.js`ä¸­çš„*çˆ¶æ¥å—*ä¼¼ä¹æœ‰ç‚¹åšä½œâ€”â€”å®ƒåœ¨é‚£é‡Œåªæ˜¯å› ä¸ºæˆ‘ä»¬å¿…é¡»æ¥å—å³å°†åˆ°æ¥çš„æ›´æ–°ã€‚å¦‚æœæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå¯¼å…¥`tree.js?`çš„æ–°æ¨¡å—ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªæ›´æ–°å¤„ç†ç¨‹åºï¼æ˜¯æ—¶å€™é‡æ„äº†ã€‚

ç›®å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¥å—`index.js`å’Œ`lights.js`ä¸­ tree.js çš„æ›´æ”¹ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ¨¡å—éƒ½å¯¼å…¥äº†å®ƒã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹`lights.js`æ˜¯å¦‚ä½•ä½¿ç”¨`tree.js` :

```
// src/lights.js

import fir from './tree.js';

function turnOn() {
    const rowsCount = fir.rowsCount;
    const needles = fir.getNeedles();
    ...
}

turnOn(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å¯ä»¥ä¸å¯¼å…¥`fir`ï¼Œè€Œæ˜¯è®©å®ƒæˆä¸º`turnOn`å‡½æ•°çš„ä¸€ä¸ªå‚æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸åº”è¯¥è°ƒç”¨è¯¥å‡½æ•°ï¼Œè€Œåº”è¯¥å¯¼å‡ºå®ƒã€‚

```
// src/lights.js

// import fir from './tree.js';

export function turnOn(fir) {
    const rowsCount = fir.rowsCount;
    const needles = fir.getNeedles();
    ...
}

// turnOn(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä¸å†å¯¼å…¥`tree.js`ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ é™¤å®ƒçš„å¤„ç†ç¨‹åº:

```
// src/lights.js

if (module.hot) {
    // module.hot.accept(['./tree.js'], function() {
    //    clearInterval(lightsInterval);
    //    turnOn();
    // });
    module.hot.accept();
    module.hot.dispose(_data => {
      clearInterval(lightsInterval);
    });
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ— è®ºè°ä½¿ç”¨`lights.js`ï¼Œéƒ½å¿…é¡»å¯¼å…¥`turnOn`å‡½æ•°ï¼Œè°ƒç”¨å®ƒï¼Œå¹¶æä¾›`fir`å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿›å£å•†æ˜¯`index.js`ã€‚åœ¨åšäº†å¿…è¦çš„ä¿®æ”¹åï¼Œ`index.js`çœ‹èµ·æ¥åº”è¯¥æ˜¯è¿™æ ·çš„:

```
// src/index.js

import fir from './tree.js';
import { turnOn } from './lights.js';

turnOn(fir);

if (module.hot) {
    module.hot.accept(['./tree.js']);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæˆ‘ä»¬åªæœ‰åœ¨`index.js`ä¸­æœ‰ä¸€ä¸ª`tree.js`çš„æ›´æ–°å¤„ç†ç¨‹åºã€‚æˆ‘ä»¬å¯ä»¥æŠŠ`lights.js`çš„åˆ·æ–°é€»è¾‘ç§»åˆ°é‡Œé¢ã€‚è®©æˆ‘ä»¬å¯¼å‡ºä¸€ä¸ªâ€œé‡å¯â€ç¯å…‰çš„å‡½æ•°:

```
// src/lights.js

export function restart(fir) {
    clearInterval(lightsInterval);
    turnOn(fir);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶ä»`index.js` :
ä¸­çš„æ›´æ–°å¤„ç†ç¨‹åºè°ƒç”¨è¯¥å‡½æ•°

```
// src/index.js

import fir from './tree.js';
import { turnOn, restart } from './lights.js';

turnOn(fir);

if (module.hot) {
    module.hot.accept(['./tree.js'], () => {
        restart(fir);
    };
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬é€šè¿‡ä¿®æ”¹`tree.js`æ–‡ä»¶æ¥æµ‹è¯•æˆ‘ä»¬æ‰€åšçš„æ›´æ”¹ã€‚

[![Final update works](img/449dc2fee2ce9fc73959fa483a97960f.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--8H4SR8NF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/h8low94q8v9x7a2cg808.gif)

å‰ªè¾‘`tree.js`è¿˜èƒ½ç”¨ï¼

ä½†æ˜¯ï¼Œç°åœ¨`lights.js`æ¨¡å—æ˜¯è‡ªæ¥å—çš„ï¼Œä¸å†å¯¼å…¥`tree.js`ã€‚å¦‚æœæˆ‘ä»¬è¯•å›¾ä¿®æ”¹å®ƒï¼Œæ ‘ä¸ä¼šè¢«é‡ç”»ã€‚æˆ‘ä»¬è¿˜éœ€è¦å°†`lights.js`æ›´æ–°å¤„ç†ç¨‹åºç§»åŠ¨åˆ°`index.js`ã€‚

```
// src/index.js

if (module.hot) {
    // add ./lights.js to the list of accepted dependencies 
    module.hot.accept(['./tree.js', './lights.js'], () => {
      restart(fir);
    });
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸è¦å¿˜è®°ä»`lights.js` :
ä¸­åˆ é™¤è‡ªæˆ‘æ¥å—

```
// src/lights.js

if (module.hot) {
    // Comment or remove the line below
    // module.hot.accept();
    // Keep the disposal logic!
    module.hot.dispose(_data => {
      clearInterval(lightsInterval);
    });
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±æ˜¯è¿™æ ·ï¼é‡æ„å®Œæˆï¼åœ¨æˆ‘ä»¬æ‰“ç ´æŸäº›ä¸œè¥¿ä¹‹å‰ï¼Œè®©æˆ‘ä»¬åœæ­¢æ”¹å˜...

# æ€»ç»“

ä½ å¯ä»¥åœ¨åˆ†æ”¯ä¸­æ‰¾åˆ° HMR æ”¶è´¹ç‰ˆçš„æ¼”ç¤ºï¼Œåä¸ºå®Œæˆ:[https://github.com/sis0k0/christmas-tree/tree/finished](https://github.com/sis0k0/christmas-tree/tree/finished)

åº”ç”¨ç¨‹åºçš„å¤„ç½®é€»è¾‘ä¸­(è‡³å°‘)æœ‰ä¸€ä¸ª bugã€‚è¯•ç€æ‰¾åˆ°å®ƒï¼åœ¨ Github repo é‡Œéšä¾¿å¼€ä¸ª PRã€‚ç¬¬ä¸€ä¸ªè¿™æ ·åšçš„äººå¯èƒ½ä¼š(ä¹Ÿå¯èƒ½ä¸ä¼š)èµ¢å¾—å¥½ä¸œè¥¿ğŸ™‚ã€‚

æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨`module.hot` API æ¥æ‰‹åŠ¨å¤„ç†çƒ­æ›´æ–°ã€‚ä¸€äº›æ¡†æ¶ï¼Œå¦‚ Reactã€Vueã€Angular å’Œ NativeScriptï¼Œæä¾›äº†å†…ç½®çš„ HMR æ”¯æŒã€‚åœ¨ä¸€ç¯‡ä¸“é—¨çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨æ¯ä¸ªæ¡†æ¶å¦‚ä½•è§£å†³åˆ·æ–°åº”ç”¨ç¨‹åºå¹¶ä¿æŒå…¶çŠ¶æ€ä¸å˜çš„é—®é¢˜ã€‚