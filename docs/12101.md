# åœ¨ç”»ä¸­ç”»çª—å£ä¸­ç©éœ¸ç‹é¾™èµ›è·‘è€…æ¸¸æˆ

> åŸæ–‡:[https://dev . to/arnelle balane/playing-the-t-rex-runner-game-inside-a-picture-in-picture-in-picture-picture-window-KPC](https://dev.to/arnellebalane/playing-the-t-rex-runner-game-inside-a-picture-in-picture-window-kpc)

ç”»ä¸­ç”» API æ˜¯ä¸€ç§æ–°çš„ç½‘ç»œå¹³å° APIï¼Œå…è®¸ç½‘ç«™åœ¨ä¸€ä¸ªå°çš„æµ®åŠ¨çª—å£ä¸­æ’­æ”¾è§†é¢‘ï¼Œå³ä½¿æµè§ˆå™¨ä¸å¯è§ï¼Œè¯¥çª—å£ä¹Ÿä½äºå…¶ä»–çª—å£çš„é¡¶éƒ¨ï¼Œå…è®¸æˆ‘ä»¬åœ¨ä¸å…¶ä»–ç½‘ç«™æˆ–åº”ç”¨ç¨‹åºäº¤äº’æ—¶ç»§ç»­è§‚çœ‹è¿™äº›è§†é¢‘ã€‚

API ç›®å‰ä»…é™äºè§†é¢‘å…ƒç´ ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä»ç”»å¸ƒå…ƒç´ åˆ›å»ºè§†é¢‘æµã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ç”»å¸ƒä¸Šç”»ä»»ä½•ä¸œè¥¿ï¼Œå¹¶è®©å®ƒå‡ºç°åœ¨ç”»ä¸­ç”»çª—å£ä¸­ã€‚è¿™ç§å°è¯•æœ€ç»ˆè®©æˆ‘å°è¯•è®© Chrome çš„ç¦»çº¿ T-Rex runner æ¸¸æˆå¯ä»¥åœ¨ç”»ä¸­ç”»çª—å£ä¸­ç©([ç‚¹å‡»æ­¤å¤„](https://pip-trex.arnelle.me/)ç«‹å³ç©)ã€‚

> ![unknown tweet media content](../Images/4700620eac8dfa5f9892ca6867efb9a4.png)![Play butt](../Images/980e9fb12d58fa9423fc94c33003fc4f.png)<video loop="" controls=""><source src="https://video.twimg.com/ext_tw_video/1134837766619926537/pu/vid/1306x720/7zO-DFeXU9BUPZ0_.mp4?tag=9" type="video/mp4"></video>![Arnelle Balane profile image](../Images/ec221d691766db967d555cd101d62314.png)Arnelle Balane[@ Arnelle Balane](https://dev.to/arnellebalane)![twitter logo](../Images/65e26e35707d96169ec8af6b3cbf2003.png)å¦ä¸€ä¸ªç”»ä¸­ç”»å®éªŒ:åœ¨ç”»ä¸­ç”»çª—å£å†…è¿è¡Œ Chrome çš„ T-Rex runner æ¸¸æˆğŸ¦–
> 
> (ä½¿ç”¨é”®ç›˜ã€è€³æœºç­‰ä¸Šçš„æ’­æ”¾/æš‚åœåª’ä½“æŒ‰é’®ã€‚è¦è·³ï¼ğŸ”¥)
> 
> [ã€web devã€‘](https://twitter.com/hashtag/webdev)[ã€JavaScriptã€‘](https://twitter.com/hashtag/javascript)[ã€web APIã€‘](https://twitter.com/hashtag/webapis)
> 
> [pip-trex . arnelle . me](https://t.co/7m1q58CCWT)
> [github.com/arnellebalane/â€¦](https://t.co/TXQGQj26BH)2019 å¹´ 6 æœˆ 15:04 æ—¥[![Twitter reply action](../Images/269095962147c28351274afdd5486a48.png)](https://twitter.com/intent/tweet?in_reply_to=1134838128127012864)[![Twitter retweet action](../Images/771160ecf06ae3d4d7a7815c29c819c2.png)](https://twitter.com/intent/retweet?tweet_id=1134838128127012864)6[![Twitter like action](../Images/c077611ab2a5e0b4cd0c826ee7ae1e48.png)](https://twitter.com/intent/like?tweet_id=1134838128127012864)

## [](#get-the-games-source-code)è·å–æ¸¸æˆçš„æºä»£ç 

æˆ‘ä»¬å¯ä»¥ä»[é“¬åº“](https://chromium.googlesource.com/chromium/src/+/master/components/neterror/resources/)è·å¾—æ¸¸æˆçš„æºä»£ç ã€‚æˆ‘ä»¬å¤åˆ¶è¯¥ä½ç½®çš„å†…å®¹ï¼Œé‡å‘½åä¸€äº›æ–‡ä»¶ï¼Œå¹¶æ¸…ç† HTMLï¼Œä½¿å…¶åªåŒ…å«`<body>` :
ä¸­å¿…è¦çš„æ ‡è®°

```
<!-- This will contain the canvas element -->
<div class="interstitial-wrapper"></div>

<!-- Game assets: sprits + audio -->
<div id="offline-resources">
  <img id="offline-resources-1x" src="images/100-percent/100-offline-sprite.png">
  <img id="offline-resources-2x" src="images/200-percent/200-offline-sprite.png">

  <div id="audio-resources">
    <audio id="offline-sound-press" src="sounds/button-press.mp3"></audio>
    <audio id="offline-sound-hit" src="sounds/hit.mp3"></audio>
    <audio id="offline-sound-reached" src="sounds/score-reached.mp3"></audio>
  </div>
</div>

<!-- The main game script -->
<script src="offline.js"></script>

<!-- Initialize the canvas and the game. -->
<!-- Originally performed inside neterror.js -->
<script>
  const runner = new Runner('.interstitial-wrapper');
</script> 
```

è¿™ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå·²ç»å¯ä»¥ç©çš„ç¦»çº¿éœ¸ç‹é¾™è·‘å’å‘˜æ¸¸æˆçš„ç²¾ç¡®å‰¯æœ¬:

[![offline T-Rex Runner replica](../Images/30144f57ec46aef61de1be1feb5bdc00.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--SSvNrgyA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/9yz3fswcc6hpvwzdbbp6.png)

## [](#implement-programmatic-trex-jump)å®ç°ç¨‹åºåŒ–éœ¸ç‹é¾™è·³è·ƒ

æ¯æ¬¡æˆ‘ä»¬æŒ‰ç©ºæ ¼é”®ï¼Œéœ¸ç‹é¾™å°±ä¼šè·³èµ·æ¥ã€‚è®©æˆ‘ä»¬æ·»åŠ ä¸€ç§æ–¹æ³•ï¼Œé€šè¿‡ç¼–ç¨‹è®©æˆ‘ä»¬çš„ T-Rex è·³è·ƒï¼Œè€Œä¸éœ€è¦æˆ‘ä»¬çœŸçš„æŒ‰ç©ºæ ¼é”®ã€‚

ä»”ç»†ç ”ç©¶æ¸¸æˆä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°å¤„ç†ç©ºæ ¼é”®çš„`runner`å¯¹è±¡æœ‰ä¸¤ç§æ–¹æ³•:

1.  [`onKeyDown`](https://chromium.googlesource.com/chromium/src/+/master/components/neterror/resources/offline.js#676) ï¼Œè®©éœ¸ç‹é¾™åœ¨æ¸¸æˆè¿è¡Œæ—¶è·³è·ƒã€‚
2.  [`onKeyUp`](https://chromium.googlesource.com/chromium/src/+/master/components/neterror/resources/offline.js#727) ï¼Œå½“éœ¸ç‹é¾™æ’ä¸Šéšœç¢ç‰©æ—¶é‡å¯æ¸¸æˆã€‚

è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œæ ¹æ®æ¸¸æˆçš„çŠ¶æ€è°ƒç”¨å…¶ä¸­ä»»ä½•ä¸€ä¸ªï¼Œä¼ å…¥ä¸€ä¸ª*è™šæ‹Ÿ*é”®ç›˜äº‹ä»¶ã€‚

```
function simulateSpacebar() {
  const keyboardEventOptions = {
    code: 'Space',
    keyCode: 32,
  };

  if (runner.crashed) {
    const event = new KeyboardEvent('keyup', keyboardEventOptions);
    runner.onKeyUp(event);
  } else {
    const event = new KeyboardEvent('keydown', keyboardEventOptions);
    runner.onKeyDown(event);
  }
} 
```

## [](#capture-video-stream-of-canvas-contents)æ•è·ç”»å¸ƒå†…å®¹çš„è§†é¢‘æµ

è°ƒç”¨`new Runner('...')`åˆ›å»ºä¸€ä¸ªç”»å¸ƒå…ƒç´ å¹¶å°†å…¶æ’å…¥é¡µé¢ã€‚æˆ‘ä»¬éœ€è¦è·å–å¯¹ canvas å…ƒç´ çš„å¼•ç”¨ï¼Œç„¶åå°†å®ƒçš„å†…å®¹æ•è·ä¸ºè§†é¢‘æµ:

```
const canvas = document.querySelector('canvas');
const videoStream = canvas.captureStream(); 
```

ç„¶åæˆ‘ä»¬ç”¨è§†é¢‘æµä½œä¸ºæºåˆ›å»ºä¸€ä¸ª`video`å…ƒç´ :

```
const video = new Video();
video.srcObject = videoStream;

video.muted = true;
video.play(); 
```

è¿™é‡Œæˆ‘ä»¬ä¹Ÿå°†è§†é¢‘é™éŸ³ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªåŠ¨æ’­æ”¾äº†(è§ [Chrome çš„è‡ªåŠ¨æ’­æ”¾æ”¿ç­–](https://developers.google.com/web/updates/2017/09/autoplay-policy-changes))ã€‚

## [](#show-the-pictureinpicture-window)æ˜¾ç¤ºç”»ä¸­ç”»çª—å£

å½“ä½¿ç”¨ç”»ä¸­ç”»è¿™æ ·çš„æ–°çš„ Web APIs æ—¶ï¼Œåœ¨å°è¯•ä½¿ç”¨å®ƒä»¬ä¹‹å‰ï¼Œä¸€å®šè¦æ£€æµ‹å®ƒä»¬æ˜¯å¦å¯ç”¨ã€‚è¿™ç¡®ä¿äº†å½“ API ä¸å¯ç”¨æ—¶ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸ä¼šä¸­æ–­ï¼Œåªæœ‰å½“å®ƒå¯ç”¨æ—¶ï¼Œæ‰ä¼šé€æ¸å¢å¼ºä½“éªŒã€‚å¯¹äºç”»ä¸­ç”»ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥`document.pictureInPictureEnabled`å±æ€§:
æ¥å®ç°

```
const button = document.querySelector('button');

if (document.pictureInPictureEnabled) {

  // Picture-in-Picture is available!
  // Subsequent code snippets will be place inside this block.

} else {
  // Picture-in-Picture is not available. User can still play the game normally in the page.

  button.textContent = 'Picture-in-Picture is not available';
  button.disabled = true;
} 
```

æˆ‘ä»¬è¿˜åœ¨é¡µé¢ä¸­æ·»åŠ äº†ä¸€ä¸ª`<button>`å…ƒç´ ï¼Œç”¨æˆ·å¯ä»¥ç‚¹å‡»å®ƒè¿›å…¥
ç”»ä¸­ç”»ã€‚æˆ‘ä»¬å¸Œæœ›å°†è¿™ç§æ§åˆ¶æƒäº¤ç»™æˆ‘ä»¬çš„ç”¨æˆ·ï¼Œé€šå¸¸æ˜¯é€šè¿‡ UI ä¸­çš„ç”»ä¸­ç”»å›¾æ ‡ï¼Œè¿™æ ·ä»–ä»¬å°±å¯ä»¥å†³å®šä½•æ—¶åœ¨ç”»ä¸­ç”»çª—å£ä¸­æŸ¥çœ‹æˆ‘ä»¬çš„å†…å®¹ã€‚

ç°åœ¨åˆ°äº†æœ‰è¶£çš„éƒ¨åˆ†ï¼Œå½“ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè®©æˆ‘ä»¬åœ¨ç”»ä¸­ç”»çª—å£ä¸­æ˜¾ç¤ºæˆ‘ä»¬çš„è§†é¢‘æµï¼

```
button.addEventListener('click', async () => {
  simulateSpacebar();
  await video.requestPictureInPicture();
}); 
```

ç»“æœçœ‹èµ·æ¥åƒè¿™æ ·:

[https://www.youtube.com/embed/JxmrlG_ROAY](https://www.youtube.com/embed/JxmrlG_ROAY)

## [](#implement-game-controls)å®ç°æ¸¸æˆæ§åˆ¶

ç”»ä¸­ç”»çª—å£å¯ä»¥åœç•™åœ¨å…¶ä»–åº”ç”¨ç¨‹åºçª—å£çš„é¡¶éƒ¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æ— æ³•æŒ‰ä¸‹é¡µé¢ä¸Šçš„ç©ºæ ¼é”®æ¥è®© T-Rex è·³è·ƒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¦ä¸€ç§æ–¹æ³•æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

**åª’ä½“ä¼šè®® API æ¥æ‹¯æ•‘ï¼**

[åª’ä½“ä¼šè¯ API](https://developer.mozilla.org/en-US/docs/Web/API/Media_Session_API) å…è®¸ç½‘ç«™å®šåˆ¶åª’ä½“é€šçŸ¥ï¼Œä»¥åŠå®šä¹‰å›æ”¾æ§åˆ¶çš„äº‹ä»¶å¤„ç†ç¨‹åº(ä¾‹å¦‚ï¼Œæ’­æ”¾ã€æš‚åœç­‰)ã€‚).é€šè¿‡å®šä¹‰`play`å’Œ`pause`äº‹ä»¶å¤„ç†ç¨‹åºï¼Œæ¯å½“æˆ‘ä»¬æŒ‰ä¸‹é”®ç›˜ä¸Šçš„æ’­æ”¾/æš‚åœæŒ‰é’®(æˆ–å…¶ä»–å¯ä»¥æ§åˆ¶åª’ä½“æ’­æ”¾çš„è®¾å¤‡)æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®©æˆ‘ä»¬çš„ T-Rex è·³è½¬ã€‚

```
navigator.mediaSession.setActionHandler('play', simulateSpacebar);
navigator.mediaSession.setActionHandler('pause', simulateSpacebar); 
```

ç”»ä¸­ç”» API ä¸åª’ä½“ä¼šè¯ API é›†æˆå¾—å¾ˆå¥½ã€‚å½“æˆ‘ä»¬å®šä¹‰å›æ”¾äº‹ä»¶å¤„ç†ç¨‹åºæ—¶ï¼Œç”»ä¸­ç”»çª—å£ä¹Ÿä¼šæ˜¾ç¤ºå®ƒä»¬å¯¹åº”çš„åŠ¨ä½œæŒ‰é’®ã€‚

[![](../Images/b58143905f38c71d5b31fb6c371b5641.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--6-hRhiuc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/537g9fpfh4zxoao6bkw1.png)

## [](#lets-play)æ¥ç©å§ï¼

æœ‰äº†æ‰€æœ‰è¿™äº›å˜åŒ–ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨ç”»ä¸­ç”»çª—å£ä¸­ç©éœ¸ç‹é¾™èµ›è·‘è€…æ¸¸æˆ
ï¼Œä½¿ç”¨æˆ‘ä»¬çš„æ’­æ”¾/æš‚åœåª’ä½“æŒ‰é’®è®©éœ¸ç‹é¾™è·³è·ƒï¼

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹é“¾æ¥ä¸­æ‰¾åˆ°è¯¥é¡¹ç›®çš„ç°åœºæ¼”ç¤ºä»¥åŠå®Œæ•´çš„æºä»£ç :

*   [https://pip-trex.arnelle.me/](https://pip-trex.arnelle.me/)
*   [https://github.com/arnellebalane/pip-trex](https://github.com/arnellebalane/pip-trex)

## [](#conclusion)ç»“è®º

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ç”»ä¸­ç”» API å’Œåª’ä½“ä¼šè¯ API æ¥æ„å»ºä¸€äº›æ„šè ¢çš„ä¸œè¥¿ã€‚è¿™äº› API æœ‰æ›´ä¸¥è‚ƒå’Œæœ‰ç”¨çš„ç”¨é€”â€”â€”Youtube åœ¨ä»–ä»¬çš„æ’­æ”¾å™¨æ§ä»¶ä¸­æœ‰[ä¸€ä¸ªéšè—çš„ç”»ä¸­ç”»æŒ‰é’®](https://twitter.com/arnellebalane/status/1118537633548759041),åœ¨æˆ‘è¿›è¡Œè¿™ä¸ªå®éªŒä¹‹å‰ï¼Œæˆ‘è¿˜ä½¿ç”¨æœ¬æ–‡ä¸­ç›¸åŒçš„æŠ€æœ¯åœ¨[ä¸Šæ„å»ºäº†ä¸€ä¸ªæ¼”ç¤ºï¼Œåœ¨ç”»ä¸­ç”»çª—å£](https://twitter.com/arnellebalane/status/1134768178318303232)ä¸­æ˜¾ç¤ºéŸ³é¢‘å¯è§†åŒ–ã€‚

å¦‚æœä½ å·²ç»å¼€å‘/æ­£åœ¨å¼€å‘ä¸€äº›ä½¿ç”¨è¿™äº› API çš„ä¸œè¥¿ï¼Œæˆ–è€…çœ‹åˆ°å®ƒä»¬åœ¨é‡å¤–çš„ä¸€äº›ä»¤äººæƒŠå¹çš„ç”¨é€”ï¼Œè¯·åœ¨è¯„è®ºä¸­ä¸æˆ‘ä»¬åˆ†äº«ï¼Œæˆ‘å¾ˆä¹æ„å¬åˆ°å®ƒä»¬ï¼

## [](#resources)èµ„æº

*   [ç”»ä¸­ç”» API](https://blog.arnellebalane.com/the-picture-in-picture-api-30415372009f)
*   [ä½¿ç”¨å¼—æœ—ç´¢ç“¦Â·åšç¦ç‰¹çš„ç”»ä¸­ç”»](https://developers.google.com/web/updates/2018/10/watch-video-using-picture-in-picture)è§‚çœ‹è§†é¢‘
*   å®šåˆ¶åª’ä½“é€šçŸ¥å¹¶å¤„ç†æ’­æ”¾åˆ—è¡¨(åª’ä½“ä¼šè¯ API)