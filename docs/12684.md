# JavaScript ä¸­çš„æœåŠ¡äººå‘˜ç®€ä»‹

> åŸæ–‡:[https://dev . to/attacomsian/introduction-to-server-workers-in-JavaScript-1 EPA](https://dev.to/attacomsian/introduction-to-server-workers-in-javascript-1epa)

*æœ¬æ–‡æœ€åˆå‘è¡¨äº[attacomsian.com/blog](https://attacomsian.com/blog/service-workers-javascript)ã€‚*

* * *

æœåŠ¡äººå‘˜æ˜¯æ¸è¿›å¼ç½‘ç»œåº”ç”¨çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œè¿™äº›åº”ç”¨å…è®¸ç¼“å­˜èµ„æºå’Œ[ç½‘ç»œæ¨é€é€šçŸ¥](https://attacomsian.com/blog/desktop-notifications-javascript)ç­‰ï¼Œä»¥åˆ›å»ºæœ‰æ•ˆçš„ç¦»çº¿ä½“éªŒã€‚å®ƒä»¬å……å½“ web åº”ç”¨ç¨‹åºã€æµè§ˆå™¨å’Œç½‘ç»œä¹‹é—´çš„ä»£ç†ï¼Œå…è®¸å¼€å‘äººå‘˜æ‹¦æˆªå’Œç¼“å­˜ç½‘ç»œè¯·æ±‚ï¼Œå¹¶æ ¹æ®ç½‘ç»œçš„å¯ç”¨æ€§é‡‡å–é€‚å½“çš„æªæ–½ã€‚

ä¸€ä¸ªæœåŠ¡å·¥ä½œè€…åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸Šè¿è¡Œï¼Œæ‰€ä»¥å®ƒæ˜¯éé˜»å¡çš„ã€‚è¿™ä¹Ÿæ„å‘³ç€å®ƒä¸èƒ½è®¿é—®ä¸» JavaScript çº¿ç¨‹ä¸­å¯ç”¨çš„ [DOM](https://attacomsian.com/blog/getting-dom-elements-javascript) å’Œå…¶ä»– APIï¼Œå¦‚ cookiesã€XHRã€web å­˜å‚¨ API(æœ¬åœ°å­˜å‚¨å’Œä¼šè¯å­˜å‚¨)ç­‰ã€‚å› ä¸ºå®ƒä»¬è¢«è®¾è®¡æˆå®Œå…¨å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å®ƒä»¬å¤§é‡ä½¿ç”¨[æ‰¿è¯º](https://attacomsian.com/blog/promises-javascript)æ¥ç­‰å¾…ç½‘ç»œè¯·æ±‚çš„å“åº”ã€‚

> å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒæœåŠ¡äººå‘˜åªèƒ½åœ¨ HTTPS ä¸Šè¿è¡Œï¼Œä¸èƒ½åœ¨ç§äººæµè§ˆæ¨¡å¼ä¸‹ä½¿ç”¨ã€‚ç„¶è€Œï¼Œåœ¨è¿›è¡Œå®šä½è¯·æ±‚æ—¶ï¼Œæ‚¨ä¸éœ€è¦å®‰å…¨çš„è¿æ¥(å¯¹äºæµ‹è¯•æ¥è¯´å·²ç»è¶³å¤Ÿäº†)ã€‚

## [](#browser-support)æµè§ˆå™¨æ”¯æŒ

æœåŠ¡å·¥ä½œå™¨æ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒæ–°çš„ APIï¼Œåªå—ç°ä»£ç½‘ç»œæµè§ˆå™¨çš„æ”¯æŒã€‚å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯¥ API:

```
if('serviceWorker' in navigator) {
    // Supported ğŸ˜
} else {
    // Not supported ğŸ˜¥
} 
```

## [](#service-worker-registration)æœåŠ¡äººå‘˜ç™»è®°

åœ¨æˆ‘ä»¬å¼€å§‹ç¼“å­˜èµ„æºæˆ–æ‹¦æˆªç½‘ç»œè¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æµè§ˆå™¨ä¸­å®‰è£…ä¸€ä¸ªæœåŠ¡å·¥ä½œå™¨ã€‚å› ä¸ºæœåŠ¡å·¥ä½œè€…æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª JavaScript æ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æŒ‡å®šæ–‡ä»¶çš„è·¯å¾„æ¥æ³¨å†Œå®ƒã€‚è¯¥æ–‡ä»¶å¿…é¡»å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ï¼Œå¹¶ä¸”åº”è¯¥åªåŒ…å«æœåŠ¡äººå‘˜ä»£ç ã€‚

æ‚¨åº”è¯¥ç­‰åˆ°é¡µé¢åŠ è½½å®Œæ¯•ï¼Œç„¶åå°†æœåŠ¡å·¥ä½œè€…æ–‡ä»¶è·¯å¾„ä¼ é€’ç»™`navigator.serviceWorker.register()`æ–¹æ³•:

```
window.addEventListener('load', () => {
    if ('serviceWorker' in navigator) {
        // register service worker
        navigator.serviceWorker.register('/sw-worker.js').then(
            () => {
                console.log('SW registration succesful ğŸ˜');
            },
            err => {
                console.error('SW registration failed ğŸ˜ ', err)
            });
    } else {
        // Not supported ğŸ˜¥
    }
}); 
```

æ‚¨å¯ä»¥åœ¨æ¯æ¬¡åŠ è½½é¡µé¢æ—¶è¿è¡Œä¸Šè¿°ä»£ç ï¼Œè€Œä¸ä¼šé‡åˆ°ä»»ä½•éº»çƒ¦ï¼›æµè§ˆå™¨å°†å†³å®šæœåŠ¡äººå‘˜æ˜¯å¦å·²ç»å®‰è£…ï¼Œå¹¶ç›¸åº”åœ°è¿›è¡Œå¤„ç†ã€‚

## [](#service-worker-lifecycle)æœåŠ¡äººå‘˜ç”Ÿå‘½å‘¨æœŸ

æ³¨å†Œç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ä¸‰ä¸ªæ­¥éª¤:

1.  [è®¡] ä¸‹è½½
2.  å®‰è£…
3.  ä½¿æ´»åŠ¨

å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ‚¨çš„ç½‘ç«™æ—¶ï¼Œä¼šç«‹å³ä¸‹è½½æœåŠ¡äººå‘˜æ–‡ä»¶å¹¶å°è¯•å®‰è£…ã€‚å¦‚æœå®‰è£…æˆåŠŸï¼ŒæœåŠ¡äººå‘˜å°†è¢«æ¿€æ´»ã€‚åœ¨ç”¨æˆ·è®¿é—®å¦ä¸€ä¸ªé¡µé¢æˆ–åˆ·æ–°å½“å‰é¡µé¢ä¹‹å‰ï¼ŒæœåŠ¡äººå‘˜æ–‡ä»¶ä¸­çš„ä»»ä½•åŠŸèƒ½éƒ½ä¸å¯ç”¨ã€‚

## [](#browser-events)æµè§ˆå™¨äº‹ä»¶

ä¸€æ—¦å®‰è£…å¹¶æ¿€æ´»äº†æœåŠ¡å·¥ä½œå™¨ï¼Œå®ƒå°±å¯ä»¥å¼€å§‹æ‹¦æˆªç½‘ç»œè¯·æ±‚å¹¶ç¼“å­˜èµ„æºã€‚è¿™å¯ä»¥é€šè¿‡ç›‘å¬æœåŠ¡å·¥ä½œå™¨æ–‡ä»¶ä¸­æµè§ˆå™¨å‘å‡ºçš„äº‹ä»¶æ¥å®ç°ã€‚æµè§ˆå™¨å‘å‡ºä»¥ä¸‹äº‹ä»¶:

*   å®‰è£…ç»´ä¿®å·¥äººæ—¶å‘å‡º`install`ã€‚
*   `activate`åœ¨æœåŠ¡äººå‘˜æˆåŠŸæ³¨å†Œå’Œå®‰è£…åå‘é€ã€‚æ­¤äº‹ä»¶å¯ç”¨äºåœ¨å®‰è£…æ–°ç‰ˆæœ¬ä¹‹å‰ç§»é™¤è¿‡æ—¶çš„ç¼“å­˜èµ„æºã€‚
*   æ¯å½“ç½‘é¡µè¯·æ±‚ç½‘ç»œèµ„æºæ—¶å‘å‡º`fetch`ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿:ä¸€ä¸ªæ–°çš„ HTML æ–‡æ¡£ã€ä¸€ä¸ªå›¾åƒã€ä¸€ä¸ª JSON APIã€ä¸€ä¸ªæ ·å¼è¡¨æˆ– JavaScript æ–‡ä»¶ï¼Œä»»ä½•è¿œç¨‹ä½ç½®ä¸Šå¯ç”¨çš„ä¸œè¥¿ã€‚
*   å½“æ¥æ”¶åˆ°æ–°çš„æ¨é€é€šçŸ¥æ—¶ï¼Œç”±æ¨é€ API å‘é€ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªäº‹ä»¶å‘ç”¨æˆ·æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥ã€‚
*   è¿æ¥æ–­å¼€åï¼Œå½“æµè§ˆå™¨æ£€æµ‹åˆ°ç½‘ç»œå¯ç”¨æ—¶ï¼Œè°ƒç”¨`sync`ã€‚

## [](#serving-cached-resources)æä¾›ç¼“å­˜èµ„æº

å½“æœåŠ¡äººå‘˜æ­£åœ¨å®‰è£…ç¼“å­˜ç‰¹å®šèµ„æºæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬`install`äº‹ä»¶ï¼Œå½“æˆ‘ä»¬ä¸åœ¨ç½‘ç»œä¸­æ—¶ï¼Œå°†éœ€è¦è¿™äº›èµ„æºæ¥ä¸ºé¡µé¢æä¾›æœåŠ¡:

```
const CACHE_NAME = 'site-name-cache';

self.addEventListener('install', event => {
    event.waitUntil(
        caches
            .open(CACHE_NAME)
            .then(cache =>
                cache.addAll([
                    'favicon.ico',
                    'projects.json',
                    'style.css',
                    'index.js',
                    'https://fonts.googleapis.com/css?family=Open+Sans:400,700'
                ])
            )
    );
}); 
```

ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä½¿ç”¨ç¼“å­˜ API å°†èµ„æºå­˜å‚¨åœ¨åä¸º`site-name-cache`çš„ç¼“å­˜ä¸­ã€‚

> `self`æ˜¯ä¸€ä¸ªåªè¯»çš„å…¨å±€å±æ€§ï¼ŒæœåŠ¡äººå‘˜ä½¿ç”¨å®ƒæ¥è®¿é—®è‡ªå·±ã€‚

ç°åœ¨è®©æˆ‘ä»¬ç›‘å¬ä¸€ä¸ª`fetch`äº‹ä»¶æ¥æ£€æŸ¥æ‰€è¯·æ±‚çš„èµ„æºæ˜¯å¦å·²ç»å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œå¦‚æœæ‰¾åˆ°å°±è¿”å›:

```
// ...
self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request).then(response => {
            if (response) {
                //found cached resource
                return response;
            }
            return fetch(event.request);
        })
    );
}); 
```

æˆ‘ä»¬å¯»æ‰¾ç”±`request`å±æ€§æ ‡è¯†çš„èµ„æºçš„ç¼“å­˜æ¡ç›®ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæˆ‘ä»¬å‘å‡ºä¸€ä¸ª[è·å–è¯·æ±‚](https://attacomsian.com/blog/javascript-fetch-api)æ¥è·å–å®ƒã€‚å¦‚æœæ‚¨ä¹Ÿæƒ³ç¼“å­˜æ–°çš„è¯·æ±‚ï¼Œæ‚¨å¯ä»¥é€šè¿‡å¤„ç† fetch è¯·æ±‚çš„å“åº”ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
//...
self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request).then(response => {
            if (response) {
                //found cached resource
                return response;
            }

            // get resource and add it to cache
            return fetch(event.request)
                .then(response => {
                    // check if the response is valid
                    if (!response.ok) {
                        return response;
                    }

                    // clone the response
                    const newResponse = response.clone();

                    // add it to cache
                    caches.open(CACHE_NAME)
                        .then(cache =>
                            cache.put(event.request, newResponse)
                        );

                    // return response
                    return response;
                });
        })
    );
}); 
```

## [](#service-worker-update)æœåŠ¡äººå‘˜æ›´æ–°

å®‰è£…æœåŠ¡å·¥ä½œç¨‹åºåï¼Œå®ƒä¼šç»§ç»­è¿è¡Œï¼Œç›´åˆ°è¢«ç”¨æˆ·åˆ é™¤æˆ–æ›´æ–°ã€‚è¦æ›´æ–°æœåŠ¡äººå‘˜ï¼Œæ‚¨åªéœ€åœ¨æœåŠ¡å™¨ä¸Šä¸Šä¼ æœåŠ¡äººå‘˜æ–‡ä»¶çš„æ–°ç‰ˆæœ¬ã€‚å½“ç”¨æˆ·è®¿é—®ä½ çš„ç½‘ç«™æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æ–‡ä»¶çš„å˜åŒ–(å³ä½¿åªæœ‰ä¸€ä¸ªå­—èŠ‚å°±è¶³å¤Ÿäº†)ï¼Œå¹¶å®‰è£…æ–°ç‰ˆæœ¬ã€‚

å°±åƒç¬¬ä¸€æ¬¡å®‰è£…ä¸€æ ·ï¼Œåªæœ‰å½“ç”¨æˆ·å¯¼èˆªåˆ°å¦ä¸€ä¸ªé¡µé¢æˆ–åˆ·æ–°å½“å‰é¡µé¢æ—¶ï¼Œæ–°çš„æœåŠ¡äººå‘˜åŠŸèƒ½æ‰å¯ç”¨ã€‚

æˆ‘ä»¬èƒ½åšçš„ä¸€ä»¶äº‹æ˜¯ç›‘å¬`activate`äº‹ä»¶å¹¶ç§»é™¤æ—§çš„ç¼“å­˜èµ„æºã€‚ä¸‹é¢çš„ä»£ç é€šè¿‡éå†æ‰€æœ‰ç¼“å­˜å¹¶åˆ é™¤ä¸æˆ‘ä»¬çš„ç¼“å­˜åç§°ç›¸åŒ¹é…çš„ç¼“å­˜æ¥å®ç°è¿™ä¸€ç‚¹:

```
// ...
self.addEventListener('activate', event => {
    event.waitUntil(
        caches.keys().then(keys => {
            return Promise.all(
                keys.map(cache => {
                    if (cache === CACHE_NAME) {
                        return caches.delete(cache);
                    }
                })
            );
        })
    );
}); 
```

æœåŠ¡äººå‘˜ä»‹ç»å®Œæ¯•ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œè¯·æŸ¥é˜…[service worker Cookbook](https://serviceworke.rs/)â€”â€”è¿™æ˜¯ä¸€ä¸ªåœ¨ç°ä»£ç½‘ç«™ä¸­ä½¿ç”¨æœåŠ¡å·¥ä½œè€…çš„å®ç”¨ç¤ºä¾‹é›†ã€‚

* * *

âœŒï¸:æˆ‘å†™äº†å…³äºç°ä»£ JavaScriptã€Node.jsã€Spring Boot å’Œæ‰€æœ‰ web å¼€å‘çš„ä¸œè¥¿ã€‚ [**è®¢é˜…æˆ‘çš„ç®€è®¯**](https://attacomsian.com/newsletter) æ¯å‘¨è·å– web å¼€å‘æ•™ç¨‹& protipsã€‚

* * *

**å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Ÿ** [åœ¨æ¨ç‰¹ä¸Šå…³æ³¨@ attacomsian](https://twitter.com/attacomsian)ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ [LinkedIn](https://linkedin.com/in/attacomsian) å’Œ [DEV](https://dev.to/attacomsian) ä¸Šå…³æ³¨æˆ‘ã€‚