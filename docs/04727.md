# ç›‘è§† AWS EC2 å®ä¾‹çš„å†…å­˜å’Œç£ç›˜åº¦é‡

> åŸæ–‡:[https://dev . to/idrisrampurawala/monitoring-memory-and-disk-metrics-for-AWS-ec2-instances-2eg 2](https://dev.to/idrisrampurawala/monitoring-memory-and-disk-metrics-for-aws-ec2-instances-2eg2)

Amazon Web Services(AWS)é»˜è®¤ä¼šåœ¨æ§åˆ¶å°ä¸ŠæŠ¥å‘Šä¸€äº›å¥½çš„æŒ‡æ ‡ï¼Œæ¯”å¦‚ CPUï¼Œä½†ç¼ºå°‘ä¸€äº›å…³é”®æŒ‡æ ‡ï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨æƒ…å†µæˆ–ç£ç›˜ç©ºé—´ï¼›è¿™äº›å¯¹äºç›‘æ§ä»¥ç¡®ä¿å®ä¾‹æ­£å¸¸è¿è¡Œå’Œå¥åº·éå¸¸é‡è¦ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ [CloudWatch](https://aws.amazon.com/cloudwatch/) æ¥ç›‘æ§è¿™äº›æ‰©å±•çš„æŒ‡æ ‡ï¼Œå…è®¸æ‚¨æ„å»ºæŠ¥å‘Šã€ä»ªè¡¨æ¿å’Œè­¦æŠ¥ã€‚

**ğŸ“˜æ³¨æ„**
åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œè¯·æ³¨æ„æ ‡å‡†çš„äºšé©¬é€Š CloudWatch ä½¿ç”¨è´¹å°†é€‚ç”¨äºè¿™äº›è„šæœ¬ã€‚æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[äºšé©¬é€Šäº‘è§‚å¯Ÿ](https://aws.amazon.com/cloudwatch/pricing/)å®šä»·é¡µé¢ã€‚

âœ‹:ä¸ºäº†ç®€å•èµ·è§ï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬ä½¿ç”¨ EC2 å’Œ Amazon Linux æ“ä½œç³»ç»Ÿã€‚å¯¹äºå…¶ä»–æ“ä½œç³»ç»Ÿï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å„è‡ªçš„å‘½ä»¤æ¥å®ç°è¿™äº›ç»“æœã€‚

# [](#creating-an-iam-role-to-access-the-metrics)åˆ›å»º IAM è§’è‰²ä»¥è®¿é—®æŒ‡æ ‡

ä¸ºäº†å°†åº¦é‡æ•°æ®ä» EC2 ä¼ é€’åˆ° AWS Cloudwatchï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªå…·æœ‰ä»¥ä¸‹ IAM è§’è‰²è®¿é—®æƒé™çš„ç”¨æˆ·:

*   `cloudwatch:PutMetricData`
*   `cloudwatch:GetMetricStatistics`
*   `cloudwatch:ListMetrics`
*   `ec2:DescribeTags`

è¿·èŒ«äº†ï¼Ÿåªéœ€ç”¨ä¸Šè¿°æƒé™åˆ›å»ºä¸€ä¸ªç­–ç•¥(æ¯”å¦‚- cloudwatch-ec2-access)ã€‚ä¹‹åï¼Œåˆ›å»ºä¸€ä¸ªç”¨æˆ·(cloudwatch-stats-user)å¹¶å°†åˆ›å»ºçš„ç­–ç•¥(cloudwatch-ec2-access)é™„åŠ åˆ°è¯¥ç”¨æˆ·ã€‚æ­¤å¤–ï¼Œå­˜å‚¨è¯¥ç”¨æˆ·ç”Ÿæˆçš„`AWSAccessKeyId`å’Œ`AWSSecretKey`ï¼Œç¨åå°†ä¼šç”¨åˆ°å®ƒä»¬ã€‚

# [](#ssh-to-ec2)SSH åˆ° EC2

SSH åˆ°æ‚¨çš„ EC2 å®ä¾‹ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹æ­¥éª¤:

### [](#1-create-a-script-folder)1ã€‚åˆ›å»ºè„šæœ¬æ–‡ä»¶å¤¹

ä¸ºäº†æ¸…æ™°èµ·è§ï¼Œæˆ‘é€šå¸¸å–œæ¬¢æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹é‡Œï¼Œå°½ç®¡è¿™ä¸æ˜¯å¼ºåˆ¶æ€§çš„ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Amazon Linux 2 AMIï¼Œæ­¥éª¤çœ‹èµ·æ¥ç±»ä¼¼äºæ­¤:

```
# current folder /home/ec2-user
$ mkdir cloudwatch_logs
$ cd cloudwatch_logs 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#2-install-the-required-packages)2ã€‚å®‰è£…æ‰€éœ€çš„è½¯ä»¶åŒ…

ä¸ºäº†èƒ½å¤Ÿè¿è¡Œ AWS è„šæœ¬ï¼Œæˆ‘ä»¬å¿…é¡»å®‰è£…ä¸€äº›åŒ…ã€‚å¦å¤–ï¼Œè¯·æ³¨æ„ï¼Œè¯¥å‘½ä»¤å¯èƒ½ä¼šå› æ“ä½œç³»ç»Ÿè€Œå¼‚ã€‚æŸ¥çœ‹æ­¤[é“¾æ¥](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/mon-scripts.html)äº†è§£æ›´å¤šä¿¡æ¯ã€‚

```
sudo yum install -y perl-Switch perl-DateTime perl-Sys-Syslog perl-LWP-Protocol-https perl-Digest-SHA.x86_64 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#3-download-the-scripts-from-aws)3ã€‚ä» AWS ä¸‹è½½è„šæœ¬

ç°åœ¨æˆ‘ä»¬å·²ç»å®‰è£…äº†æ‰€æœ‰çš„åŒ…ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½ AWS æä¾›çš„ Perl è„šæœ¬ã€‚

```
curl https://aws-cloudwatch.s3.amazonaws.com/downloads/CloudWatchMonitoringScripts-1.2.2.zip -O 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#4-unzip-the-scripts)4ã€‚è§£å‹ç¼©è„šæœ¬

```
unzip CloudWatchMonitoringScripts-1.2.2.zip
# remove the zip
rm CloudWatchMonitoringScripts-1.2.2.zip
# move to the unzipped folder
cd aws-scripts-mon 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç›‘æ§è„šæœ¬åŒ…åŒ…å«ä»¥ä¸‹æ–‡ä»¶:

*   `CloudWatchClient.pm`â€“å…±äº« Perl æ¨¡å—ï¼Œç®€åŒ–äº†ä»å…¶ä»–è„šæœ¬è°ƒç”¨ Amazon CloudWatchã€‚
*   `mon-put-instance-data.pl`â€“æ”¶é›† Amazon EC2 å®ä¾‹çš„ç³»ç»ŸæŒ‡æ ‡(å†…å­˜ã€äº¤æ¢ç©ºé—´ã€ç£ç›˜ç©ºé—´åˆ©ç”¨ç‡)ï¼Œå¹¶å°†å®ƒä»¬å‘é€åˆ° Amazon CloudWatchã€‚
*   `mon-get-instance-stats.pl`â€“æŸ¥è¯¢ Amazon CloudWatch å¹¶æ˜¾ç¤ºæ‰§è¡Œè¯¥è„šæœ¬çš„ EC2 å®ä¾‹çš„æœ€æ–°åˆ©ç”¨ç‡ç»Ÿè®¡æ•°æ®ã€‚
*   `awscreds.template`â€“å­˜å‚¨æ‚¨çš„è®¿é—®å¯†é’¥ ID å’Œç§˜å¯†è®¿é—®å¯†é’¥çš„ AWS å‡­è¯çš„æ–‡ä»¶æ¨¡æ¿ã€‚
*   `LICENSE.txt`â€“åŒ…å« Apache 2.0 è®¸å¯è¯çš„æ–‡æœ¬æ–‡ä»¶ã€‚
*   `NOTICE.txt`â€“ç‰ˆæƒå£°æ˜ã€‚

### [](#5-add-raw-access-id-endraw-and-raw-secret-key-endraw-of-cloudwatch-user-cloudwatchstatsuser)5ã€‚æ·»åŠ äº‘è§‚å¯Ÿç”¨æˆ·(cloudwatch-stats-user)çš„`Access ID`å’Œ`Secret Key`

æ­£å¦‚å‰é¢æåˆ°çš„ï¼Œamazon æä¾›äº†ä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶`awscreds.template`ï¼Œå®ƒå¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ª`conf`æ–‡ä»¶æ¥å­˜å‚¨ AWS å‡­è¯ã€‚

```
# creates a conf file from the template. Make sure the filename is as is
cp awscreds.template awscreds.conf 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æ·»åŠ  AWS `Access ID`å’Œ`secret key`å¹¶ä¿å­˜å®ƒã€‚

### [](#6-verify-if-statistics-are-captured-correctly)6ã€‚éªŒè¯ç»Ÿè®¡æ•°æ®æ˜¯å¦è¢«æ­£ç¡®æ•è·

ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥éªŒè¯ä¸€åˆ‡æ˜¯å¦å°±ç»ªå¹¶é¡ºåˆ©å·¥ä½œ:

```
# change the paths according to your folder structure
/home/ec2-user/cloudwatch_logs/aws-scripts-mon/mon-put-instance-data.pl --mem-used-incl-cache-buff --mem-util --mem-used --mem-avail --disk-space-util --disk-space-avail --disk-path=/ --verify --verbose 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#7-final-step)7ã€‚æœ€åä¸€æ­¥

æ­å–œä½ ï¼ğŸ‘æ‚¨å·²ç»åœ¨ EC2 å®ä¾‹ä¸ŠæˆåŠŸé…ç½®äº† Cloudwatch æŒ‡æ ‡ã€‚ç°åœ¨ï¼Œæœ€åä¸€æ­¥æ˜¯å°†å®ƒæ·»åŠ åˆ° cronï¼Œè¿™æ ·å®ƒå¯ä»¥æ¯éš” 5 åˆ†é’Ÿå‘é€ä¸€æ¬¡æŒ‡æ ‡ã€‚

```
# Open the crontab file
crontab -e

# Add the following line and save it

# Cloudwatch Monitoring Metrics (AWS)
*/5 * * * * /home/ec2-user/cloudwatch_logs/aws-scripts-mon/mon-put-instance-data.pl --mem-used-incl-cache-buff --mem-util --mem-used --mem-avail --disk-space-util --disk-space-avail --disk-path=/ --from-cron 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#where-to-find-these-metrics-on-aws)åœ¨ AWS ä¸Šå“ªé‡Œå¯ä»¥æ‰¾åˆ°è¿™äº›æŒ‡æ ‡ï¼Ÿ

åœ¨ AWS æ§åˆ¶å°ä¸­ï¼Œè½¬åˆ° Cloudwatch æœåŠ¡ã€‚
[![AWS Cloudwatch Console](../Images/bdee6da75d4ba2c5ca20f31b6513abaa.png)T3ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s---gQzT8RR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://res.cloudinary.com/idr/image/upload/v1567136936/dev.to/cloudwatch_screen_1_jc48in.png)

æ‚¨çš„æ‰€æœ‰æŒ‡æ ‡éƒ½å¯ä»¥åœ¨`Metrics`èœå•ä¸­æ‰¾åˆ°ã€‚ä¸€æ—¦ Cloudwatch å¼€å§‹ä»è„šæœ¬æ¥æ”¶æŒ‡æ ‡ï¼Œä¸€ä¸ªæ–°çš„`Custom Namespaces`å°†è¢«æ·»åŠ åˆ°æ‚¨çš„æŒ‡æ ‡è§†å›¾ä¸­ã€‚
T3![AWS Cloudwatch Custom Metrics](../Images/c7b47e2fdbd09b7ac2288fde163e2e65.png)T5ã€‘

ç‚¹å‡»å®ƒï¼Œä½ ä¼šå¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ 2 ä¸ªé€‰é¡¹:
[![AWS Cloudwatch Custom Metrics Options](../Images/bcee078b22ce94576b81a873867de339.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--UA0fmrFJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://res.cloudinary.com/idr/image/upload/v1567136936/dev.to/cloudwatch_screen_3_wcxzhs.png)

1.  `Filesystem, InstanceId, MountPath` -æ‚¨çš„æ‰€æœ‰ EC2 ç£ç›˜æŒ‡æ ‡éƒ½å°†åœ¨æ­¤é€‰é¡¹ä¸­å¯ç”¨ã€‚
2.  `InstanceId` -æ‚¨çš„æ‰€æœ‰ EC2 å†…å­˜æŒ‡æ ‡å°†åœ¨æ­¤é€‰é¡¹ä¸­å¯ç”¨ã€‚

# [](#points-to-remember)ç‚¹è®°

*   æ¯å½“æ‚¨é‡æ–°å¯åŠ¨æˆ–åˆ†é…/å–æ¶ˆåˆ†é…ç£ç›˜ç©ºé—´æ—¶ï¼Œæ‚¨çš„ EC2 ç£ç›˜æ–‡ä»¶ç³»ç»Ÿè·¯å¾„å¯èƒ½ä¼šæ”¹å˜ï¼Œå› æ­¤æ‚¨å¯èƒ½éœ€è¦é‡æ–°é…ç½®æ‚¨ä¸ºç›‘æ§ EC2 è€Œåˆ›å»ºçš„ä»»ä½•è­¦æŠ¥æˆ–ä»ªè¡¨æ¿ã€‚
*   å¦‚æœæ‚¨å·²ç»ä»é…ç½®äº†è¿™äº›æŒ‡æ ‡çš„ AMI å¯åŠ¨äº† EC2 å®ä¾‹ï¼Œé‚£ä¹ˆä¸Šé¢çš„è®¾ç½®å·²ç»å­˜åœ¨ã€‚åªéœ€é€šè¿‡å‘½ä»¤`rm /var/tmp/aws-mon/instance-id`æ¸…é™¤ç¼“å­˜
*   AWS æœ€è¿‘æ¨å‡ºäº†`CloudWatch Agent`æ¥ä» Amazon EC2 å®ä¾‹ä¸­æ”¶é›†ç³»ç»ŸæŒ‡æ ‡å’Œæ—¥å¿—æ–‡ä»¶ã€‚å› æ­¤ï¼Œå»ºè®®ä½¿ç”¨`CloudWatch Agent`æ¥æ”¶é›†æŒ‡æ ‡å’Œæ—¥å¿—ï¼Œè€Œä¸æ˜¯è¿™äº›ç›‘æ§è„šæœ¬ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨è¿™äº›ç›‘æ§è„šæœ¬ï¼Œè¿™ç¯‡æ–‡ç« å¯èƒ½ä¼šå¸®åŠ©ä½ é…ç½®å®ƒã€‚

æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ã€‚å†è§ï¼ç›´åˆ°æˆ‘çš„ä¸‹ä¸€ç¯‡æ–‡ç« ğŸ˜‹