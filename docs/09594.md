# æ­å¼€ç¼–ç¨‹è¯­è¨€çš„ç¥ç§˜é¢çº±

> åŸæ–‡ï¼š<https://dev.to/stereobooster/programming-language-to-write-or-not-to-write-1aci>

ç¼–ç¨‹è¯­è¨€(PL)è¢«è§†ä¸ºä¸€ç§å®—æ•™ã€‚äººä»¬å›´ç»•ç€ PL æœ‰ç¥åœ£çš„æˆ˜äº‰ã€‚äººä»¬æ··æ·†äº†èŒƒå¼å’Œè¯­è¨€ã€‚

> ä»»ä½•è¶³å¤Ÿå…ˆè¿›çš„æŠ€æœ¯éƒ½å’Œé­”æ³•æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚
> 
> -å…‹æ‹‰å…‹ç¬¬ä¸‰å®šå¾‹

ä½ å¯èƒ½æƒ³å†™ä¸€ä¸ªç¼–ç¨‹è¯­è¨€æ¥æ­å¼€å®ƒçš„ç¥ç§˜é¢çº±ã€‚ç¼–ç¨‹è¯­è¨€åªæ˜¯ä¸€ç§å·¥å…·ã€‚

## å­¦ä¹ é”»ç‚¼

ä¸è¦æŠŠå®ƒæƒ³æˆæ˜¯ä½ åœ¨å·¥ä½œä¸­ä½¿ç”¨çš„è¯­è¨€ï¼Œæˆ–è€…æ˜¯ç”Ÿäº§ä¸­ä¼šç”¨åˆ°çš„ä¸œè¥¿ï¼Œè€Œæ˜¯æŠŠå®ƒå½“æˆä¸€æ¬¡å­¦ä¹ ç»å†ã€‚ä¸»è¦çš„æ”¶è·æ˜¯ç†è§£ç¼–ç¨‹è¯­è¨€èƒŒåçš„é€»è¾‘ï¼Œè€Œä¸æ˜¯ç¼–å†™é«˜æ€§èƒ½æˆ–è¯¦å°½çš„å®ç°ã€‚

è¿™é¡¹å·¥ä½œéµå¾ªä¸¤ä¸ªåŸåˆ™:

*   [ç™½æ‰‹èµ·å®¶](https://stereobooster.com/posts/about-learning/#building-from-scratch)
*   [â€œé—®é¢˜ä¼˜å…ˆâ€æ–¹æ³•](https://stereobooster.com/posts/about-learning/#problem-first-approach)

## ä»€ä¹ˆï¼Ÿ

æˆ‘ä»¬è¦å†™ä»€ä¹ˆæ ·çš„è¯­è¨€ï¼Ÿå£é½¿ä¼¶ä¿ã€‚ç­‰ç­‰ï¼Œä¸è¦å…³é—­æµè§ˆå™¨ã€‚å¬æˆ‘è¯´å®Œã€‚æˆ‘å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆã€‚

æ­£å¦‚æˆ‘æ‰€è¯´çš„ï¼Œè¿™æ˜¯å­¦ä¹ ç»ƒä¹ ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸“æ³¨äºç¼–ç¨‹è¯­è¨€æœ¬èº«çš„é€»è¾‘ï¼Œæˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½åœ°æ¶ˆé™¤å¤æ‚æ€§ã€‚æˆ‘ä»¬ä¸æƒ³åœ¨åˆ†è¯å™¨ã€è¯æ³•åˆ†æå™¨ã€è§£æå™¨ã€ç¼–è¯‘å™¨ç­‰ä¸Šé¢æµªè´¹æ—¶é—´ã€‚æˆ‘ä»¬æƒ³æ·±å…¥æ ¸å¿ƒã€‚Lisp éå¸¸é€‚åˆè¿™ä¸ªç›®çš„ï¼Œå› ä¸ºå®ƒå‡ ä¹æ²¡æœ‰è¯­æ³•ï¼Œè¿™æ„å‘³ç€ä¸ºå®ƒå®ç°ä¸€ä¸ªè§£æå™¨éå¸¸å®¹æ˜“ã€‚

è§£æå™¨æœ€ç®€å•çš„å®ç°åªæœ‰ä¸€ç§è§£æé”™è¯¯â€”â€”æ²¡æœ‰åŒ¹é…çš„æ‹¬å·ã€‚

### ä½†æ˜¯æ‹¬å·

ä¸éœ€è¦ç”¨ Lisp å†™å¾ˆé•¿çš„ç¨‹åºã€‚æˆ‘ä»¬å°†å®ç°å®ƒçš„æœ€å°å­é›†ã€‚æ‰€ä»¥æ‹¬å·çš„æ•°é‡æ˜¯å¯ä»¥æ¥å—çš„ã€‚

ä¸è¦å¿˜è®°æ‹¬å·çš„é€‰æ‹©æ˜¯ä»»æ„çš„:

```
// Lisp
(a b)
// C-like
a(b)
// Ruby
c.a b
c.a(b)
c.send(:a, b)
// Lua
c.a(c, b)
c:a(b) 
```

## å¦‚ä½•ï¼Ÿ

æˆ‘ä»¬å°†å®ç°å°½å¯èƒ½å°‘çš„ç±»ä¼¼ Lisp çš„è¯­è¨€ï¼Œå¹¶æ ¹æ®éœ€è¦æ‰©å±•å®ƒã€‚æˆ‘ä»¬å°†ç”¨ JavaScript å®ç°å®ƒã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºå¦‚æœä½ ç”¨ç½‘ç»œæµè§ˆå™¨é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œè¿™æ„å‘³ç€ä½ çš„æœºå™¨ä¸Šå·²ç»æœ‰ JS äº†ã€‚

### æ²¡æœ‰è£…é…ï¼Ÿæ²¡æœ‰ç¼–è¯‘å™¨ï¼Ÿ

æœ‰äº›äººå¯èƒ½ä¼šå¯¹æˆ‘ä»¬åœ¨å¦ä¸€ä¸ª PL ä¸­å®ç°ä¸€ä¸ª PL æ„Ÿåˆ°å›°æƒ‘ã€‚ä¸æ˜¯å‡ºè½¨å—ï¼Ÿä¸åº”è¯¥åšç¼–è¯‘å™¨å—ï¼Ÿè¿˜æ˜¯ç”¨æ±‡ç¼–ï¼Ÿ

è¿™é‡Œçš„æŠ€å·§æ˜¯ï¼Œå¦‚æœä½ å¯ä»¥ç”¨å›¾çµå®Œæ•´è¯­è¨€å®ç°æŸä¸ªä¸œè¥¿ï¼Œä½ å°±å¯ä»¥(ç†è®ºä¸Š)ç§»æ¤åˆ°ä»»ä½•å…¶ä»–å›¾çµæœºä¸Š(è¿™æ˜¯å› ä¸ºä½ å¯ä»¥åœ¨å¦ä¸€ä¸ªå›¾çµæœºä¸­å®ç°ä¸€ä¸ªå›¾çµæœºâ€”â€”ä¸€è·¯å‘ä¸‹)ã€‚

ç”¨ä¸€ä¸ª PL å®ç°å¦ä¸€ä¸ª PL æ˜¯å¯ä»¥çš„ã€‚

## è®©æˆ‘ä»¬è¯•è¯•å§

è¿™ä¸ªå¸–å­çš„çµæ„Ÿæ¥æºäº[(å¦‚ä½•ç”¨ Python å†™ä¸€ä¸ª(Lisp)è§£é‡Šå™¨)](https://norvig.com/lispy.html)ã€‚åŸå¸–æŒºå¥½çš„ï¼Œå¯ä»¥çœ‹çœ‹é‚£ä¸ªã€‚æˆ‘çš„è§£é‡Šå’ŒåŸè§£é‡Šçš„ä¸»è¦åŒºåˆ«æ˜¯æˆ‘å¦‚ä½•åˆ’åˆ†ææ–™ã€‚æˆ‘è¿™æ ·åšæ˜¯ä¸ºäº†æ¸…æ¥šåœ°å±•ç¤ºå‘è¯­è¨€ä¸­æ·»åŠ æ¯ä¸ªæ–°ç‰¹æ€§éœ€è¦åšäº›ä»€ä¹ˆã€‚

ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†å®ç°è®¡ç®—å™¨è¯­è¨€ã€‚å®ƒå°†æä¾›`+`ã€`-`è¿ç®—å’Œæ•°å€¼ã€‚çœ‹èµ·æ¥ä¸å¤šï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šå­¦åˆ° REPLã€æ ‡è®°åŒ–ã€è§£æã€AST å’Œè¯„ä¼°ã€‚

### ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Ÿ

ç¼–ç¨‹è¯­è¨€è¿è¡Œæ—¶(åˆåè§£é‡Šå™¨)æ‰§è¡Œä»¥ä¸‹æ­¥éª¤:

1.  è¯»å–ç¨‹åºçš„æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼Œä»æ–‡ä»¶ç³»ç»Ÿæˆ–å…¶ä»–è¾“å…¥ä¸­è¯»å–
2.  è§£ææ–‡æœ¬â€”â€”å°†æ–‡æœ¬è½¬æ¢ä¸ºå†…éƒ¨è¡¨ç¤ºå½¢å¼ï¼Œç„¶åè¿›è¡Œè®¡ç®—
3.  è¯„ä¼°(æ‰§è¡Œ)æŒ‡ä»¤

### è¯„ä»·

è®¡ç®—å™¨è¯­è¨€çš„æ±‚å€¼ä¸è®¡ç®—æ˜¯ä¸€æ ·çš„ï¼Œä½†å¯¹äºæ›´å¤æ‚çš„è¯­è¨€æ±‚å€¼ä¹Ÿæ„å‘³ç€å®ƒå°†ä½¿è®¡ç®—æœºåšå…¶ä»–äº‹æƒ…ï¼Œå¦‚ä»è¾“å…¥ä¸­è¯»å–ã€æ‰“å°åˆ°è¾“å‡ºã€å‘å‡ºå£°éŸ³ã€ä½¿ç¯é—ªçƒç­‰ã€‚

ä¾‹å¦‚ï¼Œ`5 - (2 + 1)`è¯„ä¼°ä¸º`2`ã€‚ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦è¯„ä¼°`(2 + 1)`åˆ°`3`ï¼Œç„¶åå†è¯„ä¼°`5 - 3`åˆ°`2`ã€‚

è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªå°ç¨‹åºã€‚è¯¥ç¨‹åºç”±å°æŒ‡ä»¤(æ­¥éª¤)ç»„æˆï¼Œè®¡ç®—æœºå¯ä»¥é€ä¸ªæˆ–å¹¶è¡Œè¯„ä¼°è¿™äº›æŒ‡ä»¤ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†å‡è®¾æŒ‡ä»¤è¢«ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œã€‚

ç¨‹åºæ–‡æœ¬ä¸­çš„æŒ‡ä»¤å¹¶ä¸æ€»æ˜¯æŒ‰ç…§å®ƒä»¬åœ¨ç¨‹åºä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œï¼Œä¾‹å¦‚`-`åœ¨`+`ä¹‹å‰ï¼Œä½†æ˜¯å®ƒåœ¨ç¬¬äºŒä¸ªæ‰§è¡Œã€‚

> å¥æ³•-è§„å®šè®¡ç®—æœºè¯­è¨€ä¸­å•è¯å’ŒçŸ­è¯­å¿…é¡»å¦‚ä½•ä½¿ç”¨çš„è§„åˆ™ã€‚
> 
> [ç‰›æ´¥å­¦ä¹ è¯å…¸](https://www.oxfordlearnersdictionaries.com/definition/english/syntax)

æ‰§è¡Œé¡ºåºç”±è¯­æ³•å†³å®šã€‚å½“ä¸€ç§è¯­è¨€æœ‰æµæ§åˆ¶æŒ‡ä»¤æ—¶ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼ä¼šæœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæ‰§è¡Œé¡ºåºå®Œå…¨ç”±è¯­æ³•è§„åˆ™å†³å®šã€‚

æ‰§è¡Œçš„é¡ºåºå¾ˆé‡è¦ï¼Œå› ä¸º`5 - (2 + 1)`æ˜¯`2`ï¼Œä½†æ˜¯`5 - 2 + 1`æ˜¯`4`ã€‚

### Lisp è¯­æ³•

è¿™æ˜¯æ ‡å‡†çš„ç®—æœ¯ç¬¦å·:`5 - (2 + 1)`ã€‚Lisp ä¸­åŒæ ·çš„ä¾‹å­ä¼šæ˜¯è¿™æ ·çš„:`(- 5 (+ 2 1))`ã€‚

é¦–å…ˆï¼Œè¿™å¯èƒ½ä¼šè®©ä½ æ„Ÿåˆ°å›°æƒ‘ï¼Œä½†è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä»ä¸€ä¸ªè½¬æ¢åˆ°å¦ä¸€ä¸ª:

1.  åŠ æ‹¬å·(ä¸æ”¹å˜æ„æ€):`5 - (2 + 1)`â€”â€”>â€”â€”T1ã€‚
2.  ç”±ä¸­ç¼€ç¬¦å·æ”¹ä¸ºå‰ç¼€ç¬¦å·:`(5 - (2 + 1))`->-T1ã€‘

ä¸­ç¼€ç¬¦å·-å½“å‡½æ•°å(`+`ï¼Œ`-`)ï¼›ä¹Ÿå¯ä»¥ç§°ä¸ºæ“ä½œ)ä½äºå‡½æ•°çš„è‡ªå˜é‡ä¹‹é—´(ä¹Ÿå¯ä»¥ç§°ä¸ºæ“ä½œæ•°)ï¼Œä¾‹å¦‚`a + b`ã€‚

å‰ç¼€ç¬¦å·â€”â€”å½“å‡½æ•°åä½äºå‚æ•°ä¹‹å‰æ—¶ï¼Œä¾‹å¦‚ï¼Œ`+ a b`ã€‚

è¿™ä¸ªè¯­æ³•æœ‰ä¸€äº›æ‰©å±•ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸éœ€è¦å®ƒä»¬ç”¨äºè®¡ç®—å™¨ã€‚

### è§£æ

è§£ææ˜¯å°†æ–‡æœ¬è½¬æ¢ä¸ºå†…éƒ¨è¡¨ç¤º(å³æ‰€è°“è¯­æ³•æ ‘)çš„è¿‡ç¨‹ã€‚

æ ‘æ˜¯æ•°æ®ç»“æ„ã€‚è¯­æ³•æ ‘æ„å‘³ç€å®ƒæ˜¯æ ¹æ®è¯­æ³•è§„åˆ™å»ºç«‹çš„ã€‚

æ•°æ®ç»“æ„æ˜¯æˆ‘ä»¬(å¼€å‘äººå‘˜)åœ¨è®¡ç®—æœºå†…éƒ¨ç»„ç»‡æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚ä¾‹å¦‚:

*   å•ä¸€å€¼ã€‚ççš„å‡ºç”Ÿå¹´ä»½æ˜¯`2000`
*   åˆ—è¡¨ã€‚æˆ‘çš„é˜Ÿå‹çš„å‡ºç”Ÿå¹´ä»½æ˜¯`2000, 2001, 2002`
*   è®°å½•ã€‚æˆ‘çš„é˜Ÿå‹çš„å‡ºç”Ÿå¹´ä»½æ˜¯`Jen: 2000, Ben: 2001, Ken: 2002`

æ ‘æ˜¯ç»„ç»‡åˆ†å±‚æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œæ–‡ä»¶ç³»ç»Ÿ(æ²¡æœ‰é“¾æ¥)æ˜¯ä¸€æ£µæ ‘

```
home
 â”œ My documents
 â”‚ â”” Picture.jpg
 â”œ My music
 â”” My videos 
```

å¯ä»¥ç”¨åµŒå¥—åˆ—è¡¨(åˆ—è¡¨ä¸­çš„åˆ—è¡¨)æ¥å®ç°æ ‘ã€‚JavaScript ä¸­çš„æ•°ç»„æ˜¯ä¸€ç§è¡¨ç¤ºåˆ—è¡¨çš„æ–¹å¼(ä¸æ˜¯é“¾è¡¨ï¼Œè€Œæ˜¯ä¸€èˆ¬æ„ä¹‰ä¸Šçš„åˆ—è¡¨çš„æ¦‚å¿µ)ã€‚

```
const list = [2000, 2001, 2002];
const tree = [
  "home",
  [["My documents", ["Picture.jpg"]], "My music", "My videos"]
]; 
```

> æ ‘æ˜¯ç”±æœ‰å‘è¾¹è¿æ¥çš„èŠ‚ç‚¹çš„é›†åˆã€‚
> 
> *   ä¸€ä¸ªèŠ‚ç‚¹è¢«åŒºåˆ†ä¸ºæ ¹ï¼›
> *   æ¯ä¸ªèŠ‚ç‚¹(é™¤äº†æ ¹ä¹‹å¤–)éƒ½ç”±æ¥è‡ªæ°å¥½ä¸€ä¸ªå…¶å®ƒèŠ‚ç‚¹æœ‰å‘è¾¹è¿æ¥ï¼›ä¸€ä¸ªæ–¹å‘æ˜¯:çˆ¶->å­
> 
> -[15-111 ä¸­é«˜çº§ç¼–ç¨‹åœ¨çº¿æ•™æ](http://www.cs.cmu.edu/~clo/www/CMU/DataStructures/Lessons/lesson4_1.htm)

é€šè¿‡è§£æä¸‹é¢çš„ç¨‹åº

```
(- 5
 (+ 2 1)) 
```

æˆ‘ä»¬å°†å¾—åˆ°ä¸‹é¢çš„(æŠ½è±¡çš„)è¯­æ³•æ ‘:

```
["-", 5, ["+", 2, 1]]; 
```

è¯­æ³•æ ‘æœ‰ä¸¤ç§é£æ ¼:æŠ½è±¡çš„å’Œå…·ä½“çš„ã€‚åœ¨ AST(æŠ½è±¡è¯­æ³•æ ‘)ä¸­ï¼Œæˆ‘ä»¬åˆ é™¤ä¸æ”¹å˜ç¨‹åºå«ä¹‰çš„ç»†èŠ‚ï¼Œä¾‹å¦‚ï¼Œç©ºç™½å’Œæ–°è¡Œï¼Œä½†åœ¨ CST ä¸­ï¼Œè¿™äº›ä¿¡æ¯è¢«ä¿ç•™ä¸‹æ¥ã€‚å½“æ‚¨æƒ³è¦æ“ä½œæºä»£ç ä½†ä¿ç•™æ ¼å¼æ—¶ï¼Œæ‚¨å¯èƒ½éœ€è¦ CSTï¼Œä¾‹å¦‚ï¼Œåœ¨ IDE ä¸­è¿›è¡Œâ€œé‡æ„â€ï¼Œå¦‚é‡å‘½åå˜é‡ã€‚

### æ ‡è®°åŒ–

æ ‡è®°åŒ–å¯ä»¥æ˜¯è§£æçš„å­æ­¥éª¤ä¹‹ä¸€ã€‚è®°å·åŒ–æ˜¯å°†ç¨‹åºæ–‡æœ¬è½¬æ¢æˆè®°å·åˆ—è¡¨(å•è¯å’Œæ ‡ç‚¹ç¬¦å·)çš„æ–¹æ³•ã€‚ç„¶åè§£æå™¨å¯ä»¥ä»åˆ—è¡¨(æˆ–æµ)ä¸­è¯»å–æ ‡è®°ï¼Œå¹¶ä»ä¸­åˆ›å»º ASTã€‚

tokenistation å°†è½¬æ¢

```
(- 5 (+ 2 1)) 
```

è‡³

```
["(", "-", "5", "(", "+", "2", "1", ")", ")"]; 
```

è¿™ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†æ˜¯è¿™ä¸ªå­æ­¥éª¤ä¼šä½¿è§£æå˜å¾—æ›´å®¹æ˜“ä¸€äº›ã€‚

### å®ç°è§£æå™¨

ä»¤ç‰ŒåŒ–å™¨çš„ç®€å•(éæœ€ä½³)å®ç°:

*   è·å–æ–‡æœ¬(JS ä¸­çš„å­—ç¬¦ä¸²)
*   å°†æ‰€æœ‰æ‹¬å·(`(`ã€`)`)æ›¿æ¢ä¸ºç”±ç©ºæ ¼(`(`ã€`)`)åŒ…å›´çš„æ‹¬å·
*   ç”¨ä¸€ä¸ªç©ºæ ¼æ›¿æ¢ä»»æ„æ•°é‡çš„åç»­ç±»ç©ºæ ¼å­—ç¬¦(åˆ¶è¡¨ç¬¦ã€ç©ºæ ¼ã€æ¢è¡Œç¬¦)
*   æŒ‰ç©ºé—´åˆ†å‰²

```
// Convert a string of characters into a list of tokens.
const tokenize = program =>
  program
    .replace(/\(/g, " ( ")
    .replace(/\)/g, " ) ")
    .replace(/^\s+|\s+$/g, "")
    .split(/\s+/g); 
```

æµ‹è¯•å®ƒ:

```
const assert = require("assert");
const program = "(- 5 (+ 2 1))";
assert.deepStrictEqual(tokenize(program), [
  "(",
  "-",
  "5",
  "(",
  "+",
  "2",
  "1",
  ")",
  ")"
]); 
```

è§£æå™¨çš„ç®€å•(éæœ€ä½³)å®ç°:

*   `tokens_to_ast`å¸¸è§„
*   æ‹¿ä¸€å¼ ä»£å¸æ¸…å•
*   ä»åˆ—è¡¨ä¸­é€‰æ‹©ç¬¬ä¸€ä¸ª(`shift`)
*   æ£€æŸ¥æ˜¯å¦æ˜¯`(`ï¼Œå¦‚æœæ˜¯
*   å¼€å§‹ä¸€ä¸ªæ–°çš„åˆ—è¡¨(JS æƒ…å†µä¸‹çš„æ•°ç»„ï¼Œ`let L = [];`)
*   ç”¨å‰©ä½™çš„ä»£å¸æ‰“ç”µè¯ç»™`tokens_to_ast`
*   å°†(`push`)ç»“æœæ”¾å…¥æ–°åˆ›å»ºçš„åˆ—è¡¨(`L`)ä¸­
*   é‡å¤ç›´åˆ°åˆ°è¾¾`)`
*   ä½œä¸ºä¾‹ç¨‹æ‰§è¡Œç»“æœçš„è¿”å›åˆ—è¡¨(`L`)
*   å¦‚æœä¸æ˜¯`(`
*   æ£€æŸ¥æ˜¯å¦æ˜¯`)`ï¼Œè¿™æ˜¯ä¸€ä¸ªé”™è¯¯ç¨‹åºä¸èƒ½ç”¨`)`å¯åŠ¨
*   æ£€æŸ¥æ˜¯å¦æ˜¯å·ç `if (!isNaN(parseFloat(token))) {`
*   å¦‚æœæ˜¯ï¼Œè¿”å›å·ç 
*   å¦åˆ™ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²(å­—ç¬¦ä¸²æ˜¯ä¸€æ®µæ–‡æœ¬)ã€‚åœ¨ Lisp ä¸­ï¼Œä»–ä»¬ç§°ä¹‹ä¸ºç¬¦å·æˆ–åŸå­ï¼Œä½†åœ¨ JS ä¸­æˆ‘ä»¬å°†ä½¿ç”¨å­—ç¬¦ä¸²ã€‚

```
const parse = program => tokens_to_ast(tokenize(program));

const tokens_to_ast = tokens => {
  if (tokens.length === 0) {
    throw new SyntaxError("Can't parse empty program");
  }
  const token = tokens.shift();
  if (token === "(") {
    let L = [];
    while (tokens[0] !== ")") {
      L.push(tokens_to_ast(tokens));
    }
    tokens.shift(); // pop off ')'
    return L;
  } else if (token === ")") {
    throw new SyntaxError("Unexpected closing parenthesis");
  } else if (!isNaN(parseFloat(token))) {
    // Numbers become numbers
    return parseFloat(token);
  } else {
    // every other token is a symbol or an atom
    // for simplicity we use strings
    return token;
  }
}; 
```

è§£æå™¨æµ‹è¯•

```
assert.deepStrictEqual(parse(program), ["-", 5, ["+", 2, 1]]); 
```

### å®ç°è¯„ä»·è€…

è®©æˆ‘ä»¬æƒ³æƒ³è¯„ä¼°ä»¥ä¸‹ç¨‹åºéœ€è¦ä»€ä¹ˆ:`(+ 2 2)`å’Œ`(- 2 2)`ã€‚æˆ‘ä»¬éœ€è¦å– ASTï¼Œåœ¨å‡½æ•°åï¼Œç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå‚æ•°ä¸­ææ„å®ƒï¼Œç„¶åæ ¹æ®å‡½æ•°åè¿›è¡Œè®¡ç®—:

```
const evaluate = ast => {
  // function call handling
  let [name, first, second] = ast;
  if (name === "+") {
    return first + second;
  } else if (name === "-") {
    return first - second;
  } else {
    // runtime error
    throw new Error(`${name} is not a function`);
  }
}; 
```

ä½†æ˜¯è¯¥è¯„ä¼°å™¨ä¸èƒ½å¤„ç†ä»¥ä¸‹æƒ…å†µ:`(+ 2 (+ 2 2))`ã€‚å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥å¤„ç†åµŒå¥—è¡¨è¾¾å¼ï¼Œä¾‹å¦‚`(+ 2 2)`ï¼Œæ‰€ä»¥ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥åœ¨èµ‹å€¼å™¨ä¸­ä½¿ç”¨èµ‹å€¼å™¨ğŸ¤”ã€‚

```
const evaluate = ast => {
  // number handling, like this: 2
  if (typeof ast === "number") {
    return ast;
  } else {
    // function call handling
    let [name, first, second] = ast;
    if (name === "+") {
      return evaluate(first) + evaluate(second);
    } else if (name === "-") {
      return evaluate(first) - evaluate(second);
    } else {
      // runtime error
      throw new Error(`${name} is not a function`);
    }
  }
}; 
```

è¿™æ˜¯å®ƒ-æˆ‘ä»¬æœ‰è®¡ç®—å™¨è¯­è¨€çš„è¯„ä¼°å·¥ä½œã€‚è¿™ä¸æ˜¯ä¸€æ®µéå¸¸é€šç”¨çš„ä»£ç ï¼Œä½†æ˜¯å®ç°èµ·æ¥éå¸¸ç®€å•ã€‚ä¸€æ—¦æˆ‘ä»¬æƒ³è¦æ·»åŠ æ›´å¤šçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±éœ€è¦æ›´æ”¹ä»£ç ï¼Œä½†è¿™æ˜¯ç»ƒä¹ çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†äº†è§£æ·»åŠ æ–°åŠŸèƒ½éœ€è¦åšä»€ä¹ˆæ ·çš„æ›´æ”¹ã€‚

è¯„ä¼°å‘˜æµ‹è¯•:

```
assert.deepStrictEqual(evaluate(["-", 5, ["+", 2, 1]]), 2); 
```

## REPL

æˆ‘ä»¬å·²ç»æœ‰äº†è¯­è¨€çš„æ ¸å¿ƒï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€äº›èƒ½å¤Ÿä¸ä¹‹äº¤äº’çš„æ¥å£ã€‚REPL ä»£è¡¨:

*   readâ€”â€”è¯»å–ç”¨æˆ·é€šè¿‡ç•Œé¢æä¾›çš„ç¨‹åºæ–‡æœ¬
*   Eval -è¯„ä¼°è®¡åˆ’
*   æ‰“å°-æ‰“å°ç»“æœ
*   å¾ªç¯-ä»å¤´å¼€å§‹é‡å¤è¿™ä¸ªè¿‡ç¨‹

REPL æ˜¯ä¸€ä¸ªç®€å•çš„ç¼–ç¨‹è¯­è¨€è§£é‡Šå™¨çš„äº¤äº’ç•Œé¢ã€‚ç›®å‰ï¼Œæˆ‘ä»¬çš„è¯­è¨€æ—¢æ²¡æœ‰ readï¼Œä¹Ÿæ²¡æœ‰ writeï¼Œä¹Ÿæ²¡æœ‰ loop å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åœ¨æ ¸å¿ƒä¹‹å¤–å®ç°è¿™ç§äº¤äº’(ç”¨ JS)ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å®ç°:ç½‘é¡µæˆ–è€… Node.js å‘½ä»¤è¡Œç•Œé¢(CLI)ã€‚

### ç½‘é¡µä¸­çš„ REPL

è®©æˆ‘ä»¬è¯•è¯•ç½‘é¡µã€‚æˆ‘ä»¬å°†ä» HTML æ–‡æœ¬å­—æ®µä¸­è¯»å–ç”¨æˆ·è¾“å…¥ï¼Œåœ¨è¡¨å• submit ä¸Šå¯¹å…¶è¿›è¡Œè¯„ä¼°ï¼Œå¹¶å°†ç»“æœæ‰“å°åˆ° textareaã€‚

```
<html>
  <body>
    <form id="form">
      <textarea id="program" placeholder="program"></textarea><br /><br />
      <input type="submit" value="evaluate" /><br /><br />
      <textarea id="result" placeholder="result"></textarea>
    </form>
    <script>
      // implementation of parse and evaluate functions which we wrote before
      // ...
      const form = document.getElementById("form");
      const programInput = document.getElementById("program");
      const resultOutput = document.getElementById("result");
      form.addEventListener("submit", e => {
        // prevent page reload
        e.preventDefault();
        try {
          // evaluate a program
          const result = evaluate(parse(programInput.value));
          // and print it to the textarea
          resultOutput.value = result;
        } catch (e) {
          // in case of error print the error to the textarea
          resultOutput.value = e.message;
        }
      });
    </script>
  </body>
</html> 
```

### CLI ä¸­çš„ REPL

```
// implementation of parse and evaluate functions which we wrote before
// ...
const readline = require("readline");
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
  prompt: "calcy> "
});
rl.prompt();

rl.on("line", input => {
  try {
    console.log(evaluate(parse(input)));
  } catch (e) {
    console.log(e.message);
  }
  rl.prompt();
}); 
```

## ç»“è®º

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºå°†æ¥çš„å­¦ä¹ æ‰“ä¸‹äº†åŸºç¡€ã€‚ä¾‹å¦‚ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡å¯ä»¥æ˜¯å‘è¯­è¨€ä¸­æ·»åŠ å˜é‡(ä¸€ç§ä¿å­˜è®¡ç®—ç»“æœçš„æ–¹æ³•ï¼Œä»¥ä¾¿èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¸­é‡ç”¨å®ƒ)ï¼Œæˆ–è€…æ·»åŠ å‡½æ•°ï¼Œæˆ–è€…æ·»åŠ å¯¹å‡½æ•°ä¸­æ›´å¤§æˆ–æ›´å°æ•°é‡çš„å‚æ•°çš„å¤„ç†(ç›®å‰æ‰€æœ‰å‡½æ•°éƒ½åªæ¥å—ä¸¤ä¸ªå‚æ•°)ã€‚è¿™ä¹ˆå¤šå­¦ä¹ æœºä¼šã€‚

æˆ‘çŒœåœ¨ä¸‹ä¸€ä¸ªæ•™ç¨‹ä¸­æˆ‘ä»¬ä¼šæ·»åŠ å˜é‡ã€[å‡½æ•°å’Œé—­åŒ…](https://stereobooster.com/posts/from-function-to-closure)ã€‚

æºä»£ç è¿™é‡Œæ˜¯[è¿™é‡Œæ˜¯](https://github.com/stereobooster/write-a-language/tree/master/1.calcy)ã€‚

> é©¬ä¿®Â·æ–½ç“¦èŒ¨åœ¨ unsplash ä¸Šæ‹æ‘„çš„ç…§ç‰‡