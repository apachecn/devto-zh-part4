# å°† google ç™»å½•æ·»åŠ åˆ°æ‚¨çš„ webapp ä¸­â€”â€”ä½¿ç”¨ js åº“

> åŸæ–‡ï¼š<https://dev.to/intricatecloud/adding-google-sign-in-to-your-webapp-using-the-js-library-3n0g>

åœ¨æœ¬ç³»åˆ—çš„ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨ [Google ç™»å½•ç½‘ç«™åº“](https://developers.google.com/identity/sign-in/web/)æ¥æ˜¾ç¤ºä¸€äº›ä½¿ç”¨ javascript çš„ç”¨æˆ·çš„ä¿¡æ¯ã€‚æˆ‘ä»¬ä½¿ç”¨äº†é»˜è®¤çš„ Google ç™»å½•å·¥ä½œæµå’Œä»–ä»¬çš„é»˜è®¤æŒ‰é’®ã€‚

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨`gapi`åº“æ¥é…ç½®ç™»å½•ï¼Œç„¶åå®é™…ç™»å½•ç”¨æˆ·ï¼Œä»¥åŠå¤„ç†ä¸€äº›å¸¸è§ç”¨æˆ·åœºæ™¯çš„ä¸€äº›ç‰‡æ®µã€‚

## åˆ›å»ºè‡ªå·±çš„ç­¾åˆ°æŒ‰é’®

1.  åŠ è½½ api.js åº“ï¼Œè€Œä¸æ˜¯ platform.jsğŸ¤·(ä¸ç¡®å®šå®ƒä»¬ä¸ºä»€ä¹ˆä¸åŒ)

å°†`https://apis.google.com/js/platform.js`æ”¹ä¸º`https://apis.google.com/js/api.js?onload=onLibraryLoaded`

åœ¨è¿™é‡Œï¼Œä¸€æ—¦ä½¿ç”¨æ‚¨å¯ä»¥é€šè¿‡ URL æä¾›çš„`?onload=onLibraryLoaded`å›è°ƒåŠ è½½äº†åº“ï¼Œæˆ‘ä»¬å°±é…ç½®æˆ‘ä»¬çš„ç™»å½•å®¢æˆ·ç«¯ã€‚`api.js`å°†æ·»åŠ ä¸€ä¸ªåä¸º`gapi`çš„å…¨å±€å˜é‡ã€‚

1.  ç”¨æŒ‰é’®å•å‡»å¤„ç†ç¨‹åºå‘ index.html æ·»åŠ ä¸€ä¸ªæŒ‰é’®

`<button onclick="onSignInClicked()">Sign in with button onClick</button>`

1.  å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ° index.html çš„è„šæœ¬æ ‡è®°ä¸­ï¼Œä»¥å¤„ç†æŒ‰é’®å•å‡»

```
function onLibraryLoaded() {
    gapi.load('auth2', function() {
        gapi.auth2.init({
            client_id: 'YOUR_CLIENT_ID.apps.googleusercontent.com',
            scope: 'profile'
        })
    })
}

function onSignInClicked() {
    gapi.load('auth2', function() {
        gapi.auth2.signIn().then(function(googleUser) {
          console.log('user signed in')
        }, function(error) {
            console.log('user failed to sign in')
        })
    })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä»å¼€å‘äººå‘˜æ§åˆ¶å°è®¿é—®`gapi.auth2`åº“ï¼Œå¹¶ä½¿ç”¨æˆ‘ä»¬çš„`client_id`åˆå§‹åŒ–å®ƒã€‚

## å¦‚ä½•å¤„ç†ä¸€äº›å¸¸è§çš„ç”¨æˆ·åœºæ™¯

*   å½“ç”¨æˆ·ç™»å½•æ—¶ç›‘å¬
*   æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
*   è·å–ç”¨æˆ·ä¿¡æ¯
*   ä»…å…è®¸ç‰¹å®šåŸŸçš„ç”¨æˆ·ç™»å½•
*   ä»…å…è®¸ç‰¹å®šç”¨æˆ·ç™»å½•
*   åœ¨ç”¨æˆ·ç™»å½•ä¹‹å‰éšè—å†…å®¹
*   å°†æ‚¨çš„ ID ä»¤ç‰Œå‘é€åˆ°åç«¯(å¦‚æœæ‚¨æœ‰)

### ç”¨æˆ·ç™»å½•æ—¶ç›‘å¬

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªèƒ½åœ¨åˆå§‹åŒ–å¹¶ç™»å½•ç”¨æˆ·åè¿è¡Œä¸€äº›ä»£ç ã€‚ä½†æ˜¯ï¼Œå¦‚æœé¡µé¢çš„ä¸åŒéƒ¨åˆ†åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªéƒ¨åˆ†æ ¹æ®ç”¨æˆ·æ˜¾ç¤ºä¸åŒçš„å†…å®¹ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ(å¦‚æœæ‚¨ä½¿ç”¨ç»„ä»¶ï¼Œå¯èƒ½å°±æ˜¯è¿™ç§æƒ…å†µ)

```
class UserAvatarComponent extends React.Component {
    ...
    componentDidMount() {
        gapi.load('auth2', function() {
            gapi.auth2.isSignedIn.listen(function(isSignedIn) {
                console.log('user signed in ', isSignedIn)
                this.setState({status: isSignedIn})
            })
        })
    }    
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•

```
function isUserSignedIn() {
  gapi.load('auth2', function() {
      var isSignedIn = auth2.isSignedIn.get();
      console.log('is signed in? ', isSigned In)
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨è¯¥å‡½æ•°éœ€è¦æ³¨æ„ä¸€äº›äº‹é¡¹:

*   é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨å·²ç»ç™»å½•ï¼Œç™»å½•åº“ä¼šè‡ªåŠ¨ä¸ºæ‚¨ç™»å½•ã€‚
*   å¦‚æœä½ åˆ·æ–°é¡µé¢ï¼Œç”šè‡³åœ¨ç”¨æˆ·ç™»å½•ä¹‹åï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ï¼Œä½ ä¼šå¾—åˆ°`auth2.isSignedIn.get() === false`
*   ç”¨æˆ·è‡ªåŠ¨ç™»å½•å(é€šå¸¸éœ€è¦ä¸€ç§’é’Ÿ)ï¼Œç„¶å`auth2.isSignedIn.get() === true`
*   å–å†³äºæ‚¨å¦‚ä½•å¤„ç†æ‚¨çš„ç™»å½•ç”¨æˆ·ç•Œé¢ï¼Œæ‚¨çš„ç”¨æˆ·å¯èƒ½ä¼šçœ‹åˆ°ä»–ä»¬æ²¡æœ‰ç™»å½•ä¸€ä¸ªçƒ­ç‚¹ç§’ã€‚å¦‚æœæ‚¨æƒ³çŸ¥é“å‘ç”Ÿè¿™ç§æƒ…å†µçš„å‡†ç¡®æ—¶é—´ï¼Œä½¿ç”¨`isSignedIn.listen()`å›è°ƒä¼šå¾ˆæœ‰å¸®åŠ©ã€‚

### è·å–ç”¨æˆ·ä¿¡æ¯

```
function showCurrentUserInfo() {
  gapi.load('auth2', function() {
      var googleUser = auth2.currentUser.get()
      console.log('users info ', googleUser)
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### åªå…è®¸ç‰¹å®šåŸŸçš„ç”¨æˆ·ç™»å½•

è¿™æ˜¯ä¸€ä¸ªå°æŠ€å·§ï¼Œå¯èƒ½å¾ˆå®¹æ˜“ç»•è¿‡ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨`getHostedDomain()`æ–¹æ³•è·å¾—ç”¨æˆ·æ¥è‡ªçš„ G-Suite åŸŸã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰ G-Suite åŸŸï¼Œé‚£ä¹ˆå®ƒå°†æ˜¯ç©ºç™½çš„ã€‚

```
function onSignIn(googleUser) {
    if(googleUser.getHostedDomain() !== 'mysite.com') {
        // show a Not Authorized message
    } else {
        // show the users dashboard
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### åªå…è®¸æŸäº›ç”¨æˆ·ç™»å½•

è¿™æ›´åƒæ˜¯ä¸€ç§é»‘å®¢è¡Œä¸ºï¼Œä½†ä¼¼ä¹æ˜¯å”¯ä¸€å¯ä»¥ä» javascript å†…éƒ¨å®Œæˆçš„æ–¹æ³•ã€‚ä½ çœŸçš„ä¸åº”è¯¥ã€‚ä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘è¦æŠŠå®ƒåŒ…æ‹¬è¿›æ¥ã€‚é‡è›®çš„æ–¹æ³•ã€‚

```
function onSignIn(googleUser) {
    var profile = googleUser.getBasicProfile()
    if(profile.getEmail() === 'admin@example.com' ||
       profile.getEmail() === 'client@example.com') {
           // show the user dashboard
    } else {
        // show a Not Authorized message
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### éšè—å†…å®¹ç›´åˆ°ç”¨æˆ·ç™»å½•å

è¿™ä¹Ÿæ˜¯é»‘ã€‚å¦‚æœæ‚¨åœ¨æµè§ˆå™¨ä¸­æ‘†å¼„ CSSï¼Œè¿™å¾ˆå®¹æ˜“è§£å†³ï¼Œä½†æ˜¯å¦‚æœå®ƒé€‚åˆæ‚¨çš„ç”¨ä¾‹ï¼Œä¹Ÿå¯ä»¥å·¥ä½œã€‚è¿™æ˜¯ä¸€ä¸ªåä¸»æ„çš„åŸå› æ˜¯ï¼Œåœ¨ä¸€ä¸ªé™æ€ç½‘ç«™ä¸­ï¼Œç”¨æˆ·å¯ä»¥è·å¾— HTML ä¸­çš„æ‰€æœ‰ä¿¡æ¯ã€‚å¦‚æœæ‚¨è¦éšè—å®é™…çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·ä¸è¦ä½¿ç”¨æ­¤é€‰é¡¹ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å€™é€‰äººå±•ç¤ºä½ æœ€å–œæ¬¢çš„çŒ«å›¾ç‰‡ã€‚

```
<body>
...
  <div id="greeting">
    You are not authorized to view this content
  </div>
  <div id="dashboard">
    ...
  </div>
  <script>
    // hide initially
    $('#dashboard').hide()

    function onSignIn(googleUser) {
      setTimeout(function() {
        // show the content
        $('#greeting').hide()
        $('#dashboard').show()
      }, 1000);
    }
  </script>
</body> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### å‘é€ä»¤ç‰Œæ¥è¯†åˆ«ç”¨æˆ·(ä¸æ˜¯ä»–ä»¬çš„ ID)

å¦‚æœæ‚¨æ­£åœ¨è¿›è¡Œåç«¯è¯·æ±‚ï¼Œæ‚¨å°†å¸Œæœ›å°†ç”¨æˆ· ID ä»¤ç‰Œä½œä¸ºæˆæƒå¤´å‘é€åˆ°æ‚¨çš„åç«¯ã€‚åœ¨æ‚¨çš„åç«¯ï¼Œæ‚¨å°†èƒ½å¤ŸéªŒè¯å’Œè§£ç  ID ä»¤ç‰Œ([å‚è§è¿™é‡Œçš„ç¤ºä¾‹](https://developers.google.com/identity/sign-in/web/backend-auth))ã€‚

è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯è¿™ä¸ª ID ä»¤ç‰Œ(ä¸€ç§ JWT ä»¤ç‰Œ)æ˜¯ç”± Google ç­¾åçš„ï¼Œæ‰€ä»¥æ‚¨çŸ¥é“ä¿¡æ¯æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚

```
$.ajax({
  url: 'myapi/example',
  headers: {'Authorization': googleUser.getAuthResponse().id_token)},
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## ç»“è®º

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•é€šè¿‡ javascript é…ç½® Google ç™»å½•åº“ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥åšä¸€äº›äº‹æƒ…ï¼Œå¦‚è·å–ç”¨æˆ·ä¿¡æ¯å¹¶æ£€æŸ¥ä»–ä»¬æ˜¯å¦ç™»å½•(ç™»å½•æµç¨‹ä¸­éœ€è¦æ³¨æ„ä¸€äº›ç»†å¾®å·®åˆ«)ã€‚

æ¼”ç¤ºä»£ç å¯åœ¨[Github intricatecloud/Google-sign-in-demo](https://github.com/intricatecloud/google-sign-in-demo/blob/master/gapi-demo.html)ä¸Šè·å¾—ã€‚å°†`YOUR_CLIENT_ID`æ›¿æ¢ä¸ºæ‚¨çš„å®¢æˆ·ç«¯ IDï¼Œæ‚¨å°†èƒ½å¤Ÿçœ‹åˆ°è¿è¡Œä¸­çš„ç™»å½•æŒ‰é’®ã€‚

åœ¨æœ¬ç³»åˆ—çš„æœ€åä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹å¦‚ä½•åœ¨ React å’Œ Angular åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ google sign-in çš„ä¸€äº›ä¾‹å­ã€‚[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹](https://www.intricatecloud.io/2019/08/adding-google-sign-in-to-your-webapp-a-react-example/)ã€‚

* * *

æœ€åˆå‘å¸ƒäº [www.intricatecloud.io](https://www.intricatecloud.io/2019/07/adding-google-sign-in-to-your-webapp-using-the-js-library/)