# åœ¨ä»¥å¤ªåŠä¸Šå®ç°åŒºå—é“¾ Oracle

> åŸæ–‡:[https://dev . to/pedroduartecosta/implementing-a-åŒºå—é“¾-ä»¥å¤ªåŠä¸Šçš„ç”²éª¨æ–‡-56bp](https://dev.to/pedroduartecosta/implementing-a-blockchain-oracle-on-ethereum-56bp)

TLDR: åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•æ„å»ºä¸€ä¸ªä»¥å¤ªåŠè‡ªæ‰˜ç®¡åŒºå—é“¾å…ˆçŸ¥ã€‚è¯¥æœåŠ¡å°†æ ¹æ®æ™ºèƒ½åˆåŒçš„è¯·æ±‚æŸ¥è¯¢ APIï¼Œå¹¶æ·»åŠ æœ‰å…³åŒºå—é“¾çš„ä¿¡æ¯ã€‚æ‰€æè¿°çš„æ–¹æ³•å…è®¸éƒ¨ç½²ç›¸åŒ oracle çš„å¤šä¸ªç«äº‰æ–¹å¯¹ç»“æœæœ‰ç›¸åŒçš„å‘è¨€æƒã€‚ä½†æ˜¯å¯ä»¥å¾ˆå®¹æ˜“åœ°è½¬æ¢æˆä¸€ä¸ªç®€å•çš„ oracle æ¥ä¸ºä¸€ä¸ªåˆ©ç›Šç›¸å…³è€…æœåŠ¡ã€‚

## [](#background)èƒŒæ™¯

ä»¥å¤ªåŠä¸­çš„æ™ºèƒ½åˆçº¦å¯ä»¥æ”¯æŒå¹¿æ³›çš„åº”ç”¨ï¼Œç„¶è€Œï¼Œç”±äºåŒºå—é“¾çš„æ€§è´¨ï¼Œæ™ºèƒ½åˆçº¦ç¼ºä¹ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½:*äº’è”ç½‘è¿æ¥*ã€‚

### [](#why-you-may-ask)ä¸ºä»€ä¹ˆï¼Ÿä½ å¯èƒ½ä¼šé—®

ä»¥å¤ªåŠåŒºå—é“¾è¢«è®¾è®¡ä¸ºå®Œå…¨ç¡®å®šæ€§çš„ï¼Œè¿™æ„å‘³ç€å¦‚æœæœ‰äººä¸‹è½½äº†æ•´ä¸ªç½‘ç»œå†å²å¹¶é‡æ”¾å®ƒï¼Œä»–ä»¬åº”è¯¥æ€»æ˜¯ä»¥ç›¸åŒçš„çŠ¶æ€ç»“æŸã€‚ç¡®å®šæ€§æ˜¯å¿…è¦çš„ï¼Œä»¥ä¾¿èŠ‚ç‚¹å¯ä»¥è¾¾æˆå…±è¯†ã€‚

ç„¶è€Œï¼Œäº’è”ç½‘æ˜¯ä¸ç¡®å®šçš„ï¼Œåœ¨æŸä¸ªæ—¶é—´ç‚¹æŸ¥è¯¢ä¸€ä¸ª API çš„æ™ºèƒ½åˆçº¦ï¼Œä¸èƒ½ä¿è¯ä»¥åæŸ¥è¯¢åŒä¸€ä¸ª API ä¼šå¾—åˆ°ç›¸åŒçš„ç»“æœã€‚web ä¸Šçš„ API å’Œæ•°æ®ä¼šå‘ç”Ÿå˜åŒ–ã€‚å› æ­¤ï¼Œæ™ºèƒ½åˆçº¦æœ¬è´¨ä¸Šç¼ºä¹è¿é€šæ€§ã€‚

### [](#so-oracles-right)å¦‚æ­¤ç¥è°•å¯¹å—ï¼Ÿ

ç¥è°•è¿™ä¸ªåå­—æ¥æºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œä»å†å²ä¸Šè®²ï¼Œç¥è°•æ˜¯çœŸç†çš„æ¥æºã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ã€‚

Oracles æ˜¯åœ¨åŒºå—é“¾ä¸Šæ’å…¥æ•°æ®ä»¥ä¾›æ™ºèƒ½åˆçº¦ä½¿ç”¨çš„æœåŠ¡ã€‚é€šè¿‡å°†å…·æœ‰æ‰€éœ€ä¿¡æ¯çš„äº¤æ˜“æ·»åŠ åˆ°åŒºå—é“¾ï¼Œæ™ºèƒ½åˆçº¦å¯ä»¥è¿è¡Œå¹¶æ€»æ˜¯è·å¾—ç›¸åŒçš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒæ­£åœ¨ä»åŒºå—é“¾æ£€ç´¢è¯¥ä¿¡æ¯ã€‚

## [](#solution)è§£

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª oracle æœåŠ¡ï¼Œå®ƒå¯ä»¥æŸ¥è¯¢ JSON APIs å¹¶ä» API å“åº”ä¸­æ£€ç´¢å•ä¸ªå€¼ã€‚oracle å°†ä¿å­˜æ‰€æœ‰çš„è¯·æ±‚å’Œå›ç­”ï¼Œå¹¶å°†æ‹¥æœ‰ä¸€ç»„é¢„å®šä¹‰çš„åˆ©ç›Šç›¸å…³è€…ã€‚

è¿™äº›æ˜¯è¿è¡Œ node.js æœåŠ¡çš„å¸æˆ·ï¼Œè¯¥æœåŠ¡æŸ¥è¯¢ API å¹¶å‘ oracle è¿”å›å“åº”ã€‚oracle è¿˜å…·æœ‰å®ƒå¿…é¡»æ¥æ”¶çš„æœ€å°æ•°é‡çš„ç›¸ç­‰å“åº”ï¼Œä»¥ä¾¿ç¡®è®¤æ‰€æä¾›çš„ç­”æ¡ˆæ˜¯æœ‰æ•ˆçš„ã€‚

è¿™æ ·ï¼Œå¦‚æœç«äº‰æ–¹ä¾é ç¥è°•æ¥å¼ºåŒ–ä»–ä»¬çš„åˆåŒï¼Œè€Œå…¶ä¸­ä¸€æ–¹(èŠ‚ç‚¹)å˜å¾—ä¸å®ˆè§„çŸ©æˆ–è¯•å›¾æ“çºµç»“æœï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºä»–ä»¬åŒæ„äº†é¢„å…ˆå®šä¹‰çš„ç›¸ç­‰ç­”æ¡ˆçš„æ³•å®šäººæ•°ã€‚

## [](#architecture)å»ºç­‘

è¿™ä¸ªé¢„è¨€å°†ç”±ä¸¤éƒ¨åˆ†ç»„æˆã€‚é“¾ä¸Š oracle(æ™ºèƒ½å¥‘çº¦)å’Œé“¾ä¸‹ oracle æœåŠ¡(node.js æœåŠ¡å™¨)ã€‚

on-chain oracle æ˜¯ä¸€ä¸ªæ™ºèƒ½å¥‘çº¦ï¼Œå®ƒæœ‰ä¸€ä¸ªå…¬å…±å‡½æ•° *createRequest* ï¼Œè¯¥å‡½æ•°æ¥æ”¶è¦æŸ¥è¯¢çš„ URL å’Œè¦æ£€ç´¢çš„å±æ€§ã€‚ç„¶åï¼Œå¯åŠ¨ä¸€ä¸ªäº‹ä»¶æ¥è­¦å‘Šç¦»çº¿ oracle æœ‰æ–°çš„è¯·æ±‚ã€‚

ç¦»çº¿ oracle ç”±ä¸åŒæ–¹éƒ¨ç½²çš„å‡ ä¸ª node.js æœåŠ¡ç»„æˆï¼Œè¿™äº›æœåŠ¡å°†æŸ¥è¯¢ API å¹¶å‘å¥‘çº¦è¿”å›å“åº”ã€‚

ç„¶åï¼Œé“¾ä¸Š oracle éªŒè¯æ˜¯å¦è¾¾åˆ°äº†ç›¸ç­‰å“åº”çš„æœ€å°æ•°é‡ï¼Œå¦‚æœè¾¾åˆ°äº†ï¼Œåˆ™å‘å‡ºä¸€ä¸ªäº‹ä»¶ï¼Œè¡¨æ˜å®ƒå·²ç»å°±è¯¥å€¼è¾¾æˆäº†å…±è¯†ï¼Œä»¥ä¾¿æŸ¥è¯¢ oracle çš„å®¢æˆ·ç«¯æ™ºèƒ½åˆçº¦çŸ¥é“å®ƒå·²ç»å¾—åˆ°äº†å“åº”ã€‚

[![Oracle architecture](../Images/379f99a13184807525eb6270e53245ed.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--WlDh3FOH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/xtjqcwdzgcgalvjrm0r8.png)

## [](#onchain-oracle-implementation)é“¾ä¸Š Oracle å®æ–½

æˆ‘ä»¬ç”¨å•†å®šçš„æ¡æ¬¾å®šä¹‰ oracle å¥‘çº¦:æœ€å°æ³•å®šäººæ•°å’Œ Oracle æ€»æ•°ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰ä¸‰ä¸ªåˆ©ç›Šç›¸å…³è€…ï¼Œä¸ºäº†è¾¾æˆå…±è¯†ï¼Œä¸‰ä¸ªä¸­çš„ä¸¤ä¸ªå¿…é¡»æä¾›ç›¸åŒçš„ç­”æ¡ˆã€‚

```
pragma solidity >=0.4.21 <0.6.0;

contract Oracle {
  Request[] requests; //list of requests made to the contract
  uint currentId = 0; //increasing request id
  uint minQuorum = 2; //minimum number of responses to receive before declaring final result
  uint totalOracleCount = 3; // Hardcoded oracle count

} 
```

ç„¶åæˆ‘ä»¬æ·»åŠ è¯·æ±‚ç»“æ„ï¼Œå®ƒå°†ä¿å­˜è¯·æ±‚:

```
 // defines a general api request
  struct Request {
    uint id;                            //request id
    string urlToQuery;                  //API url
    string attributeToFetch;            //json attribute (key) to retrieve in the response
    string agreedValue;                 //value from key
    mapping(uint => string) anwers;     //answers provided by the oracles
    mapping(address => uint) quorum;    //oracles which will query the answer (1=oracle hasn't voted, 2=oracle has voted)
  } 
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥åˆ›å»ºå…¬å…±å‡½æ•° *createRequest* ï¼Œå®¢æˆ·ç«¯æ™ºèƒ½å¥‘çº¦(ä»»ä½•æƒ³è¦ä½¿ç”¨ oracle æœåŠ¡çš„å¥‘çº¦)å°†è°ƒç”¨è¯¥å‡½æ•°:

```
function createRequest (
    string memory _urlToQuery,
    string memory _attributeToFetch
  )
  public
  {
    uint lenght = requests.push(Request(currentId, _urlToQuery, _attributeToFetch, ""));
    Request storage r = requests[lenght-1];

    // Hardcoded oracles address
    r.quorum[address(0x6c2339b46F41a06f09CA0051ddAD54D1e582bA77)] = 1;
    r.quorum[address(0xb5346CF224c02186606e5f89EACC21eC25398077)] = 1;
    r.quorum[address(0xa2997F1CA363D11a0a35bB1Ac0Ff7849bc13e914)] = 1;

    // launch an event to be detected by oracle outside of blockchain
    emit NewRequest (
      currentId,
      _urlToQuery,
      _attributeToFetch
    );

    // increase request id
    currentId++;
  } 
```

è¿™ä¸ªåŠŸèƒ½åŒ…å«äº†åˆ©ç›Šç›¸å…³è€…ä¹‹é—´åè®®çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ã€‚è¢«ä¿¡ä»»å‚ä¸æœ€ç»ˆè§£å†³æ–¹æ¡ˆçš„å¸æˆ·çš„åœ°å€ã€‚å¹¶å°†å‘å‡ºäº‹ä»¶ï¼Œ *NewRequest* ï¼Œè¯¥äº‹ä»¶å°†è¢«ç¦»çº¿çš„ oracles ç›‘å¬ã€‚

```
 //event that triggers oracle outside of the blockchain
  event NewRequest (
    uint id,
    string urlToQuery,
    string attributeToFetch
  ); 
```

ä¸€æ—¦å¬åˆ°è¿™ä¸ªäº‹ä»¶(æˆ‘å°†åœ¨ä¸‹é¢è§£é‡Šè¿™ä¸€éƒ¨åˆ†),ç¦»çº¿çš„ oracles å°†è°ƒç”¨å…¬å…±å‡½æ•° *updateRequest* ã€‚

```
//called by the oracle to record its answer
  function updateRequest (
    uint _id,
    string memory _valueRetrieved
  ) public {

    Request storage currRequest = requests[_id];

    //check if oracle is in the list of trusted oracles
    //and if the oracle hasn't voted yet
    if(currRequest.quorum[address(msg.sender)] == 1){

      //marking that this address has voted
      currRequest.quorum[msg.sender] = 2;

      //iterate through "array" of answers until a position is free and save the retrieved value
      uint tmpI = 0;
      bool found = false;
      while(!found) {
        //find first empty slot
        if(bytes(currRequest.anwers[tmpI]).length == 0){
          found = true;
          currRequest.anwers[tmpI] = _valueRetrieved;
        }
        tmpI++;
      }

      uint currentQuorum = 0;

      //iterate through oracle list and check if enough oracles(minimum quorum)
      //have voted the same answer has the current one
      for(uint i = 0; i < totalOracleCount; i++){
        bytes memory a = bytes(currRequest.anwers[i]);
        bytes memory b = bytes(_valueRetrieved);

        if(keccak256(a) == keccak256(b)){
          currentQuorum++;
          if(currentQuorum >= minQuorum){
            currRequest.agreedValue = _valueRetrieved;
            emit UpdatedRequest (
              currRequest.id,
              currRequest.urlToQuery,
              currRequest.attributeToFetch,
              currRequest.agreedValue
            );
          }
        }
      }
    }
  } 
```

è¯¥åŠŸèƒ½å°†é¦–å…ˆæ£€æŸ¥å‘¼å«è€…æ˜¯å¦æ˜¯é¢„å®šä¹‰åœ°å€ä¹‹ä¸€ã€‚ç„¶åï¼Œå®ƒå°†æ£€æŸ¥ç”²éª¨æ–‡æ²¡æœ‰æŠ•ç¥¨ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œå®ƒå°†ä¿å­˜ç”²éª¨æ–‡çš„ç­”æ¡ˆã€‚é‚£ä¹ˆå®ƒå°†æ£€æŸ¥è¯¥å›ç­”æ˜¯å¦å·²ç»ç”±è‡³å°‘æ‰€éœ€çš„æœ€å°æ³•å®šäººæ•°æä¾›ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å·²ç»å°±ä¸€ä¸ªç»“æœè¾¾æˆä¸€è‡´ï¼Œå¹¶å°†å‘å‡ºä¸€ä¸ªäº‹ä»¶ *UpdatedRequest* ï¼Œå°†ç»“æœé€šçŸ¥ç»™å®¢æˆ·ç«¯å¥‘çº¦ã€‚

```
 //triggered when there's a consensus on the final result
  event UpdatedRequest (
    uint id,
    string urlToQuery,
    string attributeToFetch,
    string agreedValue
  ); 
```

åœ¨è¿™é‡Œä½ å¯ä»¥æ‰¾åˆ°å®Œæ•´çš„ oracle ä»£ç ä»¥åŠå¦‚ä½•ä½¿ç”¨ truffle åˆ›å»ºæ ·æ¿æ–‡ä»¶çš„è¯´æ˜ã€‚

## [](#offchain-oracle-implementation)é“¾å¤– Oracle å®ç°

è¿™æ˜¯æ¯”è¾ƒç®€å•çš„éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä»»ä½•å¯ä»¥ç›‘å¬å‘å‡ºçš„åŒºå—é“¾å¹¶æŸ¥è¯¢ API çš„æœåŠ¡ã€‚

å®ƒä½¿ç”¨ web3 ç›‘å¬é“¾ä¸Š oracle ä¸Šçš„äº‹ä»¶ï¼ŒæŸ¥è¯¢è¯·æ±‚çš„ APIï¼Œè§£ææ£€ç´¢åˆ°çš„ JSON ä»¥è·å¾—è¯·æ±‚çš„é”®ï¼Œå¹¶è°ƒç”¨å…¬å…±å‡½æ•° *updateRequest* ã€‚

å› ä¸ºè¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œè€Œä¸”è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä¸ä¼šæ·±å…¥è®¨è®ºç¦»çº¿æœåŠ¡çš„å®ç°ç»†èŠ‚ã€‚

[åœ¨è¿™é‡Œ](https://github.com/pedroduartecosta/ethereum-oracle/tree/master/off-chain-oracle)æ‚¨å¯ä»¥æ‰¾åˆ°åº”è¯¥ç”±æ‰€æœ‰åˆ©ç›Šç›¸å…³è€…éƒ¨ç½²çš„æœåŠ¡ä»£ç ã€‚

## [](#summing-up)æ€»ç»“å½’çº³

è¿™ç§å®ç°å…è®¸ä¸ä¾èµ–äºä½œä¸ºå”¯ä¸€æŸ¥è¯¢ API çš„ä¸€æ–¹çš„å•ä¸€æ–¹ä½œä¸ºäº‹å®çš„æ¥æºï¼Œè€Œæ˜¯è®©å¤šæ–¹å°±ç»“æœè¾¾æˆä¸€è‡´ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸çµæ´»çš„æœåŠ¡ï¼Œå› ä¸ºå®ƒå¯ä»¥æŸ¥è¯¢ä»»ä½•å…¬å…±çš„ JSON APIï¼Œå…è®¸åœ¨è¿‡å¤šçš„ç”¨ä¾‹ä¸­ä½¿ç”¨ã€‚

æ‰€æœ‰çš„ä»£ç éƒ½å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°[ã€‚](https://github.com/pedroduartecosta/ethereum-oracle)

# [](#thanks-for-reading)ğŸ‘‹æ„Ÿè°¢é˜…è¯»ï¼