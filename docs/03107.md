# å®šåˆ¶æŒ‚é’©å’Œæ’åº§

> åŸæ–‡:[https://dev.to/droidmakk/custom-hooks-and-sockets-2i56](https://dev.to/droidmakk/custom-hooks-and-sockets-2i56)

æ‰€ä»¥ï¼Œè‡ªä»é’©å­å‡ºç°å·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œæˆ‘ä¸€ç›´åœ¨åŠªåŠ›æ‰¾æ—¶é—´å°è¯•å’Œå­¦ä¹ åˆ›å»ºå®šåˆ¶é’©å­ã€‚çœŸæ­£ä»¤äººéš¾ä»¥ç½®ä¿¡çš„ğŸ§ .è™½ç„¶æœ‰è¶£çš„éƒ¨åˆ†æ˜¯ï¼Œè¿™ä¸ªæ¦‚å¿µå¯èƒ½å¾ˆç®€å•ï¼Œä½†å¦‚æœä½ æ‰¾åˆ°æ­£ç¡®çš„ç”¨ä¾‹ã€‚

æˆ‘æƒ³å°è¯•çš„ç¬¬ä¸€ä»¶äº‹æ˜¯å‘å‡ºç½‘ç»œè¯·æ±‚ï¼Œçœ‹çœ‹æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨é’©å­æ¥å®ç°ã€‚é€šå¸¸çš„ååº”æ–¹å¼æ˜¾ç„¶æ˜¯ **setState** ã€‚å‡è®¾ä½ ä»¬å¤§å¤šæ•°äººéƒ½ä½¿ç”¨è¿‡ setStateã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨**é’©å­**åœ¨åŠŸèƒ½ç»„ä»¶ä¸­ç¼–å†™å®ƒã€‚

ä¸ºæ­¤ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ JSON å ä½ç¬¦æ¥è·å–å¸–å­ã€‚

```
import React,{ useState } from "react";

// URL to fetch posts
const postsUrl = "https://jsonplaceholder.typicode.com/posts"

// Our Component
const ListPosts = () => {
    // Using state hook to set if loading
    const [ loading, setLoading ] = useState(true);
    // Fetch and set list of posts
    const [ posts, setPosts ] = useState([]);

    //Here we fetch the posts and add it to posts state
    fetch(postsUrl)
        .then(res => res.json())
        .then(data => { setPosts(data); setLoading(false); })
        .catch(err => {
            alert('Error fetching posts');
            setLoading(false);
        });

    //Our Component which will lists posts
    return(
        <div>
            // Loop through the list of posts
            <h1>My Posts <span>{posts.length}</span></h1>
            {loading ? 
                <h1>Loading posts...</h2> 
                : posts.map(post => (
                    <div>
                        <h3>{post.title}</h3>
                        <hr/>
                        <p>{post.body}</p>
                    </div>
            })}
        </div>
    )
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ä¸ªç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† **useState** é’©å­æ¥è®¾ç½®å¸–å­å’ŒåŠ è½½çŠ¶æ€ã€‚ä½†æ˜¯ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å°†å®ƒé‡å†™ä¸ºä¸€ä¸ªå°†é€»è¾‘ä¸ç»„ä»¶åˆ†ç¦»çš„é’©å­ã€‚

é¦–å…ˆè®©æˆ‘ä»¬ä½¿ç”¨ effect é’©å­ï¼Œå®ƒå°†å¯¹ç»„ä»¶å†…éƒ¨çš„å˜åŒ–åšå‡ºååº”ã€‚æˆ‘ä»¬å»çœ‹çœ‹ã€‚

```
React.useEffect(() => {
    // Function called whenever something updates in component
},[ /* Update based on variable */ ]) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨æˆ‘ä»¬çš„ç»„ä»¶
ä¸­ä½¿ç”¨å®ƒ

```
import React,{ useState } from "react";

// URL to fetch posts
const postsUrl = "https://jsonplaceholder.typicode.com/posts"

// Our Component
const ListPosts = () => {
    // Using state hook to set if loading
    const [ loading, setLoading ] = useState(true);
    // Fetch and set list of posts
    const [ posts, setPosts ] = useState([]);

    // Use effect to update component
    React.useEffect(() => {
        //Here we fetch the posts and add it to posts state
        fetch(postsUrl)
            .then(res => res.json())
            .then(data => { setPosts(data); setLoading(false); })
            .catch(err => {
                alert('Error fetching posts');
                setLoading(false);
            });
    },[ postsUrl ])

    //Our Component which will lists posts
    return(
        <div>
            // Loop through the list of posts
            <h1>My Posts <span>{posts.length}</span></h1>
            {loading ? 
                <h1>Loading posts...</h2> 
                : posts.map(post => (
                    <div>
                        <h3>{post.title}</h3>
                        <hr/>
                        <p>{post.body}</p>
                    </div>
            })}
        </div>
    )
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬å°†é€»è¾‘ä»åº”ç”¨ç¨‹åºä¸­åˆ†ç¦»å‡ºæ¥

```
// Here is our hook which makes request and returns the posts
const usePosts = (postUrl) => {
    const [ loading, setLoading ] = useState(true);
    const [ posts, setPosts ] = useState([]);

    React.useEffect(() => {
        //Here we fetch the posts and add it to posts state
        fetch(postsUrl)
            .then(res => res.json())
            .then(data => { setPosts(data); setLoading(false); })
            .catch(err => {
                alert('Error fetching posts');
                setLoading(false);
            });
    },[ postsUrl ])

    return { loading, posts }
}

// Adding it to our component
const postsUrl = "https://jsonplaceholder.typicode.com/posts";

const ListPosts = () => {
    const { loading, posts } = usePosts(postsUrl);

    return(  
        <div>  // Loop through the list of posts  
            <h1>My Posts <span>{posts.length}</span></h1>  
            {loading ?  
                <h1>Loading posts...</h2>
                : posts.map(post =>  (
                <div>
                    <h3>{post.title}</h3>  
                    <hr/>
                    <p>{post.body}</p>
                </div>
                })}  
        </div>)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¥½äº†ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº†ç¬¬ä¸€ä¸ªç®€å•çš„å®šåˆ¶é’©å­ã€‚å¦‚æœæˆ‘ä»¬æ‰“ç®—ä½¿ç”¨é™æ€è¯·æ±‚æ¥è·å–æ•°æ®ï¼Œè¿™æ˜¯å¯ä»¥çš„ã€‚å¦‚æœæˆ‘ä»¬è¦æ¥æ”¶åŸºäºäº‹ä»¶çš„æ•°æ®æµå‘¢ï¼Ÿ
è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨å¥—æ¥å­—ç¼–å†™ç›¸åŒçš„ç»„ä»¶æ¥ä»ç‰©è”ç½‘è®¾å¤‡è·å–æ¸©åº¦ã€‚å®ƒä¼šä¸æ–­åœ°å‘é€æ•°æ®ã€‚

ä¸ºæ­¤ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå®ƒä½¿ç”¨ express å’Œ socket-io ä¼ è¾“ 0 åˆ° 100 ä¹‹é—´çš„éšæœºæ¸©åº¦ã€‚ä»£ç å¦‚ä¸‹ã€‚

```
// server.js
const app = require('express')();
const server = require('http').createServer(app);
const socket = require('socket.io');
const io = socket(server);

const port = 8080 || process.env.PORT;

io.on('connection', () => {
    console.info('SOME ONE IS HERE');
});

setInterval(() => {
    const temp = Math.floor(Math.random()* 100);
    const topic = 'temperature';
    console.info(`TEMP : ${temp}`);
    io.emit(topic,temp);
}, 3000);

const listenCb = () => console.table([['status', 'port'],['started',port]])
server.listen(port, listenCb); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨ä¸‹é¢çš„ä»£ç 
å®‰è£…ä¾èµ–é¡¹å¹¶è¿è¡ŒæœåŠ¡å™¨

```
npm i -S socket.io express

# Run the app using nodejs
node app.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†æŒç»­æ¯ 3 ç§’å‘é€ä¸€æ¬¡æ•°æ®ã€‚

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨ React çš„ç»„ä»¶ä¸­ä½¿ç”¨å®šåˆ¶é’©å­æ¥å®ç°è¿™ä¸€ç‚¹ã€‚é¦–å…ˆè®©æˆ‘ä»¬å†™æˆ‘ä»¬çš„é’©å­ã€‚

```
import React from 'react';
import PropTypes from 'prop-types';
import socket from 'socket.io-client';

// Use socket to fetch request to data 
// Socket server's url and topic in which data is sent
const useSocket = (serverUrl, topic) => {
    const [temp, setTemp] = React.useState(0);
    const [isConnected, setConnected] = React.useState(false);

    React.useEffect(() => {
        const client = socket.connect(serverUrl);
        client.on("connect", () => setConnected(true));
        client.on("disconnect", () => setConnected(false));
        client.on(topic, (data) => {
            setTemp(data);
        })
    }, [serverUrl, topic, isConnected]);

    return { temp, isConnected };
}

// Our component which sends the request through the topic
const Sockt = () => {
    const serverUrl='http://localhost:8080', topic='temperature';
    const { temp, isConnected } = useSocket(serverUrl, topic);

    return (
        <div>
            <h4>Temperature</h4>
            <h1>{temp}</h1>
            <h3>{`CONNECTED: ${isConnected}`}</h3>
        </div>
    )
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç»„ä»¶ç°åœ¨å°†æ˜¾ç¤ºä»å¥—æ¥å­—æœåŠ¡å™¨æ¥æ”¶çš„æ¸©åº¦ã€‚æ¯æ¬¡é€šè¿‡å¥—æ¥å­—å‘é€æ•°æ®æ—¶ã€‚

æˆ‘å¸Œæœ›ï¼Œä½ èƒ½å­¦åˆ°ä¸€äº›æ–°çš„æœ‰è¶£çš„ä¸œè¥¿ã€‚æ‰¾åˆ°ä»£ç æ²™ç®±æ¥å®ç°æˆ‘ä»¬åœ¨æ•´ç¯‡æ–‡ç« ä¸­æ‰€è®¨è®ºçš„å†…å®¹ã€‚

https://codesandbox.io/s/express-socket-io-70t5x åç«¯å¥—æ¥å­—æœåŠ¡å™¨ğŸ§¦
t1

ç”¨é’©å­åšå‡ºååº”
[https://codesandbox.io/s/priceless-greider-3b814](https://codesandbox.io/s/priceless-greider-3b814)