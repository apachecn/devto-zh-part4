# ç†Ÿæ‚‰çš„ç¬¬äºŒå¤©:åœ°çƒåŒ–ç«æ˜Ÿ

> åŸæ–‡:[https://dev . to/nick blow/familiar-day-2-terra forming-mars-17ma](https://dev.to/nickblow/familiar-day-2-terraforming-mars-17ma)

*å›¾ç‰‡æ¥è‡ªçŸ¥è¯†å…±äº«ç”¨æˆ· [Kimika Ying](https://www.flickr.com/photos/48054321@N05) æ ¹æ®[CC BY-NC-SA 2.0](https://creativecommons.org/licenses/by-nc-sa/2.0/?ref=ccsearch&atype=rich)T5ã€‘æˆæƒ*

æ¬¢è¿å›åˆ°æˆ‘å…³äºä»å¤´å¼€å§‹æ„å»ºæˆ‘çš„[å¼€æºæ¡Œé¢ RPG åŠ©æ‰‹](https://github.com/NickBlow/familiar)çš„ç³»åˆ—ã€‚ä»¥é˜²ä½ è¿˜æ²¡çœ‹è¿‡[è¿™æ˜¯](https://dev.to/nickblow/familiar-day-1-4nkm)ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä¸ºæˆ‘çš„é¡¹ç›®åˆ—å‡ºäº†ä¸€ç³»åˆ—é«˜æ°´å¹³çš„ç›®æ ‡ã€‚

ä»Šå¤©æˆ‘å®é™…ä¸Šè¦å†™ä¸€äº›ä»£ç (ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰).[ç¡®åˆ‡åœ°è¯´æ˜¯åœ°å½¢](https://www.terraform.io)é…ç½®ã€‚ã€ŠTerraform å…¥é—¨æŒ‡å—ã€‹ä»…æ¶µç›– AWSï¼Œå› æ­¤è¿™å¯èƒ½ä¼šæˆä¸º GCP ç”¨æˆ·çš„æœ‰ç”¨æŒ‡å—ã€‚ä¹Ÿè®¸å§ã€‚æˆ‘ç”¨çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„ Terraform(æ’°å†™æœ¬æ–‡æ—¶ï¼ŒTerraform v0.12.2)ã€‚

æˆ‘ä¸ä¼šè®²è§£å¦‚ä½•å®‰è£… Terraformï¼Œä½†åœ¨æˆ‘çš„ Mac ä¸Šï¼Œå®ƒå°±åƒ`brew install terraform`ä¸€æ ·ç®€å•ã€‚

### [](#why-google-cloud-platform)ä¸ºä»€ä¹ˆè¦ Google äº‘å¹³å°ï¼Ÿ

æˆ‘ç”¨ AWS å¾ˆå¤šï¼ŒçœŸçš„å¾ˆå¥½ã€‚ä»–ä»¬æ€»æ˜¯ä»¥æå¿«çš„é€Ÿåº¦å¢åŠ æ”¹è¿›ã€‚Azureï¼Œæˆ‘è¿˜æ²¡æœ‰çœŸæ­£ä½¿ç”¨è¿‡ï¼Œä½†ä¼¼ä¹ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„äº‘å¹³å°ã€‚ç„¶è€Œï¼Œå¯¹äºä¸€ä¸ªå¯¹ä»·æ ¼æ•æ„Ÿçš„ä¸ªäººé¡¹ç›®ï¼Œè°·æ­Œäº‘æ‹¥æœ‰æœ€æ…·æ…¨çš„å…è´¹å±‚ï¼Œåªæœ‰*æ°¸è¿œå…è´¹*è®¡ç®—èµ„æº(ä¸åŒ…æ‹¬ FaaSï¼Œè¿™å°†åœ¨ä»¥åå‡ºç°)ã€‚

#### [](#disclaimer-about-my-knowledge-level)å…³äºæœ¬äººçŸ¥è¯†æ°´å¹³çš„å…è´£å£°æ˜

æˆ‘ç»ä¸æ˜¯åœ°å½¢æˆ– GCP ä¸“å®¶ï¼Œä¹Ÿä¸è‡ªç§°æ˜¯â€”â€”æˆ‘è¿™ä¸ªé¡¹ç›®çš„éƒ¨åˆ†ç›®çš„æ˜¯å­¦ä¹ æ›´å¤šå…³äºè¿™äº›å·¥å…·çš„çŸ¥è¯†ã€‚æˆ‘å°†åŠªåŠ›æä¾›å‡†ç¡®å’Œè¯¦ç»†çš„ä¿¡æ¯ï¼Œå¹¶æ˜ç¡®æŒ‡å‡ºæˆ‘å¯¹æœ€ä½³å®è·µä¸ç¡®å®šçš„åœ°æ–¹ã€‚å¦‚æœæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Œæˆ–è€…æˆ‘åšé”™äº†ä»€ä¹ˆï¼Œè¯·å‘Šè¯‰æˆ‘ï¼çŠ¯é”™è¯¯æ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹å¼ã€‚

## [](#lets-get-to-the-code)è®©æˆ‘ä»¬æ¥çœ‹ä»£ç 

### [](#setting-up-a-provider)è®¾ç½®æä¾›å•†

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¾›åº”å•†ã€‚æä¾›è€…è®© Terraform çŸ¥é“ä½¿ç”¨å“ªç»„ APIï¼Œä»¥åŠå¦‚ä½•åˆ›å»ºèµ„æºã€‚åœ¨ [Terraform ç½‘ç«™](https://www.terraform.io/docs/providers/google/getting_started.html)ä¸Šæœ‰ä¸€ä¸ªæœ‰ç”¨çš„ GCP å…¥é—¨æŒ‡å—ã€‚

æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯[è°·æ­Œäº‘](https://cloud.google.com/)ï¼Œæ‰€ä»¥é¦–å…ˆè®©æˆ‘ä»¬åœ¨é‚£é‡Œå»ºç«‹ä¸€ä¸ªè´¦æˆ·ï¼Œå¹¶ä¸‹è½½ [GCloud SDK](https://cloud.google.com/sdk/) ã€‚ä¸€æ—¦æˆ‘ä»¬ä¸‹è½½äº†ï¼Œæˆ‘ä»¬éœ€è¦ç”¨`gcloud init`åˆå§‹åŒ–å®ƒã€‚

#### [](#create-a-service-account)åˆ›å»ºæœåŠ¡è´¦æˆ·

éµå¾ªæ­¤å¤„çš„è¯´æ˜[ã€‚æˆ‘ä»¬åœ¨æ§åˆ¶å°ä¸Šè¿™æ ·åšï¼Œå› ä¸ºå®ƒçš„ CLI ç•Œé¢è¿˜åœ¨æµ‹è¯•é˜¶æ®µã€‚å¯¹äºè§’è‰²ï¼Œæˆ‘ä»¬çœŸçš„åº”è¯¥ä½¿ç”¨æœ€å°ç‰¹æƒ](https://cloud.google.com/iam/docs/creating-managing-service-accounts#iam-service-accounts-create-console)çš„[åŸåˆ™ï¼Œåªç»™æˆ‘ä»¬çš„æœåŠ¡è§’è‰²è®¿é—®å®ƒéœ€è¦åšçš„äº‹æƒ…ã€‚æˆ‘ä»¬å¯èƒ½ä¼šåœ¨è§’è‰²ä¸Šæ¯”æˆ‘ä»¬éœ€è¦çš„æ›´å®½æ³›ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å®Œå…¨ç¡®å®šæˆ‘ä»¬éœ€è¦ä»€ä¹ˆï¼Œä½†æˆ‘ä»¬å¯ä»¥åœ¨ä»¥åå‰Šå‡å®ƒã€‚](https://en.wikipedia.org/wiki/Principle_of_least_privilege)

ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ ä»¥ä¸‹æƒé™:`Compute Engine > Compute Admin`ã€`DNS > DNS Administrator`ã€`Datastore > Cloud Datastore Owner`ã€`Storage > Storage Admin`å’Œ`App Engine > App Engine Admin`ï¼Œå› ä¸ºæˆ‘ä»¬å‡ ä¹è‚¯å®šä¼šéœ€è¦è¿™äº›æƒé™ã€‚è®©æˆ‘ä»¬æš‚æ—¶ç¦»å¼€ Kubernetesã€‚

ä»¥ä¸‹æ˜¯è¿™äº›è§’è‰²çš„æ ·å­: [![Role Dashboard](../Images/77d028bdb350a2a2efdff1a3fe7c99ed.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--ArvaUfuU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/q4xwfcopoebmze167cy4.png)

æˆ‘åˆ›å»ºäº†ä¸€ä¸ª keyï¼Œä¸‹è½½åˆ° JSON é‡Œï¼Œä¿å­˜åˆ°`~/.gcp/terraform-sa.json`ã€‚

ç†æƒ³æƒ…å†µä¸‹ï¼Œä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬å°†ä¸ä¼šæ¥è§¦ GCP æ§åˆ¶å°ã€‚å®é™…ä¸Šï¼Œæ£€æŸ¥èµ„æºç­‰æ˜¯æœ‰ç”¨çš„ã€‚ä½†æ˜¯é™¤äº†æ›´æ”¹æœåŠ¡è§’è‰²çš„æƒé™ä¹‹å¤–ï¼Œæˆ‘ä»¬åº”è¯¥ä» CLI å’Œ terraform åšæ‰€æœ‰çš„äº‹æƒ…ã€‚

#### [](#our-terraform-configuration)æˆ‘ä»¬çš„åœ°å½¢é…ç½®

Terraform ç¡®å®æ˜¯å¯ç»„åˆçš„ï¼Œå¯ä»¥è®©ä½ å¾ˆå®¹æ˜“åœ°æŠŠä¸œè¥¿åˆ†æˆå¤šä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯ç°åœ¨è®©æˆ‘ä»¬æŠŠå®ƒä»¬éƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œã€‚æˆ‘éå¸¸å–œæ¬¢è®©äº‹æƒ…è¿è½¬èµ·æ¥ï¼Œç„¶åå°½æ—©åœ°ã€ç»å¸¸åœ°é‡æ„ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€äº›[å˜é‡](https://www.terraform.io/docs/configuration/variables.html)ï¼Œè¿™æ ·æ‰€æœ‰çš„é…ç½®éƒ½æ˜¯é€šç”¨çš„ã€‚æˆ‘å·²ç»å°†å®ƒä»¬æ·»åŠ åˆ°ä¸€ä¸ª`variables.tf`æ–‡ä»¶ä¸­ï¼Œæˆ‘è¿˜ä¸ç¡®å®šæˆ‘æ˜¯å¦ä¼šæäº¤ç»™æºä»£ç æ§åˆ¶â€”â€”æˆ‘åªæ˜¯ä¸æäº¤å®ƒï¼Œå¦‚æœæˆ‘å†³å®šè¦åšä»€ä¹ˆï¼Œæˆ‘ä¼šæŠŠå®ƒæ”¾å…¥. gitignore ä¸­ã€‚

```
variable "region" {
  type = string
  default ="YOUR_REGION_HERE"
}

variable "project_id" {
    type = string
    default = "YOUR_PROJECT_ID_HERE"
}

variable "service_account_location" {
    type = string
    default = "YOUR_SERVICE_ACCOUNT_LOCATION_HERE"
}

variable "zone" {
  type = string
  default = "YOUR_ZONE_HERE"
} 
```

å¡«å†™ä¸Šé¢çš„é»˜è®¤å€¼ï¼Œä¿å­˜æ–‡ä»¶ï¼Œç„¶åè®©æˆ‘ä»¬è¿›å…¥æˆ‘ä»¬çš„ main.tf æ–‡ä»¶ã€‚æœåŠ¡å¸æˆ·ä½ç½®æ˜¯æŒ‡æ‚¨åœ¨ä¸Šé¢å­˜å‚¨æœåŠ¡å¸æˆ· JSON æ–‡ä»¶çš„ä½ç½®ã€‚

**âš ï¸WARNINGâš ï¸:è°·æ­Œè®¡ç®—å¼•æ“å…è´¹ç­‰çº§ä»…é€‚ç”¨äºç¾å›½è¥¿éƒ¨ 1ã€ç¾å›½ä¸­éƒ¨ 1ã€ç¾å›½ä¸œéƒ¨ 1 åœ°åŒº**ã€‚åœ°åŒºå’ŒåŒºåŸŸçš„å®Œæ•´åˆ—è¡¨å¯ä»¥åœ¨[è¿™é‡Œ](https://cloud.google.com/compute/docs/regions-zones/)æ‰¾åˆ°ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨â€œè°·æ­Œâ€æä¾›å•†ï¼Œä½†æˆ‘ä»¬å¯èƒ½ä¼šåœ¨ä»¥åå‡çº§åˆ°â€œè°·æ­Œæµ‹è¯•ç‰ˆâ€æä¾›å•†ï¼Œå› ä¸ºæˆ‘å…³æ³¨ä¸€äº›æµ‹è¯•ç‰ˆåŠŸèƒ½ï¼Œå¦‚[ä» Firestore æ›´æ”¹ä¸­è§¦å‘äº‘åŠŸèƒ½](https://firebase.google.com/docs/firestore/extend-with-functions)ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥[å…¥é—¨æŒ‡å—](https://www.terraform.io/docs/providers/google/getting_started.html)ä¸­çš„è®¡ç®—å®ä¾‹é…ç½®ä¸ºä¾‹ã€‚

æˆ‘çš„`main.tf`ç°åœ¨çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```
provider "google" {
  credentials = "${file(var.service_account_location)}"
  project     = var.project_id
  region      = var.region
  zone = var.zone
}

resource "google_compute_instance" "vm_instance" {
  name         = "terraform-instance"
  machine_type = "f1-micro"

  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-9"
    }
  }

  network_interface {
    # A default network is created for all GCP projects
    network       = "default"
    access_config {
    }
  }
} 
```

*æ³¨æ„:è¯­æ³•é«˜äº®ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºä»–ä»¬æ”¹å˜äº†åœ¨ Terraform 0.12 ä¸­[è¡¨è¾¾å¼](https://www.terraform.io/docs/configuration/expressions.html)çš„å·¥ä½œæ–¹å¼ã€‚å®ƒç¼–è¯‘æ­£ç¡®ï¼Œæˆ‘ä¿è¯ï¼*

è®©æˆ‘ä»¬`cd`è¿›å…¥æœ‰ terraform æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œåœ¨*ç†Ÿæ‚‰çš„*å®ƒè¢«åˆ›é€ æ€§åœ°ç§°ä¸ºâ€˜terra formâ€™ã€‚å®ƒåº”è¯¥æœ‰ä¸¤ä¸ªæ–‡ä»¶`variables.tf`å’Œ`main.tf`ã€‚

è¿è¡Œ`terraform init`æ¥åˆå§‹åŒ–ä¸€åˆ‡ï¼Œç„¶åè¿è¡Œ`terraform apply`æ¥æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’ã€‚æ£€æŸ¥è¿™ä¸€åˆ‡çœ‹èµ·æ¥æ­£å¸¸ï¼Œç„¶åé”®å…¥`yes`ã€‚

å‡ ç§’é’Ÿå:
[![Terraform's complete!](../Images/8c7783610a323f008a863bce77d07e29.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--K4CIy_St--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/eskqdokw0tl6lcvwb0d1.png)

è®©æˆ‘ä»¬è¿›å…¥è°·æ­Œäº‘æ§åˆ¶å°-
[![Our running instance](../Images/9660a57782b5b42047dc555eb2647b10.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--g0w_6UmZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/rodd70f6hbloijaau5i5.png)

çœŸæ£’ğŸ¥³ï¼æˆ‘ä»¬å·²ç»å»ºç«‹äº†ä¸€äº›åŸºç¡€è®¾æ–½ã€‚å®ƒè¿˜æ²¡æœ‰åšå¤ªå¤šï¼Œä½†æˆ‘ä»¬ä¼šåŠæ—¶å®ç°çš„ã€‚

## [](#next-time)ä¸‹æ¬¡:

(å¯èƒ½ä¼šæ›´æ”¹)æˆ‘ä»¬å°†ä½¿ç”¨ terraform åšä¸€äº›å®é™…çš„äº‹æƒ…ï¼Œè®¾ç½®ä¸€äº›å­˜å‚¨ï¼Œå¹¶è®¾ç½®ä¸€ä¸ª [Terraform åç«¯](https://www.terraform.io/docs/backends/)æ¥å­˜å‚¨æˆ‘ä»¬çš„é…ç½®ï¼Œå› ä¸ºè¿™å°†ä½¿å¤šäººç®¡ç†å˜å¾—æ›´å®¹æ˜“ï¼Œå¹¶ä¸”é€šå¸¸æ˜¯ä¸€ç§å¥½çš„åšæ³•ã€‚