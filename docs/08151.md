# ç”¨ Rust å’Œ POM è§£æä¸–ç•Œ

> åŸæ–‡ï¼š<https://dev.to/pragmalang/parsing-the-world-with-rust-and-pom-eb6>

ä½œä¸ºç¨‹åºå‘˜ï¼Œæˆ‘ä»¬èŠ±å¾ˆå¤šæ—¶é—´å¤„ç†æ–‡æœ¬å­—ç¬¦ä¸²ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä»ç”¨æˆ·é‚£é‡Œæ¥æ”¶æ–‡æœ¬ä½œä¸ºè¾“å…¥ï¼Œæˆ–è€…æˆ‘ä»¬é˜…è¯»æ–‡æœ¬æ–‡ä»¶å¹¶è¯•å›¾ç†è§£å®ƒä»¬çš„å†…å®¹ã€‚

åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æŸ¥çœ‹æ–‡æœ¬æ˜¯å¦åŒ¹é…æŸç§æ¨¡å¼ï¼Œæˆ–è€…ä»å­—ç¬¦ä¸²ä¸­æå–ä¸€äº›ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ”¶åˆ°ä¸€ä¸ªç”¨æˆ·åä½œä¸ºè¡¨å•è¾“å…¥ï¼Œå¹¶ä¸”æ‚¨æƒ³ç¡®ä¿å®ƒä¸åŒ…å«ä»»ä½•ç©ºæ ¼ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼äº`"^\S+$"`çš„æ­£åˆ™è¡¨è¾¾å¼å°†ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ä¸€ä¸ªæˆ–å¤šä¸ªéç©ºç™½å­—ç¬¦è¿›è¡ŒåŒ¹é…(`^`è¡¨ç¤ºå­—ç¬¦ä¸²çš„å¼€å¤´ï¼Œ`\S`è¡¨ç¤ºéç©ºç™½å­—ç¬¦ï¼Œ`+`è¡¨ç¤ºé‡å¤ä¸€æ¬¡æˆ–å¤šæ¬¡ï¼Œ`$`è¡¨ç¤ºå­—ç¬¦ä¸²çš„ç»“å°¾)ã€‚ä½ ç”šè‡³å¯ä»¥å†™ä¸€ä¸ªç±»ä¼¼äº
çš„å‡½æ•°

```
fn has_whitespaces(s: String) -> bool {
  s.contains(' ')
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> ä½ èƒ½æ‰¾å‡ºä»£ç ä¸­çš„é”™è¯¯å—ï¼Ÿ

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨è¯•å›¾è§£ææ›´å¤æ‚çš„å­—ç¬¦ä¸²çš„å†…å®¹å‘¢ï¼Ÿæ¯”å¦‚è¯´ï¼Œä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œä¸€ä¸ª CSV(é€—å·åˆ†éš”å€¼)æ–‡ä»¶ï¼Œç”šè‡³ä¸€ä¸ªç¨‹åºï¼Ÿå¦‚æœä½ ä¸ä½¿ç”¨ç°æœ‰çš„åº“å‡½æ•°ï¼Œä½ å°†å¾ˆéš¾ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œå­—ç¬¦ä¸²æ–¹æ³•ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢ [POM](https://github.com/J-F-Liu/pom) åº“ï¼Œå®ƒä¸ºç›´è§‚åœ°å®šä¹‰å’Œç»„åˆè§£æå™¨æä¾›äº†ä¸€ä¸ªéå¸¸é…·çš„ç•Œé¢ã€‚ä½¿ç”¨è¿™ä¸ªåº“ï¼Œä½ å¯ä»¥æ–¹ä¾¿åœ°å®šä¹‰ä¸€é—¨æ­£å¼è¯­è¨€çš„å…¨éƒ¨è¯­æ³•(ä¹Ÿè®¸æ˜¯ä½ è‡ªå·±çš„æ–°ç¼–ç¨‹è¯­è¨€ï¼Ÿ)

POM æ˜¯ä¸€ä¸ª [PEG](https://en.wikipedia.org/wiki/Parsing_expression_grammar) (è§£æè¡¨è¾¾å¼è¯­æ³•)çš„å®ç°ï¼Œå®ƒæ˜¯ä¸€ç§å½¢å¼è¯­è¨€åœ¨ç¬¦å·ã€å­—ç¬¦ä¸²è¡¨è¾¾å¼å’Œè§„åˆ™æ–¹é¢çš„å®šä¹‰ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬è¦å®šä¹‰ä¸€ä¸ªè§£æå˜é‡å®šä¹‰çš„è§„åˆ™ï¼Œæ¯”å¦‚:`let x = 1;`ï¼Œæˆ‘ä»¬ä¼šè¯´`let`æ˜¯ä¸€ä¸ªç¬¦å·åºåˆ—ï¼Œ`=`ï¼Œ`;`ï¼Œç©ºæ ¼æ˜¯ç¬¦å·ï¼Œ`x`å’Œ`1`æ˜¯å­—ç¬¦ä¸²è¡¨è¾¾å¼ã€‚å˜é‡å®šä¹‰åŒ…æ‹¬`let`åºåˆ—ï¼Œåé¢æ˜¯ä¸€ä¸ªç©ºæ ¼ï¼Œåé¢æ˜¯**æœ‰æ•ˆæ ‡è¯†ç¬¦**(ä¾‹å¦‚`x`ï¼Œåé¢æ˜¯é›¶ä¸ªæˆ–å¤šä¸ªç©ºæ ¼ï¼Œåé¢æ˜¯`=`ç¬¦å·ï¼Œåé¢æ˜¯é›¶ä¸ªæˆ–å¤šä¸ªç©ºæ ¼ï¼Œåé¢æ˜¯ä¸€ä¸ªæœ‰æ•ˆè¡¨è¾¾å¼(æœ¬ä¾‹ä¸­ä¸º`1`ï¼Œåé¢æ˜¯é›¶ä¸ªæˆ–å¤šä¸ªç©ºæ ¼å’Œ`;`ç¬¦å·ã€‚æœ‰ç‚¹å•°å—¦ï¼Œä¸æ˜¯å—ï¼Ÿè¿™å°±æ˜¯å½¢å¼è¯­è¨€çš„å®šä¹‰ã€‚

å¹¸è¿çš„æ˜¯ï¼ŒPOM æä¾›äº†å®šä¹‰è¿™äº›è§„åˆ™çš„éå¸¸æ˜ç¡®çš„æ–¹å¼ã€‚å®ƒå…è®¸æˆ‘ä»¬å®šä¹‰ä¸åŒçš„è§„åˆ™æ¥è§£ææ¯ä¸€å°æ®µæ–‡æœ¬ï¼Œç„¶åä½¿ç”¨ç®—æœ¯å’Œé€»è¾‘è¿ç®—ç¬¦å°†å®ƒä»¬ç»„åˆèµ·æ¥ï¼Œå½¢æˆæ›´å¤æ‚çš„è§„åˆ™ã€‚è¿™äº›æ“ä½œç¬¦è¢«ç§°ä¸º*è§£æå™¨ç»„åˆå­*ã€‚

POM å®šä¹‰äº†ä¸€ä¸ªå«åš`Parser`çš„ç±»å‹ï¼Œç”¨æ¥ç¼–ç è§£æè§„åˆ™ã€‚å¯ä»¥ä½¿ç”¨è¯¥åº“æä¾›çš„è®¸å¤šé¢„å®šä¹‰è§£æå™¨æ¥æ„å»ºè§£æå™¨ï¼Œæ¯”å¦‚`sym`å’Œ`seq`å‡½æ•°ã€‚ä¸Šé¢è¿™ä¸ªå˜é‡å®šä¹‰çš„ä¾‹å­å¯ä»¥ç”¨ POM è¡¨ç¤ºä¸º:

```
use pom::char_class::*;
use pom::parser::*;

fn variable_def<'a>() -> Parser<'a, u8, (String, u32)> {
  let valid_id = (is_a(alpha) + is_a(alphanum).repeat(0..))
    .map(|(first, rest)| format!("{}{}", first as char, String::from_utf8(rest).unwrap()));
  let valid_expr = one_of(b"0123456789")
    .repeat(1..10)
    .convert(String::from_utf8)
    .convert(|s| s.parse::<u32>());
  seq(b"let") * sym(b' ') * valid_id - sym(b' ') - sym(b'=') 
    - sym(b' ').repeat(0..) + valid_expr - sym(b';')
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬åˆ†è§£ä»£ç :
1â€”â€”æˆ‘ä»¬å¯¼å…¥`pom::char_class`çš„æ‰€æœ‰å†…å®¹ï¼Œå®ƒå¯¼å‡º
è°“è¯ï¼Œå¦‚`alpha`å’Œ`alphanum`ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™äº›è°“è¯æ¥æµ‹è¯•è¾“å…¥å­—ç¬¦çš„ç±»å‹ã€‚
`pom::parser`å¯¼å‡º`seq`ï¼Œ`sym`ä»¥åŠå…¶ä»–è¿”å›
`Parser`
çš„å‡½æ•°

```
use pom::char_class::*;
use pom::parser::*; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

2-`variable_def`å‡½æ•°ä¸å¸¦å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªç”Ÿå­˜æœŸä¸º`'a`çš„`Parser`
ï¼Œæ¥å—`u8` s(å­—ç¬¦å­—èŠ‚)ä½œä¸ºè¾“å…¥ï¼Œ
è¾“å‡ºä¸€ä¸ª`(String, u32)`çš„å…ƒç»„ã€‚å…ƒç»„ç¼–ç å˜é‡çš„
æ ‡è¯†ç¬¦åŠå…¶å€¼(ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†æœ‰æ•ˆå€¼é™åˆ¶ä¸º 9 ä½æ­£æ•´æ•°
ã€‚)

```
fn variable_def<'a>() -> Parser<'a, u8, (String, u32)> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

3 -æœ‰æ•ˆçš„å˜é‡æ ‡è¯†ç¬¦è‡³å°‘ç”±ä¸€ä¸ªå­—æ¯å­—ç¬¦ç»„æˆï¼Œåè·Ÿé›¶ä¸ªæˆ–å¤šä¸ªå­—æ¯æ•°å­—å­—ç¬¦ã€‚æˆ‘ä»¬ä½¿ç”¨`is_a`è§£æå™¨æ¥æµ‹è¯•å˜é‡ id çš„ç¬¬ä¸€ä¸ªå­—ç¬¦`is_a(alpha)`ï¼Œä»¥åŠ id çš„å…¶ä½™éƒ¨åˆ†`is_a(alphanum)`ã€‚
æ³¨æ„`+`æ“ä½œç¬¦æ˜¯å¦‚ä½•ç”¨äºç»„åˆå˜é‡æ ‡è¯†ç¬¦çš„ä¸¤ä¸ªéƒ¨åˆ†çš„ã€‚å®ƒè¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæ“ä½œæ•°ç»“æœçš„å…ƒç»„ï¼Œç„¶åæˆ‘ä»¬åœ¨`map`æ–¹æ³•è°ƒç”¨ä¸­ææ„å®ƒã€‚`map`ç”¨äºè½¬æ¢ä¸€ä¸ªè§£æå™¨çš„ç»“æœï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„è§£æå™¨ã€‚åœ¨æœ¬ä¾‹ä¸­:`(is_a(alpha) + is_a(alphanum).repeat(0..))`è¿”å›ä¸€ä¸ª`Parser<'a, u8, (u8, Vec<u8>)>`(ç¬¬ä¸€ä¸ªå­—ç¬¦å’Œå…¶ä½™çš„å­—ç¬¦)ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡ä½¿ç”¨`format!`è¿æ¥ç¬¬ä¸€ä¸ªå­—ç¬¦å’Œå…¶ä½™çš„å­—ç¬¦ï¼Œå°†å®ƒè½¬æ¢æˆä¸€ä¸ª`Parser<'a, u8, String>`(æ•´ä¸ªæ ‡è¯†ç¬¦)ã€‚

```
let valid_id = (is_a(alpha) + is_a(alphanum).repeat(0..))
    .map(|(first, rest)| format!("{}{}", first as char, String::from_utf8(rest).unwrap())); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

4 -ä¸€ä¸ªæœ‰æ•ˆçš„è¡¨è¾¾å¼è¢«å®šä¹‰ä¸º 1 åˆ° 9 ä¸ªæ•°å­—è¢«è½¬æ¢æˆä¸€ä¸ª`String`ï¼Œç„¶åè¢«è§£æä¸ºä¸€ä¸ª`u32`ã€‚è¿™é‡Œä½¿ç”¨`convert`è€Œä¸æ˜¯`map`ï¼Œå› ä¸º`String::from_utf8`è¿”å›ä¸€ä¸ª`Result`ï¼Œæ‰€ä»¥å¦‚æœ`String::from_utf8`çš„ç»“æœæ˜¯`Err`ï¼Œè§£æå™¨ä¸ä¼šåŒ¹é…è¡¨è¾¾å¼ã€‚

```
let valid_expr = one_of(b"0123456789")
    .repeat(1..10)
    .convert(String::from_utf8)
    .convert(|s| s.parse::<u32>()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

5 -è¿”å›çš„è§£æå™¨æ˜¯ä¸Šé¢æåˆ°çš„ç¬¦å·ä¸ä¸€äº›ç©ºæ ¼çš„ç»„åˆï¼Œä»¥åŠä¸€ä¸ªæœ‰æ•ˆçš„æ ‡è¯†ç¬¦å’Œè¡¨è¾¾å¼ã€‚`*`æ“ä½œç¬¦ç»„åˆä¸¤ä¸ªè§£æå™¨å¹¶è¿”å›å³è¾¹è§£æå™¨çš„ç»“æœã€‚æ‰€ä»¥`Parser<'a, u8, T> * Parser<'a, u8, U> = Parser<'a, u8, U>`ã€‚æˆ‘ä»¬è¿˜çœ‹åˆ°äº†æ­£åœ¨ä½¿ç”¨çš„`-`æ“ä½œç¬¦ï¼Œå®ƒç»„åˆäº†ä¸¤ä¸ªè§£æå™¨ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«å·¦ä¾§è§£æå™¨å€¼çš„è§£æå™¨ã€‚è¿™äº›æ“ä½œç¬¦éµå¾ªä¸ Rust ä¸­æ™®é€šç®—æœ¯æ“ä½œç¬¦ç›¸åŒçš„ä¼˜å…ˆè§„åˆ™ã€‚

```
seq(b"let") * sym(b' ') * valid_id - sym(b' ') - sym(b'=') 
    - sym(b' ').repeat(0..) + valid_expr - sym(b';') 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> çœ‹çœ‹[è¿™ä¸ªæ–¹ä¾¿çš„è§£æå™¨ç»„åˆå­è¡¨](https://github.com/J-F-Liu/pom#list-of-predefined-parsers-and-combinators)ã€‚

ç°åœ¨æ¥æµ‹è¯•æˆ‘ä»¬çš„è§£æå™¨:

```
#[test]
fn test_variable_parser() {
  let valid_variable_byte_string = b"let v1 = 42;";
  let parsed_variable = variable_def().parse(valid_variable_byte_string);
  assert_eq!(parsed_variable, Ok(("v1".to_string(), 42)));

  let invalid_variable_byte_string = b"let nosemicolon = 42";
  let parsed_variable = variable_def().parse(invalid_variable_byte_string);
  assert_eq!(parsed_variable, Err(pom::Error::Incomplete));

  let invalid_variable_byte_string = b"let morethan9digits = 1234567890;";
  let parsed_variable = variable_def().parse(invalid_variable_byte_string);
  assert_eq!(
    parsed_variable,
    Err(pom::Error::Mismatch {
      message: "expect: 59, found: 48".to_string(),
      position: 31
    })
  );
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨ POM æ¥è§£ææ­£æ•´æ•°å€¼çš„å˜é‡å®šä¹‰å¯èƒ½çœ‹èµ·æ¥æœ‰äº›è¿‡ç«ï¼Œä½†æ˜¯è¯·æƒ³è±¡ä¸€ä¸‹ç”¨å®ƒæ¥è§£ææ•´ä¸ªç¼–ç¨‹è¯­è¨€ã€‚

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚ç°åœ¨äº«å—ç”¨ä½ çš„æ–¹å¼è§£ææ¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

ç‰¹åˆ«æ„Ÿè°¢[åˆ˜ä¿Šå³°](https://github.com/J-F-Liu)å’Œæ‰€æœ‰è´¡çŒ®è€…åˆ›é€ äº†ä¸€ä¸ªæƒŠäººçš„å›¾ä¹¦é¦†ã€‚ä½ åº”è¯¥å¾—åˆ°ä¸€å—é¥¼å¹²ğŸª