# ä½¿ç”¨ PyYAML é…ç½® Alertmanager

> åŸæ–‡:[https://dev . to/serializer/alert manager-configuration-with-pyyaml-and-include-1504](https://dev.to/serializator/alertmanager-configuration-with-pyyaml-and-include-1504)

**æˆ‘çš„å™©æ¢¦å°±åƒæ˜¯è¯•å›¾ç”¨ Alertmanager ä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶**ğŸ’€ğŸ‘€

æˆ‘æœ€è¿‘å¼€å§‹ç›‘æ§æˆ‘ä»¬åœ¨[æä¾›çš„](https://www.weprovide.com)çš„ä¸€äº›å†…éƒ¨å·¥å…·å’ŒæœåŠ¡ã€‚ä½œä¸ºç¬¬ä¸€æ¬¡å°è¯•ï¼Œæˆ‘å†³å®šä¿®è¡¥ä¸€ä¸‹â€œæ™®ç½—ç±³ä¿®æ–¯ã€æ ¼æ‹‰å¤«çº³å’Œ Alertmanagerâ€å †æ ˆã€‚

æ˜¾ç„¶ï¼Œæˆ‘ä»¬æœ‰äº›å°é—®é¢˜...ğŸ’©

[![I over engineered...](img/97512ff70a72046fc0ebbcdd11dd4461.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--xSrHYsiC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/lo8hgm03jfsac1yrgsy8.jpg)

æœ€åˆæˆ‘å¼€å§‹è€ƒè™‘ä¸€ä¸ªæˆ‘å¯ä»¥ç¼–å†™çš„å·¥å…·ï¼Œç±»ä¼¼äº`am-stitcher` ( *ssooo åŸåˆ›ï¼Œå®Œå…¨ä¸åƒ`amtool`...*)ï¼Œä½†æ˜¯...æˆ‘æ„è¯†åˆ°æˆ‘è¿‡åº¦è®¾è®¡äº†ä¸€äº›ä¸œè¥¿ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å°†å¤šä¸ª YAML æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªã€‚

è°·æ­Œï¼Œæˆ‘æ¥äº†ï¼Œè¯·ç»™æˆ‘ä¸€äº›æœ‰ç”¨æˆ–å¯å¤åˆ¶ç²˜è´´çš„ä¸œè¥¿ï¼â¤ï¸
å°±å­—é¢ä¸Šçš„åˆå¹¶è€Œè¨€ï¼Œæˆ‘çœŸçš„æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è¶³ä»¥æ»¡è¶³è¿™ä¸ªç”¨ä¾‹çš„ä¸œè¥¿ã€‚

æˆ‘é‡åˆ°çš„ä¸€äº›å·¥å…·åšäº†æˆ‘æƒ³è®©å®ƒä»¬åšçš„äº‹æƒ…ï¼Œä½†æ˜¯ä¸èƒ½è®©æˆ‘æ§åˆ¶ä»¥ä»€ä¹ˆé¡ºåºåˆå¹¶å®ƒä»¬ã€‚æœ‰äº›æ˜¯è¿™æ ·ï¼Œä½†æ˜¯å®ƒä»¬è¦æ±‚æˆ‘å•ç‹¬æŒ‡å®šæ¯ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯èƒ½å¤Ÿé€’å½’åœ°æœç´¢ä¸€ä¸ªç›®å½•ã€‚

**PyYAML ä¸ pyyaml-include** ğŸ’Œ ğŸ’•æˆ‘åœ¨ YAML æ‰¾åˆ°äº†ä¸€ç¯‡å…³äºçš„æ–‡ç« ï¼Œå°½ç®¡æˆ‘å¾ˆå¤©çœŸï¼Œä½†æˆ‘è®¤ä¸ºè¿™åœ¨ YAML å¯èƒ½è¡Œå¾—é€š...ä½†æ˜¯ï¼Œå½“ç„¶ï¼Œå®ƒæ²¡æœ‰ï¼

å¯¹`!include`çš„æ”¯æŒæ˜¯ç”±`pyyaml-include`æ‰©å±•æ·»åŠ çš„ï¼Œå®ƒå°†è¿™ä¸ªâ€œæŒ‡ä»¤â€æ·»åŠ åˆ° PyYAML ä¸­ã€‚

å› æ­¤...æˆ‘å°è¯•ä½¿ç”¨ PIP å®‰è£… PyYAML å’Œ`pyyaml-include`æ‰©å±•ï¼Œå¸Œæœ›ä½¿ç”¨ PyYAML çš„è§£æåªä¸ CLI ä¸€èµ·å·¥ä½œï¼Œå¹¶ä¸”å®ƒä¼šè‡ªåŠ¨ä½¿ç”¨`pyyaml-include`æ‰©å±•ã€‚ä½†æ˜¯æˆ‘æ‰¾ä¸åˆ°åªåœ¨ CLI ä¸­ä½¿ç”¨ PyYAML çš„æ–¹æ³•...

æˆ‘çœŸçš„ä¸åº”è¯¥è¿™ä¹ˆå¤©çœŸ...ä½ ä¸ä¹Ÿè¿™æ ·è®¤ä¸ºå—ï¼ŸğŸ˜¬ğŸ˜…

æˆ‘æœ€ç»ˆç¼–å†™çš„æ˜¯ä¸€ä¸ªå° Python è„šæœ¬ï¼Œå®ƒå¯¼å…¥ PyYAML å¹¶ä½¿ç”¨`pyyaml-include`è§£æ`!include`â€œæŒ‡ä»¤â€ã€‚

ä¸è¦è¢«æ„šå¼„äº†ï¼Œè¿™æ˜¯å¤§é‡çš„å¤åˆ¶ç²˜è´´å’Œåå¤è¯•éªŒçš„ç»“åˆï¼ğŸ”¥

```
import sys
import os
import yaml
from yamlinclude import YamlIncludeConstructor

YamlIncludeConstructor.add_to_loader_class(loader_class=yaml.FullLoader, base_dir=os.getcwd())

data = ''

for line in sys.stdin:
    data += line

data = yaml.load(data, Loader=yaml.FullLoader)
yaml.dump(data, sys.stdout, default_flow_style=False) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘å†³å®šä½¿ç”¨æ ‡å‡†çš„è¾“å…¥(`sys.stdin`)å’Œè¾“å‡º(`sys.stdout`)æµè¿›è¡Œè¯»å†™ã€‚å½“æˆ‘ç”šè‡³ä¸çŸ¥é“ Python è¯­æ³•çš„æ—¶å€™ï¼Œæˆ‘ä¸æƒ³ä¸ºä½¿ç”¨å‚æ•°è€Œçƒ¦æ¼ğŸ˜…

```
python parse-yaml.py < alertmanager.yml > merged.yml 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¦ä¸è¦å¢åŠ ä¸€ç‚¹è‡ªåŠ¨åŒ–ï¼Ÿï¼ğŸ™Œ

åœ¨æˆ‘ä»¬æä¾›çš„äº§å“ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨ Bitbucketï¼Œå¯¹äºå¼€æºäº§å“ï¼Œæˆ‘ä»¬ä½¿ç”¨ GitHub(æ˜¾ç„¶...)ï¼Œä½†å¯¹äºå¤§å¤šæ•°ä¸œè¥¿ï¼Œæˆ‘ä»¬ä½¿ç”¨ Bitbucketã€‚

å®ƒç”±ä¸‰ä¸ªæ­¥éª¤ç»„æˆï¼Œâ€œè§£æå’Œåˆå¹¶â€ã€â€œéªŒè¯â€å’Œâ€œéƒ¨ç½²â€ã€‚æˆ‘è§‰å¾—è¿™äº›éƒ½æ˜¯ä¸è¨€è‡ªæ˜çš„ï¼Œä½ ä¸è§‰å¾—å—ï¼ŸğŸ˜Š

```
pipelines:
  default:
    - step:
        name: Parse & Merge
        image: python:3.5.1
        script:
          - pip install pyyaml pyyaml-include
          - python parse-yaml.py < alertmanager.yml > merged.yml
        artifacts:
          - merged.yml
    - step:
        name: Validate
        image: serializator/amtool
        script:
          - amtool check-config merged.yml
    - step:
        name: Deploy
        image: eeacms/rsync
        script:
          - rsync merged.yml $USER@$HOST:$ALERTMANAGER_YAML
          - curl -L -X POST $HOST$RELOAD_PATH 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­ä¸€ä¸ªå›¾åƒæ˜¯`serializator/amtool`ã€‚æœ€åˆæˆ‘å°è¯•ä½¿ç”¨æ€ç§‘å…ƒäº‘(Anthony Rogliano) çš„ [`amtool-docker`å›¾åƒã€‚ä½†æ˜¯å®ƒå»ºç«‹åœ¨`golang:1.9-alpine3.6`ä¹‹ä¸Šçš„äº‹å®å¯¼è‡´äº†åœ¨ Bitbucket ç®¡é“ä¸­ä½¿ç”¨`/bin/bash`è€Œä¸æ˜¯`/bin/sh`çš„é—®é¢˜ã€‚](https://hub.docker.com/r/metacloud/amtool-docker)

*^å¦‚æœä½ çŸ¥é“è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ–è€…å¦‚æœæˆ‘åœ¨ Bitbucket ç®¡é“ä¸­å¿½ç•¥äº†ä¸€äº›æˆ‘å¯ä»¥é…ç½®çš„ä¸œè¥¿ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼* â¤ï¸

æˆ‘æœ€ç»ˆåšçš„æ˜¯åˆ†å‰å­˜å‚¨åº“å¹¶åœ¨`golang:1.13-stretch`è€Œä¸æ˜¯`golang:1.9-alpine3.6`ä¸Šæ„å»ºæ˜ åƒã€‚

*^æˆ‘æƒ³è¿‡ä¸ä½¿ç”¨ alpine æ ‡ç­¾ä¼šå¢åŠ å°ºå¯¸ï¼Œä½†ä»ç”¨ä¾‹æ¥çœ‹ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯å¯ä»¥å¿½ç•¥çš„ã€‚*

**æˆ‘çˆ±ä¸Šäº†â€œ/-/reloadâ€ç«¯ç‚¹**ğŸ™ˆğŸ™Š
æˆ‘ä»¥ä¸ºæˆ‘å¿…é¡»ä½¿ç”¨ SSH å’Œ Docker Compose æ¥é‡å¯ Alertmanager æœåŠ¡ï¼Œä½†å¹¸è¿çš„æ˜¯ï¼Œå®ƒæ²¡æœ‰é‚£ä¹ˆéš¾çœ‹ã€‚

åœ¨ 2016 å¹´çš„æŸä¸ªåœ°æ–¹ï¼Œ[ç”„é˜³æ˜­](https://github.com/ZhenyangZhao)ä»‹ç»äº†`/-/reload`ç«¯ç‚¹ï¼Œæˆ‘å¾ˆé«˜å…´ä»–æå‡ºäº†é‚£ä¸ªæ‹‰è¯·æ±‚ï¼çŸ¥é“æˆ‘çš„ä¸€ä¸ªéƒ¨ç½²ä¸­æ²¡æœ‰ cURLï¼Œæˆ‘ä¸çŸ¥é“æˆ‘å°†å¦‚ä½•é¢å¯¹è‡ªå·±...

å› æ­¤ï¼Œæˆ‘æ¯«ä¸çŠ¹è±«åœ°å¿«é€Ÿç¼–å†™äº†ä¸€è¡Œä»£ç å‘`/-/reload`ç«¯ç‚¹å‘é€ POST è¯·æ±‚ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®äº†ä¸€äº›ä¸œè¥¿ï¼Œå¹¶å°†å…¶æ¨é€ç»™ masterï¼

æˆ‘ä¸çŸ¥é“è¿™ç§å¿«ä¹çš„å­˜åœ¨ï¼ğŸ˜ŠğŸ”¥æˆ‘ç»ˆäºèººåœ¨åºŠä¸Šï¼Œé—­ä¸Šçœ¼ç›ï¼Œè„¸ä¸Šå¸¦ç€å¹¸ç¦çš„å¾®ç¬‘ï¼Œå¼€å§‹æ¢¦è§æˆ‘å°†è¦å†™çš„è®¸å¤šæ–‡ä»¶ã€æ–‡ä»¶å¤¹å’Œä¸œè¥¿ï¼ğŸ˜†

æˆ‘å¸Œæœ›ä½ ä»ä¸­å¾—åˆ°ä¸€äº›æœ‰ç”¨çš„ä¸œè¥¿ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæˆ‘å¸Œæœ›ä½ è‡³å°‘å–œæ¬¢é˜…è¯»å®ƒï¼

æˆ‘æ„Ÿè°¢ä½ ï¼Œ[@ yamadashi](https://dev.to/yamadashy)æ„Ÿè°¢[è¿™ä¸ªè¡¨æƒ…ç¬¦å·å°æŠ„â¤ï¸](https://dev.to/yamadashy/emoji-cheatsheet-of-githubslackdiscordqiita-4d2f)