# IL ä¸­çš„å†’é™©:æ¡ä»¶å’Œå¾ªç¯

> åŸæ–‡ï¼š<https://dev.to/dotnet/adventures-in-il-conditionals-and-loops-28m5>

ä¸Šæ¬¡æˆ‘ä»¬æ¢ç´¢ IL(å—¯ï¼ŒCILï¼Œä½†å¤§å¤šæ•°äººåªçŸ¥é“å®ƒæ˜¯ IL)æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•äº†è§£äº†[æ“ä½œç åŠå…¶å«ä¹‰](https://dev.to/dotnet/what-is-an-opcode-2bch)ã€‚ä»Šå¤©æˆ‘æƒ³çœ‹ä¸€ä¸‹æˆ‘ä»¬åœ¨ç¼–ç¨‹ä¸­å¸¸ç”¨çš„ä¸¤ä¸ªè¯­å¥ï¼Œæ¡ä»¶è¯­å¥(`if`ã€`switch`)å’Œå¾ªç¯è¯­å¥(`for`ã€`foreach`ç­‰ã€‚).æˆ‘ä»¬è¿˜å°†çœ‹çœ‹æˆ‘ä»¬ä»ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è·³è¿‡çš„ä¸€äº›ä¸œè¥¿ï¼Œå³`Debug`å’Œ`Release`æ„å»ºä¹‹é—´çš„åŒºåˆ«(æ— è®ºæœ‰æ²¡æœ‰ç¼–è¯‘å™¨ä¼˜åŒ–)ã€‚

## If è¯­å¥

å°±æ‹¿ä¸‹é¢è¿™ä¸ª F#å‡½æ•°æ¥è¯´:

```
let ifStatement a =
    if a = 1 then
        Console.WriteLine "one"
    else
        Console.WriteLine "not one" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æˆ‘ç”¨çš„æ˜¯`Console.WriteLine`è€Œä¸æ˜¯ [F# `Core.Printf`æ¨¡å—](https://msdn.microsoft.com/visualfsharpdocs/conceptual/core.printf-module-%5bfsharp%5d?WT.mc_id=devto-blog-aapowell)å’Œ`printfn`ï¼Œå› ä¸ºè¿™æ ·ä»£ç æ›´ç®€æ´ã€‚é€šå¸¸åœ¨ F#ä¸­æˆ‘ä¼šä½¿ç”¨`printfn`ã€‚*

è¿™å°†ç”Ÿæˆä»¥ä¸‹ IL:

```
IL_0000: ldarg.0
IL_0001: ldc.i4.1
IL_0002: bne.un.s IL_0006

IL_0004: br.s IL_0008

IL_0006: br.s IL_0013

IL_0008: ldstr "one"
IL_000d: call void [mscorlib]System.Console::WriteLine(string)
IL_0012: ret

IL_0013: ldstr "not one"
IL_0018: call void [mscorlib]System.Console::WriteLine(string)
IL_001d: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰ä¸€äº›ç†Ÿæ‚‰çš„æ“ä½œç ï¼Œä½†æˆ‘ä»¬ä¹Ÿé‡åˆ°äº†ä¸€äº›æ–°çš„ã€‚æˆ‘ä»¬è¾“å‡ºä¸­çš„å‰ä¸¤ä¸ªè´Ÿè´£å°†å‚æ•°å€¼(ä»£ç ä¸­çš„`a`)åŠ è½½åˆ°å †æ ˆä¸Šï¼Œç„¶åå°†`int32`å€¼`1`æ¨é€åˆ°å †æ ˆä¸Šã€‚ç°åœ¨æˆ‘ä»¬è¦å­¦ä¹ ä¸€ä¸ªæ–°çš„æ“ä½œç ï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£æ›´å¤šå…³äº`:`(æˆ‘ä»¬ä¸Šæ¬¡å¿½ç•¥äº†)çš„*å·¦è¾¹*çš„éƒ¨åˆ†ï¼Œå®ƒè¢«ç§°ä¸º**æŒ‡ä»¤å‰ç¼€**ã€‚

IL ä¸­çš„ä¸€æ¡æŒ‡ä»¤å¯ä»¥ç”±ä¸¤æ¡`prefix: instruction`æ ¼å¼çš„ä¿¡æ¯ç»„æˆã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™æ¡çº¿:

```
IL_0002: bne.un.s IL_0006 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå‰ç¼€`IL_0002`ï¼Œå¹¶ä¸”è¯¥è¡Œçš„æŒ‡ä»¤æ˜¯`bne.un.s IL_0006`ï¼Œå®ƒåœ¨è¿™é‡Œè¢«å®šä¹‰ä¸ºã€‚å¼•ç”¨`bne.un.s`çš„è¯´æ˜æ–‡ä»¶:

> å½“ä¸¤ä¸ªæ— ç¬¦å·æ•´æ•°å€¼æˆ–æ— åºæµ®ç‚¹å€¼ä¸ç›¸ç­‰æ—¶ï¼Œå°†æ§åˆ¶è½¬ç§»åˆ°ç›®æ ‡æŒ‡ä»¤(çŸ­æ ¼å¼)ã€‚

æœ‰æ„æ€çš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ª*ä¸ç­‰äº*çš„è¿ç®—ï¼Œè€Œæˆ‘ä»¬çš„ä»£ç æ˜¯`if a = 1 then`ï¼Œæ‰€ä»¥ IL ä»£è¡¨äº†æˆ‘ä»¬ä»£ç æ‰€ä»£è¡¨çš„*çš„é€†è¿ç®—*ã€‚ä¸ºäº†ç†è§£ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æŸ¥çœ‹æŒ‡ä»¤çš„å…¶ä½™éƒ¨åˆ†ï¼Œä»¥åŠ IL çš„å…¶ä½™éƒ¨åˆ†ï¼Œå› ä¸ºè¿˜æœ‰å¦ä¸€ä½ä¿¡æ¯ä¼ é€’ç»™äº†`bne.un.s`ã€`IL_0006`ï¼Œå®ƒè¡¨ç¤ºè¦å°†æ§åˆ¶è½¬ç§»åˆ°çš„ç›®æ ‡æŒ‡ä»¤ã€‚å®é™…ä¸Šï¼Œè¿™æ„å‘³ç€â€œå¦‚æœä¸¤ä¸ªå€¼ä¸åŒ¹é…ï¼Œä¸‹ä¸€è¡Œæ‰§è¡Œçš„æ˜¯`IL_0006`â€ã€‚

è¿™æ˜¯å®ƒåœ¨ IL ä¸­çš„ä½ç½®:

```
IL_0004: br.s IL_0008

IL_0006: br.s IL_0013 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ ä¼šæ³¨æ„åˆ°`IL_0006`æ˜¯ `IL_0004`ä¹‹åçš„*ï¼Œæ‰€ä»¥æˆ‘ä»¬è·³è¿‡äº†`IL_0004`ï¼Œæœ¬è´¨ä¸Šä½¿ç”¨äº†ä¸€ä¸ª [`goto`è¯­å¥](https://en.wikipedia.org/wiki/Goto)ï¼*

*è¯´å¥é¢˜å¤–è¯ï¼ŒF#æ²¡æœ‰`goto`è¯­å¥ï¼Œ [C#æœ‰](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/goto?WT.mc_id=devto-blog-aapowell)ï¼*

`IL_0004`å’Œ`IL_0006`éƒ½ä½¿ç”¨ [`br.s`](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.br_s?view=netcore-2.2&WT.mc_id=devto-blog-aapowell) ï¼Œåè€…**å†æ¬¡**å°†æ§åˆ¶æƒè½¬ç§»ç»™å¦ä¸€æ¡æŒ‡ä»¤:

```
IL_0008: ldstr "one"
IL_000d: call void [mscorlib]System.Console::WriteLine(string)
IL_0012: ret

IL_0013: ldstr "not one"
IL_0018: call void [mscorlib]System.Console::WriteLine(string)
IL_001d: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸¤ä¸ªå—éå¸¸ç›¸ä¼¼ï¼Œ`IL_0008`æ˜¯æˆ‘ä»¬çš„`if`è¯­å¥çš„ *truthy* åˆ†æ”¯çš„å¼€å§‹ï¼Œå°†ä¸€ä¸ªå­—ç¬¦ä¸²åŠ è½½åˆ°å †æ ˆä¸Šï¼Œç„¶ååœ¨å‘å‡º`ret`ç»“æŸæ–¹æ³•ä¹‹å‰è°ƒç”¨`Console.WriteLine`ã€‚`IL_0013`æ˜¯*false*åˆ†æ”¯ï¼Œä½¿ç”¨æ§åˆ¶è½¬ç§»æˆ‘ä»¬è·³è¿‡ truthy å—ã€‚

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æŠŠå®ƒåˆ†è§£å¼€æ¥ï¼Œä¸€ä¸ª`if`è¯­å¥å°±æ˜¯ä¸€ç³»åˆ— GOTO è°ƒç”¨æ¥è·³è¿‡æˆ‘ä»¬ä¸æƒ³æ‰§è¡Œçš„å—ã€‚

### If è¯­å¥ä¸­çš„`C#`

å‡ºäºå¥½å¥‡ï¼Œæˆ‘å†³å®šç”¨ C#åˆ›å»ºåŒæ ·çš„ä¾‹å­:

```
public void IfStatements(int a)
{
    if (a == 1)
    {
        Console.WriteLine("One");
    }
    else
    {
        Console.WriteLine("Not One");
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘å‘ç°å®ƒä¼šäº§ç”Ÿä¸åŒçš„ ILï¼

```
IL_0000: nop
IL_0001: ldarg.1
IL_0002: ldc.i4.1
IL_0003: ceq
IL_0005: stloc.0
IL_0006: ldloc.0
IL_0007: brfalse.s IL_0018

IL_0009: nop
IL_000a: ldstr "One"
IL_000f: call void [mscorlib]System.Console::WriteLine(string)
IL_0014: nop
IL_0015: nop
IL_0016: br.s IL_0025

IL_0018: nop
IL_0019: ldstr "Not One"
IL_001e: call void [mscorlib]System.Console::WriteLine(string)
IL_0023: nop
IL_0024: nop

IL_0025: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæœ‰æ„æ€çš„æ˜¯ï¼Œåœ¨ C#ç‰ˆæœ¬ä¸­å®ƒä½¿ç”¨äº† [`ceq`](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.ceq?view=netcore-2.2&WT.mc_id=devto-blog-aapowell) ï¼Œå¹¶å°†å…¶ä¸ [`brfalse.s`](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.brfalse_s?view=netcore-2.2&WT.mc_id=devto-blog-aapowell) ç»„åˆåœ¨ä¸€èµ·ã€‚`ceq`å¯¹ä¸¤ä¸ªå€¼è¿›è¡Œç›¸ç­‰æµ‹è¯•ï¼Œå¦‚æœå®ƒä»¬ç›¸ç­‰ï¼Œå®ƒå°†`1`æ¨åˆ°å †æ ˆä¸Šï¼Œå¦åˆ™`0`ï¼Œç„¶å`brfalse.s`å°†æ§åˆ¶è½¬ç§»åˆ°ä¸€ä¸ªæŒ‡ä»¤ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯`IL_0018`ï¼Œå¦‚æœå †æ ˆä¸Šçš„å€¼ä¸ºå‡ï¼Œ`null`æˆ– 0ã€‚

å½“ *truthy* å—è·³è¿‡*false*å—å¹¶è½åœ¨`ret`ä¸Šæ—¶ï¼Œä½ è¿˜ä¼šæ³¨æ„åˆ° [`br.s`](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.br_s?view=netcore-2.2&WT.mc_id=devto-blog-aapowell) çš„ä½¿ç”¨ï¼Œè€Œ F#åªæ˜¯å†…è”äº†`ret`ã€‚

è¿™ä½¿å¾— C#ç‰ˆæœ¬åœ¨å®ç°åŒæ ·çš„äº‹æƒ…æ—¶æ¯” F#ç‰ˆæœ¬æ›´å†—é•¿ä¸€äº›ã€‚

### è°ƒè¯• vs å‘å¸ƒ

ä»¥ä¸Šä¸¤ä¸ªä¾‹å­éƒ½æ˜¯ä½¿ç”¨â€œè°ƒè¯•æ¨¡å¼â€ç¼–è¯‘çš„ï¼Œæ‰€ä»¥æ²¡æœ‰å¯ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚ä½†è¿™ä¸æ˜¯æ‚¨è¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¸œè¥¿(å¯¹å—ï¼Ÿå¯¹ï¼)æ‰€ä»¥æˆ‘åˆä¸€æ¬¡å¾ˆæœ‰å…´è¶£å»çœ‹çœ‹é‚£é‡Œçš„å·®å¼‚ã€‚ä¸‹é¢æ˜¯ç»è¿‡ä¼˜åŒ–ç¼–è¯‘çš„ F # one:

```
IL_0000: ldarg.0
IL_0001: ldc.i4.1
IL_0002: bne.un.s IL_000f

IL_0004: ldstr "one"
IL_0009: call void [mscorlib]System.Console::WriteLine(string)
IL_000e: ret

IL_000f: ldstr "not one"
IL_0014: call void [mscorlib]System.Console::WriteLine(string)
IL_0019: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯ C#:

```
IL_0000: ldarg.1
IL_0001: ldc.i4.1
IL_0002: bne.un.s IL_000f

IL_0004: ldstr "One"
IL_0009: call void [mscorlib]System.Console::WriteLine(string)
IL_000e: ret

IL_000f: ldstr "Not One"
IL_0014: call void [mscorlib]System.Console::WriteLine(string)
IL_0019: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å—¯ï¼Œå®ƒä»¬çœ‹èµ·æ¥å¾ˆç›¸ä¼¼ï¼Œä¸æ˜¯å—ï¼Œäº‹å®ä¸Šï¼Œå®ƒä»¬æ˜¯ä¸€æ ·çš„(æˆ‘å¿…é¡»æ£€æŸ¥å‡ æ¬¡ï¼Œæ˜¯çš„ï¼Œæˆ‘æ˜¯åœ¨å¤åˆ¶ä¸åŒçš„ï¼).å®ƒä»¬éƒ½ç±»ä¼¼äºæœªä¼˜åŒ–çš„ F#è¾“å‡ºï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹å°å°çš„ä¸åŒï¼Œå°±æ˜¯å°‘äº†å‡ æ¡`br.s`æŒ‡ä»¤ã€‚

## ä¸ºå¾ªç¯

å½“è°ˆåˆ°å¾ªç¯æ—¶ï¼Œæˆ‘å€¾å‘äºä½¿ç”¨æœ€å¸¸ç”¨çš„`for`å¾ªç¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åœ¨ä»Šå¤©çš„æ¢ç´¢ä¸­ä½¿ç”¨å®ƒã€‚ä»ä¸€ä¸ªç®€å•çš„ F#å‡½æ•°å¼€å§‹:

```
let forLoop() =
    for i in 0 .. 99 do
        Console.WriteLine i 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å¯¼è‡´ä»¥ä¸‹ IL:

```
IL_0000: ldc.i4.0
IL_0001: stloc.0
IL_0002: br.s IL_000e
// loop start (head: IL_000e)
    IL_0004: ldloc.0
    IL_0005: call void [mscorlib]System.Console::WriteLine(int32)
    IL_000a: ldloc.0
    IL_000b: ldc.i4.1
    IL_000c: add
    IL_000d: stloc.0

    IL_000e: ldloc.0
    IL_000f: ldc.i4.1
    IL_0010: ldc.i4.s 99
    IL_0012: add
    IL_0013: blt.s IL_0004
// end loop

IL_0015: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ç•™ä¸‹äº†ä¸€äº› IL Spy ä¸ºæˆ‘ç”Ÿæˆçš„ç¼©è¿›å’Œæ³¨é‡Šï¼Œä»¥å¸®åŠ©æ›´å¥½åœ°å¯è§†åŒ– ILã€‚

æˆ‘ä»¬é¦–å…ˆç”¨`ldc.i4.0`å°†`i`çš„åˆå§‹å€¼æ¨åˆ°å †æ ˆä¸Šï¼Œç„¶ååœ¨ç”¨`br.s`å‘ä¸‹ç§»åŠ¨åˆ°`IL_000e`ä¹‹å‰ï¼Œç”¨`stloc.0`ç¡®ä¿å †æ ˆåœ¨æ­£ç¡®çš„ä½ç½®ã€‚è¿™æ˜¯æˆ‘ä»¬ç­‰å¼æµ‹è¯•çš„å¼€å§‹ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬ä»ç„¶åœ¨å¾ªç¯èŒƒå›´å†…:

```
 IL_000e: ldloc.0
    IL_000f: ldc.i4.1
    IL_0010: ldc.i4.s 99
    IL_0012: add
    IL_0013: blt.s IL_0004 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ç½® 0 è¢«åŠ è½½åˆ°å †æ ˆä¸Š(è¿™æ˜¯æˆ‘ä»¬çš„`i`å€¼),ç„¶ååœ¨è°ƒç”¨å°†`100`çš„å€¼æ¨é€åˆ°å †æ ˆä¸Šçš„`add`ä¹‹å‰ï¼Œåˆ†åˆ«ç”¨`ldc.i4.1`å’Œ`ldc.i4.s`å°†`1`å’Œ`99`çš„å€¼æ¨é€åˆ°å †æ ˆä¸Š(`ldc.i4.1`æ˜¯`ldc.i4.s 1`çš„ç®€å†™ï¼Œå¯èƒ½ä¼šè¢«æ‚¨çš„è¿è¡Œæ—¶ä¼˜åŒ–)ã€‚æœ€å [`blt.s`](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.blt_s?view=netcore-2.2&WT.mc_id=devto-blog-aapowell) è¢«è°ƒç”¨ï¼Œå¦‚æœå †æ ˆä½ç½®`0`ä¸­çš„å€¼å°äº`add`çš„ç»“æœï¼Œæˆ‘ä»¬å°†æŠŠæ§åˆ¶è½¬ç§»åˆ°æŒ‡ä»¤åˆ—è¡¨ä¸­æ›´é«˜çš„ä½ç½®ï¼Œç‰¹åˆ«æ˜¯è½¬ç§»åˆ°`IL_0004`ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†è¿™ä¸ªç¨‹åºå—:

```
 IL_0004: ldloc.0
    IL_0005: call void [mscorlib]System.Console::WriteLine(int32)
    IL_000a: ldloc.0
    IL_000b: ldc.i4.1
    IL_000c: add
    IL_000d: stloc.0 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä»å †æ ˆä½ç½®`0`è·å–å€¼ï¼Œå°†å®ƒä¼ é€’ç»™`Console.WriteLine`ï¼Œå†æ¬¡è·å–å®ƒï¼Œå°†`1`æ·»åŠ åˆ°å®ƒï¼Œå¹¶ä¼ é€’åˆ°`IL_000e`ï¼Œå› ä¸ºæ²¡æœ‰æ§åˆ¶æƒè½¬ç§»ã€‚

æˆ‘å‘ç°è¿™ä¸ªé¡ºåºå¾ˆæœ‰è¶£ï¼Œè¾“å‡º IL çš„é¡ºåºä¸æˆ‘é¢„æœŸçš„ç›¸åï¼Œæ¡ä»¶æµ‹è¯•åœ¨æŒ‡ä»¤è¡¨çš„**æœ«ç«¯**ï¼Œä½†æ˜¯ä»”ç»†åˆ†æåï¼Œå®ƒå¾ˆæœ‰æ„ä¹‰ã€‚å¦‚æœæ¡ä»¶æµ‹è¯•åœ¨é¡¶éƒ¨ï¼Œå½“å¾ªç¯ä½“ç»“æŸæ—¶ï¼Œä½ å¿…é¡»ä½¿ç”¨ä¸€ä¸ª`br.s`å°†æ§åˆ¶è½¬ç§»å›é¡¶éƒ¨ï¼Œç„¶åå¦‚æœè¶…å‡ºèŒƒå›´ï¼Œè¿›è¡Œæ§åˆ¶è½¬ç§»æµ‹è¯•(ä¸€ä¸ª`brtrue.s`)ã€‚è¿™å°†æ˜¯ä½æ•ˆçš„ï¼Œå› ä¸ºä½ æ€»æ˜¯æ‰§è¡Œä¸€ä¸ªæ§åˆ¶è½¬ç§»ï¼Œç„¶åæœ‰ç¬¬äºŒä¸ª*æ½œåœ¨çš„*æ§åˆ¶è½¬ç§»ï¼Œè€Œç›¸åï¼Œä½ åªæœ‰ä¸€ä¸ªæ§åˆ¶è½¬ç§»ï¼Œè€Œä¸”æ˜¯æœ‰æ¡ä»¶çš„ã€‚

### ä¸º`C#`ä¸­çš„å¾ªç¯

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ª C#å®ç°:

```
public void ForLoop()
{
    for (var i = 0; i < 100; i++)
    {
        Console.WriteLine(i);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

äº§ç”Ÿä»¥ä¸‹ IL:

```
IL_0000: nop
IL_0001: ldc.i4.0
IL_0002: stloc.0
IL_0003: br.s IL_0012
// loop start (head: IL_0012)
    IL_0005: nop
    IL_0006: ldloc.0
    IL_0007: call void [mscorlib]System.Console::WriteLine(int32)
    IL_000c: nop
    IL_000d: nop
    IL_000e: ldloc.0
    IL_000f: ldc.i4.1
    IL_0010: add
    IL_0011: stloc.0

    IL_0012: ldloc.0
    IL_0013: ldc.i4.s 100
    IL_0015: clt
    IL_0017: stloc.1
    IL_0018: ldloc.1
    IL_0019: brtrue.s IL_0005
// end loop

IL_001b: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒä¸ F#ç‰ˆæœ¬éå¸¸ç›¸ä¼¼(å¿½ç•¥äº†`nop`æŒ‡ä»¤),é™¤äº†ç­‰å¼æµ‹è¯•æ˜¯å¦‚ä½•å®Œæˆçš„ã€‚åœ¨æˆ‘ä»¬çš„ F#ç‰ˆæœ¬ä¸­ï¼Œä¸`if`è¯­å¥ä¸€æ ·ï¼Œç­‰å¼æµ‹è¯•ä¸ä½¿ç”¨`blt.s`çš„æ§åˆ¶è½¬ç§»ç»“åˆåœ¨ä¸€èµ·ï¼Œè€Œ C#ä½¿ç”¨ [`clt`](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.clt?view=netcore-2.2&WT.mc_id=devto-blog-aapowell) å’Œ`brtrue.s`æ¥æ¯”è¾ƒå€¼ï¼Œç„¶åè½¬ç§»æ§åˆ¶ã€‚

å¦ä¸€ä¸ªä¸»è¦åŒºåˆ«æ˜¯ï¼ŒC#ç‰ˆæœ¬å°† 100 åŠ è½½åˆ°å †æ ˆä¸Šè¿›è¡Œ`clt`æµ‹è¯•ï¼Œä½†æ˜¯ F#å°† 1 å’Œ 99 æ¨å…¥å †æ ˆï¼Œç„¶åå°†å®ƒä»¬ç›¸åŠ ï¼Œè¿™æ„å‘³ç€å®ƒçš„ç›¸ç­‰æµ‹è¯•æ›´ç±»ä¼¼äº`i < 1 + 99`è€Œä¸æ˜¯ C#çš„`i < 100`ã€‚

### è°ƒè¯• vs å‘å¸ƒ

æ˜¯æ—¶å€™æ¯”è¾ƒä¸€ä¸‹å½“æˆ‘ä»¬å¯ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆäº†ï¼Œä» F#å¼€å§‹:

```
IL_0000: ldc.i4.0
IL_0001: stloc.0
IL_0002: br.s IL_000e
// loop start (head: IL_000e)
    IL_0004: ldloc.0
    IL_0005: call void [mscorlib]System.Console::WriteLine(int32)
    IL_000a: ldloc.0
    IL_000b: ldc.i4.1
    IL_000c: add
    IL_000d: stloc.0

    IL_000e: ldloc.0
    IL_000f: ldc.i4.s 100
    IL_0011: blt.s IL_0004
// end loop

IL_0013: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è€Œç°åœ¨ C#:

```
IL_0000: ldc.i4.0
IL_0001: stloc.0
IL_0002: br.s IL_000e
// loop start (head: IL_000e)
    IL_0004: ldloc.0
    IL_0005: call void [mscorlib]System.Console::WriteLine(int32)
    IL_000a: ldloc.0
    IL_000b: ldc.i4.1
    IL_000c: add
    IL_000d: stloc.0

    IL_000e: ldloc.0
    IL_000f: ldc.i4.s 100
    IL_0011: blt.s IL_0004
// end loop

IL_0013: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ¬¡æˆ‘ä»¬å¾—åˆ°äº†ç›¸åŒçš„ IL (F#ç”šè‡³ä½¿ç”¨ 100ï¼Œè€Œä¸æ˜¯åšåŠ æ³•ï¼)ï¼Œäº†è§£è¿™ä¸€ç‚¹å¾ˆå¥½ï¼Œä½†æœ‰è¶£çš„æ˜¯ï¼Œå½“æ‚¨å¯ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–æ—¶ï¼Œè¾“å‡ºä¼šæœ‰å¤šä¹ˆä¸åŒã€‚

## ç»“è®º

ç°åœ¨æˆ‘ä»¬å·²ç»çœ‹åˆ°äº† IL çš„ä¸€äº›ç»†èŠ‚éƒ¨åˆ†ï¼Œä¸€åˆ‡éƒ½åªæ˜¯ä¸€å¤©ç»“æŸæ—¶çš„ GOTO è¯­å¥ï¼ğŸ¤£

ç†è§£æ§åˆ¶æ˜¯å¦‚ä½•åœ¨ IL ä¸­ä¼ é€’çš„æœ‰åŠ©äºæˆ‘ä»¬ç†è§£ç¼–è¯‘å™¨æ˜¯å¦‚ä½•è¿›è¡Œä¼˜åŒ–çš„ï¼Œä»¥åŠä¸ºä»€ä¹ˆæˆ‘ä»¬åº”è¯¥ä»¥ä¸€ç§ç‰¹å®šçš„æ–¹å¼ç¼–å†™ä»£ç ã€‚

æˆ‘å°†ç•™ç»™æ‚¨ä¸€ä¸ª`switch`è¯­å¥çš„è¾“å‡ºï¼Œçœ‹çœ‹æ‚¨æ˜¯å¦èƒ½ç®—å‡ºå®ƒæ˜¯ä»å“ªä¸ª C#ç”Ÿæˆçš„:

```
IL_0000: ldarg.1
IL_0001: ldc.i4.1
IL_0002: beq.s IL_000a

IL_0004: ldarg.1
IL_0005: ldc.i4.2
IL_0006: beq.s IL_0015

IL_0008: br.s IL_0021

IL_000a: ldstr "One"
IL_000f: call void [mscorlib]System.Console::WriteLine(string)
IL_0014: ret

IL_0015: ldstr "Two"
IL_001a: call void [mscorlib]System.Console::WriteLine(string)
IL_001f: br.s IL_000a

IL_0021: ldstr "Default"
IL_0026: call void [mscorlib]System.Console::WriteLine(string)
IL_002b: ret 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¥ä½ å¥½è¿ï¼