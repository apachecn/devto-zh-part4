# å¸¦æœ‰ Docker å’Œ Traefik çš„ Pixelfed(æµ‹è¯•ç‰ˆ)

> åŸæ–‡:[https://dev . to/Joe nas/pixel fed-beta-with-docker-and-traefik-35hm](https://dev.to/joenas/pixelfed-beta-with-docker-and-traefik-35hm)

[![Pixelfed (beta) with Docker and Traefik](../Images/5c537dc4d0202c3de196a52818111dc4.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--2OMYH_fs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://jonnev.se/content/images/2019/07/pixelfed-2.png)

ä½ åŒå€¦äº†æ•°æ®æŒ–æ˜å’Œå¹¿å‘Šå—ï¼Ÿæƒ³è¦ä»¥ç±»ä¼¼ Instagram çš„æ–¹å¼ä¸æœ‹å‹åˆ†äº«ç…§ç‰‡å¹¶ä¿æŒå¯¹æ•°æ®çš„æ§åˆ¶å—ï¼Ÿpixel feed æ˜¯ä¸€ä¸ªå¼€æºçš„æ›¿ä»£å“ï¼Œå¾ˆå®¹æ˜“æ‰˜ç®¡ã€‚

æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºä¸€ç§åœ¨ Traefik å’Œ Docker çš„å¸®åŠ©ä¸‹å¿«é€Ÿå¯åŠ¨å®ä¾‹çš„ç®€å•æ–¹æ³•ã€‚å¦‚æœæ‚¨å·²ç»æœ‰ä¸€ä¸ªè¿è¡Œ Traefik çš„æœåŠ¡å™¨ï¼Œé‚£ä¹ˆç»§ç»­ã€‚å¦åˆ™ï¼Œæˆ‘æ¨èä½ é˜…è¯»æˆ‘åœ¨[ä¹‹å‰çš„å¸–å­](https://dev.to/joenas/traefik-with-docker-and-lets-encrypt-35if)ï¼Œä½ å¾ˆå¿«å°±ä¼šå›åˆ°è¿™é‡Œã€‚

ä¹Ÿå¯ä»¥è·³è¿‡ä½¿ç”¨ Traefikï¼ŒæŠŠè‡ªå·±çš„*åå‘ä»£ç†* (f.e nginx)æ”¾åœ¨ Pixelfed å‰é¢ã€‚ä»Šå¤©ä½¿ç”¨ https æ˜¯å¿…é¡»çš„ã€‚

è¯·è®°ä½ï¼Œå½“å‰çš„[å‘å¸ƒ](https://github.com/pixelfed/pixelfed/releases/tag/v0.9.4)æ˜¯`v0.9.4`ï¼Œæ‰€ä»¥äº‹æƒ…ä»ç„¶æ˜¯ä¸€ä¸ª*åœ¨è¿›è¡Œä¸­*ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¯¹æˆ‘å’Œæˆ‘çš„æœ‹å‹ä»¬æ¥è¯´éƒ½å¾ˆå¥½ã€‚

## [](#prerequisites)å…ˆå†³æ¡ä»¶

æœ¬æŒ‡å—å‡å®šæ‚¨å¯¹ Linux æœ‰ä¸€å®šçš„äº†è§£ï¼Œå¹¶ä¸”æ‚¨æœ‰ä¸€å°å®‰è£…äº†è¿™äº›æœåŠ¡çš„æœåŠ¡å™¨:

*   [ç å¤´å·¥äºº](https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/)
*   [åç«™-å¤åˆ](https://docs.docker.com/compose/install/)
*   ç”¨äºæ‰˜ç®¡æ‚¨çš„åº”ç”¨ç¨‹åºçš„**åŸŸ**

å¯¹äºä»·å»‰ç‰©ç¾çš„æœåŠ¡å™¨ï¼Œè¯·æŸ¥çœ‹æ•°å­—æµ·æ´‹æˆ– T2 çš„ç½‘ç«™ã€‚å¦å¤–ï¼Œå½“æˆ‘å»ºç«‹ä¸€ä¸ªæ–°çš„ VPS æ—¶ï¼Œæˆ‘æ€»æ˜¯æ¨è[è¿™ä¸ªæŒ‡å—](https://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers)ã€‚

*å¦‚æœä½ æƒ³ä½¿ç”¨æ•°å­—æµ·æ´‹ï¼Œè¯·éšæ„ä½¿ç”¨æˆ‘çš„[æ¨èé“¾æ¥](https://m.do.co/c/37d221e6802a)ä¸ºä½ çš„æœåŠ¡å™¨è·å¾— 10 ç¾å…ƒ*ğŸ˜Š

## [](#setup)è®¾ç½®

æˆ‘ä»¬é¦–å…ˆå°†å­˜å‚¨åº“å…‹éš†åˆ°å®ƒè‡ªå·±çš„ç›®å½•ä¸­ï¼Œå¹¶ä»é‚£é‡Œæ„å»º docker æ˜ åƒã€‚ä¹Ÿæœ‰é¢„å»ºçš„ï¼Œåƒ[è¿™ä¸ª](https://hub.docker.com/r/tedomum/pixelfed)ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘æ¨èè‡ªå·±å»ºã€‚

è®©æˆ‘ä»¬ä¸ºä½ çš„æ•°æ®å»ºç«‹ä¸€ä¸ªç›®å½•ï¼Œå¦‚æœéœ€è¦çš„è¯ã€‚

```
sudo mkdir -p /opt/pixelfed_source
sudo chown $USER:$USER /opt/pixelfed_source 
```

è·å– repoï¼Œæ£€æŸ¥å‘å¸ƒçš„æäº¤ï¼Œç„¶åæ„å»ºæ˜ åƒ(ç”¨æœ€æ–°ç‰ˆæœ¬æ›¿æ¢æ ‡ç­¾ä¸­çš„`v0.9.4`,ä»¥ä¾¿äºå›æ»š)å¹¶ç­‰å¾…...

```
git clone git@github.com:pixelfed/pixelfed.git /opt/pixelfed_source
# OR 
git clone https://github.com/pixelfed/pixelfed.git /opt/pixelfed_source
cd /opt/pixelfed_source
git checkout v0.9.4
docker build -t pixelfed:v0.9.4 . 
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸ºæœåŠ¡åˆ›å»ºä¸€ä¸ªç›®å½•ã€‚

```
sudo mkdir -p /opt/pixelfed
sudo chown $USER:$USER /opt/pixelfed
cd /opt/pixelfed 
```

### [](#configuration)é…ç½®

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç¼–è¾‘é…ç½®ã€‚

```
cp ../pixelfed_source/.env.example .env
nano .env 
```

å°†æ‰€æœ‰çš„`*_DOMAIN`æ›¿æ¢ä¸ºæ‚¨çš„ä¸»æœºåï¼Œå°†`APP_URL=http://localhost`æ›¿æ¢ä¸ºæ‚¨çš„å®Œæ•´ä¸»æœºåï¼ŒåŒ…æ‹¬åè®®ã€‚

æˆ‘ä»¬ç¨åä¼šè®© Pixelfed ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª`APP_KEY`ï¼Œæ‰€ä»¥ä¸è¦ç¢°é‚£ä¸ªã€‚

æˆ‘ä½¿ç”¨ Postgresï¼Œä¸»è¦æ˜¯å› ä¸º MySQL æŠ›å‡ºäº†å¥‡æ€ªçš„é”™è¯¯ï¼Œä½†ä¹Ÿå› ä¸ºè¿™æ˜¯æˆ‘é€šå¸¸ä½¿ç”¨çš„ï¼Œæ‰€ä»¥è¿™äº›éœ€è¦æ”¹å˜ã€‚

```
DB_CONNECTION=pgsql
DB_HOST=db
DB_PORT=5432
DB_DATABASE=pixelfed
DB_USERNAME=pixelfed
DB_PASSWORD=USE_A_PROPER_PASSWORD 
```

å› ä¸ºæˆ‘ä»¬å¯¹æ•°æ®åº“å’Œ Redis ä½¿ç”¨ docker å’Œä¸€ä¸ªå†…éƒ¨ç½‘ç»œï¼Œæ‰€ä»¥ä¹Ÿä¿®æ”¹è¿™ä¸ª:`REDIS_HOST=redis`

å¦‚æœæ‚¨**ä¸æƒ³è¦**è”ç›Ÿï¼Œè¯·æ›´æ”¹ä»¥ä¸‹å†…å®¹ã€‚

```
ACTIVITY_PUB=false
REMOTE_FOLLOW=false 
```

æ‚¨ä¹Ÿå¯ä»¥ç¼–è¾‘è¿™äº›:

```
# For a personal server, I don't really feel this is necessary
ENFORCE_EMAIL_VERIFICATION=false
# I had trouble running Horizon (background jobs) embedded in Docker
HORIZON_EMBED=false 
```

### [](#docker)ç å¤´å·¥äºº

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ docker çš„å†…éƒ¨ç½‘ç»œã€‚

```
docker network create pixelfed 
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ª`docker-compose`æ–‡ä»¶ã€‚

```
touch docker-compose.yml
nano docker-compose.yml 
```

å¤åˆ¶å¹¶ç²˜è´´è¿™ä¸ªã€‚

```
version: '3'
services:

  app:
    image: pixelfed:v0.9.4
    restart: unless-stopped
    # This is for Traefik
    labels:
       - traefik.enable=true
       - traefik.frontend.rule=Host:pixelfed.example.com
       - traefik.port=80
       - traefik.docker.network=web
    env_file:
      - ./.env
    volumes:
      - "app-storage:/var/www/storage"
      - "app-bootstrap:/var/www/bootstrap"
      # We can remove this after generating APP_KEY
      - ./.env:/var/www/.env
    networks:
      - web
      - pixelfed

  db:
    image: postgres:9.6.4
    restart: unless-stopped
    networks:
      - pixelfed
    volumes:
     - db-data:/var/lib/postgresql/data
    environment:
     - POSTGRES_PASSWORD=${DB_PASSWORD}
     - POSTGRES_USER=${DB_USERNAME}

  worker:
    image: pixelfed:v0.9.4
    restart: unless-stopped
    env_file:
      - ./.env
    volumes:
      - "app-storage:/var/www/storage"
      - "app-bootstrap:/var/www/bootstrap"
    networks:
      - web # Required for ActivityPub
      - pixelfed
    command: gosu www-data php artisan horizon

  redis:
    image: redis:5-alpine
    restart: unless-stopped
    volumes:
      - "redis-data:/data"
    networks:
      - pixelfed

# Adjust your volume data in order to store data where you wish
volumes:
  redis-data:
  db-data:
  app-storage:
  app-bootstrap:

networks:
  pixelfed:
    internal: true
  web:
    external: true 
```

â˜ï¸ **è®°å¾—ç”¨ä½ çš„ä¸»æœºåæ›¿æ¢`traefik.frontend.rule`ä¸­çš„** `pixelfed.example.com`ã€‚è¿˜è¦ç¡®ä¿åœ¨`networks`ä¸­æ·»åŠ /æ›¿æ¢ä½ çš„ **Traefik ç½‘ç»œ**(åœ¨æˆ‘çš„ä¾‹å­ä¸­æ˜¯`web`)ã€‚

å¦‚æœä½ **æ²¡æœ‰**ä½¿ç”¨ Traefikï¼Œç”¨è¿™ä¸ªæ›¿æ¢`app`çš„`labels`éƒ¨åˆ†ä»¥ä¾¿èƒ½å¤Ÿåå‘ä»£ç†ã€‚

```
 ports:
    - "127.0.0.1:8080:80" 
```

ç°åœ¨æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿå¯åŠ¨æœåŠ¡å¹¶ç”Ÿæˆä¸€ä¸ª`APP_KEY`ã€‚

```
docker-compose up -d
docker-compose exec app php artisan key:generate
# Make sure there's a value
cat .env | grep APP_KEY 
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¯ã€æ¸…ç©ºç¼“å­˜å¹¶åœ¨æ•°æ®åº“ä¸Šè¿è¡Œè¿ç§»ã€‚

```
docker-compose restart app
docker-compose exec app php artisan config:cache
docker-compose exec app php artisan migrate
# Answer yes 
```

å¥½äº†ğŸ‘æ‚¨çš„ Pixelfed å®ä¾‹åº”è¯¥å·²ç»å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œã€‚ç°åœ¨å»æ³¨å†Œä¸€ä¸ªç”¨æˆ·å§ï¼ä½ å¯ä»¥åœ¨ç½‘ä¸Šæˆ–è€…é€šè¿‡ä½ çš„ç»ˆç«¯æ¥åšã€‚

```
docker-compose exec app php artisan user:create 
```

[![Pixelfed (beta) with Docker and Traefik](../Images/7b198fb6435b1a436c47ebf3f816ad9a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--gToz9zEG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://jonnev.se/content/images/2019/07/pixelfed-1.png)

### [](#site-admin)ç«™ç‚¹ç®¡ç†å‘˜

é‚£ä¹ˆä½ å¯èƒ½æƒ³è®©è‡ªå·±æˆä¸ºç½‘ç«™çš„ç®¡ç†å‘˜...

```
docker-compose exec app php artisan user:admin [username] 
```

## [](#the-end)ç»“æŸ

æˆ‘å¸Œæœ›ä½ å–œæ¬¢ä½ çš„ç¤¾äº¤ç…§ç‰‡åˆ†äº«ï¼Œä¸è¦çŠ¹è±«ç»™æˆ‘æ‰“ç”µè¯å¯»æ±‚å¸®åŠ©(æœ‰äº†è¿™ä¸ªæŒ‡å—ï¼Œå…³äºåƒç´ é—®é¢˜ï¼ŒæŸ¥çœ‹ä»–ä»¬çš„[å¸®åŠ©ä¸­å¿ƒ](https://pixelfed.social/site/help))ã€‚