# ä½¿ç”¨ fp-ts è¿›è¡Œ HTTP è¯·æ±‚å’ŒéªŒè¯

> åŸæ–‡:https://dev . to/ksaaskill/using-FP-ts-for-http-requests-validation-131 c

[fp-ts](https://gcanti.github.io/fp-ts/) æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„å‡½æ•°å¼ç¼–ç¨‹çš„ç±»å‹è„šæœ¬åº“ã€‚æˆ‘è¿˜æ²¡æœ‰å‘ç°å¤ªå¤šçœŸå®ä¸–ç•Œçš„ä½¿ç”¨ä¾‹å­ï¼Œæ‰€ä»¥æˆ‘æƒ³æ‰¾ä¸€ä¸ªå­˜å‚¨åº“å¹¶å°è¯•åœ¨é‚£é‡Œæ·»åŠ `fp-ts`å¯èƒ½ä¼šå¾ˆæœ‰è¶£ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œæˆ‘æƒ³å­¦ä¹ æ›´å¤šå…³äºç”¨`fp-ts`å‘å‡º HTTP è¯·æ±‚çš„çŸ¥è¯†ã€‚

é€šè¿‡æˆ‘åœ¨ [unmock-js](https://github.com/unmock/unmock-js) ä¸Šçš„å·¥ä½œï¼Œæˆ‘å·²ç»çœ‹åˆ°äº†ç›¸å½“å¤šçš„ä½¿ç”¨ç¬¬ä¸‰æ–¹ API çš„åº“ã€‚å› æ­¤ï¼Œæˆ‘å†³å®šåœ¨å…¶ä¸­ä¸€ä¸ªä¸­ä½¿ç”¨`fp-ts`ï¼Œå³ [danger-js](https://github.com/danger/danger-js) ã€‚ä»–ä»¬çš„ [GitLabAPI](https://github.com/danger/danger-js/blob/master/source/platforms/gitlab/GitLabAPI.ts) ç±»æ˜¯å›´ç»• [GitLab SDK](https://github.com/jdalrymple/node-gitlab) çš„ä¸€ä¸ªç›¸å½“ç®€å•çš„åŒ…è£…å™¨ï¼Œå¹¶ä¸”ä¹Ÿå¾ˆå®¹æ˜“ä¸ä»£ç åº“çš„å…¶ä½™éƒ¨åˆ†åˆ†ç¦»ã€‚

å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨[è¿™ä¸ªåº“](https://github.com/ksaaskil/fp-gitlab-example)ä¸­æ‰¾åˆ°ï¼Œå®ƒæ˜¯`danger-js`ä»£ç çš„ç²¾ç®€ç‰ˆã€‚

åœ¨å¼€å§‹åŠŸèƒ½åŒ–ä¹‹å‰ï¼Œæœ‰ä¸€äº›å…è´£å£°æ˜ğŸ¤“ç°æœ‰çš„`GitLabAPI`è¯¾æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œéƒ½æ˜¯ä¸ºäº†ç»ƒä¹ ï¼è¿™ç¯‡æ–‡ç« ä¹Ÿä¸æ‰“ç®—è®¨è®ºä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹å’Œå…¶ä»–ç¼–ç¨‹é£æ ¼çš„åˆ©å¼Šã€‚æˆ‘ä¹Ÿä¸æ˜¯ FP æ–¹é¢çš„ä¸“å®¶ï¼Œæ‰€ä»¥æˆ‘åœ¨åº“ä¸­é‡å†™ API è¯·æ±‚çš„æ–¹å¼ä¸æ˜¯â€œæ­£ç¡®â€çš„æ–¹å¼ã€‚å¦‚æœä½ è®¤ä¸ºè¿™æ ·åšæœ‰æ„ä¹‰æˆ–è€…æ²¡æœ‰æ„ä¹‰ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ï¼Œæˆ–è€…æ‹¿ç€æˆ‘çš„å›è´­åè®®ï¼Œç”¨ä½ è‡ªå·±çš„æ–¹å¼å†™ä¸€ä¸ªæ–¹æ³•ï¼æˆ‘å¾ˆé«˜å…´åœ¨è¯„è®ºä¸­çœ‹åˆ°æ›¿ä»£çš„å’Œæ›´å¥½çš„å®ç°ã€‚

## å…¥é—¨

æˆ‘ä»¬å¼€å§‹å§ï¼ä¸ºäº†è·å–æ‹¥æœ‰ GitLab API ä»¤ç‰Œçš„ç”¨æˆ·çš„ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼Œ`GitLabAPI`å…·æœ‰ä»¥ä¸‹åŠŸèƒ½:

```
class GitLabAPI {
    ...
    getUser = async (): Promise<GitLabUserProfile> => {
        debugLog("getUser");
        const user: GitLabUserProfile = (await this.api.Users.current()) as GitLabUserProfile;
        debugLog("getUser", user);
        return user;
    };
} 
```

Enter fullscreen mode Exit fullscreen mode

ä¸æœ€åˆçš„ [GitLabAPI](https://github.com/danger/danger-js/blob/b386dae748effbfb3074f58e2e17093d25d5f4f5/source/platforms/gitlab/GitLabAPI.ts) ç›¸æ¯”ï¼Œæˆ‘åœ¨è¿™é‡Œåšäº†ä¸€äº›æ”¹å˜ã€‚é¦–å…ˆï¼Œæˆ‘åœ¨`this.api`ä¸­æ·»åŠ äº†ä»¥ä¸‹å†…å®¹:

```
import { GitLab } from "gitlab";
...
type GitLab = InstanceType<GitLab>;

class GitLabAPI {
    this.api: GitLab;
    ...
} 
```

Enter fullscreen mode Exit fullscreen mode

`GitLab`æ„é€ å‡½æ•°æ˜¯ä»[è¿™é‡Œçš„](https://github.com/jdalrymple/node-gitlab/blob/f7425a72e24aa8209fda9079681878d34d307ec6/src/index.ts#L89)å¯¼å…¥çš„ã€‚åœ¨åŸå§‹ä»£ç ä¸­ï¼Œ`this.api`è¢«ç±»å‹åŒ–ä¸º`any`ï¼Œå› æ­¤æ‰€æœ‰ç±»å‹æ£€æŸ¥éƒ½è¢«ç¦ç”¨ã€‚

ç”±äºå¢åŠ äº†ç±»å‹æ£€æŸ¥ï¼Œ`this.api.users.current()`è¿”å›ä¸€ä¸ª [GetResponse](https://github.com/jdalrymple/node-gitlab/blob/6949dfddcdbb0d8eff3f6d7287bb9b237db03a9b/src/infrastructure/index.ts#L75) ç±»å‹ï¼Œè€Œä¸æ˜¯`any`ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ˜¾å¼çš„ç±»å‹è½¬æ¢(â€œ`as GitLabUserProfile`â€)æ¥ä½¿è¿”å›ç±»å‹æ­£ç¡®ã€‚

å¥½å§ï¼Œè¿™æ˜¯æˆ‘ç‰ˆæœ¬çš„`getUser`æ›´ FP çš„é£æ ¼:

```
// GitLabAPI.ts
import { Lazy } from "fp-ts/lib/function";
import { Either, left, right } from "fp-ts/lib/Either";
import { pipe } from "fp-ts/lib/pipeable";
import { TaskEither } from "fp-ts/lib/TaskEither";
import TE from "./TaskEitherUtils";

...

const logValue = TE.logValueWith(debugLog);

...

getUserFp = (): TaskEither<Error, GitLabUserProfile> => {
    // I/O action for fetching user from API
    const getUserThunk: Lazy<Promise<GetResponse>> = () => {
        debugLog("getUser");
        return this.api.Users.current();
    };

    // Validate user profile
    const validateUserProfile = (
        response: object
    ): Either<Error, GitLabUserProfile> => {
        // TODO Better validation
        return hasKey(response, "id")
        ? right(response as GitLabUserProfile)
        : left(Error("Invalid user profile"));
    };

    // Pipe computations
    return pipe(
        getUserThunk,
        TE.fromThunk,
        logValue("getUser"),
        TE.chainEither(validateUserProfile)
    );
}; 
```

Enter fullscreen mode Exit fullscreen mode

å“‡ï¼Œæ—¶é—´å˜é•¿äº†ï¼è¿™ä¸ªç‰‡æ®µç”šè‡³æ²¡æœ‰åŒ…æ‹¬`TaskEitherUtils.ts`ä¸­çš„åŠ©æ‰‹ã€‚è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ã€‚

## task 101

è®©æˆ‘ä»¬ä»æ–°å‡½æ•°`TaskEither<Error, GitLabUserProfile>`çš„è¿”å›ç±»å‹å¼€å§‹ã€‚åœ¨ [fp-ts](https://github.com/gcanti/fp-ts/blob/master/src/TaskEither.ts) ä¸­ï¼Œ`TaskEither`æè¿°å¦‚ä¸‹:

> `TaskEither<E, A>`è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥è®¡ç®—ï¼Œè¦ä¹ˆäº§ç”Ÿä¸€ä¸ª`A`ç±»å‹çš„å€¼ï¼Œè¦ä¹ˆå¤±è´¥ï¼Œäº§ç”Ÿä¸€ä¸ª`E`ç±»å‹çš„é”™è¯¯ã€‚

è¿™å¬èµ·æ¥å¾ˆåƒ API è°ƒç”¨ï¼å¯¹å¤–éƒ¨ API çš„è°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œå®ƒè‚¯å®šä¼šå¤±è´¥ã€‚è¿˜è¦æ³¨æ„ï¼Œ`TaskEither`ä»£è¡¨è®¡ç®—ï¼Œ*ä¸æ˜¯*è®¡ç®—çš„ç»“æœã€‚æˆ‘ä»¬å¯ä»¥è°ƒç”¨`getUserFp`åæ¬¡ï¼Œä¸ç”¨æ‹…å¿ƒæ¯æ¬¡éƒ½æ‰“ä¸­ GitLab APIã€‚

æˆ‘ä»¬æŠŠ`getUserFp`å˜æˆäº†ä¸€ä¸ªçº¯ç²¹çš„å‡½æ•°:å®ƒæ²¡æœ‰å¯è§‚å¯Ÿåˆ°çš„å‰¯ä½œç”¨ï¼Œæ¯”å¦‚ç™»å½•æ§åˆ¶å°ã€å‘ GitLabAPI å‘é€ HTTP è¯·æ±‚ã€æŠ›å‡ºé”™è¯¯æˆ–è€…å–‚é‚»å±…çš„ç‹—ã€‚çº¯å‡½æ•°ä¹Ÿæ€»æ˜¯ä¸ºç›¸åŒçš„è¾“å…¥è¿”å›ç›¸åŒçš„ç»“æœ:è¿™ä½¿å¾—å®ƒä»¬éå¸¸é€‚åˆæµ‹è¯•å’Œç¼–å†™ï¼

è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°äº†è§£ä¸€ä¸‹`TaskEither`ã€‚åœ¨`fp-ts`ä¸­å®šä¹‰å¦‚ä¸‹:

```
// fp-ts/lib/TaskEither.ts
export interface TaskEither<E, A> extends Task<Either<E, A>> {} 
```

Enter fullscreen mode Exit fullscreen mode

å¥½äº†ï¼ŒåŸæ¥æ˜¯`Task<Either<E, A>>`çš„åˆ«åã€‚`Task`å¯¹[çš„å®šä¹‰å¦‚ä¸‹](https://github.com/gcanti/fp-ts/blob/master/src/Task.ts) :

```
// fp-ts/lib/Task.ts
export interface Task<A> {
  (): Promise<A>;
} 
```

Enter fullscreen mode Exit fullscreen mode

æœ‰äº†è¿™ä¸ªå®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥æ–­å®š`TaskEither<E, A>`æ˜¯`() => Promise<Either<E, A>>`çš„åˆ«å:ä¸€ä¸ª *thunk* ï¼Œå½“å®ƒè¢«è°ƒç”¨æ—¶å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥è®¡ç®—ã€‚è®¡ç®—çš„ç»“æœè¢«åŒ…è£…åœ¨ä¸€ä¸ª`Promise`ä¸­ã€‚

`Promise`çš„è¿”å›å€¼ä¸º[æˆ–è€…](https://github.com/gcanti/fp-ts/blob/master/src/Either.ts)ï¼Œåœ¨`fp-ts`ä¸­æè¿°å¦‚ä¸‹:

> `Either`çš„å®ä¾‹æ˜¯`Left`æˆ–`Right`çš„å®ä¾‹ã€‚
> ...æŒ‰ç…§æƒ¯ä¾‹ï¼Œ`Left`ç”¨äºå¤±è´¥ï¼Œ`Right`ç”¨äºæˆåŠŸã€‚

æ‰€ä»¥ä¸€ä¸ª`Either`æ—¢å¯ä»¥åŒ…å«ä¸€ä¸ªè¡¨ç¤ºé”™è¯¯çš„å€¼(â€œå·¦â€)ï¼Œä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ªè¡¨ç¤ºæˆåŠŸçš„å€¼(â€œå³â€)ã€‚

## åˆ›å»ºä»»åŠ¡

æˆ‘ä»¬å¦‚ä½•ä¸º API è°ƒç”¨åˆ›å»ºä¸€ä¸ª`TaskEither`ï¼Ÿåœ¨`getUserFp`ä¸­ï¼Œä»¥ä¸‹æ˜¯å¯åŠ¨ API è¯·æ±‚çš„è®¡ç®—:

```
// GitLabAPI.ts
// I/O action for fetching user from API
const getUserThunk: Lazy<Promise<GetResponse>> = () => this.api.Users.current(); 
```

Enter fullscreen mode Exit fullscreen mode

å½“è¢«è°ƒç”¨å’Œç­‰å¾…æ—¶ï¼Œå®ƒå¯ä»¥æŠ›å‡ºã€‚ç›¸åï¼Œæˆ‘ä»¬å¸Œæœ›å°†è®¡ç®—åŒ…è£…åœ¨`TaskEither`ä¸­ï¼Œè¿™æ ·å®ƒå°±æ°¸è¿œä¸ä¼šæŠ›å‡ºï¼Œä½†æ˜¯å¤±è´¥å´åŒ…è£…åœ¨`Either`ç±»å‹ä¸­ï¼Œåœ¨`Promise`ä¸­è§£å†³ã€‚åƒ`getUserThunk`è¿™æ ·çš„è®¡ç®—å¯ä»¥é€šè¿‡`tryCatch`å‡½æ•°
æå‡ä¸º`TaskEither`

```
// fp-ts/lib/TaskEither.ts
export function tryCatch<E, A>(
  f: Lazy<Promise<A>>,
  onRejected: (reason: unknown) => E
): TaskEither<E, A> {
  return () => f().then(a => E.right(a), reason => E.left(onRejected(reason)));
} 
```

Enter fullscreen mode Exit fullscreen mode

è¿™é‡Œçš„[æ‡’æƒ°](https://github.com/gcanti/fp-ts/blob/master/src/function.ts#L6)T3 ä»…ä»…æ˜¯è¿”å›`A`çš„ thunk çš„åŒä¹‰è¯:

```
// fp-ts/lib/function.ts
export interface Lazy<A> {
  (): A;
} 
```

Enter fullscreen mode Exit fullscreen mode

`tryCatch`æ¥å—ä¸€ä¸ª thunkï¼Œè¿”å›ä¸€ä¸ªå¯èƒ½å¤±è´¥çš„æ‰¿è¯º(å°±åƒæˆ‘ä»¬çš„`getUserThunk`)å¹¶è¿”å›ä¸€ä¸ªåŒ…å«ä¸€ä¸ªæ°¸è¿œä¸ä¼šå¤±è´¥çš„æ‰¿è¯ºçš„`TaskEither`ã€‚å¦‚æœåŸå§‹æ‰¿è¯ºå¤±è´¥ï¼Œä»`TaskEither`è§£æçš„æ‰¿è¯ºå°†åŒ…å«ä¸€ä¸ªâ€œå·¦â€ï¼Œå¦åˆ™æ˜¯â€œå³â€ã€‚

ä¸ºäº†å°†ä»»ä½•ç±»å‹ä¸º`() => Promise<A>`çš„ thunk æå‡ä¸º`TaskEither<Error, A>`ï¼Œæˆ‘åœ¨`TaskEitherUtils.ts`ä¸­å®šä¹‰äº†ä»¥ä¸‹å¸®åŠ©å‡½æ•°:

```
// TaskEitherUtils.ts
import { toError } from "fp-ts/lib/Either.ts";

function fromThunk<A>(thunk: Lazy<Promise<A>>): TaskEither<Error, A> {
  return tryCatch(thunk, toError);
} 
```

Enter fullscreen mode Exit fullscreen mode

ä½ å¯ä»¥çœ‹åˆ°è¿™è¢«ç”¨ä½œ`getUserFp`æœ«å°¾çš„`pipe`ä¸­çš„ç¬¬ä¸€ä¸ªå‡½æ•°ã€‚

## éªŒè¯å“åº”

ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹éªŒè¯ã€‚ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½éªŒè¯ç”¨æˆ·é…ç½®æ–‡ä»¶:

```
// GitLabAPI.ts
// Validate user profile
const validateUserProfile = (
  response: object
): Either<Error, GitLabUserProfile> => {
  // TODO Better validation
  return hasKey(response, "id")
    ? right(response as GitLabUserProfile)
    : left(Error("Invalid user profile"));
}; 
```

Enter fullscreen mode Exit fullscreen mode

è¿™é‡Œ`hasKey`å®šä¹‰ä¸º

```
// GitLabAPI.ts
function hasKey<K extends string>(o: {}, k: K): o is { [_ in K]: any } {
  return typeof o === "object" && k in o;
} 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘åœ¨è¿™é‡Œå¾ˆæ‡’ï¼Œåªæ˜¯æ£€æŸ¥å“åº”ä½“æ˜¯å¦æœ‰ä¸€ä¸ª`id`å­—æ®µ(ä¸€ä¸ªæœ‰æ•ˆçš„`GitLabUserProfile`åº”è¯¥æœ‰)ã€‚å¦‚æœç¡®å®æœ‰ï¼Œé‚£ä¹ˆå“åº”å°†è¢«è½¬æ¢ä¸ºä¸€ä¸ª`GitLabUserProfile`å¯¹è±¡ï¼Œå¹¶åŒ…è£…åœ¨ä¸€ä¸ª`right`ä¸­è¿”å›ï¼Œè¡¨ç¤ºéªŒè¯æˆåŠŸã€‚å¦‚æœéªŒè¯å¤±è´¥ï¼Œæˆ‘ä»¬ç”¨`Error`è¿”å›ä¸€ä¸ª`left`çš„å®ä¾‹ã€‚

åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›ä½¿ç”¨ [io-ts](https://gcanti.github.io/io-ts/) æ¥éªŒè¯å“åº”ï¼Œè¿™æ˜¯ç”±`fp-ts`çš„ä½œè€…ç¼–å†™çš„ä¸€ä¸ªéå¸¸æ£’çš„è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥åº“ã€‚ä¸ºäº†è®©è¿™ç¯‡æ–‡ç« ç®€çŸ­ä¸€ç‚¹ï¼Œæˆ‘ä¸ä¼šåœ¨è¿™é‡Œæ·±å…¥è®¨è®ºã€‚é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼ŒéªŒè¯æ­¥éª¤è¿”å›ä¸€ä¸ªæˆ‘ä»¬å¸Œæœ›åŒ…å«åœ¨å‡½æ•°è¿”å›å€¼ä¸­çš„`Either`ã€‚

## æŠŠæ‰€æœ‰çš„ä¸œè¥¿æ”¾åœ¨ä¸€èµ·

æœ€åï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½æ”¾åœ¨å‡½æ•°
æœ«å°¾çš„[ç®¡é“](https://github.com/gcanti/fp-ts/blob/master/src/pipeable.ts)ä¸­

```
// GitLabAPI.ts
return pipe(
  getUserThunk, // Lazy<Promise<GetResponse>>
  TE.fromThunk, // -> TaskEither<Error, GetResponse>
  logValue("getUser"), // -> TaskEither<Error, GetResponse>
  TE.chainEither(validateUserProfile) // -> TaskEither<Error, GitLabUserProfile>
); 
```

Enter fullscreen mode Exit fullscreen mode

ä¸‹é¢æ˜¯`pipe`çš„è¾“å…¥å†…å®¹:

```
// fp-ts/lib/pipeable.ts
export function pipe<A>(a: A): A;
export function pipe<A, B>(a: A, ab: (a: A) => B): B;
export function pipe<A, B, C>(a: A, ab: (a: A) => B, bc: (b: B) => C): C;
// ...and so on 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`pipe`å°†ä¸€ä¸ªç±»å‹ä¸º`A`çš„å€¼ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¹¶é€šè¿‡ç®¡é“å°†å…¶ä¼ é€’ç»™åé¢çš„å‡½æ•°ã€‚ä»`pipe`è¿”å›çš„ç±»å‹æ˜¯æœ€åä¸€ä¸ªå‡½æ•°å‚æ•°çš„è¿”å›ç±»å‹ã€‚

æˆ‘ä»¬çš„`pipe`ä¸­çš„ç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯æˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„`TE.fromThunk`ï¼Œå®ƒå°†æ‡’æƒ°æ‰¿è¯ºè½¬æ¢ä¸ºä¸€ä¸ª`TaskEither`ã€‚ä¸‹é¢æ˜¯`logValue("getUser")`ï¼Œå…¶ä¸­`logValue`å®šä¹‰å¦‚ä¸‹:

```
// GitLabAPI.ts
const debugLog = debug("GitLabAPI");
const logValue = TE.logValueWith(debugLog); 
```

Enter fullscreen mode Exit fullscreen mode

è¿™é‡Œ`debugLog`æ˜¯ç”¨äºè®°å½•çš„å‡½æ•°ï¼Œ`TE.logValueWith`åœ¨`TaskEitherUtils.ts`ä¸­å®šä¹‰å¦‚ä¸‹:

```
// TaskEitherUtils.ts
import { map } from "fp-ts/lib/TaskEither";

function logValueWith(logger: (firstArg: any, ...args: any[]) => void) {
  return <A>(logString: String) =>
    map((obj: A) => {
      logger(logString, obj);
      return obj;
    });
} 
```

Enter fullscreen mode Exit fullscreen mode

è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªè®°å½•å™¨å¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ã€‚è¿”å›çš„å‡½æ•°æ¥å—ä¸€ä¸ªæ—¥å¿—å­—ç¬¦ä¸²(å¦‚â€œgetUserâ€)å¹¶è¿”å›ä¸€ä¸ªå¯åº”ç”¨äº`TaskEither`å®ä¾‹çš„`map`ã€‚`map`å¯¹`TaskEither`å†…çš„å€¼åº”ç”¨å‡½æ•°(å¦‚æœæ˜¯`right`çš„å®ä¾‹)ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå€¼æ˜¯ API è¿”å›çš„å“åº”ã€‚ç”¨`logger(logString, obj)`è®°å½•è¯¥å€¼åï¼Œè¯¥å€¼è¢«è¿”å›ï¼Œä»¥ä¾¿å¯ç”¨äº`pipe`çš„ä¸‹ä¸€ä¸ªåŠŸèƒ½ã€‚

æ‚¨å¯èƒ½ä¼šé—®ï¼Œä¸ºäº†è®°å½•ä¸€è¡Œä»£ç è€Œç»å†è¿™ä¸€åˆ‡æ˜¯å¦å€¼å¾—ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½é—®é¢˜ã€‚æˆ‘ä»¬å°†åœ¨è¿™ç¯‡æ–‡ç« çš„æœ€åè®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚

å¥½äº†ï¼Œè°œé¢˜çš„æœ€åä¸€å—æ˜¯`TE.chainEither(validateUserProfile)`ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„`pipe`ä¸­çš„æœ€åä¸€ä¸ªå‡½æ•°ã€‚`TE.chainEither`å®šä¹‰å¦‚ä¸‹:

```
// TaskEitherUtils.ts
import { flow } from "fp-ts/lib/function";
import { chain, TaskEither, fromEither } from "fp-ts/lib/TaskEither";
import { Either } from "fp-ts/lib/Either";

function chainEither<A, B>(
  f: (a: A) => Either<Error, B>
): (ma: TaskEither<Error, A>) => TaskEither<Error, B> {
  return chain(
    flow(
      f,
      fromEither
    )
  );
} 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ä»¬å…ˆçœ‹ç±»å‹ã€‚å®ƒé‡‡ç”¨ä¸€ä¸ªç±»å‹ä¸º`f: (a: A) => Either<Error, B>`çš„å‡½æ•°ã€‚è¿™å°±æ˜¯æˆ‘ä»¬éªŒè¯å‡½æ•°çš„ç±»å‹ï¼Œåˆ†åˆ«ç”¨`GetResponse`å’Œ`GitLabUserProfile`ä»£æ›¿äº†`A`å’Œ`B`ã€‚`chainEither`è¿”å›ä¸€ä¸ª`(ma: TaskEither<Error, A>) => TaskEither<Error, B>`ç±»å‹çš„å‡½æ•°ã€‚ç”¨`GitLabUserProfile`æ›¿æ¢`B`ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªå‡½æ•°é€‚åˆä½œä¸ºç®¡é“çš„æœ€åä¸€éƒ¨åˆ†ã€‚

å¥½äº†ï¼Œç±»å‹æ˜¯æœ‰æ„ä¹‰çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹å®ç°ã€‚`chain`æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå°†åŒ…è£…åœ¨`TaskEither`ä¸­çš„å€¼æ˜ å°„åˆ°ä¸€ä¸ªè¿”å›`TaskEither`çš„å‡½æ•°ã€‚è¿™å¯èƒ½æœ‰ç‚¹æ··ä¹±ï¼Œæ‰€ä»¥æˆ‘ä¼šè¯•ç€æ¾„æ¸…ç±»å‹:

```
const getResponseTe: TaskEither<Error, GetResponse> = ...  // This is our TaskEither
const validateUserProfile = (getResponseTe: GetResponse) => TaskEither<Error, GitLabUserProfile> = ...  // This is the validation function we want apply to `a: GetResponse`
chain(validateUserProfile)  // Function with signature: `TaskEither<Error, GetResponse>` => `TaskEither<Error, GitLabUserProfile>`
chain(validateUserProfile)(getResponseTe)  // TaskEither<Error, GitLabUserProfile> 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœéªŒè¯å‡½æ•°è¿”å›ä¸€ä¸ª`TaskEither`ï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´å†å¥½ä¸è¿‡äº†ã€‚ä½†æ˜¯æˆ‘ä½œå¼Šäº†:å®ƒè¿”å›ä¸€ä¸ª`Either`ã€‚æ‰€ä»¥è¿™ä¸€åˆ‡éƒ½æ˜¯å¾’åŠ³çš„ï¼

JKï¼Œä¸æ˜¯çš„ï¼`TaskEither.ts`æœ‰ä¸€ä¸ªåä¸º`fromEither`çš„å‡½æ•°ï¼Œç”¨äºä»`TaskEither`åˆ›å»ºä¸€ä¸ª`Either`ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†å®ƒåº”ç”¨åˆ°éªŒè¯çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ª`GetResponse => TaskEither<Error, GitLabUserProfile>`ç±»å‹çš„å‡½æ•°ã€‚ç„¶åæˆ‘ä»¬ç”¨`chain`å¾—åˆ°ä¸€ä¸ª`TaskEither<Error, GetResponse>`åˆ°`TaskEither<Error, GitLabUserProfile>`ç±»å‹çš„å‡½æ•°ã€‚

åœ¨`fp-ts`ä¸­ï¼ŒåŠŸèƒ½å¯ä»¥ç”±`fp-ts/lib/function.ts`çš„`flow`ç»„æˆã€‚ä¸‹é¢æ˜¯å®ƒçš„ç±»å‹å®šä¹‰:

```
// fp-ts/lib/function.ts
export function flow<A extends Array<unknown>, B>(
  ab: (...a: A) => B
): (...a: A) => B;
export function flow<A extends Array<unknown>, B, C>(
  ab: (...a: A) => B,
  bc: (b: B) => C
): (...a: A) => C;
// ...and so on 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨æˆ‘ä»¬çš„`chainEither`ä¸­ï¼Œ`flow(f, fromEither)`æ˜¯ä¸€ä¸ªä»å·¦åˆ°å³çš„å‡½æ•°ç»„åˆ:å®ƒæ˜¯ä¸€ä¸ªå…ˆåº”ç”¨`f`(éªŒè¯)ï¼Œå†åº”ç”¨`fromEither`(ä½¿ç±»å‹å…¼å®¹`chain`)çš„å‡½æ•°ã€‚

æˆ‘ä»¬å¯¹`getUser`çš„é‡å†™åˆ°æ­¤ç»“æŸï¼

## ä¸ºä»€ä¹ˆè¿™ä¹ˆé•¿ï¼Ÿ

æ˜¾ç„¶ï¼Œåœ¨æˆ‘çš„é‡å†™ä¸­ï¼Œæ–¹æ³•`getUser`å˜å¾—æ›´é•¿äº†ã€‚ç„¶è€Œï¼Œåœ¨ FP é£æ ¼çš„è¾©æŠ¤ä¸­æœ‰å‡ ç‚¹å¯ä»¥æå‡ºæ¥ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å†™äº†å¾ˆå¤š helper å‡½æ•°ã€‚å¦‚æœæ²¡æœ‰åŠ©æ‰‹ï¼Œæˆ‘ä»¬å°†èƒ½å¤ŸæŠŠè¡Œæ•°å‡å°‘åˆ°å¦‚ä¸‹:

```
// GitLabAPI.ts
// getUserFpShort
    return pipe(
      () => {
        debugLog("getUser");
        return this.api.Users.current();
      },
      thunk => tryCatch(thunk, toError),
      map((obj: GetResponse) => {
        debugLog("getUser", obj);
        return obj;
      }),
      chain(
        flow(
          validateUserProfile,
          fromEither
        )
      ) 
```

Enter fullscreen mode Exit fullscreen mode

è¿™æ¯”åŸå§‹å‡½æ•°é•¿ä¸äº†å¤šå°‘ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å·²ç»å¤±å»äº†å¯é‡ç”¨æ€§:ä»¥ FP é£æ ¼é‡å†™å…¶ä½™çš„å‡½æ•°éœ€è¦é‡å¤ä»£ç ã€‚æœ‰äº†åŠ©æ‰‹å‡½æ•°ï¼Œäº‹æƒ…å°±å˜å¾—ç›¸å½“ç®€å•äº†ã€‚

ç¬¬äºŒï¼Œå‡½æ•°ç°åœ¨æ˜¯çº¯å‡½æ•°ï¼Œè¿”å›ç±»å‹æ˜¯ä¸€ä¸ªæŠ½è±¡æ•°æ®ç±»å‹ï¼Œæœ‰ä¸€ç»„ä¸°å¯Œçš„ç»„åˆå­ã€‚å› æ­¤ï¼Œäººä»¬å¯ä»¥ä½¿ç”¨æ‰€æœ‰å¯ç”¨äº`TaskEither`çš„ç»„åˆå­ï¼Œå¾ˆå®¹æ˜“åœ°ä»è¾ƒå°çš„å‡½æ•°ç»„æˆè¾ƒé•¿çš„æµæ°´çº¿ã€‚

ç¬¬ä¸‰ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ˜¾å¼éªŒè¯æ­¥éª¤ï¼Œè¯¥æ­¥éª¤åªåœ¨åŸå§‹å‡½æ•°ä¸­éšå¼æ‰§è¡Œ(`as GitLabUserProfile`)ï¼Œå› æ­¤ä¹Ÿæ·»åŠ äº†å‡ è¡Œä»£ç ã€‚

### å€¼å¾—å—ï¼Ÿ

æœ€åï¼Œäººä»¬å¯ä»¥æ€è€ƒæ˜¯å¦å€¼å¾—å°†`GitLabAPI`ä¸­çš„æ–¹æ³•é‡æ„ä¸ºè¿”å›`TaskEither` s çš„çº¯å‡½æ•°ã€‚æˆ‘è®¤ä¸ºè¿™å–å†³äºå¦‚ä½•ä½¿ç”¨`GitLabAPI`ç±»ã€‚å¦‚æœç±»çš„ç”¨æˆ·é€šè¿‡ç­‰å¾…æ‰¿è¯ºå’Œæ£€æŸ¥é”™è¯¯ç«‹å³æ‰”æ‰äº†`TaskEither`ï¼Œæˆ‘ä»¬åªæ˜¯å¢åŠ äº†ä¸å¿…è¦çš„å¤æ‚æ€§ï¼Œç”¨`isLeft`æ£€æŸ¥æ›¿æ¢äº†ä¸€ä¸ª`try-catch`å—ã€‚

å¦ä¸€æ–¹é¢ï¼Œå¦‚æœç±»çš„ç”¨æˆ·ä½¿ç”¨`TaskEither`å¹¶å°†å…¶ä¸å…¶ä»–ä»»åŠ¡ç»„åˆåœ¨ä¸€èµ·ä»¥åˆ›å»ºæ›´å¤§çš„æ•…äº‹ï¼Œæˆ‘è®¤ä¸ºæ›´ç±»ä¼¼äº FP çš„è§£å†³æ–¹æ¡ˆå¯èƒ½å·²ç»å°±ä½ã€‚ä½ ä¹Ÿå¯ä»¥å¯¹çº¯åº¦é‡‡å–æ›´æ¸©å’Œçš„ç«‹åœºï¼Œå…è®¸å‡½æ•°éšæ„ç™»å½•åˆ°æ§åˆ¶å°ã€‚

è¿™æ˜¯æˆ‘åœ¨ dev.to çš„ç¬¬ä¸€ç¯‡å¸–å­ï¼æˆ‘å¸Œæœ›æœ‰äººä¼šè§‰å¾—å®ƒæœ‰ç”¨:æˆ‘å­¦åˆ°äº†å¾ˆå¤šå…³äºå†™ä½œçš„çŸ¥è¯†ï¼Œä¹Ÿä»æˆåŠŸçš„ç±»å‹æ£€æŸ¥ä¸­è·å¾—äº†å¾ˆå¤šæ»¡è¶³æ„Ÿã€‚æ„Ÿè°¢æ‚¨çš„é˜…è¯»å’Œåˆ†äº«æ‚¨çš„è¯„è®ºï¼

## èµ„æº

*   [FP-ts](https://dev.to/gcanti/getting-started-with-fp-ts-setoid-39f3)ç³»åˆ—å…¥é—¨:å­¦ä¹ çš„å¥½æ–¹æ³•`fp-ts`
*   [ä½¿ç”¨ fp-ts ä¸éåŠŸèƒ½ä»£ç çš„äº’æ“ä½œæ€§](https://dev.to/gcanti/interoperability-with-non-functional-code-using-fp-ts-432e):æåˆ°`TaskEither`çš„æœ‰ç”¨æ–‡ç« 
*   å­¦ä¹  Haskell çš„æœ€å¥½æ–¹æ³•:å­¦ä¹  Haskellï¼Œä¸€ç§çº¯å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€
*   å‡½æ•°å¼ç¼–ç¨‹ç‚¹ç‡ƒå–œæ‚¦ä¹‹ç«:æœ€è¿‘ä¸€ç¯‡å…³äºå‡½æ•°å¼ç¼–ç¨‹çš„æ–‡ç« ï¼Œæˆ‘å¾ˆå–œæ¬¢