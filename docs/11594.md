# WebGL æœˆä»½ã€‚ç¬¬ 24 å¤©ã€‚ç»“åˆåœ°å½¢å’Œå¤©ç©ºç›’

> åŸæ–‡:[https://dev . to/lesnitsky/web GL-month-day-24-combining-terrain-and-skybox-kgo](https://dev.to/lesnitsky/webgl-month-day-24-combining-terrain-and-skybox-kgo)

è¿™æ˜¯ä¸€ç³»åˆ—ä¸ WebGL ç›¸å…³çš„åšæ–‡ã€‚æ¯å¤©éƒ½ä¼šæœ‰æ–°å¸–å­

[![GitHub stars](../Images/2f002bd36aac85f6eb3fad10526da225.png)](https://github.com/lesnitsky/webgl-month)
[![Twitter Follow](../Images/367043e12af3829681d57af89d077b37.png)T6ã€‘](https://twitter.com/lesnitsky_a)

[åŠ å…¥é‚®ä»¶åˆ—è¡¨](http://eepurl.com/gwiSeH),è®©æ–°é‚®ä»¶ç›´æ¥è¿›å…¥ä½ çš„æ”¶ä»¶ç®±

[æ­¤å¤„æä¾›æºä»£ç ](https://github.com/lesnitsky/webgl-month)

å»ºé€ äº

[![Git Tutor Logo](../Images/4a5fcbd1126401b65ca7fbe362404aa0.png)T2ã€‘](https://github.com/lesnitsky/git-tutor)

* * *

å˜¿ğŸ‘‹

æ¬¢è¿æ¥åˆ°ç½‘ç»œåšå®¢æœˆ

åœ¨ä¹‹å‰çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ¸²æŸ“äº† minecraft åœ°å½¢å’Œå¤©ç©ºç›’ï¼Œä½†æ˜¯æ˜¯åœ¨ä¸åŒçš„ä¾‹å­ä¸­ã€‚æˆ‘ä»¬å¦‚ä½•å°†å®ƒä»¬ç»“åˆèµ·æ¥ï¼ŸWebGL å…è®¸ä½¿ç”¨å¤šä¸ªç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è½»å¾®çš„é‡æ„å°†ä¸¤ä¸ªä¾‹å­ç»“åˆèµ·æ¥ã€‚

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„å…¥å£ç‚¹æ–‡ä»¶`minecraft.js`ï¼Œå¹¶å‡è®¾`skybox.js`å’Œ`minecraft-terrain.js`å¯¼å‡º`prepare`å’Œ`render`å‡½æ•°

```
import { prepare as prepareSkybox, render as renderSkybox } from './skybox';
import { prepare as prepareTerrain, render as renderTerrain } from './minecraft-terrain'; 
```

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªç”»å¸ƒ

```
const canvas = document.querySelector('canvas');
const gl = canvas.getContext('webgl');

const width = document.body.offsetWidth;
const height = document.body.offsetHeight;

canvas.width = width * devicePixelRatio;
canvas.height = height * devicePixelRatio;

canvas.style.width = `${width}px`;
canvas.style.height = `${height}px`; 
```

è®¾ç½®æ‘„åƒæœºçŸ©é˜µ

```
const viewMatrix = mat4.create();
const projectionMatrix = mat4.create();

mat4.lookAt(viewMatrix, [0, 0, 0], [0, 0, -1], [0, 1, 0]);

mat4.perspective(projectionMatrix, (Math.PI / 360) * 90, canvas.width / canvas.height, 0.01, 142);

gl.viewport(0, 0, canvas.width, canvas.height);

const cameraPosition = [0, 5, 0];
const cameraFocusPoint = vec3.fromValues(0, 0, 30);
const cameraFocusPointMatrix = mat4.create();

mat4.fromTranslation(cameraFocusPointMatrix, cameraFocusPoint); 
```

å®šä¹‰ä¸€ä¸ªæ¸²æŸ“å‡½æ•°

```
function render() {
    renderSkybox(gl, viewMatrix, projectionMatrix);
    renderTerrain(gl, viewMatrix, projectionMatrix);

    requestAnimationFrame(render);
} 
```

å¹¶æ‰§è¡Œâ€œå‡†å¤‡â€ä»£ç 

```
(async () => {
    await prepareSkybox(gl);
    await prepareTerrain(gl);

    render();
})(); 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦å®ç°å¤©ç©ºç›’å’Œåœ°å½¢çš„`prepare`å’Œ`render`åŠŸèƒ½

è¿™ä¸¤ä¸ªå‡½æ•°éƒ½éœ€è¦è®¿é—®å…±äº«çŠ¶æ€ï¼Œåƒ WebGL ç¨‹åºã€å±æ€§å’Œç¼“å†²åŒºï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¯¹è±¡

```
const State = {};

export async function prepare(gl) {
    // initialization code goes here
} 
```

é‚£ä¹ˆä»€ä¹ˆæ˜¯â€œå‡†å¤‡â€æ­¥éª¤å‘¢ï¼Ÿ

è¿™æ˜¯å…³äºåˆ›å»ºç¨‹åº

```
 export async function prepare(gl) {
+     const vShader = gl.createShader(gl.VERTEX_SHADER);
+     const fShader = gl.createShader(gl.FRAGMENT_SHADER); 
+     compileShader(gl, vShader, vShaderSource);
+     compileShader(gl, fShader, fShaderSource); 
+     const program = gl.createProgram();
+     State.program = program; 
+     gl.attachShader(program, vShader);
+     gl.attachShader(program, fShader); 
+     gl.linkProgram(program);
+     gl.useProgram(program); 
+     State.programInfo = setupShaderInput(gl, program, vShaderSource, fShaderSource);
  } 
```

ç¼“å†²å™¨

```
 gl.useProgram(program);

      State.programInfo = setupShaderInput(gl, program, vShaderSource, fShaderSource);

+     const cube = new Object3D(cubeObj, [0, 0, 0], [0, 0, 0]);
+     State.vertexBuffer = new GLBuffer(gl, gl.ARRAY_BUFFER, cube.vertices, gl.STATIC_DRAW);
  } 
```

çº¹ç†

```
 const cube = new Object3D(cubeObj, [0, 0, 0], [0, 0, 0]);
      State.vertexBuffer = new GLBuffer(gl, gl.ARRAY_BUFFER, cube.vertices, gl.STATIC_DRAW);

+     await Promise.all([
+         loadImage(rightTexture),
+         loadImage(leftTexture),
+         loadImage(upTexture),
+         loadImage(downTexture),
+         loadImage(backTexture),
+         loadImage(frontTexture),
+     ]).then((images) => {
+         State.texture = gl.createTexture();
+         gl.bindTexture(gl.TEXTURE_CUBE_MAP, State.texture); 
+         gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
+         gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
+         gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
+         gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE); 
+         images.forEach((image, index) => {
+             gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X + index, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
+         });
+     }); } 
```

å¹¶è®¾ç½®å±æ€§

```
 gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X   index, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
          });
      });
+     setupAttributes(gl); } 
```

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°æ¥è®¾ç½®å±æ€§ï¼Œå› ä¸ºæˆ‘ä»¬ä¹Ÿéœ€è¦åœ¨æ¸²æŸ“å‡½æ•°ä¸­è¿™æ ·åšã€‚å±æ€§åœ¨ä¸åŒçš„ç¨‹åºä¹‹é—´å…±äº«çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡ä½¿ç”¨ä¸åŒçš„ç¨‹åºæ—¶æ­£ç¡®åœ°è®¾ç½®å®ƒä»¬

`setupAttributes`é•¿å¾—åƒè¿™æ ·`skybox`

```
function setupAttributes(gl) {
    State.vertexBuffer.bind(gl);
    gl.vertexAttribPointer(State.programInfo.attributeLocations.position, 3, gl.FLOAT, false, 0, 0);
} 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œå®ƒå°†è§†å›¾å’ŒæŠ•å½±çŸ©é˜µä¼ é€’ç»™åˆ¶æœï¼Œå¹¶å‘å‡ºä¸€ä¸ªç»˜åˆ¶è°ƒç”¨

```
export function render(gl, viewMatrix, projectionMatrix) {
    gl.useProgram(State.program);

    gl.uniformMatrix4fv(State.programInfo.uniformLocations.viewMatrix, false, viewMatrix);
    gl.uniformMatrix4fv(State.programInfo.uniformLocations.projectionMatrix, false, projectionMatrix);

    setupAttributes(gl);

    gl.drawArrays(gl.TRIANGLES, 0, State.vertexBuffer.data.length / 3);
} 
```

è¿™ç§é‡æ„éå¸¸ç®€å•ï¼Œå› ä¸ºå®ƒåªéœ€è¦å°†ä»£ç ç‰‡æ®µç§»åŠ¨åˆ°å¿…è¦çš„å‡½æ•°ä¸­ï¼Œæ‰€ä»¥è¿™äº›æ­¥éª¤å¯¹äº`minecraft-terrain`æ¥è¯´çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ï¼Œåªæœ‰ä¸€ä¸ªä¾‹å¤–

æˆ‘ä»¬ä½¿ç”¨`ANGLE_instanced_arrays`æ‰©å±•æ¥æ¸²æŸ“åœ°å½¢ï¼Œå®ƒè®¾ç½®äº†`divisorAngle`ã€‚ç”±äºå±æ€§åœ¨ç¨‹åºä¹‹é—´å…±äº«çŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦â€œé‡ç½®â€é‚£äº›é™¤æ•°è§’åº¦ã€‚

```
function resetDivisorAngles() {
    for (let i = 0; i < 4; i++) {
        State.ext.vertexAttribDivisorANGLE(State.programInfo.attributeLocations.modelMatrix + i, 0);
    }
} 
```

å¹¶åœ¨ä¸€æ¬¡ draw è°ƒç”¨
åè°ƒç”¨è¯¥å‡½æ•°

```
export function render(gl, viewMatrix, projectionMatrix) {
    gl.useProgram(State.program);

    setupAttributes(gl);

    gl.uniformMatrix4fv(State.programInfo.uniformLocations.viewMatrix, false, viewMatrix);
    gl.uniformMatrix4fv(State.programInfo.uniformLocations.projectionMatrix, false, projectionMatrix);

    State.ext.drawArraysInstancedANGLE(gl.TRIANGLES, 0, State.vertexBuffer.data.length / 3, 100 * 100);

    resetDivisorAngles();
} 
```

ç”Ÿæˆçš„ä»£ç çœŸçš„èƒ½å·¥ä½œå—ï¼Ÿ

ä¸å¹¸çš„æ˜¯æ²¡æœ‰ğŸ˜¢
é—®é¢˜æ˜¯æˆ‘ä»¬åœ¨æ¯”æˆ‘ä»¬çš„åœ°å½¢å°çš„ç«‹æ–¹ä½“ä¸­æ¸²æŸ“å¤©ç©ºç›’ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹å˜å¤©ç©ºç›’é¡¶ç‚¹ç€è‰²å™¨æ¥ä¿®å¤å®ƒ

```
 attribute vec3 position;
  varying vec3 vTexCoord;

  uniform mat4 projectionMatrix;
  uniform mat4 viewMatrix;

  void main() {
      vTexCoord = position;
-     gl_Position = projectionMatrix * viewMatrix * vec4(position, 1); +     gl_Position = projectionMatrix * viewMatrix * vec4(position, 0.01);
  } 
```

é€šè¿‡æ”¹å˜ç¬¬å››ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°†æŠŠå¤©ç©ºç›’ç¼©æ”¾ 100 å€(é½æ¬¡åæ ‡çš„é­”åŠ›)ã€‚

åœ¨è¿™ä¸ªæ”¹å˜ä¹‹åï¼Œä¸–ç•Œçœ‹èµ·æ¥è¿˜å¯ä»¥ï¼Œç›´åˆ°æˆ‘ä»¬è¯•ç€çœ‹æˆ‘ä»¬ä¸–ç•Œç«‹æ–¹ä½“çš„æœ€è¿œçš„â€œè¾¹ç¼˜â€ã€‚å¤©ç©ºç›’ä¸ä¼šå‘ˆç°åœ¨é‚£é‡ŒğŸ˜¢

è¿™æ˜¯å› ä¸ºä¼ é€’ç»™æŠ•å½±çŸ©é˜µ
çš„`zFar`å‚æ•°

```
 const projectionMatrix = mat4.create();

  mat4.lookAt(viewMatrix, [0, 0, 0], [0, 0, -1], [0, 1, 0]);

- mat4.perspective(projectionMatrix, (Math.PI / 360) * 90, canvas.width / canvas.height, 0.01, 100);
+ mat4.perspective(projectionMatrix, (Math.PI / 360) * 90, canvas.width / canvas.height, 0.01, 142); 
  gl.viewport(0, 0, canvas.width, canvas.height); 
```

åˆ°æœ€è¿œè¾¹ç¼˜çš„è·ç¦»æ˜¯`Math.sqrt(size ** 2 + size ** 2)`ï¼Œä¹Ÿå°±æ˜¯`141.4213562373095`ï¼Œæˆ‘ä»¬æ­£å¥½å¯ä»¥é€šè¿‡`142`

å°±æ˜¯è¿™æ ·ï¼

æ„Ÿè°¢é˜…è¯»ï¼Œæ˜å¤©è§ğŸ‘‹

* * *

è¿™æ˜¯ä¸€ç³»åˆ—ä¸ WebGL ç›¸å…³çš„åšæ–‡ã€‚æ¯å¤©éƒ½ä¼šæœ‰æ–°å¸–å­

[![GitHub stars](../Images/2f002bd36aac85f6eb3fad10526da225.png)](https://github.com/lesnitsky/webgl-month)
[![Twitter Follow](../Images/367043e12af3829681d57af89d077b37.png)T6ã€‘](https://twitter.com/lesnitsky_a)

[åŠ å…¥é‚®ä»¶åˆ—è¡¨](http://eepurl.com/gwiSeH),è®©æ–°é‚®ä»¶ç›´æ¥è¿›å…¥ä½ çš„æ”¶ä»¶ç®±

[æ­¤å¤„æä¾›æºä»£ç ](https://github.com/lesnitsky/webgl-month)

å»ºé€ äº

[![Git Tutor Logo](../Images/4a5fcbd1126401b65ca7fbe362404aa0.png)T2ã€‘](https://github.com/lesnitsky/git-tutor)