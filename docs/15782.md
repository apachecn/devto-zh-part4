# æé«˜é˜²é”ˆå’Œç½‘çŠ¶è£…é…æ€§èƒ½ğŸš€ğŸš€ğŸš€

> åŸæ–‡:[https://dev . to/sendilkumarn/increase-rust-and-web assembly-performance-382h](https://dev.to/sendilkumarn/increase-rust-and-webassembly-performance-382h)

åœ¨æµè§ˆå™¨ä¸­è¿è¡Œæœ¬æœºä»£ç çš„æ¢¦æƒ³å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ã€‚æœ‰è®¸å¤šå¤±è´¥çš„å°è¯•ã€‚ä»–ä»¬éƒ½ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ•™è®­ã€‚è¿™äº›çŸ¥è¯†ä½¿ä»Šå¤©æˆä¸ºå¯èƒ½ã€‚

WebAssembly ä½¿å¾—åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ Cã€C++ã€Rust ç­‰è¯­è¨€æˆä¸ºå¯èƒ½ã€‚

* * *

æŸ¥çœ‹æˆ‘å…³äº Rust å’Œ WebAssembly çš„ä¹¦[è¿™é‡Œ](https://sendilkumarn.com/wasm-book)

* * *

ä½†æ˜¯ä»€ä¹ˆæ˜¯ WebAssembly å‘¢ï¼Ÿç‚¹å‡»æ­¤å¤„æˆ–[æŸ¥çœ‹è¿™ç¯‡æ¥è‡ªæ—å…‹æ‹‰å…‹çš„](https://hacks.mozilla.org/2017/02/a-cartoon-intro-to-webassembly/)ç²¾å½©å¸–å­ã€‚

## TLï¼›åšå£«:

*   Rust çš„å·¥å…·é“¾ä½¿ç¼–å†™ WebAssembly åº”ç”¨ç¨‹åºå˜å¾—å®¹æ˜“ã€‚
*   å¦‚æœä½ æƒ³è¦æ›´å¥½çš„æ€§èƒ½ï¼Œé‚£ä¹ˆä½¿ç”¨`opt-level=3`ã€‚
*   å¦‚æœä½ æƒ³è¦ä¸€ä¸ªæ›´å°çš„åŒ…ï¼Œé‚£ä¹ˆä½¿ç”¨`opt-level="s"`ã€‚

# [](#what-are-we-gonna-do)æˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼Ÿ

åˆ›å»ºä¸€ä¸ª WebAssembly åº”ç”¨ç¨‹åºï¼Œå®ƒæ¥å—ä¸€ä¸ª`markdown`æ ¼å¼çš„å­—ç¬¦ä¸²å¹¶å°†å…¶è½¬æ¢æˆ HTMLã€‚

# [](#lets-get-started)æˆ‘ä»¬å¼€å§‹å§

åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒRust æ‹¥æœ‰ WebAssembly çš„æœ€ä½³å·¥å…·ã€‚å®ƒä¸è¯­è¨€ç»“åˆå¾—å¾ˆå¥½ã€‚è¿™ä½¿å¾— Rust æˆä¸ºåš WebAssembly çš„æœ€ä½³é€‰æ‹©ã€‚

æˆ‘ä»¬éœ€è¦åœ¨å¼€å§‹ä¹‹å‰å®‰è£… Rustã€‚è¦å®‰è£… Rust checkoutï¼Œè¯·æŸ¥çœ‹æ­¤å¤„çš„å®‰è£…æŒ‡å—ã€‚

ä¸€æ—¦ä½ å®‰è£…äº†é“é”ˆã€‚è®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºåº”ç”¨ç¨‹åºã€‚

# [](#create-application)åˆ›å»ºåº”ç”¨ç¨‹åº

ç”¨æ‰€æœ‰å¿…è¦çš„å·¥å…·é“¾åˆ›å»ºä¸€ä¸ª WebAssembly åº”ç”¨ç¨‹åº:

```
npm init rust-webpack markdown-rust 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ç”¨ Webpack åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„åŸºäº Rust + JavaScript çš„åº”ç”¨ç¨‹åºã€‚

è¿›å…¥ç›®å½•

```
cd markdown-rust 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒæ—¢æœ‰`Cargo.toml`åˆæœ‰`package.json`ã€‚

Rust æºæ–‡ä»¶ä½äº`src`ç›®å½•ä¸­ï¼ŒJavaScript æ–‡ä»¶ä½äº`js`ç›®å½•ä¸­ã€‚æˆ‘ä»¬è¿˜é…ç½®äº† webpackï¼Œä»¥ä¾¿è½»æ¾å¿«é€Ÿåœ°è¿è¡Œåº”ç”¨ç¨‹åºã€‚

`Cargo.toml`åŒ…å«ä»¥ä¸‹å†…å®¹:

```
[package]
# Some package information. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åï¼Œå®ƒå£°æ˜é¡¹ç›®å°†ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ„å»ºä¸€ä¸ª`dynamic library`ã€‚

```
[lib]
crate-type = ["cdylib"] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜å£°æ˜äº†å‘å¸ƒæ¦‚è¦æ–‡ä»¶åº”è¯¥ä½¿ç”¨`lto`æ ‡å¿—æ¥ä¼˜åŒ–å‘å¸ƒã€‚

```
[profile.release]
lto = true 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€ååŠ äº†ä¸€äº›`[features]`å’Œ`[depdencies]`ã€‚

ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯ä¸º Rust æ·»åŠ `markdown`åº“ï¼Œå®ƒå°† Markdown (string)ç¼–è¯‘æˆ HTML å­—ç¬¦ä¸²ã€‚

```
[dependencies]
# some comments ......
wasm-bindgen = "0.2.45"
comrak = "0.6" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ é™¤`src/lib.rs`ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶æ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹ã€‚

åŠ è½½æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„`comrak`å‡½æ•°å’Œ`wasm_bindgen`ã€‚

```
use comrak::{markdown_to_html, ComrakOptions};
use wasm_bindgen::prelude::*; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### [](#so-what-is-raw-wasmbindgen-endraw-)é‚£ä¹ˆä»€ä¹ˆæ˜¯`wasm_bindgen`ï¼Ÿ

WebAssembly æ²¡æœ‰ä»»ä½•ç»‘å®šæ¥è°ƒç”¨ JavaScript æˆ–æ–‡æ¡£ APIã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬åªèƒ½åœ¨ JavaScript å’Œ WebAssembly ä¹‹é—´ä¼ é€’æ•°å­—ã€‚ä½†è¿™å¹¶ä¸æ€»æ˜¯ä»¤äººæ»¡æ„çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®ƒä»¬ä¹‹é—´ä¼ é€’ JS å¯¹è±¡ã€å­—ç¬¦ä¸²ã€ç±»ã€é—­åŒ…å’Œå…¶ä»–ä¸œè¥¿ã€‚

> æˆ‘ä»¬å¦‚ä½•å®ç°è¿™ä¸€ç›®æ ‡ï¼Ÿ

æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç»‘å®šæ–‡ä»¶æˆ–èƒ¶æ°´æ–‡ä»¶ï¼Œå¸®åŠ©å°†ä¸Šè¿°å¯¹è±¡è½¬æ¢ä¸ºæ•°å­—ã€‚ä¾‹å¦‚ï¼Œåœ¨å­—ç¬¦ä¸²çš„æƒ…å†µä¸‹ï¼Œè€Œä¸æ˜¯å°†æ¯ä¸ªå­—ç¬¦ä½œä¸ºå­—ç¬¦ä»£ç å‘é€ã€‚

æˆ‘ä»¬å¯ä»¥å°†è¯¥å­—ç¬¦ä¸²æ”¾åœ¨çº¿æ€§å†…å­˜æ•°ç»„ä¸­ï¼Œç„¶åå°†èµ·å§‹ç´¢å¼•(å®ƒåœ¨å†…å­˜ä¸­çš„ä½ç½®)åŠå…¶é•¿åº¦ä¼ é€’ç»™å¦ä¸€ä¸ªä¸–ç•Œ(æˆ– JavaScript)ã€‚å¦ä¸€ä¸ªä¸–ç•Œåº”è¯¥å¯ä»¥è®¿é—®è¿™ä¸ªçº¿æ€§å†…å­˜æ•°ç»„ï¼Œå¹¶ä»é‚£é‡Œè·å–ä¿¡æ¯ã€‚

ä½†æ˜¯å¯¹ JavaScript å’Œ WebAssembly ä¹‹é—´ä¼ é€’çš„æ¯ä¸ªå€¼éƒ½è¿™æ ·åšæ—¢è€—æ—¶åˆå®¹æ˜“å‡ºé”™ã€‚ [wasm_bindgen](https://rustwasm.github.io/wasm-bindgen/) å·¥å…·å¸®åŠ©æ‚¨è‡ªåŠ¨æ„å»ºç»‘å®šæ–‡ä»¶ï¼Œå¹¶åˆ é™¤å¸¦æœ‰å•ä¸ª`#[wasm_bindgen]`æ³¨é‡Šçš„æ ·æ¿ä»£ç ã€‚

ä½†æ˜¯æˆ‘ä»¬éœ€è¦éå¸¸å°å¿ƒæœ‰å¤šå°‘æ¬¡è·¨è¶Šäº† JavaScript å’Œ WebAssembly æ¨¡å—ä¹‹é—´çš„ç•Œé™ã€‚æˆ‘ä»¬ç©¿è¶Šå¾—è¶Šå¤šï¼Œæ€§èƒ½å°±è¶Šæ…¢ã€‚

ç°åœ¨æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º parse çš„å‡½æ•°ï¼Œå®ƒå®é™…ä¸Šæ¥å— markdown è¾“å…¥å¹¶è¿”å› HTMLã€‚

```
#[wasm_bindgen]
pub fn parse(input: &str) -> String {
    markdown_to_html(&input.to_string(), &ComrakOptions::default())
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`#[wasm_bindgen]`æ³¨é‡Šå®Œæˆäº†å°†å­—ç¬¦ä¸²è½¬æ¢æˆä¸¤ä¸ªæ•°å­—çš„æ‰€æœ‰æ ·æ¿å·¥ä½œï¼Œä¸€ä¸ªæ˜¯æŒ‡å‘çº¿æ€§å†…å­˜ä¸­å­—ç¬¦ä¸²å¼€å¤´çš„æŒ‡é’ˆï¼Œå¦ä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚`#[wasm_bindgen]`ä¹Ÿç”¨ JavaScript ç”Ÿæˆç»‘å®šæ–‡ä»¶ã€‚

#### JavaScriptâ¤ï¸çš„æ—¶é—´åˆ°äº†

ç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº† WebAssembly æ¨¡å—ã€‚æ˜¯æ—¶å€™ä½¿ç”¨ä¸€äº› JavaScript äº†ã€‚

æˆ‘ä»¬å°†åˆ é™¤`js/index.js`ä¸­çš„æ‰€æœ‰è¡Œï¼Œå¹¶æ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹ã€‚

æˆ‘ä»¬å°†é¦–å…ˆå¯¼å…¥ç”Ÿæˆçš„ WebAssembly æ¨¡å—ã€‚å› ä¸ºæˆ‘ä»¬ä½¿ç”¨ Webpackï¼Œæ‰€ä»¥ Webpack å°†è´Ÿè´£å¼•å¯¼`wasm_pack`ï¼Œå¼•å¯¼å°†ä¾æ¬¡ä½¿ç”¨`wasm_bindgen`å°† Rust è½¬æ¢ä¸º WebAssembly æ¨¡å—ï¼Œç„¶åç”Ÿæˆå¿…è¦çš„ç»‘å®šæ–‡ä»¶ã€‚

`wasm_pack`æ˜¯ä¸€ä¸ªå¸®åŠ©æ„å»ºå’Œæ‰“åŒ… Rust å’Œ WebAssembly åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚æ›´å¤šå…³äº Wasm-pack [è¿™é‡Œ](https://rustwasm.github.io/wasm-pack/)ã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬åªéœ€å¯¼å…¥`pkg/index.js`æ–‡ä»¶ã€‚wasm_pack å°†åœ¨è¿™é‡Œç”Ÿæˆè¾“å‡ºã€‚

```
const rust = import('../pkg/index.js'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŠ¨æ€å¯¼å…¥å°†åˆ›å»ºæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºåœ¨è§£ææ—¶ç»™å‡º WebAssembly æ¨¡å—çš„ç»“æœã€‚æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·è°ƒç”¨ Rust æ–‡ä»¶å†…éƒ¨å®šä¹‰çš„å‡½æ•°`parse`ã€‚

```
rust.then(module => {
    console.log(module.parse('#some markdown content')); 
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜å°†è®¡ç®—ä½¿ç”¨ WebAssembly æ¨¡å—è§£æå†…å®¹æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚

```
rust.then(module => {
    console.log(module.parse('#some markdown content'));

    const startWasm = performance.now();
    module.parse('#Heading 1');
    const endWasm = performance.now();

    console.log(`It took ${endWasm - startWasm} to do this in WebAssembly`);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†æ¯”è¾ƒï¼Œæˆ‘ä»¬è¿˜å°†è®¡ç®—ç”¨ JavaScript åšè¿™ä»¶äº‹æ‰€èŠ±çš„æ—¶é—´ã€‚

å®‰è£… JavaScript çš„ markdown åº“ã€‚

```
npm install --save marked 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®‰è£…å®Œæˆåï¼Œè®©æˆ‘ä»¬ç¼–å†™ JavaScript ä»£ç ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª Markdown æ–‡æœ¬å¹¶è¿”å› HTMLã€‚

```
 // js/index.js
import marked from 'marked';
// some content goes here;

const markdown = '#Heading';

const startJs = performance.now();
console.log(marked(markdown));
const endJs = performance.now();

console.log(`It took ${endJs - startJs} to do this in JavaScript`); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬ä½¿ç”¨`npm run start`è¿è¡Œåº”ç”¨ç¨‹åºã€‚è¿™å°†å¯åŠ¨ Webpack dev æœåŠ¡å™¨å¹¶ä»æœ¬åœ°æä¾›å†…å®¹ã€‚

[https://codesandbox.io/embed/xenodochial-tesla-rimzu](https://codesandbox.io/embed/xenodochial-tesla-rimzu)

è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£çš„æ€§èƒ½ç»Ÿè®¡æ•°æ®ã€‚

åœ¨ Chrome å’Œ Safari ä¸­ï¼ŒJavaScript çš„æ€§èƒ½è¦æ¯” WebAssembly å¥½å¾—å¤šã€‚ä½†æ˜¯åœ¨ Firefox ä¸­ï¼ŒJavaScript ç‰ˆæœ¬æ¯” WebAssembly æ…¢äº† 50%ã€‚

è¿™ä¸»è¦æ˜¯å› ä¸ºä¸å…¶ä»–æµè§ˆå™¨ç›¸æ¯”ï¼ŒFirefox ä¸­çš„ WebAssembly é“¾æ¥å’Œå¼•å¯¼éå¸¸éå¸¸å¿«ã€‚

å¦‚æœçœ‹ä¸€ä¸‹åŒ…çš„å¤§å°ï¼ŒWebAssembly æ–‡ä»¶æ¯” JavaScript å˜ä½“ 1009 KB å¤§ 7475 KBã€‚

å¦‚æœä½ ç°åœ¨å¯¹ WebAssembly èµ·å“„ï¼Œé‚£å°±ç­‰ç€å§ã€‚

æˆ‘ä»¬è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ä¼˜åŒ–ã€‚è®©æˆ‘ä»¬æ·»åŠ ä¸€äº›ä¼˜åŒ–å¹¶æ£€æŸ¥æ€§èƒ½ã€‚

æ‰“å¼€`Cargo.toml`æ–‡ä»¶ï¼Œå¹¶åœ¨`[features]`éƒ¨åˆ†ä¸Šæ–¹æ·»åŠ ä»¥ä¸‹æ®µã€‚

```
[profile.dev]
lto = true
opt-level = 3 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`opt-level`åªä¸è¿‡æ˜¯ç¼–è¯‘é¡¹ç›®çš„ä¼˜åŒ–çº§åˆ«ã€‚

è¿™é‡Œçš„`lto`æŒ‡çš„æ˜¯`link-time-optimization`ã€‚

> æ³¨æ„:åœ¨å¤„ç†å®é™…åº”ç”¨ç¨‹åºæ—¶ï¼Œè¿™ä¸ªä¼˜åŒ–çº§åˆ«å’Œ lto åº”è¯¥æ·»åŠ åˆ°`profile.release`ä¸­ã€‚

æ­¤å¤–ï¼Œå¯ç”¨`wee_alloc`,å®ƒåˆ†é…çš„å†…å­˜è¦å°‘å¾—å¤šã€‚

å–æ¶ˆ`Cargo.toml`
ä¸­çš„ä»¥ä¸‹æ³¨é‡Š

```
[features]
default = ["wee_alloc"] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`src/lib.rs`æ–‡ä»¶ä¸­æ·»åŠ `wee_alloc`å†…å­˜åˆ†é…ã€‚

```
#[cfg(feature = "wee_alloc")]
#[global_allocator]
static ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚

[https://codesandbox.io/embed/hidden-sun-cdhms](https://codesandbox.io/embed/hidden-sun-cdhms)

æˆ‘ä»¬ç°åœ¨å¯ä»¥çœ‹åˆ° WebAssembly çš„çœŸæ­£æ€§èƒ½ä¼˜åŠ¿ã€‚åœ¨ Chrome ä¸­ï¼ŒWebAssembly ç‰ˆæœ¬æ¯” JavaScript ç‰ˆæœ¬å¿« 4 å€ã€‚

åœ¨ Safari ä¸­ï¼ŒJavaScript å˜ä½“ä»ç„¶åœ¨ 2-3 æ¯«ç§’ä¹‹é—´ï¼Œä½†æ˜¯ WebAssembly å˜ä½“åœ¨ 0-2 æ¯«ç§’ä¹‹é—´ã€‚

Firefox ä½¿ç”¨ä¼˜åŒ–åçš„ WebAssembly ä»£ç ä¹Ÿæ¯”æ²¡æœ‰ä¼˜åŒ–æ—¶å¿«äº†è¿‘ 50%ã€‚

ç°åœ¨ï¼Œå¯¹äº WebAssembly æ¥è¯´æœ€é‡è¦çš„åŒ…å¤§å°æ˜¯ 1280 KBï¼Œå¯¹äº JavaScript æ¥è¯´æ˜¯ 1009 KBã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥è¦æ±‚ Rust ç¼–è¯‘å™¨é’ˆå¯¹å¤§å°è€Œä¸æ˜¯é€Ÿåº¦è¿›è¡Œä¼˜åŒ–ã€‚æŒ‡å®šå°†`opt-level`æ”¹ä¸º`s`

```
opt-level = "s" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[https://codesandbox.io/embed/beautiful-clarke-cr649](https://codesandbox.io/embed/beautiful-clarke-cr649)

WebAssembly ä»ç„¶æ˜¯æ˜æ˜¾çš„èµ¢å®¶ï¼Œä½† Chrome æ³¨å†Œçš„ WebAssembly æ—¶é—´ç•¥æœ‰å¢åŠ ï¼Œä½†ä»ä½äº JavaScript å˜ä½“ã€‚Safari å’Œ Firefox éƒ½ä¸º WebAssembly æä¾›äº†æ›´é«˜çš„æ€§èƒ½ã€‚

å¯¹äº WebAssemblyï¼ŒåŒ…çš„å¤§å°è¿›ä¸€æ­¥å‡å°ï¼Œå¤§çº¦ä¸º 1220 KBï¼Œå¯¹äº JavaScriptï¼Œä¸º 1009 KBã€‚

Rust ç¼–è¯‘å™¨è¿˜æ”¯æŒè¿›ä¸€æ­¥å‡å°æ–‡ä»¶å¤§å°çš„`opt-level = "z"`ã€‚

```
opt-level = "z" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[https://codesandbox.io/embed/upbeat-ritchie-43rth](https://codesandbox.io/embed/upbeat-ritchie-43rth)

å¯¹äº WebAssemblyï¼ŒåŒ…çš„å¤§å°è¿›ä¸€æ­¥å‡å°ï¼Œå¤§çº¦ä¸º 1161KBï¼Œå¯¹äº JavaScript ä¸º 1009 KBã€‚

Chrome ä¸­çš„ WebAssembly æ¨¡å—åœ¨ 41 åˆ° 140 ms ä¹‹é—´ä½¿ç”¨`opt-level='z'`æ—¶æ€§èƒ½æ³¢åŠ¨å¾ˆå¤§ã€‚

IE Canary for Mac çš„æ€§èƒ½(~)å‡ ä¹å’Œ Chrome ä¸€æ ·ã€‚

å¦‚æœä½ æ›´å…³å¿ƒä½ çš„åŒ…çš„å¤§å°ï¼Œä½†æ˜¯ç°åœ¨ v8 çš„æ€§èƒ½ä¸å¯é ï¼Œä½¿ç”¨`opt-level="z"`ã€‚

æˆ‘å¸Œæœ›è¿™èƒ½ç»™ä½ ä¸€ä¸ªåŠ¨åŠ›ï¼Œå¼€å§‹ä½ çš„ web ç»„è£…ä¹‹æ—…ã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜/å»ºè®®/è§‰å¾—æˆ‘é”™è¿‡äº†ä»€ä¹ˆï¼Œè¯·éšæ—¶æ·»åŠ è¯„è®ºã€‚

* * *

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œé‚£ä¹ˆä½ å¯èƒ½ä¼šå–œæ¬¢æˆ‘å…³äº Rust å’Œ WebAssembly çš„ä¹¦ã€‚ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹

* * *

ä½ å¯ä»¥åœ¨æ¨ç‰¹ä¸Šå…³æ³¨æˆ‘ã€‚

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç•™ä¸‹èµæˆ–è¯„è®ºã€‚â¤ï¸