# å¦‚ä½•åœ¨ Kubernetes ä¸Šç”¨ Istio æœåŠ¡ç½‘æ ¼è®¾ç½® Java å¾®æœåŠ¡

> åŸæ–‡ï¼š<https://dev.to/deepu105/how-to-set-up-java-microservices-with-istio-service-mesh-on-kubernetes-5bkn>

*æœ€åˆå‘å¸ƒäº[deepu . tech](https://deepu.tech/jhipster-microservices-with-istio-service-mesh-on-kubernetes/)T3ã€‚*

æœ€åˆå‘å¸ƒäº 2018 å¹´ 11 æœˆ 17 æ—¥[åª’ä½“](https://medium.com/free-code-camp/jhipster-microservices-with-istio-service-mesh-on-kubernetes-a7d0158ba9a3)ã€‚
æœ¬æ–‡å·²äº 2020 å¹´ 1 æœˆæ›´æ–°ï¼Œä»¥ä¾¿ä¸ JHipster(7 . 0 . 0-beta 1)å’Œ Istio(1.8.2)çš„æœ€æ–°ç‰ˆæœ¬é…åˆä½¿ç”¨ã€‚

* * *

Istio ç°åœ¨æ˜¯ DevOps å’Œ Cloud block ä¸Šæœ€é…·çš„å­©å­ã€‚å¯¹äºé‚£äº›æ²¡æœ‰å¯†åˆ‡å…³æ³¨çš„äººæ¥è¯´ï¼ŒIstio æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨æ¶æ„çš„æœåŠ¡ç½‘æ ¼ï¼Œå°¤å…¶æ˜¯é‚£äº›ä½¿ç”¨ Kubernetes åœ¨äº‘ä¸Šè¿è¡Œçš„åº”ç”¨ã€‚Istio ä¸ Kubernetes é…åˆå¾—éå¸¸å¥½ï¼Œå¥½åˆ°ä½ å¯èƒ½ä¼šè®¤ä¸ºå®ƒæ˜¯ Kubernetes å¹³å°çš„ä¸€éƒ¨åˆ†ã€‚å½“ä½ ä½¿ç”¨ Google Kubernetes å¼•æ“æ—¶ï¼Œåƒ Google Cloud è¿™æ ·çš„å¹³å°ç”šè‡³å¯ä»¥æä¾›å¼€ç®±å³ç”¨çš„æœåŠ¡ã€‚

å¦‚æœä½ è¿˜æƒ³çŸ¥é“ï¼Œåˆ°åº•ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼æˆ– Istioï¼Ÿé‚£ä¹ˆæˆ‘ä»¬æ¥å¯¹ Istio åšä¸€ä¸ªæ¦‚è¿°ã€‚

## Istio

Istio åœ¨åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºæ¶æ„ä¸­æä¾›äº†ä»¥ä¸‹åŠŸèƒ½:

*   æœåŠ¡å‘ç°â€”â€”ä¼ ç»Ÿä¸Šç”±å¹³å°æä¾›ï¼Œå¦‚[ç½‘é£å°¤é‡Œå¡](https://github.com/Netflix/eureka/wiki)æˆ–[é¢†äº‹](https://www.consul.io/)ã€‚

*   è‡ªåŠ¨è´Ÿè½½å¹³è¡¡â€”â€”ä½ å¯èƒ½å·²ç»ä¸ºæ­¤ä½¿ç”¨äº†[ç½‘é£Â·ç¥–å°”](https://github.com/Netflix/zuul/wiki)ã€‚

*   è·¯ç”±ã€æ–­è·¯ã€é‡è¯•ã€æ•…éšœè½¬ç§»ã€æ•…éšœæ³¨å…¥â€”â€”æƒ³æƒ³[ç½‘é£ä¸å¸¦](https://github.com/Netflix/ribbon/wiki)ã€[æµ·å´”å…‹æ–¯](https://github.com/Netflix/Hystrix)ç­‰ç­‰ã€‚

*   é’ˆå¯¹è®¿é—®æ§åˆ¶ã€é€Ÿç‡é™åˆ¶ã€A/B æµ‹è¯•ã€æµé‡åˆ†æµå’Œé…é¢çš„ç­–ç•¥å®æ–½â€”â€”åŒæ ·ï¼Œæ‚¨å¯èƒ½å·²ç»ä½¿ç”¨ Zuul å®Œæˆäº†å…¶ä¸­çš„ä¸€äº›ä»»åŠ¡ã€‚

*   åº¦é‡ã€æ—¥å¿—å’Œè·Ÿè¸ªâ€”â€”æƒ³æƒ³ [ELK](https://www.elastic.co/elk-stack) æˆ–[å †æ ˆé©±åŠ¨ç¨‹åº](https://cloud.google.com/stackdriver/)

*   å®‰å…¨çš„æœåŠ¡å¯¹æœåŠ¡é€šä¿¡

ä¸‹é¢æ˜¯ Istio çš„æ¶æ„ã€‚

[![Istio architecture](img/6e3dc61f3f57a72bab3942cf1e526494.png) ](https://res.cloudinary.com/practicaldev/image/fetch/s--8IpEP9KJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/2500/1%2A_STCerKXb4L3Hutyn4P5Gw.png) * Istio å»ºç­‘*

å®ƒå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªä¸åŒçš„å±‚é¢ã€‚

**æ•°æ®å¹³é¢**:ç”±[ç‰¹ä½¿](https://www.envoyproxy.io/)ä»£ç†ç»„æˆï¼Œéƒ¨ç½²ä¸ºåº”ç”¨ç¨‹åºå®¹å™¨çš„ä¾§æŸœã€‚å®ƒä»¬æ§åˆ¶ç€å®¹å™¨çš„æ‰€æœ‰è¿›å‡ºæµé‡ã€‚

**æ§åˆ¶å¹³é¢**:ä½¿ç”¨ Pilot ç®¡ç†å’Œé…ç½®ä»£ç†è·¯ç”±æµé‡ã€‚å®ƒè¿˜é…ç½® Mixer æ¥æ‰§è¡Œç­–ç•¥å’Œæ”¶é›†é¥æµ‹æ•°æ®ã€‚å®ƒè¿˜æœ‰å…¶ä»–ç»„ä»¶ï¼Œå¦‚ Citadelï¼Œç”¨äºç®¡ç†å®‰å…¨æ€§ï¼ŒGalleyï¼Œç”¨äºç®¡ç†é…ç½®ã€‚

æ‚¨è¿˜å¯ä»¥é…ç½®[æ ¼æ‹‰æ³•çº³](https://grafana.com/)ã€[æ™®ç½—ç±³ä¿®æ–¯](https://prometheus.io/)ã€[è€¶æ ¼](https://www.jaegertracing.io/) / [é½æ™®é‡‘](https://zipkin.io/)å’Œ[åŸºäºšåˆ©](https://www.kiali.io/)è¿›è¡Œç›‘æ§å’Œè§‚å¯Ÿï¼Œå› ä¸ºå®ƒä»¬ä¸ Istio é…åˆè‰¯å¥½ã€‚å¦‚æœæ‚¨æ„¿æ„çš„è¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªæˆ–è€…ä½¿ç”¨æ‚¨ç°æœ‰çš„ç›‘æ§å †æ ˆã€‚å¦‚æœæ‚¨ä½¿ç”¨ Istio é™„å¸¦çš„æ¼”ç¤ºé…ç½®æ–‡ä»¶ï¼Œå®ƒä¼šä¸º Grafanaã€Kiali ç­‰é¢„é…ç½®ä»ªè¡¨æ¿å’Œé…ç½®ã€‚

æˆ‘å¸Œæœ›è¿™æä¾›äº†å¯¹ Istio çš„æ¦‚è¿°ï¼Œç°åœ¨è®©æˆ‘ä»¬å…³æ³¨æœ¬æ–‡çš„ç›®æ ‡ã€‚

## å‡†å¤‡ Kubernetes é›†ç¾¤

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å‡†å¤‡ä¸€ä¸ª Kubernetes é›†ç¾¤æ¥éƒ¨ç½² Istio å’Œåº”ç”¨ç¨‹åºå®¹å™¨ã€‚éµå¾ªæ‚¨å–œæ¬¢çš„ä»»ä½•ä¸€ä¸ªå¹³å°çš„è¯´æ˜ã€‚

### å…ˆå†³æ¡ä»¶

æˆ‘ä»¬å°†ä½¿ç”¨ [istioctl](https://istio.io/latest/docs/reference/commands/istioctl/) åœ¨ Kubernetes é›†ç¾¤ä¸Šå®‰è£… Istioï¼Œä½¿ç”¨ [kubectl](https://kubernetes.io/docs/reference/kubectl/kubectl/) éƒ¨ç½²åº”ç”¨ç¨‹åºã€‚

**:ä¸ Kubernetes äº¤äº’çš„å‘½ä»¤è¡Œå·¥å…·ã€‚[å®‰è£…](https://kubernetes.io/docs/tasks/tools/install-kubectl/)å¹¶è¿›è¡Œé…ç½®ã€‚**

 **### åœ¨ Azure Kubernetes æœåŠ¡(AKS)ä¸Šåˆ›å»ºé›†ç¾¤

å¦‚æœä½ å‡†å¤‡ä½¿ç”¨ Azureï¼Œé‚£ä¹ˆå®‰è£… [**Azure CLI**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest) ä¸ Azure äº¤äº’ã€‚å®‰è£…å¹¶ä½¿ç”¨ä½ çš„ Azure è´¦æˆ·ç™»å½•(å¦‚æœä½ è¿˜æ²¡æœ‰ä¸€ä¸ª[å…è´¹è´¦æˆ·](https://azure.microsoft.com/en-us/free/)ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª)ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯·è·³è¿‡è¿™ä¸€éƒ¨åˆ†ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªèµ„æºç»„ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨ä»»ä½•ä½ å–œæ¬¢çš„åœ°åŒºï¼Œè€Œä¸æ˜¯ç¾å›½ä¸œéƒ¨ã€‚

```
$ az group create --name eCommerceCluster --location eastus 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ›å»º Kubernetes é›†ç¾¤:

```
$ az aks create \
  --resource-group eCommerceCluster \
  --name eCommerceCluster \
  --node-count 4 \
  --kubernetes-version 1.15 \
  --enable-addons monitoring \
  --generate-ssh-keys 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`node-count`æ ‡å¿—å¾ˆé‡è¦ï¼Œå› ä¸ºè®¾ç½®éœ€è¦è‡³å°‘å››ä¸ªèŠ‚ç‚¹å’Œé»˜è®¤ CPU æ¥è¿è¡Œä¸€åˆ‡ã€‚å¦‚æœæ”¯æŒçš„è¯ï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨æ›´é«˜çš„`kubernetes-version`,å¦åˆ™åšæŒ 1.15

é›†ç¾¤åˆ›å»ºå¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œæ‰€ä»¥è¯·é«˜æ•æ— å¿§ã€‚ğŸ¹

åˆ›å»ºé›†ç¾¤åï¼Œé€šè¿‡è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä» kubectl è·å–è¦ä½¿ç”¨çš„è¯ä¹¦ã€‚å®ƒä¼šè‡ªåŠ¨å°†å‡­è¯æ³¨å…¥åˆ°æ‚¨çš„ kubectl é…ç½®ä¸­çš„ ***~/ä¸‹ã€‚kube/config***T4ã€‘

```
$ az aks get-credentials \
  --resource-group eCommerceCluster \
  --name eCommerceCluster 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯ä»¥åœ¨ Azure é—¨æˆ·ä¸­æŸ¥çœ‹åˆ›å»ºçš„é›†ç¾¤:

[![Kubernetes cluster in AKS](img/97147958bdedaa3d402bce9478a3c4f0.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--2mUavvWQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/3284/1%2AyfLnHHc_N7VCkEY9vjNciQ.png)*AKS çš„ Kubernetes é›†ç¾¤*

è¿è¡Œ`kubectl get nodes`åœ¨å‘½ä»¤è¡Œä¸­æŸ¥çœ‹å®ƒï¼Œå¹¶éªŒè¯ kubectl å¯ä»¥è¿æ¥åˆ°æ‚¨çš„é›†ç¾¤ã€‚

[![Cluster Nodes](img/52f5f4ccff6d121b99aa7d19a19694b0.png) ](https://res.cloudinary.com/practicaldev/image/fetch/s---t8X-i-v--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/2000/1%2Ak8xsRqQsvnquUhGPAh9TsA.png) *é›†ç¾¤èŠ‚ç‚¹*

è¿›å…¥ **[å®‰è£…å’Œè®¾ç½® Istio](#install-and-setup-istio)** éƒ¨åˆ†ã€‚

### åœ¨ Google Kubernetes å¼•æ“ä¸Šåˆ›å»ºé›†ç¾¤(GKE)

å¦‚æœä½ æ‰“ç®—ä½¿ç”¨è°·æ­Œäº‘å¹³å°(GCP)ï¼Œé‚£ä¹ˆå®‰è£… [**Gcloud CLI**](https://cloud.google.com/sdk/docs/) ä¸ GCP äº’åŠ¨ã€‚å®‰è£…å¹¶ä½¿ç”¨æ‚¨çš„ GCP å¸æˆ·ç™»å½•(å¦‚æœæ‚¨è¿˜æ²¡æœ‰ä¸€ä¸ª[å…è´¹å¸æˆ·](https://console.cloud.google.com/freetrial)ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª)ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è®¾ç½®åœ°åŒºå’ŒåŒºåŸŸï¼Œä¹Ÿå¯ä»¥åœ¨æ‰§è¡Œæ¯ä¸ªå‘½ä»¤æ—¶ä¼ é€’åŒºåŸŸé€‰é¡¹ã€‚

```
$ gcloud config set compute/region europe-west1
$ gcloud config set compute/zone europe-west1-b 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª GCP é¡¹ç›®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç°æœ‰çš„é¡¹ç›®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ GCloud CLI åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œå‘½ä»¤å¦‚ä¸‹:

```
$ gcloud projects create jhipster-demo-deepu 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†æ‚¨æƒ³è¦ä½¿ç”¨çš„é¡¹ç›®è®¾ç½®ä¸ºé»˜è®¤é¡¹ç›®ï¼Œå¹¶å¯ç”¨å®¹å™¨ APIã€‚æ‚¨è¿˜éœ€è¦é€šè¿‡[è°·æ­Œäº‘æ§åˆ¶å°](https://console.cloud.google.com/)
ä¸ºé¡¹ç›®å¯ç”¨è®¡è´¹

```
$ gcloud config set project jhipster-demo-deepu
$ gcloud services enable container.googleapis.com 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬ç”¨ä¸‹é¢çš„å‘½ä»¤ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªé›†ç¾¤:

```
$ gcloud container clusters create hello-hipster \
    --cluster-version latest \
    --num-nodes 4 \
    --machine-type n1-standard-2 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`num-nodes`å’Œ`machine-type`æ ‡å¿—å¾ˆé‡è¦ï¼Œå› ä¸ºè®¾ç½®éœ€è¦è‡³å°‘å››ä¸ªå…·æœ‰æ›´å¤§ CPU çš„èŠ‚ç‚¹æ¥è¿è¡Œä¸€åˆ‡ã€‚å¦‚æœæ”¯æŒçš„è¯å¯ä»¥å°è¯•ä½¿ç”¨æœ€æ–°çš„`cluster-version`ï¼Œå¦åˆ™åšæŒ 1.17ã€‚

é›†ç¾¤åˆ›å»ºå¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œæ‰€ä»¥è¯·é«˜æ•æ— å¿§ã€‚ğŸ¹

åˆ›å»ºé›†ç¾¤åï¼Œé€šè¿‡è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä» kubectl è·å–è¦ä½¿ç”¨çš„è¯ä¹¦ã€‚å®ƒä¼šè‡ªåŠ¨å°†å‡­è¯æ³¨å…¥åˆ°æ‚¨çš„ kubectl é…ç½®ä¸­çš„ ***~/ä¸‹ã€‚kube/config***T4ã€‘

```
$ gcloud container clusters get-credentials hello-hipster 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯ä»¥åœ¨ GCP GUI ä¸­æŸ¥çœ‹åˆ›å»ºçš„é›†ç¾¤ã€‚

[![Kubernetes cluster on GKE](img/94e104ee2d7eae3ae852190a06269f53.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--Q9V7y0Gg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/2000/1%2AZxNbIG4vqWJymTLweJpPyQ.png)*gke*ä¸Šçš„ç«‹æ–¹ç°‡

è¿è¡Œ`kubectl get nodes`åœ¨å‘½ä»¤è¡Œä¸­æŸ¥çœ‹å®ƒï¼Œå¹¶éªŒè¯ kubectl å¯ä»¥è¿æ¥åˆ°æ‚¨çš„é›†ç¾¤ã€‚

[![Cluster Nodes](img/b9ef437a61bad0294573aadb53ad45cf.png) ](https://res.cloudinary.com/practicaldev/image/fetch/s--WJp_00xk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/2000/1%2AF5Qcd_GS_GSuA1PsJE7gvA.png) *é›†ç¾¤èŠ‚ç‚¹*

## å®‰è£…å¹¶è®¾ç½® Istio

æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£… Istio:

```
$ cd ~/

$ export ISTIO_VERSION=1.8.2

$ curl -L https://istio.io/downloadIstio | sh -

$ ln -sf istio-$ISTIO_VERSION istio

$ export PATH=~/istio/bin:$PATH 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨ Istio æä¾›çš„å›¾è¡¨åœ¨æˆ‘ä»¬çš„ Kubernetes é›†ç¾¤ä¸Šå®‰è£… Istioã€‚

```
# Install the Istio CRDs and components from the Demo profile
$ istioctl install --set profile=demo -y

# Install Addons like Grfana, Prometheus, Kiali and Zipkin
$ cd ~/istio
$ kubectl apply -f samples/addons/grafana.yaml
$ kubectl apply -f samples/addons/prometheus.yaml
$ kubectl apply -f samples/addons/kiali.yaml
$ kubectl apply -f samples/addons/extras/zipkin.yaml 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç­‰å¾… pod è¿è¡Œï¼Œå®ƒä»¬å°†è¢«éƒ¨ç½²åˆ°`istio-system`åç§°ç©ºé—´ã€‚

```
$ watch kubectl get pods -n istio-system 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦ pod å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œé€€å‡ºç›‘è§†å¾ªç¯å¹¶è¿è¡Œä¸‹é¢çš„ä»¥è·å–å…¥å£ç½‘å…³æœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ã€‚è¿™æ˜¯å”¯ä¸€å‘å¤–éƒ¨ IP å…¬å¼€çš„æœåŠ¡ã€‚

```
$ kubectl get svc istio-ingressgateway -n istio-system

NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP
istio-ingressgateway   LoadBalancer   10.27.249.83   35.195.81.130 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœ`istio-ingressgateway`æ˜¾ç¤ºå¤–éƒ¨ IP ä¸ºï¼Œç­‰å¾…å‡ åˆ†é’Ÿï¼Œç›´åˆ°åˆ†é…äº† IP åœ°å€ã€‚

å¤–éƒ¨ IP åœ¨è¿™é‡Œéå¸¸é‡è¦ï¼Œè®©æˆ‘ä»¬å°†å®ƒä¿å­˜åˆ°ä¸€ä¸ªç¯å¢ƒå˜é‡ä¸­ï¼Œä»¥ä¾¿åœ¨ä»¥åçš„å‘½ä»¤ä¸­ä½¿ç”¨å®ƒã€‚

```
$ export \
  INGRESS_IP=$(kubectl -n istio-system get svc \
  istio-ingressgateway \
  -o jsonpath='{.status.loadBalancer.ingress[0].ip}') 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œè¿˜éœ€è¦ä¸º Istio åšä¸€ä¸ªé¢å¤–çš„æ­¥éª¤ã€‚è‡ªåŠ¨åˆ›å»ºçš„é˜²ç«å¢™è§„åˆ™ä¸ä¼šæ‰“å¼€ç«¯å£ 15017ã€‚è¿™ä¸ªè¯•ç‚¹å‘ç°éªŒè¯ webhook éœ€è¦è¿™ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ é‚£ä¸ªã€‚é¦–å…ˆï¼Œé€šè¿‡è¿è¡Œä¸‹é¢çš„å‘½ä»¤è·å– Istio ä¸ºé¡¹ç›®æ·»åŠ çš„é˜²ç«å¢™è§„åˆ™ã€‚å¦‚æœä¸æ­¢ä¸€ä¸ªï¼Œéšä¾¿æŒ‘ä¸€ä¸ªã€‚å¦‚æœæ‚¨æ‰¾ä¸åˆ°ä»»ä½•è§„åˆ™ï¼Œè¯·è¿è¡Œä¸å¸¦è¿‡æ»¤å™¨çš„å‘½ä»¤ï¼Œå¹¶åœ¨æè¿°ä¸­æŸ¥æ‰¾å¸¦æœ‰ Istio çš„è§„åˆ™ã€‚

```
$ gcloud compute firewall-rules list --filter="name~k8s-fw-[0-9a-z]*" --format=json 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ›´æ–°è¯¥è§„åˆ™ï¼Œæ·»åŠ æ‰€éœ€çš„ç«¯å£ï¼Œç”¨ä¸Šé¢è·å–çš„è§„åˆ™çš„å®é™…åç§°æ›¿æ¢è¯¥åç§°ï¼Œå¹¶å°†æ‰€æœ‰åŸå§‹ç«¯å£æ·»åŠ åˆ°åˆ—è¡¨

```
gcloud compute firewall-rules update <firewall rule name> --allow tcp:15017,tcp:80,tcp:443,<append all other protocol:port comma separated> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬çš„ Kubernetes é›†ç¾¤å·²ç»ä¸º Istio åšå¥½äº†å‡†å¤‡ã€‚ğŸ‰

*æœ‰å…³é«˜çº§ Istio è®¾ç½®é€‰é¡¹ï¼Œè¯·å‚è€ƒ[https://istio.io/docs/setup/kubernetes/](https://istio.io/docs/setup/kubernetes/)T3ã€‘*

## åˆ›å»ºå¾®æœåŠ¡åº”ç”¨æ ˆ

åœ¨æˆ‘ä¹‹å‰çš„[å¸–å­](https://deepu.tech/create-full-microservice-stack-using-j-hipster-domain-language-under-30-minutes)ä¸­ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ **JHipster** å’Œ **JDL** åˆ›å»ºä¸€ä¸ªå…¨æ ˆå¾®æœåŠ¡æ¶æ„ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šç»†èŠ‚ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»å¸–å­ã€‚åœ¨æœ¬ç»ƒä¹ ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œä½†ä¸ä¼šä½¿ç”¨æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„ Eureka æœåŠ¡å‘ç°é€‰é¡¹ã€‚æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼Œå•†åº—åº”ç”¨ç¨‹åºè¿›ä¸€æ­¥åˆ†ä¸ºç½‘å…³å’Œäº§å“åº”ç”¨ç¨‹åºã€‚

### å»ºç­‘

è¿™æ˜¯æˆ‘ä»¬ä»Šå¤©è¦åˆ›å»ºå’Œéƒ¨ç½²çš„å¾®æœåŠ¡çš„æ¶æ„ã€‚

[![Microservice architecture with Istio](img/f1dcf2812bb5653930e77a753179a749.png) ](https://res.cloudinary.com/practicaldev/image/fetch/s--trpAoWK2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/2162/1%2AUmNJ-Ue362-OltPOxt-OFQ.png) *å¾®æœåŠ¡æ¶æ„ä¸ Istio*

å®ƒæœ‰ä¸€ä¸ªç½‘å…³åº”ç”¨ç¨‹åºå’Œä¸‰ä¸ªå¾®æœåŠ¡åº”ç”¨ç¨‹åºã€‚ä»–ä»¬æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„æ•°æ®åº“ã€‚æ‚¨å¯ä»¥çœ‹åˆ°æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ª Envoy ä»£ç†ä½œä¸º sidecar è¿æ¥åˆ° podã€‚Istio æ§åˆ¶å¹³é¢ç»„ä»¶ä¹Ÿä¸ Prometheusã€Grafana å’Œ Jaeger ä¸€èµ·éƒ¨ç½²åˆ°åŒä¸€ä¸ªé›†ç¾¤ã€‚

Istio çš„å…¥å£ç½‘å…³æ˜¯æµé‡çš„å”¯ä¸€å…¥å£ç‚¹ï¼Œå®ƒç›¸åº”åœ°å°†æµé‡è·¯ç”±åˆ°æ‰€æœ‰å¾®æœåŠ¡ã€‚é¥æµ‹æ˜¯ä»é›†ç¾¤ä¸­è¿è¡Œçš„æ‰€æœ‰å®¹å™¨æ”¶é›†çš„ï¼ŒåŒ…æ‹¬åº”ç”¨ç¨‹åºã€æ•°æ®åº“å’Œ Istio ç»„ä»¶ã€‚

ä¸åŸå§‹åº”ç”¨ç¨‹åº[çš„æ¶æ„ç›¸æ¯”ï¼Œä½ å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æˆ‘ä»¬ç”¨ Istio æ›¿æ¢äº† JHipster æ³¨å†Œè¡¨å’Œç½‘é£ OSS ç»„ä»¶ã€‚éº‹é¹¿ç›‘æ§æ ˆæ¢æˆ Istio é…ç½®çš„æ™®ç½—ç±³ä¿®æ–¯ã€æ ¼æ‹‰æ³•çº³ã€è€¶æ ¼ã€‚è¿™é‡Œæ˜¯æ²¡æœ‰ Istio çš„åŸå§‹æ¶æ„å›¾ï¼Œä»¥ä¾¿è¿›è¡Œå¿«é€Ÿçš„è§†è§‰æ¯”è¾ƒã€‚](https://deepu.tech/create-full-microservice-stack-using-j-hipster-domain-language-under-30-minutes)

[![Microservice architecture with Netflix OSS](img/a8eea3a61fd8421411b19267d89b4e44.png) ](https://res.cloudinary.com/practicaldev/image/fetch/s--J1w3N3rl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/2162/1%2AH-6_dz1-aYXQ-fzWEuJcRw.png) *å¾®æœåŠ¡æ¶æ„æ­é…ç½‘é£ OSS*

### åº”ç”¨ JDL

è®©æˆ‘ä»¬çœ‹çœ‹ä¿®æ”¹åçš„ JDL å®£è¨€ã€‚ä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»åœ¨è¿™é‡Œå£°æ˜äº†`serviceDiscoveryType no`,å› ä¸ºæˆ‘ä»¬å°†ä¸ºæ­¤ä½¿ç”¨ Istioã€‚**