# ä½¿ç”¨è”åˆèº«ä»½ä»¥æœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·èº«ä»½è®¿é—®éå…¬å…± S3 å¯¹è±¡ã€‚

> åŸæ–‡:[https://dev . to/jimatjibba/using-federated-identities-to-access-non-public-S3-objects-as-a-un authenticated-user-4gk 7](https://dev.to/jimatjibba/using-federated-identities-to-access-non-public-s3-objects-as-an-unauthenticated-user-4gk7)

æˆ‘æœ€è¿‘å‚ä¸äº†ä¸€ä¸ªé¡¹ç›®ï¼Œè¿™ä¸ªé¡¹ç›®æœ‰ä¸€äº›æœ‰è¶£çš„éœ€æ±‚ã€‚è¯¥é¡¹ç›®åŒ…æ‹¬ä¸€ä¸ªä¸»è¦çš„åº”ç”¨ç¨‹åºï¼Œå°†ä¸¥é‡ä¾èµ–äºæ”¾å¤§å™¨(æ˜¾ç„¶ğŸ˜ƒ)ï¼Œåˆ©ç”¨ Authã€AppSyncã€Storage ç­‰ç­‰ã€‚æ‰€æœ‰æœåŠ¡å’Œæ•°æ®éƒ½éœ€è¦é”å®šç»™åˆ›å»ºå®ƒä»¬çš„ç”¨æˆ·ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºç®¡ç†å‘˜å¯ä»¥è®¿é—®å®ƒä»¬ã€‚é¡¹ç›®çš„ç¬¬äºŒéƒ¨åˆ†åŒ…æ‹¬æœªçŸ¥æ•°é‡çš„å¤–éƒ¨åº”ç”¨ç¨‹åºã€‚è¿™äº›åº”ç”¨ç¨‹åºå°†ç”±å…¶ä»–å¤–éƒ¨å¼€å‘äººå‘˜ç¼–å†™ï¼Œä¸ä¼šä½¿ç”¨ä¸»åº”ç”¨ç¨‹åºç”Ÿæˆçš„ Amplify æœåŠ¡ã€‚è¿™äº›åº”ç”¨ç¨‹åºéœ€è¦èƒ½å¤Ÿè®¿é—®éå…¬å…± S3 å­˜å‚¨æ¡¶ä¸­çš„ä¸€äº›èµ„äº§ï¼Œå¹¶ä¸”ä¸éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚

è¿™äº›åº”ç”¨ç¨‹åºå°†æ— æ³•åƒä¸»åº”ç”¨ç¨‹åºé‚£æ ·ä¸¥é‡ä¾èµ– Amplifyï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚

æ­£å¦‚ AWS ä¸­çš„æ‰€æœ‰ä¸œè¥¿ä¸€æ ·ï¼Œç»™çŒ«å‰¥çš®çš„æ–¹æ³•ä¸æ­¢ä¸€ç§ã€‚æˆ‘ä»¬ä»ç„¶éœ€è¦ä»¥å®‰å…¨çš„æ–¹å¼è®¿é—®è¿™äº›å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»„åˆèº«ä»½æ± [è”åˆèº«ä»½](https://docs.aws.amazon.com/cognito/latest/developerguide/identity-pools.html)å’Œ AWS Signature Version 4 æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

### [](#federated-identities)è”åˆèº«ä»½

> Amazon Cognito èº«ä»½æ± ä¸ºæ¥å®¾ç”¨æˆ·(æœªç»èº«ä»½éªŒè¯)å’Œå·²é€šè¿‡èº«ä»½éªŒè¯å¹¶æ”¶åˆ°ä»¤ç‰Œçš„ç”¨æˆ·æä¾›ä¸´æ—¶ AWS å‡­æ®ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…è®¸æœªç»è®¤è¯çš„èº«ä»½ï¼Œç™»å½• AWS æ§åˆ¶å°å¹¶é€‰æ‹© Cognitoï¼Œç„¶åé€‰æ‹©ç®¡ç†è”åˆèº«ä»½ã€‚é€‰æ‹©å·²ä¸ºå¤–éƒ¨åº”ç”¨ç¨‹åºåˆ›å»ºçš„èº«ä»½æ± ï¼Œå¹¶å•å‡»å³ä¸Šè§’çš„**ç¼–è¾‘èº«ä»½æ± **ã€‚å‘ä¸‹æ»šåŠ¨å¹¶ç‚¹å‡»**æœªè®¤è¯èº«ä»½**ã€‚é€‰æ‹©å¤é€‰æ¡†å¹¶ä¿å­˜æ‚¨çš„æ›´æ”¹ã€‚AWS ç°åœ¨å°†ä¸ºæ‚¨æä¾›ä¸´æ—¶å‡­æ®ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è®¾ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨èº«ä»½æ± ç”Ÿæˆçš„ä¸´æ—¶å‡­è¯å‘ AWS æœåŠ¡å‘å‡ºæœªç»èº«ä»½éªŒè¯çš„è¯·æ±‚ã€‚

æˆ‘ä»¬ä»ç„¶éœ€è¦ä¸€ç§æ–¹æ³•æ¥åˆ›å»ºè¿™äº›ä¸´æ—¶å‡­æ®ï¼Œä¸ºæ­¤æˆ‘ä»¬å°†ä½¿ç”¨`aws-amplify` npm åŒ…ï¼Œå› ä¸ºå®ƒä½¿åˆ›å»ºå˜å¾—éå¸¸ç®€å•ã€‚æˆ‘ä»¬å°†ä½¿ç”¨`Auth`æ¨¡å—ã€‚æ˜¾ç„¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`aws-sdk`å¹¶ä»é‚£é‡Œä½¿ç”¨ Cognito åŒ…ã€‚å®ƒä»¬å°†å®ç°ç›¸åŒçš„ç›®æ ‡ï¼Œæˆ‘åªæ˜¯ç¢°å·§å–œæ¬¢ amplify äº§å“ã€‚

åœ¨ index.js æ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹:

```
import Amplify, { Auth } from "aws-amplify";

Amplify.configure({
  Auth: {
    identityPoolId: "eu-west-1:****-***********-***",
    region: "eu-west-1"
  }
}); 
```

è¿™æ˜¯ç”Ÿæˆæœªç»èº«ä»½éªŒè¯çš„èº«ä»½çš„èº«ä»½æ± çš„ idã€‚

ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å†…å®¹æ¥è®¿é—®ä¸´æ—¶å‡­è¯

```
const creds = await Auth.currentCredentials(); 
```

### [](#aws4)AWS4

ä½†æ˜¯ï¼Œæˆ‘ä»¬å¦‚ä½•å¤„ç†è¿™äº›æ–°è·å¾—çš„å‡­è¯å‘¢ï¼Ÿè¿™å°±æ˜¯ AWS Signature ç¬¬ 4 ç‰ˆçš„ç”¨æ­¦ä¹‹åœ°ã€‚è¿™å…è®¸æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„è¯·æ±‚è¿›è¡Œç­¾åï¼Œç­¾åè¿‡ç¨‹å‘æŸ¥è¯¢å­—ç¬¦ä¸²æ·»åŠ ä¸€ä¸ªä»¤ç‰Œï¼Œç”¨æˆ‘ä»¬çš„ä¸´æ—¶å‡­è¯å¯¹æˆ‘ä»¬è¿›è¡Œèº«ä»½éªŒè¯ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦è®¿é—® S3 çš„ä¸€ä¸ªå¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å‘é€è¯·æ±‚ä¹‹å‰å¯¹å…¶è¿›è¡Œç­¾åï¼Œè¿™ä½¿å¾— AWS çŸ¥é“è¯·æ±‚æ¥è‡ªæŒæœ‰è¿™äº›æœªç»è®¤è¯çš„å‡­è¯çš„äººï¼Œè€Œä¸æ˜¯äº’è”ç½‘ä¸Šçš„æŸä¸ªéšæœºçš„ chapã€‚ä¸ºäº†ç­¾ç½²æˆ‘ä»¬çš„è¯·æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† [`aws4`](https://www.npmjs.com/package/aws4) åŒ…ã€‚

[![Birds](../Images/614380833c701fc3b52a10963b546d35.png)T2ã€‘](https://i.giphy.com/media/26Ff9P7oFlrqX2epq/giphy.gif)

å®ƒå‡ ä¹å¯ä»¥ä¸æ‰€æœ‰äºšé©¬é€ŠæœåŠ¡å…¼å®¹ï¼ŒåŒ…æ‹¬ S3ã€EC2ã€DynamoDBã€Kinesisã€Lambdaã€SQSã€SNSã€IAMã€STSã€RDSã€CloudWatchã€CloudWatch Logsã€CodeDeployã€CloudFrontã€CloudTrailã€ElastiCacheã€EMRã€Glacierã€CloudSearchã€Elastic Load Balancingã€Elastic Transcoderã€CloudFormationã€Elastic Beanstalkã€Storage Gatewayã€Data Pipelineã€Direct Connectã€Redshiftã€OpsWorksã€SESã€SWFã€AutoScalingã€Mobile Analyticsã€Cognito Identityã€Cognito Syncã€Container Serviceã€AppStreamã€Key Management Serviceã€Config

ä¸ºäº†ç­¾ç½²æˆ‘ä»¬å¯¹ S3 å¯¹è±¡çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°ã€‚è¿™è¿”å›

```
import aws4 from "aws4";
import { Auth } from "aws-amplify";

export default async (src: string) => {
  const credentials = await Auth.currentCredentials();
  const request = {
    host: "s3.eu-west-2.amazonaws.com",
    path: `/${process.env.REACT_APP_S3_BUCKET}/${src}`,
    service: "s3",
    signQuery: true
  };
  const protocol = "https://";
  const signedRequest = aws4.sign(
    request,
    Auth.essentialCredentials(credentials)
  );

  return protocol + signedRequest.host + signedRequest.path;
}; 
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿”å› URL ä»¥å®‰å…¨çš„æ–¹å¼è®¿é—®æˆ‘ä»¬çš„ S3 å¯¹è±¡ã€‚è¯•è¯•çœ‹ï¼

è™½ç„¶æˆ‘çš„æƒ…å†µå¾ˆä¸æ­£å¸¸ï¼Œä½†æˆ‘ç»å¯¹èƒ½çœ‹å‡ºè¿™æœ‰ä»€ä¹ˆç”¨å¤„ã€‚æˆ‘å¸Œæœ›è¿™ä¸ªåˆ†ç±»å¯¹å…¶ä»–éœ€è¦ç­¾ç½²æœªç»è®¤è¯çš„ç”¨æˆ·å¯¹ AWS æœåŠ¡çš„è¯·æ±‚çš„äººæœ‰ç”¨ã€‚