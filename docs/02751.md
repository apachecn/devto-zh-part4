# ç”¨ Immer ç®€åŒ–æ‚¨çš„ Redux å‡é€Ÿå™¨

> åŸæ–‡:[https://dev . to/mercantate/simplify-your-redux-reducers-with-immer-3e 51](https://dev.to/mercatante/simplify-your-redux-reducers-with-immer-3e51)

* * *

*æœ¬å¸–æœ€åˆå‘è¡¨äº[https://stevenmercatante.com](https://stevenmercatante.com/simpify-redux-reducers-with-immer/)T3ã€‘*

* * *

## [](#the-problem)é—®é¢˜

æˆ‘åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨ Reduxï¼Œçœ‹åˆ°æˆ‘çš„ Redux å˜å¾—æœ‰ç‚¹ç²—ç³™ã€‚æ¯å½“æˆ‘éœ€è¦å¤„ç†åµŒå¥—æ•°æ®æ—¶ï¼Œä»£ç ä¼¼ä¹éƒ½ä¼šå‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚è¿™æ˜¯å› ä¸º Redux åšæŒä½¿ç”¨ä¸å¯å˜æ•°æ®ã€‚æˆ‘æ˜¯ä½¿ç”¨ä¸å¯å˜æ•°æ®çš„å¿ å®ç²‰ä¸ï¼Œä½†ç»å¯¹ä¸æ­¢äºæ­¤...ä¸å¯å˜æ•°æ®ç›¸æ¯”ï¼Œå¾ˆéš¾å¤„ç†ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€äº›ä¾‹å­:

```
case ADD_TIMER: {
  return { [action.payload.id]: action.payload, ...state };
} 
```

æˆ‘çŸ¥é“ä½ åœ¨æƒ³ä»€ä¹ˆ...â€œè¿™æ®µä»£ç å¹¶ä¸ç¬¨æ‹™â€”â€”å®ƒåªæ˜¯ä½¿ç”¨ spread æ“ä½œç¬¦å°†ä¸€ä¸ªé¡¹ç›®æ·»åŠ åˆ°ä¸€ä¸ªç°æœ‰çš„å¯¹è±¡ä¸­ã€‚å®¹æ˜“ï¼â€å¥½å§ï¼Œæˆ‘ä»¬ç»§ç»­...

```
case REMOVE_TIMER: {
  const newState = { ...state };
  delete newState[action.payload.id];
  return newState;
} 
```

å¥½çš„ï¼Œè¿™è¿˜ä¸ç®—å¤ªç³Ÿï¼Œä½†æ˜¯æˆ‘æƒ³åšçš„åªæ˜¯ä»ä¸€ä¸ªå¯¹è±¡ä¸­åˆ é™¤ä¸€ä¸ªé¡¹ç›®ã€‚æˆ‘ä¸éœ€è¦åˆ›å»ºç°æœ‰çŠ¶æ€çš„å‰¯æœ¬ï¼Œä»å‰¯æœ¬ä¸­åˆ é™¤é¡¹ç›®ï¼Œç„¶åè¿”å›å‰¯æœ¬ã€‚

```
case INCREMEMT_RUNNING_TIMERS: {
  const updatedTimers = Object.values(state)
    .filter(timer => timer.running)
    .reduce((acc, timer) => {
      timer.totalTime = getTotalTime(true, timer.starts, timer.stops);
      acc[timer.id] = timer;
      return acc;
    }, {});
  return { ...state, ...updatedTimers };
} 
```

ç¥ä½ èƒ½è¯´æœæˆ‘è¿™æ˜¯ä¸å¯èƒ½æ”¹è¿›çš„ã€‚å¦‚æœæ‚¨æƒ³çŸ¥é“ï¼Œæˆ‘æ­£åœ¨éå†å¯¹è±¡ï¼Œåªè¿‡æ»¤æˆ‘æƒ³è¦çš„å¯¹è±¡ï¼Œå°†å®ƒä»¬å‡å°‘åˆ°ä¸€ä¸ªå…·æœ‰ä¸€äº›æ›´æ–°å±æ€§çš„æ–°å¯¹è±¡ä¸­ï¼Œæœ€åå°†å®ƒåˆå¹¶åˆ°è¿”å›çš„çŠ¶æ€ä¸­ã€‚å‘€ã€‚

## [](#the-solution)è§£

[Immer](https://github.com/immerjs/immer) æ¥æ•‘æ´ï¼Immer è®©æ‚¨â€œé€šè¿‡ç®€å•åœ°ä¿®æ”¹å½“å‰æ ‘æ¥åˆ›å»ºä¸‹ä¸€ä¸ªä¸å¯å˜çš„çŠ¶æ€æ ‘ã€‚â€é‚£æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæˆ‘ä»¬æŠŠä¸Šé¢çš„ä»£ç ä¾‹å­è½¬æ¢ä¸€ä¸‹çœ‹çœ‹ã€‚

```
case ADD_TIMER: {
  draft[action.payload.id] = action.payload;
  break;
} 
```

```
case REMOVE_TIMER: {
  delete draft[action.payload.id];
  break;
} 
```

```
case INCREMEMT_RUNNING_TIMERS: {
  Object.values(draft).forEach(timer => {
    if (timer.running) {
      timer.totalTime = getTotalTime(true, timer.starts, timer.stops);
    }
  });
  break;
} 
```

*(ä¸è¦æ‹…å¿ƒé‚£ä¸ª`draft`å˜é‡â€”â€”æˆ‘ä»¬ç¨åä¼šè°ˆåˆ°å®ƒ...)*

çœ‹é‚£ä¸ªï¼ä»£ç æ›´çŸ­ï¼Œæ›´å®¹æ˜“é˜…è¯»ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚ä½†æ˜¯ï¼Œè¿™ä¸æ˜¯æ‰“ç ´äº† Redux å¯¹ä¸å¯å˜æ“ä½œçš„éœ€æ±‚å—ï¼Ÿæ²¡æœ‰ã€‚Immer åœ¨å¹•åæ‰§è¡Œä¸å¯å˜çš„æ“ä½œï¼Œä½†æ˜¯å®ƒè®©æˆ‘ä»¬å¯ä»¥ç¼–å†™å¯å˜çš„æ“ä½œï¼Œ10 æ¬¡ä¸­æœ‰ 9 æ¬¡æ›´å®¹æ˜“æ¨ç†(æ›´ä¸ç”¨è¯´æ›´å¿«åœ°ç¼–å†™)ã€‚è¿™ä¸ªç§˜å¯†å°±æ˜¯ Immer çš„ a `draftState`æ¦‚å¿µã€‚

## [](#the-draft-state)è‰ç¨¿çŠ¶æ€

ä¸å…¶è‡ªå·±è§£é‡Šï¼Œä¸å¦‚è®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ Immer æ˜¯å¦‚ä½•å®šä¹‰`draftState`çš„:

> åŸºæœ¬æ€æƒ³æ˜¯å°†æ‰€æœ‰æ›´æ”¹åº”ç”¨åˆ°ä¸´æ—¶çš„ draftStateï¼Œå®ƒæ˜¯å½“å‰çŠ¶æ€çš„ä»£ç†ã€‚ä¸€æ—¦ä½ æ‰€æœ‰çš„çªå˜éƒ½å®Œæˆäº†ï¼ŒImmer å°†ä¼šåŸºäºè‰ç¨¿çŠ¶æ€çš„çªå˜äº§ç”Ÿä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥é€šè¿‡ç®€å•åœ°ä¿®æ”¹æ•°æ®æ¥ä¸æ•°æ®è¿›è¡Œäº¤äº’ï¼ŒåŒæ—¶ä¿ç•™ä¸å¯å˜æ•°æ®çš„æ‰€æœ‰ä¼˜åŠ¿ã€‚â€

æ‚¨éœ€è¦å‘æ‚¨çš„ç¼©å‡å™¨æ·»åŠ ä¸€ç‚¹ä»£ç ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­:

```
import produce from 'immer'

export default (state = {}, action) =>
  produce(state, draft => {
    switch (action.type) {
      case ADD_TIMER: {
        draft[action.payload.id] = action.payload
        break
      }

      case REMOVE_TIMER: {
        delete draft[action.payload.id]
        break
      }

      case INCREMEMT_RUNNING_TIMERS: {
        Object.values(draft).forEach(timer => {
          if (timer.running) {
            timer.totalTime = getTotalTime(true, timer.starts, timer.stops)
          }
        })
        break
      }

      default:
        return draft
    }
  }) 
```

è¯·ç¡®ä¿æ‚¨æ²¡æœ‰å¿˜è®°å¯¹`produce`çš„å‘¼å«â€”â€”æ²¡æœ‰å®ƒï¼Œæ‚¨çš„å‡é€Ÿå™¨å°†æ— æ³•å·¥ä½œï¼

## [](#wrapping-things-up)æŠŠä¸œè¥¿åŒ…èµ·æ¥

æ¯å½“æˆ‘ä»äº‹ Redux é¡¹ç›®æ—¶ï¼ŒImmer å·²ç»æˆä¸ºæˆ‘çš„é¦–é€‰å·¥å…·ä¹‹ä¸€ã€‚å‘åŒäº‹å’Œè´¡çŒ®è€…è§£é‡Šåªéœ€å¾ˆå°‘çš„æ—¶é—´ï¼Œå¹¶æä¾›ä¸€ç³»åˆ—å¥½å¤„ï¼ŒåŒ…æ‹¬:

*   éœ€è¦ç¼–å†™çš„ä»£ç æ›´å°‘
*   éœ€è¦ç»´æŠ¤çš„ä»£ç æ›´å°‘
*   æ›´å®¹æ˜“ç†è§£çš„ä»£ç 

å¦‚æœä½ éœ€è¦è¿›ä¸€æ­¥çš„è¯´æœï¼Œçœ‹çœ‹ React çš„ä¸€ä¸ªæ ¸å¿ƒç»´æŠ¤è€…æ˜¯æ€ä¹ˆè¯´çš„:

> å¦‚æœä½ å–œæ¬¢ MobXï¼Œæˆ‘å¼ºçƒˆæ¨èè·Ÿéš [@mweststrate](https://twitter.com/mweststrate?ref_src=twsrc%5Etfw) åœ¨ Immer ä¸Šçš„ä½œå“ã€‚è™½ç„¶ MobX ä¸ React çš„æ„¿æ™¯ç›¸å»ç”šè¿œã€‚ä¼Šè«å®Œå…¨æ­£ç¡®ã€‚
> 
> â€” Sebastian MarkbÃ¥ge (@sebmarkbage) [August 23, 2018](https://twitter.com/sebmarkbage/status/1032684851063705600?ref_src=twsrc%5Etfw)

ğŸ‘‹å–œæ¬¢è¿™ç¯‡æ–‡ç« å—ï¼Ÿ

åŠ å…¥æˆ‘çš„[æ—¶äº‹é€šè®¯](https://stevemerc.com/newsletter/?r=dev)å¹¶åœ¨ Twitter[@ mercantate](https://twitter.com/mercatante)ä¸Šå…³æ³¨æˆ‘ä»¥è·å¾—æ›´å¤šç±»ä¼¼çš„å†…å®¹ã€‚