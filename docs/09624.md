# ç°åœ¨æ›´æ–°åˆ° Angular ç‰ˆæœ¬ 8ï¼

> åŸæ–‡:[https://dev.to/angular/update-to-angular-version-8-now-4k8f](https://dev.to/angular/update-to-angular-version-8-now-4k8f)

*æœ¬æ–‡æœ€åˆå‘è¡¨äº[https://juristr.com/blog/2019/06/angular-v8](https://juristr.com/blog/2019/06/angular-v8)ã€‚å‰å¾€[juristr.com/blog](https://juristr.com/blog)äº†è§£æ›´å¤šå†…å®¹*

* * *

è®©æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹åˆšåˆšå‘å¸ƒçš„æœ€æ–° Angular ç‰ˆæœ¬ 8ã€‚æˆ‘ä»¬å°†å¿«é€Ÿæ¢ç´¢æ–°åŠŸèƒ½ã€ä¸ºä»€ä¹ˆæ‚¨åº”è¯¥æ›´æ–°ã€å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ä»¥åŠæ‚¨åº”è¯¥æ³¨æ„ä»€ä¹ˆã€‚

åœ¨æ‚¨å¼€å§‹ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€ä¸ªå…³äº Angular å›¢é˜Ÿå‘å¸ƒçš„å®˜æ–¹å¸–å­:

> æŸ¥çœ‹æˆ‘å…³äºâ€œ[æ‡’æƒ°è´Ÿè½½è§’åˆ†é‡](https://juristr.com/blog/2019/04/state-lazy-loading-components-angular/)â€çš„ç›¸å…³å¸–å­

åœ¨å‡çº§è¿‡ç¨‹ä¸­ï¼Œæ‚¨å°†æ”¶åˆ°ä¸€ä¸ªé€šçŸ¥ï¼Œå…¶ä¸­åŒ…å«æ›´å¤šè¯¦ç»†ä¿¡æ¯çš„é“¾æ¥ã€‚
[![](../Images/0b651866f22c984dec6771b9cf1c76b6.png)T3ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--QORkfGa1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://juristr.com/blog/assets/imgs/querymigration.png)

ä½ å¯ä»¥åœ¨ https://angular.io/guide/static-query-migration é˜…è¯»æ‰€æœ‰çš„ç»†èŠ‚ã€‚

å¦‚æœ Angular CLI æ— æ³•è‡ªåŠ¨æ¨æ–­æ˜¯ä½¿ç”¨é™æ€åˆ†è¾¨ç‡è¿˜æ˜¯åŠ¨æ€åˆ†è¾¨ç‡ï¼Œå®ƒä¼šåœ¨æ§åˆ¶å°ä¸Šæ·»åŠ ç›¸åº”çš„æ³¨é‡Šå’Œè­¦å‘Š

[![](../Images/71e81d68e22fdfee475ac9498fdbceba.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Hf0JoXnb--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://juristr.com/blog/assets/imgs/querymigration-manualwork.png)

**æ€»ç»“ä¸€ä¸‹ï¼Œè¿™æ˜¯å…³äºä»€ä¹ˆçš„ï¼Ÿ**

å‡è®¾æ‚¨æœ‰ä»¥ä¸‹å†…å®¹:

```
<div foo></div> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä½ çš„ä»£ç ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª`@ViewChild`ï¼Œæ¯”å¦‚

```
@ViewChild(Foo) foo: Foo; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*(å…¶ä¸­`Foo`æ˜¯ä¸€äº›è§’åº¦æŒ‡ä»¤)*

é€šå¸¸å‡è®¾`foo`å°†åœ¨`ngAfterViewInit`ä¹‹åå¡«å……æ˜¯å®‰å…¨çš„(æˆ–è€…å¯¹äºå¸¦æœ‰`@ContentChild`çš„å†…å®¹æŸ¥è¯¢ï¼Œåœ¨`ngAfterContentInit`ä¹‹åå¡«å……)ã€‚ç„¶è€Œï¼Œå…¶ä¸­ä¸€äº›ä¹Ÿå·²ç»å¯ä»¥åœ¨`onInit`ç›´æ¥è®¿é—®ã€‚åŸå› æ˜¯ç¼–è¯‘å™¨åœ¨å¹•åå°†å®ƒä»¬åˆ†ç±»

*   **é™æ€æŸ¥è¯¢**ç«‹å³å¯ç”¨
*   **åŠ¨æ€æŸ¥è¯¢**ä»…åœ¨è¿è¡Œæ—¶å¯ç”¨

æˆ‘ä»¬ä¸Šé¢çš„ä»£ç ç¤ºä¾‹æ˜¯ä¸€ä¸ª**é™æ€æŸ¥è¯¢**çš„ç¤ºä¾‹ï¼Œå› ä¸º`<div foo>`å®ƒæ˜¯ç«‹å³å¯ç”¨çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨`ngOnInit`ä¸­å®‰å…¨åœ°è®¿é—®å®ƒã€‚å¦ä¸€æ–¹é¢ï¼Œå‡è®¾æˆ‘ä»¬åƒ
ä¸€æ ·ä¿®æ”¹ä»£ç 

```
<div foo *ngIf="isVisible"></div> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåªæœ‰åœ¨`isVisible`è¯„ä¼°ä¸ºçœŸæ—¶æ‰å¯ç”¨ï¼Œè¿™å¯èƒ½åœ¨æ‰§è¡Œåº”ç”¨ç¨‹åºçš„ä»»ä½•æ—¶å€™å‘ç”Ÿã€‚è¿™æ ·çš„æŸ¥è¯¢æ˜¯**åŠ¨æ€æŸ¥è¯¢**ã€‚

ä¸»è¦é—®é¢˜æ˜¯è¿™å¹¶ä¸æ˜ç¡®ã€‚å› æ­¤ï¼Œå½“å‡çº§åˆ° v8 æ—¶ï¼Œä»£ç è¿ç§»ä¼šè‡ªåŠ¨å°†æ‚¨çš„ä»£ç è½¬æ¢ä¸º

```
// query results available in ngOnInit
@ViewChild('foo', {static: true}) foo: ElementRef; 

// query results available in ngAfterViewInit
@ViewChild('foo', {static: false}) foo: ElementRef; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#typescript-upgrade)æ‰“å­—ç¨¿å‡çº§

é€šè¿‡å‡çº§åˆ° Angular 8ï¼Œæ‚¨ä¹Ÿå°†å‡çº§åˆ° TypeScript 3.4ã€‚å¦‚æœä½ å¯¹æ–°ç‰¹æ€§[æ„Ÿå…´è¶£ï¼Œè¿™é‡Œæœ‰ç›¸åº”çš„æ–‡æ¡£](https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-4.html)ã€‚

å› æ­¤ï¼Œå‡çº§å(å³ä½¿æˆåŠŸå®Œæˆ)ï¼Œæ‚¨å¯èƒ½ä¼šå¾—åˆ°é”™è¯¯ã€‚å¾ˆå¯èƒ½æ˜¯å› ä¸ºæ›´å¥½çš„ç±»å‹æ¨æ–­æ­ç¤ºäº†æ–°çš„æ½œåœ¨ç±»å‹é—®é¢˜ã€‚

## [](#other-deprecations)å…¶ä»–æŠ˜æ—§

åœ¨å®˜æ–¹ç½‘ç«™ä¸ŠæŸ¥çœ‹[æ–°çš„å¼ƒç”¨æŒ‡å—](https://angular.io/guide/deprecations)ã€‚è¿˜æœ‰é—®é¢˜å—ï¼Ÿåœ¨ [Angular CLI èµ„æºåº“](https://github.com/angular/angular-cli)ä¸­æ‰“å¼€ä¸€ä¸ªä¸å‡çº§ç›¸å…³çš„é—®é¢˜ï¼Œæˆ–è€…åœ¨ [Angular èµ„æºåº“](https://github.com/angular/angular)ä¸­æ‰“å¼€ä¸€ä¸ªä¸æ¡†æ¶ç›¸å…³çš„é—®é¢˜ã€‚æˆ–è€…å¹²è„†åœ¨ Twitter ä¸Šç»™æˆ‘å‘çŸ­ä¿¡[ğŸ˜ƒ](https://twitter.com/juristr)

## [](#faq-potential-upgrade-issues)å¸¸è§é—®é¢˜-æ½œåœ¨çš„å‡çº§é—®é¢˜

### [](#rerun-migrations)é‡æ–°è¿è¡Œè¿ç§»

å¦‚æœæ‚¨è¿›è¡Œäº†è§’åº¦å‡çº§ï¼Œä½†æ˜¯ç”±äºæŸç§åŸå› ï¼Œä¸€äº›ä»£ç è½¬æ¢æ²¡æœ‰æˆåŠŸå®Œæˆï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿæœ€ç»ˆï¼ŒAngular 8(æˆ–è€…ä½ æ­£åœ¨å‡çº§çš„ä»»ä½•ç‰ˆæœ¬)å·²ç»åœ¨ node_modules æ–‡ä»¶å¤¹å’Œ`package.json`ä¸­äº†ã€‚

æ€»çš„æ¥è¯´ï¼Œæˆ‘çš„å»ºè®®æ˜¯ç”¨ Gitã€‚åˆ›å»ºä¸€ä¸ªè¿ç§»åˆ†æ”¯ï¼Œè¿™å…è®¸æ‚¨åœ¨å‡çº§è¿‡ç¨‹ä¸­è½»æ¾åœ°æ¥å›ç§»åŠ¨ã€‚åœ¨æ¯ä¸€æ­¥ä¹‹åæäº¤ï¼Œè¿™æ ·ä½ å°±æœ‰äº†å¤‡ä»½ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒAngular CLI è¿˜å…è®¸æ‚¨å†æ¬¡è¿è¡Œè¿ç§»ï¼Œå³ä½¿æ‚¨çš„`package.json`ä¸­å·²ç»æœ‰äº†æœ€æ–°ç‰ˆæœ¬ã€‚åªéœ€æ‰§è¡Œ

```
// re-run CLI schematics
$ ng update @angular/cli --from 7 --to 8 --migrate-only

// re-run Angular core schematics
$ ng update @angular/core --from 7 --to 8 --migrate-only 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#material-upgrade-fatal-error-ineffective-markcompacts-near-heap-limit-allocation-failed-javascript-heap-out-of-memory)ææ–™å‡çº§:è‡´å‘½é”™è¯¯:æ— æ•ˆæ ‡è®°-å‹ç¼©æ¥è¿‘å †é™åˆ¶åˆ†é…å¤±è´¥- JavaScript å †å†…å­˜ä¸è¶³

å½“æˆ‘åœ¨æˆ‘ä»¬ç›¸å½“å¤§çš„ monorepo ä¸Šç”¨`ng update @angular/material`å‡çº§ Angular material æ—¶ï¼Œæˆ‘å¾—åˆ°äº†ä»¥ä¸‹å¼‚å¸¸ã€‚

```
<--- Last few GCs --->

[85884:0x103802200]   712051 ms: Scavenge 2004.6 (2047.9) -> 2004.5 (2047.9) MB, 4.1 / 0.0 ms  (average mu = 0.199, current mu = 0.181) allocation failure
[85884:0x103802200]   712072 ms: Scavenge 2006.3 (2048.9) -> 2004.6 (2048.4) MB, 3.8 / 0.0 ms  (average mu = 0.199, current mu = 0.181) allocation failure
[85884:0x103802200]   712077 ms: Scavenge 2005.6 (2049.4) -> 2005.6 (2049.9) MB, 4.3 / 0.0 ms  (average mu = 0.199, current mu = 0.181) allocation failure

<--- JS stacktrace --->

==== JS stack trace =========================================

    0: ExitFrame [pc: 0x100e146e6]
Security context: 0x08b76239a2f1 <JSObject>
    1: stringSlice(aka stringSlice) [0x8b725f97839] [buffer.js:~568] [pc=0x1d077761a16a](this=0x08b76f0804d1 <undefined>,0x08b765580f19 <Uint8Array map = 0x8b742025759>,0x08b786894e49 <String[#4]: utf8>,0,1073870)
    2: toString [0x8b7623f02f9] [buffer.js:~622] [pc=0x1d0777ee3789](this=0x08b765580f19 <Uint8Array map = 0x8b742025759>,0x08b786894e49 <String[#4]:...

FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory
 1: 0x100075bd5 node::Abort() [/Users/jstrumpflohner/.nvm/versions/node/v12.4.0/bin/node]
 2: 0x100076316 node::errors::TryCatchScope::~TryCatchScope() [/Users/jstrumpflohner/.nvm/versions/node/v12.4.0/bin/node]
 3: 0x1001697d7 v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [/Users/jstrumpflohner/.nvm/versions/node/v12.4.0/bin/node]
 4: 0x10016976c v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [/Users/jstrumpflohner/.nvm/versions/node/v12.4.0/bin/node]
 5: 0x1005480d5 v8::internal::Heap::FatalProcessOutOfMemory(char const*) [/Users/jstrumpflohner/.nvm/versions/node/v12.4.0/bin/node]
 6: 0x1005491c3 v8::internal::Heap::CheckIneffectiveMarkCompact(unsigned long, double) [/Users/jstrumpflohner/.nvm/versions/node/v12.4.0/bin/node]
 7: 0x100546bc3 v8::internal::Heap::PerformGarbageCollection(v8::internal::GarbageCollector, v8::GCCallbackFlags) [/Users/jstrumpflohner/.nvm/versions/node/v12.4.0/bin/node]
 8: 0x10054487f v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [/Users/jstrumpflohner/.nvm/versions/node/v12.4.0/bin/node]
 ...
[1]    85884 abort      ng update @angular/material @angular/cdk @angular/cdk-experimental 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“èŠ‚ç‚¹è¿›ç¨‹éœ€è¦æ›´å¤šå†…å­˜æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§é—®é¢˜ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°†`max_old_space_size`é€‰é¡¹ä¼ é€’ç»™èŠ‚ç‚¹æµç¨‹ï¼Œå°±åƒè¿™æ ·:

```
$ node --max_old_space_size=8000 ./node_modules/.bin/ng update @angular/material @angular/cdk 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#ngrx-type-observable-is-not-assignable-to-type-observable)Ngrx:ç±»å‹â€œObservableâ€ä¸èƒ½èµ‹ç»™ç±»å‹â€œObservableâ€

å½“æˆ‘æŠŠåŸºäº NX çš„ monorepo ä» v7 å‡çº§åˆ° v8 æ—¶ï¼Œæˆ‘é‡åˆ°çš„å¦ä¸€ä¸ªå¥‡æ€ªçš„é”™è¯¯å¦‚ä¸‹:

```
ERROR in libs/r3-core/src/lib/+state/app-config/app-config.effects.ts(22,5): error TS2322: Type '(action: LoadAppConfig, state: AppConfigPartialState) => Observable<AppConfigLoaded>' is not assignable to type '(a: LoadAppConfig, state?: AppConfigPartialState) => void | Action | Observable<Action>'.
  Type 'Observable<AppConfigLoaded>' is not assignable to type 'void | Action | Observable<Action>'.
    Type 'Observable<AppConfigLoaded>' is not assignable to type 'Observable<Action>'.
      Types of property 'source' are incompatible.
        Type 'import("/Users/jstrumpflohner/myapp/node_modules/rxjs/internal/Observable").Observable<any>' is not assignable to type 'import("/Users/jstrumpflohner/myapp/node_modules/@nrwl/angular/node_modules/rxjs/internal/Observable").Observable<any>'.
          Types of property 'operator' are incompatible.
            Type 'import("/Users/jstrumpflohner/myapp/node_modules/rxjs/internal/Operator").Operator<any, any>' is not assignable to type 'import("/Users/jstrumpflohner/myapp/node_modules/@nrwl/angular/node_modules/rxjs/internal/Operator").Operator<any, any>'.
              Types of property 'call' are incompatible.
                Type '(subscriber: import("/Users/jstrumpflohner/myapp/node_modules/rxjs/internal/Subscriber").Subscriber<any>, source: any) => import("/Users/jstrumpflohner/myapp/node_modules/rxjs/internal/types").TeardownLogic' is not assignable to type '(subscriber: import("/Users/jstrumpflohner/myapp/node_modules/@nrwl/angular/node_modules/rxjs/internal/Subscriber").Subscriber<any>, source: any) => import("/Users/jstrumpflohner/myapp/node_modules/@nrwl/angular/node_modules/rxjs/internal/types").TeardownLogic'.
                  Types of parameters 'subscriber' and 'subscriber' are incompatible.
                    Property '_parentOrParents' is missing in type 'Subscriber<any>' but required in type 'Subscriber<any>'. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¼¼ä¹æ˜¯ç”±äº RxJS å’Œ Ngrx v7 åœ¨æŸä¸ªç‰ˆæœ¬ä¸­ä¸å…¼å®¹ã€‚å‡çº§åˆ° Ngrx v8 å¯èƒ½ä¼šè§£å†³è¿™ä¸ªé—®é¢˜(è™½ç„¶æˆ‘æ²¡æœ‰å°è¯•)ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œå°† RxJS é™çº§åˆ°`~6.4.0`æœ‰æ‰€å¸®åŠ©ã€‚

```
$ yarn add rxjs@~6.4.0 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…

```
$ npm i rxjs@~6.4.0 --save 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>