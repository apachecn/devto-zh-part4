# ä½¿ç”¨ Make + Docker è¿›è¡Œå¯å†ç°çš„æ•°æ®å¤„ç†

> åŸæ–‡ï¼š<https://dev.to/aagnone3/reproducible-data-processing-with-make-docker-4a28>

### *ç”¨ä¾èµ–ç®¡ç†å’Œå®¹å™¨åŒ–é¿å…å†ç°æ€§åœ°ç‹±*

## åŠ¨æœº

åœ¨æ•°æ®ç§‘å­¦å’Œæœºå™¨å­¦ä¹ ä¸­è¿›è¡Œå®éªŒæ—¶ï¼Œæœ€åˆè¿›å±•çš„ä¸¤ä¸ªä¸»è¦éšœç¢æ˜¯æ„å»º/ä½¿ç”¨â€œåŸºç¡€ä»£ç â€çš„å»¶è¿Ÿå’Œç¼ºä¹å¯é‡å¤æ€§ã€‚å¤šäºäº†ä¸€äº›ä¼Ÿå¤§çš„å¼€æºå·¥å…·ï¼Œä½ ä¸å¿…æˆä¸ºè½¯ä»¶å¤§å¸ˆä¹Ÿèƒ½ç»•è¿‡è¿™äº›éšœç¢ï¼Œä»¥æ›´åŠ é¡ºç•…çš„è¿‡ç¨‹ä»æ•°æ®ä¸­è·å–æ„ä¹‰ã€‚

â€œå˜¿ï¼Œæˆ‘åœ¨è¿è¡Œä½ çš„ä»£ç æ—¶é‡åˆ°äº†è¿™ä¸ªé”™è¯¯â€¦â€¦ä½ èƒ½å¸®æˆ‘å—ï¼Ÿâ€

<figure>[![](img/8a6f37cd8ac4104930b0bbdbd8f7ee3b.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--dWkT3cpK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://anthonyagnone.com/wp-content/uploads/2019/05/Screen-Shot-2019-05-18-at-6.37.49-PM-1024x254.png) 

<figcaption>å“¦å¯¹äº†ï¼Œé‚£ä¸ªæ–‡ä»¶â€¦â€¦</figcaption>

</figure>

â€¦è¿™æ˜¯å€¼å¾—åœ¨ facepalm ä¸Šä½¿ç”¨çš„ä¸œè¥¿ã€‚ä½ åœ¨è¿™é‡Œï¼Œè¯•å›¾ä¸æœ‹å‹æˆ–åŒäº‹ä¸€èµ·æ‰¾åˆ°ä¸€ä¸ªæœ‰è¶£çš„æƒ³æ³•ï¼Œè€Œä½ ç°åœ¨æ­£åœ¨è°ƒè¯•ä¸€ä¸ªæ–‡ä»¶æœªæ‰¾åˆ°çš„é”™è¯¯ã€‚æ¬¢è¿å›åˆ°ç¼–ç¨‹å…¥é—¨è¯¾ç¨‹ï¼

æˆ‘æ•¢è‚¯å®šï¼Œä»£ç çš„æ‰€æœ‰è€…ä¹Ÿæœ€å–œæ¬¢èŠ±å¤§é‡æ—¶é—´å¸®åŠ©åˆ«äººä»¥èœ—ç‰›çš„é€Ÿåº¦è§£å†³è¿™äº›é—®é¢˜ã€‚ä½ ä»¬ä¸¤ä¸ªåˆšåˆšå¯¹æœ€è¿‘çš„å®éªŒç»“æœçš„æ‰¿è¯ºæ‰€åˆ†äº«çš„çº¯ç²¹çš„å–œæ‚¦ç°åœ¨å·²ç»å˜æˆäº†æ— è¨€çš„å°´å°¬å’Œæ²®ä¸§ï¼Œå› ä¸ºæ¼”ç¤ºåœ¨æ˜¾ç¤ºå‡ºä»»ä½•ä»·å€¼ä¹‹å‰å°±å¤±è´¥äº†ã€‚

[![](img/29102fe358305b00599e01cce7750f04.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--otEDM--l--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://anthonyagnone.com/wp-content/uploads/2019/07/over.jpg)

ä½†æ˜¯æ²¡å…³ç³»ã€‚æŒºå¥½çš„ï¼ä½ çš„æœ‹å‹çŸ¥é“åœ¨å“ªé‡Œèƒ½æ‰¾åˆ°ä¸¢å¤±çš„æ–‡ä»¶ã€‚ä½ è¢«å‘ŠçŸ¥å‡ åˆ†é’Ÿä¹‹å†…å°±èƒ½æ‹¿åˆ°ï¼Œç„¶åä½ å°±å¯ä»¥ä¸Šè·¯äº†ï¼

â€œå¥½å§ï¼Œä¸‹è½½é‚£ä¸ªæ–‡ä»¶â€”â€”æˆ‘å·²ç»ç”¨ç”µå­é‚®ä»¶å‘ç»™ä½ äº†ã€‚ç„¶åè¿è¡Œ train.pyï¼Œä½ åº”è¯¥åœ¨ 20 ä¸ªå†å…ƒå†…å¾—åˆ° 98%çš„å‡†ç¡®ç‡ã€‚â€

å•Šå“ˆï¼å°±æ˜¯è¿™ä¸ªï¼æ˜¯æ—¶å€™åŠ å…¥å—äººå°Šæ•¬çš„æ•°æ®é­”æœ¯å¸ˆçš„è¡Œåˆ—äº†ï¼Œé“¸é€ ä¸€ä¸ªåˆä¸€ä¸ªé”®ç›˜å’’è¯­ï¼Œçœ‹ç€ä½ çš„æ•°æ®å®å®çš„å¤§è„‘è¶Šæ¥è¶Šå…ˆè¿›ï¼Œå› ä¸ºå®ƒåœ¨å¬å”¤ä¸€ä¸ªæ–°çš„ç»ˆç»“è€…ç”µå½±ä¸­çš„è§’è‰²ï¼è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬å¾—åˆ°äº†ä»€ä¹ˆï¼

<figure>[![](img/7adcd285e7bd2d552041035c4728db96.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--V5Zk81mM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://anthonyagnone.com/wp-content/uploads/2019/05/Screen-Shot-2019-05-18-at-6.46.42-PM.png) 

<figcaption>ä½†æ˜¯æˆ‘ç…§ä½ è¯´çš„åšäº†ğŸ™</figcaption>

</figure>

â€¦æ˜¯çš„ï¼Œæˆ‘ä»¬éƒ½ç»å†è¿‡ã€‚

ä¼šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå—¯ï¼Œä¹Ÿè®¸æ˜¯æ˜¾è€Œæ˜“è§çš„äº‹ã€‚æˆ‘äº†è§£ pythonï¼Œæˆ‘çŸ¥é“ä½ çš„ä»£ç åº”è¯¥åšä»€ä¹ˆã€‚æˆ‘ä¼šæ‰“å¼€ä½ çš„`train.py`å››å¤„çœ‹çœ‹â€¦â€¦ä¸ã€‚

[![](img/c68bc4ba26705708e235632364ef67ee.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--TlNQaCec--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://i.chzbgr.com/full/6157943808/h9C44E570/)

ä¸è¦æ‹…å¿ƒï¼Œè¿™ä¸ä¼šæ˜¯ä¸€ç¯‡å…³äºå¦‚ä½•æ€»æ˜¯å†™ä¸€ä¸ªè½¯ä»¶æ°ä½œå¹¶å˜²ç¬‘ä»»ä½•ä½ è®¤ä¸ºä¸æœä»çš„ä¸œè¥¿çš„æŒ¥èˆç€å°æ‰‹æŒ‡çš„æ–‡ç« ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼Œå› ä¸ºå®ƒå¸¦æœ‰ä¸»è§‚æ€§å’Œç«äº‰æ€§æ ‡å‡†ã€‚è¿™äº›ä¾‹å­æ—¨åœ¨å¼ºè°ƒæœ‰æ— æ•°ç§æˆ‘ä»¬ä¸å–œæ¬¢çš„æ–¹å¼æ¥å¼€å§‹æ–°çš„å®éªŒã€‚

æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ˜¯*ä»¥ä¸€ç§*ä¾¿åˆ©çš„*æ–¹å¼é‡ç°*å’Œ*æ”¹è¿›*ç»“æœï¼Œè€Œä¸æ˜¯è·Œè·Œæ’æ’åœ°é‡ç°è¿‡å»çš„æˆå°±ã€‚è®°ä½è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸€äº›æµè¡Œçš„å·¥å…·ï¼Œå®ƒä»¬å¯ä»¥ç”¨æ¥ç®€åŒ–ä»»ä½•æ–°çš„ ML è½¯ä»¶é¡¹ç›®çš„å¼€å§‹: [Docker](https://www.docker.com/) å’Œ [Make](https://www.gnu.org/software/make/) ã€‚

## ç å¤´å·¥äºº

python ç”Ÿæ€ç³»ç»Ÿåœ¨å¤„ç†ä¾èµ–æ€§æ–¹é¢æœ‰ä¸€äº›å¾ˆæ£’çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ [pip](https://realpython.com/what-is-pip/) å’Œ [virtualenv](https://docs.python-guide.org/dev/virtualenvs/) ã€‚è¿™äº›å·¥å…·å…è®¸ç”¨æˆ·æ ¹æ®éœ€è¦å®‰è£…çš„ä¸€äº›è§„èŒƒè½»æ¾åœ°å¯åŠ¨å’Œè¿è¡Œï¼Œä»¥ç»§ç»­è¿è¡Œä¸€äº›ä»£ç ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾ä½ åˆšåˆšé‡åˆ°äº† [scikit-learn](https://scikit-learn.org) åº“(å½“ç„¶æ˜¯ä¸€è§é’Ÿæƒ…)ã€‚ä½ å¯¹å®ƒçš„ä¸€ä¸ªæ¼”ç¤ºç¤ºä¾‹ç‰¹åˆ«æ„Ÿå…´è¶£ï¼Œä½†æ˜¯ä½ æƒ³ç”¨[ç†ŠçŒ«](https://pandas.pydata.org/)æ•°æ®æ¡†æ¶ä¸­çš„æ•°æ®é‡æ–°åˆ¶ä½œå®ƒã€‚æ­¤å¤–ï¼Œæ‚¨æ­£åœ¨è¿›è¡Œçš„å¦ä¸€ä¸ªé¡¹ç›®éœ€è¦ä¸€ä¸ªæ—§ç‰ˆæœ¬çš„ pandasï¼Œä½†æ˜¯æ‚¨æƒ³ä½¿ç”¨ä»…åœ¨æ–°ç‰ˆæœ¬ä¸­å¯ç”¨çš„ç‰¹æ€§ã€‚æœ‰äº† pip å’Œ virtualenvï¼Œä½ å°±æ²¡æœ‰ä»€ä¹ˆå¯å®³æ€•çš„äº†(â€¦â€¦é™¤äº†å®³æ€•æœ¬èº«)ã€‚

```
# create and activate environment
virtualenv pandas_like_ml
source pandas_like_ml/bin/activate

# install your desired libraries
pip install --upgrade pip
pip install scikit-learn==0.21.1
pip install pandas==0.19.1

# the main event
python eigenfaces.py -n 20000

# we're done here, so exit the environment
source deactivate 
```

å½“ä½ ç¬¬ä¸€æ¬¡å­¦ä¹ è¿™ä¸ªæµç¨‹æ—¶ï¼Œä½ ä¼šæ„Ÿè§‰ä»ä¾èµ–ç®¡ç†è¿™ç§åœ°ç‹±èˆ¬çš„å­˜åœ¨ä¸­è§£è„±å‡ºæ¥ã€‚æ‚¨èƒœåˆ©åœ°å®£å¸ƒï¼Œæ‚¨å°†æ°¸è¿œä¸ä¼šå†è¢«ä¸¢å¤±çš„è½¯ä»¶åŒ…æˆ–è‡ƒè‚¿çš„æ•´ä½“ç³»ç»Ÿç¯å¢ƒæ‰€å¾æœã€‚ç„¶è€Œï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™å¹¶ä¸æ€»æ˜¯è¶³å¤Ÿçš„â€¦

> å½“ä¾èµ–æ€§ä¸åœ¨è¯­è¨€çº§åˆ«ï¼Œè€Œæ˜¯åœ¨ç³»ç»Ÿçº§åˆ«æ—¶ï¼ŒPython ç¯å¢ƒå·¥å…·å°±æœ‰æ‰€æ¬ ç¼ºã€‚

ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³ç”¨ä¸€ä¸ª [MongoDB](https://www.mongodb.com/) æ•°æ®åº“åå°å»ºç«‹ä½ çš„æœºå™¨å­¦ä¹ é¡¹ç›®ã€‚æ²¡é—®é¢˜ï¼ç„¶åæˆ‘ä»¬å°±è‡ªç”±äº†ï¼æ²¡é‚£ä¹ˆå¿«â€¦

[![](img/33e7660d15b4acea161b816c447e9ba0.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--LUn7ArRO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://anthonyagnone.com/wp-content/uploads/2019/05/Screen-Shot-2019-05-18-at-7.16.23-PM-1-1024x329.png)

å—¯â€¦â€¦è¿™å¹¶ä¸åƒé¢„æœŸçš„é‚£æ ·ã€‚ç°åœ¨ï¼Œé™¤äº†è®¾ç½®æˆ‘çš„åº“ä¾èµ–é¡¹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç®¡ç† python ä¹‹å¤–çš„åº“ï¼Ÿå•Šï¼è¿›ä¸€æ­¥å»¶è¯¯ï¼è¯¥è°·æ­Œä¸€ä¸‹ mongoDB çš„åŒ…åäº†â€¦

å¦‚æœæˆ‘è¿åŒäº‹ç”¨çš„æ˜¯ä»€ä¹ˆæ“ä½œç³»ç»Ÿéƒ½ä¸çŸ¥é“æ€ä¹ˆåŠï¼Ÿå¦‚æœä»–åœ¨ CentOS ä¸Šï¼Œæˆ‘ä¸èƒ½ç»™ä»–ä¸€äº›ç‰‡æ®µã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå¯¹äºæœªæ¥çš„é¡¹ç›®æ¥è¯´ï¼Œæ²¡æœ‰ç®€å•çš„æ–¹æ³•è®©*è‡ªåŠ¨åŒ–*è¿™ä¸ªæ­¥éª¤ã€‚è®©æˆ‘åšä¸€æ¬¡ï¼Œæˆ‘ä¼šåšçš„ã€‚è®©æˆ‘å†åšä¸€æ¬¡â€¦zzzzã€‚

å› æ­¤ï¼Œæˆ‘ä»¬é¢ä¸´ç€ä¸ºæ–°çš„æ•°æ®ç›¸å…³å·¥ä½œå»ºç«‹è½¯ä»¶åº“å’Œå…¶ä»–ç³»ç»Ÿä¾èµ–çš„æ ‡å‡†åŒ–å’Œè‡ªåŠ¨åŒ–çš„æ„¿æœ›ï¼Œé—æ†¾çš„æ˜¯ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ python å·¥å…·å·²ç»ä¸å¤Ÿç”¨äº†ã€‚è¾“å…¥ Docker:ä¸€ä¸ªç”¨äºåœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡ŒæœåŠ¡çš„å¼•æ“ï¼Œä½œä¸ºè½»é‡çº§è™šæ‹ŸåŒ–åŒ…ï¼Œç§°ä¸º*å®¹å™¨*ã€‚Docker å®¹å™¨æ˜¯ Docker *å›¾åƒ*å®šä¹‰çš„å®ç°ï¼Œå®ƒç”±ä¸€ä¸ªåä¸º`Dockerfile`çš„æ–‡ä»¶æŒ‡å®šã€‚

```
# you can specify a base image as a foundation to build on
FROM ubuntu:16.04

# make a partition, and specify the working directory
VOLUME /opt
WORKDIR /opt

# install some base system packages
RUN apt-get update && apt-get install -y \
    python3 \
    python3-dev \
    python3-pip \
    python3-setuptools

# install some python packages
RUN pip3 install --upgrade pip
RUN pip3 install \
    scikit-learn==0.21.1 \
    pandas==0.19.1

# set the container's entry point, just a bash shell for now.
# this can also be a single program to run, i.e. a python script.
ENTRYPOINT ["/bin/bash"] 
```

å¯ä»¥æŠŠ order æ–‡ä»¶æƒ³è±¡æˆä¸€ä¸ª(è¯¦ç»†çš„)è®¾ç½®æ­¥éª¤çš„å¤„æ–¹ï¼Œæˆ‘ä»¬éœ€è¦è¿™æ ·åšï¼Œä»¥ä¾¿è®©ç³»ç»Ÿå¤„äºæˆ‘ä»¬æƒ³è¦çš„å®éªŒçŠ¶æ€ã€‚ä¾‹å­åŒ…æ‹¬å»ºç«‹æ•°æ®åº“ã€å®‰è£…åº“å’Œåˆå§‹åŒ–ç›®å½•ç»“æ„ã€‚å¦‚æœæ‚¨æ›¾ç»ç¼–å†™è¿‡ä¸€ä¸ªå¾ˆå¥½çš„ shell è„šæœ¬æ¥å®Œæˆç±»ä¼¼çš„è®¾ç½®ï¼Œé‚£ä¹ˆæ‚¨å°±ç¦»å…¸å‹çš„ Docker å·¥ä½œæµä¸è¿œäº†ã€‚ç›¸å¯¹äº shell è„šæœ¬ï¼ŒDocker æœ‰å¾ˆå¤šå¥½å¤„ï¼Œæœ€æ˜æ˜¾çš„æ˜¯*å®¹å™¨åŒ–*:ä½¿ç”¨ Docker å®¹å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿è¡Œå®¹å™¨çš„ä¸»æœºç³»ç»Ÿä¸­æŠ½è±¡å‡ºæ¥ã€‚è¿è¡Œå®¹å™¨çš„è™šæ‹Ÿç³»ç»Ÿæ˜¯åœ¨å®ƒè‡ªå·±çš„è¿›ç¨‹ä¸­å®šä¹‰çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®©å¤šä¸ªå®¹å™¨åœ¨åŒä¸€å°ä¸»æœºä¸Šè¿è¡Œå®Œå…¨ä¸åŒçš„è®¾ç½®ã€‚è¿™å¯¹äºæŠµå¾¡ç³»ç»Ÿä¾èµ–åœ°ç‹±æ¥è¯´å¦‚ä½•ï¼Ÿ

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜è¿›ä¸€æ­¥é¿å…äº†æ–‡ä»¶ä¸¢å¤±å’Œç³»ç»ŸçŠ¶æ€å·®å¼‚ç­‰é—®é¢˜ã€‚æˆ‘ä»¬ç¡®åˆ‡åœ°çŸ¥é“ç³»ç»Ÿè¿è¡Œæ—¶çš„çŠ¶æ€ã€‚æˆ‘ä»¬çŸ¥é“è¿™ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ Dockerfile æ–‡ä»¶ä¸­çš„æ˜ç¡®è¯´æ˜åšåˆ°äº†è¿™ä¸€ç‚¹ã€‚

ä¸ºäº†å®é™…æ„å»ºå›¾åƒï¼Œæˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

```
docker build \
    -t my_first_container \
    -f Dockerfile 
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å»ºç«‹äº†å›¾åƒã€‚æœ‰äº†è¿™ä¸ªå›¾åƒï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦é‡å¤å®ä¾‹åŒ–å®ƒï¼Œä¾‹å¦‚æ‰§è¡Œå¤šä¸ªå®éªŒã€‚

```
docker run \
    --rm \
    -it \
    my_first_container 
```

ç§å•Šã€‚

å¦‚æœæˆ‘ä»¬ä»è¿™ä¸€ç‚¹å‡ºå‘ï¼Œè·‘å‘ N ä¸ªæ–¹å‘å»åšå„ç§ä¸åŒçš„å®éªŒï¼Œè¿™äº›å‘½ä»¤å¯èƒ½ä¼šå˜å¾—ç›¸å½“éº»çƒ¦

```
docker run \
    --mount type=bind,source="$(pwd)",target=/opt \
    --mount type=bind,source=${CORPORA_DIR},target=/corpora \
    -p ${JUPYTER_PORT}:${JUPYTER_PORT} \
    -ti \
    --rm \
    my_advanced_container \
    jupyter-lab \
        --allow-root \
        --ip=0.0.0.0 \
        --port=${JUPYTER_PORT} \
        --no-browser \
        2>&1 | tee log.txt 
```

ä¸è¦æ‹…å¿ƒï¼Œå¦‚æœä½ çš„çœ¼ç›åœ¨è¿™ä¸€ç‚¹ä¸Šè’™æ··è¿‡å…³ã€‚å…³é”®æ˜¯è¦ä¸åœåœ°æ‰“å­—ã€‚ä¸è¿‡æ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä½¿ç”¨ shell è„šæœ¬æ˜¯æœ‰åŸå› çš„ã€‚æœ‰äº† shell è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥å°†åˆ¶ä½œä¸€ä¸ªéå¸¸å…·ä½“çš„å‘½ä»¤åºåˆ—çš„å¾®å°ç»†èŠ‚å°è£…åˆ°åƒ`bash doit.sh`è¿™æ ·æ— éœ€åŠ¨è„‘çš„ä¸œè¥¿ä¸­ã€‚ç„¶è€Œï¼Œè¿˜è¦è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œå…¶ä¸­ Dockerfile å®šä¹‰ä¾èµ–äºå…¶ä»–æ–‡ä»¶(å³ requirements.txt æ–‡ä»¶æˆ–è¦ä½¿ç”¨çš„ç¯å¢ƒå˜é‡æ–‡ä»¶)ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›æ ¹æ®ä¸Šæ¸¸*ä¾èµ–å…³ç³»*ï¼Œè‡ªåŠ¨çŸ¥é“*ä½•æ—¶éœ€è¦é‡æ–°åˆ›å»º Docker æ˜ åƒã€‚*

é‚£ä¹ˆæ˜¯ä»€ä¹ˆæœ‰å››ä¸ªå­—æ¯ï¼Œè®©ä½ ä¸ç”¨è¾“å…¥å†—é•¿è´¹åŠ›çš„å‘½ä»¤ï¼Œå¹¶ä¸”è‡ªåŠ¨åŒ–äº†ä¾èµ–ç®¡ç†å‘¢ï¼Ÿ

## ä½¿

GNU Make æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„å·¥å…·ï¼Œæ˜¯è½¯ä»¶è¿åŠ¨èµ‹äºˆæˆ‘ä»¬çš„ï¼Œæ­£æ˜¯è¿™ä¸ªè½¯ä»¶è¿åŠ¨æˆå°±äº†ä»Šå¤©çš„æ•°å­—ä¸–ç•Œã€‚æˆ‘å°†ä¸ºæ‚¨ä¿å­˜ä¸€ä¸ªæ›´ç²¾å½©çš„ä»‹ç»ï¼Œå¹¶è·³è½¬åˆ°å®ƒçš„æ ¸å¿ƒæŠ½è±¡:ä¸€ä¸ªåŸºäº [DAG](https://en.wikipedia.org/wiki/Directed_acyclic_graph) çš„æ–¹æ³•æ¥æ™ºèƒ½åœ°ç®¡ç†æµç¨‹ä¸­åŠ¨ä½œçš„ä¾èµ–å…³ç³»ï¼Œä»¥ä¾¿*é«˜æ•ˆåœ°*å®ç°æœŸæœ›çš„ç»“æœã€‚

å¥½çš„ï¼Œè¿™ä¹Ÿæ˜¯ç¼–è¯‘ C ä»£ç çš„ä¸€ç§ä¾¿æ·æ–¹å¼ã€‚ä½†æ˜¯è¦ä¸“æ³¨äºç¬¬ä¸€ä¸ªå®šä¹‰ï¼Œè¦æƒ³å¾—æ›´å¤§ï¼å¤šå¹´æ¥ï¼Œé‡ç”¨åŸºäº DAG çš„ä¸€èˆ¬ä¾èµ–ç®¡ç†æ€æƒ³å¯¼è‡´äº†ä¸€äº›ä¼Ÿå¤§çš„å·¥å…·ï¼Œå¦‚ [Drake](https://github.com/Factual/drake) (ä¸æ˜¯è¯´å”±æ­Œæ‰‹) [Luigi](https://github.com/spotify/luigi) (ä¸æ˜¯é©¬é‡Œå¥¥çš„å…„å¼Ÿ)ï¼Œä¹Ÿè®¸æœ€è‘—åçš„æ˜¯ [Airflow](https://airflow.apache.org/) (AirBnB çš„å©´å„¿ï¼Œä½†ç°åœ¨æ˜¯ Apache åŸºé‡‘ä¼šçš„ä¸€éƒ¨åˆ†)ã€‚

è€ƒè™‘ä¸‹é¢è¿™ä¸ªäººä¸ºçš„ä¾‹å­ã€‚æˆ‘ä»¬æƒ³ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹å¯¹è§†å¬æ•°æ®è¿›è¡Œé¢„æµ‹ã€‚å½“æ–°çš„åŸå§‹å›¾åƒå‡ºç°æ—¶ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦é‡æ–°è®­ç»ƒæ¨¡å‹ä»¥åˆ›å»ºé¢„æµ‹ï¼ŸæŠ›å¼€åœ¨çº¿å­¦ä¹ ç­‰åº”ç”¨ï¼Œæˆ‘ä»¬ä¸ä¼šã€‚ç±»ä¼¼åœ°ï¼Œå‡è®¾æˆ‘ä»¬åˆšåˆšæ›´æ–°äº†æˆ‘ä»¬çš„è®­ç»ƒæ¨¡å‹çš„ä¸€äº›å‚æ•°ã€‚ä¸ºäº†é‡æ–°åˆ›å»º*ç›¸åŒçš„æ•°æ®æ ·æœ¬*ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æŒ‘é€‰åŸå§‹å›¾åƒå—ï¼Ÿæ²¡æœ‰ã€‚

[![](img/b5448819295c7ce83037271482386d58.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--IGP4r5sy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://anthonyagnone.com/wp-content/uploads/2019/05/graph-1.png)

è¿™å°±æ˜¯å“ç‰Œå‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚é€šè¿‡ç”¨å¯¹åº”äº DAG ä¸­(ä¸€ä¸ªæˆ–å¤šä¸ª)æœŸæœ›è¾“å‡ºçš„â€œç›®æ ‡â€æŒ‡å®šä¸€ä¸ª [Makefile](http://www.cs.colby.edu/maxwell/courses/tutorials/maketutor/) ï¼Œè°ƒç”¨è¯¥ç›®æ ‡å°†è‡ªåŠ¨ä¸ºæ‚¨æä¾›è¯¥ç»“æœï¼ŒåŒæ—¶åªé‡æ–°è°ƒç”¨å¿…è¦çš„ä¾èµ–è¿‡ç¨‹ã€‚

Make å¯ä»¥ç”¨äºå‡ ä¹æ‰€æœ‰æ¶‰åŠåŠ¨ä½œåŠå…¶ä¾èµ–å…³ç³»çš„äº‹æƒ…ã€‚å®ƒå¹¶ä¸æ€»æ˜¯åˆé€‚çš„å·¥å…·(å‚è§ [Airflow](https://airflow.apache.org/) äº†è§£åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„è¿™ä¸ªè¿‡ç¨‹)ï¼Œä½†æ˜¯å®ƒå¯ä»¥è®©ä½ èµ°å¾—å¾ˆè¿œã€‚æˆ‘ç”šè‡³ç”¨å®ƒç”Ÿæˆäº†ä¸Šé¢çš„å›¾åƒï¼ä¸‹é¢æ˜¯ Makefile çš„æ ·å­ã€‚

```
# the "graph.png" target specifies "graph.dot" as a dependency
# when "graph.png" is invoked, it invokes "graph.dot" only if necessary

graph.png: graph.dot
    dot graph.dot -Tpng > graph.png

# the "graph.dot" target specifies "make_graph.py" as a dependency
# so, this command is only re-run when...
#   1) make_graph.py changes
#   2) graph.dot is not present
graph.dot: make_graph.py
    python make_graph.py 
```

## ä¸¤å®¶è”å§»

å› æ­¤ï¼Œæˆ‘ä»¬åŠªåŠ›å…‹æœå¯å¤åˆ¶å·¥ä½œçš„å›°éš¾ï¼Œå¹¶å¼•å…¥äº†ä¼˜ç§€çš„å·¥å…·æ¥ç®¡ç†ç¯å¢ƒå°è£…(Docker)å’Œä¾èµ–ç®¡ç†(Make)ã€‚è¿™æ˜¯ä¸¤åªå¾ˆé…·çš„çŒ«ï¼Œæˆ‘ä»¬åº”è¯¥æŠŠå®ƒä»¬ä»‹ç»ç»™å½¼æ­¤ï¼

<figure>[![](img/ff316a192393a5c6c6eb0b0e6ddbbedc.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--kzxj5TMx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://anthonyagnone.com/wp-content/uploads/2019/07/product-school-mEpShydwItI-unsplash-1024x683.jpg)

<figcaption>Photo by[Product School](https://unsplash.com/@productschool?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)on[Unsplash](https://unsplash.com/search/photos/meet?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

p . s .å“ªä¸ªæ˜¯ Dockerï¼Œå“ªä¸ªæ˜¯ Makeï¼Ÿ</figcaption>

T12ã€‘</figure>

å‡è®¾æˆ‘ä»¬åˆšåˆšå‘ç°äº† [Magenta](https://magenta.tensorflow.org/) é¡¹ç›®ï¼Œå¹¶ä¸”æƒ³è¦å»ºç«‹ä¸€ä¸ªç¯å¢ƒæ¥ä¸€è‡´åœ°è¿è¡Œæ¼”ç¤ºå’Œå®éªŒï¼Œè€Œä¸ç”¨è¿›ä¸€æ­¥è€ƒè™‘æŸäººçš„è®¡ç®—æœºä¸Šè¿è¡Œçš„æ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„`this_or_that.py`ã€‚æ¯•ç«Ÿï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œæˆ‘ä»¬å¹¶ä¸å…³å¿ƒä½ çš„æœºå™¨ä¸Šè¿è¡Œçš„æ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„`this_or_that.py`ã€‚æˆ‘ä»¬å…³å¿ƒçš„æ˜¯ï¼Œæ‚¨èƒ½å¤Ÿä»¥æœ€å°çš„åŠªåŠ›ä½“éªŒå‘é€è€…ä½“éªŒè¿‡çš„ç›¸åŒæ¼”ç¤º/ç»“æœã€‚

æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªåŸºæœ¬çš„`Dockerfile`å®šä¹‰æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼ŒMagenta çš„äººå·²ç»å°½èŒå°½è´£åœ°è‡ªå·±åˆ›é€ äº†ä¸€ä¸ª[åŸºç¡€ç å¤´å·¥äººå½¢è±¡](https://hub.docker.com/r/tensorflow/magenta/tags)ï¼Œä½¿ä¹‹æˆä¸º*çç¢çš„*æ¥æ„å»º:

```
# base image
FROM tensorflow/magenta

# set partition and working directory
VOLUME /opt
WORKDIR /opt

# install base system packages
RUN apt-get update && apt-get install -y \
    vim \
    portaudio19-dev

# install python libraries
COPY requirements.txt /tmp/requirements.txt
RUN pip install --upgrade pip
RUN pip install -r /tmp/requirements.txt

# container entry point
ENTRYPOINT ["/bin/bash"] 
```

åœ¨å°†åŸºç¡€æ˜ åƒæŒ‡å®šä¸º Magenta ä¹‹åï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ª`/opt`å·ä¸Šè®¾ç½®ä¸€ä¸ªå·¥ä½œç›®å½•ï¼Œå®‰è£…ä¸€äº›ç³»ç»Ÿçº§å’Œ python çº§çš„ä¾èµ–é¡¹ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªç®€å•çš„`bash`å…¥å£ç‚¹ï¼Œç›´åˆ°æˆ‘ä»¬æœ‰ä¸€ä¸ªå·¥ä½œçš„åº”ç”¨ç¨‹åºã€‚å…¸å‹çš„`requirements.txt`æ–‡ä»¶å¯èƒ½å¦‚ä¸‹æ‰€ç¤º:

```
jupyterlab
seaborn
scikit-learn
matplotlib
pyaudio 
```

å¤ªæ£’äº†ã€‚æ‰€ä»¥ç°åœ¨æˆ‘ä»¬æœ‰äº†æˆ‘ä»¬æƒ³è¦çš„ç¯å¢ƒçš„è§„æ ¼ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥åˆ¶ä½œä¸€ä¸ª`Makefile`æ¥å¤„ç†ä¸€äº›ä¾èµ–å…³ç³»:

```
# use the name of the current directory as the docker image tag
DOCKERFILE ?= Dockerfile
DOCKER_TAG ?= $(shell echo ${PWD} | rev | cut -d/ -f1 | rev)
DOCKER_IMAGE = ${DOCKER_USERNAME}/${DOCKER_REPO}:${DOCKER_TAG}

$(DOCKERFILE): requirements.txt
    docker build \
        -t ${DOCKER_IMAGE} \
        -f ${DOCKERFILE} \
        .

.PHONY image
image: $(DOCKERFILE)

.PHONY: run
run:
     nvidia-docker run \
         --mount type=bind,source="$(shell pwd)",target=/opt \
         -i \
         --rm \
         -t $(DOCKER_IMAGE) 
```

è¿™ä¸ª`Makefile`æŒ‡å®šäº†`run`ã€`image`å’Œ`$(DOCKERFILE)`çš„ç›®æ ‡ã€‚`$(DOCKERFILE)`ç›®æ ‡å°†`requirements.txt`åˆ—ä¸ºä¾èµ–é¡¹ï¼Œå› æ­¤å½“æ–‡ä»¶æ”¹å˜æ—¶ï¼Œå°†è§¦å‘ Docker æ˜ åƒçš„é‡å»ºã€‚`image`ç›®æ ‡æ˜¯`$(DOCKERFILE)`ç›®æ ‡çš„ç®€å•åˆ«åã€‚æœ€åï¼Œ`run`ç›®æ ‡å…è®¸ä¸€ä¸ªç®€æ´çš„è°ƒç”¨æ¥æ‰§è¡Œ Docker å®¹å™¨ä¸­æ‰€éœ€çš„ç¨‹åºï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é”®å…¥è´¹åŠ›çš„å‘½ä»¤ã€‚

## ä¸€ä¸ªç å¤´å·¥äººç»Ÿæ²»ä»–ä»¬æ‰€æœ‰äººï¼Ÿ

[![](img/845ca0903b866e329278a259f3185c98.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--V3zZ_rKq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://anthonyagnone.com/wp-content/uploads/2019/07/docker-docker-docker-docker-docker-docker.jpg)

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä½ å¯èƒ½ä¼šæœ‰åŠ¨åŠ›å»å®šä¹‰ä¸€ä¸ª`Dockerfile`ä¸­çš„æ¯ä¸€ä¸ªå¯èƒ½çš„ä¾èµ–å…³ç³»ï¼Œä»¥ä¾¿ä¸å†ä¸ºç¡®ä¿ä¸‹ä¸€ä¸ªé¡¹ç›®çš„åˆé€‚ç¯å¢ƒè€Œçƒ¦æ¼ã€‚ä¾‹å¦‚ï¼ŒFloydhub æœ‰ä¸€ä¸ªç”¨äºæ·±åº¦å­¦ä¹ é¡¹ç›®çš„[å¤šåŠŸèƒ½ Docker å›¾åƒ](https://github.com/floydhub/dl-docker)ã€‚è¿™ä¸ªé•œåƒè§„èŒƒåŒ…æ‹¬*ä¼—å¤š*æ·±åº¦å­¦ä¹ æ¡†æ¶å’Œæ”¯æŒ python åº“ã€‚

ä¸è¦é‚£æ ·åšï¼

ä¸ºäº†ä¾¿äºè®¨è®ºï¼Œè®©æˆ‘ä»¬æŠŠå®ƒå‘æŒ¥åˆ°æé™ã€‚åœ¨ä½ æ¥ä¸‹æ¥çš„ 100 ä¸ªé¡¹ç›®ä¸­ï¼Œä½ çš„ Docker å½¢è±¡ä¼šæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿè€Œæ¥ä¸‹æ¥çš„ 1000 ä¸ªé¡¹ç›®ä¹‹åå‘¢ï¼Ÿéšç€æ—¶é—´çš„æ¨ç§»ï¼Œå®ƒä¼šå˜å¾—è‡ƒè‚¿ï¼Œå°±å¥½åƒä½ åœ¨æ¯ä¸ªé¡¹ç›®ä¸­é€æ¸æ”¹å˜äº†ä½ çš„ä¸»æ“ä½œç³»ç»Ÿä¸€æ ·ã€‚è¿™è¿èƒŒäº† Docker çš„é›†è£…ç®±å“²å­¦â€”â€”ä½ çš„é›†è£…ç®±åº”è¯¥æ˜¯è½»é‡çº§çš„ï¼ŒåŒæ—¶ä¿æŒå……è¶³ã€‚

æ­¤å¤–ï¼Œç”±äºæ‰€æœ‰è¿™äº›è†¨èƒ€ï¼Œæ‚¨å¤±å»äº†ç»´æŒéœ€è¦ä¸åŒä¾èµ–ç‰ˆæœ¬çš„é¡¹ç›®çš„å¤šä¸ªæ–¹å‘çš„èƒ½åŠ›ã€‚å¦‚æœæ‚¨çš„ä¸€ä¸ªé¡¹ç›®éœ€è¦è¿è¡Œæœ€æ–°ç‰ˆæœ¬çš„ Tensorflowï¼Œä½†æ‚¨ä¸æƒ³æ›´æ–°ä¹‹å‰çš„ 99 ä¸ªé¡¹ç›®(å¹¶å¤„ç†æ›´æ–°å¸¦æ¥çš„æ‰€æœ‰å¤±è´¥)ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

## ç»“è®º

åœ¨è¿ˆå‘é«˜æ•ˆå’Œå¯å†ç°(TEAR) ML å·¥ä½œæµç³»åˆ—çš„è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸ºä½¿å®éªŒå’Œåº”ç”¨æˆä¸ºç›¸å¯¹æ— ç—›çš„è¿‡ç¨‹å¥ å®šäº†åŸºç¡€ã€‚æˆ‘ä»¬é€šè¿‡ Docker ä½¿ç”¨å®¹å™¨åŒ–æ¥ç¡®ä¿å®éªŒå’Œåº”ç”¨ç¨‹åºæ˜¯**å¯å¤åˆ¶çš„**å¹¶ä¸”æ˜“äºæ‰§è¡Œã€‚ç„¶åæˆ‘ä»¬é€šè¿‡ Make ä½¿ç”¨äº†ä¸€äº›è‡ªåŠ¨ä¾èµ–ç®¡ç†æ¥ä¿æŒå®éªŒç®¡é“**é«˜æ•ˆ**å’Œç®€å•è¿è¡Œã€‚

<figure>[![](img/d977949ea112a694dadb770c8978ca72.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--VhNYWfH7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://anthonyagnone.com/wp-content/uploads/2019/07/susan-holt-simpson-2nSdQEd-Exc-unsplash-1024x689.jpg) 

<figcaption>ç…§ç‰‡ç”±[è‹çŠéœå°”ç‰¹è¾›æ™®æ£®](https://unsplash.com/@shs521?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)ä¸Š [Unsplash](https://unsplash.com/collections/4885214/blog-photos?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)</figcaption>

</figure>

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºè¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæœ‰è®¸å¤šå¯ä¾›é€‰æ‹©çš„è§£å†³æ–¹æ¡ˆï¼›ç„¶è€Œï¼Œå®ƒä»¬éµå¾ªç›¸åŒçš„ä¸€èˆ¬*æ¨¡å¼*:å®¹å™¨åŒ–ç»™ä½ å¯å¤åˆ¶æ€§ï¼Œè‡ªåŠ¨ä¾èµ–ç®¡ç†ç»™ä½ æ•ˆç‡ã€‚ç”±æ­¤ï¼Œå…¶ä»–è§£å†³æ–¹æ¡ˆä¸­çš„é™„åŠ å€¼é€šå¸¸å½’ç»“ä¸ºä¸€äº›åè€Œä¸å®çš„ä¸œè¥¿ï¼Œæ¯”å¦‚äº‘é›†æˆã€å¯ä¼¸ç¼©æ€§æˆ–æ€»ä½“æ˜“ç”¨æ€§ã€‚æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±é€‰æ‹©çš„å·¥å…·ã€‚