# å°†å¤šéƒ¨åˆ†è¯·æ±‚æ­£æ–‡ä¸ VCR åŒ¹é…

> åŸæ–‡ï¼š<https://dev.to/kabisasoftware/matching-multipart-request-bodies-with-vcr-2mf4>

å½“ä½¿ç”¨ VCR æµ‹è¯• HTTP å¤šéƒ¨åˆ†è¯·æ±‚æ—¶ï¼Œç”±äºå¤šéƒ¨åˆ†çš„è¾¹ç•Œï¼Œæ‚¨å¯èƒ½ä¼šé‡åˆ°ä¸åŒ¹é…çš„ç›’å­ã€‚å¤šéƒ¨åˆ†è¾¹ç•Œé€šå¸¸æ˜¯ç”± HTTP åº“æˆ–æµè§ˆå™¨éšæœºç”Ÿæˆçš„ï¼Œå› æ­¤å½“ VCR è¯•å›¾å°†å¤šéƒ¨åˆ†è¯·æ±‚ä¸ç£å¸¦åŒ¹é…æ—¶ï¼Œè¾¹ç•Œå°†ä¼šä¸åŒï¼ŒåŒ¹é…å°†ä¼šå¤±è´¥ã€‚

ç„¶è€Œï¼Œåœ¨åŒ¹é…è¯·æ±‚ä¹‹å‰ï¼Œç”¨å›ºå®šè¾¹ç•Œæ›¿æ¢éšæœºè¾¹ç•Œæ˜¯éå¸¸ç®€å•çš„ã€‚å¤šéƒ¨åˆ†è¯·æ±‚å°†æœ‰ä¸€ä¸ª`Content-Type`å¤´ï¼Œå®ƒä¸ä»…ä½¿è¯·æ±‚å¯è¢«è¯†åˆ«ä¸ºå¤šéƒ¨åˆ†è¯·æ±‚ï¼Œè¿˜æŒ‡å®šäº†æ‰€ä½¿ç”¨çš„ç¡®åˆ‡è¾¹ç•Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä» Ruby é¡¹ç›®ä¸­æå–äº†ä¸€ä¸ªç£å¸¦ï¼Œæ‰€ä»¥`Content-Type`çœ‹èµ·æ¥åƒè¿™æ ·:

```
multipart/form-data; boundary=----RubyFormBoundaryTsqIBL0iujC5POpr 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç»™å®šè¿™ä¸ªå¤´ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿç®€å•åœ°ç”¨ä¸€ä¸ªå›ºå®šå€¼æ›¿æ¢è¾¹ç•Œã€‚VCR æœ‰ä¸€ä¸ªåä¸º`match_request_on`çš„é…ç½®é€‰é¡¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¥å—é¢„å®šä¹‰è¯·æ±‚åŒ¹é…å™¨çš„ç¬¦å·(å‚è§ https://relishapp.com/vcr/vcr/v/5-0-0/docs/request-matching)æˆ– callable (Procï¼ŒLambda)ã€‚æˆ‘ä¸æ˜¯ä¸€ä¸ªçœŸæ­£å–œæ¬¢ä½¿ç”¨è¿›ç¨‹çš„äººï¼Œä½†æ˜¯åªè¦æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”`call`çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å°±ä¼šæ²¡äº‹:

```
class VCRMultipartBodyMatcher
  MULTIPART_HEADER_MATCHER = %r{^multipart/form-data; boundary=(.+)$}

  def call(request_1, request_2)
    normalized_multipart_body(request_1) == normalized_multipart_body(request_2)
  end

  private

  def normalized_multipart_body(request)
    content_type = (request.headers['Content-Type'] || []).first.to_s

    return request.body unless multipart_request?(content_type)

    boundary = MULTIPART_HEADER_MATCHER.match(content_type)[1]
    request.body.gsub(boundary, '----RubyFormBoundaryTsqIBL0iujC5POpr')
  end

  def multipart_request?(content_type)
    return false if content_type.empty?

    MULTIPART_HEADER_MATCHER.match?(content_type)
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬å¯ä»¥å‘Šè¯‰ VCR ä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰åŒ¹é…å™¨:

```
VCR.configure do |config|
  config.default_cassette_options = {
    match_requests_on: [:method, :uri, VCRMultipartBodyMatcher.new]
  }
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œå½“è¿è¡Œæµ‹è¯•æ—¶ï¼Œè¯·æ±‚å’Œç‰‡ç›’çš„è¾¹ç•Œå°†æ˜¯ç›¸ç­‰çš„ï¼Œå› æ­¤åªæœ‰å½“è¯·æ±‚å‚æ•°ä¸åŒæ—¶ï¼Œç‰‡ç›’æ‰ä¼šä¸åŒ¹é…ã€‚ğŸ‘

æ‚¨éœ€è¦æµ‹è¯•åº”ç”¨ç¨‹åºçš„å¸®åŠ©å—ï¼Ÿåœ¨ Kabisaï¼Œæˆ‘ä»¬éå¸¸äº†è§£å¦‚ä½•ç¼–å†™å¥½çš„æµ‹è¯•ã€‚å¦‚æœæ‚¨æƒ³è”ç³»æˆ‘ä»¬ï¼Œè¯·ç»™æˆ‘ä»¬ç•™è¨€ã€‚