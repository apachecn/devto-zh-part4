# å•å…ƒæµ‹è¯•åœ¨ React ä¸­å‘ˆç°æ­£ç¡®çš„ç»„ä»¶

> åŸæ–‡ï¼š<https://dev.to/maksimovicdanijel/unit-testing-render-prop-component-in-react-27hm>

## ä»€ä¹ˆæ˜¯æ¸²æŸ“é“å…·ï¼Ÿ

æ¸²æŸ“é“å…·æ˜¯ä¸€ç§åœ¨ React ç”Ÿæ€ç³»ç»Ÿä¸­å¹¿æ³›ä½¿ç”¨æ¨¡å¼ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæ¸²æŸ“é“å…·æ˜¯ä¸€ç§å°†å‡½æ•°ä½œä¸ºé“å…·ä¼ é€’çš„æ¨¡å¼ï¼Œé€šå¸¸ç§°ä¸º`render`æˆ–è€…æ›´å¸¸è§çš„æ˜¯ä½œä¸º`children`é“å…·ã€‚æ¯”å¦‚:

```
import React from 'react';

const RenderPropComponent = ({children}) => {
  const [counter, setCounter] = React.useState(0)  

  return children({counter, setCounter});
};

// usage
const Usage = () => {
  return (
    <RenderPropComponent>
      {({counter}) => <p>Counter: {counter}</p>}
    </RenderPropComponent>
  );
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä½ æƒ³æ›´å¹¿æ³›åœ°äº†è§£ React ä¸­çš„æ¸²æŸ“é“å…·æ¨¡å¼ä»¥åŠå®ƒä»¬åœ¨ React ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç”¨æ³•ï¼Œè¯·æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ã€‚

## æµ‹è¯•å‡†å¤‡

ä¸ºäº†æµ‹è¯•æ¸²æŸ“é“å…·ç»„ä»¶ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆå†™ä¸€ä¸ªï¼æˆ‘ä»¬çš„ç»„ä»¶å°†ä» API è·å–å¸–å­ï¼Œå¹¶å‘æ¶ˆè´¹è€…ç»„ä»¶å…¬å¼€åŠ è½½çŠ¶æ€å’Œå¸–å­ã€‚

```
import React from 'react';
import PropTypes from 'prop-types';

import { fetchPosts } from './api';

export default class FetchPosts extends React.Component {
  static propTypes = {
    children: PropTypes.func.isRequired
  };

  state = { posts: [], loading: false };

  async componentDidMount() {
    this.setState({ loading: true });

    const posts = await fetchPosts();

    this.setState({ posts, loading: false });  
  }

  render() {
    return this.props.children({posts: this.state.posts, loading});
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## å†™ä½œæµ‹è¯•

æˆ‘ä»¬å°†ä½¿ç”¨`jest`å’Œ`react-testing-library`æ¥ç¼–å†™æˆ‘ä»¬çš„æµ‹è¯•ï¼Œä½†æ˜¯å¦‚æœæ‚¨ä½¿ç”¨å…¶ä»–ä¸œè¥¿æ¥ç¼–å†™æµ‹è¯•ï¼ŒåŒæ ·çš„åŸåˆ™ä¹Ÿé€‚ç”¨ã€‚

```
import React from 'react';
import { render } from 'react-testing-library';

import FetchPosts from './FetchPosts';

const mockPosts = [{ id: 1, title: 'Title' }];

jest.mock('./fetchPosts', () => Promise.resolve(mockPosts));

describe('FetchPosts component test', () => {
  it('should expose loading and posts prop', () => {
    const postsCallbackMock = jest.fn();

    const { getByTestId } = render(
      <FetchPosts>{postsCallbackMock}</FetchPosts>
    );

    expect(postsCallbackMock).toHaveBeenCalledWith({
      loading: false,
      posts: mockPosts
    })
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯æµ‹è¯•æ¸²æŸ“é“å…·ç»„ä»¶çš„ä¸€ç§ç®€å•æ–¹æ³•ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ç¼–å†™ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä»¶ï¼Œåœ¨é¡µé¢ä¸Šå‘ˆç°ä¸€äº›å†…å®¹ï¼Œç„¶åæœŸæœ›å®ƒä¸æ‚¨æ”¶åˆ°çš„æ•°æ®ç›¸åŒ¹é…ã€‚ä¾‹å¦‚:

```
import React from 'react';
import { render } from 'react-testing-library';

import FetchPosts from './FetchPosts';

const mockPosts = [{ id: 1, title: 'Title' }];

jest.mock('./fetchPosts', () => {
  return new Promise(resolve => {
    setTimeout(() => resolve(mockPosts), 100);
  });
});

const FetchPostsConsumer = () => (
  <FetchPosts>
    {({loading, posts}) => {
      if(loading) return <span data-testid="loading"></span>; 
      return posts.map(post => <p data-testid="post-title">{post.title}</p>)
    }}
  </FetchPosts> );

describe('FetchPosts component test', done => {
  it('should return correct loading and posts props', () => {
    const postsCallbackMock = jest.fn();

    const { getByTestId } = render(
      <FetchPostsConsumer />
    );

    expect(getByTestId('loading').textContent).toBe('Loading');

    setTimeout(() => {
      expect(getByTestId('post-title').textContent).toBe('Title');
      done()
    })
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ä¸ªæµ‹è¯•çš„å¼€å§‹ï¼Œæˆ‘ä»¬å£°æ˜æˆ‘ä»¬çš„`fetchPosts`æ¨¡å—è¿”å›ä»€ä¹ˆï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªæµ‹è¯•è¿è¡Œä¸­æœ‰ç›¸åŒçš„ç»“æœ(è¿™äº›æµ‹è¯•è¢«ç§°ä¸ºç¡®å®šæ€§çš„)ã€‚è¿™ä¸ªå‡½æ•°çš„æ¨¡æ‹Ÿç‰ˆæœ¬æ­£åœ¨è§£æä¸€ä¸ªæ‰¿è¯ºï¼Œä½†æ˜¯åœ¨è¶…æ—¶ä¹‹åï¼Œè¿™ç»™äº†æˆ‘ä»¬è¶³å¤Ÿçš„æ—¶é—´åœ¨æµ‹è¯•ä¸­æ£€æŸ¥åŠ è½½çŠ¶æ€ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒä½¿ç”¨äº†æˆ‘ä»¬çœŸæ­£æƒ³è¦æµ‹è¯•çš„ render prop ç»„ä»¶ã€‚ç»„ä»¶å‘ˆç°åï¼Œæˆ‘ä»¬æ£€æŸ¥åŠ è½½æ–‡æœ¬æ˜¯å¦å­˜åœ¨ã€‚ä¸€æ®µæ—¶é—´åï¼Œæˆ‘ä»¬å°†æ£€æŸ¥æ¸²æŸ“å±æ€§å›è°ƒæ˜¯å¦ä¼šæ¸²æŸ“æ­£ç¡®çš„å¸–å­ã€‚è¿™ç§æ–¹æ³•æœ‰ç‚¹é•¿ï¼Œä½†åœ¨æˆ‘çœ‹æ¥ï¼Œå®ƒç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ›´é¢å‘ç”¨æˆ·çš„æµ‹è¯•ï¼Œæœ€ç»ˆæ˜¯ç”¨æˆ·å°†å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„ç»„ä»¶ã€‚

## ç»“è®º

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæµ‹è¯•æ¸²æŸ“ç»„ä»¶å¹¶ä¸å›°éš¾ã€‚å› ä¸ºè¿™ç§ç»„ä»¶æœ¬èº«ä¸ä¼šç”Ÿæˆè¾“å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨æµ‹è¯•ä¸­æä¾›ç¼ºå¤±çš„éƒ¨åˆ†ï¼Œç„¶åè¿›è¡Œæ–­è¨€ã€‚ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•æ˜¯åªæä¾›ä¸€ä¸ªæ¨¡æ‹Ÿå‡½æ•°ï¼Œå¹¶æœŸæœ›ç”¨æ­£ç¡®çš„å‚æ•°è°ƒç”¨å®ƒã€‚ä½ æ›´å–œæ¬¢å“ªç§æ–¹æ³•ï¼Ÿè¯·åœ¨ä¸‹é¢çš„è¯„è®ºä¸­åˆ†äº«å§ğŸ‘‡