# WebGL æœˆä»½ã€‚ç¬¬ 26 å¤©ã€‚æ¸²æŸ“åˆ°çº¹ç†

> åŸæ–‡:[https://dev . to/lesnitsky/web GL-month-day-26-rendering-to-texture-4 hkp](https://dev.to/lesnitsky/webgl-month-day-26-rendering-to-texture-4hkp)

è¿™æ˜¯ä¸€ç³»åˆ—ä¸ WebGL ç›¸å…³çš„åšæ–‡ã€‚æ¯å¤©éƒ½ä¼šæœ‰æ–°å¸–å­

[![GitHub stars](../Images/7a62e6572a80bbc8913957ac9042103e.png)](https://github.com/lesnitsky/webgl-month)
[![Twitter Follow](../Images/a66003765b1d742c03ff459eb1614ef8.png)T6ã€‘](https://twitter.com/lesnitsky_a)

[åŠ å…¥é‚®ä»¶åˆ—è¡¨](http://eepurl.com/gwiSeH),è®©æ–°é‚®ä»¶ç›´æ¥è¿›å…¥ä½ çš„æ”¶ä»¶ç®±

[æ­¤å¤„æä¾›æºä»£ç ](https://github.com/lesnitsky/webgl-month)

å»ºé€ äº

[![Git Tutor Logo](../Images/4a5fcbd1126401b65ca7fbe362404aa0.png)T2ã€‘](https://github.com/lesnitsky/git-tutor)

* * *

å˜¿ğŸ‘‹æ¬¢è¿æ¥åˆ° WebGL æœˆã€‚

åœ¨æˆ‘ä»¬ä¹‹å‰çš„ä¸€ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å»ºç«‹äº†ä¸€äº›ç®€å•çš„å›¾åƒè¿‡æ»¤å™¨ï¼Œå¦‚â€œé»‘ç™½â€ã€â€œæ£•è¤è‰²â€ç­‰ã€‚æˆ‘ä»¬èƒ½å¦å°†è¿™ç§â€œåæœŸæ•ˆæœâ€ä¸ä»…åº”ç”¨äºç°æœ‰å›¾åƒï¼Œè¿˜åº”ç”¨äºæˆ‘ä»¬æ­£åœ¨æ¸²æŸ“çš„æ•´ä¸ª 3d åœºæ™¯ï¼Ÿ

æ˜¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥ï¼ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦ä¸€ä¸ªçº¹ç†æ¥å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆæŠŠåœºæ™¯æ¸²æŸ“åˆ°çº¹ç†ä¸Šï¼Œè€Œä¸æ˜¯ç”»å¸ƒä¸Š

ä»ç¬¬ä¸€ä¸ªæ•™ç¨‹ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œcanvas åªæ˜¯ä¸€ä¸ªåƒç´ é¢œè‰²çš„ç¼“å†²åŒº(4 ä¸ªæ•´æ•°ï¼Œrï¼Œgï¼Œbï¼Œa)
è¿˜æœ‰ä¸€ä¸ªæ·±åº¦ç¼“å†²åŒº(ç”¨äºæ¯ä¸ªåƒç´ çš„ Z åæ ‡)

æ‰€ä»¥æƒ³æ³•æ˜¯è®© webgl æ¸²æŸ“åˆ°ä¸€äº›ä¸åŒçš„â€œç¼“å†²åŒºâ€è€Œä¸æ˜¯ç”»å¸ƒã€‚

æœ‰ä¸€ç§ç‰¹æ®Šç±»å‹çš„ç¼“å†²åŒºï¼Œç§°ä¸º`framebuffer`,å¯ä»¥ä½œä¸ºæ¸²æŸ“ç›®æ ‡

ä¸ºäº†åˆ›å»ºä¸€ä¸ªå¸§ç¼“å†²åŒºï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨`gl.createFramebuffer`

ğŸ“„src/minecraft.js

```
 mat4.fromTranslation(cameraFocusPointMatrix, cameraFocusPoint);

+ const framebuffer = gl.createFramebuffer();
+ 
  function render() {
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, -30]);
      mat4.rotateY(cameraFocusPointMatrix, cameraFocusPointMatrix, Math.PI / 360); 
```

Framebuffer æœ¬èº«ä¸æ˜¯ä¸€ä¸ªå­˜å‚¨å™¨ï¼Œè€Œæ˜¯ä¸€ç»„å¯¹â€œé™„ä»¶â€(é¢œè‰²ã€æ·±åº¦)çš„å¼•ç”¨

ä¸ºäº†æ¸²æŸ“é¢œè‰²ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªçº¹ç†

ğŸ“„src/minecraft.js

```
 const framebuffer = gl.createFramebuffer();

+ const texture = gl.createTexture();
+ 
+ gl.bindTexture(gl.TEXTURE_2D, texture);
+ gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, canvas.width, canvas.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
+ 
+ gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
+ gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
+ gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
+ 
  function render() {
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, -30]);
      mat4.rotateY(cameraFocusPointMatrix, cameraFocusPointMatrix, Math.PI / 360); 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦ç»‘å®šä¸€ä¸ªå¸§ç¼“å†²åŒºå¹¶è®¾ç½®ä¸€ä¸ªé¢œè‰²é™„ä»¶

ğŸ“„src/minecraft.js

```
 gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

+ gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
+ gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);
+ 
  function render() {
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, -30]);
      mat4.rotateY(cameraFocusPointMatrix, cameraFocusPointMatrix, Math.PI / 360); 
```

ç°åœ¨æˆ‘ä»¬çš„ç”»å¸ƒæ˜¯ç™½è‰²çš„ã€‚æˆ‘ä»¬æ‰“ç ´äº†ä»€ä¹ˆå—ï¼Ÿä¸â€“ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼Œä½†æ˜¯æˆ‘ä»¬çš„åœºæ™¯ç°åœ¨è¢«æ¸²æŸ“åˆ°ä¸€ä¸ªçº¹ç†è€Œä¸æ˜¯ç”»å¸ƒä¸Š

ç°åœ¨æˆ‘ä»¬éœ€è¦ä»çº¹ç†æ¸²æŸ“åˆ°ç”»å¸ƒ

é¡¶ç‚¹ç€è‰²å™¨éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æ¸²æŸ“ä¸€ä¸ªç”»å¸ƒå¤§å°çš„çŸ©å½¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä» js ä¼ é€’é¡¶ç‚¹ä½ç½®ï¼Œè€Œæ— éœ€ä»»ä½•è½¬æ¢

ğŸ“„src/shaders/filter.v.glsl

```
attribute vec2 position;

void main() {
    gl_Position = vec4(position, 0, 1);
} 
```

ç‰‡æ®µç€è‰²å™¨éœ€è¦çº¹ç†æ¥è¯»å–é¢œè‰²ï¼Œè¿˜éœ€è¦åˆ†è¾¨ç‡æ¥å°†åƒç´ åæ ‡è½¬æ¢ä¸ºçº¹ç†åæ ‡

ğŸ“„src/shaders/filter.f.glsl

```
precision mediump float;

uniform sampler2D texture;
uniform vec2 resolution;

void main() {
    gl_FragColor = texture2D(texture, gl_FragCoord.xy / resolution);
} 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªç¨‹åºè®¾ç½®ä¾‹ç¨‹

ğŸ“„src/minecraft.js

```
 import { prepare as prepareSkybox, render as renderSkybox } from './skybox';
  import { prepare as prepareTerrain, render as renderTerrain } from './minecraft-terrain';

+ import vShaderSource from './shaders/filter.v.glsl';
+ import fShaderSource from './shaders/filter.f.glsl';
+ import { setupShaderInput, compileShader } from './gl-helpers';
+ import { GLBuffer } from './GLBuffer';
+ import { createRect } from './shape-helpers';
+ 
  const canvas = document.querySelector('canvas');
  const gl = canvas.getContext('webgl');

  gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
  gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);

+ const vShader = gl.createShader(gl.VERTEX_SHADER);
+ const fShader = gl.createShader(gl.FRAGMENT_SHADER);
+ 
+ compileShader(gl, vShader, vShaderSource);
+ compileShader(gl, fShader, fShaderSource);
+ 
+ const program = gl.createProgram();
+ 
+ gl.attachShader(program, vShader);
+ gl.attachShader(program, fShader);
+ 
+ gl.linkProgram(program);
+ gl.useProgram(program);
+ 
+ const vertexPositionBuffer = new GLBuffer(
+     gl,
+     gl.ARRAY_BUFFER,
+     new Float32Array([...createRect(-1, -1, 2, 2)]),
+     gl.STATIC_DRAW
+ );
+ 
+ const indexBuffer = new GLBuffer(gl, gl.ELEMENT_ARRAY_BUFFER, new Uint8Array([0, 1, 2, 1, 2, 3]), gl.STATIC_DRAW);
+ 
+ const programInfo = setupShaderInput(gl, program, vShaderSource, fShaderSource);
+ 
+ vertexPositionBuffer.bind(gl);
+ gl.vertexAttribPointer(programInfo.attributeLocations.position, 2, gl.FLOAT, false, 0, 0);
+ 
+ gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);
+ 
  function render() {
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, -30]);
      mat4.rotateY(cameraFocusPointMatrix, cameraFocusPointMatrix, Math.PI / 360); 
```

åœ¨æ¯ä¸€å¸§çš„å¼€å§‹ï¼Œæˆ‘ä»¬éœ€è¦ç»‘å®šä¸€ä¸ª framebuffer æ¥å‘Šè¯‰ webgl æ¸²æŸ“ä¸€ä¸ªçº¹ç†

ğŸ“„src/minecraft.js

```
 gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);

  function render() {
+     gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
+ 
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, -30]);
      mat4.rotateY(cameraFocusPointMatrix, cameraFocusPointMatrix, Math.PI / 360);
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, 30]); 
```

åœ¨æˆ‘ä»¬å°†åœºæ™¯æ¸²æŸ“åˆ°çº¹ç†ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æˆ‘ä»¬çš„æ–°ç¨‹åº

ğŸ“„src/minecraft.js

```
 renderSkybox(gl, viewMatrix, projectionMatrix);
      renderTerrain(gl, viewMatrix, projectionMatrix);

+     gl.useProgram(program);
+ 
      requestAnimationFrame(render);
  } 
```

è®¾ç½®è®¡åˆ’å±æ€§å’Œç»Ÿä¸€

ğŸ“„src/minecraft.js

```
 gl.useProgram(program);

+     vertexPositionBuffer.bind(gl);
+     gl.vertexAttribPointer(programInfo.attributeLocations.position, 2, gl.FLOAT, false, 0, 0);
+ 
+     gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);
+ 
      requestAnimationFrame(render);
  } 
```

ç»‘å®šç©ºå¸§ç¼“å†²åŒº(è¿™å°†ä½¿ webgl æ¸²æŸ“åˆ°ç”»å¸ƒä¸Š)

ğŸ“„src/minecraft.js

```
 gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);

+     gl.bindFramebuffer(gl.FRAMEBUFFER, null);
+ 
      requestAnimationFrame(render);
  } 
```

ç»‘å®šçº¹ç†ä»¥å°†å…¶ç”¨ä½œé¢œè‰²æ•°æ®çš„æ¥æº

ğŸ“„src/minecraft.js

```
 gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);

      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
+     gl.bindTexture(gl.TEXTURE_2D, texture); 
      requestAnimationFrame(render);
  } 
```

å¹¶å‘å‡ºå¹³å±€å‘¼å«

ğŸ“„src/minecraft.js

```
 gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      gl.bindTexture(gl.TEXTURE_2D, texture);

+     gl.drawElements(gl.TRIANGLES, indexBuffer.data.length, gl.UNSIGNED_BYTE, 0);
+ 
      requestAnimationFrame(render);
  } 
```

å› ä¸ºæˆ‘ä»¬åœ¨æ¸²æŸ“åœ°å½¢å’Œå¤©ç©ºç›’åç»‘å®šäº†ä¸åŒçš„çº¹ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨åœ°å½¢å’Œå¤©ç©ºç›’ç¨‹åºä¸­é‡æ–°ç»‘å®šçº¹ç†

ğŸ“„src/minecraft-terrain.js

```
 await loadImage(textureSource).then((image) => {
          const texture = createTexture(gl);
+         State.texture = texture;
+ 
          setImage(gl, texture, image);

          gl.generateMipmap(gl.TEXTURE_2D);

      setupAttributes(gl);

+     gl.bindTexture(gl.TEXTURE_2D, State.texture);
+ 
      gl.uniformMatrix4fv(State.programInfo.uniformLocations.viewMatrix, false, viewMatrix);
      gl.uniformMatrix4fv(State.programInfo.uniformLocations.projectionMatrix, false, projectionMatrix); 
```

ğŸ“„src/skybox.js

```
 export function render(gl, viewMatrix, projectionMatrix) {
      gl.useProgram(State.program);

+     gl.bindTexture(gl.TEXTURE_CUBE_MAP, State.texture);
+ 
      gl.uniformMatrix4fv(State.programInfo.uniformLocations.viewMatrix, false, viewMatrix);
      gl.uniformMatrix4fv(State.programInfo.uniformLocations.projectionMatrix, false, projectionMatrix); 
```

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ·±åº¦ç¼“å†²ã€‚æ·±åº¦ç¼“å†²åŒºæ˜¯ä¸€ä¸ªæ¸²æŸ“ç¼“å†²åŒº(åŒ…å«æ¥è‡ª fragmnt ç€è‰²å™¨è¾“å‡ºçš„æ•°æ®çš„å¯¹è±¡)

ğŸ“„src/minecraft.js

```
 gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
  gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);

+ const depthBuffer = gl.createRenderbuffer();
+ gl.bindRenderbuffer(gl.RENDERBUFFER, depthBuffer);
+ 
  const vShader = gl.createShader(gl.VERTEX_SHADER);
  const fShader = gl.createShader(gl.FRAGMENT_SHADER); 
```

å¹¶è®¾ç½® renderbuffer æ¥å­˜å‚¨æ·±åº¦ä¿¡æ¯

ğŸ“„src/minecraft.js

```
 const depthBuffer = gl.createRenderbuffer();
  gl.bindRenderbuffer(gl.RENDERBUFFER, depthBuffer);

+ gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, canvas.width, canvas.height);
+ gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, depthBuffer);
+ 
  const vShader = gl.createShader(gl.VERTEX_SHADER);
  const fShader = gl.createShader(gl.FRAGMENT_SHADER); 
```

ç°åœ¨åœºæ™¯çœ‹èµ·æ¥æ›´å¥½ï¼Œä½†åªæœ‰ä¸€ä¸ªå•ä¸€çš„æ¡†æ¶ï¼Œå…¶ä»–äººä¼¼ä¹æ˜¯åœ¨ä»¥å‰çš„åŸºç¡€ä¸Šç»˜åˆ¶çš„ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºçº¹ç†åœ¨ä¸‹ä¸€æ¬¡ç»˜åˆ¶è°ƒç”¨ä¹‹å‰æ²¡æœ‰è¢«æ¸…é™¤

æˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ª`gl.clear`æ¥æ¸…é™¤çº¹ç†(æ¸…é™¤å½“å‰ç»‘å®šçš„å¸§ç¼“å†²åŒº)ã€‚è¿™ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ªä½æ©ç ï¼Œå‘Šè¯‰ webgl æ¸…é™¤å“ªä¸ªç¼“å†²åŒºã€‚æˆ‘ä»¬éœ€è¦æ¸…é™¤é¢œè‰²å’Œæ·±åº¦ç¼“å†²åŒºï¼Œæ‰€ä»¥è’™ç‰ˆæ˜¯`gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT`

ğŸ“„src/minecraft.js

```
 function render() {
      gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);

+     gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
+ 
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, -30]);
      mat4.rotateY(cameraFocusPointMatrix, cameraFocusPointMatrix, Math.PI / 360);
      mat4.translate(cameraFocusPointMatrix, cameraFocusPointMatrix, [0, 0, 30]); 
```

> æ³¨æ„:å¦‚æœ`preserveDrawingBuffer`ä¸Šä¸‹æ–‡å‚æ•°è®¾ç½®ä¸º trueï¼Œè¿™ä¹Ÿåº”è¯¥åœ¨æ¸²æŸ“åˆ°ç”»å¸ƒä¹‹å‰å®Œæˆ

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¤ä½¿ç”¨ä¹‹å‰æ•™ç¨‹ä¸­çš„æ»¤é•œåŠŸèƒ½ï¼Œå°†æ•´ä¸ªåœºæ™¯å˜æˆé»‘ç™½çš„

ğŸ“„src/shaders/filter.f.glsl

```
 uniform sampler2D texture;
  uniform vec2 resolution;

+ vec4 blackAndWhite(vec4 color) {
+     return vec4(vec3(1.0, 1.0, 1.0) * (color.r + color.g + color.b) / 3.0, color.a);
+ }
+ 
  void main() {
-     gl_FragColor = texture2D(texture, gl_FragCoord.xy / resolution); +     gl_FragColor = blackAndWhite(texture2D(texture, gl_FragCoord.xy / resolution));
  } 
```

å°±æ˜¯è¿™æ ·ï¼

å±å¹•å¤–æ¸²æŸ“(æ¸²æŸ“åˆ°çº¹ç†)å¯ç”¨äºåº”ç”¨ä¸åŒçš„â€œåæœŸâ€æ•ˆæœï¼Œå¦‚æ¨¡ç³Šã€ç›¸æœºä¸Šçš„æ°´ç­‰ã€‚æ˜å¤©æˆ‘ä»¬å°†å­¦ä¹ å±å¹•å¤–æ¸²æŸ“çš„å¦ä¸€ä¸ªæœ‰ç”¨çš„ç”¨ä¾‹

æ„Ÿè°¢é˜…è¯»ï¼ğŸ‘‹

* * *

[![GitHub stars](../Images/7a62e6572a80bbc8913957ac9042103e.png)](https://github.com/lesnitsky/webgl-month)
[![Twitter Follow](../Images/a66003765b1d742c03ff459eb1614ef8.png)T6ã€‘](https://twitter.com/lesnitsky_a)

[åŠ å…¥é‚®ä»¶åˆ—è¡¨](http://eepurl.com/gwiSeH),è®©æ–°é‚®ä»¶ç›´æ¥è¿›å…¥ä½ çš„æ”¶ä»¶ç®±

[æ­¤å¤„æä¾›æºä»£ç ](https://github.com/lesnitsky/webgl-month)

å»ºé€ äº

[![Git Tutor Logo](../Images/4a5fcbd1126401b65ca7fbe362404aa0.png)T2ã€‘](https://github.com/lesnitsky/git-tutor)