# ä½¿ç”¨ GitLab CI å°† Laravel éƒ¨ç½²åˆ° AWS Beanstalk(åŒ…æ‹¬æµ‹è¯•å’Œè¯•è¿è¡Œ/ç”Ÿäº§åˆ†æ”¯)

> åŸæ–‡:[https://dev . to/mjsarfatti/deploy-laravel-to-AWS-beanstalk-with-gitlab-ci-including-testing-and-staging-production-branches-f8g](https://dev.to/mjsarfatti/deploy-laravel-to-aws-beanstalk-with-gitlab-ci-including-testing-and-staging-production-branches-f8g)

*ç‹å¾·Â·å¤æ™®å¡”åœ¨ Unsplash ä¸Šæ‹æ‘„çš„ç…§ç‰‡*

è¿™æ˜¯ä¸€ç¯‡æ•™ç¨‹ï¼Œè®²è¿°äº†ä¸€å¤©æ™šä¸Šæˆ‘å¼€å§‹ç®€åŒ–æˆ‘çš„éƒ¨ç½²è¿‡ç¨‹ï¼Œå‡ ä¸ªå°æ—¶åå‡Œæ™¨ 4 ç‚¹æˆ‘å‘ç°è‡ªå·±åœ¨æ„å»ºæ–°çš„ docker æ˜ åƒã€‚å¸Œæœ›å®ƒåŒ…å«æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œå¯¹äºé‚£äº›æ­£åœ¨ä¸ºä½ çš„ Laravel åº”ç”¨ç¨‹åºè®¾ç½® CI/CD çš„äººæ¥è¯´ï¼Œè¿™æ ·ä½ å°±ä¸ç”¨åƒæˆ‘ä¸€æ ·ç†¬å¤œäº†ã€‚

## æˆ‘ä»¬æƒ³è¦å®Œæˆçš„äº‹æƒ…

å¾ˆç®€å•ï¼Œæ¯æ¬¡æ¨é€è‡³`master`æˆ–`staging`æ—¶ï¼Œphpunit æµ‹è¯•éƒ½ä¼šè‡ªåŠ¨è¿è¡Œã€‚

æ­¤å¤–ï¼Œå¦‚æœåˆ†æ”¯`staging`ä¸Šçš„æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ï¼Œåº”ç”¨ç¨‹åºå°†è‡ªåŠ¨éƒ¨ç½²åˆ° Elastic Beanstalkã€‚

æˆ‘å°†`master`åˆ†æ”¯éƒ¨ç½²ä¿ç•™ä¸ºâ€œæ‰‹åŠ¨â€,å› ä¸ºæˆ‘ä¸å¸Œæœ›åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ„å¤–åœ°éƒ¨ç½²ä¸€ä¸ªæ–°ç‰¹æ€§ã€‚

## [](#requirements)è¦æ±‚

æˆ‘è¯•å›¾è®©è¿™ç¯‡æ–‡ç« ç®€æ˜æ‰¼è¦ï¼Œä¸ºæ­¤ï¼Œå¸Œæœ›æ‚¨å·²ç»å‡†å¤‡å¥½äº†ä»¥ä¸‹å†…å®¹(å¦‚æœæ‚¨æ²¡æœ‰ï¼Œä¸è¦æ‹…å¿ƒï¼Œè¯·å°†è¿™ç¯‡æ–‡ç« åŠ å…¥ä¹¦ç­¾ï¼Œç¨åå†æ¥çœ‹):

1.  ä¸€ä¸ªåœ¨æ‚¨çš„æœ¬åœ°ç¯å¢ƒä¸­å·¥ä½œçš„ Laravel åº”ç”¨ç¨‹åºï¼Œå®ƒåœ¨ GitLab ä¸Šæœ‰ git å­˜å‚¨åº“ï¼Œæœ‰ä¸¤ä¸ªåˆ†æ”¯:`master`å’Œ`staging`(åˆ°ç›®å‰ä¸ºæ­¢éƒ½å¾ˆæ ‡å‡†)
2.  AWS Elastic Beanstalk ä¸Šçš„ä¸¤ä¸ªé…ç½®å’Œè¿è¡Œç¯å¢ƒ(æ‚¨å¯èƒ½å¸Œæœ›å®ƒä»¬åœ¨åŒä¸€ä¸ª Beanstalk åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘å‘ç°æœ¬æŒ‡å—å¯¹æœ¬éƒ¨åˆ†éå¸¸æœ‰ç”¨)
3.  æ‚¨çš„ AWS å¸æˆ·ä¸­çš„ IAM ç”¨æˆ·ï¼Œæ‹¥æœ‰ Elastic Beanstalk å®Œå…¨è®¿é—®æƒé™(æˆ‘ä»¬å°†éœ€è¦è¯¥ç”¨æˆ·çš„è®¿é—®/å¯†é’¥ï¼Œ*ç¡®ä¿æ‚¨å°†å®ƒä»¬è®°åœ¨æŸä¸ªåœ°æ–¹*
4.  è¯´æ˜ä½ å·²ç»å®‰è£…äº†[EB CLI](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli3-install.html)T3ã€‘å’Œ ran `eb init`

## [](#0-a-bad-default)0ã€‚ä¸¥é‡è¿çº¦

å¦‚æœä½ å·²ç»è¿è¡Œäº†`eb init`ï¼Œä½ ä¼šæ³¨æ„åˆ°ç°åœ¨æœ‰ä¸€ä¸ªåä¸º`.elasticbeanstalk`çš„æ–‡ä»¶å¤¹ã€‚è¿™ä¸ªæ–‡ä»¶å¤¹å¯¹äº GitLab æ¥è¯´æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œä½†æ˜¯ç”±äºæŸç§åŸå› ï¼Œè¿™ä¸ªå‘½ä»¤ä¹Ÿåœ¨ä½ çš„`.gitignore`ä¸­æ·»åŠ äº†å‡ è¡Œï¼Œè¿™ä½¿å¾— GitLab æ— æ³•å®Œæˆå®ƒçš„å·¥ä½œã€‚å¦‚æœä½ åœ¨ä½ çš„`.gitignore` :
é‡Œçœ‹åˆ°è¿™æ ·çš„ä¸œè¥¿

```
# Elastic Beanstalk Files
.elasticbeanstalk/*
!.elasticbeanstalk/*.cfg.yml
!.elasticbeanstalk/*.global.yml 
```

ç»§ç»­åˆ é™¤è¿™äº›è¡Œã€‚

## [](#1-getting-started)1ã€‚å…¥é—¨æŒ‡å—

è®©æˆ‘ä»¬ä»è¿‡ç¨‹çš„ç»“å°¾å¼€å§‹ï¼Œåªæ˜¯ä¸ºäº†å¢åŠ ä¸€ç‚¹è¶£å‘³ã€‚

åœ¨ Laravel åº”ç”¨ç¨‹åºçš„æ¯æ¬¡éƒ¨ç½²ä¹‹å(å¯¹äºä»»ä½•æœåŠ¡å™¨è®¾ç½®éƒ½æ˜¯å¦‚æ­¤ï¼Œä¸ä»…ä»…æ˜¯ EB ),æˆ‘ä»¬éœ€è¦ç¡®ä¿æˆ‘ä»¬çš„ remote (gitignored) `/vendor`æ–‡ä»¶å¤¹åŒ…å«æ‰€æœ‰éœ€è¦çš„åŒ…ï¼Œå¹¶ä¸”è¿œç¨‹æ•°æ®åº“çš„ç»“æ„æ˜¯æœ€æ–°çš„ã€‚è¿™æ˜¯é€šè¿‡è¿è¡Œä¸¤ä¸ªå‘½ä»¤æ¥å®Œæˆçš„:`$ composer install`å’Œ`$ php artisan migrate`ã€‚

æ­¤å¤–ï¼Œåœ¨æˆ‘ä»¬çš„ç‰¹å®šè®¾ç½®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ EB æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ˜¯ä»æ–‡ä»¶å¤¹`/public`ä¸­æä¾›çš„ï¼Œç”±äº SSL æ˜¯**é“å¾·ä¸Šå¼ºåˆ¶çš„**ï¼Œç°åœ¨æˆ‘ä»¬å¯èƒ½è¿˜æƒ³å‘Šè¯‰ Apache å°†æ‰€æœ‰ *http* è¯·æ±‚é‡å®šå‘åˆ° *https* ã€‚

è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„è®¾ç½®ï¼Œåº”è¯¥å¯ä»¥å¾ˆå¥½åœ°ä¸º 98%çš„é¡¹ç›®å·¥ä½œã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ *ssh* è¿›å…¥è¿œç¨‹æœºå™¨å¹¶è¿è¡Œä¸€äº›å‘½ä»¤ï¼Œä½†å¹¸è¿çš„æ˜¯ï¼ŒElastic Beanstalk ä¸ºæˆ‘ä»¬æä¾›äº†é…ç½®æ–‡ä»¶(ä¸€ç»„ä½äº`.ebextensions`æ–‡ä»¶å¤¹ä¸­çš„ YAML æ–‡ä»¶ï¼ŒæŒ‡ç¤º AWS ä¸Šçš„è¿œç¨‹æœåŠ¡å™¨åœ¨éƒ¨ç½²å‰åè¿è¡ŒæŸäº›å‘½ä»¤),è¿™äº›æ–‡ä»¶éå¸¸é€‚åˆæˆ‘ä»¬çš„ CI/CD å·¥ä½œæµã€‚

æ¬¢è¿æ‚¨æ¢ç´¢å®˜æ–¹æ–‡æ¡£ï¼Œä½†å†æ¬¡å¹¸è¿çš„æ˜¯ï¼Œæ‚¨çœŸçš„åœ¨ GitHub ä¸Šå‘å¸ƒäº†æ‰€éœ€çš„æ–‡ä»¶ä¾›æ‚¨é˜…è¯»ã€‚

åœ¨æ‚¨çš„é¡¹ç›®è¿è¡Œçš„æ ¹ç›®å½•ä¸­:

```
$ svn export https://github.com/mjsarfatti/laravel-eb-gitlab-ci/trunk/.ebextensions 
```

è¿™å°†åˆ›å»ºä¸€ä¸ª`.ebextensions`æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æœ‰å››ä¸ªæ–‡ä»¶ã€‚è¯·éšæ„æ£€æŸ¥è¿™äº›æ–‡ä»¶ï¼Œæ³¨æ„æˆ‘å·²ç»åœ¨å…¶ä¸­æ·»åŠ äº†ä¸€äº›å¥½ä¸œè¥¿ã€‚

## [](#2-the-gitlab-yaml)2ã€‚å‰æ³°å®éªŒå®¤ YAML

ä¸ºäº†æŒ‡å¯¼ GitLab åœ¨éƒ¨ç½²æœŸé—´å¦‚ä½•è¿è¡Œä»¥åŠè¿è¡Œä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå¹¶æäº¤ä¸€ä¸ª`.gitlab-ci.yml`æ–‡ä»¶ã€‚GitLab CI å¦‚ä½•å·¥ä½œè¶…å‡ºäº†æœ¬æ•™ç¨‹çš„èŒƒå›´ï¼Œä½†æ˜¯æ–‡ä»¶æœ¬èº«æ˜¯ä¸è¨€è‡ªæ˜çš„ã€‚

å°†å…¶æ·»åŠ åˆ°æ‚¨çš„é¡¹ç›®:

```
$ svn export https://github.com/mjsarfatti/laravel-eb-gitlab-ci/trunk/.gitlab-ci.yml 
```

ç„¶åæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œç¡®ä¿å°†å˜é‡`MYSQL_DATABASE`è®¾ç½®ä¸ºæ‚¨çš„æµ‹è¯•æ•°æ®åº“åç§°(æ‚¨å¯èƒ½ä¼šåœ¨æ‚¨çš„`phpunit.xml`æ–‡ä»¶ä¸­æ‰¾åˆ°å®ƒ)ã€‚

### [](#a-useful-bit-to-know)æœ‰ç”¨ä¸€ç‚¹å°±çŸ¥é“ğŸ

æœ‰æ—¶ï¼Œå³ä½¿æµ‹è¯•å¤±è´¥ï¼Œæ‚¨ä¹Ÿå¯èƒ½æƒ³è¦éƒ¨ç½²(ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ­£åœ¨æµ‹è¯•éƒ¨ç½²æœ¬èº«)ã€‚æˆ–è€…æ‚¨å¸Œæœ›è¿›è¡Œç®€å•çš„ç¼–è¾‘(æ¯”å¦‚è‡ªè¿°æ–‡ä»¶æˆ–è­¦å‘Šæ¶ˆæ¯ä¸­çš„é”™åˆ«å­—),å¹¶ä¸”ä¸å¸Œæœ›å°†å®è´µçš„ CI æ—¶é—´ç”¨äºæ— ç”¨çš„æµ‹è¯•ã€‚

æˆ‘ä»¬çš„`.gitlab-ci.yml`æœ‰ä¸€ä¸ªå‹å¥½çš„è§„åˆ™ï¼Œå¦‚æœæäº¤æ¶ˆæ¯åŒ…å«çŸ­è¯­`[skip tests]`(æˆ–è€…ç±»ä¼¼äº`[skip test]`æˆ–`[skip-tests]`çš„å˜ä½“)ï¼Œå®ƒå°†è·³è¿‡æµ‹è¯•ã€‚

## [](#3-setting-up-gitlab-ci-for-success)3ã€‚ä¸ºæˆåŠŸè®¾ç½® GitLab CI

ç™»å½•ä½ çš„ GitLab è´¦æˆ·ï¼Œåœ¨ä½ çš„é¡¹ç›®çš„*è®¾ç½®* > *CI / CD* ä¸­æ·»åŠ ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªåä¸º`AWS_ACCESS_KEY_ID` withï¼Œä½ çŸ¥é“äº†ï¼Œä½ çš„ IAM ç”¨æˆ·è®¿é—®å¯†é’¥ idï¼Œå¦ä¸€ä¸ªåä¸º`AWS_SECRET_ACCESS_KEY` with...ä½ çŸ¥é“å—ï¼Ÿ

è¿™å°±æ˜¯ğŸ¥³

æ¨å¼€å®ƒï¼Œäº«å—ä½ åº”å¾—çš„å†…å¿ƒå¹³é™ã€‚

## å“¦ï¼Œæˆ‘å·®ç‚¹å¿˜äº†

ä½ å¯èƒ½ä¼šé—®ï¼Œæˆ‘æ˜¯å¦‚ä½•èŠ±äº†ä¸€æ•´æ™šæ¥æ„å»º docker å›¾åƒçš„ï¼Ÿ

è¿™ä¸€åˆ‡éƒ½æ˜¯ä»æˆ‘å‘ç°çˆ±å¾·åå¤šÂ·æ¯”æ‰ç½—çš„è¿™äº›æƒŠäººçš„ Docker å›¾ç‰‡å¼€å§‹çš„ï¼Œè¿™äº›å›¾ç‰‡é¢„å…ˆé…ç½®äº† PHPã€Composerã€Node å’Œ Yarnï¼Œå¯ç”¨äº PHP 7.1ã€7.2 å’Œ 7.3:[https://github.com/edbizarro/gitlab-ci-pipeline-php/](https://github.com/edbizarro/gitlab-ci-pipeline-php/)

æˆ‘æƒ³ï¼Œè¿™å¤ªç–¯ç‹‚äº†(ä»ç„¶åªæœ‰æ™šä¸Š 11 ç‚¹)ï¼Œæˆ‘ä¼šæŠŠè¿™äº›éƒ½è®°åœ¨æˆ‘çš„`.gitlab-ci.yml`é‡Œï¼Œç„¶åå°±åˆ°æ­¤ä¸ºæ­¢ã€‚

LOLã€‚

è¿™äº›å›¾åƒä¸åŒ…æ‹¬`eb`(ä¸ºä»€ä¹ˆä¼šåŒ…æ‹¬å®ƒä»¬)ã€‚æ‰€ä»¥æˆ‘è¯•ç€å®‰è£…äº†å®ƒã€‚ä½†æ˜¯`eb`éœ€è¦`pip`ï¼Œ`pip`éœ€è¦å‡ ä¸ªè¯¡å¼‚çš„ Python åŒ…ã€‚åªæ˜¯`apt-get`ï¼Œå¯¹å—ï¼Ÿä¸å¯¹ã€‚

è¿™äº›å›¾åƒä¸èƒ½åœ¨æ ¹ç”¨æˆ·ä¸Šè¿è¡Œ(æˆ‘çŒœè¿™æ˜¯ä¸€ä¸ªåˆç†çš„é»˜è®¤è®¾ç½®ï¼Ÿ)ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘åœ¨ CI æœŸé—´ä¸èƒ½å®‰è£…ä»»ä½•åŒ…ã€‚æˆ‘çŸ¥é“è¦èµ°çš„è·¯æ˜¯åˆ†å‰é¡¹ç›®ï¼Œæ½œå…¥ä»–ä»¬çš„ docker æ–‡ä»¶ï¼Œå¹¶æ ¹æ®æˆ‘çš„éœ€è¦å®šåˆ¶å®ƒã€‚ä½†æˆ‘ä»¥å‰å‡ ä¹æ²¡æœ‰ç”¨è¿‡ Dockerï¼Œæˆ‘ä¸å–œæ¬¢åœ¨æ·±å¤œå¼€å§‹æ–°çš„å†’é™©(æœ‰è¶£ï¼Œå—¯ï¼Ÿ).

æ‰€ä»¥æˆ‘æŠ—äº‰ï¼ŒæŠ—äº‰ï¼ŒæŠ—äº‰ã€‚æˆ‘å°è¯•äº†å®ƒä»¬é™„å¸¦çš„æ‰€æœ‰ 3 ä¸ª Linux å‘è¡Œç‰ˆï¼Œå¹¶ä¸”å°è¯•äº†æ‰€æœ‰ä¸åŒçš„æ–¹æ³•æ¥å®‰è£…`eb`ï¼ŒåŒ…æ‹¬åœ¨æœ¬åœ°æ–‡ä»¶å¤¹ä¸­å®‰è£…æ‰€æœ‰çš„å·¥å…·ã€‚ä»€ä¹ˆéƒ½æ²¡ç”¨ã€‚

æ‰€ä»¥ç°åœ¨æ˜¯å‡Œæ™¨ 3 ç‚¹ï¼Œæˆ‘é¢ä¸´ç€ä¸€ä¸ªç®€å•çš„é€‰æ‹©:æˆ‘æ˜¯åº”è¯¥å»ç¡è§‰ä¼‘æ¯ï¼Œè¿˜æ˜¯è¿™æ˜¯æˆ‘ç”Ÿå‘½ä¸­çš„ä¸€åœºæˆ˜æ–—ï¼Ÿ

ä½ å¯ä»¥æƒ³è±¡å‘ç”Ÿäº†ä»€ä¹ˆã€‚

æˆ‘æ‰“å¼€äº†[https://hub.docker.com/](https://hub.docker.com/)ï¼Œç ”ç©¶äº†æ¯”æ‰ç½—çš„å›è´­ï¼Œç ”ç©¶äº†å¦‚ä½•å¼€å§‹ï¼Œä½ ç§ï¼Œä¸€ä¸ªå°æ—¶åæˆ‘å°±æœ‰äº†:

*   æˆåŠŸåœ°é‡æ–°é…ç½®äº†æ¯”æ‰ç½—çš„æ˜ åƒä»¥å®‰è£… EBCliã€AWSCli å’Œ CLI53(ä¸ºä»€ä¹ˆä¸å‘¢)
*   å‘ Docker å‘å¸ƒæ–°å›¾åƒ
*   æˆåŠŸåœ°ä½¿ç”¨æˆ‘çš„ç¬¬ä¸€ä¸ªæ–° Docker æ˜ åƒå°†æˆ‘çš„ Laravel åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Elastic BeanstalkğŸ‰ğŸ‰ğŸ‰

æ‰€ä»¥å¦‚æœä½ æ³¨æ„åˆ°åœ¨æˆ‘ä»¬çš„`.gitlab-ci.yml`æ–‡ä»¶ä¸­æˆ‘ä»¬ä½¿ç”¨äº†`image: mjsarfatti/gitlab-ci-pipeline-php-aws:latest`ã€‚

è¯·æ³¨æ„:è¿™æ˜¯ä¸€ä¸ªåŸºäº PHP 7.2 Debian çš„å›¾åƒã€‚ä¸èƒ½å®‰è£…åŒ…ã€‚æ²¡æœ‰ç»è¿‡å½»åº•çš„æµ‹è¯•ã€‚ä½†è¿™å¾ˆæœ‰æ•ˆã€‚

## [](#big-thanks-to)å¤§æ‹œ

ä¸€å¦‚æ—¢å¾€ï¼Œå¦‚æœä¸æ˜¯æ˜¨æ™šé™ªä¼´æˆ‘çš„ææ–™ã€è½¯ä»¶å’Œæ•™ç¨‹ï¼Œæˆ‘å°†ä¸ä¼šæœ‰ä»Šå¤©çš„æˆå°±ã€‚æ’åä¸åˆ†å…ˆåï¼Œå¤§æ‹œ:

*   [https://github.com/edbizarro/gitlab-ci-pipeline-php/](https://github.com/edbizarro/gitlab-ci-pipeline-php/)
*   [https://medium . com/@ thimblot/deploying-a-flask-application-on-AWS-with-git lab-ci-CD-part-2-a 175 DC 132950](https://medium.com/@thimblot/deploying-a-flask-application-on-aws-with-gitlab-ci-cd-part-2-a175dc132950)
*   [https://medium . com/dowebthings/how-to-deploy-from-git lab-to-elastic-beanstalk-AWS-cdac7b 701004](https://medium.com/dowebthings/how-to-deploy-from-gitlab-to-elastic-beanstalk-aws-cdac7b701004)
*   [https://blog . powerupcloud . com/deploy-python-application-on-AWS-elastic beanstalk-using-git lab-runner-8982 FB 26 E4 a4](https://blog.powerupcloud.com/deploy-python-application-on-aws-elasticbeanstalk-using-gitlab-runner-8982fb26e4a4)
*   [https://github . com/spiritix/lumen-AWS-git lab-continuous-deployment](https://github.com/spiritix/lumen-aws-gitlab-continuous-deployment)
*   [https://github.com/Cox-Automotive/aws-ebcli](https://github.com/Cox-Automotive/aws-ebcli)
*   [https://github.com/rennokki/laravel-aws-eb](https://github.com/rennokki/laravel-aws-eb)

å¦‚æœæœ¬æŒ‡å—å¯¹æ‚¨æœ‰ç”¨ï¼Œæˆ–è€…æ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ä¸‹é¢è¯„è®ºï¼T3ã€‘

<small>-ç¼–è¾‘-
å¢åŠ äº† rennokki/laravel-aws-eb é“¾æ¥</small>