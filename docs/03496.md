# Engarde:åƒå† å†›ä¸€æ ·è§£æ Envoy å’Œ istio-proxy æ—¥å¿—

> åŸæ–‡:[https://dev . to/nitishm/engarde-parse-envoy-and-istio-proxy-logs-like-a-champ-219m](https://dev.to/nitishm/engarde-parse-envoy-and-istio-proxy-logs-like-a-champ-219m)

# [](#envoy-proxy)ç‰¹ä½¿ä»£ç†

[![Alt Envoy Logo](img/b98a449f31d4b3667e3eaee6fda334f8.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--GHmMN7-S--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://raw.githubusercontent.com/envoyproxy/artwork/master/PNG/Envoy_Logo_Final_PANTONE.png)

[Envoy](https://www.envoyproxy.io/) æ˜¯ä¸€æ¬¾ç°ä»£ã€é«˜æ€§èƒ½ã€å°å°ºå¯¸çš„å¼€æºè¾¹ç¼˜å’ŒæœåŠ¡ä»£ç†ï¼Œä¸“ä¸ºäº‘åŸç”Ÿåº”ç”¨è€Œè®¾è®¡ã€‚æœ€åˆæ˜¯åœ¨ Lyft ç¼–å†™å’Œéƒ¨ç½²çš„ï¼ŒEnvoy å·²ç»æˆä¸ºå„ç§æœåŠ¡ç½‘æ ¼çš„é¦–é€‰ä»£ç†ï¼ŒåŒ…æ‹¬æ›´å—æ¬¢è¿çš„ Istio æœåŠ¡ç½‘æ ¼ã€‚

# [](#istio-service-mesh)Istio æœåŠ¡ç½‘æ ¼

ç”±è°·æ­Œã€IBM å’Œ Lyft åˆä½œå¼€å‘çš„, [Istio](https://istio.io/) æ˜¯ä¸€ä¸ªå¼€æºæœåŠ¡ç½‘æ ¼ï¼Œå®ƒå…è®¸æ‚¨è¿æ¥ã€ç›‘æ§å’Œä¿æŠ¤éƒ¨ç½²åœ¨å†…éƒ¨ã€äº‘ä¸­æˆ–ä¸ Kubernetes ç­‰ç¼–æ’å¹³å°ä¸€èµ·éƒ¨ç½²çš„å¾®æœåŠ¡ã€‚

Istio ä½¿ç”¨ Envoy sidecar proxies(åˆå istio-proxy)ä½œä¸ºå…¶æ•°æ®å¹³é¢ã€‚åœ¨ Kubernetes ä¸­ï¼Œè¿™äº›ä»£ç†è¢«éƒ¨ç½²ä¸ºæ‰€æœ‰å‚ä¸ pod ä¸­çš„ sidecar(æ‰‹åŠ¨æˆ–è‡ªåŠ¨ä½¿ç”¨ sidecar æ³¨å…¥),å¹¶è¢«ç¼–ç¨‹ä¸ºé€šè¿‡ iptable é‡å®šå‘æ‹¦æˆªæ‰€æœ‰å…¥ç«™å’Œå‡ºç«™æµé‡ã€‚

# [](#envoy-access-logs)ç‰¹ä½¿è®¿é—®æ—¥å¿—

ç‰¹ä½¿ä»£ç†æä¾›äº†ä¸€ç§å¯é…ç½®çš„è®¿é—®æ—¥å¿—è®°å½•æœºåˆ¶ã€‚è¿™äº›è®¿é—®æ—¥å¿—æä¾›äº†å¤§é‡ä¿¡æ¯ï¼Œå¯ç”¨äºè§£å†³é—®é¢˜ã€‚

å¤§å¤šæ•°ç‰¹ä½¿ä»£ç†éƒ¨ç½²ä½¿ç”¨é»˜è®¤çš„æ—¥å¿—æ ¼å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œ

```
[%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
%RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION%
%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%"
"%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"\n 
```

è¿™å°†äº§ç”Ÿå¦‚ä¸‹æ—¥å¿—è¡Œï¼Œ

```
[2016-04-15T20:17:00.310Z] "POST /api/v1/locations HTTP/2" 204 - 154 0 226 100 "10.0.35.28"
"nsq2http" "cc21d9b0-cf5c-432b-8c7e-98aeb7988cd2" "locations" "tcp://10.0.2.1:80" 
```

è¿™äº›æ—¥å¿—ï¼Œå³ä½¿æ˜¯é»˜è®¤æ ¼å¼çš„ï¼Œ**ä¹ŸåŒ…å«äº†è®¸å¤šæœ‰ç”¨çš„ä¿¡æ¯**ï¼Œè¿™äº›ä¿¡æ¯åœ¨è°ƒè¯• L4-L7 ä»£ç†çš„é—®é¢˜æ—¶ä¼šæ´¾ä¸Šç”¨åœºã€‚

è°·æ­Œçš„ Meghan O'Keefe æœ€è¿‘å‘äº†ä¸€æ¡æ¨æ–‡ï¼Œä¸ºé»˜è®¤ç‰¹ä½¿æ—¥å¿—ä¸­çš„æ¯ä¸ªå­—æ®µæä¾›äº†ä¸€ä¸ªéå¸¸ç›´è§‚çš„è¡¨ç¤º(å¦‚ä¸‹æ‰€ç¤º)ã€‚

> ![unknown tweet media content](img/4df86d5531104635fb39c7bcb2fdc108.png)![Megan O'Keefe profile image](img/4aa5e3e638a18bf4411aa4664f408103.png)æ¢…æ ¹Â·å¥¥åŸºå¤«@ askmeegs![twitter logo](img/65e26e35707d96169ec8af6b3cbf2003.png)ä½ æœ‰æ²¡æœ‰çœ‹è¿‡ Istio çš„ä»£ç†æ—¥å¿—ï¼Œå¿ƒæƒ³:ğŸ˜±ï¼Ÿ
> 
> è¿™äº›æ˜¯ [@EnvoyProxy](https://twitter.com/EnvoyProxy) è®¿é—®æ—¥å¿—ï¼ŒåŒ…å«å¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼[envoyproxy.io/docs/envoy/latâ€¦](https://t.co/SbV75hDrON)2019 å¹´ 8 æœˆ 20:43 åˆ†- 01 åˆ†[![Twitter reply action](img/269095962147c28351274afdd5486a48.png)](https://twitter.com/intent/tweet?in_reply_to=1157029140693995521)[![Twitter retweet action](img/771160ecf06ae3d4d7a7815c29c819c2.png)](https://twitter.com/intent/retweet?tweet_id=1157029140693995521)30[![Twitter like action](img/c077611ab2a5e0b4cd0c826ee7ae1e48.png)](https://twitter.com/intent/like?tweet_id=1157029140693995521)100

é™¤äº†æ¨æ–‡ä¹‹å¤–ï¼ŒRichard Li(é¦–å¸­æ‰§è¡Œå®˜ï¼ŒDatawire -ç»™ä½ å¸¦æ¥å¤§ä½¿çš„å®¶ä¼™)çš„è¿™ç¯‡åä¸º**â€œäº†è§£ç‰¹ä½¿ä»£ç† HTTP è®¿é—®æ—¥å¿—â€**çš„[ä¸­å‹](https://medium.com/understanding-envoy-proxy-and-ambassador-http-access-logs-fee7802a2ec5)åšå®¢æä¾›äº†å…³äºé»˜è®¤æ ¼å¼æ—¥å¿—çš„æ¯ä¸ªå­—æ®µçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

å¦‚æœä½ æ›¾ç»åƒæˆ‘ä¸€æ ·å¤„ç†è¿‡è¿™äº›æ—¥å¿—ï¼Œä½ å°±ä¼šçŸ¥é“å½“è¿™äº›è¡Œä»¥å…‰é€Ÿæ»šåŠ¨æ—¶ï¼Œæ‰‹åŠ¨æœç´¢æ¯ä¸ªå­—æ®µæ˜¯å¤šä¹ˆå›°éš¾ï¼Œå°¤å…¶æ˜¯åœ¨ä¸€ä¸ªç¹å¿™çš„ç½‘ç»œä¸­ã€‚

* * *

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä½¿è¿™äº›ç¥ç§˜çš„æ—¥å¿—è¡Œæ›´æœ‰æ„ä¹‰ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œæˆ‘æƒ³æŠŠå®ƒå±•ç¤ºç»™ç¤¾åŒºã€‚

# [](#introducing-engarde)ä»‹ç»[æ©åŠ å¾·](https://github.com/nitishm/engarde)

*(Envoy + On Gaurd = Engarde...å¾—åˆ°å®ƒğŸ˜‰ï¼Ÿï¼ŸBah nevermingï¼Œæˆ‘è¯•è¿‡)*
Engarde æ˜¯ä¸€ä¸ªç”¨ Go ç¼–å†™çš„å¼€æºå®ç”¨ç¨‹åºï¼Œæœ‰å¼€æº [grok](//github.com/vjeantet/grok) åŒ…çš„(å¤§é‡)å¸®åŠ©ï¼Œå®ƒå…è®¸ä½ åƒå† å†›ä¸€æ ·è§£æ envoy è®¿é—®æ—¥å¿—ã€‚æ­¤å¤–ï¼ŒEngarde è¿˜æ”¯æŒ istio-proxy ä½¿ç”¨çš„é»˜è®¤æ ¼å¼(å¦‚ä¸‹æ‰€ç¤º)ã€‚

```
[%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% \"%DYNAMIC_METADATA(istio.mixer:status)%\" %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \"%REQ(X-FORWARDED-FOR)%\" \"%REQ(USER-AGENT)%\" \"%REQ(X-REQUEST-ID)%\" \"%REQ(:AUTHORITY)%\" \"%UPSTREAM_HOST%\" %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME%\n 
```

Engarde é€šè¿‡ STDIN é€è¡Œè¯»å– envoy æ—¥å¿—ï¼Œå°†å®ƒä»¬æ•´ç†æˆ JSON å¯¹è±¡ä»¥å¢å¼ºå¯è¯»æ€§ï¼Œå¹¶æœ€ç»ˆé€šè¿‡ STDOUT å°†å®ƒä»¬è¾“å‡ºå›ç»ˆç«¯ã€‚

## Engarde å…¥é—¨

è¦å¼€å§‹ä½¿ç”¨æ©åŠ å°”å¾·ï¼Œåªéœ€è®¿é—®[https://github.com/nitishm/engarde](https://github.com/nitishm/engarde)ï¼Œå¹¶éµå¾ª`README`ä¸­æä¾›çš„è¯´æ˜ã€‚

## [](#sample)æ ·å“

**ç‰¹ä½¿é»˜è®¤æ ¼å¼**

```
echo '[2016-04-15T20:17:00.310Z] "POST /api/v1/locations HTTP/2" 204 - 154 0 226 100 "10.0.35.28" "nsq2http" "cc21d9b0-cf5c-432b-8c7e-98aeb7988cd2" "locations" "tcp://10.0.2.1:80"' | engarde | jq 
```

```
{  "authority":  "locations",  "bytes_received":  "154",  "bytes_sent":  "0",  "duration":  "226",  "method":  "POST",  "protocol":  "HTTP/2",  "request_id":  "cc21d9b0-cf5c-432b-8c7e-98aeb7988cd2",  "response_flags":  "-",  "status_code":  "204",  "timestamp":  "2016-04-15T20:17:00.310Z",  "upstream_service":  "tcp://10.0.2.1:80",  "upstream_service_time":  "100",  "uri_path":  "/api/v1/locations",  "user_agent":  "nsq2http",  "original_message":  "[2016-04-15T20:17:00.310Z] \"POST /api/v1/locations HTTP/2\" 204 - 154 0 226 100 \"10.0.35.28\"  \"nsq2http\"  \"cc21d9b0-cf5c-432b-8c7e-98aeb7988cd2\"  \"locations\"  \"tcp://10.0.2.1:80\""  } 
```

**Istio-proxy é»˜è®¤æ ¼å¼**

```
kubectl logs -f foo-app-1 -c istio-proxy | engarde --use-istio | jq 
```

```
{  "authority":  "hello-world",  "bytes_received":  "148",  "bytes_sent":  "171",  "duration":  "4",  "method":  "GET",  "protocol":  "HTTP/1.1",  "request_id":  "c0ce81db-4f5a-9134-8a5c-f8c076c91652",  "response_flags":  "-",  "status_code":  "200",  "timestamp":  "2019-09-03T05:37:41.341Z",  "upstream_service":  "192.168.89.50:9001",  "upstream_service_time":  "3",  "upstream_cluster":  "outbound|80||hello-world.default.svc.cluster.local",  "upstream_local":  "-",  "downstream_local":  "10.97.86.53:80",  "downstream_remote":  "192.168.167.113:39953",  "uri_path":  "/index",  "user_agent":  "-",  "mixer_status":  "-",  "original_message":  "[2019-09-03T05:37:41.341Z] \"GET /index HTTP/1.1\" 200 - \"-\" 148 171 4 3 \"-\"  \"-\"  \"c0ce81db-4f5a-9134-8a5c-f8c076c91652\"  \"hello-world\"  \"192.168.89.50:9001\" outbound|80||hello-world.default.svc.cluster.local - 10.97.86.53:80 192.168.167.113:39953 -"  } 
```

æ©åŠ å¾·çš„çœŸæ­£åŠ›é‡åªæœ‰å’Œ`jq`ç»“åˆæ‰èƒ½è¢«é©¾é©­ã€‚

# ã€jq+ä½œå¼Š

`jq`æ˜¯ä¸€ä¸ªè½»é‡çº§ä¸”çµæ´»çš„å‘½ä»¤è¡Œ JSON å¤„ç†å™¨ã€‚`jq`å°±åƒæ˜¯ JSON æ•°æ®çš„`sed`â€”â€”ä½ å¯ä»¥ç”¨å®ƒæ¥åˆ†å‰²ã€è¿‡æ»¤ã€æ˜ å°„å’Œè½¬æ¢ç»“æ„åŒ–æ•°æ®ï¼Œå°±åƒ sedã€awkã€grep å’Œ friends è®©ä½ å¤„ç†æ–‡æœ¬ä¸€æ ·å®¹æ˜“ã€‚

å¦‚ä¸Šé¢çš„ä¾‹å­æ‰€ç¤ºï¼Œæœ€åŸºæœ¬çš„ï¼Œpretty å°† JSON å­—ç¬¦ä¸²æ‰“å°æˆç»ˆç«¯å¯è¯»çš„å¯¹è±¡ã€‚ç„¶è€Œï¼Œ`jq`çš„èƒ½åŠ›è¦å¤§å¾—å¤šã€‚

å› ä¸ºè¿™ç¯‡åšå®¢æ˜¯å…³äº`Engarde`çš„ï¼Œæ‰€ä»¥æˆ‘ä¸ä¼šæ·±å…¥æ¢ç©¶`jq`çš„èƒ½åŠ›(å®ƒå¾ˆå®¹æ˜“æä¾›ä¸€ä¸ªè‡ªå·±çš„å¸–å­)ã€‚
ç›¸åï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨`jq`é€šè¿‡`status_code`è¿‡æ»¤ç‰¹ä½¿è®¿é—®æ—¥å¿—ï¼Œå¹¶åªå°†å­—æ®µçš„å­é›†è¾“å‡ºåˆ° STDOUTï¼Œ

```
kubectl logs -f foo-app-1 -c istio-proxy | engarde --use-istio | jq -c 'select( .status_code = 200) | {log: .original_message, URI: .uri_path, UpstreamCluster: .upstream_cluster}' | jq 
```

```
{  "log":  "[2019-09-06T19:11:40.645Z] \"GET /v1/health/service/xyz?index=0&wait=10s HTTP/1.1\" 500 - \"-\" 0 23 0 0 \"-\"  \"Python-urllib/2.7\"  \"83484d3a-fedb-96f5-a653-1c38fa1ac2e4\"  \"10.15.12.33:8500\"  \"10.15.12.33:8500\" PassthroughCluster - 10.15.12.33:8500 192.168.89.3:34780 -",  "URI":  "/v1/health/foobar",  "UpstreamCluster":  "PassthroughCluster"  }  {  "log":  "[2019-09-06T19:11:42.218Z] \"GET /metrics HTTP/1.1\" 200 - \"-\" 0 0 1 0 \"-\"  \"Prometheus/2.9.1\"  \"e8810c98-9e10-9b2c-837e-987ec3ed3614\"  \"192.168.89.3:9001\"  \"127.0.0.1:9001\" inbound|80|foo-worker|hello-world.foo-namespace.svc.cluster.local - 192.168.89.3:9001 192.168.167.109:53458 -",  "URI":  "/metrics",  "UpstreamCluster":  "inbound|80|foo-worker|hello-world.foo-namespace.svc.cluster.local"  }  {  "log":  "[2019-09-06T19:11:47.218Z] \"GET /metrics HTTP/1.1\" 200 - \"-\" 0 0 1 0 \"-\"  \"Prometheus/2.9.1\"  \"f4cd2b2b-7202-9823-a8cd-7a150c6b5c4a\"  \"192.168.89.3:9001\"  \"127.0.0.1:9001\" inbound|80|foo-worker|hello-world.foo-namespace.svc.cluster.local - 192.168.89.3:9001 192.168.167.109:53458 -",  "URI":  "/metrics",  "UpstreamCluster":  "inbound|80|foo-worker|hello-world.foo-namespace.svc.cluster.local"  }  ...  ... 
```

# [](#fin)é³

è¯·éšæ„åˆ†äº«ä¸€äº›åé¦ˆï¼Œå¯ä»¥ç›´æ¥åˆ†äº«ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åœ¨ [Github](https://github.com/nitishm) ä¸Šå‘è¡¨ä¸€ä¸ªé—®é¢˜æ¥åˆ†äº«ã€‚å¾ˆæƒ³å¬å¬ä½ å¯¹å®ƒçš„çœ‹æ³•ï¼Œä»¥åŠä½ æ˜¯å¦å¸Œæœ›çœ‹åˆ°ä»»ä½•æ”¹è¿›ã€‚

åˆ«å¿˜äº†åœ¨ GitHub ä¸Šâ­è¿™ä¸ªé¡¹ç›®ï¼Œå¹¶åœ¨[https://github.com/nitishm](https://github.com/nitishm)å…³æ³¨æˆ‘ã€‚