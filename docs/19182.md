# æ„å»ºå¯é‡ç”¨çš„æµ‹è¯•æŸ¥è¯¢

> åŸæ–‡:[https://dev . to/Jon majorc/build-reusable-testing-queries-27 m1](https://dev.to/jonmajorc/build-reusable-testing-queries-27m1)

è¿™ç¯‡æ–‡ç« çš„çµæ„Ÿæ¥è‡ªäºä¸¤å‘¨å‰æˆ‘é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼›æˆ‘ç¼–å†™äº†ä¸ React Material UI ä¸­çš„`Select`ç»„ä»¶äº¤äº’çš„è„†æ€§æµ‹è¯•ã€‚é‚£å¤©èŠ±äº†å¾ˆå¤šæ—¶é—´å°è¯•äº†å¾ˆå¤šè§£å†³æ–¹æ¡ˆåï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªä»¤æˆ‘æ»¡æ„çš„æ–¹æ¡ˆ...è¿™å°±æ˜¯æˆ‘ä»Šå¤©è¦åˆ†äº«çš„è§£å†³æ–¹æ¡ˆï¼

**TLDRï¼›é€šè¿‡å…±äº«å¯é‡ç”¨çš„ DOM æŸ¥è¯¢ï¼Œä¿æŒæµ‹è¯•åº“çš„å¯ç»´æŠ¤æ€§å’Œä¸æ˜“ç¢æ€§ã€‚è®¿é—®ç¬¬ä¸‰æ–¹ç»„ä»¶çš„â€œæŠ½è±¡ç»†èŠ‚â€çš„æ¨¡å¼å¯èƒ½ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œæ”¹å˜ï¼Œä½†æ˜¯æ›´æ–°å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œã€‚**

## [](#the-problem)é—®é¢˜

æˆ‘æƒ³ç¼–å†™å¯ç»´æŠ¤çš„æµ‹è¯•ï¼Œå¹¶ä¸”ç±»ä¼¼äºæˆ‘çš„è½¯ä»¶è¢«ä½¿ç”¨çš„æ–¹å¼ã€‚è¿™æ„å‘³ç€æˆ‘éœ€è¦åœ¨ç»„ä»¶ä¸­æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’ï¼ŒåŒ…æ‹¬ä»»ä½•ç¬¬ä¸‰æ–¹ç»„ä»¶ã€‚ç„¶è€Œ...

1.  æ•°æ®å±æ€§ä¸èƒ½å‡ºç°åœ¨ç¬¬ä¸‰æ–¹ç»„ä»¶ä¸­ã€‚
2.  æ•°æ®å±æ€§ä¸èƒ½å‡ºç°åœ¨ç¬¬ä¸‰æ–¹ç»„ä»¶å†…çš„é¢„æœŸå…ƒç´ ä¸Šã€‚

æˆ‘éå¸¸å–œæ¬¢æ•°æ®æµ‹è¯•ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶æ—¶ï¼Œæˆ‘ä¸èƒ½æ€»æ˜¯ä¾èµ–å®ƒä»¬ã€‚

**å¿«é€Ÿé è¾¹:ææ–™`Select`ç»„ä»¶ä½¿ç”¨`react-select`ã€‚è¿™ç¯‡æ–‡ç« åªä¼šåœ¨ä¸€ä¸ªè™šæ„çš„ä¾‹å­ä¸­ä½¿ç”¨`react-select`...**

ç»è¿‡ä¸€äº›è°ƒè¯•ï¼Œæˆ‘åœ¨`react-select`å†…éƒ¨çš„`input`æ ‡ç­¾ä¸Šå‘ç°äº†ä¸€ä¸ª`id`ã€‚

```
<input
  aria-autocomplete="list"
  autocapitalize="none"
  autocomplete="off"
  autocorrect="off"
  id="react-select-2-input" {/* That's helpful! */}
  spellcheck="false"
  style="box-sizing: content-box; width: 2px; border: 0px; font-size: inherit; opacity: 1; outline: 0; padding: 0px;"
  tabindex="0"
  type="text"
  value=""
/> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡æŸ¥è¯¢`id`è¿›è¡Œæµ‹è¯•åï¼Œæˆ‘å‘ç°å®ƒä¼šæ ¹æ®é¡µé¢ä¸Šå‘ˆç°çš„ Select ç»„ä»¶çš„æ•°é‡è€Œå¢åŠ ã€‚æˆ‘ä¸ä¼šç›¸ä¿¡è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• idï¼è¿™å¯èƒ½éšæ—¶æ”¹å˜ï¼Œå¯¼è‡´çº§è”æµ‹è¯•å¤±è´¥ã€‚ä¸€ä¸ªå¥½çš„ç»éªŒæ³•åˆ™æ˜¯ä¸ºæµ‹è¯•ä¿ç•™ä¸€ä¸ª idã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨è¾“å…¥ä¸­ä½¿ç”¨æ•°æ®å±æ€§æˆ–è¿™ä¸ª`id`...æˆ‘å®æ„¿åœ¨ç»„ä»¶çš„æ ¹æ ‡ç­¾ä¸Šæœ‰ä¸€ä¸ª`id`;ç„¶åæˆ‘å¯ä»¥æŸ¥è¯¢ç»„ä»¶å†…éƒ¨çš„ä»»ä½•å†…å®¹...åŸæ¥ï¼Œæˆ‘å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼

*â€œè¿™é‡Œæ˜¯ä¸€ä¸ªçƒ­ç‚¹â€*ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶åŒ…ä¸å…è®¸æ•°æ®å±æ€§ï¼Œè¯·é˜…è¯»æ–‡æ¡£å¹¶äº†è§£ä»€ä¹ˆå¯ä»¥ä½œä¸ºæ›¿ä»£å“ä¼ é€’ã€‚å¯èƒ½ä¼šæœ‰ä¸€ä¸ª`id`ä¹‹ç±»çš„ï¼Œå¯ä»¥æ›´åä¸ºæµ‹è¯• idã€‚å°±æˆ‘è€Œè¨€ï¼Œæˆ‘å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚åœ¨æˆ‘è®¾è®¡çš„ä¾‹å­ä¸­ï¼Œæˆ‘å¯ä»¥åˆ›å»ºæˆ‘è‡ªå·±çš„å†…éƒ¨`Select`ç»„ä»¶ï¼Œç”¨å¿…éœ€çš„`dataTestId`å±æ€§é‡æ–°å¼•å…¥`react-select`ã€‚ç°åœ¨æˆ‘å¯ä»¥ä½¿ç”¨æˆ‘çš„å†…éƒ¨ç»„ä»¶ï¼Œå®ƒæœ‰ä¸€ä¸ª**å¯ä¿¡çš„**æµ‹è¯• idã€‚

```
// Select.js
import ReactSelect from 'react-select'
import React from 'react'
import PropTypes from 'prop-types'

function Select({ dataTestId, ...props }) {
  return <ReactSelect {...props} id={dataTestId} />
}

Select.propTypes = {
  dataTestId: PropTypes.string.isRequired,
}

export default Select 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#the-solution)è§£

è®©æˆ‘ä»¬ç»§ç»­ä¸€äº›å¥½çš„æ—§æ—¶å°šâ€œæ¥å—æ ‡å‡†ã€‚â€

*   æˆ‘åœ¨`Select`ç»„ä»¶çš„è¾“å…¥å­—æ®µä¸­çœ‹åˆ°æˆ‘é€‰æ‹©çš„å€¼
*   æˆ‘åœ¨`Select`ç»„ä»¶çš„æ­£ä¸‹æ–¹çš„`span` **ä¸­çœ‹åˆ°æˆ‘é€‰æ‹©çš„å€¼**

è¿™æ˜¯ä¸€ä¸ªç¬¦åˆéªŒæ”¶æ ‡å‡†çš„å·¥ä½œç¤ºä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æµ‹è¯•æ¥ç¡®ä¿æˆ‘ä»¬åœ¨ç”Ÿäº§ä¸­é¿å…é€€åŒ–ï¼

```
import React from 'react'
import Select from './Select'

const options = [
  { value: 'chocolate', label: 'Chocolate' },
  { value: 'strawberry', label: 'Strawberry' },
  { value: 'vanilla', label: 'Vanilla' },
]

function App() {
  const [selectedOption, setSelectedOption] = React.useState({})

  return (
    <div>
      <Select
        dataTestId="select-ice-cream"
        value={selectedOption}
        onChange={valSelected => setSelectedOption(valSelected)}
        options={options}
      />
      <span data-testid="select-ice-cream-selected">You selected {selectedOption.value}</span>
    </div>
  )
}

export default App 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæˆ‘ä»¬è¦æ£€æŸ¥ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå®ƒé‡Œé¢æœ‰å¾ˆå¤š`div`ä¹‹ç±»çš„ä¸œè¥¿ã€‚å¾ˆå¤šæˆ‘ä»¬ä¸å…³å¿ƒçš„â€œæŠ½è±¡ç»†èŠ‚â€ã€‚æµ‹è¯•ä¸€ä¸ªæœªå°è£…çš„ç¬¬ä¸‰æ–¹ç»„ä»¶å¯èƒ½ç›¸å½“å›°éš¾ï¼Œä½†æ˜¯è¿™æ ·åšè®©æˆ‘å¯¹åº”ç”¨ç¨‹åºæ­£å¸¸å·¥ä½œæœ‰äº†æ›´å¤§çš„ä¿¡å¿ƒã€‚å¥½å§ï¼Œæ—¢ç„¶æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨`data-testid`ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ä½¿ç”¨ React æµ‹è¯•åº“ä¸­çš„`queryByTestId`é€‰æ‹©å™¨ã€‚æˆ‘å°†ä½¿ç”¨ DOM `querySelector`æ¥ä»£æ›¿...

```
it('renders without crashing', () => {
  const { container, debug } = render(<App />)
  const inputEl = container.querySelector('[id="select-ice-cream"] input')
  debug(inputEl)
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æˆ‘ä¸çŸ¥é“ React æµ‹è¯•åº“æŸ¥è¯¢æ˜¯å¦å¯ä»¥æŸ¥è¯¢å±æ€§ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ DOM `querySelector`çš„åŸå› ã€‚*æˆ‘ä»¬å¯ä»¥åšå¾—æ›´å¥½ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸Šé¢çš„å˜æˆä¸€ä¸ªè‡ªå®šä¹‰æŸ¥è¯¢ï¼æ›´å¥½çš„æ˜¯ï¼Œæˆ‘å°†è¿”å›ä¸€ä¸ªåŒ…å«æ»¡è¶³æ¥å—æ ‡å‡†æ‰€éœ€å…ƒç´ çš„å¯¹è±¡ï¼

```
it('shows selected value in input field and right below select', () => {
  const { querySelectComponent } = render(<App />, {
    queries: {
      ...queries,
      querySelectComponent: (root, id) => {
        return {
          rootEl: root.querySelector(`[id=${id}]`),
          inputEl: root.querySelector(`[id=${id}] input`),
          spanEl: document.querySelector(
            `div[id=${id}] + span[data-testid='${id}-selected']`
          ),
        }
      },
    },
  })

  const { rootEl, inputEl, spanEl } = querySelectComponent('select-ice-cream')

  fireEvent.change(inputEl, { target: { value: 'strawberry' } }) // change input value to strawberry
  fireEvent.keyDown(inputEl, { key: 'Tab', code: 9 }) // select what the input value has as the selected value

  //Assertions!
  expect(spanEl).toHaveTextContent(/strawberry/)
  expect(getByText(rootEl, 'Strawberry')).toHaveTextContent('Strawberry')   
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æµ‹è¯•å—ç°åœ¨æ¶µç›–äº†éªŒæ”¶æ ‡å‡†ï¼æ˜¯çš„ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«æŠ½è±¡ç»†èŠ‚çš„éå¸¸å…·ä½“çš„é€‰æ‹©å™¨ã€‚`div[id=${id}] + span[data-testid='${id}-selected']`ã€‚è¯¥é€‰æ‹©å™¨ç¡®ä¿è·¨åº¦å‡ºç°åœ¨éªŒæ”¶æ ‡å‡†æè¿°çš„`Select`æ­£ä¸‹æ–¹ã€‚*ç”¨æˆ·åº”é€‰æ‹©ä¸€ä¸ªå€¼ï¼Œå¹¶åœ¨`Select`çš„è¾“å…¥æ å’Œ `Select`æ­£ä¸‹æ–¹çš„`span` **å†…çœ‹åˆ°é€‰æ‹©çš„å€¼ã€‚***

å½“å‰çš„æµ‹è¯•å—å…·æœ‰æŠ½è±¡ç»„ä»¶é€‰æ‹©å™¨ç»†èŠ‚çš„æŸ¥è¯¢ã€‚è®©æŸ¥è¯¢åœ¨ä»»ä½•æµ‹è¯•å—ä¸­å¯é‡ç”¨æ˜¯ç†æƒ³çš„ã€‚ä»»ä½•éœ€è¦ä¸`Select`ç»„ä»¶äº¤äº’çš„äººéƒ½å¯ä»¥åœ¨ä»–ä»¬çš„æµ‹è¯•ä¸­ä½¿ç”¨ç›¸åŒçš„é€‰æ‹©å™¨æ¨¡å¼ã€‚æ¯ä¸ªæµ‹è¯•éƒ½å¯ä»¥é‡ç”¨ç›¸åŒçš„æ¨¡å¼æ¥è®¿é—®ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œæˆ–è€…å¯èƒ½æ˜¯å†…éƒ¨ç»„ä»¶çš„æŠ½è±¡ç»†èŠ‚ã€‚ä½†æ˜¯å½“`react-select`æ›´æ–°æ—¶ï¼Œæˆ‘å¯ä»¥ä»ä¸€ä¸ªåœ°æ–¹æ›´æ–°æˆ‘çš„æŸ¥è¯¢ï¼

```
//testUtils.js
export const selectComponentQueries = (root, id) => {
  return {
    rootEl: root.querySelector(`[id=${id}]`),
    inputEl: root.querySelector(`[id=${id}] input`),
    spanEl: document.querySelector(
      `div[id=${id}] + span[data-testid='${id}-selected']`
    ),
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
//App.test.js
it('shows selected value in input field and right below select', () => {
  const { container } = render(<App />)

  const { rootEl, inputEl, spanEl } = selectComponentQueries(
    container,
    'select-ice-cream'
  )

  fireEvent.change(inputEl, { target: { value: 'strawberry' } })
  fireEvent.keyDown(inputEl, { key: 'Tab', code: 9 })

  expect(spanEl).toHaveTextContent(/strawberry/)
  expect(getByText(rootEl, 'Strawberry')).toHaveTextContent('Strawberry')
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#conclusion)ç»“è®º

ç»„ä»¶çš„æŠ½è±¡ç»†èŠ‚å¯ä»¥æ”¹å˜ã€‚ä¿æŒä¸€ä¸ªæµ‹è¯•åº“çš„å¯ç»´æŠ¤æ€§ï¼Œå¯¹äºç±»ä¼¼æŸ¥è¯¢è¿™æ ·çš„äº‹æƒ…ä½¿ç”¨å¯å…±äº«çš„æµ‹è¯•å·¥å…·ã€‚è¿™æ ·ï¼Œæ‰€æœ‰çš„æµ‹è¯•éƒ½ä½¿ç”¨ç›¸åŒçš„å¯é‡ç”¨ä»£ç ã€‚å°†æŸ¥è¯¢æ”¾åœ¨ä¸€ä¸ªå•ä¸€çš„æºä¸­ä¼šä½¿æ”¹å˜å˜å¾—å®¹æ˜“å¾—å¤šã€‚

* * *

ä½ å¥½ï¼æˆ‘æ˜¯ä¹”æ©Â·åº·ç™»å°‘æ ¡ã€‚æˆ‘æ˜¯ä¸€åèµ„æ·±è½¯ä»¶å†œæ°‘ï¼Œåœ¨ [Bendyworks](https://bendyworks.com/) è´Ÿè´£å®¢æˆ·ä»£ç åº“ã€‚ä½œä¸ºä¸€åè½¯ä»¶å†œæ°‘ï¼Œæˆ‘ä¸“æ³¨äºç½‘ç»œä¸Šçš„ä»»ä½•ä¸œè¥¿ï¼Œä½†æˆ‘çš„å¥½å¥‡å¿ƒé€šå¸¸ä¼šè®©æˆ‘æ‰è¿›å…”å­æ´...*â€œä¹”æ©Â·æ¢…æ°åˆšåˆšæ‰è¿›äº†å¦ä¸€ä¸ªå…”å­æ´â€¦â€¦æ•¬è¯·æœŸå¾…ä¸‹ä¸€ç¯‡åšæ–‡ï¼ğŸ‘‹â€*