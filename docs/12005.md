# è‡ªä¸»å¼€å‘çš„ç‰©è”ç½‘è‡ªåŠ¨åŒ–å¼€å‘å¹³å°ğŸ¤–

> åŸæ–‡:[https://dev.to/azure/home-grown-iot-automated-devops-3nba](https://dev.to/azure/home-grown-iot-automated-devops-3nba)

çœ‹äº†ä¸€ä¸‹[ä¸€äº›éƒ¨ç½²ç‰©è”ç½‘åº”ç”¨çš„å·¥å…·](https://dev.to/azure/home-grown-iot-simple-devops-11n9)ä¹‹åï¼Œè¿™é‡Œè¿˜ç¼ºå°‘ä¸€å—æ‹¼å›¾ï¼Œ*è‡ªåŠ¨åŒ–*ã€‚æ¯•ç«Ÿï¼Œæˆ‘çš„ç›®æ ‡ä¹‹ä¸€æ˜¯èƒ½å¤Ÿæ¯«ä¸è´¹åŠ›åœ°å°†æ›´æ–°éƒ¨ç½²åˆ°æˆ‘çš„é¡¹ç›®ä¸­ï¼Œæˆ‘æƒ³è¦åšä¸€ä¸ª`git push`çš„æƒ³æ³•ï¼Œç„¶åå®ƒå°±éƒ¨ç½²äº†ã€‚

è¿™è®©æˆ‘ä»¬çœ‹åˆ°äº†è¿™ç¯‡æ–‡ç« ï¼Œçœ‹çœ‹æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ç‰©è”ç½‘è¾¹ç¼˜å’Œ Azure ç®¡é“æ¥è‡ªåŠ¨éƒ¨ç½²ç‰©è”ç½‘é¡¹ç›®ã€‚

åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç‰©è”ç½‘è¾¹ç¼˜å›¢é˜Ÿ[å·²ç»åœ¨å¾®è½¯æ–‡æ¡£ä¸Šå°±å¦‚ä½•åšè¿™ä»¶äº‹æä¾›äº†æŒ‡å¯¼](https://docs.microsoft.com/en-us/azure/iot-edge/how-to-devops-project?WT.mc_id=devto-blog-aapowell)ï¼Œä½†å®ƒå°†ä¸ºæ‚¨ç”Ÿæˆä¸€ä¸ªæ ·æœ¬é¡¹ç›®ï¼Œè¿™æ„å‘³ç€æ‚¨éœ€è¦å°†æ‚¨çš„é¡¹ç›®æ”¹é€ åˆ°å…¶ä¸­ã€‚**é‚£**æ˜¯æˆ‘ä»¬å°†åœ¨è¿™ç¯‡æ–‡ç« ä¸­æ¶‰åŠçš„ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ å…ˆæµè§ˆä¸€ä¸‹æ–‡æ¡£ã€‚

## [](#defining-our-process)å®šä¹‰æˆ‘ä»¬çš„æµç¨‹

å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥çœ‹çœ‹æ„å»ºå’Œéƒ¨ç½²é¡¹ç›®çš„è¿‡ç¨‹ã€‚æˆ‘å°†æŠŠå®ƒåˆ†æˆæ˜ç¡®å®šä¹‰çš„æ„å»ºå’Œå‘å¸ƒé˜¶æ®µï¼Œä½¿ç”¨ YAML Azure Pipelines ç»„ä»¶æ¥æ„å»ºï¼Œç„¶åä½¿ç”¨åŸºäº GUI çš„å‘å¸ƒæ¥éƒ¨ç½²åˆ° Piã€‚æˆ‘èµ°è¿™æ¡è·¯çš„ä¸»è¦åŸå› æ˜¯ï¼Œ**åœ¨æ’°å†™**æ—¶ï¼Œåœ¨//Build å®£å¸ƒçš„ YAML å‘å¸ƒé¢„è§ˆç‰ˆ[ä¸æ”¯æŒæ‰¹å‡†ï¼Œè¿™æ˜¯æˆ‘æƒ³è¦çš„(æˆ‘å°†åœ¨è¿™ç¯‡æ–‡ç« çš„åé¢è§£é‡Šä¸ºä»€ä¹ˆ)ã€‚](https://devblogs.microsoft.com/devops/whats-new-with-azure-pipelines/?WT.mc_id=devto-blog-aapowell)

### [](#build-phase)å»ºé€ é˜¶æ®µ

åœ¨æ„å»ºé˜¶æ®µï¼Œæˆ‘ä»¬çš„ç®¡é“å°†è´Ÿè´£ç¼–è¯‘åº”ç”¨ç¨‹åºï¼Œç”Ÿæˆç‰©è”ç½‘è¾¹ç¼˜éƒ¨ç½²æ¨¡æ¿ï¼Œå¹¶åˆ›å»º Docker æ˜ åƒä¾›ç‰©è”ç½‘è¾¹ç¼˜ä½¿ç”¨ã€‚

æˆ‘è¿˜å†³å®šè®©è¿™ä¸ªé˜¶æ®µè´Ÿè´£å‡†å¤‡ä¸€äº› Azure åŸºç¡€è®¾æ–½ï¼Œæˆ‘éœ€è¦ä½¿ç”¨[èµ„æºç®¡ç†å™¨æ¨¡æ¿](https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authoring-templates?WT.mc_id=devto-blog-aapowell)ã€‚è¿™é‡Œçš„ç›®æ ‡æ˜¯èƒ½å¤Ÿä½¿ç”¨ç®¡é“ä»é›¶å¼€å§‹ 100%åœ°ä¾›åº”ä¸€åˆ‡ï¼Œå› æ­¤ï¼Œäº²çˆ±çš„è¯»è€…ï¼Œä½ å¯ä»¥ç¡®åˆ‡åœ°çœ‹åˆ°æ­£åœ¨ä½¿ç”¨ä»€ä¹ˆã€‚

### [](#release-phase)é‡Šæ”¾é˜¶æ®µ

å‘å¸ƒé˜¶æ®µå°†ç”±æˆåŠŸçš„æ„å»ºé˜¶æ®µå®Œæˆè§¦å‘ï¼Œå¹¶è´Ÿè´£åˆ›å»ºç‰©è”ç½‘è¾¹ç¼˜éƒ¨ç½²å’Œéƒ¨ç½²æˆ‘çš„ Azure åŠŸèƒ½æ¥å¤„ç†æ•°æ®ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä¸º Pi å’Œ Azure å‡½æ•°åˆ›å»ºäº†å•ç‹¬çš„â€œç¯å¢ƒâ€,å› ä¸ºæˆ‘å¯èƒ½åªéƒ¨ç½²ä¸€ä¸ªè€Œä¸éƒ¨ç½²å¦ä¸€ä¸ªï¼Œå¹¶ä¸”å¹¶è¡Œè¿è¡Œå®ƒä»¬ã€‚

## [](#getting-the-build-on)è¶Šé€ è¶Šå¤§

è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ„å»ºå‡†å¤‡å‘å¸ƒçš„åº”ç”¨ç¨‹åºéœ€è¦ä»€ä¹ˆã€‚ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯ [YAML æ¨¡å¼](https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema&WT.mc_id=devto-blog-aapowell)ï¼Œæˆ‘å°†ä»æ‰€éœ€çš„è§¦å‘å™¨å’Œå˜é‡å¼€å§‹:

```
trigger:
- master

pr: none

variables:
  azureSubscription: 'Sunshine  Service  Connection'
  azureResourceNamePrefix: sunshine
  buildConfiguration: 'Release'
  azureResourceLocation: 'Australia  East'

jobs: 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘åªå…³å¿ƒ`master`åˆ†æ”¯ï¼Œæ‰€ä»¥æˆ‘åªè§¦å‘è¯¥åˆ†æ”¯æœ¬èº«çš„ä»£ç ï¼Œå¹¶ä¸”æˆ‘å…³é—­äº†æ‹‰è¯·æ±‚æ„å»ºï¼Œå› ä¸ºæˆ‘ä¸æƒ³è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ PR(å˜¿ï¼Œè¿™æ˜¯*æˆ‘çš„*æˆ¿å­ï¼ğŸ˜).æˆ‘ä»¬éœ€è¦å‡ ä¸ªå˜é‡ï¼Œä¸»è¦ä¸æˆ‘ä»¬å°†ç”Ÿæˆçš„ Azure èµ„æºç›¸å…³ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å®šä¹‰å®ƒä»¬ï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œæ”¾ä¸Šé­”æ³•å­—ç¬¦ä¸²ã€‚

## [](#optimising-builds-with-jobs)ä½¿ç”¨ä½œä¸šä¼˜åŒ–æ„å»º

å½“è°ˆåˆ°åœ¨ Azure Pipelines ä¸­è¿è¡Œæ„å»ºæ—¶ï¼Œè€ƒè™‘å¦‚ä½•æœ‰æ•ˆåœ°åšåˆ°è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚é€šå¸¸æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªæ„å»ºå®šä¹‰ï¼Œå®ƒæ˜¯ä¸€ç³»åˆ—è¢«æ‰§è¡Œçš„è¿ç»­ä»»åŠ¡ï¼Œæˆ‘ä»¬ç¼–è¯‘ã€æ‰“åŒ…ã€å‡†å¤‡ç¯å¢ƒç­‰ç­‰ã€‚ä½†æ˜¯è¿™å¹¶ä¸æ€»æ˜¯æˆ‘ä»¬æ„å»ºçš„æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚æ¯•ç«Ÿï¼Œæˆ‘ä»¬å¸Œæœ›å°½å¿«ä»æˆ‘ä»¬çš„æ„å»ºä¸­å¾—åˆ°ç»“æœã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Azure ç®¡é“ä¸­ä½¿ç”¨[ä½œä¸š](https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml&WT.mc_id=devto-blog-aapowell)ã€‚ä½œä¸šæ˜¯å®Œæˆæˆ‘ä»¬ç®¡é“çš„ä¸€éƒ¨åˆ†è¦é‡‡å–çš„æ­¥éª¤çš„é›†åˆï¼Œå…³äºä½œä¸šçš„çœŸæ­£å¥½çš„äº‹æƒ…æ˜¯ä½ å¯ä»¥å¹¶è¡Œè¿è¡Œå®ƒä»¬([å–å†³äºä½ çš„è®¸å¯](https://docs.microsoft.com/en-us/azure/devops/pipelines/licensing/concurrent-jobs?view=azure-devops&WT.mc_id=devto-blog-aapowell)ï¼Œæˆ‘å·²ç»å…¬å¼€äº†æˆ‘çš„ç®¡é“ï¼Œè¿™æ„å‘³ç€æˆ‘å¾—åˆ°äº† 10 ä¸ªå¹¶è¡Œä½œä¸š)ï¼Œå¹¶ä¸”é€šè¿‡ä¸€ä¸ªç”Ÿæˆå¤§é‡ Docker å›¾åƒçš„ç®¡é“ï¼Œèƒ½å¤Ÿå¹¶è¡Œæ‰§è¡Œå®ƒä»¬æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ—¶é—´èŠ‚çœï¼

æ­¤å¤–ï¼Œå¯¹äºä¸åŒçš„ä½œä¸šï¼Œæ‚¨å¯ä»¥æŒ‡å®šä¸åŒçš„ä»£ç†æ± ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨ Linux ä¸Šè¿è¡Œä¸€äº›ç®¡é“ï¼Œåœ¨ Windows ä¸Šè¿è¡Œä¸€äº›ç®¡é“ã€‚æ‚¨ç”šè‡³å¯ä»¥å®šä¹‰ä½œä¸šä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè¿™æ ·æ‚¨å°±ä¸ä¼šåœ¨åˆ›å»ºæ³¨å†Œä¸­å¿ƒä¹‹å‰å°è¯•å°† Docker æ˜ åƒæ¨é€åˆ°å®¹å™¨æ³¨å†Œä¸­å¿ƒã€‚

è®°ä½æ‰€æœ‰è¿™äº›ï¼Œæ˜¯æ—¶å€™å¼€å§‹åˆ›å»ºæˆ‘ä»¬çš„ç®¡é“äº†ã€‚

### [](#building-the-application)æ„å»ºåº”ç”¨ç¨‹åº

åœ¨æˆ‘ä»¬çš„ç®¡é“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æœ€ç®€å•çš„äº‹æƒ…æ˜¯ä»€ä¹ˆï¼Ÿç¼–è¯‘æˆ‘ä»¬çš„ã€‚NET ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»é‚£é‡Œå¼€å§‹:

```
- job: Build
  pool:
      vmImage: "Ubuntu-16.04"
  steps:
      - script: dotnet build --configuration $(buildConfiguration)
        displayName: "dotnet  build  $(buildConfiguration)"

      - task: DotNetCoreCLI@2
        inputs:
            command: "publish"
            arguments: "--configuration  $(BuildConfiguration)"
            publishWebProjects: false
            zipAfterPublish: false
        displayName: dotnet publish

      - task: ArchiveFiles@2
        inputs:
            rootFolderOrFile: "$(Build.SourcesDirectory)/src/Sunshine.Downloader/bin/$(BuildConfiguration)/netcoreapp2.2/publish"
            includeRootFolder: false
            archiveFile: "$(Build.ArtifactStagingDirectory)/Sunshine.Downloader-$(Build.BuildId).zip"
        displayName: Archive Downloader

      - task: ArchiveFiles@2
        inputs:
            rootFolderOrFile: "$(Build.SourcesDirectory)/src/Sunshine.Functions/bin/$(BuildConfiguration)/netcoreapp2.1/publish"
            includeRootFolder: false
            archiveFile: "$(Build.ArtifactStagingDirectory)/Sunshine.Functions-$(Build.BuildId).zip"
        displayName: Archive Functions

      - task: ArchiveFiles@2
        inputs:
            rootFolderOrFile: "$(Build.SourcesDirectory)/src/Sunshine.MockApi/bin/$(BuildConfiguration)/netcoreapp2.2/publish"
            includeRootFolder: false
            archiveFile: "$(Build.ArtifactStagingDirectory)/Sunshine.MockApi-$(Build.BuildId).zip"
        displayName: Archive MockApi

      - task: PublishBuildArtifacts@1
        displayName: "Publish  Artifact"
        continueOnError: true
        inputs:
            artifactName: Apps 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä»½å·¥ä½œæ˜¯ä½ çš„æ ‡å‡†ã€‚NET æ ¸å¿ƒç®¡é“æ¨¡æ¿ï¼Œæˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬åœ¨å˜é‡ä¸­å®šä¹‰çš„é…ç½®è¿è¡Œ`dotnet build`(é»˜è®¤ä¸º`Release`)ï¼Œç„¶åæ‰§è¡Œ`dotnet publish`æ¥ç”Ÿæˆå¯éƒ¨ç½²çš„åŒ…ï¼Œç„¶åå°†æ¯ä¸ªé¡¹ç›®å‹ç¼©ä¸ºç®¡é“çš„å·¥ä»¶ã€‚æˆ‘å°†æ‰€æœ‰é¡¹ç›®ä½œä¸ºå·¥ä»¶å‘å¸ƒçš„åŸå› æ˜¯ï¼Œå³ä½¿ç‰©è”ç½‘ç»„ä»¶å°†è¢« Dockerisedï¼Œå¦‚æœæˆ‘æƒ³çš„è¯ï¼Œæˆ‘å¯ä»¥åœ¨å°†æ¥ä¸‹è½½å’Œæ£€æŸ¥è¿™ä¸ªåŒ…ã€‚

åˆ›å»ºæˆ‘ä»¬çš„ç‰©è”ç½‘è¾¹ç¼˜éƒ¨ç½²åŒ…ã€‚

### [](#build-iot-edge-deployment-packages)æ„å»ºç‰©è”ç½‘è¾¹ç¼˜éƒ¨ç½²åŒ…

ä¸ºäº†åˆ›å»ºç‰©è”ç½‘è¾¹ç¼˜éƒ¨ç½²åŒ…ï¼Œæˆ‘ä»¬éœ€è¦åšä¸‰ä»¶äº‹ï¼Œåˆ›å»º Docker æ˜ åƒï¼Œå°†å…¶æ¨é€åˆ°å®¹å™¨æ³¨å†Œè¡¨ï¼Œå¹¶åˆ›å»ºæˆ‘ä»¬çš„éƒ¨ç½²æ¨¡æ¿(æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æŸ¥çœ‹äº†[)ã€‚](https://dev.to/azure/home-grown-iot-simple-devops-11n9)

#### [](#creating-a-container-registry)åˆ›å»ºå®¹å™¨æ³¨å†Œè¡¨

ä½†æ˜¯è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®¹å™¨æ³¨å†Œä¸­å¿ƒã€‚æˆ‘å°†ä½¿ç”¨[Azure Container Registry(ACR)](https://azure.microsoft.com/en-us/services/container-registry/?WT.mc_id=devto-blog-aapowell),å› ä¸ºä»å®‰å…¨è§’åº¦æ¥çœ‹ï¼Œå®ƒå¯ä»¥è½»æ¾åœ°é›†æˆåˆ°æˆ‘çš„ç®¡é“å’Œç‰©è”ç½‘ä¸­å¿ƒï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨æƒ³è¦çš„æ³¨å†Œè¡¨ã€‚å› ä¸ºæˆ‘åœ¨ä½¿ç”¨ ACRï¼Œæ‰€ä»¥æˆ‘éœ€è¦å®ƒçš„å­˜åœ¨ã€‚æ‚¨å¯ä»¥é€šè¿‡ç‚¹å‡»é—¨æˆ·ç½‘ç«™æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œä½†æˆ‘å¸Œæœ›è¿™æ˜¯æˆ‘çš„ git repo çš„è„šæœ¬å’Œä¸€éƒ¨åˆ†ï¼Œä»¥ä¾¿æˆ‘å¯ä»¥åœ¨éœ€è¦æ—¶é‡å»ºï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨èµ„æºç®¡ç†å™¨æ¨¡æ¿:

```
{  "resources":  [  {  "type":  "Microsoft.ContainerRegistry/registries",  "sku":  {  "name":  "[parameters('registrySku')]"  },  "name":  "[variables('registryName')]",  "apiVersion":  "2017-10-01",  "location":  "[parameters('location')]",  "properties":  {  "adminUserEnabled":  false  }  }  ],  "parameters":  {  "name":  {  "type":  "string",  "metadata":  {  "description":  "Short name for the resources within this stack"  }  },  "location":  {  "type":  "string"  },  "registrySku":  {  "defaultValue":  "Standard",  "type":  "string",  "metadata":  {  "description":  "The SKU of the container registry."  }  }  },  "variables":  {  "registryName":  "[concat(parameters('name'), 'cr')]"  },  "outputs":  {  "acrUrl":  {  "type":  "string",  "value":  "[concat(variables('registryName'), '.azurecr.io')]"  },  "acrName":  {  "type":  "string",  "value":  "[variables('registryName')]"  },  "subscriptionId":  {  "type":  "string",  "value":  "[subscription().id]"  }  },  "$schema":  "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",  "contentVersion":  "1.0.0.0"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªä»»åŠ¡ä»ç®¡é“ä¸­è¿è¡Œå®ƒ:

```
- job: PrepareAzureACR
  displayName: Prepare Azure ACR
  pool:
      vmImage: "Ubuntu-16.04"
  steps:
      - task: AzureResourceGroupDeployment@2
        displayName: "Azure  Deployment:Create  ACR"
        inputs:
            azureSubscription: "$(azureSubscription)"
            resourceGroupName: "$(azureResourceNamePrefix)-shared"
            location: "$(azureResourceLocation)"
            templateLocation: Linked artifact
            csmFile: "$(Build.SourcesDirectory)/.build/acr.json"
            overrideParameters: '-name  $(azureResourceNamePrefix)  -registrySku  "Basic"  -location  "$(azureResourceLocation)"'
            deploymentOutputs: ResourceGroupDeploymentOutputs 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨äº†ä¹‹å‰ä¸ºå‚æ•°`-name`å’Œ`-location`å®šä¹‰çš„å˜é‡ã€‚è¿™æœ‰åŠ©äºæˆ‘ä¿æŒèµ„æºå‘½åçš„ä¸€è‡´æ€§ã€‚æˆ‘è¿˜å°†å®ƒæ”¾å…¥ä¸€ä¸ªåä¸º`$(azureResourceNamePrefix)-shared`çš„èµ„æºç»„ï¼Œå› ä¸ºå¦‚æœæˆ‘æƒ³åœ¨ç”Ÿäº§å’Œéç”Ÿäº§åœºæ™¯ä¸­éƒ½ä½¿ç”¨è¿™äº›å›¾åƒ(å¦‚æœæˆ‘ä¸åªæ˜¯åœ¨å»ºé€ æˆ‘çš„æˆ¿å­ï¼Œæˆ‘ä¼šè¿™æ ·åš)ã€‚ä»»åŠ¡ä¸­éœ€è¦æ³¨æ„çš„æœ€åä¸€ç‚¹æ˜¯`templateLocation`è¢«è®¾ç½®ä¸º`Linked artifact`ï¼Œè¿™å‘Šè¯‰ä»»åŠ¡æ–‡ä»¶å­˜åœ¨äºç£ç›˜ä¸Š`csmFile`ä¸­å®šä¹‰çš„ä½ç½®ï¼Œè€Œä¸æ˜¯ä» URL ä¸­æå–ã€‚è¿™è®©æˆ‘å›°æƒ‘äº†ä¸€æ®µæ—¶é—´ï¼Œæ‰€ä»¥è¯·è®°ä½ï¼Œå¦‚æœæ‚¨æƒ³å°†æ‚¨çš„èµ„æºç®¡ç†å™¨æ¨¡æ¿ä¿ç•™åœ¨æºä»£ç æ§åˆ¶ä¸­å¹¶åœ¨å…‹éš†ä¸­ä½¿ç”¨è¯¥ç‰ˆæœ¬ï¼Œè¯·å°†`templateLocation`è®¾ç½®ä¸º`Linked artifact`å¹¶è®¾ç½®ä¸€ä¸ª`csmFile`è·¯å¾„ã€‚

åœ¨åˆ›å»ºç‰©è”ç½‘è¾¹ç¼˜éƒ¨ç½²æ¨¡æ¿æ—¶ï¼Œæˆ‘éœ€è¦ä¸€äº›å…³äºåˆšåˆšåˆ›å»ºçš„æ³¨å†Œè¡¨çš„ä¿¡æ¯ï¼Œæˆ‘éœ€è¦æ³¨å†Œè¡¨çš„åç§°åŠå…¶ URLã€‚ä¸ºäº†å¾—åˆ°è¿™äº›ï¼Œæˆ‘ä»æ¨¡æ¿ä¸­åˆ›å»ºäº†ä¸€äº›è¾“å‡ºå˜é‡:

```
...  "outputs":  {  "acrUrl":  {  "type":  "string",  "value":  "[concat(variables('registryName'), '.azurecr.io')]"  },  "acrName":  {  "type":  "string",  "value":  "[variables('registryName')]"  },  "subscriptionId":  {  "type":  "string",  "value":  "[subscription().id]"  }  },  ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨å®ƒä»¬å‘¢ï¼Ÿæœ€åˆï¼Œä»»åŠ¡ä¼šå°†å®ƒä»¬ä½œä¸ºä¸€ä¸ª JSON å­—ç¬¦ä¸²è½¬å‚¨åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œä½¿ç”¨`deploymentOutputs: ResourceGroupDeploymentOutputs`å®šä¹‰ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬éœ€è¦è§£åŒ…å¹¶è®¾ç½®æˆ‘ä»¬å°†åœ¨å…¶ä»–ä»»åŠ¡ä¸­ä½¿ç”¨çš„å˜é‡ã€‚æˆ‘ç”¨ä¸€ä¸ª PowerShell è„šæœ¬æ¥åšè¿™ä»¶äº‹:

```
param  (  [Parameter(Mandatory=$true)]  [string]  $ResourceManagerOutput  )  $json  =  ConvertFrom-Json  $ResourceManagerOutput  Write-Host  "##vso[task.setvariable variable=CONTAINER_REGISTRY_SERVER;isOutput=true]$($json.acrUrl.value)"  Write-Host  "##vso[task.setvariable variable=CONTAINER_REGISTRY_SERVER_NAME;isOutput=true]$($json.acrName.value)"  Write-Host  "##vso[task.setvariable variable=SUBSCRIPTION_ID;isOutput=true]$($json.subscriptionID.value)" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰§è¡Œä»»åŠ¡:

```
- task: PowerShell@2
    displayName: Convert ARM output to environment variables
    name: armVar
    inputs:
        targetType: filePath
        filePath: '$(Build.SourcesDirectory)/.build/Set-BuildResourceManagerOutput.ps1'
        arguments: -ResourceManagerOutput '$(ResourceGroupDeploymentOutputs)' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨åœ¨å…¶ä»–ä»»åŠ¡ä¸­ï¼Œæˆ‘å¯ä»¥å°†`CONTAINER_REGISTRY_SERVER`ä½œä¸ºä¸€ä¸ªå˜é‡æ¥è®¿é—®ã€‚

#### [](#preparing-the-iot-edge-deployment)å‡†å¤‡ç‰©è”ç½‘è¾¹ç¼˜éƒ¨ç½²

æˆ‘æƒ³åˆ›å»ºä¸‰ä¸ª Docker æ˜ åƒï¼Œä¸€ä¸ªæ˜¯å°†éƒ¨ç½²åˆ° Raspberry Pi çš„ ARM32 æ˜ åƒï¼Œå¦ä¸€ä¸ªæ˜¯ç”¨äºæœ¬åœ°æµ‹è¯•çš„ x64 æ˜ åƒï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å¸¦æœ‰è°ƒè¯•å™¨ç»„ä»¶çš„ x64 æ˜ åƒã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¯¹ä½œä¸šçš„ä½¿ç”¨éå¸¸æœ‰ç›Šçš„åœ°æ–¹ï¼Œæ ¹æ®æˆ‘çš„æµ‹è¯•ï¼Œæ¯ä¸ªä½œä¸šè‡³å°‘éœ€è¦ 7 åˆ†é’Ÿæ¥è¿è¡Œï¼Œå› æ­¤å¹¶è¡Œè¿è¡Œå®ƒä»¬å¯ä»¥å¤§å¤§å‡å°‘æˆ‘ä»¬çš„æ„å»ºæ—¶é—´ã€‚

ä¸ºäº†ç”Ÿæˆä¸‰ä¸ªå›¾åƒï¼Œæˆ‘éœ€è¦æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡é›†ä¸‰æ¬¡ï¼Œå› æ­¤ä¸ºäº†ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[æ­¥éª¤æ¨¡æ¿](https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops&WT.mc_id=devto-blog-aapowell)(é™„å¸¦è¯´æ˜ï¼Œè¿™æ˜¯æˆ‘é‡åˆ°é—®é¢˜[çš„åœ°æ–¹ï¼Œæˆ‘åœ¨è¿™é‡Œæè¿°äº†](https://dev.to/azure/azure-pipeline-yaml-templates-and-parameters-448j)æ¨¡æ¿å’Œå‚æ•°)ã€‚

```
parameters:
    name: ""
    ARTIFACT_STORAGE_NAME: ""
    CONTAINER_REGISTRY_SERVER: ""
    SUBSCRIPTION_ID: ""
    CONTAINER_REGISTRY_SERVER_NAME: ""
    defaultPlatform: ""
    azureResourceNamePrefix: ""
    azureSubscription: "" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹äºæ¨¡æ¿ä¸­çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä»å®šä¹‰ä¸€ç»„å‚æ•°å¼€å§‹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å®šä¹‰ä½œä¸š:

```
jobs:
- job: ${{ parameters.name }}
  displayName: Build Images for IoT Edge (${{ parameters.defaultPlatform }})
  dependsOn:
    - PrepareArtifactStorage
    - PrepareAzureACR
    - Build
  pool:
    vmImage: 'Ubuntu-16.04'
  variables:
    CONTAINER_REGISTRY_SERVER: ${{ parameters.CONTAINER_REGISTRY_SERVER }}
    SUBSCRIPTION_ID: ${{ parameters.SUBSCRIPTION_ID }}
    CONTAINER_REGISTRY_SERVER_NAME: ${{ parameters.CONTAINER_REGISTRY_SERVER_NAME }}
    ARTIFACT_STORAGE_NAME: ${{ parameters.ARTIFACT_STORAGE_NAME }}
  steps: 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦è®¿é—®æ¨¡æ¿å‚æ•°ï¼Œæ‚¨éœ€è¦ä½¿ç”¨`${{ parameters.<parameter name> }}`ã€‚æˆ‘åœ¨`name`å‚æ•°ä¸­ä¸ºæ¨¡æ¿æä¾›ä¸€ä¸ªæƒŸä¸€çš„åç§°ï¼Œç„¶åä½¿ç”¨æ¶æ„(AMD64ã€ARM32 ç­‰)åˆ›å»ºä¸€ä¸ªæ˜¾ç¤ºåç§°ã€‚).

æ¥ä¸‹æ¥ï¼Œä½œä¸šå®šä¹‰äº†å‡ ä¸ªä¾èµ–é¡¹ï¼Œå³æˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°çš„`Build`å’Œ`PrepareAzureACR`ä½œä¸šï¼Œç¨åæˆ‘ä¼šè°ˆåˆ°`PrepareArtifactStorage`ã€‚æœ€åï¼Œè¿™å°†æ± è®¾ç½®ä¸ºä¸€ä¸ª Linux VMï¼Œå¹¶å°†ä¸€äº›å‚æ•°è½¬æ¢ä¸ºä½œä¸šä¸­çš„ç¯å¢ƒå˜é‡ã€‚

è®©æˆ‘ä»¬å¼€å§‹çœ‹ä»»åŠ¡:

```
- task: DownloadBuildArtifacts@0
  displayName: "Download  Build  Artifacts"
  inputs:
      artifactName: Apps
      downloadPath: $(System.DefaultWorkingDirectory)

- task: ExtractFiles@1
  displayName: Unpack Build Artifact
  inputs:
      destinationFolder: "$(Build.SourcesDirectory)/src/Sunshine.Downloader/bin/$(BuildConfiguration)/netcoreapp2.2/publish"
      archiveFilePatterns: $(System.DefaultWorkingDirectory)/Apps/Sunshine.Downloader-$(Build.BuildId).zip 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å› ä¸ºæ­¤å¤„è¿è¡Œçš„ä½œä¸šä¸æœ€åˆæ„å»ºæˆ‘ä»¬çš„ã€‚NET åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦å¾—åˆ°æ–‡ä»¶ï¼Œè°¢å¤©è°¢åœ°ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬ä½œä¸ºä¸€ä¸ªå·¥ä»¶å‘å¸ƒäº†ï¼Œæ‰€ä»¥åªéœ€è¦ä¸‹è½½å¹¶è§£å‹åˆ°æ­£ç¡®çš„ä½ç½®ã€‚æˆ‘å°†å®ƒè§£åŒ…å›åˆ°å‘å¸ƒæœ€åˆå‘ç”Ÿçš„åœ°æ–¹ï¼Œå› ä¸ºä½œä¸šæœ€åˆç¡®å®åšäº†ä¸€ä¸ª`git clone`(æˆ‘éœ€è¦å®ƒæ¥è·å¾—ç‰©è”ç½‘è¾¹ç¼˜çš„`module.json`å’Œ`deployment.template.json`)æˆ‘è¿˜ä¸å¦‚å‡è£…æˆ‘åœ¨ä½¿ç”¨æ­£å¸¸çš„ç»“æ„ã€‚

ä»£ç ï¼Ÿâœ”.éƒ¨ç½² JSONï¼Ÿâœ”.æ˜¯æ—¶å€™ä½¿ç”¨ç‰©è”ç½‘è¾¹ç¼˜å·¥å…·æ¥åˆ›å»ºä¸€äº›éƒ¨ç½²æ–‡ä»¶äº†ã€‚è°¢å¤©è°¢åœ°ï¼ŒAzure Pipelines æœ‰ä¸€ä¸ª[ç‰©è”ç½‘è¾¹ç¼˜ä»»åŠ¡](https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/azure-iot-edge?view=azure-devops&WT.mc_id=devto-blog-aapowell)ï¼Œè¿™å°†åšå¾—å¾ˆå¥½ã€‚

```
- task: AzureIoTEdge@2
  displayName: Azure IoT Edge - Build module images (${{ parameters.defaultPlatform }})
  inputs:
      templateFilePath: "$(Build.SourcesDirectory)/.build/deployment.template.json"
      defaultPlatform: ${{ parameters.defaultPlatform }}

- task: AzureIoTEdge@2
  displayName: Azure IoT Edge - Push module images (${{ parameters.defaultPlatform }})
  inputs:
      action: "Push  module  images"
      templateFilePath: "$(Build.SourcesDirectory)/.build/deployment.template.json"
      azureSubscriptionEndpoint: ${{ parameters.azureSubscription }}
      azureContainerRegistry: '{"loginServer":"$(CONTAINER_REGISTRY_SERVER)",  "id"  :  "$(SUBSCRIPTION_ID)/resourceGroups/${{  parameters.azureResourceNamePrefix  }}-shared/providers/Microsoft.ContainerRegistry/registries/$(CONTAINER_REGISTRY_SERVER_NAME)"}'
      defaultPlatform: ${{ parameters.defaultPlatform }} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¬¬ä¸€ä¸ªä»»åŠ¡å°†ä½¿ç”¨`deployment.template.json`æ–‡ä»¶ä¸ºæˆ‘ä»¬æŒ‡å®šçš„å¹³å°æ„å»º Docker æ˜ åƒã€‚æ­£å¦‚æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„ï¼Œå¦‚æœä½ éœ€è¦è®¾ç½®`CONTAINER_REGISTRY_USERNAME`ã€`CONTAINER_REGISTRY_PASSWORD`å’Œ`CONTAINER_REGISTRY_SERVER`ç¯å¢ƒå˜é‡ï¼Œé‚£ä¹ˆå®ƒä»¬å¯ä»¥è¢«æ›¿æ¢åˆ°æ¨¡æ¿ä¸­ã€‚æˆ‘ä»¬ä»ä¼ å…¥çš„å‚æ•°ä¸­å¾—åˆ°`CONTAINER_REGISTRY_SERVER`(ä½œä¸ºå˜é‡è§£åŒ…)ï¼Œä½†æ˜¯å…¶ä»–ä¸¤ä¸ªå‘¢ï¼Ÿå®ƒä»¬æ˜¯ç”± Azure å’Œ Azure ç®¡é“ä¹‹é—´çš„é›†æˆæä¾›çš„ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦æ˜¾å¼è®¾ç½®å®ƒä»¬ã€‚

ä¸€æ—¦æ„å»ºäº†æ˜ åƒï¼Œæˆ‘ä»¬å°±åœ¨ä»»åŠ¡ä¸Šæ‰§è¡Œ`Push module images`å‘½ä»¤ï¼Œè¿™å°†æŠŠæ˜ åƒæ¨é€åˆ°æˆ‘ä»¬çš„å®¹å™¨æ³¨å†Œè¡¨ä¸­ã€‚å› ä¸ºæˆ‘æ­£åœ¨ä½¿ç”¨ ACRï¼Œæ‰€ä»¥æˆ‘éœ€è¦æä¾›ä¸€ä¸ª JSON å¯¹è±¡ï¼Œå®ƒåŒ…å« ACR çš„ URL å’Œå®ƒçš„`id`ã€‚`id`æœ‰ç‚¹æ£˜æ‰‹ï¼Œæ‚¨éœ€è¦ç”Ÿæˆå®Œæ•´çš„èµ„æºæ ‡è¯†ç¬¦ï¼Œè¿™æ„å‘³ç€æ‚¨éœ€è¦å°†æ¯ä¸ªç‰‡æ®µè¿æ¥åœ¨ä¸€èµ·ï¼Œä»è€Œå¯¼è‡´è¿™ä¸ª`$(SUBSCRIPTION_ID)/resourceGroups/${{ parameters.azureResourceNamePrefix }}-shared/providers/Microsoft.ContainerRegistry/registries/$(CONTAINER_REGISTRY_SERVER_NAME)`æˆä¸º`<some guid>/resourceGroups/sunshine-shared/providers/Microsoft.ContainerRegistry/registries/sunshinecr`ã€‚

æœ€åï¼Œæˆ‘ä»¬éœ€è¦å‘å¸ƒæˆ‘ä»¬çš„`deployment.platform.json`æ–‡ä»¶ï¼Œå‘å¸ƒé˜¶æ®µå°†æ‰§è¡Œè¯¥æ–‡ä»¶æ¥å°†ä¸€ä¸ªå‘å¸ƒéƒ¨ç½²åˆ°ä¸€ä¸ªè®¾å¤‡ä¸Šï¼Œä½†æ˜¯è¿™é‡Œæœ‰äº›äº‹æƒ…éœ€è¦å°å¿ƒã€‚å½“ç”Ÿæˆéƒ¨ç½²æ—¶ï¼Œå®¹å™¨æ³¨å†Œä¸­å¿ƒä¿¡æ¯è¢«æ›¿æ¢ä¸ºä¸æ³¨å†Œä¸­å¿ƒå¯¹è¯æ‰€éœ€çš„å‡­è¯ã€‚è¿™æ ·ï¼Œå½“éƒ¨ç½²è¢«æ‹‰åˆ°è®¾å¤‡ä¸Šæ—¶ï¼Œå°±èƒ½å¤Ÿç™»å½•åˆ°æ‚¨çš„æ³¨å†Œè¡¨ä¸­ã€‚ä½†æ˜¯è¿™æ ·åšæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œæ‚¨å°†å‡­è¯å­˜å‚¨åœ¨ä¸€ä¸ªéœ€è¦é™„åŠ åˆ°æ„å»ºä¸­çš„æ–‡ä»¶ä¸­ã€‚åœ¨æ–‡æ¡£ä¸­ç”Ÿæˆçš„æ ‡å‡†æ¨¡æ¿[å°†æŠŠå®ƒä½œä¸ºæ„å»ºå·¥ä»¶é™„åŠ è¿›æ¥ï¼Œå°±åƒæˆ‘ä»¬ç¼–è¯‘çš„åº”ç”¨ç¨‹åºä¸€æ ·ï¼Œè¿™åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½èƒ½å¾ˆå¥½åœ°å·¥ä½œã€‚ä½†æ˜¯è¿™æ ·åšæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œä»»ä½•èƒ½å¤Ÿè®¿é—®æ‚¨çš„æ„å»ºå·¥ä»¶çš„äººéƒ½å°†èƒ½å¤Ÿè®¿é—®æ‚¨çš„å®¹å™¨æ³¨å†Œå‡­è¯ï¼Œè¿™å¯èƒ½æ˜¯æ‚¨ä¸å¸Œæœ›çœ‹åˆ°çš„ã€‚å½“æˆ‘æ„è¯†åˆ°ï¼Œå› ä¸ºæˆ‘çš„ç®¡é“æ˜¯å…¬å…±çš„ï¼Œ**æ¯ä¸ªäºº**éƒ½å¯ä»¥è®¿é—®æˆ‘çš„å®¹å™¨æ³¨å†Œå‡­è¯æ—¶ï¼Œæˆ‘æœ‰ç‚¹åƒæƒŠï¼ç„¶åæˆ‘å¾ˆå¿«åˆ é™¤äº†é‚£ä¸ª ACRï¼Œå› ä¸ºå‡­è¯ç°åœ¨å·²ç»æ³„éœ²äº†ï¼ğŸ¤¦â€â™‚ï¸](https://docs.microsoft.com/en-us/azure/iot-edge/how-to-devops-project?WT.mc_id=devto-blog-aapowell)

#### [](#securing-deployments)å®‰å…¨éƒ¨ç½²

æˆ‘ä»¬å¸Œæœ›ä¿æŠ¤éƒ¨ç½²ï¼Œè¿™æ ·æˆ‘ä»¬çš„æ„å»ºæœåŠ¡å™¨å°±ä¸ä¼šæˆä¸ºåŸºç¡€è®¾æ–½çš„åª’ä»‹ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½å°†éƒ¨ç½²æ–‡ä»¶ä½œä¸ºæ„å»ºå·¥ä»¶é™„åŠ ã€‚

è¿™å°±æ˜¯è¿™ä¸ªä½œä¸šçš„å¦ä¸€ä¸ªä¾èµ–é¡¹`PrepareArtifactStorage`çš„ä½œç”¨ã€‚æˆ‘æ²¡æœ‰å°†éƒ¨ç½²æ–‡ä»¶ä½œä¸ºå·¥ä»¶æ¨é€åˆ° Azure å­˜å‚¨å¸æˆ·:

```
- job: PrepareArtifactStorage
  displayName: Setup Artifact Storage Azure Resources
  pool:
      vmImage: "Ubuntu-16.04"
  steps:
      - task: AzureResourceGroupDeployment@2
        displayName: "Azure  Deployment:  Artifact  Storage"
        inputs:
            azureSubscription: "$(azureSubscription)"
            resourceGroupName: "$(azureResourceNamePrefix)-shared"
            location: "$(azureResourceLocation)"
            templateLocation: Linked artifact
            csmFile: "$(Build.SourcesDirectory)/.build/artifact-storage.json"
            overrideParameters: '-name  $(azureResourceNamePrefix)  -location  "$(azureResourceLocation)"'
            deploymentOutputs: ResourceGroupDeploymentOutputs

      - task: PowerShell@2
        displayName: Convert ARM output to environment variables
        name: artifactVars
        inputs:
            targetType: filePath
            filePath: "$(Build.SourcesDirectory)/.build/Set-ArtifactStorageResourceManagerOutput.ps1"
            arguments: -ResourceManagerOutput '$(ResourceGroupDeploymentOutputs)' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä½¿ç”¨äº†ä¸€ä¸ªèµ„æºç®¡ç†å™¨æ¨¡æ¿ï¼Œè¯¥æ¨¡æ¿ä»…åˆ›å»ºå­˜å‚¨å¸æˆ·:

```
{  "resources":  [  {  "apiVersion":  "2015-06-15",  "type":  "Microsoft.Storage/storageAccounts",  "name":  "[variables('artifactStorageName')]",  "location":  "[parameters('location')]",  "properties":  {  "accountType":  "Standard_LRS"  }  }  ],  "parameters":  {  "name":  {  "type":  "string",  "metadata":  {  "description":  "Name prefix for the resources to be created"  }  },  "location":  {  "type":  "string",  "metadata":  {  "description":  "Azure Region for each resource to be created in"  }  }  },  "variables":  {  "artifactStorageName":  "[replace(concat(parameters('name'), 'artifacts'), '-', '')]"  },  "outputs":  {  "artifactStorageName":  {  "type":  "string",  "value":  "[variables('artifactStorageName')]"  }  },  "$schema":  "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",  "contentVersion":  "1.0.0.0"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å’Œä¸€ä¸ª PowerShell è„šæœ¬å°†è¾“å‡ºè½¬æ¢æˆå˜é‡:

```
param  (  [Parameter(Mandatory=$true)]  [string]  $ResourceManagerOutput  )  $json  =  ConvertFrom-Json  $ResourceManagerOutput  Write-Host  "##vso[task.setvariable variable=ARTIFACT_STORAGE_NAME;isOutput=true]$($json.artifactStorageName.value)" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### [](#pushing-artifacts-to-storage)å°†å·¥ä»¶æ¨å…¥åº“

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨å­˜å‚¨å¸æˆ·ä½œä¸ºå·¥ä»¶çš„ç›®çš„åœ°æ¥å®Œæˆæˆ‘ä»¬çš„ç‰©è”ç½‘å·¥ä½œ:

```
- task: AzureCLI@1
  displayName: Upload deployment artifact
  inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptLocation: inlineScript
      arguments: $(ARTIFACT_STORAGE_NAME) $(Build.ArtifactStagingDirectory) ${{ parameters.defaultPlatform }} $(Build.BuildId)
      inlineScript: |
          account_name=$1
          key=$(az storage account keys list --account-name $account_name | jq '.[0].value')
          exists=$(az storage container exists --account-name $account_name --name artifacts --account-key $key | jq '.exists')
          if ["$exists" == false]; then
                  az storage container create --name artifacts --account-name $account_name --account-key $key
          fi
          az storage blob upload --container-name artifacts --file $2/deployment.$3.json --name $4/deployment.$3.json --account-name $account_name --account-key $key 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä½¿ç”¨çš„æ˜¯ [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest&WT.mc_id=devto-blog-aapowell) è€Œä¸æ˜¯ [AzCopy](https://docs.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-v10?WT.mc_id=devto-blog-aapowell) ï¼Œå› ä¸ºæˆ‘è¿è¡Œçš„æ˜¯ Linux ä»£ç†ã€‚å®ƒæ‰§è¡Œä¸€ä¸ªè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†ä»å­˜å‚¨å¸æˆ·è·å–å¸æˆ·å¯†é’¥(è¿™æ ·æˆ‘å°±å¯ä»¥å†™å…¥å®ƒ)ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä¸€ä¸ªå®¹å™¨(è„šæœ¬ä¸€åˆ‡ï¼Œä¸è¦å‡è®¾ï¼)ç„¶åå°†æ–‡ä»¶ä¸Šä¼ åˆ°å­˜å‚¨å®¹å™¨ä¸­å‰ç¼€ä¸º`Build.BuildId`çš„æ–‡ä»¶å¤¹ä¸­ï¼Œè¿™æ ·æˆ‘å°±çŸ¥é“åœ¨å‘å¸ƒé˜¶æ®µä½¿ç”¨å“ªä¸ªå·¥ä»¶ã€‚

#### [](#using-the-template)ä½¿ç”¨æ¨¡æ¿

æˆ‘ä¸ºç‰©è”ç½‘ä½œä¸šå®šä¹‰çš„æ¨¡æ¿åœ¨ä¸€ä¸ªåä¸º`template.iot-edge.yml`çš„å•ç‹¬æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä»æˆ‘ä»¬çš„ä¸»`azure-pipelines.yml`æ–‡ä»¶:
ä¸­æ‰§è¡Œå®ƒ

```
- template: .build/template.iot-edge.yml
  parameters:
      name: BuildImages_arm32v7
      CONTAINER_REGISTRY_SERVER: $[dependencies.PrepareAzureACR.outputs['armVar.CONTAINER_REGISTRY_SERVER']]
      SUBSCRIPTION_ID: $[dependencies.PrepareAzureACR.outputs['armVar.SUBSCRIPTION_ID']]
      CONTAINER_REGISTRY_SERVER_NAME: $[dependencies.PrepareAzureACR.outputs['armVar.CONTAINER_REGISTRY_SERVER_NAME']]
      ARTIFACT_STORAGE_NAME: $[dependencies.PrepareArtifactStorage.outputs['artifactVars.ARTIFACT_STORAGE_NAME']]
      defaultPlatform: arm32v7
      azureResourceNamePrefix: $(azureResourceNamePrefix)
      azureSubscription: $(azureSubscription) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä¾èµ–äºä¸€äº›å…¶ä»–ä½œä¸šçš„è¾“å‡ºï¼Œå¹¶è®¿é—®æˆ‘ä»¬ä½¿ç”¨çš„é‚£äº›`$[dependencies.JobName.outputs['taskName.VARIABLE_NAME']]`ï¼Œç„¶åå®ƒä»¬è¢«ä¼ å…¥æ¨¡æ¿ä»¥ä¾›ä½¿ç”¨(è®°ä½å°†å®ƒä»¬èµ‹ç»™æ¨¡æ¿å˜é‡ï¼Œå¦åˆ™å®ƒä»¬[ä¸ä¼šè§£åŒ…](https://dev.to/azure/azure-pipeline-yaml-templates-and-parameters-448j))ã€‚

### [](#creating-our-azure-environment)åˆ›é€ æˆ‘ä»¬çš„è”šè“ç¯å¢ƒ

åœ¨æ„å»ºé˜¶æ®µåªå‰©ä¸‹ä¸€ä»¶äº‹è¦åšï¼Œå‡†å¤‡æˆ‘ä»¬éœ€è¦çš„ Azure ç¯å¢ƒã€‚åŒæ ·ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨èµ„æºç®¡ç†å™¨æ¨¡æ¿æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œä½†æˆ‘ä¸ä¼šå°†å®ƒåµŒå…¥åˆ°åšæ–‡ä¸­ï¼Œå› ä¸ºå®ƒè¶…è¿‡äº† 400 è¡Œï¼Œç›¸åï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å®ƒã€‚

ä½¿ç”¨æ¨¡æ¿åˆ›å»ºç‰©è”ç½‘é›†çº¿å™¨èµ„æºæ—¶ï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·æä¾›è·¯ç”±:

```
...  "routing":  {  "endpoints":  {  "serviceBusQueues":  [],  "serviceBusTopics":  [],  "eventHubs":  [{  "connectionString":  "[listKeys(resourceId('Microsoft.EventHub/namespaces/eventhubs/authorizationRules', variables('EventHubsName'), 'live-list', variables('IotHubName')), '2017-04-01').primaryConnectionString]",  "name":  "sunshine-live-list-eh",  "subscriptionId":  "[subscription().subscriptionId]",  "resourceGroup":  "[resourceGroup().name]"  },  ...  ],  "storageContainers":  []  },  "routes":  [{  "name":  "live-list",  "source":  "DeviceMessages",  "condition":  "__messageType='liveList'",  "endpointNames":  [  "sunshine-live-list-eh"  ],  "isEnabled":  true  },  ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ç”šè‡³å¯ä»¥ä½¿ç”¨ [`listKeys`](https://docs.microsoft.com/en-us/rest/api/eventhub/namespaces/listkeys?WT.mc_id=devto-blog-aapowell) å‡½æ•°ç»“åˆ [`resourceId`](https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-template-functions-resource?WT.mc_id=devto-blog-aapowell#resourceid) æ¥æ„å»ºäº‹ä»¶ä¸­å¿ƒæˆæƒè§„åˆ™çš„è¿æ¥å­—ç¬¦ä¸²ã€‚ä½¿ç”¨`resourceId`æ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½ å°†ç‰‡æ®µè¿æ¥åœ¨ä¸€èµ·æ—¶ï¼Œé™¤äº†èµ„æºç±»å‹ä¹‹å¤–ï¼Œä½ ä¸éœ€è¦`/`åˆ†éš”ç¬¦*ï¼Œè¿™åœ¨ä½ åˆ›å»ºåƒ`"name": "[concat(variables('EventHubsName'), '/live-list/', variables('IotHubName'))]"`è¿™æ ·çš„èµ„æºåç§°æ—¶ä¼šæœ‰ç‚¹æ··ä¹±ï¼Œå› ä¸ºåŒ…å«`/`**ã€‚***

ä¸ºè¯¥æ¨¡æ¿åˆ›å»ºäº†ä¸€ä¸ªæ–°ä½œä¸š:

```
- job: PrepareAzureIoTEnvrionment
  displayName: Prepare Azure IoT Environment
  pool:
      vmImage: "Ubuntu-16.04"
  variables:
      resourceGroupName: sunshine-prod
  steps:
      - task: AzureResourceGroupDeployment@2
        displayName: "Azure  Deployment:Create  Or  Update  Resource  Group  action  on  sunshine-prod"
        inputs:
            azureSubscription: "$(azureSubscription)"
            resourceGroupName: "$(azureResourceNamePrefix)-prod"
            location: "$(azureResourceLocation)"
            templateLocation: Linked artifact
            csmFile: "$(System.DefaultWorkingDirectory)/.build/azure-environment.json"
            overrideParameters: '-name  $(azureResourceNamePrefix)  -location  "$(azureResourceLocation)"'
            deploymentOutputs: ResourceGroupDeploymentOutputs 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ä½ å¯èƒ½æƒ³çŸ¥é“â€œä¸ºä»€ä¹ˆåœ¨ Azure ä¸­åˆ›å»º*ç”Ÿäº§*ç¯å¢ƒçš„æ­¥éª¤æ˜¯åœ¨æ„å»ºé˜¶æ®µå®Œæˆçš„ï¼Œè€Œä¸æ˜¯åœ¨å‘å¸ƒé˜¶æ®µï¼Ÿâ€è¿™æ˜¯ä¸€ä¸ªéå¸¸åˆç†çš„é—®é¢˜ï¼Œæ¯•ç«Ÿï¼Œå¦‚æœæˆ‘*æœ‰å¤šä¸ªç¯å¢ƒï¼Œä¸ºä»€ä¹ˆæˆ‘ä¸æŠŠ Azure è®¾ç½®ä½œä¸ºå‘å¸ƒçš„ä¸€éƒ¨åˆ†å‘¢ï¼Ÿ*

å—¯ï¼Œæˆ‘é‡‡ç”¨è¿™ç§æ–¹æ³•çš„ä¸»è¦åŸå› æ˜¯æˆ‘æƒ³é¿å…å°†èµ„æºç®¡ç†å™¨æ¨¡æ¿ä»æ„å»ºé˜¶æ®µæ¨åˆ°å‘å¸ƒé˜¶æ®µã€‚å› ä¸ºæ„å»ºé˜¶æ®µåš`git clone`è€Œå‘å¸ƒé˜¶æ®µä¸åšï¼Œæ‰€ä»¥æˆ‘ä¸å¾—ä¸å°†æ¨¡æ¿ä½œä¸ºå·¥ä»¶é™„åŠ ã€‚æ­¤å¤–ï¼Œæˆ‘æƒ³åœ¨ä¸¤ä¸ªé˜¶æ®µéƒ½ä½¿ç”¨ä¸€äº›å˜é‡ï¼Œä½†ä½ ä¸èƒ½åœ¨æ„å»ºå’Œå‘å¸ƒä¹‹é—´å…±äº«å˜é‡ï¼Œè¿™ä»ç„¶ä¼šç»™ç¯å¢ƒè®¾ç½®å¸¦æ¥é—®é¢˜ï¼Œæˆ‘éœ€è¦ Azure åŠŸèƒ½å’Œç‰©è”ç½‘ä¸­å¿ƒèµ„æºçš„åç§°ã€‚

ä¸ºäº†è·å¾—è¿™äº›ï¼Œæˆ‘å°†èµ„æºç®¡ç†å™¨éƒ¨ç½²çš„è¾“å‡ºå†™åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶ä½œä¸ºå·¥ä»¶é™„åŠ :

```
- task: PowerShell@2
  displayName: Publish ARM outputs for asset
  inputs:
      targetType: filePath
      filePath: "$(Build.SourcesDirectory)/.build/Set-ReleaseResourceManagerOutput.ps1"
      arguments: -ResourceManagerOutput '$(ResourceGroupDeploymentOutputs)'
- task: PublishBuildArtifacts@1
  displayName: "Publish  Artifact"
  continueOnError: true
  inputs:
      artifactName: arm 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨è¿™ä¸ª PowerShell è„šæœ¬:

```
param  (  [Parameter(Mandatory=$true)]  [string]  $ResourceManagerOutput  )  Set-Content  -Path  $env:BUILD_ARTIFACTSTAGINGDIRECTORY/release-output.json  -Value  $ResourceManagerOutput 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**ğŸ‰æ„å»ºé˜¶æ®µå·²å®Œæˆï¼**ä½ å¯ä»¥åœ¨ GitHub ä¸­æ‰¾åˆ°å®Œæ•´çš„ Azure Pipeline YAML æ–‡ä»¶[ã€‚](https://github.com/aaronpowell/sunshine/blob/1a8a2ba6921915bcc82ac0be477330d5e5b4ea95/azure-pipelines.yml)

[![A successful Build execution](../Images/75d5342d5cb30c8ab4357b1e6a028079.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--_AljqcUq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.aaron-powell.com/images/home-grown-iot/08-001.png)

## [](#deploying-releases)éƒ¨ç½²å‘å¸ƒ

è¿™æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨ Azure Pipelines UI åˆ›å»ºçš„å‘å¸ƒæµç¨‹çš„è®¾è®¡:

[![Our Release process](../Images/a0922587a2c7752ed6eb26cb6bbe0202.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--VB_1WY_6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.aaron-powell.com/images/home-grown-iot/08-002.png)

å·¦è¾¹æ˜¯å°†å¯ç”¨äºå‘å¸ƒçš„å·¥ä»¶ï¼Œå®ƒé“¾æ¥åˆ°æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ„å»ºç®¡é“ï¼Œå¹¶ä¸”å®ƒè¢«è®¾ç½®ä¸ºåœ¨æ„å»ºæˆåŠŸå®Œæˆæ—¶è‡ªåŠ¨è¿è¡Œã€‚

æˆ‘å·²ç»å®šä¹‰äº†ä¸‰ä¸ªé˜¶æ®µï¼Œä»£è¡¨æˆ‘å°†è¿è¡Œçš„ä»»åŠ¡ç»„ã€‚æˆ‘å–œæ¬¢æŠŠé˜¶æ®µæƒ³è±¡æˆç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘æœ‰ä¸€ä¸ªç”¨äºæˆ‘çš„ Raspberry Pi çš„ç¯å¢ƒå’Œä¸€ä¸ªç”¨äºæˆ‘çš„ Azure åŠŸèƒ½çš„ç¯å¢ƒ(æˆ‘ç¡®å®æœ‰ç¬¬äºŒä¸ª Raspberry Pi ç¯å¢ƒï¼Œä½†é‚£æ˜¯æˆ‘åœ¨åŠå…¬å®¤é‡Œçš„æµ‹è¯•è®¾å¤‡ï¼Œæˆ‘åªæ˜¯ç”¨æ¥æµ‹è¯• IoT Edgeï¼Œé€šå¸¸å®ƒç”šè‡³æ²¡æœ‰æ‰“å¼€)ã€‚

### [](#pi-stage)åœ†å‘¨ç‡é˜¶æ®µ

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹éƒ¨ç½²åˆ° Raspberry Pi çš„é˜¶æ®µï¼Œæˆ–è€…è¯´ï¼Œä»»ä½•ç”±ç‰©è”ç½‘è¾¹ç¼˜æ”¯æŒçš„ç‰©è”ç½‘è®¾å¤‡:

[![Tasks for deploying to an IoT Device](../Images/7897e67402c609dc8fc2168473f6bdd1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qU7gI9d6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.aaron-powell.com/images/home-grown-iot/08-003.png)

ç¬¬ä¸€é¡¹ä»»åŠ¡æ˜¯è·å–æˆ‘ä»¬çš„éƒ¨ç½²æ¨¡æ¿ã€‚å› ä¸ºæˆ‘ä½¿ç”¨ Azure å­˜å‚¨å¸æˆ·æ¥å­˜å‚¨å®ƒï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨ Azure CLI æ¥ä¸‹è½½æ–‡ä»¶ï¼Œä½†æ˜¯å¦‚æœæ‚¨å°†å®ƒç”¨ä½œæ„å»ºè¾“å‡ºä¸­çš„å·¥ä»¶ï¼Œæ‚¨å¯èƒ½ä¼šè·³è¿‡è¿™ä¸€æ­¥(å› ä¸ºå·¥ä»¶æ˜¯è‡ªåŠ¨ä¸‹è½½çš„)ã€‚

ä¸‹è½½éƒ¨ç½²åï¼Œæ˜¯æ—¶å€™ä¸ Azure IoT Hub äº¤æµäº†ï¼

#### [](#provisioning-the-device)é…ç½®è®¾å¤‡

ç»§ç»­æˆ‘ä»¬çš„æ–¹æ³•ï¼Œå‡è®¾ä¸å­˜åœ¨ä»»ä½•ä¸œè¥¿ï¼Œæˆ‘ä»¬å°†è¿è¡Œä¸€ä¸ªä»»åŠ¡æ¥æ£€æŸ¥ç‰©è”ç½‘é›†çº¿å™¨ä¸­çš„[è®¾å¤‡èº«ä»½ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒã€‚](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-identity-registry?WT.mc_id=devto-blog-aapowell) 

```
#! /bin/sh

IoTHubName=$(cat $SYSTEM_DEFAULTWORKINGDIRECTORY/_aaronpowell.sunshine/arm/release-output.json | jq '.iotHubName.value' | sed s/\"// | sed s/\"//)

# install iot hub extension
az extension add --name azure-cli-iot-ext

# check if device exists
# note: redirect to /dev/null so the keys aren't printed to logs, and we don't need the output anyway
az iot hub device-identity show \
--device-id $DEVICE_ID \
--hub-name $IoTHubName >> /dev/null

if [$? -ne 0]; then az iot hub device-identity create --hub-name $IoTHubName --device-id $DEVICE_ID --edge-enabled
    TMP_OUTPUT="$(az iot hub device-identity show-connection-string --device-id $DEVICE_ID --hub-name $IoTHubName)"
    RE="\"cs\":\s?\"(.*)\""
    if [[$TMP_OUTPUT =~ $RE]]; then CS_OUTPUT=${BASH_REMATCH[1]};
    fi echo "##vso[task.setvariable variable=CS_OUTPUT]${CS_OUTPUT}"
fi 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æœ‰ç‚¹é»‘æˆ‘çš„ shell è„šæœ¬æŠ€æœ¯æ²¡é‚£ä¹ˆå‰å®³ï¼*ğŸ¤£

æˆ‘ä»¬å°†éœ€è¦åœ¨æ„å»ºé˜¶æ®µä½¿ç”¨èµ„æºç®¡ç†å™¨åˆ›å»ºçš„ç‰©è”ç½‘ä¸­å¿ƒçš„åç§°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [`jq`](https://stedolan.github.io/jq/) è·å–è¯¥åç§°ã€‚ä¹‹åå®‰è£…[ç‰©è”ç½‘é›†çº¿å™¨ CLI æ‰©å±•](https://docs.microsoft.com/en-us/cli/azure/ext/azure-cli-iot-ext/?view=azure-cli-latest&WT.mc_id=devto-blog-aapowell)ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦çš„å‘½ä»¤ä¸åœ¨åŒ…è£…ç›’å†…ã€‚

æˆ‘ä»¬æ„Ÿå…´è¶£çš„å‘½ä»¤æ˜¯ [`az iot hub device-identity show`](https://docs.microsoft.com/en-us/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest&WT.mc_id=devto-blog-aapowell#ext-azure-cli-iot-ext-az-iot-hub-device-identity-show) ï¼Œå®ƒå°†è·å–è®¾å¤‡æ ‡è¯†ä¿¡æ¯*æˆ–*ï¼Œå¦‚æœè®¾å¤‡ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›ä¸€ä¸ªéé›¶é€€å‡ºä»£ç ã€‚ç”±äºè¯¥å‘½ä»¤çš„é»˜è®¤è®¾ç½®æ˜¯å†™å…¥æ ‡å‡†è¾“å‡ºï¼Œå¹¶ä¸”è¾“å‡ºåŒ…å«è®¾å¤‡å¯†é’¥ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒé‡å®šå‘åˆ°`/dev/null`,å› ä¸ºæˆ‘å®é™…ä¸Šä¸éœ€è¦è¾“å‡ºï¼Œæˆ‘åªéœ€è¦é€€å‡ºä»£ç ã€‚å¦‚æœä½ **éœ€è¦è¾“å‡ºï¼Œæˆ‘ä¼šæŠŠå®ƒèµ‹ç»™ä¸€ä¸ªå˜é‡ã€‚**

å¦‚æœè®¾å¤‡ä¸å­˜åœ¨(éé›¶é€€å‡ºä»£ç ï¼Œç”¨`if [$? -ne 0]`æµ‹è¯•)å¯ä»¥ä½¿ç”¨ [`az iot hub device-identity create`](https://docs.microsoft.com/en-us/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest&WT.mc_id=devto-blog-aapowell#ext-azure-cli-iot-ext-az-iot-hub-device-identity-create) ã€‚ä¸€å®šè¦é€šè¿‡`--edge-enabled`ï¼Œè¿™æ ·è®¾å¤‡æ‰èƒ½å’Œ IoT Edge è¿æ¥ï¼

å¦‚æœå¯ä»¥æ£€ç´¢åˆ°è¿æ¥å­—ç¬¦ä¸²ï¼Œè„šæœ¬å°†åšçš„æœ€åä¸€ä»¶äº‹æ˜¯å¯¼å‡ºè¿æ¥å­—ç¬¦ä¸²(ä¸æ˜¯ 100%ç¡®å®šéœ€è¦è¿™æ ·åšï¼Œå®ƒåªæ˜¯åœ¨æ¨¡æ¿ä¸­ï¼).

#### [](#preparing-the-module-twin)å‡†å¤‡æ¨¡å— Twin

åœ¨æˆ‘å…³äº[æ•°æ®ä¸‹è½½å™¨](https://dev.to/aaronpowell/home-grown-iot-data-downloader-56nc)çš„å¸–å­ä¸­ï¼Œæˆ‘æåˆ°æˆ‘å°†ä½¿ç”¨[æ¨¡å—åŒèƒèƒ](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-module-twins?WT.mc_id=devto-blog-aapowell)æ¥è·å–æˆ‘çš„å¤ªé˜³èƒ½é€†å˜å™¨ API çš„å‡­è¯ï¼Œè€Œä¸æ˜¯åµŒå…¥å®ƒä»¬ã€‚

ä¸ºäº†å°†å®ƒä»¬æ”¾å…¥æ¨¡å— twin ä¸­ï¼Œæˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨ Azure CLI:

```
#! /bin/sh

az extension add --name azure-cli-iot-ex

IoTHubName=$(cat $SYSTEM_DEFAULTWORKINGDIRECTORY/_aaronpowell.sunshine/arm/release-output.json | jq '.iotHubName.value' | sed s/\"//g)

az iot hub module-twin update \
--device-id $DEVICE_ID \
--hub-name $IoTHubName \
--module-id SunshineDownloader \
--set properties.desired="{ \"inverter\": { \"username\": \"$SUNSHINEUSER\", \"password\": \"$SUNSHINEPWD\", \"url\": \"$SUNSHINEURL\" } }" >> /dev/null 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨ [`az iot hub module-twin update`](https://docs.microsoft.com/en-us/cli/azure/ext/azure-cli-iot-ext/iot/hub/module-twin?view=azure-cli-latest&WT.mc_id=devto-blog-aapowell#ext-azure-cli-iot-ext-az-iot-hub-module-twin-update) å‘½ä»¤æˆ‘ä»¬å¯ä»¥è®¾ç½® twin çš„`properties.desired`éƒ¨åˆ†(è¿™æ­£å¥½æ˜¯æˆ‘æ”¾å®ƒä»¬çš„åœ°æ–¹ï¼Œä½†æ˜¯ä½ å¯ä»¥åœ¨ twin å±æ€§ä¸­åˆ›å»ºä½ è‡ªå·±çš„èŠ‚ç‚¹)ã€‚åƒä¸Šä¸€ä¸ªä»»åŠ¡ä¸€æ ·ï¼Œè¾“å‡ºè¢«é‡å®šå‘åˆ°`/dev/null`ï¼Œè¿™æ ·è¿”å›çš„æ›´æ–°åçš„å­ªç”Ÿå®šä¹‰å°±ä¸ä¼šå†™å…¥æˆ‘ä»¬çš„æ—¥å¿—æ–‡ä»¶ã€‚æ¯•ç«Ÿï¼Œå¦‚æœæˆ‘ä»¬çš„ç§˜å¯†è¢«æ‰”è¿›æœ¨å¤´é‡Œï¼Œå®ƒä»¬å°±ä¸æ˜¯ç§˜å¯†äº†ï¼

#### [](#its-time-to-deploy)è¯¥éƒ¨ç½²äº†

**æœ€å**æ˜¯æ—¶å€™å°†æˆ‘ä»¬çš„éƒ¨ç½²å‘é€åˆ°ç‰©è”ç½‘è¾¹ç¼˜äº†ï¼æˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨[ç‰©è”ç½‘è¾¹ç¼˜ä»»åŠ¡](https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/azure-iot-edge?view=azure-devops&WT.mc_id=devto-blog-aapowell)ï¼Œä½†è¿™æ¬¡çš„åŠ¨ä½œå°†æ˜¯`Deploy to IoT Edge devices`:

[![Deploy task](../Images/e6eca36536b88ed0f23a88977eae8ef3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--rXAEpGfR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.aaron-powell.com/images/home-grown-iot/08-004.png)

æˆ‘ä»¬æŒ‡å®šå°†è¦æ‰§è¡Œçš„éƒ¨ç½²æ¨¡æ¿(ä»å­˜å‚¨ä¸­è·å¾—çš„æ¨¡æ¿)ï¼Œè¿™å°†æ˜¯ä¸€ä¸ª**å•è®¾å¤‡**éƒ¨ç½²(å¦‚æœæ‚¨è¦éƒ¨ç½²åˆ°ä¸€ä¸ªè®¾å¤‡ç¾¤ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦æ›´æ”¹è¯¥æ¨¡æ¿ï¼Œå¹¶æŒ‡å®šæŸç§æ–¹æ³•æ¥æ‰¾åˆ°ç›®æ ‡è®¾å¤‡ç»„)ã€‚åœ¨å¼•æ“ç›–ä¸‹ï¼Œè¯¥ä»»åŠ¡å°†ä½¿ç”¨æ­£ç¡®çš„å‘½ä»¤æ‰§è¡Œ`iotedgedev`å·¥å…·ï¼Œå¹¶å°†å¯¼è‡´æˆ‘ä»¬éƒ¨ç½²åˆ°ç‰©è”ç½‘è¾¹ç¼˜ï¼Œå¹¶æœ€ç»ˆéƒ¨ç½²åˆ°æˆ‘ä»¬çš„è®¾å¤‡ï¼ğŸ‰

### [](#deploying-functions)éƒ¨ç½²åŠŸèƒ½

éšç€æˆ‘ä»¬ä¸ºç‰©è”ç½‘è®¾å¤‡å®šä¹‰çš„é˜¶æ®µï¼Œæ˜¯æ—¶å€™ä½¿ç”¨ Azure åŠŸèƒ½äº†ã€‚äº‹å®è¯æ˜ï¼ŒAzure Pipelines éå¸¸æ“…é•¿åšè¿™ç§éƒ¨ç½²ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¥å®Œæˆä¸€ä¸ª[ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯ä¸ºå®ƒæä¾›åŒ…å«å‡½æ•°çš„ ZIP æ–‡ä»¶(æ¥è‡ªæˆ‘ä»¬çš„å·¥ä»¶)ã€‚](https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-rm-web-app-deployment?view=azure-devops&WT.mc_id=devto-blog-aapowell)

ä¸éœ€è¦æä¾›èµ„æºç®¡ç†å™¨æ¨¡æ¿ä¸­è®¾ç½®çš„è¿æ¥å­—ç¬¦ä¸²[ï¼](https://github.com/aaronpowell/sunshine/blob/1a8a2ba6921915bcc82ac0be477330d5e5b4ea95/.build/azure-environment.json#L7-L22)

**ğŸ‰å‘å¸ƒé˜¶æ®µå®Œæˆï¼**

[![Deployment is green](../Images/a0713946a8ba9f33833102b7ff20d2c3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--7okGyzbo--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.aaron-powell.com/images/home-grown-iot/08-005.png)

## [](#conclusion)ç»“è®º

å”·ï¼Œé‚£æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„å¸–å­ï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»è¦†ç›–äº†å¾ˆå¤šï¼æˆ‘ä»¬çš„éƒ¨ç½²æ˜¯ç«¯åˆ°ç«¯çš„ï¼Œä»è§¦å‘æ„å»ºçš„`git push`åˆ°åˆ›å»º Azure ç¯å¢ƒã€ç¼–è¯‘æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåˆ°æ„å»º Docker æ˜ åƒã€åœ¨ IoT Hub ä¸­è®¾ç½®è®¾å¤‡å¹¶æœ€ç»ˆéƒ¨ç½²åˆ°è¿™äº›è®¾å¤‡ã€‚

æˆ‘å·²ç»å…¬å¼€äº†æˆ‘ä½¿ç”¨çš„ Azure ç®¡é“ï¼Œæ‰€ä»¥ä½ å¯ä»¥çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼Œä½ ä¼šåœ¨è¿™é‡Œæ‰¾åˆ°[æ„å»ºé˜¶æ®µ](https://dev.azure.com/aaronpowell/Sunshine/_build?definitionId=25&_a=summary)å’Œ[å‘å¸ƒé˜¶æ®µ](https://dev.azure.com/aaronpowell/Sunshine/_release?definitionId=1&view=mine&_a=releases)ã€‚

æ­£å¦‚æˆ‘åœ¨å¼€å§‹æ—¶æ‰€è¯´çš„ï¼Œæˆ‘é¼“åŠ±ä½ é˜…è¯»ä¸€ä¸‹ [Microsoft Docs](https://docs.microsoft.com/en-us/azure/iot-edge/how-to-devops-project?WT.mc_id=devto-blog-aapowell) ä¸Šçš„ä¿¡æ¯ï¼Œå¯¹è¿™ä¸ªè¿‡ç¨‹æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œç„¶åç”¨è¿™ç¯‡æ–‡ç« æ¥è¡¥å……ä¸€åˆ‡æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

ç¦»å©šå¿«ä¹ï¼