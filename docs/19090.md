# è‡ªåˆ¶ç‰©è”ç½‘æ•°æ®ä¸‹è½½å™¨

> åŸæ–‡:[https://dev . to/aaronpowell/home-grown-IOT-data-downloader-56nc](https://dev.to/aaronpowell/home-grown-iot-data-downloader-56nc)

æˆ‘ä»¬ä¸Šæ¬¡è®¨è®ºäº†å¦‚ä½•æ„å»ºç‰©è”ç½‘é¡¹ç›®çš„æ•°æ®ç»“æ„ï¼Œä»¥åŠå¼•å¯¼æˆ‘æœ€ç»ˆé€‰æ‹©è¯¥é¡¹ç›®ç»“æ„çš„ä¸€äº›å†³å®šï¼Œå› æ­¤ç°åœ¨ä¼¼ä¹æ˜¯å¼€å§‹ç ”ç©¶ä»£ç çš„å¥½æ—¶æœºï¼Œç‰¹åˆ«æ˜¯æˆ‘ç”¨æ¥ä»é€†å˜å™¨æœ¬èº«æ•è·æ•°æ®çš„ä»£ç ã€‚

æˆ‘å°†æŠŠé‡ç‚¹æ”¾åœ¨ä¸‹è½½å™¨çš„ä»£ç ä¸Šï¼Œå®ƒä½äº GitHub repo çš„è¿™ä¸€éƒ¨åˆ†[ä¸­ï¼ŒåŒæ—¶ä¹Ÿæ¶‰åŠåˆ°æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨çš„ä¸€èˆ¬å¼€å‘æ–¹æ³•ã€‚](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Sunshine.Downloader)

## [](#codebase-basics)ä»£ç åŸºç¡€çŸ¥è¯†

è®©æˆ‘ä»¬ä»ä»£ç åº“å¦‚ä½•å·¥ä½œçš„ä¸€äº›åŸºç¡€å¼€å§‹ã€‚æ­£å¦‚æˆ‘åœ¨[åºè¨€](https://dev.to/azure/home-grown-iot-prologue-3k9h)ä¸­æåˆ°çš„ï¼Œæˆ‘é€‰æ‹©ç”¨ F#æ¥åšè¿™ä»¶äº‹ã€‚NET æ ¸å¿ƒåº”ç”¨ç¨‹åºï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥è½»æ¾åœ°å°†å®ƒéƒ¨ç½²åˆ° Linux å’Œ Windows ä¸Šã€‚æˆ‘è¿˜ä½¿ç”¨ Docker è¿›è¡Œå¼€å‘å’Œéƒ¨ç½²(æˆ‘å°†åœ¨ä»¥åçš„æ–‡ç« ä¸­ä»‹ç»æœ¬åœ°å¼€å‘)ï¼Œä»¥ä½¿æˆ‘æ›´å®¹æ˜“æ§åˆ¶ä¾èµ–é¡¹å’Œç¯å¢ƒã€‚

æˆ‘è¿˜é€‰æ‹©ä½¿ç”¨ [Paket](https://fsprojects.github.io/Paket/) ï¼Œå®ƒæ˜¯ NuGet çš„æ›¿ä»£åŒ…ç®¡ç†å™¨ï¼Œåœ¨ F#ç¤¾åŒºä¸­éå¸¸å¸¸è§ï¼Œä½†ä¹Ÿå¼•å…¥äº†é”æ–‡ä»¶çš„æ¦‚å¿µï¼Œä»¥æ›´å¥½åœ°å¤„ç†ä¼ é€’ä¾èµ–æˆ–å†²çªä¾èµ–ç‰ˆæœ¬ã€‚æˆ‘æ‰¿è®¤æˆ‘ä¸å–œæ¬¢ Paketï¼Œæˆ‘ç¡®å®æœ‰å¾ˆå¤šæ¬¡ä¸å¾—ä¸ç§¯æåœ°ä¸å®ƒæ–—äº‰ï¼Œè€Œä¸”å®ƒä¹Ÿä¸æ˜¯ä¸€ä¸ª. NET æ ¸å¿ƒå·¥å…·ï¼Œè¿™æ„å‘³ç€å¦‚æœä½ æƒ³ä½¿ç”¨ Linux/WSL æˆ–è€…ä¾èµ–äº[æ­£åœ¨å¼€å‘ä¸”ä¸å—æ”¯æŒçš„ç‰ˆæœ¬](https://github.com/fsprojects/Paket/issues/2875)ï¼Œä½ å°±éœ€è¦`mono`(è¿™æ­£æ˜¯æˆ‘æ‰€åšçš„)ã€‚ä½†æ˜¯æœ€åæˆ‘æŠŠå®ƒå…¨éƒ¨ä¿®å¥½äº†ï¼Œæ‰€ä»¥æˆ‘å°å¿ƒç¿¼ç¿¼åœ°ä¸å»ç¢°å®ƒï¼Œä»¥å…å¼„åä¸œè¥¿ï¼ğŸ˜

ä»£ç åº“è¢«åˆ†æˆ 3 ä¸ªé¡¹ç›®ï¼Œä¸‹è½½å™¨(æˆ‘ä»¬ä»Šå¤©å°†è®¨è®º)ã€å‡½æ•°å’Œæ¨¡æ‹Ÿ API(ç”¨äºæœ¬åœ°å¼€å‘)ã€‚è¿™äº›éƒ½å­˜åœ¨äº`src`æ–‡ä»¶å¤¹ä¸­ï¼Œæ—è¾¹æ˜¯ä¸€äº›å…±äº«æ–‡ä»¶(åœ¨`Shared`ä¸­)ã€‚git repo çš„æ ¹åŒ…å«é€šå¸¸çš„ git æ–‡ä»¶ã€æˆ‘çš„ç”¨äºæ„å»ºç®¡é“çš„`azure-pipelines.yml`(æˆ‘å°†åœ¨ä»¥åè®¨è®ºç®¡é“)ã€Paket æ–‡ä»¶å’Œä¸€ä¸ª`.sln`ã€‚ä¸å¯å¦è®¤ï¼Œæˆ‘ç”¨ VS ä»£ç åšäº†å¤§éƒ¨åˆ†å¼€å‘å·¥ä½œï¼Œä½†æœ‰æ—¶æˆ‘ä¼šå¯åŠ¨å®Œæ•´çš„ Visual Studioï¼Œå°¤å…¶æ˜¯åœ¨è¯•å›¾å¯è§†åŒ–ä¾èµ–æ ‘çš„æ—¶å€™ã€‚

## [](#the-downloader)ä¸‹è½½å™¨

æ˜¯æ—¶å€™å¼€å§‹ç ”ç©¶ä¸‹è½½å™¨äº†ï¼Œè¿™æ ·å¯ä»¥äº†è§£ä¸€ä¸‹ ABB å˜é¢‘å™¨æ˜¯å¦‚ä½•å…¬å¼€å…¶ API çš„ã€‚ä½†æ˜¯æœ‰ä¸€ä»¶äº‹æˆ‘æƒ³ä»ä¸€å¼€å§‹å°±è¯´æ¸…æ¥š:

æˆ‘æ­£åœ¨å¤„ç†ä¸€ä¸ªæ²¡æœ‰æ–‡æ¡£è®°å½•çš„å…³äºå˜é¢‘å™¨çš„ APIï¼Œå¹¶ä¸”ä»¥ä¸€ç§å®ƒä¸åº”è¯¥è¢«ä½¿ç”¨çš„æ–¹å¼ä½¿ç”¨å®ƒã€‚ä»¥è¿™ç§æ–¹å¼è®¿é—®æ‚¨çš„é€†å˜å™¨åº”è¯¥ä¸ä¼šæŸåä»»ä½•ä¸œè¥¿ï¼Œä½†å®ƒå¯èƒ½ä¼šã€‚æˆ‘å¯¹ä½ å¯èƒ½é€ æˆçš„ä»»ä½•æŸå®³ä¸è´Ÿä»»ä½•è´£ä»»ï¼åšè¿™ä»¶äº‹é£é™©è‡ªæ‹…ï¼

å…è´£å£°æ˜å®Œæˆåï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è·å¾—æ•°æ®ã€‚æˆ‘çš„ç¬¬ä¸€é¡¹å·¥ä½œæ˜¯ç ”ç©¶å¦‚ä½•å®é™…è·å–æ•°æ®ï¼Œæ¯•ç«Ÿï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ–‡æ¡£åŒ–çš„ APIï¼Œæ‰€ä»¥æˆ‘éœ€è¦ç ”ç©¶å­˜åœ¨å“ªäº›ç«¯ç‚¹ä»¥åŠæˆ‘éœ€è¦è®¿é—®ä»€ä¹ˆã€‚

æˆ‘é‡‡å–çš„æ–¹æ³•æ˜¯æ‰“å¼€æµè§ˆå™¨ä¸­çš„ç½‘ç»œå·¥å…·ï¼ŒåŒæ—¶åœ¨é€†å˜å™¨çš„ä»ªè¡¨æ¿ä¸Šè§‚çœ‹ XHR ç½‘ç»œäº‹ä»¶ã€‚é‰´äºæˆ‘å·²ç»ç¡®å®šå®ƒæ˜¯ä¸€ä¸ª AngularJS åº”ç”¨ç¨‹åºï¼Œå®ƒå®é™…ä¸Šåªæ˜¯ä¸€ä¸ªè§‚å¯Ÿç½‘ç»œæµé‡ä»¥æ‰¾åˆ°æœ€æœ‰ç”¨çš„ä¸œè¥¿çš„é—®é¢˜ã€‚é€šè¿‡è¿™æ ·åšï¼Œæˆ‘å‘ç°äº† 4 ä¸ªæœ‰è¶£çš„ API ç«¯ç‚¹(è¿˜æœ‰å…¶ä»–çš„ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“å®ƒä»¬æ˜¯åšä»€ä¹ˆçš„ï¼Œæˆ–è€…å®ƒä»¬åªæ˜¯ä¿æŒæ´»åŠ¨çŠ¶æ€çš„æµ‹è¯•):

*   `/v1/specs`
    *   è¿™ä¸ª API æè¿°äº†å¯ç”¨çš„è®¾å¤‡ï¼Œå¹¶è¿”å›ä¸€ä¸ª JSON æœ‰æ•ˆè½½è·([ç¤ºä¾‹](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Shared/sample-data/specs.json))ï¼Œè¯¥è½½è·ä¸ºæˆ‘æä¾›äº†å…³äº`device`(é€†å˜å™¨)å’Œ`logger`(å‘ ABB çš„äº‘å¹³å°å‘é€æ•°æ®çš„ä¸œè¥¿)çš„ä¿¡æ¯
    *   æœ€ç»ˆï¼Œè¿™ä¸ª API æ˜¯ä¸€ä¸ªå…ƒæ•°æ®ç«¯ç‚¹ï¼Œæˆ‘ä¸éœ€è¦*è°ƒç”¨å®ƒï¼Œä½†æ˜¯æˆ‘éœ€è¦è°ƒç”¨å®ƒï¼Œå› ä¸ºè¿™æ„å‘³ç€æˆ‘ä¸éœ€è¦åœ¨è§£å†³æ–¹æ¡ˆä¸­å¯¹æˆ‘çš„è®¾å¤‡è¿›è¡Œä»»ä½•ç¡¬ç¼–ç *
    *   å½“ AngularJS åº”ç”¨ç¨‹åºç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä»ªè¡¨æ¿ä¼¼ä¹ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä»¥åå†ä¹Ÿä¸ä¼šè°ƒç”¨äº†(æˆ‘çŒœå€¼åœ¨ JavaScript å†…å­˜ä¸­)
*   `/v1/livedata/list`
    *   è¿™æ˜¯`livedata`ä¸‹çš„ä¸¤ä¸ª API ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯å¦ä¸€ä¸ªå…ƒæ•°æ®ç«¯ç‚¹ï¼Œè¿™æ¬¡å®ƒç»™æˆ‘æä¾›äº†å…³äºé€†å˜å™¨æ­£åœ¨ç›‘æ§å“ªäº›ä¼ æ„Ÿå™¨çš„ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥ä»ä¸­è·å–æ•°æ®ã€‚å®ƒè¿˜æä¾›äº†å…³äºå®ƒä»¬çš„ä¿¡æ¯ï¼Œå¦‚å®ƒä»¬çš„åº¦é‡å•ä½ã€æè¿°(ä¸€èˆ¬æ¥è¯´ï¼Œå®é™…ä¸Šä¸æ˜¯æè¿°æ€§çš„ï¼)å’Œå°æ•°ç²¾åº¦ã€‚æˆ‘åœ¨ GitHub ä¸Šåˆæœ‰äº†ä¸€ä¸ªä¾‹å­
    *   ä»ªè¡¨æ¿ä¼¼ä¹æ¯ 5 åˆ†é’Ÿè°ƒç”¨ä¸€æ¬¡ã€‚æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆå®ƒä¼šåˆ·æ–°è¿™ä¸ªï¼Œå¸Œæœ›ä¼ æ„Ÿå™¨ä¸ä¼šç»å¸¸æ”¹å˜ï¼
*   `/v1/livedata`
    *   è¿™æ˜¯æœ‰è¶£çš„éƒ¨åˆ†ï¼Œè¿™æ˜¯æ•°æ®æœ‰ç”¨çš„åœ°æ–¹ï¼Œå®ƒè¿”å›ç”±`livedata/list` ( [ç¤ºä¾‹](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Shared/sample-data/live-data.json))æè¿°çš„ä¼ æ„Ÿå™¨çš„å€¼
    *   ä»ªè¡¨æ¿è°ƒç”¨è¿™ä¸ª**å¾ˆå¤šæ¬¡**ï¼Œå¤§çº¦æ¯ 30 ç§’ä¸€æ¬¡ï¼Œè¿™æ˜¯åˆç†çš„ï¼Œå› ä¸ºå®ƒæ˜¯ä¸»è¦çš„æ•°æ®é¦ˆé€
*   `/v1/feeds`
    *   è¿™ä¸ª API è®©æˆ‘å¾ˆå›°æƒ‘ï¼Œå› ä¸ºå®ƒæ€»æ˜¯è¢«ä¸€å †æŸ¥è¯¢å­—ç¬¦ä¸²å€¼è°ƒç”¨ï¼Œè¿™äº›å€¼åœ¨ 5 åˆ†é’Ÿå†…è¿”å›`Pgrid`ã€‚é€šè¿‡æŸ¥çœ‹æ•°æ®ï¼Œ*çœ‹èµ·æ¥*è®¤ä¸º`Pgrid`ä¸ä»é€†å˜å™¨åˆ°ç”µç½‘çš„åŠŸç‡(ç“¦ç‰¹)æœ‰å…³(ä»åç§°ä¸Šçœ‹è¿™æ˜¯åˆç†çš„),ä½†æ˜¯å¦‚æœæˆ‘æƒ³è·å¾—å…¶ä»–æŒ‡æ ‡ï¼Œæˆ‘æ— æ³•åœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­æ‰¾åˆ°ä»»ä½•å…¶ä»–å¯ä»¥è°ƒæ•´çš„å†…å®¹ã€‚æˆ‘æƒ³æˆ‘ä¹Ÿåœ¨`livedata`å¾—åˆ°äº†è¿™ä¸ªä¿¡æ¯ï¼Œä½†æ˜¯æ•è·ä¸¤æ¬¡ä¹Ÿæ— å¦¨ï¼Œæ¯•ç«Ÿï¼Œä»–ä»¬ä¸ºæ­¤ä¸“é—¨å¼€å‘äº†ä¸€ä¸ª APIã€‚æ— è®ºå¦‚ä½•ï¼Œè¿™ä¸ªå“åº”çš„ç»“æ„å¾ˆå¥‡æ€ª([ä¾‹å­](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Shared/sample-data/pgrid-sum.json))ä½†æ˜¯å¹¶ä¸*å¤ªéš¾ç†è§£*
    *   ä»ªè¡¨æ¿ä¼¼ä¹å¤§çº¦æ¯ 5 åˆ†é’Ÿè°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœå“åº”æ˜¯ 5 åˆ†é’Ÿæ—¶é—´ç‰‡ï¼Œå°±æ²¡æœ‰å¿…è¦æ¯”è¿™æ›´é¢‘ç¹åœ°è°ƒç”¨å®ƒ

æœ‰äº†æˆ‘ä»¬è¦è°ƒç”¨çš„ 4 ä¸ª APIï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ„å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºäº†ã€‚

### [](#api-helpers)API åŠ©æ‰‹

æˆ‘æ­£åœ¨è®¿é—®çš„ API æ˜¯ä½¿ç”¨åŸºæœ¬èº«ä»½éªŒè¯æ¥ä¿æŠ¤çš„ï¼Œå®ƒå‘åŒ…å« base 64 ç¼–ç å­—ç¬¦ä¸²`username:password`çš„è¯·æ±‚æ·»åŠ äº†ä¸€ä¸ª`Authorization`ä»¤ç‰Œï¼Œä¸æ˜¯éå¸¸å®‰å…¨ï¼Œä½†ä¹Ÿå¯ä»¥ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå°çš„å¸®åŠ©å‡½æ•°æ¥ä¸ºæˆ‘ä»¬ç”Ÿæˆå®ƒ:

```
let getAuthToken username password =
    sprintf "%s:%s" username password
    |> ASCIIEncoding.ASCII.GetBytes
    |> Convert.ToBase64String 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†è®¿é—® APIï¼Œæˆ‘ä½¿ç”¨äº† [FSharpã€‚æ•°æ®](http://fsharp.github.io/FSharp.Data/)çš„ [HTTP å®ç”¨ç¨‹åº](http://fsharp.github.io/FSharp.Data/library/Http.html)ï¼Œå¹¶å°†å…¶åŒ…è£…åœ¨ä¸€ä¸ªåä¸º`getData` :
çš„å‡½æ•°ä¸­

```
let getData authToken baseUri (path : string) =
    let url = Uri(baseUri, path)
    printfn "Requesting: %s" (url.ToString())
    Http.AsyncRequestString
        ( url.ToString(),
          httpMethod = "GET",
          headers = [ Accept HttpContentTypes.Json
                      Authorization (sprintf "Basic %s" authToken) ] ) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯¥å‡½æ•°è·å–ä»¤ç‰Œ(ä»`getAuthToken`è¾“å‡º)å’Œå˜é¢‘å™¨çš„ API åº“ï¼Œæˆ‘ä»¬å‘å…¶ä¸­æ·»åŠ ç‰¹å®šçš„ API è·¯å¾„ã€‚ç„¶åï¼Œè¿™ä¸ªå°å‡½æ•°å°†è®¾ç½®å°è£…åœ¨é€‚å½“çš„å¤´ä¸­ï¼Œå¹¶å‘å‡ºè¯·æ±‚ä»¥è·å– JSON å“åº”ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚

### [](#starting-the-application)å¯åŠ¨åº”ç”¨ç¨‹åº

å½“ä¸‹è½½å™¨å¯åŠ¨æ—¶ï¼Œå®ƒæ‰“å°å‡º[æ ‡å¿—](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Sunshine.Downloader/Logo.fs)(å¸®åŠ©æˆ‘åœ¨æ—¥å¿—ä¸­å‘ç°å®ƒä½•æ—¶é‡å¯ğŸ¤£)ç„¶åå»ºç«‹åˆ° Azure IoT Hub çš„è¿æ¥ã€‚

### [](#establishing-iot-client-connections)å»ºç«‹ç‰©è”ç½‘å®¢æˆ·ç«¯è¿æ¥

æœ‰äº†è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œæˆ‘è¦ä¹ˆåœ¨æœ¬åœ°è¿è¡Œå®ƒï¼Œè¦ä¹ˆåœ¨æˆ‘çš„ Raspberry Pi ä¸Šè¿è¡Œå®ƒï¼Œæˆ‘è°ƒæ•´æˆ‘å»ºç«‹è¿æ¥çš„æ–¹å¼ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œè°ƒæ•´è¿æ¥çš„ç±»å‹ã€‚å¯¹äºæœ¬åœ°å¼€å‘ï¼Œæˆ‘è¿æ¥åˆ°ç‰©è”ç½‘ä¸­å¿ƒä½œä¸ºä¸€ä¸ª[ç®¡ç†è®¾å¤‡](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-device-management-overview?WT.mc_id=devto-blog-aapowell)ï¼Œä½†å½“å®ƒåœ¨æ ‘è“ Pi ä¸Šæ—¶ï¼Œå®ƒä½¿ç”¨ç‰©è”ç½‘è¾¹ç¼˜ä½œä¸ºä¸€ä¸ª[æ¨¡å—](https://docs.microsoft.com/en-us/azure/iot-edge/iot-edge-modules?WT.mc_id=aaronpowell-blog-aapowell)è¿›è¡Œéƒ¨ç½²ã€‚å½“æˆ‘è¿›è¡Œæœ¬åœ°å¼€å‘å’Œéƒ¨ç½²æ—¶ï¼Œæˆ‘å°†æ›´è¯¦ç»†åœ°è®¨è®ºè¿™ä¸¤ä¸ªä¸»é¢˜ï¼Œä½†æ˜¯è¦çŸ¥é“ï¼Œé™¤äº†ä¸€ä¸ªä½¿ç”¨ [`DeviceClient`](https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.devices.client.deviceclient?view=azure-dotnet&WT.mc_id=devto-blog-aapowell) å’Œå¦ä¸€ä¸ªä½¿ç”¨ [`ModuleClient`](https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.devices.client.moduleclient?view=azure-dotnet&WT.mc_id=devto-blog-aapowell) ä¹‹å¤–ï¼Œæ‚¨çš„è¿æ¥æ–¹å¼å¹¶æ²¡æœ‰å¤ªå¤§çš„ä¸åŒã€‚

æ­£å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ç”¨ä¸€ä¸ª F#è®°å½•ç±»å‹å’Œåˆ©ç”¨å‡½æ•°ä½œä¸ºå¼•ç”¨æ¥åŒ…è£…å®¢æˆ·ç«¯(é™¤äº†`Object`ï¼Œå®ƒä»¬ä¸å…±äº«ä¸€ä¸ªå…¬å…±çš„åŸºæœ¬ç±»å‹:

```
module IoTWrapper
open Microsoft.Azure.Devices.Client
open Microsoft.Azure.Devices.Shared

type IoTConnectionWrapper =
  { SendEventAsync : Message -> Async<unit>
    GetTwinAsync : unit -> Async<Twin> }

let getIoTHubClient iotConnStr =
    async {
    return! match iotConnStr with
            | null | "" ->
              async {
              let amqpSetting = AmqpTransportSettings(TransportType.Amqp_Tcp_Only) :> ITransportSettings;
              let! client = [| amqpSetting |]
                            |> ModuleClient.CreateFromEnvironmentAsync
                            |> Async.AwaitTask
              do! client.OpenAsync() |> Async.AwaitTask
              return { SendEventAsync = fun msg -> client.SendEventAsync msg |> Async.AwaitTask
                       GetTwinAsync = fun () -> client.GetTwinAsync() |> Async.AwaitTask } }
            | _ ->
              async {
              let client = DeviceClient.CreateFromConnectionString iotConnStr
              return { SendEventAsync = fun msg -> client.SendEventAsync msg |> Async.AwaitTask
                       GetTwinAsync = fun () -> client.GetTwinAsync() |> Async.AwaitTask } } } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`getIoTHubClient`è·å–ä¸€ä¸ªè¿æ¥å­—ç¬¦ä¸²(ä¸ºæœ¬åœ°å¼€å‘ä¼ é€’çš„)å¹¶ä½¿ç”¨æ¨¡å¼åŒ¹é…æ¥æ£€æŸ¥æˆ‘æ˜¯å¦æä¾›äº†ä¸€ä¸ªè¿æ¥å­—ç¬¦ä¸²(éšå«çš„æœ¬åœ°å¼€å‘)ã€‚*è¾¹æ³¨:æˆ‘çˆ± F#å›¾æ¡ˆæ­é…ï¼*

ä½¿ç”¨`| null | "" ->`çš„æ¨¡å¼å…è®¸æˆ‘æµ‹è¯•ä¸€äº›ä¸åŒçš„ç»“æœï¼Œå¹¶è®©å®ƒä»¬éƒ½äº§ç”Ÿåœ¨åŒä¸€ä¸ªå—ä¸­ï¼Œè€Œ`| _ ->`çš„æ„æ€æ˜¯â€œä»¥å‰æ²¡æœ‰åŒ¹é…çš„ä»»ä½•ä¸œè¥¿â€ã€‚æˆ‘è¿˜å¹¿æ³›ä½¿ç”¨äº† [F#å¼‚æ­¥å·¥ä½œæµ](https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/asynchronous-workflows?WT.mc_id=aaronpowell-blog-aapowell)æ¥å±•å¼€ C# `Task` APIï¼Œä½¿å…¶æ›´å¥½åœ°é€‚åº” F#çš„å¼‚æ­¥æ–¹æ³•ã€‚

### [](#using-iot-twins)ä½¿ç”¨ç‰©è”ç½‘åŒèƒèƒ

å½“æ¶‰åŠåˆ°ä½¿ç”¨ç‰©è”ç½‘è§£å†³æ–¹æ¡ˆæ—¶ï¼Œè®¾å¤‡ä¸Šè¿è¡Œçš„ä»£ç å¯èƒ½éå¸¸é€šç”¨ï¼Œæ¯•ç«Ÿï¼Œå®ƒå¯èƒ½è¢«éƒ¨ç½²åˆ°æ•°ç™¾å°è®¾å¤‡ä¸Šï¼Œæ‰€ä»¥ä½ ä¸å¸Œæœ›å°†ç§˜å¯†åµŒå…¥åˆ°ä»£ç åº“ä¸­ï¼Œå› ä¸ºè¿™æ ·ä½ åœ¨ä»»ä½•åœ°æ–¹éƒ½æœ‰ç›¸åŒçš„ç§˜å¯†ã€‚è™½ç„¶ **I** å¯èƒ½åªæœ‰ä¸€å°è®¾å¤‡ï¼Œä½†æˆ‘ä»ç„¶ä¸æƒ³åœ¨ä»£ç ä¸­åµŒå…¥æˆ‘çš„é€†å˜å™¨çš„ç”¨æˆ·åã€å¯†ç å’Œ IP åœ°å€(æˆ‘ä¸æƒ³è®© GitHub ä¸Šçš„å˜æˆ**ï¼)æ‰€ä»¥æˆ‘éœ€è¦æŸç§æ–¹æ³•ä»¥å®‰å…¨çš„æ–¹å¼å°†å®ƒä»¬ä¸‹è½½åˆ°è®¾å¤‡ä¸Šã€‚**

æœ€åˆï¼Œå½“ Docker å®¹å™¨å¼€å§‹ä¼ é€’ç¯å¢ƒå˜é‡æ—¶ï¼Œæˆ‘æ²¿ç€åœ¨ Docker å®¹å™¨ä¸Šè®¾ç½®ç¯å¢ƒå˜é‡çš„é“è·¯å‰è¿›ï¼Œä½†æ˜¯å½“æ¶‰åŠåˆ°éƒ¨ç½²åˆ°ç‰©è”ç½‘è®¾å¤‡æ—¶ï¼Œè¿™å°±æœ‰ç‚¹æ£˜æ‰‹äº†ï¼Œç›¸åï¼Œæˆ‘å†³å®šä½¿ç”¨[è®¾å¤‡å­ªç”Ÿ](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-device-twins?WT.mc_id=devto-blog-aapowell)(é™„å¸¦è¯´æ˜:å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯`ModuleClient`ï¼Œæ‚¨å°†ä½¿ç”¨æ¨¡å—å­ªç”Ÿï¼Œå®ƒä¸è®¾å¤‡å­ªç”Ÿç›¸åŒï¼Œä½†èŒƒå›´ä»…é™äºè¯¥æ¨¡å—)ã€‚Device Twin æ˜¯è®¾å¤‡çš„ JSON é…ç½®æ–‡ä»¶ï¼Œå­˜å‚¨åœ¨ Azure ä¸­ï¼Œå¯ä»¥ç”±è®¾å¤‡æˆ–é€šè¿‡ portal/ `az` cli(ä»¥åŠä»»ä½•ç¬¬ä¸‰æ–¹å·¥å…·)è¿›è¡Œæ›´æ–°ã€‚

åœ¨æˆ‘çš„ Twin ä¸­ï¼Œæˆ‘æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å¸¦æœ‰ API è®¤è¯ä¿¡æ¯çš„`Desired Property`:

```
 //  snip  "properties":  {  "desired":  {  "inverter":  {  "username":  "...",  "password":  "...",  "url":  "http://..."  },  "$metadata":  {  //  and  so  on  }  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åå°±æ˜¯[å¾—åˆ°åŒèƒèƒä¿¡æ¯](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Sunshine.Downloader/Program.fs#L21-L23) :
çš„é—®é¢˜äº†

```
 async {
    let! iotClient = getIoTHubClient iotConnStr

    let! twin = iotClient.GetTwinAsync()

    let iotProperties = parseDesiredProperties twin.Properties.Desired 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`parseDesiredProperties`æ˜¯ä¸€ä¸ª[çš„å°å‡½æ•°](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Sunshine.Downloader/IoTWrapper.fs#L28-L32)ï¼Œå¸®åŠ©å°†è¿”å›çš„`TwinCollection`è§£åŒ…ä¸ºå¯¹æˆ‘æœ‰ç”¨çš„ç±»å‹:

```
open FSharp.Data
type DesiredProperties = JsonProvider<""" {"inverter":{"username":"user","password":"pass","url":"http://localhost/"},"$version":4} """>

let parseDesiredProperties (data : TwinCollection) =
  data.ToJson() |> DesiredProperties.Parse 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯èƒ½æ³¨æ„åˆ°æˆ‘ä½¿ç”¨äº† FSharp çš„ [JSON ç±»å‹æä¾›è€…](http://fsharp.github.io/FSharp.Data/library/JsonProvider.html)ã€‚æ•°æ®ï¼Œæˆ‘ç»å¸¸ä½¿ç”¨å®ƒå°† JSON è¡¨ç¤ºè½¬æ¢å›å¼ºç±»å‹å¯¹è±¡ã€‚

ç°åœ¨æˆ‘å¯ä»¥åšä¸€äº›å±€éƒ¨åº”ç”¨æ¥è®¾ç½®`getData`å‡½æ•°ï¼Œä»¥ä¾¿åœ¨åº”ç”¨:
ä¸­å¤šæ¬¡ä½¿ç”¨

```
let token = getAuthToken iotProperties.Inverter.Username iotProperties.Inverter.Password
let getData' = getData token (Uri iotProperties.Inverter.Url) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ„å‘³ç€æ¯å½“æˆ‘éœ€è¦è¿›è¡Œ API è°ƒç”¨æ—¶ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨å·²ç»åº”ç”¨äº†è®¿é—®ä»¤ç‰Œå’ŒåŸºäº URI å‚æ•°çš„è½¬æ¢å™¨çš„`getData'`ã€‚

### [](#polling-apis)è½®è¯¢ API

å¦ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„éƒ¨åˆ†æ˜¯åœ¨ä¸åŒçš„æ—¶é—´è¡¨è½®è¯¢è¿™äº› APIã€‚æˆ‘å¯ä»¥ä½¿ç”¨ç±»ä¼¼ [Hangfire](https://www.hangfire.io/) çš„ä¸œè¥¿ï¼Œä½†æ˜¯æˆ‘è¿˜éœ€è¦åŒ…å«ä¸€ä¸ª SQL Server(æˆ–ç±»ä¼¼çš„)æ¥æœ‰æ•ˆåœ°ç®¡ç†è½®è¯¢ï¼Œè¿™å°†å¢åŠ æˆæœ¬å’Œå¤æ‚æ€§ã€‚å¦‚æœæˆ‘ä¸ºå¤šå°è®¾å¤‡è¿™æ ·åšï¼Œæˆ‘ä¼šæ¨èå®ƒï¼Œä½†å¯¹äºä¸»è¦ä¾›ä¸ªäººä½¿ç”¨çš„å•å°è®¾å¤‡ï¼Œåœæœºå’Œæ•°æ®ä¸¢å¤±å¹¶ä¸æ˜¯ä¸–ç•Œæœ«æ—¥ã€‚

ç›¸åï¼Œæˆ‘ä½¿ç”¨ F#å¼‚æ­¥å·¥ä½œæµä¸­çš„`Async.Start`æ¥ç”Ÿæˆä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œç„¶åè¿è¡Œä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œ[å°±åƒè¿™æ ·çš„](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Sunshine.Downloader/Program.fs#L49-L57) :

```
let rec dataPoller() = async {
    match! getLiveData getData' deviceId with
    | Some liveData -> do! sendIoTMessage iotClient "liveData" correlationId liveData
    | None -> ignore()

    do! int(TimeSpan.FromSeconds(20.).TotalMilliseconds) |> Async.Sleep
    dataPoller() |> Async.Start }

dataPoller() |> Async.Start 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™é‡Œï¼Œæˆ‘æ¯ 20 ç§’è°ƒç”¨ä¸€æ¬¡`livedata` API(è¿™æ ·æœ‰å»¶è¿Ÿï¼Œç­‰ç­‰ã€‚æˆ‘å¤§çº¦æ¯ 30 ç§’å¾—åˆ° 1)ï¼Œå¯¹æˆ‘æ‹¥æœ‰çš„ [API åŒ…è£…å™¨](https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Sunshine.Downloader/LiveData.fs#L25-L39)ä½¿ç”¨æ¨¡å¼åŒ¹é…ï¼Œå®ƒè¿”å›ä¸€ä¸ª [`Option`](https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/options?WT.mc_id=devto-blog-aapowell) ç”¨äºé”™è¯¯å¤„ç†ï¼Œå¹¶å‡è®¾å®ƒæˆåŠŸåœ°å°†æ•°æ®å‘é€åˆ°ç‰©è”ç½‘ä¸­å¿ƒã€‚ä¸ºä»€ä¹ˆæˆ‘è¦ç”¨é€’å½’å‡½æ•°å‘¢ï¼Ÿå¥½å§ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œäº‹å®ä¸Šï¼Œå‡½æ•°è°ƒç”¨å®ƒè‡ªå·±ï¼Œå®ƒå®é™…ä¸Šä¸ä¼ é€’ä»»ä½•æ•°æ®åˆ°æ–°çš„è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åƒæŸç§å¾ªç¯é‚£æ ·åšï¼Œä½†åƒè¿™æ ·çš„é€’å½’å‡½æ•°æ›´åƒæ˜¯ä¸€ä¸ªå¸¸è§çš„ F#æ¨¡å¼ã€‚ä½ å¯èƒ½æƒ³çŸ¥é“å †æ ˆæº¢å‡ºå¼‚å¸¸ï¼Œå¹¸å¥½ F#åœ¨é€’å½’å‡½æ•°æ–¹é¢æœ‰ä¸€äº›å¾ˆå¥½çš„ä¼˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä¸åº”è¯¥ç¢°åˆ°å®ƒï¼Œæˆ‘å·²ç»è®©å®ƒè¿è¡Œäº†å‡ å¤©ï¼Œäº§ç”Ÿäº†æˆåƒä¸Šä¸‡çš„æ¶ˆæ¯ï¼Œå®ƒæ²¡æœ‰å´©æºƒï¼ *â€¦ç„¶è€Œ*

### [](#linking-api-calls-together)å°† API è°ƒç”¨é“¾æ¥åœ¨ä¸€èµ·

æ¯ä¸ª API è°ƒç”¨éƒ½å‘ç”Ÿåœ¨å•ç‹¬çš„åå°ä½œä¸šä¸­ï¼Œç”±å•ç‹¬çš„é€’å½’å‡½æ•°å¤„ç†

### [](#keeping-the-application-running)ä¿æŒåº”ç”¨ç¨‹åºè¿è¡Œ

æˆ‘éœ€è¦åº”ç”¨ç¨‹åºåšçš„æœ€åä¸€ä»¶äº‹æ˜¯ä¸é€€å‡ºï¼Œå› ä¸ºå®ƒä¸çŸ¥é“è¦ç­‰åˆ°åå°ä½œä¸šåœæ­¢ã€‚æœ€åˆï¼Œæˆ‘æ‰“ç®—ä¾èµ–äº`Console.ReadLine()`,å¹¶è®©å®ƒç­‰å¾…ç›´åˆ°ä¸€ä¸ªæ¢è¡Œç¬¦è¢«å‘é€ï¼Œä½†æ˜¯å¦‚æœå®ƒè¿è¡Œåœ¨ä¸€ä¸ªæ²¡æœ‰é™„åŠ `stdin`çš„ Docker å®¹å™¨ä¸­(å³:ä¸€ä¸ªéäº¤äº’å¼å®¹å™¨),è¿™æ˜¯å®ƒè¢«éƒ¨ç½²åˆ° Raspberry Pi çš„æ–¹å¼ï¼Œè¿™å°±ä¸èµ·ä½œç”¨äº†ã€‚

æ–¹ä¾¿çš„æ˜¯ï¼Œæˆ‘ä»¬æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥æµ‹è¯•å®ƒï¼Œ [`Console.IsInputRedirected`](https://docs.microsoft.com/en-us/dotnet/api/system.console.isinputredirected?view=netcore-2.2?WT.mc_id=aaronpowell-blog-aapowell) ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ç»„åˆ:

```
printfn "Background jobs running, now we're waiting... "
if Console.IsInputRedirected then
    while true do
        do! Async.Sleep 300000
else
    Console.ReadLine() |> ignore 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæ ¹æ®æˆ‘ä»¬çš„å®¹å™¨å¦‚ä½•å¯åŠ¨ï¼Œæˆ‘ä»¬è¦ä¹ˆç­‰å¾…æ¢è¡Œç¬¦ç»ˆæ­¢ï¼Œè¦ä¹ˆåº”ç”¨ç¨‹åºå°†æ— é™æœŸè¿è¡Œã€‚

## [](#conclusion)ç»“è®º

ä¸‹è½½å™¨çš„å®Œæ•´ä»£ç åº“åœ¨ GitHub ä¸Šæœ‰[(åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œæˆ‘å·²ç»å°†è¿™ç¯‡æ–‡ç« æäº¤åˆ°äº†`HEAD`)ã€‚]((https://github.com/aaronpowell/sunshine/blob/277c31fcb612d3866daf7759beb9525826778c2c/src/Sunshine.Downloader))

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•åˆ©ç”¨éƒ¨åˆ†åº”ç”¨ç¨‹åºå’Œæ¨¡å¼åŒ¹é…ç­‰ä¸€äº› F#è¯­è¨€ç‰¹æ€§æ¥å®ç°æˆ‘ä»¬çš„ä¸€äº›ç›®æ ‡ï¼Œä»¥åŠå¦‚ä½•å‘è®¾å¤‡æä¾›è¯ä¹¦/æœºå¯†ï¼Œè€Œæ— éœ€å°†å®ƒä»¬åµŒå…¥åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚

æˆ‘å¸Œæœ›è¿™èƒ½è®©ä½ å¯¹æˆ‘ä»é€†å˜å™¨ä¸­æ”¶é›†æ•°æ®çš„æ–¹æ³•æœ‰æ‰€äº†è§£ã€‚æˆ‘å¾ˆå–œæ¬¢è¿™ç§æ–¹æ³•çš„åé¦ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå¯ä»¥åšå¾—æ›´ç®€å•çš„ï¼Ÿæ²¡é“ç†ï¼Ÿä¼¼ä¹å·¥ç¨‹è¿‡åº¦ï¼Ÿ