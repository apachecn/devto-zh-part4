# ç”¨ JavaScript æ¼”å¥ç©ºé¼“

> åŸæ–‡:[https://dev . to/dev dev Charlie/playing-air-drums-in-JavaScript-47jg](https://dev.to/devdevcharlie/playing-air-drums-in-javascript-47jg)

å»å¹´ï¼Œå½“æˆ‘å»å‚åŠ ä¸€ä¸ªå‘¨æœ«çš„å·¥ä½œæ—…è¡Œæ—¶ï¼Œæˆ‘å’Œä¸€ä¸ªä»¥å‰çš„åŒäº‹è°ˆè®ºæˆ‘æœ‰å¤šä¹ˆæƒ³å­¦æ‰“é¼“ï¼Œä½†å®é™…ä¸Šä»æ¥æ²¡æœ‰å­¦è¿‡ï¼Œå› ä¸ºå®ƒéœ€è¦å¾ˆå¤šç©ºé—´ï¼Œè€Œä¸”æ¶å­é¼“ä¹Ÿå¾ˆè´µã€‚

ä¸çŸ¥ä»å“ªé‡Œï¼Œä»–æŠŠæ‰‹ä¼¸è¿›åŒ…é‡Œï¼Œæ‹¿å‡ºäº† Freedrum ä¼ æ„Ÿå™¨ã€‚æˆ‘ä»¥å‰ä»æœªå¬è¯´è¿‡è¿™äº›ä¸œè¥¿ï¼Œä½†ä»–å‘Šè¯‰æˆ‘ï¼Œä½ å¯ä»¥æŠŠè¿™äº›è¿åŠ¨ä¼ æ„Ÿå™¨ç»‘åœ¨é¼“æ£’å’Œé‹å­ä¸Šï¼Œç”¨æ¥æ¼”å¥ç©ºé¼“ã€‚ä½ å¯ä»¥é€šè¿‡è“ç‰™æŠŠå®ƒä»¬è¿æ¥åˆ°ä½ çš„æ‰‹æœºæˆ–ç¬”è®°æœ¬ç”µè„‘ä¸Šï¼Œç„¶åå°±å¯ä»¥ç©äº†ã€‚

è¿™æ˜¯å¦‚æ­¤å·§åˆï¼Œä»–åªæ˜¯ç¢°å·§åœ¨ä»–çš„åŒ…é‡Œï¼Œæˆ‘å¤ªå…´å¥‹äº†ï¼è¿™ä¸ä»…è®©æˆ‘æœ‰å¯èƒ½æ‹¥æœ‰æŸç§æ›´ä¾¿å®œã€æ›´ä¾¿æºçš„æ¶å­é¼“ï¼Œè€Œä¸”çŸ¥é“å®ƒé€šè¿‡è“ç‰™è¿æ¥æ„å‘³ç€æˆ‘ä¸å¾—ä¸å°è¯•ç”¨å®ƒæ¥ç ´è§£ä¸€äº›ä¸œè¥¿ã€‚é‚£ä¸ªå‘¨æœ«æˆ‘è¯•äº†è¯•ï¼Œä½†æ²¡æˆåŠŸã€‚

å‡ å‘¨å‰ï¼Œæˆ‘ä¹°äº†æˆ‘è‡ªå·±çš„ Freedrum å·¥å…·åŒ…ï¼Œä¸Šå‘¨æœ«ï¼Œæˆ‘èŠ±äº†ä¸€äº›æ—¶é—´ç”¨å®ƒæ¥ç ´è§£ï¼Œå®ƒå·¥ä½œäº†ï¼ï¼ğŸ‰ğŸ‰ğŸ‰

å¦‚æœä½ æƒ³è·³è¿‡å…¶ä½™éƒ¨åˆ†ï¼Œåªçœ‹ä»£ç ï¼Œè¯·éšæ„æŸ¥çœ‹ [freedrum.js](https://github.com/charliegerard/freedrum.js) ã€‚

## [](#demo)æ¼”ç¤º

[https://www.youtube.com/embed/UrG_mlfvDjE](https://www.youtube.com/embed/UrG_mlfvDjE)

## [](#how-does-it-work)å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„

æˆ‘ä¹‹å‰ç”¨ JavaScriptã€è“ç‰™å’Œç¡¬ä»¶æ­å»ºè¿‡å‡ ä¸ªé¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘çŸ¥é“åœ¨ Node.js ä¸­å¯ä»¥ä½¿ç”¨ [noble æ¨¡å—](https://github.com/noble/noble)ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å¯ä»¥ä½¿ç”¨ [Web è“ç‰™ API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Bluetooth_API) ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘åšäº†ä¸€äº›ç ”ç©¶ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰äººåšè¿‡ç±»ä¼¼çš„äº‹æƒ…ï¼Œæˆ–è€…è‡³å°‘ï¼Œæˆ‘å¯ä»¥æ‰¾åˆ°ä¸€äº› Freedrum ä¼ æ„Ÿå™¨çš„è“ç‰™è§„èŒƒã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘æ‰¾åˆ°äº†è¿™ä¸ªè¦ç‚¹ï¼Œä½†è¿™æ˜¯å®ƒçš„ä¸€ç§â€¦

æˆ‘é¦–å…ˆé€šè¿‡å°è¯•è¿æ¥åˆ°æåˆ°çš„è“ç‰™æœåŠ¡æ¥æ£€æŸ¥ gist ä¸­çš„ä¿¡æ¯æ˜¯å¦ä»ç„¶æ­£ç¡®ã€‚

ä¸€æ—¦æˆ‘çœ‹åˆ° gist ä¸­æŒ‡å‡ºçš„ uuids æ­£åœ¨å·¥ä½œï¼Œæˆ‘å°±å¼€å§‹å¼€å‘ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªåœ¨ Node.js ä¸­ï¼Œå¦ä¸€ä¸ªä½¿ç”¨ Web Bluetooth APIã€‚

### [](#web-bluetooth-api)Web è“ç‰™ API

ä»£ç å’Œä»»ä½• Web è“ç‰™ API ä¾‹å­æ²¡æœ‰å¤ªå¤§åŒºåˆ«:

```
const bluetoothLEMidi = '03b80e5a-ede8-4b33-a751-6ce34ec4c700';
const bleMidiCharacteristic = '7772e5db-3868-4112-a1a9-f2669d106bf3';
const uuid = "XrnS1FRG/q/kM7ecsfErcg==";

const options = {
  "filters": [
      {name: uuid},
      {services: [bluetoothLEMidi]}
  ],
};
return navigator.bluetooth.requestDevice(options)
.then(device => device.gatt.connect())
.then(server => server.getPrimaryService(bluetoothLEMidi)
.then(service => service.getCharacteristic(bleMidiCharacteristic)
.then(characteristic => characteristic.startNotifications())
.then(characteristic => {
  characteristic.addEventListener('characteristicvaluechanged', function(e){
  let data = event.target.value;
  });
 }) 
```

æˆ‘ä»¬é¦–å…ˆè¯·æ±‚ä¸€ä¸ªè®¾å¤‡ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ä¸€ä¸ª Freedrum ä¼ æ„Ÿå™¨ï¼›æˆ‘ä»¬è¿æ¥åˆ°å®ƒï¼Œè¯·æ±‚å®ƒçš„ä¸€ä¸ªæœåŠ¡å’Œç‰¹æ€§æ¥è·å– BLE MIDI æ•°æ®ï¼Œå¹¶è®¢é˜…é€šçŸ¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®æ—¶æ¥æ”¶æ•°æ®ã€‚

### [](#nodejs-version)Node.js ç‰ˆæœ¬

ä¸ Node.js ç‰ˆæœ¬ç›¸åŒï¼Œä»£ç ç±»ä¼¼äºä¸€ä¸ªåŸºæœ¬çš„ noble ç¤ºä¾‹:

```
let state = {};
const sensorId = "XrnS1FRG/q/kM7ecsfErcg==";

function FreedrumsController(sensorId){
    noble.on('stateChange', function(state) {
        state === 'poweredOn' ? noble.startScanning() : noble.stopScanning();
      });

      noble.on('discover', function(peripheral){
        if(peripheral.id === sensorId){
          noble.stopScanning();
        }

        explore(peripheral);
      });

      function explore(peripheral){
        peripheral.connect(function(){
          peripheral.discoverSomeServicesAndCharacteristics([bluetoothLEMidi], [], function(error, services, characteristics){
              characteristics[0].on("read", function(event, isNotification){
                let data = event.toJSON().data;
                state = data;
                onStateChangeCallback(state);
              })
          })
        });
      }

      function onStateChangeCallback(e){
        return e;
      }

      return {
        onStateChange: function ( callback ) {
          onStateChangeCallback = callback;
        }
    }
} 
```

æˆ‘ä»¬é¦–å…ˆæ‰«æé™„è¿‘çš„è®¾å¤‡ï¼Œè¿æ¥åˆ°å…·æœ‰æ­£ç¡® uuid çš„è®¾å¤‡ï¼Œè¿æ¥åˆ°æ‰€æä¾›çš„æœåŠ¡å’Œç‰¹æ€§ï¼Œå¹¶ç›‘å¬å®æ—¶æ•°æ®ã€‚

### BLE è¿·ç¬›æ•°æ®

ä¸€æ—¦æ‚¨è®¢é˜…å¹¶æ¥æ”¶åˆ°æ¥è‡ªä¼ æ„Ÿå™¨çš„æ•°æ®ï¼Œå®ƒå°†ä½œä¸º 5 ä¸ªæ•´æ•°çš„æ•°ç»„è¿”å›ï¼Œä¾‹å¦‚[128ï¼Œ128ï¼Œ153ï¼Œ60ï¼Œ90]ã€‚

å‰ä¸¤ä¸ªæ•°å­—ä»£è¡¨æŠ¥å¤´å’Œæ—¶é—´æˆ³å­—èŠ‚ã€‚å®ƒä»¬ä¼¼ä¹æ€»æ˜¯ä»¥ 128 çš„å€¼è¿”å›ï¼Œè¿™å¾ˆå¥½ï¼Œå› ä¸ºæˆ‘ä»¬æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šä½¿ç”¨å®ƒä»¬ã€‚å¯¹æˆ‘ä»¬æ¥è¯´é‡è¦çš„æ˜¯æœ€åä¸‰ä¸ªä»·å€¼ã€‚

æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå€¼ä»£è¡¨çŠ¶æ€å­—èŠ‚æˆ– MIDI å‘½ä»¤ã€‚åŸºæœ¬ä¸Šï¼Œ153 è¡¨ç¤ºéŸ³ç¬¦åº”è¯¥æ¼”å¥æ—¶éŸ³ç¬¦å¼€ï¼Œ137 è¡¨ç¤ºéŸ³ç¬¦ä¸æ¼”å¥æ—¶éŸ³ç¬¦å…³ã€‚

ç¬¬å››ä¸ªå€¼æ˜¯ MIDI éŸ³ç¬¦æœ¬èº«ã€‚æ ¹æ®ä½ ç”¨é¼“æ£’å‡»æ‰“çš„ä½ç½®ï¼Œä¸åŒçš„æ•°å­—(éŸ³ç¬¦)ä¼šè¿”å›ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥è§¦å‘ä¸åŒçš„å£°éŸ³ã€‚

æœ€åä¸€ä¸ªå€¼ä»£è¡¨é€Ÿåº¦ï¼Œä»‹äº 0 å’Œ 127 ä¹‹é—´ï¼Œå¯ç”¨äºè®¾ç½®éŸ³é‡ã€‚

å·®ä¸å¤šå°±æ˜¯è¿™æ ·äº†ï¼ç°åœ¨æ‚¨å·²ç»ç”¨ JavaScript è·å¾—äº†è¿™äº›æ•°æ®ï¼Œæ‚¨å¯ä»¥è§¦å‘ä»»ä½•æ‚¨æƒ³è¦çš„å£°éŸ³å’Œå¯è§†åŒ–æ•ˆæœï¼

## [](#improvements)æ”¹è¿›

ç›®å‰ï¼Œæˆ‘åªèƒ½ä»ä¼ æ„Ÿå™¨è¯»å–æ•°æ®ï¼Œä½†æˆ‘çŸ¥é“å¦‚æœä½ æ„¿æ„ï¼Œä½ ä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ã€‚

æˆ‘ä¹Ÿåªå’Œ BLE çš„ MIDI æœåŠ¡åˆä½œè¿‡ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªè·å–åŸå§‹è¿åŠ¨æ•°æ®çš„æœåŠ¡ï¼Œç©èµ·æ¥ä¼šå¾ˆæœ‰è¶£ï¼

* * *

å°±æ˜¯è¿™æ ·ï¼å¦‚æœä½ æƒ³æŸ¥ä»£ç ï¼Œè¿™é‡Œæœ‰[å›è´­](https://github.com/charliegerard/freedrum.js)ï¼

å¸Œæœ›æœ‰å¸®åŠ©ï¼ğŸ’œ