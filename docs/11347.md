# JavaScript é—­åŒ…ç®€å•è§£é‡Š

> åŸæ–‡:[https://dev . to/shim Phillip/JavaScript-closure-simple-explained-1f 79](https://dev.to/shimphillip/javascript-closure-simply-explained-1f79)

é—­åŒ…æ˜¯ç”±å¦ä¸€ä¸ªå‡½æ•°è¿”å›çš„æœ‰çŠ¶æ€å‡½æ•°ã€‚å®ƒå……å½“ä¸€ä¸ªå®¹å™¨æ¥è®°å¿†æ¥è‡ªå…¶çˆ¶ä½œç”¨åŸŸçš„å˜é‡å’Œå‚æ•°ï¼Œå³ä½¿çˆ¶å‡½æ•°å·²ç»å®Œæˆæ‰§è¡Œã€‚è€ƒè™‘è¿™ä¸ªç®€å•çš„ä¾‹å­ã€‚

```
function sayHello() {
  const greeting = "Hello World";

  return function() { // anonymous function/nameless function
    console.log(greeting)
  }
}

const hello = sayHello(); // hello holds the returned function
hello(); // -> Hello World 
```

çœ‹å•Šï¼æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿”å›å‡½æ•°çš„å‡½æ•°ï¼è¿”å›çš„å‡½æ•°è¢«ä¿å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œå¹¶è°ƒç”¨ä¸‹é¢çš„ä»£ç è¡Œã€‚

## [](#many-ways-to-write-the-same-code)ç›¸åŒä»£ç çš„å¤šç§å†™æ³•ï¼

ç°åœ¨æ‚¨å·²ç»åŸºæœ¬äº†è§£äº†ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Œè¿™é‡Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥ç¼–å†™ä¸ä¸Šé¢ç›¸åŒçš„ä»£ç ã€‚

```
// original
function sayHello() {
  const greeting = "Hello World";

  return function() { // anonymous function
    console.log(greeting)
  }
}

// #1
function sayHello() {
  const greeting = "Hello World";

  return function hello() { // named function
    console.log(greeting)
  }
}

// #2
function sayHello() {
  const greeting = "Hello World";

  function hello() { // named function
    console.log(greeting)
  }

  return hello; // return inner function on a different line
}

// #3
function sayHello() {
  const greeting = "Hello World";
  const hello = () => { // arrow function
    console.log(greeting)
  }

  return hello;
} 
```

é€‰æ‹©ä¸€ç§ä½ æœ€å–œæ¬¢çš„é£æ ¼å¹¶åšæŒä¸‹å»ï¼Œå› ä¸ºä¸Šé¢çš„æ¯ä¸€ç§å˜åŒ–ä»ç„¶ä¼šæ‰“å°å‡ºç›¸åŒçš„ç»“æœï¼

```
const hello = sayHello();
hello(); // -> Hello World 
```

#### [](#private-namespace)ç§æœ‰å‘½åç©ºé—´

å†…éƒ¨å‡½æ•°è®°å¾—å®ƒè¢«åˆ›å»ºçš„ç¯å¢ƒï¼Œè¿™å¾ˆé…·ï¼Œä½†æ˜¯å®ƒæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä¸€å¯¹å¤«å¦‡ã€‚é¦–å…ˆï¼Œ*å®ƒå¯ä»¥ä¿æŒä½ çš„å˜é‡ç§æœ‰*ã€‚è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„åä¾‹ã€‚

```
function counter() {
  let count = 0;
  return function() {
    count += 1;
    return count;
  }
}

const increment = counter();
console.log(increment()); // 1
console.log(increment()); // 2
console.log(count) // Reference error: count is not defined 
```

è¯•å›¾è®¿é—® count å˜é‡ä¼šç»™æˆ‘ä»¬ä¸€ä¸ªå¼•ç”¨é”™è¯¯ï¼Œå› ä¸ºå®ƒæ²¡æœ‰æš´éœ²åœ¨å…¨å±€ç¯å¢ƒä¸­ã€‚è¿™æœ‰åŠ©äºæˆ‘ä»¬å‡å°‘é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬çš„çŠ¶æ€ç”±ç‰¹å®šçš„æ–¹æ³•æ›´ä¸¥æ ¼åœ°æ§åˆ¶ã€‚

#### [](#reusable-states)å¯å¤ç”¨çŠ¶æ€

å› ä¸ºâ€œcountâ€æ˜¯ç§æœ‰èŒƒå›´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ›å»ºè®¡æ•°å™¨å‡½æ•°çš„ä¸åŒå®ä¾‹ï¼Œå®ƒä»¬çš„â€œcountâ€å˜é‡ä¸ä¼šé‡å ï¼

```
function counter() {
  let count = 0;
  return function() {
    count += 1;
    return count;
  }
}

const incrementBananaCount = counter();
const incrementAppleCount = counter();
console.log(incrementBananaCount()); // 1
console.log(incrementBananaCount()); // 2
console.log(incrementAppleCount()); // 1 
```

#### [](#module-design-pattern)æ¨¡å—è®¾è®¡æ¨¡å¼

æ¨¡å—è®¾è®¡æ¨¡å¼æ˜¯æ„å»º JavaScript åº”ç”¨ç¨‹åºçš„æµè¡Œæƒ¯ä¾‹ã€‚å®ƒåˆ©ç”¨ IIFE(ç«‹å³è°ƒç”¨çš„å‡½æ•°è¡¨è¾¾å¼)æ¥è¿”å›å¯¹è±¡ï¼Œå¹¶ä¸”åªå…¬å¼€æ‚¨æƒ³è¦å…¬å¼€çš„å˜é‡å’Œæ–¹æ³•ã€‚

```
let Dog1 = (function() {
  let name = "Suzy";

  const getName = () => {
    return name;
  }

  const changeName = (newName) => {
    name = newName;
  }

  return {
    getName: getName,
    changeName: changeName
  }
}())

console.log(name); // undefined
Dog1.getName() // Suzy
Dog1.changeName("Pink")
Dog1.getName() // Pink 
```

è¿™æ®µä»£ç ä¸€è¿è¡Œï¼Œå‡½æ•°å°±æ‰§è¡Œå¹¶è¿”å›ä¸€ä¸ªä¿å­˜åˆ° Dog1 çš„å¯¹è±¡ã€‚è¿™ç§æ¨¡å¼å¯ä»¥è¿½æº¯åˆ°ä¿æŒæˆ‘ä»¬çš„åç§°ç©ºé—´ç§æœ‰ï¼Œåªé€šè¿‡å¯¹è±¡çš„å½¢å¼æ˜¾ç¤ºæˆ‘ä»¬æƒ³è¦çš„å…¬å…±æ–¹æ³•å’Œå˜é‡ã€‚çŠ¶æ€è¢«å°è£…ï¼

## [](#the-famous-interview-question)è‘—åçš„é¢è¯•é—®é¢˜

è¿è¡Œä»¥ä¸‹å‡½æ•°çš„ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

```
for(var i=0; i<5; i++) {
  setTimeout(function() {
    console.log(i)
  }, 1000)
} 
```

ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸€ä¸ªå¦‚æ­¤å—æ¬¢è¿çš„é¢è¯•é—®é¢˜ï¼Ÿå› ä¸ºå®ƒè€ƒéªŒä½ å¯¹å‡½æ•°ä½œç”¨åŸŸ/å—ä½œç”¨åŸŸã€é—­åŒ…ã€setTimeout å’ŒåŒ¿åå‡½æ•°çš„çŸ¥è¯†ï¼ç­”æ¡ˆ 1 ç§’åæ‰“å°å‡º 5 ä¸ª 5ã€‚

```
5
5
5
5
5 
```

æ€ä¹ˆä¼šï¼Ÿå—¯ï¼ŒsetTimeout åœ¨ 1 ç§’åå¾ªç¯è¿è¡Œ 5 æ¬¡ã€‚æ—¶é—´å»¶è¿Ÿåï¼Œå®ƒä»¬æ‰§è¡Œå†…éƒ¨å‡½æ•°ï¼Œç®€å•åœ°æ³¨é”€ Iã€‚1 ç§’è¿‡å»åï¼Œå¾ªç¯å·²ç»ç»“æŸï¼ŒI å˜æˆäº† 5ã€‚äº”ä¸ª 5 è¢«æ‰“å°å‡ºæ¥ã€‚ä¸æ˜¯ä½ æ‰€æœŸå¾…çš„ï¼Ÿä½ å¯èƒ½æƒ³åå¤çœ‹åˆ°æ•°å­— 1 åˆ° 5ã€‚

## [](#the-solution)è§£

æœ‰å‡ ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯è®©æˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åœ¨ä½¿ç”¨é—­åŒ…ä¸Šï¼

```
for(var i=0; i<5; i++) {
  setTimeout((function(index) {
    return function() {
      console.log(index);
    }
  }(i)), 1000)
} 
```

æˆ‘ä»¬æœ‰ä¸€ä¸ªç”±åŒ¿åå‡½æ•°è¿”å›çš„é—­åŒ…ï¼Œå®ƒæ¥æ”¶å½“å‰çš„â€œIâ€ä½œä¸ºå‚æ•°ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºâ€œindexâ€è¾“å‡ºã€‚è¿™æ ·åšå¯ä»¥æ•è·æ¯ä¸ªå‡½æ•°çš„å½“å‰å˜é‡ Iã€‚ç»“æœå˜æˆäº†

```
0 (...1000ms have passed)
1 (...1000ms have passed)
2 (...1000ms have passed)
3 (...1000ms have passed)
4 (...1000ms have passed)
5 (loop exits) 
```

æ­å–œä½ ï¼ğŸ‰ğŸ‰ç°åœ¨ä½ ä¸ºä¸‹ä¸€æ¬¡é¢è¯•åšäº†æ›´å……åˆ†çš„å‡†å¤‡ï¼ğŸ˜‰è¯·è®°ä½ï¼Œé—­åŒ…æ˜¯ä¸€ä¸ªå¯ä»¥è®¿é—®åŒ…å«è¯¥å‡½æ•°çš„ä½œç”¨åŸŸçš„å‡½æ•°ã€‚