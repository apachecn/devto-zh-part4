# ç¬¬ 027 é›†-å¯åŠ¨å¹¶è¿è¡Œ Docker Compose-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°çŸ«æ‰è¿‡æ­£

> åŸæ–‡:[https://dev . to/joaofbantunes/episode-027-up-and-running-with-docker-compose-ASP-net-core-from-0-to-overkill-4ke 9](https://dev.to/joaofbantunes/episode-027-up-and-running-with-docker-compose-asp-net-core-from-0-to-overkill-4ke9)

åœ¨è¿™ä¸€é›†ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¹‹å‰å‡†å¤‡çš„ Docker å®¹å™¨ï¼Œå¹¶ä½¿ç”¨ Docker Compose æ¥è¿è¡Œå®Œæ•´çš„ PlayBall åº”ç”¨ç¨‹åºã€‚

å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œä½†å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

[https://www.youtube.com/embed/41pDgXUgHhE](https://www.youtube.com/embed/41pDgXUgHhE)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚
T3ã€‘

## [T1ã€‘ç®€ä»‹](#intro)

åœ¨å‰ä¸€é›†é‡Œï¼Œæˆ‘ä»¬å¼€å§‹ç”¨ [Docker](https://docs.docker.com/) å‡†å¤‡è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸æ˜¯å› ä¸ºéƒ¨ç½²ï¼Œå› ä¸ºæˆ‘ä»¬ç¦»æœ‰ç”¨çš„ä¸œè¥¿æœ‰ç‚¹è¿œï¼Œè€Œæ˜¯ä¸ºäº†æ›´å®¹æ˜“è®©æ‰€æœ‰çš„ä¸œè¥¿ä¸€èµ·å·¥ä½œâ€”â€”å½“ç„¶ï¼Œä¹Ÿæ˜¯ä¸ºäº†å­¦ä¹ å¦‚ä½•å»åšğŸ™‚ã€‚

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬å°†åœ¨[Docker composer](https://docs.docker.com/compose/)çš„å¸®åŠ©ä¸‹å®Œæˆè¿™é¡¹å·¥ä½œï¼Œç›®æ ‡æ˜¯ç”¨ä¸€ä¸ªå‘½ä»¤å¯åŠ¨å¹¶è¿è¡Œ PlayBall åº”ç”¨ç¨‹åºã€‚

åœ¨æœªæ¥ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šåœ¨å®é™…éƒ¨ç½²ä¸­ä½¿ç”¨ [Kubernetes](https://kubernetes.io/) ï¼Œå› ä¸ºå®ƒæ˜¯ç›®å‰æœ€æµè¡Œçš„å®¹å™¨ç¼–æ’å·¥å…·ã€‚ä¸è¿‡ç°åœ¨ï¼ŒDocker Compose å·²ç»è¶³å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚äº†ã€‚

## [](#new-environment-configurations)æ–°çš„ç¯å¢ƒé…ç½®

å½“æˆ‘ä»¬è½¬ç§»åˆ°ä¸€ä¸ªæ–°çš„ç¯å¢ƒâ€”â€”ä»å¼€å‘åˆ° Docker å¼€å‘â€”â€”ä¸€äº›é…ç½®å°†éœ€è¦æ”¹å˜ï¼Œä¾‹å¦‚ BFF å°†ä¸èƒ½å†é€šè¿‡`localhost:5005`è®¿é—® auth æœåŠ¡ã€‚

å›æƒ³ã€ŠT2ã€‹ç¬¬ 006 é›†ï¼Œæˆ‘ä»¬çœ‹äº†ä¸€ä¸‹ ASP.NET æ ¸å¿ƒçš„é…ç½®ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬æœ‰å¾ˆå¤šæ–¹æ³•åœ¨ä¸åŒçš„ç¯å¢ƒä¸­ä½¿ç”¨ä¸åŒçš„é…ç½®ã€‚æœ€ç®€å•çš„æ–¹æ³•å¯èƒ½æ˜¯æ·»åŠ ä¸€ä¸ªç‰¹å®šäºç¯å¢ƒçš„æ–°çš„`appsettings.json`æ–‡ä»¶ï¼Œä½†æ˜¯æ ¹æ®é…ç½®çš„ç±»å‹(ä¾‹å¦‚ä¸€äº›ç§˜å¯†),ä»ä¸åŒçš„æä¾›å•†é‚£é‡Œè·å–ä¸€äº›é…ç½®å¯èƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨å¼€å‘ç¯å¢ƒä¸­æ‰€åšçš„,`json`æ–‡ä»¶å·²ç»è¶³å¤Ÿå¥½äº†ã€‚

è®°ä½è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ BFF ä½œä¸ºç¤ºä¾‹ï¼Œå¹¶åœ¨ web åº”ç”¨ç¨‹åºé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`appsettings.DockerDevelopment.json`çš„æ–°è®¾ç½®æ–‡ä»¶ã€‚

ä½œä¸ºå‚è€ƒï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¼€å‘è®¾ç½®æ–‡ä»¶:
`appsettings.Development.json`

```
{  "Logging":  {  "LogLevel":  {  "Default":  "Debug",  "System":  "Information",  "Microsoft":  "Information"  }  },  "GroupManagementApiSettings":  {  "Uri":  "http://localhost:5002"  },  "AuthServiceSettings":  {  "Authority":  "http://localhost:5005",  "RequireHttpsMetadata":  true,  "ClientId":  "WebFrontend",  "ClientSecret":  "secret"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‚£ä¹ˆï¼Œå¯¹äº Docker å¼€å‘ç¯å¢ƒæˆ‘ä»¬æœ‰:
`appsettings.DockerDevelopment.json`

```
{  "Logging":  {  "LogLevel":  {  "Default":  "Debug",  "System":  "Information",  "Microsoft":  "Information"  }  },  "GroupManagementApiSettings":  {  "Uri":  "http://groupmanagement"  },  "AuthServiceSettings":  {  "Authority":  "http://auth.playball.localhost",  "RequireHttpsMetadata":  false,  "ClientId":  "WebFrontend",  "ClientSecret":  "secret"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚ä½ æ³¨æ„åˆ°çš„ï¼Œæ²¡ä»€ä¹ˆä¸åŒã€‚æˆ‘ä»¬è¦æ”¹å˜çš„æ˜¯ç«¯ç‚¹ã€‚ä»£æ›¿`localhost`ï¼Œå› ä¸ºå®ƒä¸èƒ½å·¥ä½œï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå°†è¢«æ‰˜ç®¡åœ¨ä¸åŒçš„å®¹å™¨ä¸­ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„`localhost`ï¼Œæˆ‘ä»¬ç°åœ¨ä½¿ç”¨åç§°æ¥å¼•ç”¨å…¶ä»–æœåŠ¡ã€‚å½“æˆ‘ä»¬è¿›å…¥ Docker Compose éƒ¨åˆ†æ—¶ï¼Œæˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°äº†è§£å®ƒï¼Œä½†æ˜¯åœ¨é‚£ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬èƒ½å¤Ÿå®šä¹‰åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡å…¶ç›¸äº’è®¿é—®çš„åç§°ã€‚

è‡³äºå…¶ä»–ç»„ä»¶(æˆæƒæœåŠ¡å’Œç»„ç®¡ç† API)ï¼Œé…ç½®è°ƒæ•´æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘å°±è·³è¿‡å®ƒï¼Œä½†ä½ å¯ä»¥åœ¨[â€œç¼–ç æ°‘å…µ:ASP.NET æ ¸å¿ƒ-ä» 0 åˆ°è¿‡åº¦æ€ä¼¤â€ç»„ç»‡](https://github.com/AspNetCoreFromZeroToOverkill)çš„å„ä¸ªå­˜å‚¨åº“ä¸­æŸ¥çœ‹æ‰€æœ‰å†…å®¹ã€‚

## [](#setting-up-the-reverse-proxy)è®¾ç½®åå‘ä»£ç†

ä¸ºäº†å®ç°ä¸ç”¨æˆ·çš„äº¤äº’ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªåå‘ä»£ç†ï¼Œä½œä¸ºæˆ‘ä»¬å†…éƒ¨ Docker ç½‘ç»œçš„å•ä¸€å…¥å£ç‚¹ã€‚ç”¨æˆ·æ°¸è¿œä¸ä¼šç›´æ¥å‘é™¤åå‘ä»£ç†ä¹‹å¤–çš„ä»»ä½•ç»„ä»¶å‘å‡ºè¯·æ±‚ï¼Œäº‹å®ä¸Šï¼Œè¿™äº›ç»„ä»¶ç”šè‡³æ˜¯ä¸å¯è®¿é—®çš„ã€‚

æé†’ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç°åœ¨è¦ç”¨çš„æ¶æ„æ˜¯è¿™æ ·çš„(è§[ç¬¬ 021 é›†](https://blog.codingmilitia.com/2019/05/29/aspnet-021-from-zero-to-overkill-integrating-identityserver4-part1-overview)):

[![architecture diagram](../Images/89a5805da7b22d819bacbda96406550b.png)T2ã€‘](https://thepracticaldev.s3.amazonaws.com/i/uqyvo0j7dy3s5zgnr4bt.jpg)

æˆ‘ä»¬å°†ä½¿ç”¨ [HAProxy](http://www.haproxy.org/) ä½œä¸ºåå‘ä»£ç†ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ [Nginx](https://www.nginx.com/) æˆ–å¦ä¸€ä¸ªæœåŠ¡å™¨ã€‚HAProxy æ˜¯ä¸“é—¨å®šåˆ¶çš„åå‘ä»£ç†ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæˆç†Ÿçš„ web æœåŠ¡å™¨ï¼Œæ‰€ä»¥åœ¨æˆ‘çœ‹æ¥è¿™æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

> è¯·æ³¨æ„ï¼Œæˆ‘å¹¶æ²¡æœ‰æŠ•å…¥å¤ªå¤šæ—¶é—´æ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨ HAProxyã€‚æˆ‘å¤åˆ¶äº†ä¸€ä¸ªåŸºæœ¬é…ç½®ï¼Œæ ¹æ®æˆ‘çš„éœ€è¦è¿›è¡Œäº†è°ƒæ•´ï¼Œç„¶åç»§ç»­ä½¿ç”¨ã€‚è¯·ä¸è¦ç›²ç›®è·Ÿé£ç”Ÿäº§ğŸ™‚ã€‚

ä¸ºäº†ä¿æŒé€šç”¨çš„éƒ¨ç½²å·¥å…·ï¼Œæ¯”å¦‚è¿™ä¸ªåå‘ä»£ç†å’Œ Docker ç»„åˆå·¥å…·ï¼Œæˆ‘åœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„åº“ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„`docker`æ–‡ä»¶å¤¹ï¼Œç„¶åæ˜¯ä¸€ä¸ªå­æ–‡ä»¶å¤¹`reverse-proxy`ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­æ”¾ç½®åå‘ä»£ç† Docker æ˜ åƒçš„é…ç½®ã€‚

### [](#haproxy-configuration)HAProxy é…ç½®

è½¬åˆ°`reverse-proxy`æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º`haproxy.cfg`çš„ HAProxy é…ç½®æ–‡ä»¶ã€‚æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼Œç„¶åæˆ‘ä»¬å°†æµè§ˆå®ƒä»¬ã€‚

`haproxy.cfg`

```
global
    daemon
    maxconn 4096

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# define the public entrypoint
frontend public
    bind *:80

    # Define hosts
    acl host_main hdr(host) -i playball.localhost
    acl host_auth hdr(host) -i auth.playball.localhost

    # define rules to forward to backends
    use_backend auth if host_auth
    use_backend bff if host_main { path_beg /api/ }
    use_backend spa if host_main

# configure backends that process the requests
backend spa
    option forwardfor
    server spa1 spa:80

backend bff
    option forwardfor
    server bff1 bff:80

backend auth
    option forwardfor
    server auth1 auth:80

# configure states endpoint
listen stats 
  bind *:81
  stats enable  
  stats uri /haproxy
  stats auth user:pass 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### [](#global-and-default-settings)å…¨å±€å’Œé»˜è®¤è®¾ç½®

å‰ä¸¤èŠ‚ï¼Œæ˜¯æˆ‘ä»æŸå¤„å¤åˆ¶çš„ä¸€äº›é»˜è®¤å†…å®¹ğŸ˜ï¼Œä½†è¿™æ˜¯ä¸è¨€è‡ªæ˜çš„ï¼Œå› ä¸ºå®ƒå°† HAProxy è®¾ç½®ä¸ºåœ¨ dameon æ¨¡å¼ä¸‹è¿è¡Œï¼Œæœ€å¤§è¿æ¥æ•°å’Œä¸€äº›è¶…æ—¶ã€‚å®ƒè¿˜å°†æ¨¡å¼è®¾ç½®ä¸º`http`(ä¸`tcp`ç›¸å)ï¼Œè¿™å…è®¸ HAProxy æ£€æŸ¥ HTTP è¯·æ±‚ï¼Œä»è€Œå¯ä»¥åŸºäºæ­¤åˆ›å»ºè§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯·æ±‚è½¬å‘åˆ°æ­£ç¡®çš„ç»„ä»¶ã€‚`tcp`æ¨¡å¼ä¼šæ›´å¿«ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ä¸éœ€è¦æ£€æŸ¥è·¯ç”±è¯·æ±‚ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚

#### [](#handling-incoming-requests)å¤„ç†ä¼ å…¥è¯·æ±‚

åœ¨è¿™äº›éƒ¨åˆ†ä¹‹åï¼Œæˆ‘ä»¬è¿›å…¥ä¸æˆ‘ä»¬çš„ç”¨ä¾‹æ›´ç›¸å…³çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬ä»ä¸€ä¸ª`frontend`éƒ¨åˆ†(åä¸º`public`)å¼€å§‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬é…ç½®å¦‚ä½•å¤„ç†ä¼ å…¥çš„è¯·æ±‚ã€‚æˆ‘ä»¬é¦–å…ˆå°†è¿™ä¸ªå‰ç«¯ç»‘å®šåˆ°ç«¯å£ 80ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­ç›‘å¬è¯·æ±‚â€”â€”ç°åœ¨æˆ‘ä»¬åªä½¿ç”¨ HTTPï¼Œå°†æ¥æˆ‘ä»¬å¸Œæœ›ç«¯å£ 443 ä¹Ÿå…¬å¼€æ¥å¤„ç† HTTPSã€‚

æˆ‘ä»¬é€šè¿‡å®šä¹‰ä¸¤ä¸ª ACL(æ›´å¤šä¿¡æ¯[åœ¨è¿™é‡Œ](https://www.haproxy.com/blog/introduction-to-haproxy-acls/))æ¥è®©æˆ‘ä»¬å®šä¹‰è¯·æ±‚å¤„ç†çš„è§„åˆ™ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥åŒ¹é…è¯·æ±‚çš„ä¸»æœºã€‚è®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­æ¥äº†è§£ä¸€ä¸‹è¿™æ˜¯æ€ä¹ˆå›äº‹ã€‚

```
acl host_main hdr(host) -i playball.localhost 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   `acl`æ˜¯åˆ›å»ºå‘½å ACL çš„å…³é”®å­—ã€‚
*   `host_main`æ˜¯æˆ‘ä»¬æ­£åœ¨åˆ›å»ºçš„ ACL çš„åç§°ã€‚
*   `hdr`å…è®¸æˆ‘ä»¬ä»è¯·æ±‚ä¸­è·å–ä¸€ä¸ªå¤´ã€‚
*   `host`æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ ‡é¢˜çš„åç§°ã€‚
*   `-i`æ‰§è¡Œä¸åŒºåˆ†å¤§å°å†™çš„åŒ¹é…ã€‚
*   `playball.localhost`æ˜¯æˆ‘ä»¬è¦åŒ¹é…çš„ä¸»æœºã€‚

å®šä¹‰äº†è¿™äº› ACL ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç»§ç»­å®šä¹‰è§„åˆ™æ¥å°†è¯·æ±‚åŒ¹é…åˆ°æ­£ç¡®çš„åç«¯ã€‚å®šä¹‰`use_backend`è§„åˆ™çš„é¡ºåºå¾ˆé‡è¦ï¼Œå› ä¸ºè¯·æ±‚å°†è¢«è½¬å‘åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„åç«¯ã€‚

> å…³äºè¿™äº›ä¸»æœºï¼Œæˆ‘åœ¨æˆ‘çš„è®¡ç®—æœºçš„`hosts`æ–‡ä»¶ä¸­å®šä¹‰äº†å®ƒä»¬ï¼ŒæŒ‡å‘æœ¬åœ°ä¸»æœºã€‚

```
use_backend auth if host_auth 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–å…ˆï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚ä¸`auth`åç«¯(å³æˆæƒæœåŠ¡)åŒ¹é…ï¼Œæˆ‘ä»¬å°†ç«‹å³è½¬å‘å®ƒã€‚

```
use_backend bff if host_main { path_beg /api/ } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åæˆ‘ä»¬å®šä¹‰å¦ä¸€ä¸ªåç«¯è§„åˆ™ï¼Œå£°æ˜å¦‚æœä¸»æœºåŒ¹é…`host_main`å¹¶ä¸”è·¯å¾„ä»¥`/api/`å¼€å§‹ï¼Œæˆ‘ä»¬å¸Œæœ›å°†è¯·æ±‚è½¬å‘ç»™ BFFã€‚

> é™„å¸¦è¯´æ˜ï¼Œå½“æˆ‘ä»¬è®¨è®ºåˆ° BFF çš„è·¯ç”±æ—¶ï¼Œæˆ‘æœ€ç»ˆåœ¨ BFF åº”ç”¨ç¨‹åºçš„è·¯ç”±ä¸­åŒ…å«äº†`api`å‰ç¼€ï¼Œä»¥é¿å…è¿™äº›åŒ¹é…å’Œç™»å½•æµç¨‹ä¸­å‘ç”Ÿçš„é‡å®šå‘å¸¦æ¥çš„éº»çƒ¦ã€‚æˆ‘è‚¯å®šä¼šæœ‰å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä½†æˆ‘è§‰å¾—ç›®å‰ä¸å€¼å¾—èŠ±è¿™ä¹ˆå¤§åŠ›æ°”ã€‚

```
use_backend spa if host_main 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œå¦‚æœä¸»æœºä¸`host_main`åŒ¹é…ï¼Œè¯·æ±‚å°†è¢«è½¬å‘åˆ° SPAã€‚è®°ä½é¡ºåºå¾ˆé‡è¦ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªè§„åˆ™æ”¾åœ¨å‰ä¸€ä¸ªè§„åˆ™ä¹‹å‰ï¼ŒBFF å°±ä¸ä¼šæ°¸è¿œåŒ¹é…ï¼Œæ‰€ä»¥æ‰€æœ‰å¯¹`playball.localhost`çš„è¯·æ±‚æœ€ç»ˆéƒ½ä¼šè¢«è½¬å‘åˆ° SPA åç«¯ã€‚

#### [](#defining-the-backends-that-handle-the-requests)å®šä¹‰å¤„ç†è¯·æ±‚çš„åç«¯

åœ¨`frontend`éƒ¨åˆ†ï¼Œæˆ‘ä»¬å®šä¹‰äº†å°†è¯·æ±‚åŒ¹é…åˆ°åç«¯çš„è§„åˆ™ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å®šä¹‰é‚£äº›åç«¯ã€‚æˆ‘ä»¬å°†æŠ“ä½å…¶ä¸­çš„ä¸€ä¸ªä½œä¸ºä¾‹å­ï¼Œå› ä¸ºå®ƒä»¬çš„å®šä¹‰éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”ä¹Ÿä¸å¤ªå¤æ‚ã€‚

```
backend spa
    option forwardfor
    server spa1 spa:80 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä»å®šä¹‰åç«¯çš„å…³é”®å­—`backend`å¼€å§‹ï¼Œç„¶åæ˜¯æˆ‘ä»¬æƒ³è¦ç»™å®ƒèµ·çš„åå­—ã€‚è¿™æ˜¯æˆ‘ä»¬åœ¨`frontend`å®šä¹‰ä¸­ä½¿ç”¨çš„åç§°ã€‚

ç„¶åæˆ‘ä»¬æœ‰å¦å¤–å‡ è¡Œã€‚`option forwardfor`ï¼Œå‘Šè¯‰ HAProxy åœ¨è½¬å‘åˆ°åç«¯çš„è¯·æ±‚ä¸­åŒ…å«`X-Forwarded-For`å¤´ã€‚

æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨`server`è®¾ç½®æ¥æŒ‡ç¤ºè¯·æ±‚åº”è¯¥è¢«è½¬å‘åˆ°çš„å®é™…æœåŠ¡å™¨ã€‚æˆ‘ä»¬ä¸ºè¿™ä¸ªæœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªåç§°(`spa1`)ï¼Œç„¶åè®¾ç½®å®ƒçš„ä½ç½®ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨æŸ¥çœ‹ Docker Compose é…ç½®æ—¶çœ‹åˆ°çš„ï¼Œå®ƒæ˜¯ç«¯å£ 80 ä¸Šçš„ä¸»æœº`spa`ã€‚æˆ‘ä»¬åªå®šä¹‰äº†ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªï¼ŒHAProxy å°†å……å½“å®ƒä»¬ä¹‹é—´çš„è´Ÿè½½å¹³è¡¡å™¨ã€‚

#### [](#statistics-page)ç»Ÿè®¡é¡µé¢

æ€»ç»“ HAProxy çš„é…ç½®ï¼Œæˆ‘ä»¬å°† HAProxy æä¾›çš„ç»Ÿè®¡é¡µé¢é…ç½®ä¸ºå¯è®¿é—®ã€‚è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³åœ¨ç½‘ç»œä¸Šå…¬å¼€çš„ä¸œè¥¿ï¼Œæ‰€ä»¥è¦å°å¿ƒã€‚

`HAProxy statistics page`
[![HAProxy statistics page](../Images/d25405f963c46032e0f861a6f05d2660.png)T4ã€‘](https://thepracticaldev.s3.amazonaws.com/i/wi76n0un2c0b19xa5w17.png)

### [](#creating-the-docker-container-image)åˆ›å»º Docker å®¹å™¨å›¾åƒ

æˆ‘ä»¬ç°åœ¨å·²ç»å‡†å¤‡å¥½äº†é…ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Docker å®¹å™¨æ˜ åƒï¼Œå®ƒå°†è¢«ç”¨ä½œ Docker Compose éƒ¨ç½²çš„ä¸€éƒ¨åˆ†ã€‚

åœ¨`reverse-proxy`æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„`Dockerfile`æ¥æè¿°å›¾åƒã€‚

```
FROM haproxy:alpine

## Copy the config with the proxy settings
COPY haproxy.cfg /usr/local/etc/haproxy/haproxy.cfg 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

éå¸¸ç®€å•`Dockerfile`ï¼Œå› ä¸ºæˆ‘ä»¬åªæƒ³å¤åˆ¶åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œå…¶ä½™çš„å¯ä»¥ä¿æŒä¸å˜ã€‚

æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç›´æ¥å¯åŠ¨ HAProxy å®¹å™¨æ—¶æŒ‚è½½ä¸€ä¸ªåŒ…å«é…ç½®æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªåŸºäº HAProxy çš„å®¹å™¨ã€‚ä» [Docker Hub](https://hub.docker.com/_/haproxy) çš„æ–‡æ¡£:

```
docker run -d --name my-running-haproxy -v /path/to/etc/haproxy:/usr/local/etc/haproxy:ro haproxy:1.7 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#creating-the-docker-compose-file)åˆ›å»º Docker æ’°å†™æ–‡ä»¶

åšå®Œè¿™äº›å‡†å¤‡ï¼Œæˆ‘ä»¬æœ€åæ¥çœ‹çœ‹ Docker Composeã€‚ä»ä»–ä»¬çš„[æ–‡æ¡£](https://docs.docker.com/compose/):

> Compose æ˜¯ä¸€ä¸ªå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚ä½¿ç”¨ Composeï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ YAML æ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºçš„æœåŠ¡ã€‚ç„¶åï¼Œåªéœ€ä¸€ä¸ªå‘½ä»¤ï¼Œæ‚¨å°±å¯ä»¥ä»æ‚¨çš„é…ç½®ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚

è¿™æ­£æ˜¯æˆ‘ä»¬è·å¾— PlayBall åº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„ï¼Œplay ball åº”ç”¨ç¨‹åºç”±ä¸€å †åº”ç”¨ç¨‹åºç»„æˆ(è€Œä¸”æ•°é‡ä¼šå¢åŠ )ï¼Œå¼€å§‹æ—¶æ²¡æœ‰å¤ªå¤šéº»çƒ¦ã€‚

åœ¨[æ–°èµ„æºåº“](https://github.com/AspNetCoreFromZeroToOverkill/Deployment/tree/episode027)ä¸­åˆ›å»ºçš„`docker`æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º`docker-compose.dev.yml`çš„æ–°æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†è®¾ç½®æ‰€æœ‰å†…å®¹ã€‚

è¿™ä¸€æ¬¡ï¼Œæˆ‘ä¸ä¼šæ”¾å¼ƒæ•´ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†åœ°è¿›è¡Œï¼Œä½†æ˜¯æ‚¨å¯ä»¥åœ¨ GitHub repo ä¸­çœ‹åˆ°æ‰€æœ‰å†…å®¹ã€‚

```
version: "3"
networks:
  internal-network: 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ–‡ä»¶çš„ç¬¬ä¸€è¡Œï¼Œç®€å•åœ°é™ˆè¿°äº†æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„ Docker Compose æ–‡ä»¶çš„ç‰ˆæœ¬ã€‚

ä¹‹åï¼Œæˆ‘ä»¬å®šä¹‰æˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„ç½‘ç»œï¼Œæˆ‘ä»¬æ­£åœ¨å®šä¹‰ä¸€ä¸ªåä¸º`internal-network`çš„ç½‘ç»œã€‚è¿™ä¸æ˜¯å¼ºåˆ¶é…ç½®ï¼Œä½†æˆ‘ä»¬å‡ºäºå‡ ä¸ªåŸå› æƒ³è¦ä½¿ç”¨å®ƒ:

*   å®¹å™¨åœ¨éš”ç¦»çš„ç½‘ç»œä¸­è¿è¡Œï¼Œåªèƒ½åœ¨åŒä¸€ç½‘ç»œçš„å®¹å™¨ä¸­é€šä¿¡(å½“ç„¶ï¼Œé™¤éæš´éœ²åœ¨äº’è”ç½‘ä¸­)ã€‚
*   åŒä¸€ç½‘ç»œä¸­çš„å®¹å™¨ä¸éœ€è¦çŸ¥é“å½¼æ­¤çš„ IP åœ°å€ï¼Œè®©è¿™äº›ç½‘ç»œæä¾›åŸºäºå®¹å™¨åç§°çš„è‡ªåŠ¨ DNS è§£æã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ä¾‹å­ä¸­(`appsettings`æ–‡ä»¶æˆ– HAProxy é…ç½®æ–‡ä»¶)ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åƒ`spa`æˆ–`bff`è¿™æ ·çš„åœ°å€ã€‚

åœ¨è¿™ä¹‹åï¼Œæ˜¯ Docker ç¼–å†™æ–‡ä»¶æœåŠ¡å®šä¹‰çš„ä¸»è¦éƒ¨åˆ†ã€‚

```
services:
    reverse-proxy:
        build: ./reverse-proxy/.
        image: codingmilitia/reverseproxy:latest
        ports:
            - "80:80"
            - "81:81"
        networks:
            - internal-network
        depends_on:
            - spa
            - bff
            - auth
    # ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ ‡å¿—ç€æˆ‘ä»¬å¸Œæœ›ä½œä¸ºæˆ‘ä»¬æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†çš„æ‰€æœ‰å®¹å™¨çš„é…ç½®çš„å¼€å§‹ã€‚

æˆ‘ä»¬ä»é…ç½®åå‘ä»£ç†å¼€å§‹ã€‚æˆ‘ä»¬ç»™å®ƒä¸€ä¸ªåç§°ï¼Œç„¶åæ˜¯æ„å»ºå›¾åƒæ‰€éœ€çš„æ–‡ä»¶ä½ç½®çš„è·¯å¾„ï¼Œæ¥ä¸‹æ¥æ˜¯æˆ‘ä»¬å¸Œæœ›ç”¨äºç»“æœå›¾åƒçš„åç§°å’Œæ ‡ç­¾ã€‚

`ports`æ¡ç›®å®šä¹‰äº†æˆ‘ä»¬æƒ³è¦å‘ä¸»æœºå…¬å¼€çš„ç«¯å£ã€‚æ‚¨ä¼šæ³¨æ„åˆ°è¿™åªå‡ºç°åœ¨åå‘ä»£ç†å®šä¹‰ä¸­ï¼Œå…¶ä½™çš„å®¹å™¨å°†æ— æ³•ä»å¤–éƒ¨è®¿é—®ï¼Œå› ä¸ºåå‘ä»£ç†åº”è¯¥æ˜¯å”¯ä¸€çš„å…¥å£ç‚¹(å½“ç„¶ï¼Œå‡ºäºè°ƒè¯•ç›®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å…¬å¼€å…¶ä»–å®¹å™¨)ã€‚

`networks`æ¡ç›®é…ç½®æˆ‘ä»¬å¸Œæœ›å®¹å™¨æˆä¸ºå…¶ä¸­ä¸€éƒ¨åˆ†çš„ç½‘ç»œã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæ‰€æœ‰çš„å®¹å™¨éƒ½å°†ä½¿ç”¨æˆ‘ä»¬ä¸Šé¢è®¨è®ºè¿‡çš„åŒä¸€ä¸ªç½‘ç»œã€‚

æœ€åï¼Œ`depends_on`æŒ‡å‡ºåœ¨è¿™ä¸ªæœåŠ¡å¯åŠ¨ä¹‹å‰åº”è¯¥è¿è¡Œä»€ä¹ˆæœåŠ¡ã€‚ç„¶è€Œï¼Œè¿™å¹¶æ²¡æœ‰è§£å†³å…³äºä¾èµ–æ€§çš„æ‰€æœ‰é—®é¢˜ï¼Œå› ä¸ºå®ƒåªæ˜¯ç­‰å¾…å…¶ä»–å®¹å™¨å¯åŠ¨ï¼Œå®ƒä¸çŸ¥é“åœ¨è¿™äº›å®¹å™¨ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå®é™…ä¸Šæ˜¯å¦å‡†å¤‡å¥½äº†(ä¾‹å¦‚ï¼Œweb åº”ç”¨ç¨‹åºå¯èƒ½æ­£åœ¨è¿è¡Œè¿ç§»ï¼Œä½†è¿˜æ²¡æœ‰ç›‘å¬è¯·æ±‚)ã€‚

```
services:
    # ...
    spa:
        build: ../../WebFrontend/client/.
        image: codingmilitia/webfrontend/spa:latest
        networks:
            - internal-network
        depends_on:
            - bff
    # ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

SPA å®šä¹‰æ¯”åå‘ä»£ç†ç®€å•ï¼Œæ‰€ä»¥è¿™é‡Œä¸å¤šè°ˆäº†ã€‚æ³¨æ„ï¼ŒSPA å®¹å™¨å®é™…ä¸Šå¹¶ä¸éœ€è¦ BFF æ¥è¿è¡Œï¼Œä½†æ˜¯ä»åº”ç”¨ç¨‹åºä½¿ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒéœ€è¦ BFFï¼Œæ‰€ä»¥æˆ‘æ·»åŠ äº†ä¾èµ–é¡¹ã€‚

æ­¤å¤–ï¼Œè¯·æ³¨æ„æ„å»ºè·¯å¾„å‡è®¾æ‰€æœ‰çš„ repos éƒ½åœ¨å…„å¼Ÿæ–‡ä»¶å¤¹ä¸­ï¼Œå› æ­¤å¦‚æœæ‚¨ä¸‹è½½è¿™äº› repos å¹¶å¸Œæœ› Docker Compose å·¥ä½œï¼Œæ‚¨éœ€è¦æœ‰ç›¸åŒçš„æ–‡ä»¶å¤¹ç»“æ„æˆ–è°ƒæ•´è·¯å¾„ã€‚

```
services:
    # ...
    bff:
        build: ../../WebFrontend/server/.
        image: codingmilitia/webfrontend/bff:latest
        networks:
            - internal-network
        depends_on:
            - groupmanagement
        environment:
            - ASPNETCORE_ENVIRONMENT=DockerDevelopment
    # ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å†ä¸€æ¬¡ï¼Œæ²¡æœ‰å¤ªå¤šå…³äº BFF çš„è¯è¦è¯´ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å·²ç»è®¨è®ºè¿‡äº†ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬æ­£åœ¨è®¾ç½®ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå› æ­¤åº”ç”¨ç¨‹åºä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„æ–°çš„`appsettings.DockerDevelopment.json`æ–‡ä»¶ï¼Œä»¥æ­£ç¡®çš„ç¯å¢ƒé…ç½®è¿è¡Œã€‚

```
services:
    # ...
    groupmanagement:
        build: ../../GroupManagement/.
        image: codingmilitia/groupmanagement:latest
        networks:
            - internal-network
        depends_on:
            - postgres-db
        environment:
            - ASPNETCORE_ENVIRONMENT=DockerDevelopment
    # ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç»„ç®¡ç† API é…ç½®ä¸ BFF éå¸¸ç›¸ä¼¼ã€‚

```
services:
    # ...
    auth:
        build: ../../Auth/.
        image: codingmilitia/auth:latest
        networks:
            internal-network:
                aliases:
                    - auth.playball.localhost # trick to be able to access auth from inside and outside the Docker network
        depends_on:
            - postgres-db
        environment:
            - ASPNETCORE_ENVIRONMENT=DockerDevelopment
    # ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è‡³äº auth æœåŠ¡ï¼Œå®ƒå‡ ä¹ä¸ BFF å’Œç»„ç®¡ç† API ç›¸åŒï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé¢å¤–çš„ç½‘ç»œé…ç½®:è®¾ç½®ä¸€ä¸ªåˆ«åã€‚

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œåœ¨è¿›è¡Œé…ç½®æ—¶(å³`appsettings`æ–‡ä»¶),æˆ‘ä»¬é€šè¿‡åœ¨ç»„åˆæ–‡ä»¶ä¸­å®šä¹‰çš„åç§°(ä¾‹å¦‚`bff`æˆ–`groupmanagement`)æ¥å¼•ç”¨æœåŠ¡ï¼Œé™¤äº† auth æœåŠ¡ï¼Œåœ¨ auth æœåŠ¡ä¸­æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ›´â€œçœ‹èµ·æ¥æ­£å¸¸â€çš„ä¸»æœºå`auth.playball.localhost`ã€‚

è¿™é‡Œçš„é—®é¢˜æ˜¯ä¸»æœº`auth`å°†åœ¨å†…éƒ¨ç»„åˆç½‘ç»œä¸­é€šä¿¡æ—¶å·¥ä½œï¼Œå› æ­¤ï¼Œä¾‹å¦‚ï¼ŒBFF å¯ä»¥ä½¿ç”¨`auth`ä½œä¸ºä¸ auth æœåŠ¡é€šä¿¡çš„æˆæƒã€‚ç„¶è€Œé—®é¢˜æ˜¯ï¼Œå½“ BFF éœ€è¦é‡å®šå‘åˆ° auth æœåŠ¡ä»¥ä¾›ç”¨æˆ·ç™»å½•æ—¶ï¼Œå®ƒä¼šé‡å®šå‘åˆ°`http://auth/Login?ReturnUrl=RETURN_URL`ï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€è®¨è®ºçš„ï¼Œè¿™æ˜¯ä¸èƒ½ä»æµè§ˆå™¨è®¿é—®çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Compose æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªåˆ«å(æˆ–è€…æˆ‘ä»¬å¯ä»¥åªæ”¹å˜æœåŠ¡çš„åç§°)ï¼Œè¿™æ ·åŒä¸€ä¸ª`auth.playball.localhost`å°±å¯ä»¥ç”¨äºä» Docker ç½‘ç»œçš„å†…éƒ¨å’Œå¤–éƒ¨è®¿é—® auth æœåŠ¡ã€‚

```
services:
    # ...
    postgres-db:
        image: "postgres"
        networks:
            - internal-network
        environment:
            POSTGRES_USER: "user"
            POSTGRES_PASSWORD: "pass" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†åŒ…è£…åˆæˆæ–‡ä»¶ï¼Œæˆ‘ä»¬é…ç½®æ•°æ®åº“ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¸æ˜¯åŸºäºæˆ‘ä»¬åˆ›å»ºçš„å®¹å™¨æ˜ åƒï¼Œæ‰€ä»¥æ²¡æœ‰`build`æ¡ç›®ã€‚å…¶ä½™çš„ä¸æˆ‘ä»¬çœ‹åˆ°çš„ç±»ä¼¼ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ä¸€äº›è¶…çº§å®‰å…¨çš„å‡­è¯ã€‚

## [](#running-the-application)è¿è¡Œåº”ç”¨ç¨‹åº

å¥½äº†ï¼Œæˆ‘ä»¬ç»ˆäºä¸ºè¿è¡Œåº”ç”¨ç¨‹åºåšå¥½äº†ä¸€åˆ‡å‡†å¤‡ã€‚å¦‚å‰æ‰€è¿°ï¼Œç°åœ¨è¿è¡Œå®ƒæ˜¯ä¸€ä¸ªè¿è¡Œå•ä¸ªå‘½ä»¤çš„é—®é¢˜:

```
docker-compose -f docker-compose.dev.yml up -d --build 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŸºæœ¬å‘½ä»¤æ˜¯`docker-compose -f docker-compose.dev.yml up`ï¼Œå®ƒå°†å‘Šè¯‰ Docker Compose å¯åŠ¨ç”±`docker-compose.dev.yml`æ–‡ä»¶æè¿°çš„åº”ç”¨ç¨‹åºã€‚ç„¶åæˆ‘ä»¬æœ‰ä¸€äº›é¢å¤–çš„æ ‡å¿—ï¼Œä½ å¯èƒ½æƒ³ç”¨ä¹Ÿå¯èƒ½ä¸æƒ³ç”¨ã€‚

*   `-d`å’Œæˆ‘ä»¬åœ¨ä¸Šä¸€é›†çœ‹åˆ°çš„`docker run`æœ‰ç›¸åŒçš„æ„æ€ï¼Œè®©å®ƒä»¥å®ˆæŠ¤æ¨¡å¼è¿è¡Œã€‚
*   `--build`è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦æ„å»º(æˆ–é‡å»º)æœåŠ¡å®¹å™¨æ˜ åƒã€‚åœ¨æˆ‘ä»¬æ”¹å˜å’Œå°è¯•äº‹ç‰©æ—¶å¾ˆæœ‰ç”¨ã€‚

å¦‚æœæˆ‘ä»¬åšä¸€ä¸ª`docker ps`æˆ‘ä»¬åº”è¯¥çœ‹åˆ°æˆ‘ä»¬æ‰€æœ‰çš„å®¹å™¨éƒ½åœ¨è¿è¡Œã€‚ä½†æ˜¯æœ‰æ—¶ï¼Œç”±äºä¸€ä¸ªæœåŠ¡å‡†å¤‡å°±ç»ªéœ€è¦æ—¶é—´ï¼Œä¾èµ–äºå®ƒçš„å®¹å™¨å¯èƒ½ä¼šå¤±è´¥â€”â€”ä¾‹å¦‚ï¼ŒPostgreSQL å¯åŠ¨æ—¶é—´ç¨é•¿ï¼Œä½¿å¾—ç»„ç®¡ç† API å¤±è´¥ã€‚æˆ‘ä»¬å¯ä»¥åšä¸€äº›äº‹æƒ…æ¥é¿å…è¿™ç§æƒ…å†µï¼Œæ¯”å¦‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å†…ç½®é‡è¯•é€»è¾‘ï¼Œåœ¨ç»„åˆæ–‡ä»¶ä¸­æ·»åŠ ä¸€äº›é…ç½®æ¥å¤„ç†å®¹å™¨æ•…éšœç­‰ç­‰ï¼Œä½†æ˜¯è€ƒè™‘åˆ°æˆ‘ä»¬åªæ˜¯ä½¿ç”¨è¿™äº›æ¥ç®€åŒ–åº”ç”¨ç¨‹åºçš„æµ‹è¯•ï¼Œè®©å®¹å™¨åœ¨æ•…éšœæ—¶ä¿æŒå…³é—­ç”šè‡³å¯èƒ½å¯¹æˆ‘ä»¬æ›´å¥½åœ°äº†è§£æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…æœ‰å¥½å¤„ã€‚

æˆ‘ä»¬ç°åœ¨å¯ä»¥è¿›å…¥æµè§ˆå™¨ï¼Œè¾“å…¥`http://playball.localhost`(ä¸è¦å¿˜è®°å°†è¿™ä¸¤ä¸ªæ¡ç›®æ·»åŠ åˆ° hosts æ–‡ä»¶ä¸­)ï¼Œç„¶åæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°±ä¼šå‘æˆ‘ä»¬é—®å¥½ï¼Œç»™å‡ºä¸€ä¸ªå‘½ä»¤å°±å¯ä»¥è¿è¡ŒğŸ™‚ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å»`http://localhost:81/haproxy`çœ‹çœ‹å®ƒæä¾›çš„ç»Ÿè®¡æ•°æ®ã€‚

## [](#outro)å…¶ä»–

è¿™ä¸€é›†åˆ°æ­¤ä¸ºæ­¢ã€‚æˆ‘ä»¬ç°åœ¨èƒ½å¤Ÿæ¯«æ— å›°éš¾åœ°è¿è¡Œæˆ‘ä»¬çš„ PlayBall åº”ç”¨ç¨‹åºï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æµ‹è¯•åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å®ç°çš„ç‰¹æ€§ã€‚

æˆ‘ä»¬è¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ï¼Œç›´åˆ°æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥åº”ç”¨ç¨‹åºåšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ï¼Œä½†è‡³å°‘æˆ‘ä»¬æ­£åœ¨æ¢ç´¢è®¸å¤šä¸»é¢˜ã€‚

å¸–å­ä¸­çš„é“¾æ¥:

*   [ç å¤´å·¥äºº](https://docs.docker.com/)
*   [åç«™ç»„æˆ](https://docs.docker.com/compose/)
*   [Kubernetes](https://kubernetes.io/)
*   [HAProxy](http://www.haproxy.org/)
*   [HAProxy é…ç½®çš„å››ä¸ªåŸºæœ¬éƒ¨åˆ†](https://www.haproxy.com/blog/the-four-essential-sections-of-an-haproxy-configuration/)
*   [ha proxy ACL ç®€ä»‹](https://www.haproxy.com/blog/introduction-to-haproxy-acls/)
*   [Nginx](https://www.nginx.com/)

è¿™ç¯‡æ–‡ç« çš„æºä»£ç åˆ†å¸ƒåœ¨[â€œç¼–ç æ°‘å…µ:ASP.NET æ ¸å¿ƒâ€”â€”ä» 0 åˆ°è¿‡åº¦æ€æˆ®â€ç»„ç»‡](https://github.com/AspNetCoreFromZeroToOverkill)çš„å­˜å‚¨åº“ä¸­ï¼Œæ ‡è®°ä¸º`episode027`ã€‚

*   [è®¤è¯](https://github.com/AspNetCoreFromZeroToOverkill/Auth/tree/episode027)
*   [ç¾¤ç»„ç®¡ç†](https://github.com/AspNetCoreFromZeroToOverkill/GroupManagement/tree/episode027)
*   [web å‰ç«¯](https://github.com/AspNetCoreFromZeroToOverkill/WebFrontend/tree/episode027)
*   [éƒ¨ç½²](https://github.com/AspNetCoreFromZeroToOverkill/Deployment/tree/episode027)

æ„Ÿè°¢åˆ†äº«å’Œåé¦ˆï¼

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼