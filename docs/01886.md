# firestorm å­é›†åˆçš„å­˜å‚¨åº“æ¨¡å¼å®ç°

> åŸæ–‡:[https://dev . to/giodiblasi/a-repository-pattern-implementation-for-firestore-sub collections-463](https://dev.to/giodiblasi/a-repository-pattern-implementation-for-firestore-subcollections-463)

å¦‚æœä½ å·²ç»ä½¿ç”¨è¿‡ [Google Cloud Firestore](https://firebase.google.com/docs/firestore) ï¼Œä½ å¯èƒ½çŸ¥é“å®ƒçš„[æ•°æ®æ¨¡å‹](https://firebase.google.com/docs/firestore/data-model)ï¼Œå¹¶ä¸”ä½ ä¼šæ³¨æ„åˆ°**å­é›†åˆ**æ˜¯æœ€æœ‰è¶£çš„ç‰¹æ€§ä¹‹ä¸€ã€‚æˆ‘ç¬¬ä¸€æ¬¡è§åˆ°ä»–ä»¬æ˜¯åœ¨åšæˆ‘ä¸ªäººæœ€å–œæ¬¢çš„é¡¹ç›®æ—¶(åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘å¯ä»¥å°è¯•æ–°çš„æŠ€æœ¯å’Œæ–¹æ³•)ã€‚

å› æ­¤ï¼Œæˆ‘æƒ³çŸ¥é“æ˜¯å¦æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥è°ƒæ•´**å­˜å‚¨åº“æ¨¡å¼**æ¥å¤„ç† Firestore å­é›†åˆã€‚
è¦è§£å†³çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œåœ¨å­˜å‚¨åº“æ¨¡å¼ä¸­ï¼Œæ¯ä¸ªå­˜å‚¨åº“é€šå¸¸ä¸ä¸€ä¸ªç‰¹å®šçš„æ¨¡å‹ç›¸å…³ï¼Œæ¢å¥è¯è¯´ï¼Œå®ƒä¸ä¸€ä¸ªç±»å‹ç›¸å…³ã€‚ä½†æ˜¯ä»[è°·æ­Œæ–‡æ¡£é¡µé¢](https://firebase.google.com/docs/firestore/data-model#subcollections)é˜…è¯»:

> å­é›†åˆæ˜¯ä¸ç‰¹å®šæ–‡æ¡£ç›¸å…³è”çš„é›†åˆã€‚

è¿™æ„å‘³ç€ï¼Œå¯¹äºä¸€ä¸ªå­é›†åˆï¼Œä¸€ä¸ªå­˜å‚¨åº“ä¸ä¸€ä¸ªç±»å‹æ— å…³ï¼Œè€Œæ˜¯ä¸ä¸€ä¸ªç‰¹å®šçš„*æ–‡æ¡£*ç›¸å…³ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå®éªŒç»“æœ...ğŸ”¬

## [](#scenario)åœºæ™¯

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæƒ³è±¡ä¸€ä¸‹è¿™ä¸ªå®é™…çš„ä¾‹å­:æˆ‘ä»¬å¿…é¡»å¤„ç†â€œæˆ¿å­â€ï¼Œæ¯ä¸ªæˆ¿å­éƒ½æœ‰ä¸€äº›â€œæˆ¿é—´â€(ä¸€ä¸ªæµ´å®¤ï¼Œä¸€ä¸ªå¨æˆ¿ï¼Œ...).æ¯ä¸ªæˆ¿é—´éƒ½æœ‰â€œå®¶å…·â€(ä¸€å¼ åºŠã€ä¸¤æŠŠæ¤…å­ç­‰ç­‰)ã€‚
ä¸ºäº†å¯¹è¿™ä¸ªåœºæ™¯å»ºæ¨¡ï¼Œæˆ‘ä»¬å¯ä»¥è®¾æƒ³å®ç°è¿™äº›å®ä½“:

*   å®¶å…·é¡¹ç›®
*   æˆ¿é—´
*   æˆ¿å­

å®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯è¿™æ ·çš„:

```
Houses   <--- a collection
 |
 |--- My-House <---a Document of Houses
        |--Address <---- a field of "My-House" document
        |--Rooms   <----- a Subcollection of "My-House"
            |
            |--Kitchen
            |--Bathroom
            |--Bedroom <--- a document of Rooms
                    |
                    |--FurnitureItems  <--- a Subcollection of Bedroom document
                            |
                            |-- Bed
                            |-- Wardrobe 
```

## [](#the-repository)å‚¨å­˜åº“

ä¸ºäº†ç®€å•èµ·è§ï¼Œè®©æˆ‘ä»¬é›†ä¸­è®¨è®ºè¿™ä¸¤ç§æ–¹æ³•

*   â€œæ·»åŠ â€å°†æ–‡æ¡£æ·»åŠ åˆ°é›†åˆä¸­
*   â€œGetByIdâ€é€šè¿‡ Id è¿”å›æ–‡æ¡£

å°±ç•Œé¢è€Œè¨€ï¼Œæˆ‘ä»¬æœ‰:

```
public interface IRepository<T>{
    Either<String,String> Add(T data);
    Either<String, T> GetById(String id);
} 
```

æš‚ä¸”å¿½ç•¥å­é›†åˆï¼Œå®ç°ç±»å¯ä»¥æ˜¯:

```
public  class  FirestoreRepository<T> implements IRepository<T>{

    private CollectionReference collection;
    private Class<T> classType;

    public FirestoreRepository(Firestore firestore, String collectionPath, Class<T> classType){
        this.collection = firestore.collection(collectionPath);
        this.classType = classType;
    }

    public Either<String,String> Save(T data){ 
        try{
            ApiFuture<DocumentSnapshot> futureResult = collection.add(data).get().get();
            DocumentSnapshot result = futureResult.get();
            return Either.right(result.getId());
        }catch(Exception ex){
            return Either.left(ex.getMessage());
        }
    }

    public Either<String, T> GetById(String id) {
        try{
            ApiFuture<DocumentSnapshot> futureEntry = collection.document(id).get();
            DocumentSnapshot entry = futureEntry.get();
            return entry.exists()
                ? Either.right(entry.toObject(classType))
                : Either.left("Data not found for id: "+id);
        }catch(Exception ex){
            return Either.left(ex.getMessage());
        }
    }
} 
```

* * *

**æ³¨æ„:**
æ£€ç´¢*documents sphot*çš„ GoogleApi æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œå®ƒä»¬ç¡®å®è¿”å›äº†ä¸€ä¸ª[API Future](https://googleapis.github.io/api-common-java/1.1.0/apidocs/com/google/api/core/ApiFuture.html)(Java Future çš„ GoogleAPI å®ç°)ã€‚

ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘é€‰æ‹©é¿å…å¼‚æ­¥æ–¹æ³•é˜»å¡æ‰§è¡Œï¼Œç›´åˆ°å°†æ¥å®Œæˆã€‚æ˜¯çš„ï¼Œæˆ‘çŸ¥é“ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­è¿™æ ·åšä¸æ˜¯ä¸ªå¥½ä¸»æ„ğŸ¤“

* * *

ä¸Šé¢çš„å®ç°å‡è®¾æ‰€æœ‰çš„é›†åˆéƒ½åœ¨æ ¹çº§åˆ«ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­é›†åˆå¼•ç”¨ç¡®å®æ˜¯ä» firestore å¯¹è±¡åˆ›å»ºçš„:

```
this.collection = firestore.collection(collectionPath); 
```

å½“æˆ‘ä»¬ä½¿ç”¨ firestore å­é›†åˆæ—¶ï¼Œè¿™ä¸ªå‡è®¾æ˜¯ä¸æ­£ç¡®çš„ã€‚ä¸€ä¸ªå­é›†åˆä¸ä¸€ä¸ªç‰¹å®šçš„æ–‡æ¡£ç›¸å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦
ä¸€ä¸ª *DocumentReference* æ¥è·å–å®ƒçš„ä¸€ä¸ªé›†åˆã€‚
æ¯”å¦‚:

```
CollectionReference furnitureCollection = firestore
        .collection("Houses")
        .document("My-House")
        .collection("Rooms")
        .document("bathroom")
        .collection("FurnitureItems"); 
```

æˆ‘ä»¬æ³¨æ„åˆ°æˆ‘ä»¬éœ€è¦é“¾æ¥*é›†åˆå¼•ç”¨*å’Œ*æ–‡æ¡£å¼•ç”¨*æ¥è®¿é—®å³è¾¹çš„å­é›†åˆã€‚

å› æ­¤ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ FirestoreRepository çš„æ„é€ å‡½æ•°æ¥æ¥å—ä¸€ä¸ª *CollectionReference* ã€‚

```
public FirestoreRepository(CollectionReference collection, Class<T> classType){
        this.collection = collection;
        this.classType = classType;
    } 
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ¶ˆé™¤äº†æ¯ä¸ªé›†åˆéƒ½åœ¨æ ¹çº§åˆ«çš„å‡è®¾ã€‚

## [](#the-repository-factory)ä»“åº“å·¥å‚

ç°åœ¨è®©æˆ‘ä»‹ç»ä¸€ä¸‹**ä»“åº“å·¥å‚**ï¼Œå…¶èŒè´£æ˜¯:

*   é“¾*é›†åˆå¼•ç”¨*å’Œ*æ–‡æ¡£å¼•ç”¨*
*   ä¸ºç‰¹å®šé›†åˆ(æˆ–å­é›†åˆ)åˆ›å»º IRepository å®ä¾‹ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è·å¾—ç›¸å¯¹äºâ€œæˆ‘çš„æˆ¿å­â€çš„æ–‡æ¡£â€œæµ´å®¤â€çš„â€œfurniture itemsâ€
çš„å­˜å‚¨åº“ï¼Œæˆ‘ä»¬æœŸæœ›å¾—åˆ°ç±»ä¼¼äº:
çš„å†…å®¹

```
 IRepository<FurnitureItem> furnitureRepo = repoFactory
        .FromDocument(House.class, "My-House")
        .FromDocument(Room.class, "bathroom")
        .GetRepository(FurnitureItem.class);

    furnitureRepo.Add(new FurnitureItem("chair")); 
```

å¦åˆ™ï¼Œå¦‚æœæˆ‘ä»¬æƒ³é€šè¿‡*æˆ¿å­*é›†åˆè¿›è¡ŒæŸ¥è¯¢ï¼Œæˆ‘ä»¬åº”è¯¥æœ‰:

```
 IRepository<House> houseRepo = repoFactory.GetRepository(FurnitureItem.class);
  houseRepo.Add(new House()); 
```

æˆ‘ä»¬æ³¨æ„åˆ°æ¥è‡ªæ–‡æ¡£çš„æ–¹æ³•*åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„ RepositoryFactory å®ä¾‹ã€‚è¿™å…è®¸æˆ‘ä»¬ä¿å­˜ä¸€ä¸ª *RepositoryFactory* å¼•ç”¨æ¥è®¿é—®å®ƒçš„æ‰€æœ‰å­é›†åˆã€‚
ä¾‹å¦‚è€ƒè™‘ä¸€ä¸ªâ€œæˆ¿å­â€ï¼Œé™¤äº†â€œæˆ¿é—´â€é›†åˆä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªâ€œæˆ¿å®¢â€é›†åˆã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­æˆ‘ä»¬å¯ä»¥å†™:* 

```
RepositoryFactory myHouseRepoFactory = repoFactory.FromDocument(House.class, "MyHouse");

myHouseRepoFactory
    .FromDocument(Room.class, "kitchen") //this do not modify the collection root of myHouseRepoFactory
    .GetRepository(FurnitureItem.class)
    .Add(new FurnitureItem());

myHouseRepoFactory
    .GetRepository(Tenant.class)
    .Add(new Tenant()); 
```

## [](#design-the-repositoryfactory-triangularruler-pencil2)è®¾è®¡ä»“åº“å·¥å‚ğŸ“ âœï¸

ç‰¢è®°ä¸€åˆ‡ï¼Œæˆ‘ä»¬çš„*ä»“åº“å·¥å‚*éœ€è¦:

1.  å°†æ¨¡å‹ç±»ç±»å‹ä¸é›†åˆåç§°é“¾æ¥èµ·æ¥çš„æ˜ å°„
2.  åˆ›å»ºå­˜å‚¨åº“çš„æŒ‡é’ˆ:å¦‚æœå­˜å‚¨åº“åœ¨æ ¹çº§åˆ«ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥æ˜¯ firestore å®ä¾‹ï¼Œå¦åˆ™åº”è¯¥æ˜¯ *DocumentReference* ã€‚
3.  å°†æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª *DocumentReference* çš„æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ *RepositoryFactory* å®ä¾‹ã€‚
4.  è·å–æŒ‡å®šé›†åˆ(æˆ–*å­é›†åˆ*)çš„ *IRepository* å®ä¾‹çš„æ–¹æ³•

#### [](#the-modelcollection-map)æ¨¡å‹-é›†åˆå›¾

ä¸ºäº†å°†æ¯ä¸ªæ¨¡å‹ç±»ç±»å‹ä¸ç›¸å¯¹é›†åˆåç§°è”ç³»èµ·æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è¿™æ ·ä¸€ä¸ªæ˜ å°„:

```
private final static Map<Class<?>, String> collectionMap = Map.of(
        House.class, "Houses",
        Room.class, "Rooms",
        FurnitureItem.class, "Furniture"
    ); 
```

#### [](#the-pointer)æŒ‡é’ˆ

è¯·è®°ä½ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æŒ‡é’ˆ:

*   å¦‚æœé›†åˆä½äºæ ¹çº§åˆ«ï¼Œåˆ™ä¸º *Firestore* å®ä¾‹
*   ä¸€ä¸ª*æ–‡æ¡£å¼•ç”¨*å¦‚æœé›†åˆç›¸å¯¹äºä¸€ä¸ªç‰¹å®šçš„æ–‡æ¡£(ä¹Ÿç§°ä¸ºå­é›†åˆ)

æˆ‘ä»¬å¯ä»¥ä¿ç•™ä¸€ä¸ªå¯¹ *Firestore* çš„å¼•ç”¨å’Œä¸€ä¸ªå¯¹ *DocumentReference* çš„å¼•ç”¨ï¼Œç„¶åæˆ‘ä»¬åº”è¯¥æœ‰ä¸€äº›é€»è¾‘æ¥é€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªã€‚

```
public class RepositoryFactory{
    ....
    private Firestore firestore;
    private DocumentRefernce documentReference;
    private Boolean isRootLevel;

    public RepositoryFactory(Firestore firestore){
        this.firestore = firestore;
        isRootLevel = true;
    }

    private RepositoryFactory(DocumentReference documentReference){
        this.documentReference = documentReference;
        isRootLevel = false;
    }

    ....

    private CollectionReference getCollectionReference(String collectionName){
        return isRootLevel
            ? firestore.collection(collectionName)
            : documentReference.collection(collectionName);
    }
    ....
} 
```

ä½†æ˜¯å½“å°†æŒ‡é’ˆä»æ ¹çº§åˆ«ç§»åŠ¨åˆ°æ–‡æ¡£çº§åˆ«æ—¶ï¼Œfirestore å¼•ç”¨ä¸å†æœ‰ç”¨ã€‚æœ‰æ²¡æœ‰åŠæ³•åªä¿ç•™æˆ‘ä»¬éœ€è¦çš„æŒ‡é’ˆï¼Ÿ

ğŸ’¡æ•‘æ´çš„åŠŸèƒ½æ–¹æ³•ï¼

æˆ‘ä»¬å®é™…ä¸Šå¯ä»¥åªä¿ç•™å¯¹ä¸€ä¸ªå‡½æ•°çš„å¼•ç”¨ï¼Œè¯¥å‡½æ•°ç»™å®šä¸€ä¸ªé›†åˆåç§°ï¼Œæ£€ç´¢ä¸€ä¸ª*é›†åˆå¼•ç”¨* :

```
public class RepositoryFactory{
    ....
    private Function<String, CollectionReference> getCollectionReference;
    ....

    public RepositoryFactory(Firestore firestore){
        getCollectionReference = collectionPath -> firestore.collection(collectionPath);
    }

    private RepositoryFactory(DocumentReference document){
        getCollectionReference = collectionPath -> document.collection(collectionPath);
    }
    ....
} 
```

è¿™æ ·ï¼ŒRepositoryFactory çš„æ¯ä¸ªå®ä¾‹åªä¿ç•™å¯¹å³æŒ‡é’ˆçš„å¼•ç”¨ã€‚

#### [](#move-the-pointer-to-a-specific-document)å°†æŒ‡é’ˆç§»åŠ¨åˆ°ç‰¹å®šçš„æ–‡æ¡£

è¦åœ¨*æ–‡æ¡£å¼•ç”¨*ä¸­ç§»åŠ¨ï¼Œæˆ‘ä»¬ä¸æƒ³ä¿®æ”¹ç°æœ‰çš„*ä»“åº“å·¥å‚*å®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œä»¥æ–°çš„*æ–‡æ¡£å¼•ç”¨*ä½œä¸ºæŒ‡é’ˆ:

```
 public  RepositoryFactory FromDocument(Class<?> classType, String documentId){
        String collectionName = collectionMap.get(classType);
        DocumentReference documentReference = getCollectionReference.apply(collectionName).document(documentId);
        return new RepositoryFactory(documentReference);
    } 
```

#### [](#create-a-repository-for-a-given-model)ä¸ºç»™å®šçš„æ¨¡å‹åˆ›å»ºä¸€ä¸ªå­˜å‚¨åº“

æ­¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–¹æ³•ï¼Œç»™å®šä¸€ä¸ªæ¨¡å‹ç±»ç±»å‹ï¼Œè¿”å›ä¸€ä¸ª *IRepository < >* å®ä¾‹:

```
 public <T> IRepository<T> GetRepository(Class<T> classType){
        String collectionName = collectionMap.get(classType);
        return new FirestoreRepository<T>(getCollectionReference.apply(collectionName), classType);
    } 
```

## [](#pick-up-the-pieces)æ”¶æ‹¾æ®‹å±€

æœ€åï¼Œæˆ‘ä»¬çš„å­˜å‚¨åº“æ¨¡å¼å®ç°åº”è¯¥æ˜¯è¿™æ ·çš„:

```
 //IRepository.java
public interface IRepository<T>{
    Either<String,String> Add(T data);
    Either<String, T> GetById(String id);
}

//FirestoreRepository.java
public  class  FirestoreRepository<T> implements IRepository<T>{

    private CollectionReference collection;
    private Class<T> classType;

    public FirestoreRepository(CollectionReference collection, Class<T> classType){
        this.collection = collection;
        this.classType = classType;
    }

    public Either<String,String> Add(T data){ 
        try{
            DocumentSnapshot result = collection.add(data).get().get().get();
            return Either.right(result.getId());
        }catch(Exception ex){
            return Either.left(ex.getMessage());
        }
    }

    public Either<String, T> GetById(String id) {
        try{
            DocumentSnapshot entry = collection.document(id).get().get();
        return entry.exists()
                ? Either.right(entry.toObject(classType))
                : Either.left("Data not found for id: "+id);
        }catch(Exception ex){
            return Either.left(ex.getMessage());
        }
    }
}

//RepositoryFactory.java
public class RepositoryFactory{

    private Function<String, CollectionReference> getCollectionReference;

    private final static Map<Class<?>, String> collectionMap = Map.of(
        House.class, "Houses",
        Room.class, "Rooms",
        FurnitureItem.class, "Furniture"
    );   

    public RepositoryFactory(Firestore firestore){
        getCollectionReference = collectionPath -> firestore.collection(collectionPath);
    }

    private RepositoryFactory(DocumentReference document){
        getCollectionReference = collectionPath -> document.collection(collectionPath);
    }

    public  RepositoryFactory FromDocument(Class<?> classType, String documentId){
        String collectionName = collectionMap.get(classType);
        DocumentReference documentReference = getCollectionReference.apply(collectionName).document(documentId);
        return new RepositoryFactory(documentReference);
    }

    public <T> IRepository<T> GetRepository(Class<T> classType){
        String collectionName = collectionMap.get(classType);
        return new FirestoreRepository<T>(getCollectionReference.apply(collectionName), classType);
    }
} 
```

## [](#to-sum-up)æ€»è€Œè¨€ä¹‹

è¿™å°±æ˜¯æˆ‘å¦‚ä½•å®ç°å­˜å‚¨åº“æ¨¡å¼æ¥å¤„ç† Firestore å­é›†åˆçš„ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨ Javaï¼Œä½†æ˜¯å®ƒåº”è¯¥å¾ˆå®¹æ˜“ç§»æ¤åˆ°å…¶ä»–è¯­è¨€ã€‚

## [](#open-points)å¼€åˆ†

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å¿½ç•¥äº†ä¸€äº›å¯ä»¥åœ¨å•ç‹¬çš„ä¸»é¢˜ä¸­è§£å†³çš„æ–¹é¢:

*   å¦‚ä½•åº”å¯¹ Google *ApiFuture* å’Œ Java *CompletableFuture* ã€‚
*   å¦‚ä½•å¤„ç†ç‰¹å®šäºæ¨¡å‹çš„æŸ¥è¯¢ï¼Ÿ

## [](#technologies)æŠ€æœ¯

*   Java è¯­è¨€(ä¸€ç§è®¡ç®—æœºè¯­è¨€ï¼Œå°¤ç”¨äºåˆ›å»ºç½‘ç«™)
*   å¤§çˆ†å‘
*   å­é›†åˆ
*   çŸ¥è¯†åº“æ¨¡å¼

è®©æˆ‘çŸ¥é“æ‚¨ä½¿ç”¨å­é›†åˆçš„æ–¹å¼ï¼