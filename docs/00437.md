# ä¸º NestJS å¼•å…¥ NoSQL Azure è¡¨å­˜å‚¨ğŸš€

> åŸæ–‡:[https://dev . to/azure/introducing-no SQL-azure-table-storage-for-nestjs-291m](https://dev.to/azure/introducing-nosql-azure-table-storage-for-nestjs-291m)

> åŸè½½äº [Trilon åšå®¢](https://trilon.io/blog/nestjs-nosql-azure-table-storage)2019 . 9 . 17ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ–°çš„`@nestjs/azure-database`åº“ï¼Œåœ¨å‡ åˆ†é’Ÿå†…äº†è§£å¦‚ä½•å°† Azure è¡¨å­˜å‚¨æ·»åŠ åˆ°æˆ‘ä»¬çš„ NestJS åº”ç”¨ç¨‹åºä¸­ï¼

å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰ [NestJS](https://nestjs.com/) ï¼Œå®ƒæ˜¯ä¸€ä¸ª TypeScript Node.js æ¡†æ¶ï¼Œå¯ä»¥å¸®åŠ©æ‚¨æ„å»ºä¼ä¸šçº§é«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„ Node.js åº”ç”¨ç¨‹åºã€‚

# [](#whats-azure-table-storage)ä»€ä¹ˆæ˜¯ Azure è¡¨å‚¨ï¼Ÿ

[Azure Table Storage](http://bit.ly/2lMRQQh) æ˜¯ä¸€å®¶ NoSQL é”®å€¼å­˜å‚¨ï¼Œä½¿ç”¨å¤§é‡åŠç»“æ„åŒ–æ•°æ®é›†ã€‚

è¡¨å­˜å‚¨å…è®¸æ‚¨åˆ›å»ºéœ€è¦çµæ´»æ•°æ®æ¨¡å¼çš„å¤§è§„æ¨¡å¯ä¼¸ç¼©åº”ç”¨ç¨‹åºã€‚æ‚¨è¿˜å¯ä»¥æ‰§è¡ŒåŸºäº OData çš„æŸ¥è¯¢ï¼Œå¹¶ä½¿ç”¨ JSON æ¥åºåˆ—åŒ–æ•°æ®ã€‚

ä½¿ç”¨ Azure è¡¨å­˜å‚¨æ¥å­˜å‚¨æ•° Pb çš„åŠç»“æ„åŒ–æ•°æ®ï¼Œå¹¶ä¿æŒä½æˆæœ¬ã€‚

ä¸è®¸å¤šæ•°æ®å­˜å‚¨ä¸åŒâ€”â€”å†…éƒ¨æˆ–åŸºäºäº‘çš„:

*   è¡¨å­˜å‚¨ä½¿æ‚¨æ— éœ€æ‰‹åŠ¨åˆ†å‰²æ•°æ®é›†å³å¯è¿›è¡Œæ‰©å±•ã€‚
*   å¯ç”¨æ€§ä¹Ÿä¸æ˜¯ä¸€ä¸ªé—®é¢˜ï¼
*   ä½¿ç”¨åœ°ç†å†—ä½™å­˜å‚¨ï¼Œå­˜å‚¨çš„æ•°æ®åœ¨ä¸€ä¸ªåŒºåŸŸå†…å¤åˆ¶ä¸‰æ¬¡ï¼Œåœ¨æ•°ç™¾è‹±é‡Œå¤–çš„å¦ä¸€ä¸ªåŒºåŸŸå†å¤åˆ¶ä¸‰æ¬¡ã€‚

è®©æˆ‘ä»¬æ·±å…¥ç ”ç©¶å¦‚ä½•åœ¨ NestJS åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¡¨å­˜å‚¨ï¼

# [](#getting-setup)è·å–è®¾ç½®

> *æ³¨æ„*:åœ¨æœ¬æ¬¡æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºä¸€ä¸ªç”± CLI ç”Ÿæˆçš„æ–°çš„ NestJS åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯å¦‚æœæ‚¨å–œæ¬¢ä½¿ç”¨ç°æœ‰çš„ NestJS åº”ç”¨ç¨‹åºï¼Œè¯·éšæ„ï¼Œç›´æ¥è·³è¿‡ï¼

## [](#generate-a-new-nestjs-application)ç”Ÿæˆæ–°çš„ NestJS åº”ç”¨ç¨‹åº

å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œè®©æˆ‘ä»¬ç¡®ä¿å®‰è£…äº†æœ€æ–°çš„ NestJS CLI å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºã€‚

```
$ npm i -g @nestjs/cli
$ nest new PROJECT_NAME 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬è¿›å…¥æ–°åˆ›å»ºçš„ç›®å½•å¹¶æ‰“å¼€æˆ‘ä»¬çš„ IDEã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»ç”Ÿæˆäº†ä¸€ä¸ªç®€å•çš„ NestJS åº”ç”¨ç¨‹åºã€‚

## [](#setting-up-an-azure-storage-account)è®¾ç½® Azure å­˜å‚¨å¸æˆ·

ä¸ºäº†ä½¿ç”¨[è¡¨å­˜å‚¨](http://bit.ly/2lMRQQh)ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª Azure å­˜å‚¨å¸æˆ·ã€‚ä½ å¯ä»¥æŒ‰ç…§è¿™ä¸ª[ä¸€æ­¥ä¸€æ­¥çš„æŒ‡å¼•](http://bit.ly/2mvqkHq)ã€‚

åˆ›å»ºå­˜å‚¨å¸æˆ·åï¼Œæˆ‘ä»¬éœ€è¦å¤åˆ¶å°†ç”¨äº SDK çš„è¿æ¥å­—ç¬¦ä¸²ã€‚åœ¨ [Azure é—¨æˆ·](https://portal.azure.com/)ä¸­ï¼Œè¿›å…¥ä»ªè¡¨æ¿>å­˜å‚¨>æ‚¨çš„å­˜å‚¨è´¦æˆ·:

[![Alt Text](img/f417cf2ee0271efb359788eebba0b61c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ZSnR_ql_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/1276n6osvvj71btuuoju.png)

è®°ä¸‹åœ¨â€œè®¾ç½®â€é€‰é¡¹å¡ä¸‹çš„â€œè®¿é—®å¯†é’¥â€ä¸­è·å¾—çš„â€œå­˜å‚¨å¸æˆ·åç§°â€å’Œâ€œè¿æ¥å­—ç¬¦ä¸²â€ã€‚

> æç¤º:è¿æ¥å­—ç¬¦ä¸²åº”è¯¥ä»¥`DefaultEndpointsProtocol=`å¼€å¤´

# [](#nestjs-azure-storage-installation)NestJS Azure å­˜å‚¨å®‰è£…

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…æ¥è‡ª NPM çš„`@nestjs/azure-database`SDK:

```
$ npm i --save @nestjs/azure-database dotenv 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> æˆ‘ä»¬è¿˜å®‰è£…äº†`dotenv`åŒ…ï¼Œå…è®¸æˆ‘ä»¬å¤„ç†ç¯å¢ƒå˜é‡ã€‚

ç„¶åï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸ºã€‚env åŒ…å«ä»¥ä¸‹å†…å®¹:

```
AZURE_STORAGE_CONNECTION_STRING="<the connection string we copied from previous step>" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*åŒæ ·éå¸¸é‡è¦çš„æ˜¯:æˆ‘ä»¬å°†ç¡®ä¿æŠŠæˆ‘ä»¬çš„`.env`æ–‡ä»¶æ·»åŠ åˆ°`.gitignore`ä¸­ï¼åœ¨ Git ä¸Šä¸èƒ½å¯¹`.env`æ–‡ä»¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚*

ä¸€æ—¦`.env`æ–‡ä»¶è¢«åˆ›å»ºå¹¶å‡†å¤‡å¥½ï¼Œæˆ‘ä»¬å°†åŒ…å«ä¸‹é¢å¯¹`src/main.ts`æ–‡ä»¶çš„è°ƒç”¨:

```
if (process.env.NODE_ENV !== 'production') require('dotenv').config(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> æç¤º:è¿™ä¸€è¡Œå¿…é¡»æ·»åŠ åˆ°`src/main.ts`æ–‡ä»¶ä¸­ä»»ä½•å…¶ä»–å¯¼å…¥ä¹‹å‰çš„*ï¼*

æˆ‘ä»¬çš„è®¾ç½®ç°åœ¨å‡†å¤‡å¥½äº†ã€‚è®©æˆ‘ä»¬å®ç°åº”ç”¨ç¨‹åºçš„é€»è¾‘ã€‚

# [](#preparing-our-business-logic)å‡†å¤‡æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘

NestJS ä¸­çš„ Azure è¡¨å­˜å‚¨æ”¯æŒéµå¾ªå¯¹è±¡å…³ç³»æ˜ å°„(ORM)è®¾è®¡æ¨¡å¼ï¼Œè¿™åŸºæœ¬ä¸Šæ˜¯ä¸€ç§ä»æˆ‘ä»¬çš„ä»£ç è®¿é—®æ•°æ®åº“çš„â€œç»“æ„åŒ–â€æ–¹å¼â€”â€”è®©æ‚¨ä½¿ç”¨ API è€Œä¸æ˜¯ç¼–å†™å®é™…çš„ SQL ä»£ç ã€‚

ä¸ºäº†å®ç°è¿™ç§è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªç‰¹æ€§åˆ›å»ºä»¥ä¸‹ç»„ä»¶:

*   `DTO`(æˆ–æ•°æ®ä¼ è¾“å¯¹è±¡)
    *   è¿™æ˜¯è¡¨ç¤ºæˆ‘ä»¬æ•°æ®çš„å¯¹è±¡ã€‚DTO ä¸»è¦ç”¨äºåœ¨åº”ç”¨ç¨‹åºæœåŠ¡ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œä¾‹å¦‚ HTTP æœåŠ¡å’Œæµè§ˆå™¨ä¹‹é—´çš„æ•°æ®ä¼ è¾“ã€‚
*   `Entity`
    *   è¿™åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªæ˜ å°„åˆ°è¡¨æ¨¡å¼çš„ç±»ã€‚
*   `Repository`
    *   è¿™æ˜¯è´Ÿè´£ä¸æ•°æ®åº“é€šä¿¡çš„ç»„ä»¶ã€‚

è®©æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ª NestJS ç‰¹æ€§æ¨¡å—ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­æ‰˜ç®¡æˆ‘ä»¬çš„ç‰¹æ€§ä¸šåŠ¡é€»è¾‘ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ NestJS CLI åˆ›å»ºä¸€ä¸ª`Cat`ç‰¹æ€§:

```
$ nest generate module cat 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> æ³¨æ„:æˆ‘ä»¬å°†åœ¨è¿‡ç¨‹çš„æœ€åå›åˆ°æˆ‘ä»¬ç”Ÿæˆçš„æ¨¡å—ã€‚

## [](#dto)DTO

æˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬çš„`Cat`ç‰¹æ€§åˆ›å»ºçš„ç¬¬ä¸€ä¸ªç»„ä»¶æ˜¯ä¸€ä¸ª d toã€‚åœ¨åä¸º`cat.dto.ts`çš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸‹é¢çš„ç±»:

```
export class CatDTO {
  name: string;
  age: number;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#entity)å®ä½“

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª`Entity`ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º`cat.entity.ts`çš„æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨`@nestjs/azure-database`æä¾›çš„è£…é¥°å™¨æ¥æè¿°æ¨¡å‹:

| å®ä½“ | ä»£è¡¨ | éœ€è¦ |
| --- | --- | --- |
| `@EntityPartitionKey(value: string)` | å®ä½“çš„`PartitionKey` | æ˜¯ |
| `@EntityRowKey(value: string)` | å®ä½“çš„`RowKey` | æ˜¯ |
| `@EntityInt32(value?: string)` | æœ‰ç¬¦å· 32 ä½æ•´æ•°å€¼ |  |
| `@EntityInt64(value?: string)` | æœ‰ç¬¦å· 64 ä½æ•´æ•°å€¼ |  |
| `@EntityBinary(value?: string)` | äºŒè¿›åˆ¶(blob)æ•°æ® |  |
| `@EntityBoolean(value?: string)` | `true`æˆ–`false`å€¼ |  |
| `@EntityString(value?: string)` | å­—ç¬¦æ•°æ® |  |
| `@EntityDouble(value?: string)` | ç²¾åº¦ä¸º 15 ä½çš„æµ®ç‚¹æ•° |  |
| `@EntityDateTime(value?: string)` | ä¸€å¤©ä¸­çš„æ—¶é—´ |  |

> **æ³¨æ„:**API åœ¨ç¨³å®šç‰ˆæœ¬ä¸­å¯èƒ½ä¼šç•¥æœ‰å˜åŒ–ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹å®ä½“çš„å½¢çŠ¶:

```
import {
  EntityPartitionKey,
  EntityRowKey,
  EntityString,
  EntityIn32
} from '@nestjs/azure-database';

@EntityPartitionKey('CatID')
@EntityRowKey('CatName')
export class Cat {
  @EntityString() name: string;
  @EntityIn32() age: number;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`Cat`å®ä½“å°†è¢«è‡ªåŠ¨è½¬æ¢ä¸º Azure è¡¨å­˜å‚¨æ‰€æœŸæœ›çš„ä»¥ä¸‹æ¨¡å¼:

```
{  "PartitionKey":  {  "_":  "CatID",  "$":  "Edm.String"  },  "RowKey":  {  "_":  "CatName",  "$":  "Edm.String"  },  "name":  {  "_":  undefined,  "$":  "Edm.String"  },  "age":  {  "_":  undefined,  "$":  "Edm.Int32"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#repository)å‚¨å­˜åº“

åœ¨ DTO å’Œå®ä½“ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦åˆ›å»ºä¸€ä¸ª`Cat`æœåŠ¡ï¼Œå®ƒå°†æŠ½è±¡ä¸`Cat`å®ä½“ç›¸å…³çš„æ‰€æœ‰ CRUD æ“ä½œã€‚è¿™ä¸ªæœåŠ¡å°†ä½¿ç”¨ Azure Table å­˜å‚¨`Repository`ã€‚

è®©æˆ‘ä»¬ä½¿ç”¨ NestJS CLI åˆ›å»ºä¸€ä¸ªæœåŠ¡:

```
$ nest generate service cat 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨åˆ›å»ºçš„`cat.service.ts`ä¸­ï¼Œæˆ‘ä»¬å¯¼å…¥`Repository`å¹¶ä¸ºå…¶æä¾›ä¸Šä¸€æ­¥åˆ›å»ºçš„`Cat`å®ä½“å®šä¹‰:

```
import { Injectable } from '@nestjs/common';
import { Repository, InjectRepository } from '@nestjs/azure-database';
import { Cat } from './cat.entity';

@Injectable()
export class CatService {
  constructor(
    @InjectRepository(Cat)
    private readonly catRepository: Repository<Cat>,
  ) {}

  // ... other code ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Azure Table Storage `Repository`æ¥å£æä¾›äº†ä¸€å †å…¬å…± API å’Œç±»å‹ï¼Œç”¨äºç®¡ç†å„ç§ CRUD ( `Create`ã€`Read`ã€`Update`å’Œ`Delete`)æ“ä½œã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨`@nestjs/azure-database` SDK å®ç°æ¯ä¸ªä¸åŒçš„æ“ä½œã€‚

## [](#the-methods-we-will-be-invoking-are-the-following)æˆ‘ä»¬å°†è°ƒç”¨çš„æ–¹æ³•å¦‚ä¸‹:

*   `create(entity: T): Promise<T>`åˆ›å»ºæ–°å®ä½“ã€‚
*   `findAll(tableQuery?: azure.TableQuery, currentToken?: azure.TableService.TableContinuationToken): Promise<AzureTableStorageResultList<T>>`æŸ¥æ‰¾ä¸ç»™å®šæŸ¥è¯¢åŒ¹é…çš„æ‰€æœ‰å®ä½“(å¦‚æœæ²¡æœ‰æä¾›æŸ¥è¯¢ï¼Œåˆ™è¿”å›æ‰€æœ‰å®ä½“)ã€‚
*   `find(rowKey: string, entity: Partial<T>): Promise<T>`ä½¿ç”¨è¡Œé”®æŸ¥æ‰¾ä¸€ä¸ªå®ä½“ã€‚
*   `update(rowKey: string, entity: Partial<T>): Promise<T>`æ›´æ–°ä¸€ä¸ªå®ä½“ã€‚è¿™å°†è¿›è¡Œéƒ¨åˆ†æ›´æ–°ã€‚
*   `delete(rowKey: string, entity: T): Promise<AzureTableStorageResponse>`ä½¿ç”¨å®ä½“çš„è¡Œé”®åˆ é™¤å®ä½“ã€‚

### [](#here-is-an-example-of-such-implementation)ä¸‹é¢æ˜¯è¿™æ ·ä¸€ä¸ªå®ç°çš„ä¾‹å­:

```
import { Injectable } from '@nestjs/common';
import { Repository, InjectRepository } from '@nestjs/azure-database';
import { Cat } from './cat.entity';

@Injectable()
export class CatService {
  constructor(
    @InjectRepository(Cat)
    private readonly catRepository: Repository<Cat>,
  ) {}

  // find one cat entitu by its rowKey
  async find(rowKey: string, cat: Cat): Promise<Cat> {
    return this.catRepository.find(rowKey, cat);
  }

  // find all cat entities
  async findAll(): Promise<AzureTableStorageResultList<Cat>> {
    return this.catRepository.findAll();
  }

  // create a new cat entity
  async create(cat: Cat): Promise<Cat> {
    return this.catRepository.create(cat);
  }

  // update the a cat entity by its rowKey
  async update(rowKey: string, cat: Partial<Cat>): Promise<Cat> {
    return this.catRepository.update(rowKey, cat);
  }

  // delete a cat entity by its rowKey
  async delete(rowKey: string, cat: Cat): Promise<AzureTableStorageResponse> {
    return this.catRepository.delete(rowKey, cat);
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#controller)æ§åˆ¶å™¨

æœ€åä¸€æ­¥æ˜¯å®ç°å¤„ç† HTTP è¯·æ±‚çš„ NestJS æ§åˆ¶å™¨ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ NestJS CLI åˆ›å»ºè¿™æ ·ä¸€ä¸ªæ§åˆ¶å™¨:

```
$ nest generate controller cat 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ§åˆ¶å™¨çš„å®ç°å¾ˆç®€å•ï¼Œå¯èƒ½å–å†³äºæ‚¨çš„åº”ç”¨ç¨‹åºä¸šåŠ¡éœ€æ±‚ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå®ç°çš„ä¾‹å­:

```
import {
  Body,
  Controller,
  Delete,
  Get,
  Param,
  Post,
  Put,
  UnprocessableEntityException,
  NotFoundException,
  Patch
} from '@nestjs/common';
import { CatDto } from './cat.dto';
import { Cat } from './cat.entity';
import { CatService } from './cat.service';

@Controller('cats')
export class CatController {
  constructor(private readonly catService: CatService) {}

  @Get()
  async getAllCats() {
    return await this.catService.findAll();
  }

  @Get(':rowKey')
  async getCat(@Param('rowKey') rowKey) {
    try {
      return await this.catService.find(rowKey, new Cat());
    } catch (error) {
      // Entity not found
      throw new NotFoundException(error);
    }
  }

  @Post()
  async createCat(
    @Body()
    catData: CatDto,
  ) {
    try {
      const cat = new Cat();
      // Disclaimer: Assign only the properties you are expecting!
      Object.assign(cat, catData);

      return await this.catService.create(cat);
    } catch (error) {
      throw new UnprocessableEntityException(error);
    }
  }

  @Put(':rowKey')
  async saveCat(@Param('rowKey') rowKey, @Body() catData: CatDto) {
    try {
      const cat = new Cat();
      // Disclaimer: Assign only the properties you are expecting!
      Object.assign(cat, catData);

      return await this.catService.update(rowKey, cat);
    } catch (error) {
      throw new UnprocessableEntityException(error);
    }
  }

  @Patch(':rowKey')
  async updateCatDetails(@Param('rowKey') rowKey, @Body() catData: Partial<CatDto>) {
    try {
      const cat = new Cat();
      // Disclaimer: Assign only the properties you are expecting!
      Object.assign(cat, catData);

      return await this.catService.update(rowKey, cat);
    } catch (error) {
      throw new UnprocessableEntityException(error);
    }
  }

  @Delete(':rowKey')
  async deleteDelete(@Param('rowKey') rowKey) {
    try {
      const response = await this.catService.delete(rowKey, new Cat());

      if (response.statusCode === 204) {
        return null;
      } else {
        throw new UnprocessableEntityException(response);
      }
    } catch (error) {
      throw new UnprocessableEntityException(error);
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#putting-everything-together)æŠŠä¸€åˆ‡æ”¾åœ¨ä¸€èµ·

æˆ‘ä»¬å·²ç»å®Œæˆäº†`Cat`ç‰¹æ€§çš„å®ç°ã€‚åœ¨æœ€åä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†`AzureTableStorageModule`å¯¼å…¥åˆ°æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„åµŒå¥—ç‰¹æ€§æ¨¡å—`cat.module.ts`ä¸­:

```
import { Module } from '@nestjs/common';
import { AzureTableStorageModule } from '@nestjs/azure-database';
import { CatController } from './cat.controller';
import { CatService } from './cat.service';
import { Cat } from './cat.entity';

@Module({
  imports: [AzureTableStorageModule.forFeature(Cat)],
  providers: [CatService],
  controllers: [CatController],
})
export class CatModule {} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`AzureTableStorageModule`æ¨¡å—æ¥å—å‡ ä¸ªå¯é€‰å‚æ•°:

```
AzureTableStorageModule.forFeature(Cat, {
  table: 'AnotherTableName',
  createTableIfNotExists: true,
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   `table: string`:è¡¨æ ¼çš„åç§°ã€‚å¦‚æœæ²¡æœ‰æä¾›ï¼ŒCat å®ä½“çš„åç§°å°†è¢«ç”¨ä½œè¡¨å
*   `createTableIfNotExists: boolean`:å¦‚æœä¸å­˜åœ¨ï¼Œæ˜¯å¦è‡ªåŠ¨åˆ›å»ºè¡¨æ ¼:
    *   å¦‚æœ`true`å°†åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºè¡¨æ ¼ã€‚
    *   å¦‚æœ`false`ä¸åˆ›å»ºè¡¨æ ¼ã€‚**åœ¨æŸ¥è¯¢ä¹‹å‰ï¼Œæ‚¨å¿…é¡»è‡ªå·±åˆ›å»ºè¡¨æ ¼ï¼**

# [](#in-conclusion)æ€»ä¹‹

æˆ‘ä»¬åˆšåˆšä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå®ç°äº†ä¸€ä¸ªæ–°çš„`Cat`ç‰¹æ€§ï¼Œå®ƒä½¿ç”¨`@nestjs/azure-database`å®˜æ–¹åŒ…æ¥æ·»åŠ å¯¹ Azure è¡¨å­˜å‚¨çš„æ”¯æŒã€‚æœ‰äº† NestJS çš„æ¨¡å—åŒ–ç³»ç»Ÿï¼Œæˆ‘ä»¬å°±å¯ä»¥åƒå®‰è£…ä¸€ä¸ªæœ¬åœ°çš„ Nest ç‰¹æ€§ä¸€æ ·å®‰è£…å’Œè®¾ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

å¦‚æœä½ æœ‰å…´è¶£äº†è§£æ›´å¤šå…³äºä½¿ç”¨ Azure çš„æ— æœåŠ¡å™¨ NestJS åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ï¼Œè¯·ç‚¹å‡»è¿™é‡Œé˜…è¯»æ›´å¤šä¿¡æ¯ã€‚

## ![GitHub logo](img/292a238c61c5611a7f4d07a21d9e8e0a.png) [ nestjs ](https://github.com/nestjs) / [è”šè“-æ•°æ®åº“](https://github.com/nestjs/azure-database)

### åµŒå¥—æ¡†æ¶(node.js) â˜ï¸çš„ Azure æ•°æ®åº“(è¡¨å­˜å‚¨ç­‰)æ¨¡å—

<article class="markdown-body entry-content container-lg" itemprop="text">

[![Nest Logo](img/f93a841582b106d7a2e2750bf565e886.png)T2ã€‘](http://nestjs.com/)

ä¸€ä¸ªæ¸è¿›çš„ [Node.js](http://nodejs.org) æ¡†æ¶ï¼Œç”¨äºæ„å»ºé«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„æœåŠ¡å™¨ç«¯åº”ç”¨ã€‚

[![NPM Version](img/12cbd7ae9e4751bb39296200edbebf1d.png)](https://www.npmjs.com/~nestjscore)[![Package License](img/7a0883ffae00211caa014f581f24a659.png)](https://www.npmjs.com/~nestjscore)[![NPM Downloads](img/1ff633156bcc6ccb802617a2d2af82f2.png)](https://www.npmjs.com/~nestjscore)[![Travis](img/07309b95385d2058dcce89e9e5e0050b.png)](https://travis-ci.org/nestjs/nest)[![Linux](img/f94f136f2cd50cbdac7cd14db4faf478.png)](https://travis-ci.org/nestjs/nest)[![Coverage](img/4ea5d2689611d397e74f2ba6a1d7e89b.png)](https://coveralls.io/github/nestjs/nest?branch=master)[![Discord](img/af186d8bed319b0b764f7319d33de8d9.png)](https://discord.gg/G7Qnnhy)[![Backers on Open Collective](img/45d43861b72da72ae19159a778a078da.png)](https://opencollective.com/nest#backer)[![Sponsors on Open Collective](img/3c2514ebae09db00c011dbbad9725722.png)](https://opencollective.com/nest#sponsor)[![](img/0fe9ae82dc68a426e6f836fbfeac5d2b.png)](https://paypal.me/kamilmysliwiec)[![](img/526a5bc78602caf3102e52f3c9f0e774.png)](https://twitter.com/nestframework)

## æè¿°

ç”¨äº [Nest](https://github.com/nestjs/nest) æ¡†æ¶(node.js)çš„ Azure æ•°æ®åº“([è¡¨å­˜å‚¨](http://bit.ly/nest_azure-storage-table)ã€ [Cosmos DB](https://azure.microsoft.com/en-us/services/cosmos-db/) ç­‰)æ¨¡å—

## è¾…å¯¼çš„

äº†è§£å¦‚ä½•å¼€å§‹ä½¿ç”¨ç”¨äº NestJS çš„ Azure è¡¨å­˜å‚¨

## å®‰è£…å‰

ç”¨äºæ¡Œå­å­˜å‚¨

1.  åˆ›å»ºå­˜å‚¨å¸æˆ·å’Œèµ„æº([é˜…è¯»æ›´å¤šä¿¡æ¯](http://bit.ly/nest_new-azure-storage-account)
2.  å¯¹äº[è¡¨å­˜å‚¨](http://bit.ly/nest_azure-storage-table)ï¼Œåœ¨ [Azure é—¨æˆ·](https://portal.azure.com)ä¸­ï¼Œè¿›å…¥**ä»ªè¡¨ç›˜>å­˜å‚¨> *ä½ çš„-å­˜å‚¨-è´¦æˆ·*** ã€‚
3.  è®°ä¸‹åœ¨**è®¾ç½®**é€‰é¡¹å¡ä¸‹çš„**è®¿é—®é”®**å¤„è·å¾—çš„â€œå­˜å‚¨å¸æˆ·åâ€å’Œâ€œè¿æ¥å­—ç¬¦ä¸²â€ã€‚

å¯¹äº Cosmos DB

1.  åˆ›å»ºä¸€ä¸ª Cosmos DB å¸æˆ·å’Œèµ„æº([é˜…è¯»æ›´å¤šä¿¡æ¯](https://azure.microsoft.com/en-us/services/cosmos-db/)
2.  å¯¹äº[å®‡å®™æ•°æ®åº“](http://bit.ly/nest_azure-storage-table)ï¼Œåœ¨ [Azure é—¨æˆ·](https://portal.azure.com)ï¼Œè¿›å…¥**ä»ªè¡¨ç›˜> Azure å®‡å®™æ•°æ®åº“>*your-Cosmos-DB-account***ã€‚
3.  è®°ä¸‹åœ¨**è®¾ç½®**é€‰é¡¹å¡ä¸‹çš„**é”®**å¤„è·å¾—çš„â€œURIâ€å’Œâ€œä¸»é”®â€ã€‚

## è£…ç½®

```
$ npm i --save @nestjs/azure-database
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## ä½¿ç”¨

### å¯¹äº Azure è¡¨å­˜å‚¨æ”¯æŒ

1.  åˆ›å»ºæˆ–æ›´æ–°æ‚¨ç°æœ‰çš„â€¦

</article>

[View on GitHub](https://github.com/nestjs/azure-database)