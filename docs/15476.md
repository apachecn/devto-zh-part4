# ç”¨äºæœºå™¨å­¦ä¹ æ¨¡å‹çš„æ— æœåŠ¡å™¨ API

> åŸæ–‡:[https://dev . to/IBM developer/server less-API-for-machine-learning-models-43lk](https://dev.to/ibmdeveloper/serverless-apis-for-machine-learning-models-43lk)

IBM çš„[æ¨¡å‹èµ„äº§äº¤æ˜“æ‰€](https://developer.ibm.com/exchanges/models/)ä¸ºå¼€å‘è€…æä¾›äº†ä¸€ä¸ª[ç®¡ç†çš„å…è´¹æœºå™¨å­¦ä¹ æ¨¡å‹åˆ—è¡¨](https://developer.ibm.com/exchanges/models/all/)ã€‚ç›®å‰å‘å¸ƒçš„æ¨¡å‹åŒ…æ‹¬ä»å›¾åƒä¸­æ£€æµ‹é¢éƒ¨çš„[æƒ…ç»ª](https://developer.ibm.com/exchanges/models/all/max-facial-emotion-classifier/)æˆ–[å¹´é¾„](https://developer.ibm.com/exchanges/models/all/max-facial-age-estimator/)ã€é¢„æµ‹å¤©æ°”[ã€å°†](https://developer.ibm.com/exchanges/models/all/max-weather-forecaster/)[è¯­éŸ³è½¬æ¢ä¸ºæ–‡æœ¬](https://developer.ibm.com/exchanges/models/all/max-speech-to-text-converter/)ç­‰ç­‰ã€‚æ¨¡å‹ç»è¿‡é¢„å…ˆè®­ç»ƒï¼Œå¯ä»¥åœ¨äº‘ä¸­ä½¿ç”¨ã€‚

æ¨¡å‹ä½œä¸ºä¸€ç³»åˆ—[å…¬å…± Docker å›¾åƒ](https://hub.docker.com/search?q=codait&type=image)å‘å¸ƒã€‚å›¾åƒè‡ªåŠ¨å…¬å¼€ä¸€ä¸ª HTTP API ç”¨äºæ¨¡å‹é¢„æµ‹ã€‚æ¨¡å‹åº“ä¸­çš„æ–‡æ¡£è§£é‡Šäº†å¦‚ä½•åœ¨æœ¬åœ°è¿è¡Œæ˜ åƒ(ä½¿ç”¨ Docker)æˆ–éƒ¨ç½²åˆ°äº‘ä¸­(ä½¿ç”¨ Kubernetes)ã€‚è¿™è®©æˆ‘æƒ³åˆ°â€¦

**MAX å‹å·å¯ä»¥ç”¨äºæ— æœåŠ¡å™¨åŠŸèƒ½å—ï¼Ÿ**ğŸ¤”

åœ¨æ— æœåŠ¡å™¨å¹³å°ä¸Šè¿è¡Œæœºå™¨å­¦ä¹ æ¨¡å‹å¯ä»¥åˆ©ç”¨æ°´å¹³å¯æ‰©å±•æ€§æ¥å¹¶è¡Œå¤„ç†å¤§é‡è®¡ç®—å¯†é›†å‹åˆ†ç±»ä»»åŠ¡ã€‚å†åŠ ä¸Šæ— æœåŠ¡å™¨çš„å®šä»·ç»“æ„(â€œ*å…è´¹ä½¿ç”¨*â€)ï¼Œè¿™å¯èƒ½æ˜¯åœ¨äº‘ä¸­æ‰§è¡Œæ¨¡å‹åˆ†ç±»çš„ä¸€ç§æå…¶å»‰ä»·å’Œæœ‰æ•ˆçš„æ–¹å¼ã€‚

**æ¥å—æŒ‘æˆ˜ï¼**

ç»è¿‡å‡ å¤©çš„è¯•éªŒï¼Œæˆ‘å·²ç»æ‰¾åˆ°äº†ä¸€ç§ç®€å•çš„æ–¹æ³•æ¥è‡ªåŠ¨å°† MAX æ¨¡å‹ä½œä¸ºæ— æœåŠ¡å™¨ API åœ¨ IBM äº‘å‡½æ•°ä¸Šå…¬å¼€ã€‚ğŸ‰ğŸ‰ğŸ‰

æˆ‘å·²ç»åœ¨ä¸‹é¢ç»™å‡ºäº†å¦‚ä½•ä½¿ç”¨ä¸€ä¸ªç®€å•çš„è„šæœ¬ä»æ¨¡å‹ä¸­åˆ›å»ºè¿™äº› API çš„è¯´æ˜ã€‚å¦‚æœä½ åªæ˜¯æƒ³ä½¿ç”¨è¿™äº›æ¨¡å‹ï¼Œè¯·éµå¾ªè¿™äº›è¯´æ˜ã€‚å¦‚æœä½ æœ‰å…´è¶£äº†è§£è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¯·ç»§ç»­é˜…è¯»ï¼Œæˆ‘ä¼šåœ¨åé¢è§£é‡Šæˆ‘æ˜¯æ€ä¹ˆåšçš„...

## [](#running-max-models-on-ibm-cloud-functions)åœ¨ IBM äº‘å‡½æ•°ä¸Šè¿è¡Œ MAX æ¨¡å‹

[è¿™ä¸ªåº“](https://github.com/jthomas/serverless-max-models)åŒ…å«ä¸€ä¸ª [bash è„šæœ¬](https://github.com/jthomas/serverless-max-models/blob/master/build.sh)ï¼Œå®ƒç”¨ MAX æ¨¡å‹æ„å»ºå®šåˆ¶ Docker è¿è¡Œæ—¶ï¼Œä»¥ä¾¿åœ¨ [IBM äº‘å‡½æ•°](https://cloud.ibm.com/openwhisk)ä¸Šä½¿ç”¨ã€‚å°†è¿™äº›æ˜ åƒæ¨é€åˆ° Docker Hub å…è®¸ IBM äº‘åŠŸèƒ½å°†å®ƒä»¬ç”¨ä½œå®šåˆ¶è¿è¡Œæ—¶ã€‚ä»è¿™äº›å®šåˆ¶è¿è¡Œæ—¶æ˜ åƒåˆ›å»ºçš„ Web åŠ¨ä½œå…¬å¼€äº†æ¨¡å‹æ–‡æ¡£ä¸­æè¿°çš„ç›¸åŒé¢„æµ‹ APIã€‚å®ƒä»¬æ— éœ€è¿›ä¸€æ­¥ä¿®æ”¹æˆ–å®šåˆ¶ä»£ç å³å¯ä½¿ç”¨ã€‚

### [](#prerequisites)å…ˆå†³æ¡ä»¶

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·æŒ‰ç…§ä¸‹é¢çš„é“¾æ¥è®¾ç½®ä»¥ä¸‹å·¥å…·ã€‚

*   [ç å¤´å·¥äºº](https://www.docker.com/)
*   ç å¤´æ¢çº½è´¦æˆ·
*   [IBM äº‘è´¦æˆ·](https://cloud.ibm.com/registration)
*   [IBM äº‘åŠŸèƒ½ CLI å®‰è£…å®Œæ¯•](https://cloud.ibm.com/openwhisk/learn/cli)

**æŸ¥çœ‹â€œ[æ— æœåŠ¡å™¨æœ€å¤§å‹å·](https://github.com/jthomas/serverless-max-models)èµ„æºåº“ã€‚ä»è¯¥æ–‡ä»¶å¤¹è¿è¡Œä»¥ä¸‹æ‰€æœ‰å‘½ä»¤ã€‚**

```
git clone https://github.com/jthomas/serverless-max-models 
cd serverless-max-models 
```

### [](#build-custom-runtime-images)æ„å»ºè‡ªå®šä¹‰è¿è¡Œæ—¶æ˜ åƒ

*   ç”¨ [MAX model names](https://hub.docker.com/search?q=codait&type=image) è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡(`MODELS`)å¹¶è¿è¡Œæ„å»ºè„šæœ¬ã€‚
    *   `MODELS`:æœ€å¤§å‹å·åç§°ï¼Œå¦‚`max-facial-emotion-classifier`
    *   `USERNAME`:åç«™æ¢çº½ç”¨æˆ·åã€‚

```
MODELS="..." USERNAME="..." ./build.sh 
```

è¿™å°†ä½¿ç”¨ MAX æ¨¡å‹åç§°åœ¨æœ¬åœ°åˆ›å»º Docker æ˜ åƒï¼Œå¹¶å°†å…¶æ¨é€åˆ° Docker Hubï¼Œä»¥ä¾¿åœ¨ IBM Cloud å‡½æ•°ä¸­ä½¿ç”¨ã€‚ **IBM Cloud Functions åªæ”¯æŒå…¬å…± Docker æ˜ åƒä½œä¸ºå®šåˆ¶è¿è¡Œæ—¶ã€‚**

### [](#create-actions-using-custom-runtimes)ä½¿ç”¨è‡ªå®šä¹‰è¿è¡Œæ—¶åˆ›å»ºåŠ¨ä½œ

*   ä½¿ç”¨[è‡ªå®šä¹‰ Docker è¿è¡Œæ—¶](https://github.com/apache/incubator-openwhisk/blob/master/docs/actions-docker.md)åˆ›å»ºä¸€ä¸ª Web åŠ¨ä½œã€‚

```
ibmcloud wsk action create <MODEL_IMAGE> --docker <DOCKERHUB_NAME>/<MODEL_IMAGE> --web true -m 512 
```

*   æ£€ç´¢ Web æ“ä½œ URL ( `https://<REGION>.functions.cloud.ibm.com/api/v1/web/<NS>/default/<ACTION>`)

```
ibmcloud wsk action get <MODEL_IMAGE> --url 
```

### [](#invoke-web-action-url-with-prediction-api-parameters)ç”¨é¢„æµ‹ api å‚æ•°è°ƒç”¨ web åŠ¨ä½œ url

å¯¹ Web æ“ä½œ URL ä½¿ç”¨é¢„æµ‹ API è§„èŒƒä¸­å®šä¹‰çš„ç›¸åŒ API è¯·æ±‚å‚æ•°ã€‚è¿™å°†è°ƒç”¨æ¨¡å‹é¢„æµ‹å¹¶å°†ç»“æœä½œä¸º HTTP å“åº”è¿”å›ï¼Œä¾‹å¦‚

```
curl -F "image=@assets/happy-baby.jpeg" -XPOST <WEB_ACTION_URL> 
```

*æ³¨æ„:åˆ›å»ºåŠ¨ä½œåçš„ç¬¬ä¸€æ¬¡è°ƒç”¨å¯èƒ½ä¼šå¯¼è‡´é•¿æ—¶é—´çš„å†·å¯åŠ¨å»¶è¿Ÿï¼Œå› ä¸ºå¹³å°ä¼šå°†è¿œç¨‹æ˜ åƒæ‹‰å…¥æœ¬åœ°æ³¨å†Œè¡¨ã€‚ä¸€æ—¦æ˜ åƒåœ¨å¹³å°ä¸­å¯ç”¨ï¼Œè¿›ä¸€æ­¥çš„å†·è°ƒç”¨å’Œçƒ­è°ƒç”¨éƒ½ä¼šå¿«å¾—å¤šã€‚*

## [](#example)ä¸¾ä¾‹

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨`max-facial-emotion-classifier` [MAX æ¨¡å‹](https://developer.ibm.com/exchanges/models/all/max-facial-emotion-classifier/)åˆ›å»ºæ— æœåŠ¡å™¨ API çš„ä¾‹å­ã€‚å·²ç»æµ‹è¯•è¿‡çš„æ¨¡å‹çš„æ›´å¤šä¾‹å­å¯åœ¨[è¿™é‡Œ](https://github.com/jthomas/serverless-max-models/blob/master/README.md#models)æ‰¾åˆ°ã€‚å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·[åœ¨ Github ä¸Šå¼€ä¸€æœŸ](https://github.com/jthomas/serverless-max-models/issues)ã€‚

### max-é¢éƒ¨-æƒ…æ„Ÿ-åˆ†ç±»å™¨

*   [é¢éƒ¨æƒ…æ„Ÿåˆ†ç±»å™¨(`max-facial-emotion-classifier` )](https://developer.ibm.com/exchanges/models/all/max-facial-emotion-classifier/)

é¦–å…ˆä½¿ç”¨è‡ªå®šä¹‰è¿è¡Œæ—¶åˆ›å»ºæ“ä½œï¼Œç„¶åæ£€ç´¢ Web æ“ä½œ URLã€‚

```
$ ibmcloud wsk action create max-facial-emotion-classifier --docker <DOCKERHUB_NAME>/max-facial-emotion-classifier --web true -m 512
ok: created action max-facial-emotion-classifier
$ ibmcloud wsk action get max-facial-emotion-classifier --url
ok: got action max-facial-emotion-classifier
https://<REGION>.functions.cloud.ibm.com/api/v1/web/<NS>/default/max-facial-emotion-classifier 
```

æ ¹æ®è¯¥æ¨¡å‹çš„ [API å®šä¹‰](http://max-facial-emotion-classifier.max.us-south.containers.appdomain.cloud/)ï¼Œé¢„æµ‹ API æœŸæœ›ä¸€ä¸ªå¸¦æœ‰å›¾åƒæ–‡ä»¶çš„è¡¨å•æäº¤è¿›è¡Œåˆ†ç±»ã€‚ä½¿ç”¨æ¥è‡ªæ¨¡å‹æŠ¥å‘Šçš„[æ ·æœ¬å›¾åƒ](https://github.com/IBM/MAX-Facial-Emotion-Classifier/blob/master/assets/happy-baby.jpeg)ï¼Œå¯ä»¥ä½¿ç”¨ curl æµ‹è¯•è¯¥æ¨¡å‹ã€‚

```
$ curl -F "image=@happy-baby.jpeg" -XPOST https://<REGION>.functions.cloud.ibm.com/api/v1/web/<NS>/default/max-facial-emotion-classifier 
```

```
{  "status":  "ok",  "predictions":  [  {  "detection_box":  [  0.15102639296187684,  0.3828125,  0.5293255131964809,  0.5830078125  ],  "emotion_predictions":  [  {  "label_id":  "1",  "label":  "happiness",  "probability":  0.9860254526138306  },  ...  ]  }  ]  } 
```

#### [](#performance)è¡¨ç°

*ç¤ºä¾‹è°ƒç”¨æŒç»­æ—¶é—´(å†·):* ~4.8 ç§’

*ç¤ºä¾‹è°ƒç”¨æŒç»­æ—¶é—´(çƒ­):* ~ 800 æ¯«ç§’

## [](#how-does-this-work)è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ

### [](#background)èƒŒæ™¯

ç”±äºä»¥ä¸‹åŸå› ï¼Œä½¿ç”¨æ¥è‡ªæ— æœåŠ¡å™¨åŠŸèƒ½çš„é¢„è®­ç»ƒæ¨¡å‹è¿è¡Œæœºå™¨å­¦ä¹ åˆ†ç±»åœ¨å†å²ä¸Šä¸€ç›´å…·æœ‰æŒ‘æˆ˜æ€§â€¦

> å¼€å‘äººå‘˜æ— æ³•æ§åˆ¶(å¤§å¤šæ•°)æ— æœåŠ¡å™¨äº‘å¹³å°ä¸­çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚å¿…é¡»åœ¨éƒ¨ç½²åŒ…ä¸­æä¾›å‡½æ•°æ‰€éœ€çš„åº“å’Œä¾èµ–é¡¹ã€‚å¤§å¤šæ•°å¹³å°éƒ½é™åˆ¶éƒ¨ç½²åŒ…çš„å¤§å°(å‹ç¼©åå¤§çº¦ 50MBï¼Œæœªå‹ç¼©æ—¶å¤§çº¦ 250MB)ã€‚

æœºå™¨å­¦ä¹ åº“å’Œæ¨¡å‹å¯ä»¥æ¯”é‚£äº›éƒ¨ç½²å¤§å°é™åˆ¶å¤§å¾—å¤šã€‚è¿™å°†é˜»æ­¢å®ƒä»¬åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­ã€‚åœ¨è°ƒç”¨æœŸé—´åŠ¨æ€åŠ è½½æ–‡ä»¶æ˜¯å¯èƒ½çš„ï¼Œä½†æ˜¯ä¼šå¯¼è‡´æé•¿çš„å†·å¯åŠ¨å»¶è¿Ÿå’Œé¢å¤–çš„æˆæœ¬ã€‚

å¹¸è¿çš„æ˜¯ï¼Œ [IBM Cloud Functions](https://cloud.ibm.com/openwhisk) æ˜¯åŸºäºå¼€æºçš„æ— æœåŠ¡å™¨é¡¹ç›®ï¼Œ [Apache OpenWhisk](http://openwhisk.incubator.apache.org/) ã€‚è¯¥å¹³å°æ”¯æŒä½¿ç”¨[å®šåˆ¶ Docker å›¾åƒ](https://github.com/apache/incubator-openwhisk/blob/master/docs/actions-docker.md)çš„å®šåˆ¶åŠŸèƒ½è¿è¡Œæ—¶ã€‚å› æ­¤ï¼Œå¯ä»¥åœ¨å®šåˆ¶è¿è¡Œæ—¶æä¾›æœºå™¨å­¦ä¹ åº“å’Œæ¨¡å‹ã€‚è¿™æ¶ˆé™¤äº†å°†å®ƒä»¬åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­æˆ–åœ¨è¿è¡Œæ—¶åŠ è½½çš„éœ€è¦ã€‚

*æœ‰å…´è¶£é˜…è¯»å…¶ä»–å…³äºä½¿ç”¨å…·æœ‰ IBM äº‘åŠŸèƒ½çš„æœºå™¨å­¦ä¹ åº“å’Œå·¥å…·åŒ…çš„åšæ–‡å—ï¼Ÿ[æ›´å¤šè¯¦æƒ…](http://jamesthom.as/blog/2018/08/13/serverless-machine-learning-with-tensorflow-dot-js/)è§[è¿™äº›å¸–å­](http://jamesthom.as/blog/2017/08/04/large-applications-on-openwhisk/)ã€‚*

### [](#max-model-images)MAX æ¨¡å‹å›¾ç‰‡

IBM çš„[æ¨¡å‹èµ„äº§äº¤æ¢](https://developer.ibm.com/exchanges/models/all/)å‘å¸ƒæ¯ä¸ªæ¨¡å‹çš„ Docker å›¾åƒï¼Œä»¥åŠé¢„è®­ç»ƒçš„æ¨¡å‹æ–‡ä»¶ã€‚å›¾ç‰‡å±•ç¤ºäº†ä¸€ä¸ªç”¨äºé¢„æµ‹çš„[HTTP API](https://github.com/IBM/MAX-Text-Sentiment-Classifier#3-use-the-model)ï¼Œä½¿ç”¨ Python å’Œ Flask æ„å»ºçš„ç«¯å£ 5000 ä¸Šçš„æ¨¡å‹ã€‚[API çš„ Swagger æ–‡ä»¶](http://max-text-sentiment-classifier.max.us-south.containers.appdomain.cloud/)æè¿°äº†å¯ç”¨çš„æ“ä½œã€è¾“å…¥å‚æ•°å’Œå“åº”ä½“ã€‚

è¿™äº›å›¾åƒä½¿ç”¨åŸºäº Flask çš„å®šåˆ¶åº”ç”¨ç¨‹åºæ¡†æ¶( [maxfw](https://pypi.org/project/maxfw/) )æ¥æ ‡å‡†åŒ–å°† MAX æ¨¡å‹å…¬å¼€ä¸º HTTP APIsã€‚è¿™ä¸ªæ¡†æ¶å¤„ç†è¾“å…¥å‚æ•°éªŒè¯ã€å“åº”ç¼–ç»„ã€CORS æ”¯æŒç­‰ã€‚è¿™å…è®¸æ¨¡å‹è¿è¡Œæ—¶åªå®ç°é¢„æµ‹ API å¤„ç†ç¨‹åºï¼Œè€Œä¸æ˜¯æ•´ä¸ª HTTP åº”ç”¨ç¨‹åºã€‚

ç”±äºæ¡†æ¶å·²ç»å°†æ¨¡å‹å…¬å¼€ä¸º HTTP APIï¼Œæˆ‘å¼€å§‹å¯»æ‰¾ä¸€ç§æ–¹æ³•æ¥æ¨¡æ‹Ÿè¿›å…¥æ¡†æ¶çš„å¤–éƒ¨ HTTP è¯·æ±‚ã€‚å¦‚æœå¯èƒ½çš„è¯ï¼Œæˆ‘å¯ä»¥ä» Python Web æ“ä½œä¸­è§¦å‘è¿™ä¸ªå‡è¯·æ±‚ï¼Œæ ¹æ®è¾“å…¥å‚æ•°æ‰§è¡Œæ¨¡å‹åˆ†ç±»ã€‚ç„¶åï¼ŒWeb æ“ä½œä¼šå°†è¿”å›çš„ HTTP å“åº”è½¬æ¢ä¸ºæœ‰æ•ˆçš„ Web æ“ä½œå“åº”å‚æ•°ã€‚

### [](#flask-test-client)çƒ§ç“¶æµ‹è¯•å®¢æˆ·ç«¯

é€šè¯»çƒ§ç“¶[æ–‡æ¡£](http://flask.pocoo.org/docs/1.0/testing/)ï¼Œæˆ‘å‘ç°äº†å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼ğŸ‘ğŸ‘ğŸ‘

> Flask é€šè¿‡å…¬å¼€ Werkzeug æµ‹è¯•å®¢æˆ·ç«¯å¹¶ä¸ºæ‚¨å¤„ç†ä¸Šä¸‹æ–‡å±€éƒ¨å˜é‡ï¼Œæä¾›äº†ä¸€ç§æµ‹è¯•åº”ç”¨ç¨‹åºçš„æ–¹æ³•ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥å°†å®ƒç”¨äºæ‚¨æœ€å–œæ¬¢çš„æµ‹è¯•è§£å†³æ–¹æ¡ˆã€‚

è¿™å…è®¸åº”ç”¨ç¨‹åºè·¯ç”±é€šè¿‡[æµ‹è¯•å®¢æˆ·ç«¯](https://werkzeug.palletsprojects.com/en/0.15.x/test/#werkzeug.test.Client)æ¥æ‰§è¡Œï¼Œè€Œä¸éœ€è¦å®é™…è¿è¡Œ HTTP æœåŠ¡å™¨ã€‚

```
max_app = MAXApp(API_TITLE, API_DESC, API_VERSION)
max_app.add_api(ModelPredictAPI, '/predict')
test_client = max_app.app.test_client()
r = test_client.post('/model/predict', data=content, headers=headers) 
```

åœ¨æ— æœåŠ¡å™¨ Python å‡½æ•°ä¸­ä½¿ç”¨æ­¤ä»£ç å…è®¸å‡½æ•°è°ƒç”¨è§¦å‘é¢„æµ‹ APIã€‚æ— æœåŠ¡å™¨å‡½æ•°åªéœ€å°†è¾“å…¥å‚æ•°è½¬æ¢æˆå‡çš„ HTTP è¯·æ±‚ï¼Œç„¶åå°†å“åº”åºåˆ—åŒ–å› JSONã€‚

### [](#python-docker-action)python docker åŠ¨ä½œ

å®šåˆ¶çš„ MAX æ¨¡å‹è¿è¡Œæ—¶æ˜ åƒéœ€è¦å®ç° Apache OpenWhisk æœŸæœ›çš„ T2 HTTP APIã€‚è¿™ä¸ª API ç”¨äºå®ä¾‹åŒ–è¿è¡Œæ—¶ç¯å¢ƒï¼Œç„¶ååœ¨æ¯ä¸ªè¯·æ±‚ä¸­ä¼ é€’è°ƒç”¨å‚æ•°ã€‚ç”±äºè¿è¡Œæ—¶æ˜ åƒåŒ…å«å¤„ç†è¯·æ±‚æ‰€éœ€çš„æ‰€æœ‰æ–‡ä»¶å’Œä»£ç ï¼Œ`/init`å¤„ç†ç¨‹åºå˜æˆäº†[çš„ç©ºæ“ä½œ](https://english.stackexchange.com/questions/25993/what-does-no-op-mean)ã€‚`/run`å¤„ç†å™¨å°† [Web åŠ¨ä½œ HTTP å‚æ•°](https://github.com/apache/incubator-openwhisk/blob/master/docs/webactions.md#http-context)è½¬æ¢æˆå‡çš„ HTTP è¯·æ±‚ã€‚

ä¸‹é¢æ˜¯ç”¨äºå°†ä¼ å…¥çš„ Web æ“ä½œè¯·æ±‚ä»£ç†åˆ°æ¡†æ¶æ¨¡å‹æœåŠ¡çš„ Python è„šæœ¬ã€‚

```
from maxfw.core import MAXApp
from api import ModelPredictAPI
from config import API_TITLE, API_DESC, API_VERSION
import json
import base64
from flask import Flask, request, Response

max_app = MAXApp(API_TITLE, API_DESC, API_VERSION)
max_app.add_api(ModelPredictAPI, '/predict')

# Use flask test client to simulate HTTP requests for the prediction APIs
# HTTP request data will come from action invocation parameters, neat huh? :) test_client = max_app.app.test_client()
app = Flask(__name__)

# This implements the Docker runtime API used by Apache OpenWhisk
# https://github.com/apache/incubator-openwhisk/blob/master/docs/actions-docker.md
# /init is a no-op as everything is provided in the image. @app.route("/init", methods=['POST'])
def init():
    return ''

# Action invocation requests will be received as the `value` parameter in request body.
# Web Actions provide HTTP request parameters as `__ow_headers` & `__ow_body` parameters. @app.route("/run", methods=['POST'])
def run():
    body = request.json
    form_body = body['value']['__ow_body']
    headers = body['value']['__ow_headers']

    # binary image content provided as base64 strings
    content = base64.b64decode(form_body)

    # send fake HTTP request to prediction API with invocation data
    r = test_client.post('/model/predict', data=content, headers=headers)
    r_headers = dict((x, y) for x, y in r.headers)

    # binary data must be encoded as base64 strings to return in JSON response
    is_image = r_headers['Content-Type'].startswith('image')
    r_data = base64.b64encode(r.data) if is_image else r.data
    body = r_data.decode("utf-8")

    response = {'headers': r_headers, 'status': r.status_code, 'body': body }
    print (r.status)
    return Response(json.dumps(response), status=200, mimetype='application/json')

app.run(host='0.0.0.0', port=8080) 
```

### [](#building-into-an-image)å»ºç­‘æˆå›¾åƒ

ç”±äº MAX æ¨¡å‹å·²ç»ä½œä¸ºå…¬å…± Docker æ˜ åƒå­˜åœ¨ï¼Œå› æ­¤åœ¨æ„å»ºå®šåˆ¶è¿è¡Œæ—¶æ—¶ï¼Œè¿™äº›æ˜ åƒå¯ä»¥ç”¨ä½œåŸºç¡€æ˜ åƒã€‚è¿™äº›åŸºç¡€æ˜ åƒå¤„ç†æ·»åŠ æ¨¡å‹æ–‡ä»¶ä»¥åŠå°†å®ƒä»¬æ‰§è¡Œåˆ°æ˜ åƒä¸­æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–å…³ç³»ã€‚

è¿™æ˜¯æ„å»ºè„šæœ¬ç”¨æ¥åˆ›å»ºå®šåˆ¶æ¨¡å‹æ˜ åƒçš„`Dockerfile`ã€‚`model`å‚æ•°æ˜¯æŒ‡åŒ…å«æ¨¡å‹åç§°çš„æ„å»ºå‚æ•°ã€‚

```
ARG model
FROM codait/${model}:latest

ADD openwhisk.py .

EXPOSE 8080

CMD python openwhisk.py 
```

ç„¶ååœ¨ä¸‹é¢çš„æ„å»ºè„šæœ¬ä¸­ä½¿ç”¨å®ƒæ¥ä¸ºæ¨¡å‹åˆ›å»ºä¸€ä¸ªå®šåˆ¶çš„è¿è¡Œæ—¶æ˜ åƒã€‚

```
#!/bin/bash

set -e -u

for model in $MODELS; do echo "Building $model runtime image"
  docker build -t $model --build-arg model=$model .
  echo "Pushing $model to Docker Hub"
  docker tag $model $USERNAME/$model
  docker push $USERNAME/$model
done 
```

ä¸€æ—¦å›¾åƒå‘å¸ƒåˆ° Docker Hubï¼Œå°±å¯ä»¥åœ¨åˆ›å»ºæ–°çš„ Web åŠ¨ä½œæ—¶å¼•ç”¨å®ƒ(ä½¿ç”¨`â€”docker`å‚æ•°)ã€‚ğŸ˜

```
ibmcloud wsk action create <MODEL_IMAGE> --docker <DOCKERHUB_NAME>/<MODEL_IMAGE> --web true -m 512 
```

## [](#conclusion)ç»“è®º

IBM çš„æ¨¡å‹èµ„äº§äº¤æ¢æ˜¯æœºå™¨å­¦ä¹ æ¨¡å‹çš„ç²¾é€‰é›†åˆï¼Œå¯ä»¥éƒ¨ç½²åˆ°äº‘ä¸Šæ‰§è¡Œå„ç§ä»»åŠ¡ã€‚æ‰€æœ‰å‹å·éƒ½æœ‰ä¸€ç³»åˆ—å…¬å¼€çš„ Docker å›¾ç‰‡ã€‚æ¨¡å‹å›¾åƒè‡ªåŠ¨å…¬å¼€ç”¨äºåˆ†ç±»çš„ HTTP APIsã€‚

æ¨¡å‹åº“ä¸­çš„æ–‡æ¡£è§£é‡Šäº†å¦‚ä½•åœ¨æœ¬åœ°è¿è¡Œå®ƒä»¬ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ Kubernetes è¿›è¡Œéƒ¨ç½²ï¼Œä½†æ˜¯å¦‚ä½•åœ¨æ— æœåŠ¡å™¨çš„äº‘å¹³å°ä¸Šä½¿ç”¨å‘¢ï¼Ÿç”±äºæ°´å¹³å¯æ‰©å±•æ€§å’Œæˆæœ¬ä¼˜åŠ¿ï¼Œæ— æœåŠ¡å™¨å¹³å°æ­£æˆä¸ºéƒ¨ç½²æœºå™¨å­¦ä¹ æ¨¡å‹çš„æµè¡Œé€‰æ‹©ã€‚

é€šè¿‡æŸ¥çœ‹æ¨¡å‹å›¾åƒçš„æºä»£ç ï¼Œæˆ‘å‘ç°äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥è¿æ¥åˆ°ç”¨äºå°†æ¨¡å‹æ–‡ä»¶å¯¼å‡ºä¸º HTTP APIs çš„å®šåˆ¶æ¨¡å‹æ¡†æ¶ã€‚è¿™å…è®¸æˆ‘ç¼–å†™ä¸€ä¸ªç®€å•çš„åŒ…è£…å™¨è„šæœ¬æ¥ä»£ç†å¯¹æ¨¡å‹é¢„æµ‹ API çš„æ— æœåŠ¡å™¨å‡½æ•°è°ƒç”¨ã€‚API å“åº”å°†è¢«åºåˆ—åŒ–ä¸º Web åŠ¨ä½œå“åº”æ ¼å¼ã€‚

å°†è¿™ä¸ªè„šæœ¬æ„å»ºåˆ°ä¸€ä¸ªæ–°çš„ Docker æ˜ åƒä¸­ï¼Œä½¿ç”¨ç°æœ‰çš„æ¨¡å‹æ˜ åƒä½œä¸ºåŸºç¡€æ˜ åƒï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¯ä»¥åœ¨å¹³å°ä¸Šä½¿ç”¨çš„æ–°çš„è¿è¡Œæ—¶ã€‚ä»è¿™ä¸ªè¿è¡Œæ—¶æ˜ åƒåˆ›å»ºçš„ Web åŠ¨ä½œå°†è‡ªåŠ¨å…¬å¼€ä¸ç°æœ‰æ˜ åƒç›¸åŒçš„ HTTP APIsï¼