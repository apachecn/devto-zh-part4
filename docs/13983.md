# WebGL æœˆä»½ã€‚ç¬¬ 11 å¤©ã€‚å‡å°‘ WebGL æ ·æ¿æ–‡ä»¶

> åŸæ–‡:[https://dev.to/lesnitsky/webgl-month-day-11-3plb](https://dev.to/lesnitsky/webgl-month-day-11-3plb)

## [](#reducing-boilerplate)å‡å°‘æ ·æ¿æ–‡ä»¶

è¿™æ˜¯ä¸€ç³»åˆ—ä¸ WebGL ç›¸å…³çš„åšæ–‡ã€‚æ¯å¤©éƒ½ä¼šæœ‰æ–°å¸–å­

[![GitHub stars](../Images/4b13c63f7749e880ea0101298458fa81.png)](https://github.com/lesnitsky/webgl-month)
[![Twitter Follow](../Images/4c84b80da3e55d8a5b832827716e270f.png)T6ã€‘](https://twitter.com/lesnitsky_a)

[åŠ å…¥é‚®ä»¶åˆ—è¡¨](http://eepurl.com/gwiSeH),è®©æ–°é‚®ä»¶ç›´æ¥è¿›å…¥ä½ çš„æ”¶ä»¶ç®±

[æ­¤å¤„æä¾›æºä»£ç ](https://github.com/lesnitsky/webgl-month)

å»ºé€ äº

[![Git Tutor Logo](../Images/4a5fcbd1126401b65ca7fbe362404aa0.png)T2ã€‘](https://github.com/lesnitsky/git-tutor)

æ˜¨å¤©æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨å¤šç§çº¹ç†ã€‚è¿™éœ€è¦ä¿®æ”¹ç€è‰²å™¨ï¼Œä»¥åŠ javascriptï¼Œä½†è¿™ç§å˜åŒ–å¯èƒ½ä¼šéƒ¨åˆ†è‡ªåŠ¨å®Œæˆ

æœ‰ä¸€ä¸ªåŒ… [glsl-extract-sync](https://www.npmjs.com/package/glsl-extract-sync) å¯ä»¥è·å¾—å…³äºç€è‰²å™¨å±æ€§å’Œåˆ¶æœçš„ä¿¡æ¯

ç”¨
å®‰è£…è¿™ä¸ªåŒ…

```
npm i glsl-extract-sync 
```

ğŸ“„package.json

```
 "url-loader": "^2.0.1",
      "webpack": "^4.35.2",
      "webpack-cli": "^3.3.5"
+   },
+   "dependencies": {
+     "glsl-extract-sync": "0.0.0"
    }
  } 
```

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŠ©æ‰‹å‡½æ•°ï¼Œå®ƒå°†åœ¨è¿™ä¸ªåŒ…çš„å¸®åŠ©ä¸‹è·å–æ‰€æœ‰å¯¹å±æ€§å’Œç»Ÿä¸€çš„å¼•ç”¨

ğŸ“„src/gl-helpers.js

```
+ import extract from 'glsl-extract-sync';
+ 
  export function compileShader(gl, shader, source) {
      gl.shaderSource(shader, source);
      gl.compileShader(shader);
          img,
      );
  }
+ 
+ export function setupShaderInput(gl, program, vShaderSource, fShaderSource) {
+ 
+ } 
```

æˆ‘ä»¬éœ€è¦æå–å…³äºé¡¶ç‚¹å’Œç‰‡æ®µç€è‰²å™¨çš„ä¿¡æ¯

ğŸ“„src/gl-helpers.js

```
 }

  export function setupShaderInput(gl, program, vShaderSource, fShaderSource) {
- +     const vShaderInfo = extract(vShaderSource);
+     const fShaderInfo = extract(fShaderSource);
  } 
```

ğŸ“„src/texture.js

```
 import vShaderSource from './shaders/texture.v.glsl';
  import fShaderSource from './shaders/texture.f.glsl';
- import { compileShader, loadImage, createTexture, setImage } from './gl-helpers'; + import { compileShader, loadImage, createTexture, setImage, setupShaderInput } from './gl-helpers';
  import { createRect } from './shape-helpers';

  import textureImageSrc from '../assets/images/texture.jpg';
  gl.bindBuffer(gl.ARRAY_BUFFER, vertexPositionBuffer);
  gl.bufferData(gl.ARRAY_BUFFER, vertexPosition, gl.STATIC_DRAW);

+ console.log(setupShaderInput(gl, program, vShaderSource, fShaderSource));
+ 
  const attributeLocations = {
      position: gl.getAttribLocation(program, 'position'),
      texCoord: gl.getAttribLocation(program, 'texCoord'), 
```

åªæœ‰é¡¶ç‚¹ç€è‰²å™¨å¯èƒ½æœ‰å±æ€§ï¼Œä½†ç»Ÿä¸€å¯ä»¥åœ¨ä¸¤ä¸ªç€è‰²å™¨ä¸­å®šä¹‰

ğŸ“„src/gl-helpers.js

```
 export function setupShaderInput(gl, program, vShaderSource, fShaderSource) {
      const vShaderInfo = extract(vShaderSource);
      const fShaderInfo = extract(fShaderSource);
+ 
+     const attributes = vShaderInfo.attributes;
+     const uniforms = [
+         ...vShaderInfo.uniforms,
+         ...fShaderInfo.uniforms,
+     ];
  } 
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„å±æ€§ä½ç½®

ğŸ“„src/gl-helpers.js

```
 ...vShaderInfo.uniforms,
          ...fShaderInfo.uniforms,
      ];
+ 
+     const attributeLocations = attributes.reduce((attrsMap, attr) => {
+         attrsMap[attr.name] = gl.getAttribLocation(program, attr.name);
+         return attrsMap;
+     }, {});
  } 
```

å¹¶å¯ç”¨æ‰€æœ‰å±æ€§

ğŸ“„src/gl-helpers.js

```
 attrsMap[attr.name] = gl.getAttribLocation(program, attr.name);
          return attrsMap;
      }, {});
+ 
+     attributes.forEach((attr) => {
+         gl.enableVertexAttribArray(attributeLocations[attr.name]);
+     });
  } 
```

æˆ‘ä»¬è¿˜åº”è¯¥å¾—åˆ°æ‰€æœ‰ç»Ÿä¸€çš„ä½ç½®

ğŸ“„src/gl-helpers.js

```
 attributes.forEach((attr) => {
          gl.enableVertexAttribArray(attributeLocations[attr.name]);
      });
+ 
+     const uniformLocations = uniforms.reduce((uniformsMap, uniform) => {
+         uniformsMap[uniform.name] = gl.getUniformLocation(program, uniform.name);
+         return uniformsMap;
+     }, {});
  } 
```

æœ€åè¿”å›å±æ€§å’Œç»Ÿä¸€ä½ç½®

ğŸ“„src/gl-helpers.js

```
 uniformsMap[uniform.name] = gl.getUniformLocation(program, uniform.name);
          return uniformsMap;
      }, {});
+ 
+     return {
+         attributeLocations,
+         uniformLocations,
+     }
  } 
```

å¥½äº†ï¼Œè®©æˆ‘ä»¬åˆ©ç”¨ä¸€ä¸‹æˆ‘ä»¬æ–°çš„ç”œèœœåŠ©æ‰‹

ğŸ“„src/texture.js

```
 gl.bindBuffer(gl.ARRAY_BUFFER, vertexPositionBuffer);
  gl.bufferData(gl.ARRAY_BUFFER, vertexPosition, gl.STATIC_DRAW);

- console.log(setupShaderInput(gl, program, vShaderSource, fShaderSource));
+ const programInfo = setupShaderInput(gl, program, vShaderSource, fShaderSource); 
- const attributeLocations = {
-     position: gl.getAttribLocation(program, 'position'),
-     texCoord: gl.getAttribLocation(program, 'texCoord'),
-     texIndex: gl.getAttribLocation(program, 'texIndex'),
- };
- 
- const uniformLocations = {
-     texture: gl.getUniformLocation(program, 'texture'),
-     otherTexture: gl.getUniformLocation(program, 'otherTexture'),
-     resolution: gl.getUniformLocation(program, 'resolution'),
- };
- 
- gl.enableVertexAttribArray(attributeLocations.position);
- gl.vertexAttribPointer(attributeLocations.position, 2, gl.FLOAT, false, 0, 0); + gl.vertexAttribPointer(programInfo.attributeLocations.position, 2, gl.FLOAT, false, 0, 0); 
  gl.bindBuffer(gl.ARRAY_BUFFER, texCoordsBuffer);
- 
- gl.enableVertexAttribArray(attributeLocations.texCoord);
- gl.vertexAttribPointer(attributeLocations.texCoord, 2, gl.FLOAT, false, 0, 0); + gl.vertexAttribPointer(programInfo.attributeLocations.texCoord, 2, gl.FLOAT, false, 0, 0); 
  gl.bindBuffer(gl.ARRAY_BUFFER, texIndiciesBuffer);
- 
- gl.enableVertexAttribArray(attributeLocations.texIndex);
- gl.vertexAttribPointer(attributeLocations.texIndex, 1, gl.FLOAT, false, 0, 0); + gl.vertexAttribPointer(programInfo.attributeLocations.texIndex, 1, gl.FLOAT, false, 0, 0); 
  const vertexIndices = new Uint8Array([
      // left rect

      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, texture);
-     gl.uniform1i(uniformLocations.texture, 0); +     gl.uniform1i(programInfo.uniformLocations.texture, 0); 
      gl.activeTexture(gl.TEXTURE1);
      gl.bindTexture(gl.TEXTURE_2D, otherTexture);
-     gl.uniform1i(uniformLocations.otherTexture, 1); +     gl.uniform1i(programInfo.uniformLocations.otherTexture, 1); 
-     gl.uniform2fv(uniformLocations.resolution, [canvas.width, canvas.height]);
+     gl.uniform2fv(programInfo.uniformLocations.resolution, [canvas.width, canvas.height]); 
      gl.drawElements(gl.TRIANGLES, vertexIndices.length, gl.UNSIGNED_BYTE, 0);
  }); 
```

çœ‹èµ·æ¥å¾ˆåƒæ¸…ç†ğŸ˜

æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„å¦ä¸€ä¸ªä¸œè¥¿æ˜¯ç¼“å†²å™¨ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŠ©æ‰‹ç±»

ğŸ“„src/glbuffer . js

```
export class GLBuffer {
    constructor(gl, target, data) {

    }
} 
```

æˆ‘ä»¬éœ€è¦æ•°æ®ã€ç¼“å†²åŒºç›®æ ‡å’Œå®é™…çš„ gl ç¼“å†²åŒºï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ†é…ä»å¤–éƒ¨ä¼ æ¥çš„æ‰€æœ‰æ•°æ®å¹¶åˆ›å»ºä¸€ä¸ª gl ç¼“å†²åŒºã€‚

ğŸ“„src/glbuffer . js

```
 export class GLBuffer {
      constructor(gl, target, data) {
- +         this.target = target;
+         this.data = data;
+         this.glBuffer = gl.createBuffer();
      }
  } 
```

æˆ‘ä»¬æ²¡æœ‰ç»™å®ä¾‹åˆ†é…ä¸€ä¸ª`gl`,å› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä»å¤–éƒ¨ä¼ é€’å®ƒ

è®©æˆ‘ä»¬å®ç°ä¸€ä¸ª`gl.bindBuffer`çš„æ›¿ä»£æ–¹æ¡ˆ

ğŸ“„src/glbuffer . js

```
 this.data = data;
          this.glBuffer = gl.createBuffer();
      }
+ 
+     bind(gl) {
+         gl.bindBuffer(this.target, this.glBuffer);
+     }
  } 
```

ä¹Ÿæ˜¯è®¾ç½®ç¼“å†²åŒºæ•°æ®çš„ä¸€ç§ä¾¿æ·æ–¹å¼

ğŸ“„src/glbuffer . js

```
 bind(gl) {
          gl.bindBuffer(this.target, this.glBuffer);
      }
+ 
+     setData(gl, data, usage) {
+         this.data = data;
+         this.bind(gl);
+         gl.bufferData(this.target, this.data, usage);
+     }
  } 
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ„é€ å‡½æ•°çš„`data`å‚æ•°ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª`usage`å‚æ•°ï¼Œä»¥ä¾¿èƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªæ„é€ å‡½æ•°è°ƒç”¨å®Œæˆæˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰äº‹æƒ…

ğŸ“„src/glbuffer . js

```
 export class GLBuffer {
-     constructor(gl, target, data) { +     constructor(gl, target, data, usage) {
          this.target = target;
          this.data = data;
          this.glBuffer = gl.createBuffer();
+ 
+         if (typeof data !== 'undefined') {
+             this.setData(gl, data, usage);
+         }
      }

      bind(gl) { 
```

é…·ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨æˆ‘ä»¬çš„ç˜¦åŒ…è£…å™¨æ›¿æ¢ texCoords ç¼“å†²åŒºäº†

ğŸ“„src/texture.js

```
 import textureImageSrc from '../assets/images/texture.jpg';
  import textureGreenImageSrc from '../assets/images/texture-green.jpg';
+ import { GLBuffer } from './GLBuffer'; 
  const canvas = document.querySelector('canvas');
  const gl = canvas.getContext('webgl');
  gl.linkProgram(program);
  gl.useProgram(program);

- const texCoords = new Float32Array([
+ const texCoordsBuffer = new GLBuffer(gl, gl.ARRAY_BUFFER, new Float32Array([
      ...createRect(0, 0, 1, 1), // left rect
      ...createRect(0, 0, 1, 1), // right rect
- ]);
- const texCoordsBuffer = gl.createBuffer();
- 
- gl.bindBuffer(gl.ARRAY_BUFFER, texCoordsBuffer);
- gl.bufferData(gl.ARRAY_BUFFER, texCoords, gl.STATIC_DRAW); + ]), gl.STATIC_DRAW); 
  const texIndicies = new Float32Array([
      ...Array.from({ length: 4 }).fill(0), // left rect

  gl.vertexAttribPointer(programInfo.attributeLocations.position, 2, gl.FLOAT, false, 0, 0);

- gl.bindBuffer(gl.ARRAY_BUFFER, texCoordsBuffer);
+ texCoordsBuffer.bind(gl);
  gl.vertexAttribPointer(programInfo.attributeLocations.texCoord, 2, gl.FLOAT, false, 0, 0);

  gl.bindBuffer(gl.ARRAY_BUFFER, texIndiciesBuffer); 
```

å¯¹çº¹ç†ç´¢å¼•ç¼“å†²åŒºè¿›è¡ŒåŒæ ·çš„æ“ä½œ

ğŸ“„src/texture.js

```
 ...createRect(0, 0, 1, 1), // right rect
  ]), gl.STATIC_DRAW);

- const texIndicies = new Float32Array([
+ const texIndiciesBuffer = new GLBuffer(gl, gl.ARRAY_BUFFER, new Float32Array([
      ...Array.from({ length: 4 }).fill(0), // left rect
      ...Array.from({ length: 4 }).fill(1), // right rect
- ]);
- const texIndiciesBuffer = gl.createBuffer();
- 
- gl.bindBuffer(gl.ARRAY_BUFFER, texIndiciesBuffer);
- gl.bufferData(gl.ARRAY_BUFFER, texIndicies, gl.STATIC_DRAW); + ]), gl.STATIC_DRAW); 
  const vertexPosition = new Float32Array([
      ...createRect(-1, -1, 1, 2), // left rect
  texCoordsBuffer.bind(gl);
  gl.vertexAttribPointer(programInfo.attributeLocations.texCoord, 2, gl.FLOAT, false, 0, 0);

- gl.bindBuffer(gl.ARRAY_BUFFER, texIndiciesBuffer);
+ texIndiciesBuffer.bind(gl);
  gl.vertexAttribPointer(programInfo.attributeLocations.texIndex, 1, gl.FLOAT, false, 0, 0);

  const vertexIndices = new Uint8Array([ 
```

é¡¶ç‚¹ä½ç½®

ğŸ“„src/texture.js

```
 ...Array.from({ length: 4 }).fill(1), // right rect
  ]), gl.STATIC_DRAW);

- const vertexPosition = new Float32Array([
+ const vertexPositionBuffer = new GLBuffer(gl, gl.ARRAY_BUFFER, new Float32Array([
      ...createRect(-1, -1, 1, 2), // left rect
      ...createRect(-1, 0, 1, 2), // right rect
- ]);
- const vertexPositionBuffer = gl.createBuffer(); + ]), gl.STATIC_DRAW); 
- gl.bindBuffer(gl.ARRAY_BUFFER, vertexPositionBuffer);
- gl.bufferData(gl.ARRAY_BUFFER, vertexPosition, gl.STATIC_DRAW); 
  const programInfo = setupShaderInput(gl, program, vShaderSource, fShaderSource);

+ vertexPositionBuffer.bind(gl);
  gl.vertexAttribPointer(programInfo.attributeLocations.position, 2, gl.FLOAT, false, 0, 0);

  texCoordsBuffer.bind(gl); 
```

å’Œç´¢å¼•ç¼“å†²åŒº

ğŸ“„src/texture.js

```
 texIndiciesBuffer.bind(gl);
  gl.vertexAttribPointer(programInfo.attributeLocations.texIndex, 1, gl.FLOAT, false, 0, 0);

- const vertexIndices = new Uint8Array([
+ const indexBuffer = new GLBuffer(gl, gl.ELEMENT_ARRAY_BUFFER, new Uint8Array([
      // left rect
      0, 1, 2, 
      1, 2, 3, 
      // right rect
      4, 5, 6, 
      5, 6, 7,
- ]);
- const indexBuffer = gl.createBuffer();
- 
- gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
- gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, vertexIndices, gl.STATIC_DRAW); + ]), gl.STATIC_DRAW); 
  Promise.all([
      loadImage(textureImageSrc),

      gl.uniform2fv(programInfo.uniformLocations.resolution, [canvas.width, canvas.height]);

-     gl.drawElements(gl.TRIANGLES, vertexIndices.length, gl.UNSIGNED_BYTE, 0);
+     gl.drawElements(gl.TRIANGLES, indexBuffer.data.length, gl.UNSIGNED_BYTE, 0);
  }); 
```

ç°åœ¨æˆ‘ä»¬èƒ½å¤Ÿç”¨æ›´å°‘çš„ä»£ç æ›´é«˜æ•ˆåœ°ä½¿ç”¨ç€è‰²å™¨äº†ï¼

æ˜å¤©è§ğŸ‘‹

* * *

è¿™æ˜¯ä¸€ç³»åˆ—ä¸ WebGL ç›¸å…³çš„åšæ–‡ã€‚æ¯å¤©éƒ½ä¼šæœ‰æ–°å¸–å­

[![GitHub stars](../Images/4b13c63f7749e880ea0101298458fa81.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--fQC8apdT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://img.shields.io/github/stars/lesnitsky/webgl-month.svg%3Fstyle%3Dsocial%26hash%3Dday11)
[![Twitter Follow](../Images/4c84b80da3e55d8a5b832827716e270f.png)T6ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--r9zniMWM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://img.shields.io/twitter/follow/lesnitsky_a.svg%3Flabel%3DFollow%2520me%26style%3Dsocial%26hash%3Dday11)

[åŠ å…¥é‚®ä»¶åˆ—è¡¨](http://eepurl.com/gwiSeH),è®©æ–°é‚®ä»¶ç›´æ¥è¿›å…¥ä½ çš„æ”¶ä»¶ç®±

[æ­¤å¤„æä¾›æºä»£ç ](https://github.com/lesnitsky/webgl-month)

å»ºé€ äº

[![Git Tutor Logo](../Images/4a5fcbd1126401b65ca7fbe362404aa0.png)T2ã€‘](https://github.com/lesnitsky/git-tutor)