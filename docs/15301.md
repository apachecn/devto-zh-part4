# æ³¨æ„ä½ çš„ç´¢å¼•æ’é™¤

> åŸæ–‡ï¼š<https://dev.to/jermdavis/pay-attention-to-your-index-exclusions-4fgb>

æˆ‘æœ€è¿‘é‡åˆ°äº†ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜:ä¸€äº›åœ¨ Sitecore çš„ QA å®ä¾‹ä¸Šè¿è¡Œè‰¯å¥½çš„ä»£ç å·²ç»è¢«éƒ¨ç½²åˆ° UATï¼Œç°åœ¨å´å¤±è´¥äº†ï¼Œå¹¶å‡ºç°ä¸€æ¡å¥‡æ€ªçš„é”™è¯¯æ¶ˆæ¯ã€‚è™½ç„¶è¿™ä¸ªé—®é¢˜å®Œå…¨æ˜¯æˆ‘ä»¬çš„é”™ï¼Œä½†æˆ‘åœ¨è°·æ­Œä¸Šçœ‹åˆ°çš„é”™è¯¯ä¿¡æ¯å¹¶ä¸å¤šï¼Œæ‰€ä»¥æˆ‘ä»Šå¤©è¯•å›¾çº æ­£è¿™ä¸ªé—®é¢˜â€¦

## è¿™ä¸ªé—®é¢˜

æœ‰é—®é¢˜çš„ä»£ç è¿è¡Œåœ¨ Sitecore 7 å®ä¾‹ä¸Šã€‚è¿™ä¸ªé”™è¯¯è½åœ¨äº† UAT èº«ä¸Š:

```
[ArgumentNullException: Value cannot be null.Parameter name: key]
  System.ThrowHelper.ThrowArgumentNullException(ExceptionArgument argument) +49
  System.Collections.Generic.Dictionary`2.FindEntry(TKey key) +14545882
  System.Collections.Generic.Dictionary`2.TryGetValue(TKey key, TValue& value) +20
  Sitecore.ContentSearch.ContentSearchManager.GetIndex(String name) +52
  Sitecore.ContentSearch.ContentSearchManager.CreateSearchContext(IIndexable indexable) +17 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„é”™è¯¯ï¼Œæ‰€ä»¥æˆ‘èŠ±äº†ä¸€äº›æ—¶é—´æ¥è·Ÿè¸ªå®ƒã€‚ä»å †æ ˆè·Ÿè¸ªä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œé—®é¢˜ä¼¼ä¹å‡ºåœ¨å°†ä¸€ä¸ª`IIndexable`ç¿»è¯‘æˆä¸€ä¸ªæœç´¢ä¸Šä¸‹æ–‡ä¸Šï¼Œä½†æ˜¯å®ƒæ²¡æœ‰è¯´ä»»ä½•æœ‰å¸®åŠ©çš„å…³äºä¸ºä»€ä¹ˆâ€¦

åœ¨è¡¨é¢ä¹‹ä¸‹ï¼Œå´©æºƒçš„ä»£ç çœ‹èµ·æ¥åƒ:

```
var root = Sitecore.Context.GetItem("{08D9E0A1-BB72-48FD-AAB2-EFCD6F3B3C92}");
using (var context = ContentSearchManager.CreateSearchContext(new SitecoreIndexableItem(root)))
{
   // run some search queries starting from the "root" item...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## èµ·å› 

é€šè¿‡ä¸æˆ‘çš„è€æœ‹å‹ ILSpy çš„æ·±å…¥æ¢è®¨ï¼Œæˆ‘å‘ç°è¿™é‡ŒæŠ›å‡ºçš„å¼‚å¸¸æ˜¯å› ä¸ºä¸Šé¢çš„`CreateSearchContext()`åšäº†ä¸¤ä»¶äº‹:

```
public static IProviderSearchContext CreateSearchContext(IIndexable indexable)
{ 
  return GetIndex(indexable).CreateSearchContext(SearchSecurityOptions.EnableSecurityCheck);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒå°†`IIndexable`è½¬æ¢æˆè¯¥é¡¹ç›®çš„æœ‰æ•ˆç´¢å¼•ã€‚ç„¶ååœ¨è¯¥ç´¢å¼•ä¸Šåˆ›å»ºä¸€ä¸ªæœç´¢ä¸Šä¸‹æ–‡ã€‚

æŠ›å‡ºå¼‚å¸¸æ˜¯å› ä¸ºç¿»è¯‘è¿”å› nullâ€”â€”è¯¥é¡¹æ²¡æœ‰æ˜ å°„åˆ°ä»»ä½•ç´¢å¼•ã€‚åœ¨è¡¨é¢ä¹‹ä¸‹ï¼Œæœ‰ä¸€ä¸ªç®¡é“è¿è¡Œæ¥å®Œæˆè¿™ç§è½¬æ¢ï¼Œå¹¶è¿­ä»£æ‰€æœ‰å®šä¹‰çš„ç´¢å¼•ã€‚å¹¶ä¾æ¬¡è¯¢é—®å®ƒä»¬æ˜¯å¦åŒ…å«æ‰€è®¨è®ºçš„é¡¹ç›®ã€‚

åœ¨æˆ‘æ‰€çœ‹åˆ°çš„åœºæ™¯ä¸­ï¼Œå½“è¢«é—®åˆ°è¿™ä¸ªé—®é¢˜æ—¶ï¼Œæ‰€æœ‰çš„ç´¢å¼•éƒ½è¿”å›â€œno â€,å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œç®¡é“ä¸­çš„ä»£ç è¿”å› nullâ€¦æ‰€ä»¥åæ¥å½“ Sitecore è¯•å›¾é€šè¿‡åŸºäº null åç§°æŸ¥æ‰¾ç´¢å¼•æ¥è·å–å®ƒçš„ç´¢å¼•æ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°ä¸Šé¢çš„å¼‚å¸¸ã€‚

è¿›ä¸€æ­¥çš„æŒ–æ˜å‘ç°äº†â€œå·¥ä½œçš„â€æœåŠ¡å™¨å’Œâ€œåçš„â€æœåŠ¡å™¨ä¹‹é—´çš„ä¸€ä¸ªå…³é”®åŒºåˆ«:

*   åœ¨å®ƒå·¥ä½œçš„æœºå™¨ä¸Šï¼ŒSitecore çš„æœç´¢ç´¢å¼•è¢«é…ç½®ä¸ºâ€œç´¢å¼•æ‰€æœ‰æ¨¡æ¿ï¼Œé™¤äº†ä¸€äº›ç‰¹å®šçš„æ¨¡æ¿â€
*   ä½†æ˜¯è¢«ç ´åçš„æœåŠ¡å™¨è¢«é…ç½®ä¸ºâ€œæ’é™¤æ‰€æœ‰æ¨¡æ¿ï¼Œé™¤äº†ä¸€äº›ç‰¹å®šçš„â€â€¦

æ‰€ä»¥è¿™ä¸ªé—®é¢˜çš„çœŸæ­£åŸå› æ˜¯ä¼ å…¥`ContentSearchManager.CreateSearchContext()`çš„ Sitecore æ¡ç›®æ˜¯åŸºäºä¸€ä¸ªè¢«æ˜ç¡®æ’é™¤åœ¨æœç´¢ç´¢å¼•ä¹‹å¤–çš„æ¨¡æ¿ã€‚æˆ‘ä¸€è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»£ç å°±å¼€å§‹å·¥ä½œäº†ã€‚

## ç»“è®º

å—¯ï¼Œæ˜¾è€Œæ˜“è§çš„ç»“è®ºæ˜¯:1)ä¸è¦ä»ä½ çš„ç´¢å¼•ä¸­æ’é™¤ä½ å°†è¦è°ƒç”¨`ContentSearchManager.CreateSearchContext()`çš„é¡¹ç›®ã€‚2)è·¨éƒ¨ç½²æ›´å¥½åœ°ç®¡ç†æ‚¨çš„é…ç½®â€¦ [![ğŸ˜‰](img/b26450942c7c42752fe0b02f126abb48.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--fumfYCPq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s0.wp.com/wp-content/mu-plugins/wpcom-smileys/twemoji/2/72x72/1f609.png)

åšäº†ä¸€äº›è¿›ä¸€æ­¥çš„æµ‹è¯•åï¼Œä¸Šé¢çš„é”™è¯¯æ¶ˆæ¯ä¼¼ä¹æ˜¯é’ˆå¯¹æ—§ç‰ˆæœ¬çš„ Sitecore çš„ã€‚æˆ‘ä¹Ÿåœ¨ V9.1 ä¸Šæµ‹è¯•è¿‡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å®ƒä»ç„¶ä¼šå´©æºƒï¼Œä½†æ˜¯å®ƒæ˜¾ç¤ºäº†ä¸€ä¸ªä¸åŒçš„å¼‚å¸¸:

```
[NullReferenceException: Object reference not set to an instance of an object.] 

 Sitecore.ContentSearch.SitecoreItemCrawler.IsExcludedFromIndex(SitecoreIndexableItem indexable, Boolean checkLocation) +69
  Sitecore.ContentSearch.SitecoreItemCrawler.GetContextIndexRanking(IIndexable indexable) +113
  System.Linq.WhereSelectListIterator`2.MoveNext() +116
  System.Linq.Enumerable.Min(IEnumerable`1 source) +72

 Sitecore.ContentSearch.AbstractSearchIndex.Sitecore.ContentSearch.Pipelines.GetContextIndex.IContextIndexRankable.GetContextIndexRanking(IIndexable indexable) +119
  Sitecore.ContentSearch.Pipelines.GetContextIndex.<>c\_\_DisplayClass6\_0.<RankContextIndexes>b\_\_0(ISearchIndex i) +71
  System.Linq.WhereSelectEnumerableIterator`2.MoveNext() +237
  System.Linq.Buffer`1..ctor(IEnumerable`1 source) +280
  System.Linq.<GetEnumerator>d__1.MoveNext() +115
  System.Linq.Buffer`1..ctor(IEnumerable`1 source) +280
  System.Linq.Enumerable.ToArray(IEnumerable`1 source) +89

 Sitecore.ContentSearch.Pipelines.GetContextIndex.FetchIndex.GetContextIndex(IIndexable indexable, GetContextIndexArgs args) +699

 Sitecore.ContentSearch.Pipelines.GetContextIndex.FetchIndex.Process(GetContextIndexArgs args) +48 (Object , Object ) +13
  Sitecore.Pipelines.CorePipeline.Run(PipelineArgs args) +483
  Sitecore.Pipelines.DefaultCorePipelineManager.Run(String pipelineName, PipelineArgs args, String pipelineDomain, Boolean failIfNotExists) +235
  Sitecore.Pipelines.DefaultCorePipelineManager.Run(String pipelineName, PipelineArgs args, String pipelineDomain) +21
  Sitecore.Abstractions.CorePipelineWrapper.Run(String pipelineName, PipelineArgs args) +73

 Sitecore.ContentSearch.Pipelines.GetContextIndex.GetContextIndexPipeline.Run(ICorePipeline pipeline, GetContextIndexArgs args) +38 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ç§ç—•è¿¹æ›´åŠ æ˜æ˜¾â€”â€”ä½†æ˜¯å¯¹äºä¸ç†Ÿæ‚‰ Sitecore ç´¢å¼•é…ç½®è¿‡ç¨‹çš„äººæ¥è¯´ï¼Œå¯èƒ½ä»ç„¶ä¼šæ„Ÿåˆ°å›°æƒ‘ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨çœ‹åˆ°ä¸Šé¢æ˜¾ç¤ºçš„ä»»ä½•ä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼Œè¯·æ£€æŸ¥æ‚¨ä»ç´¢å¼•ä¸­æ’é™¤äº†ä»€ä¹ˆâ€¦