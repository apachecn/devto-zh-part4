# å½ªé©¬ 4:é”¤ç‚¼ H13sâ€”â€”ä¸€ä¸ªè°ƒè¯•çš„æ•…äº‹

> åŸæ–‡:[https://dev . to/heroku/puma-4-hamming-out-h13s-a-debugging-story-fbm](https://dev.to/heroku/puma-4-hammering-out-h13s-a-debugging-story-fbm)

å¾ˆé•¿ä¸€æ®µæ—¶é—´ä»¥æ¥ï¼Œæˆ‘ä»¬ä»æˆ‘ä»¬çš„å¤§å®¢æˆ·é‚£é‡Œæ”¶åˆ°å…³äº Ruby åº”ç”¨ç¨‹åºå‡ºç°ç¥ç§˜çš„ [H13 -è¿æ¥å…³é—­é”™è¯¯](https://devcenter.heroku.com/articles/error-codes#h13-connection-closed-without-response)çš„æŠ¥å‘Šã€‚å¥‡æ€ªçš„æ˜¯ï¼Œè¿™åªå‘ç”Ÿåœ¨ä»–ä»¬éƒ¨ç½²æˆ–æ‰©å±• dynos çš„æ—¶å€™ã€‚æ›´å¥‡æ€ªçš„æ˜¯ï¼Œè¿™åªå‘ç”Ÿåœ¨ç›¸å¯¹å¤§è§„æ¨¡çš„åº”ç”¨ä¸­ã€‚æˆ‘ä»¬æ— æ³•åœ¨ç¤ºä¾‹åº”ç”¨ç¨‹åºä¸Šé‡ç°è¿™ç§è¡Œä¸ºã€‚è¿™æ˜¯ä¸€ä¸ªå…³äºåˆ†å¸ƒå¼åè°ƒã€TCP API ä»¥åŠæˆ‘ä»¬å¦‚ä½•è°ƒè¯•å’Œä¿®å¤ Puma ä¸­ä¸€ä¸ªåªæœ‰å¤§è§„æ¨¡å‡ºç°çš„ bug çš„æ•…äº‹ã€‚

[![Screenshot showing H13 errors](../Images/f63b0e5e2147a6c272be3f17f977f5f1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--9vO9K5NL--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://heroku-blog-files.s3.amazonaws.com/posts/1562883126-Screenshot%25202019-06-23%252015.04.50.png)

## [](#connection-closed)è¿æ¥å…³é—­

é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯ H13 é”™è¯¯ï¼Ÿä»æˆ‘ä»¬çš„é”™è¯¯é¡µé¢æ–‡æ¡£ä¸­:

> å½“æ‚¨çš„ web dyno ä¸­çš„è¿›ç¨‹æ¥å—è¿æ¥ï¼Œä½†éšåå…³é—­å¥—æ¥å­—è€Œä¸å‘å…¶å†™å…¥ä»»ä½•å†…å®¹æ—¶ï¼Œä¼šå¼•å‘æ­¤é”™è¯¯ã€‚å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µçš„ä¸€ä¸ªä¾‹å­æ˜¯ï¼Œå½“ Unicorn web æœåŠ¡å™¨é…ç½®äº†ä¸€ä¸ªçŸ­äº 30 ç§’çš„è¶…æ—¶ï¼Œå¹¶ä¸”åœ¨è¶…æ—¶å‘ç”Ÿä¹‹å‰ä¸€ä¸ªè¯·æ±‚è¿˜æ²¡æœ‰è¢«ä¸€ä¸ªå·¥ä½œè¿›ç¨‹å¤„ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒUnicorn ä¼šåœ¨å†™å…¥ä»»ä½•æ•°æ®ä¹‹å‰å…³é—­è¿æ¥ï¼Œä»è€Œå¯¼è‡´ H13ã€‚

æœ‰è¶£çš„äº‹å®:æˆ‘ä»¬çš„é”™è¯¯ä»£ç ä»å®ƒä»¬æ¥è‡ªçš„ç»„ä»¶çš„å­—æ¯å¼€å§‹ã€‚æˆ‘ä»¬çš„è·¯ç”±ä»£ç éƒ½æ˜¯ç”¨ Erlang ç¼–å†™çš„ï¼Œå¹¶è¢«å‘½åä¸ºâ€œHermes â€,å› æ­¤ Heroku ä¸­ä»»ä½•ä»¥â€œHâ€å¼€å¤´çš„é”™è¯¯ä»£ç éƒ½è¡¨ç¤ºæ¥è‡ªè·¯ç”±å™¨çš„é”™è¯¯ã€‚

æ–‡æ¡£ç»™å‡ºäº†ä¸€ä¸ªå…³äº unicorn webserver çš„ H13 é”™è¯¯ä»£ç çš„ä¾‹å­ï¼Œä½†æ˜¯å®ƒå¯ä»¥åœ¨ä»»ä½•æ—¶å€™é€šè¿‡æœåŠ¡å™¨å…³é—­è¿æ¥ï¼Œä½†æ˜¯æ²¡æœ‰å“åº”çš„æ—¶å€™å‘ç”Ÿã€‚è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨èŠ‚ç‚¹åº”ç”¨ç¨‹åºæ˜¾å¼åœ°[å†ç° H13ã€‚](https://github.com/hunterloftis/heroku-node-errcodes/blob/master/h13)

ç”³è¯·è·å¾— H13 æ„å‘³ç€ä»€ä¹ˆï¼Ÿå®é™…ä¸Šï¼Œè¿™äº›é”™è¯¯ä¸­çš„æ¯ä¸€ä¸ªéƒ½ä¸æ”¶åˆ°é”™è¯¯é¡µé¢çš„å®¢æˆ·ç›¸å…³ã€‚æ¯æ¬¡åº”ç”¨ç¨‹åºé‡å¯ã€éƒ¨ç½²æˆ–è‡ªåŠ¨ç¼©æ”¾æ—¶å‡ºç°å°‘é‡é”™è¯¯æ˜¯ä¸€ç§ç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒï¼Œæ‰€ä»¥æ‰¾åˆ°å¹¶ä¿®å¤è¿™äº›é”™è¯¯æ˜¯å€¼å¾—çš„ã€‚

## [](#debugging)è°ƒè¯•

æˆ‘å·²ç»ç»´æŠ¤ Ruby buildpack å¥½å‡ å¹´äº†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†å·¥ä½œæ˜¯å¤„ç†å¯¹æˆ‘ä»¬çš„æ ¸å¿ƒæ”¯æŒè€…æ¥è¯´å¤ªæ£˜æ‰‹çš„æ”¯æŒå‡çº§ã€‚é™¤äº†æ­£å¸¸çš„éƒ¨ç½²é—®é¢˜ï¼Œæˆ‘è¿˜å¯¹æ€§èƒ½ã€å¯ä¼¸ç¼©æ€§å’Œ web æœåŠ¡å™¨äº§ç”Ÿäº†å…´è¶£(æˆ‘æœ€è¿‘å¼€å§‹å¸®åŠ©ç»´æŠ¤ Puma web æœåŠ¡å™¨)ã€‚å› ä¸ºè¿™äº›åˆ©ç›Šï¼Œå½“ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜æ¥è‡ªæˆ‘ä»¬çš„å¤§å®¢æˆ·æ—¶ï¼Œç‰¹åˆ«æ˜¯å¦‚æœå®ƒåªæ˜¯å¤§è§„æ¨¡å‘ç”Ÿï¼Œæˆ‘ä¼šç‰¹åˆ«æ„Ÿå…´è¶£ã€‚

è¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨éœ€è¦äº†è§£ä¸€ç‚¹å…³äºå‘é€åˆ†å¸ƒå¼æ¶ˆæ¯çš„æœ¬è´¨ã€‚web æœåŠ¡å™¨æœ¬è´¨ä¸Šæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ›´å¤æ‚çš„æ˜¯ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿæ¥ç®¡ç†æˆ‘ä»¬çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé”™è¯¯ä¼¼ä¹ä¸æ˜¯æ¥è‡ªå®¢æˆ·çš„åº”ç”¨ç¨‹åºä»£ç ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»–ä»¬ä¼¼ä¹æ²¡æœ‰ä»»ä½•é…ç½®é”™è¯¯ã€‚å®ƒä¼¼ä¹ä¹Ÿåªå‘ç”Ÿåœ¨ dyno è¢«å…³é—­çš„æ—¶å€™ã€‚

è¦å…³é—­ä¸€ä¸ª dyno å¿…é¡»å‘ç”Ÿä¸¤ä»¶äº‹ï¼Œæˆ‘ä»¬éœ€è¦å‘é€ä¸€ä¸ª`SIGTERM`åˆ° dyno ä¸Šçš„è¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹[å‘Šè¯‰ web æœåŠ¡å™¨å®‰å…¨å…³é—­](https://devcenter.heroku.com/articles/what-happens-to-ruby-apps-when-they-are-restarted)ã€‚æˆ‘ä»¬è¿˜éœ€è¦å‘Šè¯‰è·¯ç”±å™¨åœæ­¢å‘é‚£ä¸ª dyno å‘é€è¯·æ±‚ï¼Œå› ä¸ºå®ƒå¾ˆå¿«å°±ä¼šå…³é—­ã€‚

è¿™ä¸¤ä¸ªæ“ä½œå‘ç”Ÿåœ¨ä¸¤ä¸ªä¸åŒçš„ç³»ç»Ÿä¸Šã€‚dyno è¿è¡Œåœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šï¼Œä¸ºæˆ‘ä»¬çš„è¯·æ±‚æœåŠ¡çš„è·¯ç”±å™¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿã€‚å®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿã€‚äº‹å®è¯æ˜ï¼Œè™½ç„¶ä¸¤ä¸ªç³»ç»Ÿå‡ ä¹åŒæ—¶æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†è·¯ç”±å™¨å¯èƒ½ä»ç„¶ä¼šè®©ä¸€äº›è¯·æ±‚è¿›å…¥åœ¨æ”¶åˆ°`SIGTERM`åè¢«å…³é—­çš„ dynoã€‚

è¿™å°±è§£é‡Šäº†é—®é¢˜æ‰€åœ¨ï¼Œå¯¹å—ï¼Ÿè¿™ç§æƒ…å†µåªå‘ç”Ÿåœ¨å…·æœ‰å¤§é‡æµé‡çš„åº”ç”¨ç¨‹åºä¸Šçš„åŸå› æ˜¯ï¼Œå®ƒä»¬æ”¶åˆ°å¦‚æ­¤å¤šçš„è¯·æ±‚ï¼Œåœ¨è·¯ç”±å™¨åœæ­¢å‘é€è¯·æ±‚å’Œ dyno æ”¶åˆ°`SIGTERM`ä¹‹é—´æœ‰æ›´å¤šçš„æœºä¼šå‡ºç°ç«äº‰æƒ…å†µã€‚

é‚£å¬èµ·æ¥åƒæ˜¯è·¯ç”±å™¨çš„é—®é¢˜ï¼Œå¯¹å—ï¼Ÿåœ¨æˆ‘ä»¬æ·±å…¥è®¨è®ºåˆ†å¸ƒå¼åè°ƒçš„å›°éš¾ä¹‹å‰ï¼Œæˆ‘æ³¨æ„åˆ°å…¶ä»–å…·æœ‰ç›¸åŒè´Ÿè½½çš„åº”ç”¨ç¨‹åºæ²¡æœ‰å‡ºç° H13 é”™è¯¯ã€‚è¿™å‘Šè¯‰äº†æˆ‘ä»€ä¹ˆï¼Ÿå®ƒå‘Šè¯‰æˆ‘ï¼Œæˆ‘ä»¬ç³»ç»Ÿçš„åˆ†å¸ƒå¼è¡Œä¸ºä¸æ˜¯ç½ªé­ç¥¸é¦–ã€‚å¦‚æœå…¶ä»– web æœåŠ¡å™¨å¯ä»¥å¾ˆå¥½åœ°å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ›´æ–°æˆ‘ä»¬çš„ web æœåŠ¡å™¨ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯ Pumaã€‚

## [](#reproduction)ç¹è¡åä»£

å½“æ‚¨å¤„ç†ä¾èµ–äºç«äº‰æ¡ä»¶çš„åˆ†å¸ƒå¼ç³»ç»Ÿ bug æ—¶ï¼Œé‡ç°é—®é¢˜å¯èƒ½æ˜¯ä¸€ä»¶æ£˜æ‰‹çš„äº‹æƒ…ã€‚åœ¨ä¸å¦ä¸€ä½ Heroku å·¥ç¨‹å¸ˆ [Chap Ambrose](https://twitter.com/chapambrose?lang=en) å°±è¿™ä¸ªé—®é¢˜è¿›è¡Œé…å¯¹æ—¶ï¼Œæˆ‘ä»¬æƒ³åˆ°äº†ä¸€ä¸ªä¸»æ„ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†åœ¨ä»»ä½•åº”ç”¨ç¨‹åºä¸­é‡ç° H13 è¡Œä¸ºï¼Œä»¥ç¡®å®šæˆ‘ä»¬å°†å¾—åˆ°ä»€ä¹ˆæ ·çš„ [curl é€€å‡ºä»£ç ](https://curl.haxx.se/libcurl/c/libcurl-errors.html)ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­æ¥é‡ç°ç¡®åˆ‡çš„æ•…éšœæ¡ä»¶ã€‚

ä¸€ä¸ªç®€å•çš„å¤åˆ¶æ¶ app æ˜¯è¿™æ ·çš„:

```
app = Proc.new do |env|
  current_pid = Process.pid
  signal = "SIGKILL"
  Process.kill(signal, current_pid)
  ['200', {'Content-Type' => 'text/html'}, ['A barebones rack app.']]
end

run app 
```

å½“æ‚¨ç”¨ Puma è¿è¡Œè¿™ä¸ª`config.ru`å¹¶ç”¨ä¸€ä¸ªè¯·æ±‚ç‚¹å‡»å®ƒæ—¶ï¼Œæ‚¨å°†å¾—åˆ°ä¸€ä¸ªå…³é—­çš„è¿æ¥ï¼Œè€Œæ²¡æœ‰å†™å…¥è¯·æ±‚ã€‚è¿™å¾ˆç®€å•ã€‚

åƒè¿™æ ·å…³é—­è¿æ¥æ—¶çš„ curl ä»£ç æ˜¯`52`ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¯ä»¥æ£€æµ‹åˆ°å®ƒä½•æ—¶å‘ç”Ÿã€‚

```
$ curl localhost:9292
  % Total % Received % Xferd Average Speed Time Time Time Current
                                 Dload Upload Total Spent Left Speed
  0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0
curl: (52) Empty reply from server 
```

å½“è°ƒç”¨ SIGTERM æ—¶ï¼Œä¼šå‘ç”Ÿæ›´å¤æ‚çš„å¤åˆ¶ï¼Œä½†è¯·æ±‚ä¼šä¸æ–­å‡ºç°ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°äº†ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„å¤åˆ¶å“:

```
app = Proc.new do |env|
  puma_pid = File.read('puma.pid').to_i
  Process.kill("SIGTERM", puma_pid)
  Process.kill("SIGTERM", Process.pid)

  ['200', {'Content-Type' => 'text/html'}, ['A barebones rack app.']]
end

run app 
```

è¿™ä¸ª`config.ru` rack åº”ç”¨ç¨‹åºåœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶å‘å®ƒè‡ªå·±å’Œå®ƒçš„çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ª`SIGTERM`ã€‚å› æ­¤ï¼Œå½“æœåŠ¡å™¨å…³é—­æ—¶ï¼Œå…¶ä»–æœªæ¥çš„è¯·æ±‚å°†ä¼šåˆ°æ¥ã€‚

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥å¼•å¯¼è¿™ä¸ªæœåŠ¡å™¨ï¼Œå¹¶ç”¨ä¸€å †å¹¶è¡Œè¯·æ±‚æ¥è®¿é—®å®ƒ:

```
threads = []

threads << Thread.new do
  puts `puma > puma.log` unless ENV["NO_PUMA_BOOT"]
end

sleep(3)
require 'fileutils'
FileUtils.mkdir_p("tmp/requests")

20.times do |i|
  threads << Thread.new do
    request = `curl localhost:9292/?request_thread=#{i} &> tmp/requests/requests#{i}.log`
    puts $?
  end
end

threads.map {|t| t.join } 
```

å½“æˆ‘ä»¬è¿è¡Œè¿™ä¸ªå†ç°æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒç»™å‡ºäº†æˆ‘ä»¬æƒ³è¦å†ç°çš„ç¡®åˆ‡è¡Œä¸ºã€‚æ›´å¥½çš„æ˜¯ï¼Œå½“è¿™æ®µä»£ç éƒ¨ç½²åœ¨ Heroku ä¸Šæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ª H13 é”™è¯¯è¢«è§¦å‘:

```
2019-05-10T18:41:06.859330+00:00 heroku[router]: at=error code=H13 desc="Connection closed without response" method=GET path="/?request_thread=6" host=ruby-h13.herokuapp.com request_id=05696319-a6ff-4fad-b219-6dd043536314 fwd="<ip>" dyno=web.1 connect=0ms service=5ms status=503 bytes=0 protocol=https 
```

ä½ å¯ä»¥åœ¨[å¤åˆ¶è„šæœ¬ repo](https://github.com/schneems/puma_connection_closed_reproduction) ä¸Šè·å¾—æ‰€æœ‰è¿™äº›ä»£ç å’Œæ›´å¤šç»†èŠ‚ã€‚è¿™æ˜¯æˆ‘ç”¨æ¥è¿½è¸ªè¡Œä¸ºçš„[ç¾æ´²ç‹®å·](https://github.com/puma/puma/issues/1802)

## [](#closing-the-connection-closed-bug)å…³é—­è¿æ¥å…³é—­ Bug

æœ‰äº†å†ç°è„šæœ¬ï¼Œæˆ‘ä»¬å°±æœ‰å¯èƒ½å‘ Puma å†…éƒ¨æ·»åŠ è°ƒè¯•è¯­å¥ï¼Œä»¥æŸ¥çœ‹å®ƒåœ¨é‡åˆ°è¿™ä¸ªé—®é¢˜æ—¶çš„è¡Œä¸ºã€‚

ç¨å¾®è°ƒæŸ¥ä¸€ä¸‹ï¼Œå‘ç° Puma ä»æ¥æ²¡æœ‰æ˜¾å¼å…³é—­è¿‡è¿æ¥çš„å¥—æ¥å­—ã€‚ç›¸åï¼Œå®ƒä¾èµ–äºè¿›ç¨‹åœæ­¢æ¥å…³é—­å®ƒã€‚

é‚£åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæ¯æ¬¡ä½ åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ª URLï¼Œè¯·æ±‚å°±ä¼šè¢«è·¯ç”±åˆ°ä¸€ä¸ªæœåŠ¡å™¨ã€‚åœ¨ Heroku ä¸Šï¼Œè¯·æ±‚è¢«å‘é€åˆ°æˆ‘ä»¬çš„è·¯ç”±å™¨ã€‚ç„¶åï¼Œè·¯ç”±å™¨å°è¯•è¿æ¥åˆ° dyno(æœåŠ¡å™¨)å¹¶å‘å…¶ä¼ é€’è¯·æ±‚ã€‚å…è®¸è¿™æ ·åšçš„åº•å±‚æœºåˆ¶æ˜¯ dyno ä¸Šçš„ webserver (Puma)åœ¨ PORT ä¸Šæ‰“å¼€ä¸€ä¸ª TCP å¥—æ¥å­—ã€‚è¯·æ±‚åœ¨å¥—æ¥å­—ä¸Šè¢«æ¥å—ï¼Œå®ƒå°†ä¸€ç›´å‘†åœ¨é‚£é‡Œï¼Œç›´åˆ° web æœåŠ¡å™¨(Puma)å‡†å¤‡å¥½è¯»å–å¹¶å“åº”å®ƒã€‚

é‚£ä¹ˆï¼Œä¸ºäº†é¿å…è¿™ç§ H13 é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦åšäº›ä»€ä¹ˆå‘¢ï¼Ÿåœ¨é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œè·¯ç”±å™¨å°è¯•è¿æ¥åˆ° dynoï¼Œå®ƒæˆåŠŸäº†ï¼Œå› ä¸º Puma æ¥å—äº†è¯·æ±‚ï¼Œå®ƒæœŸæœ› dyno å¤„ç†è¯·æ±‚çš„å†™å…¥ã€‚ç›¸åï¼Œå¦‚æœå¥—æ¥å­—åœ¨è¯•å›¾ä¼ é€’è¯·æ±‚æ—¶è¢«å…³é—­ï¼Œå®ƒå°†çŸ¥é“ Puma æ— æ³•å“åº”ã€‚ç„¶åï¼Œå®ƒä¼šé‡è¯•å°†è¿æ¥ä¼ é€’ç»™å¦ä¸€ä¸ª dynoã€‚æœ‰æ—¶å€™ï¼Œweb æœåŠ¡å™¨å¯èƒ½ä¼šæ‹’ç»ä¸€ä¸ªè¿æ¥ï¼Œä¾‹å¦‚ï¼Œå¦‚æœå¥—æ¥å­—å·²æ»¡(é»˜è®¤æƒ…å†µä¸‹åªå…è®¸å¥—æ¥å­— backlog ä¸Šæœ‰ 1024 ä¸ªè¿æ¥)ï¼Œæˆ–è€…å¦‚æœæ•´ä¸ªæœåŠ¡å™¨å·²ç»å´©æºƒã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå…³é—­å¥—æ¥å­—æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚å®ƒæ­£ç¡®åœ°ä¸è·¯ç”±å™¨é€šä¿¡ä»¥åšæ­£ç¡®çš„äº‹æƒ…(å°è¯•å°†è¿æ¥ä¼ é€’ç»™å¦ä¸€ä¸ª dyno æˆ–åœ¨æ‰€æœ‰ dyno éƒ½é‡æ–°å¯åŠ¨çš„æƒ…å†µä¸‹ä¿æŒè¿æ¥)ã€‚

å› æ­¤ï¼Œè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨å°è¯•æ˜¾å¼å…³é—­ä¹‹å‰å…³é—­å¥—æ¥å­—ã€‚ä¸‹é¢æ˜¯ [PR](https://github.com/puma/puma/pull/1808) ã€‚ä¸»è¦çš„é­”æ³•åªæœ‰ä¸€è¡Œ:

```
@launcher.close_binder_listeners 
```

å¦‚æœä½ æ˜¯ä¸€ä¸ªæäººå¿§å¤©è€…(æˆ‘çŸ¥é“æˆ‘æ˜¯)ï¼Œä½ å¯èƒ½å®³æ€•å…³é—­å¥—æ¥å­—ä¼šé˜»æ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚è¢«æˆåŠŸå®Œæˆã€‚å¹¸è¿çš„æ˜¯ï¼Œå…³é—­å¥—æ¥å­—é˜»æ­¢äº†ä¼ å…¥çš„è¯·æ±‚ï¼Œä½†ä»ç„¶å…è®¸æˆ‘ä»¬å¯¹ç°æœ‰çš„è¯·æ±‚åšå‡ºå“åº”ã€‚å¦‚æœä½ ä¸ç›¸ä¿¡æˆ‘ï¼Œæƒ³æƒ³ä½ å¦‚ä½•ç”¨æˆ‘ä¸Šé¢çš„ä¾‹å­æ¥æµ‹è¯•å®ƒã€‚

## [](#testing-distributed-behavior)æµ‹è¯•åˆ†å¸ƒå¼è¡Œä¸º

æˆ‘ä¸çŸ¥é“å½ªé©¬çš„è¿™ç§è¡Œä¸ºæ˜¯ä¸æ˜¯åäº†ï¼Œä¹Ÿå¯èƒ½ä»æ¥å°±æ²¡èµ·ä½œç”¨ã€‚ä¸ºäº†ç¡®ä¿å®ƒåœ¨æœªæ¥ç»§ç»­å·¥ä½œï¼Œæˆ‘æƒ³ä¸ºå®ƒå†™ä¸€ä¸ªæµ‹è¯•ã€‚æˆ‘è”ç³»äº†æ›¾åœ¨ Puma å…¶ä»–é—®é¢˜ä¸Šæä¾›å¸®åŠ©çš„ [dannyfallon](https://twitter.com/touchingvirus?lang=en) ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•ä¸­ä½¿ç”¨[å¯¹å’Œå…ƒç»„](https://tuple.app/)è¿›è¡Œäº†è¿œç¨‹é…å¯¹ã€‚

æµ‹è¯•çš„ç»“æœæ˜¯[ä¸æˆ‘ä»¬åœ¨](https://github.com/puma/puma/pull/1808/files#diff-ad8d9f1e0cf07519c2372ca5f60ca4d2)ä¸Šé¢çš„ç¤ºä¾‹å¤åˆ¶æ²¡æœ‰å¤ªå¤§çš„ä¸åŒï¼Œä½†æ˜¯è®©å®ƒæœ‰ä¸€è‡´çš„è¡Œä¸ºæ˜¯ç›¸å½“æ£˜æ‰‹çš„ã€‚

é™¤éåœ¨å¤§è§„æ¨¡çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¦åˆ™é—®é¢˜ä¸ä¼šç»å¸¸å‡ºç°ï¼Œæµ‹è¯•æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œæ­£å¦‚æ…ˆå–„ä¸“ä¸šäººå£«ä¼šè¯´çš„â€œåœ¨ç”Ÿäº§ä¸­â€ã€‚æˆ‘ä»¬æœ‰å‡ ä¸ªçœ‹åˆ°è¿™ä¸ªé”™è¯¯çš„ Heroku å®¢æˆ·è¯•ç”¨äº†æˆ‘çš„è¡¥ä¸ã€‚ä»–ä»¬æŠ¥å‘Šäº†ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè§£å†³è¿™äº›é—®é¢˜ï¼Œä¿®å¤è¿™äº›é—®é¢˜åï¼Œçœ‹èµ·æ¥è¿™äº›é”™è¯¯å·²è¢«ä¿®å¤ã€‚

[![Screenshot showing no more H13 errors](../Images/e9e55b549d4840f7d134808a9132ddc8.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--YX2Se5sp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://heroku-blog-files.s3.amazonaws.com/posts/1562883272-59190728-7bf56a80-8b4b-11e9-8e01-84238fecf24c.png)

## [](#rolling-out-the-fix)é“ºå¼€ä¿®ç½—

Puma 4ï¼Œå¸¦æœ‰è¿™ä¸ªè¡¥ä¸ï¼Œ[æœ€è¿‘å‘å¸ƒäº†](https://github.com/puma/puma/releases/tag/v4.0.0)ã€‚æˆ‘ä»¬è”ç³»äº†ä¸€ä¸ªä½¿ç”¨ Puma çš„å®¢æˆ·ï¼Œä»–çœ‹åˆ°äº†å¤§é‡çš„ H13ï¼Œè¿™ä¸ªç‰ˆæœ¬é˜»æ­¢äº†ä»–ä»¬ã€‚

ä¸‹é¢äº†è§£æ›´å¤šå…³äº Puma 4 çš„ä¿¡æ¯ã€‚

> ![unknown tweet media content](../Images/bf295db6ec7ecb6753fb5ded0bfa496f.png)![Play butt](../Images/980e9fb12d58fa9423fc94c33003fc4f.png)<video loop="" controls=""><source src="https://video.twimg.com/ext_tw_video/1143577341634994176/pu/vid/640x360/VCVNd2c8NcCILhmb.mp4?tag=10" type="video/mp4"></video>![Richard Schneeman ğŸ¤  profile image](../Images/9948f63b6e8cdc19db1d1f36e2669cac.png)ç†æŸ¥å¾·Â·æ–½å°¼æ›¼ğŸ¤ [@ schneems](https://dev.to/schneems)![twitter logo](../Images/65e26e35707d96169ec8af6b3cbf2003.png)ç”±ç©¿ç€ç¡è¡£ç»™ä½ é€ç¾Šé©¼çš„ç¼–ç å‘˜ã€‚å…¨æ–°çš„å½±é™¢çº§ Ruby æœåŠ¡å™¨ä½“éªŒã€‚ç”± [@evanphx](https://twitter.com/evanphx) æ‰§å¯¼ï¼Œ [@nateberkopec](https://twitter.com/nateberkopec) æ‘„å½±ï¼Œ [@schneems](https://twitter.com/schneems) åˆ¶ç‰‡ã€‚
> 
> ä»‹ç»-å½ªé©¬:4 å¿« 4 æ€’
> 
> [github.com/puma/puma/releâ€¦](https://t.co/06PG0lzubk)2019 å¹´ 6 æœˆ 25 æ—¥ä¸‹åˆ 17:52[![Twitter reply action](../Images/269095962147c28351274afdd5486a48.png)](https://twitter.com/intent/tweet?in_reply_to=1143577608791220224)[![Twitter retweet action](../Images/771160ecf06ae3d4d7a7815c29c819c2.png)](https://twitter.com/intent/retweet?tweet_id=1143577608791220224)39[![Twitter like action](../Images/c077611ab2a5e0b4cd0c826ee7ae1e48.png)](https://twitter.com/intent/like?tweet_id=1143577608791220224)135