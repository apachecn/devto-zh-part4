# CommonJS å’Œ ES6 æ¨¡å—å¯¼å…¥çš„å®Œæ•´å’Œéƒ¨åˆ†æ¨¡ä»¿/çª¥æ¢

> åŸæ–‡:[https://dev . to/Hugo _ _ df/jest-full-and-partial-mock-spy-of-commonjs-and-es6-module-imports-53gf](https://dev.to/hugo__df/jest-full-and-partial-mock-spy-of-commonjs-and-es6-module-imports-53gf)

> JavaScript å¯¼å…¥/è¦æ±‚æ¨¡å—æµ‹è¯•ç”¨ Jest åšä»€ä¹ˆå’Œä¸åšä»€ä¹ˆ

èŒƒä¾‹åº“å¯åœ¨[github.com/HugoDF/mock-spy-module-import](https://github.com/HugoDF/mock-spy-module-import)è·å¾—ã€‚

è¿™ç¯‡æ–‡ç« è®²è¿°äº†å¦‚ä½•ç”¨ Jest å®ç°ä¸åŒç±»å‹çš„æ¨¡å—æ¨¡ä»¿åœºæ™¯ã€‚

ä»ç®€å•çš„å¯¼å…¥æ‹¦æˆªï¼Œåˆ°å¦‚ä½•ç»ˆæ­¢å†…éƒ¨å‡½æ•°è°ƒç”¨æˆ–åªæ¨¡ä»¿æ¨¡å—çš„ä¸€éƒ¨åˆ†(é€šè¿‡ç›‘è§†â€¦)ã€‚

è¿™äº›æ–¹æ³•åœ¨æ¯” Jest å®˜æ–¹æ–‡æ¡£æ˜¾ç¤ºçš„æ›´å…·ä½“çš„æƒ…å†µä¸‹æœ‰æ•ˆã€‚

ä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ª Jest æµ‹è¯•æŒ‡å—ï¼ŒåŒæ ·çš„åŸåˆ™å¯ä»¥åº”ç”¨äºä»»ä½•éœ€è¦æ¨¡æ‹Ÿ CommonJS æˆ– es æ¨¡å—çš„åº”ç”¨ç¨‹åº/æµ‹è¯•ã€‚

## [](#for-context-types-of-imports)ä¸ºä¸Šä¸‹æ–‡:å¯¼å…¥ç±»å‹

ç°ä»£ JavaScript æœ‰ä¸¤ç§ç±»å‹çš„å¯¼å…¥:

*   CommonJS:node . jsâ€™å†…ç½®çš„å¯¼å…¥ç³»ç»Ÿä½¿ç”¨å¯¹å…¨å±€`require('module-y')`å‡½æ•°çš„è°ƒç”¨ï¼Œnpm ä¸Šçš„åŒ…å…¬å¼€äº†ä¸€ä¸ª CommonJS å…¼å®¹çš„å…¥å£æ–‡ä»¶ã€‚
*   ES æ¨¡å—(ESM):ç”± ECMAScript æ ‡å‡†å®šä¹‰çš„æ¨¡å—ã€‚å®ƒä½¿ç”¨`import x from 'module-y'`è¯­æ³•ã€‚

ä¹Ÿæœ‰åƒ RequireJS å’Œ AMD è¿™æ ·çš„(ä¼ ç»Ÿ)æ¨¡å—åŠ è½½å™¨ï¼Œä½†æ˜¯ CommonJS å’Œ ESM æ˜¯å½“å‰å’Œæœªæ¥æœ€å¹¿æ³›çš„ JavaScript æ¨¡å—å®šä¹‰æ ¼å¼ã€‚

ES æ¨¡å—æœ‰ä¸¤ç§ç±»å‹çš„å¯¼å‡º:å‘½åå¯¼å‡ºå’Œé»˜è®¤å¯¼å‡ºã€‚

ä¸€ä¸ªå‘½åçš„å¯¼å‡ºçœ‹èµ·æ¥åƒè¿™æ ·:`export function myFunc() {}`æˆ–`export const a = 1`ã€‚

é»˜è®¤å¯¼å‡ºå¦‚ä¸‹æ‰€ç¤º:`export default somethingAlreadyDefined`ã€‚

å‘½åçš„å¯¼å‡ºå¯ä»¥ä½¿ç”¨çœ‹èµ·æ¥(å’Œå·¥ä½œèµ·æ¥)æœ‰ç‚¹åƒå¯¹è±¡ææ„çš„è¯­æ³•æ¥å•ç‹¬å¯¼å…¥:`import { myFunc, a } from './some-module'`ã€‚

ä¹Ÿå¯ä»¥å¯¼å…¥ä¸ºåç§°ç©ºé—´:`import * as moduleY from './module-y'`(ç°åœ¨å¯ä»¥ç”¨`moduleY.myFunc()`å’Œ`moduleY.a`)ã€‚

é»˜è®¤å¯¼å‡ºåªèƒ½ç”¨é»˜è®¤å¯¼å…¥:`import whateverIsDefault from './moduleY'`å¯¼å…¥ã€‚

è¿™ä¸¤ç§è¿›å£ä¹Ÿå¯ä»¥æ··åˆæ­é…ï¼Œ[å‚è§ MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import) ä¸Šçš„`import`æ–‡æ¡£ã€‚

## [](#intercepting-imports)æ‹¦æˆªè¿›å£

å½“è¿›è¡Œå•å…ƒæµ‹è¯•æ—¶ï¼Œæ‚¨å¯èƒ½æƒ³è¦å­˜æ ¹/æ¨¡æ‹Ÿå‡ºæ‹¥æœ‰è‡ªå·±çš„å•å…ƒæµ‹è¯•çš„æ¨¡å—ã€‚

å¼€ç©ç¬‘çš„è¯´ï¼Œè¿™æ˜¯ç”¨`jest.mock('./path/of/module/to/mock', () => ({ /* fake module */ }))`å®Œæˆçš„ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCommonJS å’Œ ES6 æ¨¡å—æ¨¡æ‹Ÿçœ‹èµ·æ¥éå¸¸ç›¸ä¼¼ã€‚æœ‰ä¸€äº›ä¸€èˆ¬æ€§çš„é—®é¢˜ã€‚

é¦–å…ˆï¼Œä½ å˜²ç¬‘çš„(ç¬¬äºŒä¸ªå‚æ•°`jest.mock`)æ˜¯æ¨¡å—çš„å·¥å‚ã€‚å³ã€‚è¿™æ˜¯ä¸€ä¸ªè¿”å›æ¨¡æ‹Ÿæ¨¡å—å¯¹è±¡çš„å‡½æ•°ã€‚

å…¶æ¬¡ï¼Œå¦‚æœæ‚¨æƒ³ä»`jest.mock`çš„çˆ¶ä½œç”¨åŸŸä¸­å¼•ç”¨ä¸€ä¸ªå˜é‡(ä¾‹å¦‚ï¼Œæ‚¨æƒ³å®šä¹‰æ‚¨çš„æ¨¡æ‹Ÿæ¨¡å—å®ä¾‹)ï¼Œæ‚¨éœ€è¦åœ¨å˜é‡åå‰é¢åŠ ä¸Šå‰ç¼€`mock`ã€‚æ¯”å¦‚:

```
const mockDb = {
get: jest.fn(),
set: jest.fn()
};
const db = mockDb
// This works
jest.mock('./db', () => mockDb);
// This doesn't work
jest.mock('./db', () => db); 
```

æœ€åï¼Œæ‚¨åº”è¯¥åœ¨å¯¼å…¥è¢«æµ‹æ¨¡å—ä¹‹å‰è°ƒç”¨`jest.mock` *(å®ƒæœ¬èº«å¯¼å…¥äº†æˆ‘ä»¬åˆšåˆšå˜²ç¬‘çš„æ¨¡å—)ã€‚*

å®é™…ä¸Šï¼ŒBabel ESM-> CommonJS trans pilation ä¼šæå‡`jest.mock`è°ƒç”¨ï¼Œæ‰€ä»¥è¿™é€šå¸¸ä¸æ˜¯é—®é¢˜ğŸ¤·â€â™€.

### [](#the-commonjs-case)æ™®é€šæ¡ˆä»¶

å®Œæ•´çš„æµ‹è¯•å’Œæµ‹è¯•ä»£ç åœ¨[examples/intercept-imports-cjs](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/intercept-imports-cjs)ä¸­ã€‚

ç›¸å…³ç‰‡æ®µå¦‚ä¸‹:

```
jest.mock('./db', () => ({
get: jest.fn(),
set: jest.fn()
}));
const mockDb = require('./db');
const {addTodo, getTodo} = require('./lib');
test('CommonJS > addTodo > inserts with new id', async () => {
await addTodo({name: 'new todo'});
expect(mockDb.set).toHaveBeenCalledWith('todos:1', {name: 'new todo', id: 1});
});
test('CommonJS > getTodo > returns output of db.get', async () => {
mockDb.get.mockResolvedValueOnce({
id: 1,
name: 'todo-1'
});
const expected = {
id: 1,
name: 'todo-1'
};
const actual = await getTodo(1);
expect(mockDb.get).toHaveBeenCalledWith('todos:1');
expect(actual).toEqual(expected);
}); 
```

### [](#es-modules-default-export)ES æ¨¡å—é»˜è®¤å¯¼å‡º

å®Œæ•´çš„æµ‹è¯•å’Œæµ‹è¯•ä»£ç åœ¨[examples/intercept-imports-ESM-default](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/intercept-imports-esm-default)ä¸­ã€‚

```
import mockDb from './db';
import lib from './lib';
jest.mock('./db', () => ({
get: jest.fn(),
set: jest.fn()
}));
const {addTodo, getTodo} = lib;
test('ESM Default Export > addTodo > inserts with new id', async () => {
await addTodo({name: 'new todo'});
expect(mockDb.set).toHaveBeenCalledWith('todos:1', {name: 'new todo', id: 1});
});
test('ESM Default Export > getTodo > returns output of db.get', async () => {
mockDb.get.mockResolvedValueOnce({
id: 1,
name: 'todo-1'
});
const expected = {
id: 1,
name: 'todo-1'
};
const actual = await getTodo(1);
expect(mockDb.get).toHaveBeenCalledWith('todos:1');
expect(actual).toEqual(expected);
}); 
```

### [](#es-modules-named-export)ES æ¨¡å—å‘½åå¯¼å‡º

å®Œæ•´çš„æµ‹è¯•å’Œè¢«æµ‹ä»£ç ä½äº[examples/intercept-imports-ESM-named](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/intercept-imports-esm-named)ã€‚

```
import * as mockDb from './db';
import {addTodo, getTodo} from './lib';
jest.mock('./db', () => ({
get: jest.fn(),
set: jest.fn()
}));
test('ESM named export > addTodo > inserts with new id', async () => {
await addTodo({name: 'new todo'});
expect(mockDb.set).toHaveBeenCalledWith('todos:1', {name: 'new todo', id: 1});
});
test('ESM named export > getTodo > returns output of db.get', async () => {
mockDb.get.mockResolvedValueOnce({
id: 1,
name: 'todo-1'
});
const expected = {
id: 1,
name: 'todo-1'
};
const actual = await getTodo(1);
expect(mockDb.get).toHaveBeenCalledWith('todos:1');
expect(actual).toEqual(expected);
}); 
```

## [](#spyingstubbing-calls-to-internal-module-functions)åˆºæ¢/å­˜æ ¹å¯¹å†…éƒ¨æ¨¡å—å‡½æ•°çš„è°ƒç”¨

> è­¦å‘Š:ä½ ä¸åº”è¯¥åˆºæ¢/å­˜æ ¹æ¨¡å—å†…éƒ¨ï¼Œé‚£æ˜¯ä½ çš„æµ‹è¯•æ·±å…¥åˆ°å®ç°ä¸­ï¼Œè¿™æ„å‘³ç€æµ‹è¯•å’Œè¢«æµ‹ä»£ç æ˜¯ç´§å¯†è€¦åˆçš„

æ¦‚å¿µ:â€œå‘¼é€šâ€(ä¸å˜²è®½ç›¸å¯¹)ã€‚

æ²¡æœ‰è¢«å¯¼å‡ºçš„å†…éƒ¨/ç§æœ‰/è¾…åŠ©å‡½æ•°åº”è¯¥é€šè¿‡å®ƒçš„å…¬å…±æ¥å£æ¥æµ‹è¯•ï¼Œä¾‹å¦‚ã€‚ä¸æ˜¯é€šè¿‡è°ƒç”¨å®ƒï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¢«å¯¼å‡ºï¼Œè€Œæ˜¯é€šè¿‡è°ƒç”¨è°ƒç”¨å®ƒçš„å‡½æ•°ã€‚

æµ‹è¯•å…¶åŠŸèƒ½æ˜¯æ¶ˆè´¹æ‰€è¿°åŠ©æ‰‹çš„åŠŸèƒ½çš„æµ‹è¯•çš„è´£ä»»ã€‚

è¿™é€‚ç”¨äºä»¥ä¸‹æƒ…å†µ:

*   ä½ æ²¡æœ‰æ—¶é—´æå–å‡½æ•°ï¼Œä½†æ˜¯å¤æ‚åº¦å¤ªé«˜ï¼Œæ— æ³•æµ‹è¯•(ä»è¢«æµ‹å‡½æ•°åˆ°å†…éƒ¨å‡½æ•°)
    *   è§£å†³æ–¹æ¡ˆ:ä½ å¯èƒ½åº”è¯¥*åˆ©ç”¨*æ—¶é—´
*   å†…éƒ¨å‡½æ•°å±äºæ‰€è¿°æ¨¡å—ï¼Œä½†æ˜¯å®ƒçš„å¤æ‚æ€§ä½¿å®ƒéš¾ä»¥æµ‹è¯•ã€‚
    *   è§£å†³æ–¹æ¡ˆ:æ‚¨å¯èƒ½åº”è¯¥æå–å®ƒ
*   è¿™ä¸ªå‡½æ•°ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„å†…éƒ¨å‡½æ•°ï¼Œå®ƒè¢«å¯¼å‡ºå¹¶ç»è¿‡å•å…ƒæµ‹è¯•ï¼Œforce è°ƒç”¨ä¼šé‡å¤æµ‹è¯•ã€‚
    *   è§£å†³æ–¹æ¡ˆ:ä½ ä¸€å®šè¦æŠŠå®ƒæå–å‡ºæ¥

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†å¯»æ‰¾ stub/mock/spy å†…éƒ¨çš„`makeKey`å‡½æ•°ã€‚è¿™çº¯ç²¹æ˜¯å‡ºäºå­¦æœ¯ç›®çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»å±•ç¤ºäº†å¦‚ä½•é€šè¿‡è°ƒç”¨`getTodo`è¿›è¡Œ**æµ‹è¯•ã€‚**

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ­£åœ¨æµ‹è¯•`expect(mockDb.get).toHaveBeenCalledWith('todos:1');`(å‚è§[examples/intercept-imports-cjs/lib . jest-test . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/intercept-imports-cjs/lib.jest-test.js))ã€‚`todos:1`é”®çš„ç”Ÿæˆæ˜¯`makeKey`çš„åŠŸèƒ½ï¼Œè¿™æ˜¯é€šè¿‡**è°ƒç”¨**è¿›è¡Œæµ‹è¯•çš„ä¸€ä¸ªä¾‹å­ã€‚

### [](#commonjs)CommonJS

#### [](#a-module-where-internal-functions-cant-be-mocked)å†…éƒ¨å‡½æ•°ä¸å¯æ¨¡ä»¿çš„æ¨¡å—

ä»£ç æ¸…å•æ‘˜è‡ª[examples/spy-internal-calls-cjs/lib . fail . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-cjs/lib.fail.js)ã€‚

```
const db = require('./db');
const keyPrefix = 'todos';
const makeKey = key => `${keyPrefix}:${key}`;
function getTodo(id) {
return db.get(makeKey(id));
}
module.exports = {
makeKey,
getTodo
}; 
```

æ­£å¦‚æ‚¨åœ¨è¿è¡Œ[examples/spy-internal-calls-cjs/lib . fail . jest-test . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-cjs/lib.fail.jest-test.js)æµ‹è¯•æ—¶æ‰€çœ‹åˆ°çš„ï¼Œæ²¡æœ‰åŠæ³•æ‹¦æˆªå¯¹`makeKey`çš„è°ƒç”¨ã€‚

#### [](#a-module-where-internal-function-can-be-mocked)ä¸€ä¸ªå†…éƒ¨å‡½æ•°*å¯ä»¥è¢«*æ¨¡ä»¿çš„æ¨¡å—

ä»£ç æ¸…å•æ‘˜è‡ª[examples/spy-internal-calls-cjs/lib . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-cjs/lib.js)ã€‚

```
const db = require('./db');
const keyPrefix = 'todos';
const makeKey = key => `${keyPrefix}:${key}`;
const lib = {
// Could also define makeKey inline like so:
 // makeKey(key) { return `${keyPrefix}:${key}` },
 makeKey,
getTodo(id) {
return db.get(lib.makeKey(id));
}
};
module.exports = lib; 
```

#### [](#mockingspying-the-internal-function)å˜²è®½/åˆºæ¢å†…éƒ¨åŠŸèƒ½

ä»£ç æ¸…å•æ‘˜è‡ª[examples/spy-internal-calls-cjs/lib . jest-test . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-cjs/lib.jest-test.js)

```
// ignore setup code
test("CommonJS > Mocking destructured makeKey doesn't work", async () => {
const mockMakeKey = jest.fn(() => 'mock-key');
makeKey = mockMakeKey;
await getTodo(1);
expect(makeKey).not.toHaveBeenCalled();
expect(mockDb.get).not.toHaveBeenCalledWith('mock-key');
});
test('CommonJS > Mocking lib.makeKey works', async () => {
const mockMakeKey = jest.fn(() => 'mock-key');
lib.makeKey = mockMakeKey;
await getTodo(1);
expect(mockMakeKey).toHaveBeenCalledWith(1);
expect(mockDb.get).toHaveBeenCalledWith('mock-key');
});
test('CommonJS > Spying lib.makeKey works', async () => {
const makeKeySpy = jest
.spyOn(lib, 'makeKey')
.mockImplementationOnce(() => 'mock-key');
await getTodo(1);
expect(makeKeySpy).toHaveBeenCalled();
expect(mockDb.get).toHaveBeenCalledWith('mock-key');
}); 
```

ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ‰äº†ä¸Šä¸€èŠ‚çš„è®¾ç½®(å‚è§[examples/spy-internal-calls-cjs/lib . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-cjs/lib.js))ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥ç”¨ä¸€ä¸ª mock æ›¿æ¢`lib.makeKey`çš„å®ç°ï¼Œåˆå¯ä»¥å¯¹å…¶è¿›è¡Œçª¥æ¢ã€‚

æˆ‘ä»¬ä»ç„¶æ— æ³•æ›¿æ¢å¯¹å®ƒçš„å¼•ç”¨ã€‚è¿™æ˜¯å› ä¸ºå½“æˆ‘ä»¬ææ„`lib`æ¥æå–`makeKey`æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºäº†å¼•ç”¨ ie çš„å‰¯æœ¬ã€‚`makeKey = newValue`æ”¹å˜äº†æˆ‘ä»¬æµ‹è¯•æ–‡ä»¶ä¸­çš„`makeKey`å˜é‡çš„å®ç°ï¼Œä½†æ˜¯æ²¡æœ‰æ›¿æ¢`lib.makeKey`çš„è¡Œä¸º(è¿™æ˜¯`getTodo`æ­£åœ¨è°ƒç”¨çš„)ã€‚

ä¸¾ä¾‹è¯´æ˜:

```
const lib = require('./lib');
let {makeKey} = lib;
makeKey = 'something';
// `lib.makeKey` and `makeKey` are now different... 
```

### [](#es-modules)ES æ¨¡å—

#### [](#difficulty-of-named-exports)å‘½åå‡ºå£çš„éš¾åº¦

åœ¨ ES6 æ¨¡å—çš„æƒ…å†µä¸‹ï¼Œä»è¯­ä¹‰ä¸Šæ¥è¯´ï¼Œå¾ˆéš¾ç”¨å‘½åå¯¼å‡ºçš„æ–¹å¼è®¾ç½®ä»£ç ï¼Œä¸‹é¢çš„ä»£ç ä¸å¤ªé€‚ç”¨:

```
import db from './db';
const keyPrefix = 'todos';
export const makeKey = key => `${keyPrefix}:${key}`;
export function getTodo(id) {
return db.get(makeKey(id));
} 
```

ä»£ç æ¸…å•æ‘˜è‡ª[examples/spy-internal-calls-ESM/lib . named-export . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-esm/lib.named-export.js)ï¼Œæµ‹è¯•æ˜¾ç¤ºæ²¡æœ‰ç®€å•çš„æ–¹æ³•æ¥æ¨¡ä»¿/çª¥æ¢`makeKey`ä½äº[examples/spy-internal-calls-ESM/lib . named-export . jest-test . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-esm/lib.named-export.jest-test.js)

#### [](#unmockeable-modules-with-default-exports)é»˜è®¤å¯¼å‡ºçš„ä¸å¯æ‹†æ¨¡å—

ä»£ç åˆ—è¡¨æ‘˜è‡ª[examples/spy-internal-calls-ESM/lib . default-export . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-esm/lib.default-export.js)ã€‚

```
import db from './db';
const keyPrefix = 'todos';
const makeKey = key => `${keyPrefix}:${key}`;
function getTodo(id) {
return db.get(makeKey(id));
}
const lib = {
makeKey,
getTodo
};
export default lib; 
```

æµ‹è¯•æ˜¾ç¤ºæ²¡æœ‰ç®€å•çš„æ–¹æ³•æ¥æ¨¡ä»¿/çª¥æ¢`makeKey`åœ¨[examples/spy-internal-calls-ESM/lib . default-export . jest-test . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-esm/lib.default-export.jest-test.js)ã€‚

è¿™ä¸èµ·ä½œç”¨çš„åŸå› ä¸ CommonJS ç¤ºä¾‹ç›¸åŒï¼Œ`makeKey`è¢«ç›´æ¥å¼•ç”¨ï¼Œå¹¶ä¸”è¯¥å¼•ç”¨ä¸èƒ½ä»æ¨¡å—å¤–éƒ¨ä¿®æ”¹ã€‚

ä»»ä½•è¯•å›¾å¯¼å…¥å®ƒçš„ä¸œè¥¿éƒ½ä¼šå¤åˆ¶ä¸€ä»½ï¼Œå› æ­¤ä¸ä¼šä¿®æ”¹å†…éƒ¨å¼•ç”¨ã€‚

#### ESM æ¨¡æ‹Ÿ/é—´è°è®¾ç½®

ä»£ç æ¸…å•æ‘˜è‡ª[ç¤ºä¾‹/spy-internal-calls-ESM/lib . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-esm/lib.js)

```
import db from './db';
const keyPrefix = 'todos';
const makeKey = key => `${keyPrefix}:${key}`;
const lib = {
// Could also define makeKey inline like so:
 // makeKey(key) { return `${keyPrefix}:${key}` },
 makeKey,
getTodo(id) {
return db.get(lib.makeKey(id));
}
};
export default lib; 
```

é€šè¿‡ä¸Šè¿°æµ‹è¯•ä½äº[examples/spy-internal-calls-ESM/lib . jest-test . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-internal-calls-esm/lib.jest-test.js)

**æ³¨æ„**ï¼Œå¯ä»¥å¯¹æŒ‡å®šçš„å‡ºå£åšç±»ä¼¼çš„äº‹æƒ…:

```
import db from './db';
const keyPrefix = 'todos';
const makeKey = key => `${keyPrefix}:${key}`;
export const lib = {
// Could also define makeKey inline like so:
 // makeKey(key) { return `${keyPrefix}:${key}` },
 makeKey,
getTodo(id) {
return db.get(lib.makeKey(id));
}
}; 
```

å…³é”®ç‚¹åœ¨äºå¯¼å‡ºä¸€ä¸ª`lib`å¯¹è±¡ï¼Œå¹¶åœ¨è°ƒç”¨`makeKey`æ—¶å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡ã€‚

### [](#mocking-internals-is-the-same-with-esmcommonjs)æ¨¡æ‹Ÿå†…éƒ¨ä¸ ESM/CommonJS ç›¸åŒ

èƒ½å¤Ÿæ¨¡ä»¿æ¨¡å—çš„ä¸€éƒ¨åˆ†å®Œå…¨æ˜¯å…³äºå¼•ç”¨çš„ã€‚

å¦‚æœä¸€ä¸ªå‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°æ—¶ä½¿ç”¨äº†ä¸€ä¸ªä»æ¨¡å—å¤–éƒ¨(æ›´ç¡®åˆ‡åœ°è¯´æ˜¯ä»æˆ‘ä»¬çš„æµ‹è¯•ä¸­)æ— æ³•è®¿é—®çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ— æ³•è¢«æ¨¡ä»¿çš„ã€‚

## [](#spy-on-imports-or-mock-part-of-a-module-by-referencing-the-module)é€šè¿‡â€œå¼•ç”¨æ¨¡å—â€æ¥çª¥æ¢æ¨¡å—çš„å¯¼å…¥æˆ–æ¨¡ä»¿éƒ¨åˆ†

> è­¦å‘Š:è¿™å°†å¯¼è‡´ä½ æ”¹å˜ä½ å†™ä»£ç çš„æ–¹å¼æ¥é€‚åº”ç‰¹å®šç±»å‹çš„æµ‹è¯•ã€‚
> 
> å¦‚æœæœ‰äººå†³å®šè·å–æ¨¡å—å‡½æ•°çš„å‰¯æœ¬ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨`module.fn()`ï¼Œè¿™å°†ä¼šè¢«æ‰“ç ´ã€‚

### [](#commonjs-spy-importmock-part-of-a-module-with-jest)CommonJS:ç”¨ Jest çª¥æ¢å¯¼å…¥/æ¨¡ä»¿æ¨¡å—çš„ä¸€éƒ¨åˆ†

ä»£ç æ¸…å•æ‘˜è‡ª[examples/spy-module-cjs/lib . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-module-cjs/lib.js)ã€‚

è¯·æ³¨æ„`db`æ¨¡å—æ˜¯å¦‚ä½•åœ¨æ²¡æœ‰ææ„çš„æƒ…å†µä¸‹å¯¼å…¥çš„ï¼Œä»¥åŠå¯¹å®ƒçš„ä»»ä½•è°ƒç”¨æ˜¯å¦‚ä½•ä½¿ç”¨`db.method()`è°ƒç”¨å®Œæˆçš„ã€‚

```
const db = require('./db');
const keyPrefix = 'todos';
const makeKey = key => `${keyPrefix}:${key}`;
let autoId = 1;
async function addTodo(todo) {
const id = autoId++;
const insertable = {
...todo,
id
};
await db.set(makeKey(id), insertable);
}
function getTodo(id) {
return db.get(makeKey(id));
}
module.exports = {
addTodo,
getTodo
}; 
```

æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•æ¥ç›‘è§†`db.method`:

```
const db = require('./db');
const {addTodo, getTodo} = require('./lib');
beforeEach(() => jest.clearAllMocks());
test('CommonJS > addTodo > inserts with new id', async () => {
const dbSetSpy = jest.spyOn(db, 'set').mockImplementation(() => {});
await addTodo({name: 'new todo'});
expect(dbSetSpy).toHaveBeenCalledWith('todos:1', {name: 'new todo', id: 1});
});
test('CommonJS > getTodo > returns output of db.get', async () => {
const dbGetSpy = jest.spyOn(db, 'get').mockResolvedValueOnce({
id: 1,
name: 'todo-1'
});
const expected = {
id: 1,
name: 'todo-1'
};
const actual = await getTodo(1);
expect(dbGetSpy).toHaveBeenCalledWith('todos:1');
expect(actual).toEqual(expected);
}); 
```

æ³¨æ„æˆ‘ä»¬æ²¡æœ‰è°ƒç”¨`jest.mock()`ã€‚ç›¸åï¼Œå½“æˆ‘ä»¬éœ€è¦ä¿®æ”¹`db`æ¨¡å—å®ç°æ—¶ï¼Œæˆ‘ä»¬åªæ˜¯æ¨¡ä»¿/ç›‘è§†æ¨¡å—çš„ç‰¹å®šåŠŸèƒ½ã€‚

### [](#es6-modules-spy-importmock-part-of-a-module-with-jest)ES6 æ¨¡å—:ç”¨ Jest çª¥æ¢å¯¼å…¥/æ¨¡ä»¿æ¨¡å—çš„ä¸€éƒ¨åˆ†

#### [](#default-exports)é»˜è®¤å‡ºå£

å‡è®¾æˆ‘ä»¬çš„`db.js`æ¨¡å—ä»¥å¦‚ä¸‹æ–¹å¼å¯¼å‡º(å‚è§[examples/spy-module-ESM-default/db . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-module-esm-default/db.js)):

```
const data = {};
async function get(k) {
return data[k];
}
async function set(k, v) {
data[k] = v;
}
const db = {
get,
set
};
export default db; 
```

ç„¶åæˆ‘ä»¬å¯ä»¥å¦‚ä¸‹å¯¼å…¥å®ƒ(ä»£ç æ¸…å•æ‘˜è‡ª[examples/spy-module-ESM-default/lib . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-module-esm-default/lib.js)):

```
import db from './db';
const keyPrefix = 'todos';
const makeKey = key => `${keyPrefix}:${key}`;
let autoId = 1;
function addTodo(todo) {
const id = autoId++;
const insertable = {
...todo,
id
};
return db.set(makeKey(id), insertable);
}
function getTodo(id) {
return db.get(makeKey(id));
}
const lib = {
addTodo,
getTodo
};
export default lib; 
```

çª¥æ¢æ¨¡å—çš„å¯¼å…¥/æ¨¡ä»¿éƒ¨åˆ†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°(å®Œæ•´ä»£ç åœ¨[examples/spy-module-ESM-default/lib . jest-test . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-module-esm-default/lib.jest-test.js)):

```
import db from './db';
import lib from './lib';
const {addTodo, getTodo} = lib;
beforeEach(() => jest.clearAllMocks());
test('ESM Default Export > addTodo > inserts with new id', async () => {
const dbSetSpy = jest.spyOn(db, 'set').mockImplementationOnce(() => {});
await addTodo({name: 'new todo'});
expect(dbSetSpy).toHaveBeenCalledWith('todos:1', {name: 'new todo', id: 1});
});
test('ESM Default Export > getTodo > returns output of db.get', async () => {
const dbGetSpy = jest.spyOn(db, 'get').mockResolvedValueOnce({
id: 1,
name: 'todo-1'
});
const expected = {
id: 1,
name: 'todo-1'
};
const actual = await getTodo(1);
expect(dbGetSpy).toHaveBeenCalledWith('todos:1');
expect(actual).toEqual(expected);
}); 
```

æ³¨æ„æˆ‘ä»¬æ²¡æœ‰ç”¨ä¸€ä¸ª`jest.mock()`è°ƒç”¨æ¥æ¨¡æ‹Ÿ`db`æ¨¡å—ã€‚æˆ‘ä»¬å†æ¬¡ç›‘è§†æˆ‘ä»¬å¯¹ç‰¹å®šæµ‹è¯•æ„Ÿå…´è¶£çš„æ–¹æ³•ã€‚

æˆ‘ä»¬åˆ©ç”¨`mockImplementationOnce()`æ¥é¿å…è°ƒç”¨çœŸæ­£çš„å‡½æ•°(ä½ å¯èƒ½ä¸æ€»æ˜¯æƒ³è¿™ä¹ˆåš)ã€‚

#### [](#named-exports-import-as-alias-from-modulename)å‘½å exports+" import * as alias from ' module-name ' "

> æ³¨æ„:æˆ‘æ²¡æœ‰é˜…è¯»å®Œæ•´çš„è§„èŒƒï¼Œäº‹å®ä¸Šè¿™å¯èƒ½æ˜¯å·´åˆ«å¡” ES2015 æ¨¡å—ç¿»è¯‘çš„ä¸€ä¸ªæ€ªç™–

å‡è®¾æˆ‘ä»¬å·²ç»å¦‚ä¸‹å®šä¹‰äº†`db.js`(ä½¿ç”¨å‘½åå¯¼å‡ºï¼Œå‚è§[examples/spy-module-ESM-named/db . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-module-esm-named/db.js)ä¸­çš„æ–‡ä»¶):

```
const data = {};
export async function get(k) {
return data[k];
}
export async function set(k, v) {
data[k] = v;
} 
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ«å`import * as db from './db'`(ä»£ç æ¸…å•æ‘˜è‡ª[examples/spy-module-ESM-named/lib . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-module-esm-named/lib.js)):
å¯¼å…¥æ‰€æœ‰å‘½åçš„å¯¼å‡º

```
import * as db from './db';
const keyPrefix = 'todos';
const makeKey = key => `${keyPrefix}:${key}`;
let autoId = 1;
export function addTodo(todo) {
const id = autoId++;
const insertable = {
...todo,
id
};
return db.set(makeKey(id), insertable);
}
export function getTodo(id) {
return db.get(makeKey(id));
} 
```

å¯¹ db.set å’Œ db.get çš„è°ƒç”¨å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•è¿›è¡Œçª¥æ¢/æ¨¡ä»¿(å®Œæ•´ä»£ç æµ‹è¯•æ–‡ä»¶ä½äº[examples/spy-module-ESM-named/lib . jest-test . js](https://github.com/HugoDF/mock-spy-module-import/tree/master/examples/spy-module-esm-named/lib.jest-test.js)):

```
import * as db from './db';
import {addTodo, getTodo} from './lib';
beforeEach(() => jest.clearAllMocks());
test('ESM named export > addTodo > inserts with new id', async () => {
const dbSetSpy = jest.spyOn(db, 'set').mockImplementationOnce(() => {});
await addTodo({name: 'new todo'});
expect(dbSetSpy).toHaveBeenCalledWith('todos:1', {name: 'new todo', id: 1});
});
test('ESM named export > getTodo > returns output of db.get', async () => {
const dbGetSpy = jest.spyOn(db, 'get').mockResolvedValueOnce({
id: 1,
name: 'todo-1'
});
const expected = {
id: 1,
name: 'todo-1'
};
const actual = await getTodo(1);
expect(dbGetSpy).toHaveBeenCalledWith('todos:1');
expect(actual).toEqual(expected);
}); 
```

## [](#further-reading)è¿›ä¸€æ­¥é˜…è¯»

å¸¦æœ‰ç¤ºä¾‹çš„å­˜å‚¨åº“ä½äº[github.com/HugoDF/mock-spy-module-import](https://github.com/HugoDF/mock-spy-module-import)ã€‚

æŸ¥çœ‹æ›´å¤šå…³äº Hugo ä»£ç çš„[æµ‹è¯•](https://codewithhugo.com/tags/testing)å’Œ[ç¬‘è¯](https://codewithhugo.com/tags/jest)å¸–å­ã€‚

ä½ å¯ä»¥åœ¨[enterprise node . js å’Œ JavaScript æ—¶äº‹é€šè®¯æ¡£æ¡ˆ](https://buttondown.email/hugo/archive)ä¸­æ‰¾åˆ°æ›´å¤š Jest/testing/JavaScript å†…å®¹ã€‚

å…‹é‡Œæ–¯Â·è´å…‹å°”