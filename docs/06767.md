# ç”¨ React å’Œ GraphQL åˆ›å»ºä¸€ä¸ªæ— é™åŠ è½½åˆ—è¡¨

> åŸæ–‡ï¼š<https://dev.to/yvonnickfrin/create-an-infinite-loading-list-with-react-and-graphql-19hh>

*å•å±±å¾·Â·è¢åœ¨ Unsplash ä¸Šæ‹æ‘„çš„ç…§ç‰‡*

* * *

æœ¬å‘¨ï¼Œæˆ‘å¿…é¡»å®ç°ä¸€ä¸ªæ— é™åŠ è½½åˆ—è¡¨æ¥æ˜¾ç¤ºæˆ‘ä¸ºå½“å‰å®¢æˆ·å¼€å‘çš„ React åº”ç”¨ç¨‹åºä¸­çš„ç”¨æˆ·ã€‚æˆ‘ä»¥å‰å·²ç»åšè¿‡ï¼Œä½†ä»æœªä½¿ç”¨ GraphQL ä½œä¸ºæœåŠ¡å™¨éƒ¨åˆ†ã€‚æ˜¯æ—¶å€™å­¦ä¹ å¦‚ä½•å®ç° GraphQL è§„èŒƒä¸­æè¿°çš„[åˆ†é¡µæœºåˆ¶](https://graphql.org/learn/pagination/)äº†ã€‚

æ— é™åŠ è½½åˆ—è¡¨å¯¹äºå°†å¤§é‡æ•°æ®åˆ†è§£æˆå°å—éå¸¸æœ‰ç”¨ï¼Œå½“ç”¨æˆ·å‘ä¸‹æ»šåŠ¨åˆ—è¡¨æ—¶å¯ä»¥åŠ è½½è¿™äº›å°å—ã€‚ [dev.to](https://dev.to/) çš„é¦–é¡µå°±æ˜¯è¿™ç§åˆ—è¡¨çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚å®ƒä¸ºç”¨æˆ·èŠ‚çœäº†ä¸€æ•´é¡µçš„å·¥ä½œé‡ã€‚å®ƒè¿˜åœ¨ç§»åŠ¨åº”ç”¨ç¨‹åºä¸­æä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

<figure>![Infinite loading list of persons](img/e5b8328928f227745fd17b6d4cd4def5.png)

<figcaption>*We will create a infinite loading list of persons. You can see data loading as the user scrolls down the list.*</figcaption>

</figure>

## æœ¬æ–‡æ¶µç›–çš„å†…å®¹

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°å¦‚ä½•ä½¿ç”¨ [Apollo Server](https://www.apollographql.com/docs/apollo-server/) åœ¨ GraphQL ç«¯å®ç°åˆ†é¡µã€‚æˆ‘ä»¬ä¸ä¼šè®¨è®ºæœåŠ¡å™¨çš„è®¾ç½®ï¼Œä½†æ˜¯ä½ å¯ä»¥åœ¨æˆ‘å†™çš„[ä¸Šä¸€ç¯‡æ–‡ç« ](https://dev.to/yvonnickfrin/mock-your-graphql-server-realistically-with-faker-js-25oo)ä¸­æ‰¾åˆ°å¦‚ä½•ç”¨ Koa è®¾ç½®æœåŠ¡å™¨ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨ React ç«¯ä½¿ç”¨æœ€è¿‘æ·»åŠ åˆ° [Apollo å®¢æˆ·ç«¯](https://www.apollographql.com/docs/react/)çš„[é’©å­](https://blog.apollographql.com/apollo-client-now-with-react-hooks-676d116eeae2)æ¶ˆè´¹ä¸€ä¸ªåˆ†é¡µæŸ¥è¯¢ã€‚

æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [Brian Vaughn](https://github.com/bvaughn) çš„åº“ [react-window](https://github.com/bvaughn/react-window) å®ç°æ— é™åŠ è½½åˆ—è¡¨ã€‚

## åˆ†é¡µ

æˆ‘ä»¬æƒ³æ˜¾ç¤ºä¸€ä¸ªäººå‘˜åˆ—è¡¨ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æ•°æ®æ¨¡å‹ï¼Œä¸€ä¸ªäººæœ‰ä¸€ä¸ª`firstname`å’Œä¸€ä¸ª`lastname`ã€‚è¿™å°†è¶³ä»¥è¯´æ˜æˆ‘ä»¬æ­£åœ¨å®æ–½ä»€ä¹ˆã€‚

```
type Person {
    id: ID,
    lastname: String,
    firstname: String,
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç®€å•çš„éƒ¨åˆ†å·²ç»å®Œæˆäº†ã€‚ç°åœ¨æ˜¯æœ€éš¾çš„ï¼Œåˆ†é¡µã€‚æœ‰å¤šç§åˆ†é¡µæ–¹å¼ã€‚æ‚¨å¯èƒ½çŸ¥é“ä½¿ç”¨é¡µé¢ç´¢å¼•å’Œå…ƒç´ åç§»é‡çš„åŸºäºé¡µé¢çš„åˆ†é¡µã€‚ä½†æ˜¯è¿™ç§åˆ†é¡µæ¨¡å‹æœ‰ä¸€äº›å¸¸è§åœºæ™¯ä¸­ä¼šé‡åˆ°çš„é™åˆ¶ã€‚ä½ å¯ä»¥ä»[çš„ Caleb Meredith](https://twitter.com/calebmer) çš„è¿™ç¯‡[æ–‡ç« ](https://blog.apollographql.com/explaining-graphql-connections-c48b7c3d6976)ä¸­äº†è§£æ›´å¤šã€‚

æˆ‘ä»¬å°†ä½¿ç”¨åŸºäºå…‰æ ‡çš„åˆ†é¡µã€‚

å…¶åŸç†åœ¨äºï¼Œæ¸¸æ ‡æ˜¯åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒæ˜¯è¿™ä¸ªäººçš„ id(ä½†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä»»ä½•ä¸œè¥¿)ã€‚

æˆ‘ç›¸ä¿¡ä¸¾ä¾‹æ˜¯æœ€å¥½çš„ç†è§£æ–¹å¼ã€‚è®©æˆ‘ä»¬æŠ›å‡ºä¸€ç³»åˆ—æŸ¥è¯¢æ¥åŠ è½½å‰ä¸¤ä¸ªäººå‘˜å—ã€‚

```
persons(first: 10) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒå°†è¿”å›å‰åä¸ªäººã€‚æ¯ä¸ªäººéƒ½æœ‰ä¸€ä¸ªå…‰æ ‡ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æœ€åæå–çš„äººå‘˜çš„å…‰æ ‡å†æ¬¡æŸ¥è¯¢ GraphQL æœåŠ¡å™¨ï¼Œå¹¶è·å¾—ä¸€ä¸ªæ–°çš„äººå‘˜å—ã€‚

```
persons(first: 10, cursor: "ZmY3OTI0YWMtYTY0Ny00NTIyLWE2ZjEtNzJmMTNhN2E3NjAx") 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒå°†è¿”å›æˆ‘ä»¬è·å–çš„æœ€åä¸€ä¸ªäººä¹‹åçš„åä¸ªäººã€‚

åœ¨ GraphQL ä¸­ï¼Œåˆ†é¡µæŸ¥è¯¢è¿”å›ä¸€ä¸ª`connection`ã€‚

```
type Query {
    persons(first: Int!, cursor: ID): PersonConnection
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

A `connection`è®©æ‚¨æä¾›æ¯”æŸ¥è¯¢å…ƒç´ æ›´å¤šçš„ä¿¡æ¯ã€‚æ¯”å¦‚ä¸å½“å‰é¡µé¢ç›¸å…³çš„å…ƒç´ æˆ–ä¿¡æ¯çš„æ€»æ•°ã€‚

```
type PersonConnection {
    edges: [PersonEdge]
    pageInfo: PageInfo
}

type PageInfo {
    endCursor: ID!,
    hasNextPage: Boolean!,
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…ƒç´ çš„é›†åˆå­˜å‚¨åœ¨ä¸€ä¸ª`edges`å±æ€§ä¸­ã€‚ä¸€ä¸ª`edge`ç”±æˆ‘ä»¬å‰é¢è°ˆåˆ°çš„å…‰æ ‡å’Œä¸€ä¸ªåŒ…å«ä¸åˆ—è¡¨å…ƒç´ ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯çš„`node`ç»„æˆã€‚å› ä¸ºå…‰æ ‡ä¸ç›´æ¥åœ¨`Person`ä¸­ï¼Œæ‰€ä»¥å®ƒè®©æˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°æ”¹å˜æˆ‘ä»¬çš„æœåŠ¡å™¨å®ç°ï¼Œè€Œä¸ä¼šå½±å“æ•°æ®æ¨¡å‹ã€‚å®ƒè¿˜å¢åŠ äº†å¢å¼º edge æºå¸¦çš„ä¿¡æ¯çš„å¯èƒ½æ€§ï¼Œæ¯”å¦‚æ·»åŠ ä¸€ä¸ª`relations`å±æ€§ï¼Œåˆ—å‡ºä¸è¿™ä¸ªäººæœ‰è”ç³»çš„äººã€‚

```
type PersonEdge {
    cursor: ID!,
    node: Person!,
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ˜¯æ—¶å€™ä¸ºæˆ‘ä»¬çš„`persons`æŸ¥è¯¢å®ç°è§£æå™¨äº†ã€‚æˆ‘ä»¬ä½¿ç”¨ faker æ¥ç”Ÿæˆéšæœºæ•°æ®å¹¶æä¾›ä¸€ä¸ªç§å­ï¼Œè¿™æ ·äººä»¬å°±ä¸ä¼šåœ¨æ¯æ¬¡è¯·æ±‚ä¹‹é—´æ”¹å˜ã€‚

```
const range = (size, callback) => {
  return Array.from({length: size}, callback);
};

const resolvers = {
  Query: {
    persons: (query, {cursor, first}) => {
      faker.seed(123);
      const persons = range(200, () => ({
        id: random.uuid(),
        firstname: name.firstName(),
        lastname: name.lastName(),
      }));

      const cursorIndex = !cursor
        ? 0
        : persons.findIndex(person => person.id === cursor) + 1;
      const sliceOfPersons = persons.slice(cursorIndex, cursorIndex + first);

      return {
        edges: sliceOfPersons.map(person => ({
          cursor: person.id,
          node: {...person},
        })),
        pageInfo: {
          endCursor: sliceOfPersons[sliceOfPersons.length - 1].id,
          hasNextPage: cursorIndex + first < persons.length,
        },
      };
    },
  },
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæ²¡æœ‰æä¾› cursor å‚æ•°ï¼Œæˆ‘ä»¬å°†åœ¨æ•°ç»„çš„å¼€å¤´åˆ›å»ºä¸€ä¸ªç”±`first`å‚æ•°å†³å®šçš„ä¸€å®šæ•°é‡çš„å…ƒç´ çš„åˆ‡ç‰‡ã€‚å¦‚æœæä¾›äº†`cursor`å‚æ•°ï¼Œæˆ‘ä»¬å°†åœ¨æ•°ç»„ä¸­æ‰¾åˆ° person çš„ç´¢å¼•ï¼Œå¹¶åœ¨è¯¥ç´¢å¼•å¤„åˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡ã€‚

æˆ‘ä»¬ä¸ä¼šå¿˜è®°é€šè¿‡ç”¨åˆ‡ç‰‡ä¸­æœ€åä¸€ä¸ªäººçš„`index`è®¾ç½®`endCursor`å±æ€§æ¥æä¾›ä¸å½“å‰é¡µé¢ç›¸å…³çš„ä¿¡æ¯ã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ª`hastNextPage`å±æ€§ï¼Œé€šçŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥æŸ¥è¯¢æ›´å¤šçš„äººã€‚

æˆ‘ä»¬ç°åœ¨å·²ç»å®Œæˆäº†æœåŠ¡å™¨éƒ¨åˆ†ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ GraphQL playground æµ‹è¯•æ‚¨çš„æŸ¥è¯¢ã€‚åœ¨ Apollo æœåŠ¡å™¨å®ç°ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒåœ¨ GraphQL ç«¯ç‚¹ä¸Šå¯ç”¨ã€‚åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­æ‰“å¼€ä»¥ä¸‹ url `http://localhost:4000/graphl`å¹¶é”®å…¥æ­¤æŸ¥è¯¢(è¯¥ url å–å†³äºæ‚¨åœ¨æœåŠ¡å™¨ä¸­é…ç½®çš„ç«¯ç‚¹):

```
{
  persons(first: 10) {
    edges {
      node {
        lastname
        firstname
      }
    }
    pageInfo {
      endCursor
      hasNextPage
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬åº”è¯¥ä¼šåœ¨å³ä¾§é¢æ¿ä¸Šçœ‹åˆ°ä¸€ä¸ªäººå‘˜åˆ—è¡¨ã€‚

## ä» Apollo å®¢æˆ·ç«¯ä½¿ç”¨é’©å­æ¶ˆè´¹æŸ¥è¯¢

æˆ‘åœ¨ React åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨äº†`create-react-app`ã€‚æˆ‘å°†ä½¿ç”¨ä¸‹é¢çš„æ–‡ä»¶å¤¹ç»“æ„:

```
.
â”œâ”€â”€ package.json
â””â”€â”€ src
 Â Â  â”œâ”€â”€ App.css
 Â Â  â”œâ”€â”€ App.js
 Â Â  â”œâ”€â”€ App.test.js
 Â Â  â”œâ”€â”€ InfiniteList.css
 Â Â  â”œâ”€â”€ InfiniteList.hooks.js
 Â Â  â”œâ”€â”€ InfiniteList.js
 Â Â  â”œâ”€â”€ index.css
 Â Â  â””â”€â”€ index.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… Apollo å®¢æˆ·ç«¯ä¾èµ–é¡¹ã€‚

```
yarn add apollo-boost @apollo/react-hooks graphql 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æ–‡ä»¶`App.js`ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`apollo-boost`å®ä¾‹åŒ–äº†ä¸€ä¸ª Apollo å®¢æˆ·ç«¯ï¼Œå¹¶å°†å…¶ä»`@apollo/react-hooks`ä¼ é€’ç»™ä¸€ä¸ª`Provider`ã€‚

```
import React from 'react';
import ApolloClient from 'apollo-boost';
import {ApolloProvider} from '@apollo/react-hooks';

import InfiniteList from './InfiniteList';

import './App.css';

const client = new ApolloClient({
  uri: 'http://localhost:4000/graphql',
});

function App() {
  return (
    <ApolloProvider client={client}>
      <div className="App">
        <InfiniteList />
      </div>
    </ApolloProvider>
  );
}

export default App; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘å–œæ¬¢å°†æ•°æ®æå–é€»è¾‘ä¸å‘ˆç°é€»è¾‘åˆ†å¼€ã€‚æˆ‘ä»¬å°†åœ¨æ–‡ä»¶`InfiniteList.hooks.js`ä¸­åˆ›å»ºä¸€ä¸ªã€è‡ªå®šä¹‰é’©å­ã€‘ã€‚

æˆ‘ä»¬ç”¨ GraphQL æŸ¥è¯¢åˆ›å»ºä¸€ä¸ªå¸¸é‡ã€‚

```
import {gql} from 'apollo-boost';

const GET_PERSONS = gql`
  query getPersons($cursor: ID) {
    persons(first: 20, cursor: $cursor) {
      edges {
        node {
          lastname
          firstname
        }
      }
      pageInfo {
        endCursor
        hasNextPage
      }
    }
  }
`; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º`usePersons`çš„å®šåˆ¶é’©å­ï¼Œå®ƒå°†è¿”å›å®ç°æ— é™åŠ è½½åˆ—è¡¨æ‰€éœ€çš„æ‰€æœ‰å˜é‡ã€‚ä¸ºäº†è°ƒç”¨æˆ‘ä»¬çš„æŸ¥è¯¢ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¥è‡ª`@apollo/react-hooks`çš„`useQuery`é’©å­ã€‚å®ƒå°†æŸ¥è¯¢å’Œé€‰é¡¹ä½œä¸ºå‚æ•°ã€‚æˆ‘ä»¬å°†`notifyOnNetworkStatusChange`é€‰é¡¹æŒ‡å®šä¸º trueï¼Œè¿™æ ·æ¯æ¬¡è°ƒç”¨æŸ¥è¯¢æ—¶`loading`å˜é‡éƒ½ä¼šæ›´æ–°ã€‚

```
import {useQuery} from '@apollo/react-hooks';

// ...

function usePersons() {
  const {data, loading, fetchMore} = useQuery(GET_PERSONS, {
    notifyOnNetworkStatusChange: true,
  });

  if (loading && !data.persons) return {loading, persons: []};

  const loadMore = () => {
    return fetchMore({
      query: GET_PERSONS,
      notifyOnNetworkStatusChange: true,
      variables: {
        cursor: data.persons.pageInfo.endCursor,
      },
      updateQuery: (previousResult, {fetchMoreResult}) => {
        const newEdges = fetchMoreResult.persons.edges;
        const pageInfo = fetchMoreResult.persons.pageInfo;

        return newEdges.length
          ? {
              persons: {
                __typename: previousResult.persons.__typename,
                edges: [...previousResult.persons.edges, ...newEdges],
                pageInfo,
              },
            }
          : previousResult;
      },
    });
  };

  return {
    persons: data.persons.edges.map(({node}) => node),
    hasNextPage: data.persons.pageInfo.hasNextPage,
    loading,
    loadMore,
  };
}

export default usePersons; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`useQuery`è¿”å›ä¸€ä¸ª`fetchMore`å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ¯æ¬¡å‘ä¸‹æ»šåŠ¨åˆ—è¡¨æ—¶ä½¿ç”¨ã€‚æˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ª`loadMore`å‡½æ•°ï¼Œç”¨æˆ‘ä»¬å‰é¢è§£é‡Šè¿‡çš„æœ€åä¸€ä¸ªäººçš„å…‰æ ‡æ¥è°ƒç”¨`fetchMore`ã€‚`updateQuery`é€‰é¡¹è®©æˆ‘ä»¬æè¿°å¦‚ä½•å¤„ç†æ–°è·å–çš„å¤§é‡äººå‘˜ã€‚æˆ‘ä»¬æŠŠæ–°çš„è¾¹å’Œä»¥å‰çš„è¾¹åˆå¹¶èµ·æ¥ã€‚

## å®ç°æ— é™åŠ è½½åˆ—è¡¨

æˆ‘ä»¬å°†ä½¿ç”¨`react-window`æ¥å®ç°æ˜¾ç¤ºæ— é™åŠ è½½åˆ—è¡¨çš„ç»„ä»¶ã€‚æˆ‘ä»¬åœ¨åšä¹‹å‰å®‰è£…ä¾èµ–é¡¹ã€‚

```
yarn add react-window react-window-infinite-loader react-virtualized-auto-sizer 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…³äºè¿™äº›ä¾èµ–æ€§çš„ä¸€äº›è§£é‡Šæ˜¯å¿…è¦çš„ã€‚ç”¨äºé«˜æ•ˆæ˜¾ç¤ºå¤§å‹åˆ—è¡¨ã€‚å®ƒåªä¸ºå¯è§å…ƒç´ å’Œé‡ç”¨èŠ‚ç‚¹åˆ›å»ºç»„ä»¶ã€‚

`react-window-infinite-loader`æ˜¯ä¸€ä¸ªåœ¨ç”¨æˆ·å‘ä¸‹æ»šåŠ¨åˆ—è¡¨æ—¶åŠæ—¶åŠ è½½å…ƒç´ çš„ç‰¹è®¾ç»„ä»¶ï¼Œ`react-virtualized-auto-sizer`æ˜¯ä¸€ä¸ªå°çš„é™„åŠ ç»„ä»¶ï¼Œå¯ä»¥å¸®åŠ©ä½ æ˜¾ç¤ºåˆ—è¡¨ï¼Œä½¿å…¶é€‚åˆçˆ¶å®¹å™¨ä¸­çš„å¯ç”¨ç©ºé—´ã€‚

æ‰€æœ‰è¿™äº›å·¥å…·éƒ½æ˜¯ç”±å¸ƒè±æ©Â·æ²ƒæ©åˆ¶é€ çš„ã€‚ä»–ä»¬å®Œç¾åœ°é…åˆåœ¨ä¸€èµ·ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è°ƒç”¨è‡ªå®šä¹‰é’©å­æ¥è·å–ç¬¬ä¸€æ‰¹äººã€‚

```
import React from 'react';

import usePersons from './InfiniteList.hooks';

import './InfiniteList.css';

function InfiniteList() {
  const {persons, loading, loadMore, hasNextPage} = usePersons();
}

export default InfiniteList; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ç°åœ¨æ·»åŠ `AutoSizer`ç»„ä»¶æ¥è·å¾—ä¸€ä¸ª`width`å’Œä¸€ä¸ª`height`å±æ€§ï¼Œè¡¨ç¤ºç»„ä»¶å®¹å™¨ä¸­çš„å¯ç”¨ç©ºé—´ã€‚

```
import AutoSizer from 'react-virtualized-auto-sizer';

// ...

return (
  <div className="InfiniteList-list">
    <AutoSizer>{({height, width}) => <div />}</AutoSizer>
  </div>
); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬æ·»åŠ äº†éœ€è¦ä¸‰ä¸ªå±æ€§çš„`InfiniteLoader`ç»„ä»¶:

*   `isItemLoaded`ç¡®å®šæ˜¯ä¸€è¡Œå·²ç»è¢«åŠ è½½
*   `itemCount`æ˜¯å°†åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºçš„å…ƒç´ æ€»æ•°ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªå°æŠ€å·§ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¸çŸ¥é“è¿™ä¸ªæ•°å­—(æƒ³æƒ³ twitter æè¦)ã€‚å¦‚æœè¿˜æœ‰ä¸‹ä¸€é¡µè¦åŠ è½½ï¼Œæˆ‘ä»¬å°†æ€»è®¡æ•°åŠ  1ã€‚
*   æ˜¯ä¸€ä¸ªè·å–æ–°äººç¾¤çš„å‡½æ•°

å®ƒè¿˜å–ä¸€ä¸ªå‡½æ•°ä½œä¸º`children`ã€‚åœ¨ä½œä¸ºå‚æ•°ä¼ é€’çš„å¯¹è±¡ä¸­æœ‰ä¸¤ä¸ªå˜é‡ï¼Œè®©`InfiniteLoader`æ§åˆ¶æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€æ­¥æ·»åŠ çš„`List`ç»„ä»¶ã€‚

```
const personsCount = hasNextPage ? persons.length + 1 : persons.length;
const loadMorePersons = loading ? () => {} : loadMore;
const isPersonLoaded = index => !hasNextPage || index < persons.length;

// ...

return (
  <div className="InfiniteList-list">
    <AutoSizer>
      {({height, width}) => (
        <InfiniteLoader
          isItemLoaded={isPersonLoaded}
          itemCount={personsCount}
          loadMoreItems={loadMorePersons}>
          {({onItemsRendered, ref}) => <div />}
        </InfiniteLoader>
      )}
    </AutoSizer>
  </div>
); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œæˆ‘ä»¬æ·»åŠ ç»„ä»¶`List`æ¥æ˜¾ç¤ºå®é™…çš„äººå‘˜åˆ—è¡¨ã€‚

ä¸ºäº†å·¥ä½œï¼Œå®ƒéœ€è¦ä¸€ä¸ª`height`å’Œ`width`å±æ€§ã€‚æˆ‘ä»¬åº”è¯¥ä¼ é€’ç”±`AutoSizer`ç»„ä»¶æä¾›çš„å€¼ã€‚åœ¨`itemSize`å±æ€§ä¸­ä¹Ÿéœ€è¦ä¸€ä¸ªè¡Œé«˜ã€‚æˆ‘ä»¬è¿˜å°†æ¥è‡ª`InfiniteLoader`çš„å˜é‡ä½œä¸ºé“å…·ä¼ é€’ã€‚

ç»„ä»¶`List`ä¹Ÿå°†ä¸€ä¸ªå‡½æ•°ä½œä¸º`children`ã€‚å®ƒç»™ä½ å½“å‰äººçš„`index`å’Œä¸€ä¸ª`style`å±æ€§ã€‚æ‚¨å¿…é¡»å°†`style`å±æ€§ä¼ é€’ç»™è¡Œçš„çˆ¶å…ƒç´ ï¼Œè¿™æ ·åˆ—è¡¨æ‰èƒ½å¾ˆå¥½åœ°æ˜¾ç¤ºã€‚

å¦‚æœæ­¤äººå°šæœªåŠ è½½ï¼Œæˆ‘ä»¬ä¼šæ˜¾ç¤ºä¸€ä¸ªå ä½ç¬¦â€œæ­£åœ¨åŠ è½½...â€ã€‚

```
// ...

return (
  <div className="InfiniteList-list">
    <AutoSizer>
      {({height, width}) => (
        <InfiniteLoader
          isItemLoaded={isPersonLoaded}
          itemCount={personsCount}
          loadMoreItems={loadMorePersons}>
          {({onItemsRendered, ref}) => (
            <List
              height={height}
              itemCount={personsCount}
              itemSize={40}
              onItemsRendered={onItemsRendered}
              ref={ref}
              width={width}>
              {({index, style}) => {
                let content;
                if (!isPersonLoaded(index)) {
                  content = 'Loading...';
                } else {
                  const {firstname, lastname} = persons[index];
                  content = `${firstname}  ${lastname}`;
                }

                return (
                  <div className="InfiniteList-item" style={style}>
                    {content}
                  </div>
                );
              }}
            </List>
          )}
        </InfiniteLoader>
      )}
    </AutoSizer>
  </div>
); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ éƒ½å‡†å¤‡å¥½äº†ğŸ™Œï¼

æˆ‘ç”¨æœ¬æ–‡ä¸­ä»‹ç»çš„æ‰€æœ‰æºä»£ç åˆ›å»ºäº†ä¸€ä¸ª[å­˜å‚¨åº“](https://github.com/frinyvonnick/create-infinite-loading-list-react-graphql)ã€‚

æ‚¨å¯ä»¥é€šè¿‡åœ¨å­˜å‚¨åº“çš„é¡¶å±‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥è¿è¡Œå®ƒ:

```
yarn && yarn start 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ„Ÿè°¢åé¦ˆğŸ™æœ‰ä»»ä½•é—®é¢˜è¯·å‘å¾®åšç»™æˆ‘[@ yvonickfrin](https://twitter.com/YvonnickFrin)ï¼

**ç¼–è¾‘:**æˆ‘ä¸º React å®ç°éƒ¨åˆ†åšäº†ä¸€ä¸ªæŠ½è±¡ï¼Œå«åš`react-simple-infinite-loading`ã€‚ä½ å¯ä»¥åœ¨è¿™ç¯‡[æ–‡ç« ](https://dev.to/yvonnickfrin/infinite-loading-list-component-in-react-431o)ä¸­æ‰¾åˆ°æ›´å¤šå…³äºè¿™ä¸ªé¡¹ç›®åŠå…¶è¿ä½œæ–¹å¼çš„ä¿¡æ¯ã€‚