# è®©æˆ‘ä»¬æ¥è°ˆè°ˆåƒåœ¾

> åŸæ–‡ï¼š<https://dev.to/zex/let-s-talk-about-garbage-32ec>

æˆ‘ä»¬çš„åŸå¸‚æ­£åœ¨è®¤çœŸè¿›è¡Œåƒåœ¾åˆ†ç±»ï¼Œè¿™æœ‰åˆ©äºèµ„æºå¾ªç¯åˆ©ç”¨å’Œç¯å¢ƒä¿æŠ¤ã€‚ğŸ’æ‰€æœ‰åºŸç‰©å¿…é¡»å€¾å€’åœ¨æ­£ç¡®çš„åœ°æ–¹ã€‚è‡ª 7 æœˆ 1 æ—¥èµ·ï¼Œä¸éµå®ˆè§„å®šçš„ä¸ªäººæœ€é«˜å¯è¢«ç½šæ¬¾ 200 å…ƒäººæ°‘å¸ï¼Œè€Œç»„ç»‡æœ€é«˜å¯è¢«ç½šæ¬¾ 50 ä¸‡å…ƒäººæ°‘å¸ã€‚ğŸ˜¢

### èµ„æºç®¡ç†

ä¼˜ç§€çš„å¼€å‘äººå‘˜ä»ç³»ç»Ÿä¸­å€Ÿç”¨èµ„æºï¼Œå¹¶åœ¨å·¥ä½œå®Œæˆåé‡Šæ”¾å®ƒä»¬ã€‚ä½†æ˜¯äººç±»æ˜¯æ‡’æƒ°çš„åŠ¨ç‰©ï¼Œæ‰€ä»¥åˆ›é€ äº†â€œè‡ªåŠ¨â€å›æ”¶åºŸç‰©çš„è¯­è¨€ã€‚å› æ­¤ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä¸“æ³¨äºä»–ä»¬çš„ä¸šåŠ¡ï¼Œè€Œä¸ç”¨æ‹…å¿ƒèµ„æºé—®é¢˜ã€‚

*C++* ç”±äºå®ç°å›°éš¾å’Œæ€§èƒ½è€ƒè™‘ï¼Œæ²¡æœ‰è¯­è¨€çº§åƒåœ¾æ”¶é›†ã€‚ä¸€ç»„**æ™ºèƒ½æŒ‡é’ˆ**ä½œä¸º STL çš„ä¸€éƒ¨åˆ†è¢«åˆ›å»ºï¼Œç”¨äºèµ„æºç®¡ç†ç›®çš„ã€‚

åƒ *Java* ã€ *Go* ã€ *Python* å’Œ *JavaScript* è¿™æ ·çš„è¯­è¨€ï¼Œéƒ½æ˜¯è‡ªåŠ¨æ‰§è¡Œ GC çš„ã€‚

## GC æŠ€æœ¯

### å‚è€ƒè®¡æ•°

ä¸ºæ¯ä¸ªå¯¹è±¡ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä»¥è¡¨ç¤ºå¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡ä¸è¢«ä»»ä½•äººå¼•ç”¨æ—¶ï¼Œå®ƒå°†è¢«é‡Šæ”¾ã€‚è¿™å¯¼è‡´äº†å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¸¤ä¸ªå¯¹è±¡ç›¸äº’å¼•ç”¨æ—¶ï¼Œæœ€ç»ˆéƒ½æ— æ³•é‡Šæ”¾ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªå«åš**å¼±å¼•ç”¨**çš„å˜é€šæ–¹æ³•ï¼Œå®ƒä¸ä¿æŠ¤è¢«å¼•ç”¨çš„å¯¹è±¡è¢«å›æ”¶ã€‚å®ƒä¸ä¼šå¢åŠ  referent å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚

### æ ‡è®°å’Œæ‰«æ 

ä½œä¸ºè·Ÿè¸ªåƒåœ¾æ”¶é›†å™¨ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªé˜¶æ®µ:æ ‡è®°é˜¶æ®µå’Œæ¸…æ‰«é˜¶æ®µã€‚

é¦–å…ˆï¼Œåƒåœ¾æ”¶é›†å™¨ä»æ ¹å¼€å§‹éå†å¯¹è±¡å›¾ï¼Œæ‰¾å‡ºé‚£äº›å¯åˆ°è¾¾çš„å¯¹è±¡ï¼Œå¹¶å°†æ ‡è®°ä½è®¾ç½®ä¸º 1ï¼Œé»˜è®¤ä¸º 0ã€‚

å…¶æ¬¡ï¼Œæ‰«ææ‰€æœ‰å¯¹è±¡ï¼Œå›æ”¶é‚£äº›ä¸å¯åŠçš„å¯¹è±¡(æ ‡è®°ä¸º 0)ï¼Œå°†å¯åŠçš„å¯¹è±¡çš„æ ‡è®°ä½è®¾ç½®ä¸º 1ã€‚

è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯å®ƒä¼šåœæ­¢ç¨‹åºæ‰§è¡Œä¸€æ®µæ—¶é—´ã€‚

### ä¸‰è‰²

å®ƒä½¿ç”¨ä¸‰ç§é¢œè‰²ï¼Œç™½è‰²ï¼Œç°è‰²å’Œé»‘è‰²æ¥åŒºåˆ†ç‰©ä½“çš„çŠ¶æ€ã€‚

*   ç™½è‰²é›†åˆåŒ…å«è¦å›æ”¶çš„å€™é€‰å¯¹è±¡ã€‚
*   ç°è‰²é›†åˆåŒ…å«å¯ä»¥ä»æ ¹åˆ°è¾¾çš„å¯¹è±¡ï¼Œå¹¶ä¸”å¼•ç”¨äº†ç™½è‰²é›†åˆä¸­çš„å¯¹è±¡ã€‚
*   é»‘è‰²é›†åˆåŒ…å«å¯ä»æ ¹åˆ°è¾¾çš„å¯¹è±¡ï¼Œä¸å¼•ç”¨ç™½è‰²é›†åˆä¸­çš„å¯¹è±¡ï¼Œå¹¶ä¸”ä¸æ˜¯å›æ”¶çš„å€™é€‰å¯¹è±¡ã€‚

å¯¹è±¡åªèƒ½ä»ç°è‰²ç§»åŠ¨åˆ°é»‘è‰²ï¼Œä»ç™½è‰²ç§»åŠ¨åˆ°ç°è‰²ã€‚

è¯¥ç®—æ³•æ¼”ç¤ºå¦‚ä¸‹

```
 While grey set not empty:
  Pick an object from a grey set
  Move the object to black set
  Move white objects it references to grey set 
```

å®ƒç¡®ä¿æ²¡æœ‰é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œç™½è‰²å¯¹è±¡ä»æ ¹æ˜¯ä¸å¯åŠçš„ï¼Œå¹¶ä¸”ä¸€æ—¦ç°è‰²é›†ä¸ºç©ºï¼Œå°±å¯ä»¥å›æ”¶ã€‚å®ƒå¯ä»¥åœ¨ä¸æš‚åœç³»ç»Ÿä¸€æ®µæ—¶é—´çš„æƒ…å†µä¸‹è¿è¡Œã€‚

## å®ç°

### åœæ­¢ä¸–ç•Œ

åƒåœ¾æ”¶é›†å™¨å¸¦æœ‰ä¸€ä¸ª
å›æ”¶é˜ˆå€¼ï¼Œå½“å®ƒè¢«å…³é—­æˆ–è¾¾åˆ°æ—¶ï¼Œå°±ä¼šå‘ç”Ÿå›æ”¶ã€‚

å®ƒä¼šåœæ­¢ç¨‹åºæ‰§è¡Œï¼Œç›´åˆ°åƒåœ¾æ”¶é›†å®Œæˆã€‚è¿™ä¸º GC å¸¦æ¥äº†é«˜ååé‡ã€‚å®ƒé€‚ç”¨äºéäº¤äº’å¼åº”ç”¨ç¨‹åºã€‚ç”±äºä»¥ç‰¹å®šçš„é¢‘ç‡è®©ä¸–ç•Œåœæ­¢ä¸€æ®µæ—¶é—´ï¼Œè¿™ä¹Ÿå¸¦æ¥äº†æ€§èƒ½é—®é¢˜ã€‚

### å¢é‡ GC

é€šè¿‡å°†åƒåœ¾æ”¶é›†åˆ†æˆå‡ ä¸ªè¿›ç¨‹å¹¶é€ä¸ªå®Œæˆå®ƒä»¬ï¼Œç¦»æ•£åœ°æ‰§è¡Œåƒåœ¾æ”¶é›†ã€‚å®ƒä¸åƒ STW é‚£æ ·å†»ç»“å¾ˆé•¿æ—¶é—´ï¼Œè€Œæ˜¯æŠŠå®ƒåˆ†è§£æˆè®¸å¤šå¾®å°çš„æ—¶é—´æ®µã€‚

### å¹¶å‘ GC

å®ƒåŒæ—¶è¿è¡Œåƒåœ¾æ”¶é›†ï¼Œè€Œä¸ä¼šåœæ­¢è¿è¡Œã€‚æœ€å°åŒ–æš‚åœæ—¶é—´æ˜¯äº¤äº’å¼ç¨‹åºçš„ä¸€ä¸ªå¥½é€‰æ‹©ã€‚ä½ååé‡ä½¿å¾—å®Œæˆ GC éœ€è¦æ›´é•¿çš„æ—¶é—´ã€‚

## è¯­è¨€åƒåœ¾æ”¶é›†

### Python ä¸­çš„ GC

Python ä¸­çš„ *gc* æ¨¡å—å…è®¸æ‚¨ä¸ gc ç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚å®ƒå¯ä»¥è¢«`gc.disable()`ç¦ç”¨ï¼Œå¹¶é€šè¿‡è°ƒç”¨`gc.collect()`æ‰‹åŠ¨ GCã€‚`gc.garbage`æ˜¯è¦æ”¶é›†çš„å¯¹è±¡åˆ—è¡¨ã€‚

æœ‰å…´è¶£äº†è§£æ›´å¤šä¿¡æ¯å—ï¼Ÿæ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªã€‚ğŸ˜

### GC åœ¨èµ°

Go å…è®¸æ‚¨é€šè¿‡ä½¿ç”¨`GOGC=off`è¿è¡Œåº”ç”¨ç¨‹åºæ¥ç¦ç”¨ GCã€‚

> Go å¸¦æœ‰ä¸¤ä¸ªæ—‹é’®æ¥æ§åˆ¶ GCã€‚ç¬¬ä¸€ä¸ªæ˜¯ GCPercentã€‚åŸºæœ¬ä¸Šè¿™æ˜¯ä¸€ä¸ªæ—‹é’®ï¼Œå¯ä»¥è°ƒèŠ‚ä½ æƒ³è¦ä½¿ç”¨å¤šå°‘ CPU å’Œå¤šå°‘å†…å­˜ã€‚é»˜è®¤å€¼æ˜¯ 100ï¼Œè¿™æ„å‘³ç€ä¸€åŠçš„å †ä¸“ç”¨äºå®æ—¶å†…å­˜ï¼Œä¸€åŠçš„å †ä¸“ç”¨äºåˆ†é…ã€‚æ‚¨å¯ä»¥åœ¨ä»»ä¸€æ–¹å‘ä¸Šå¯¹æ­¤è¿›è¡Œä¿®æ”¹ã€‚
> 
> MaxHeap å°šæœªå‘å¸ƒï¼Œä½†æ­£åœ¨å†…éƒ¨ä½¿ç”¨å’Œè¯„ä¼°ï¼Œå®ƒå…è®¸ç¨‹åºå‘˜è®¾ç½®æœ€å¤§å †å¤§å°ã€‚

ä»æºä»£ç  [mgc](https://github.com/golang/go/blob/master/src/runtime/mgc.go) ä¸­äº†è§£æ›´å¤šå…³äº Go åƒåœ¾æ”¶é›†å™¨çš„ä¿¡æ¯ã€‚

### JavaScript ä¸­çš„ GC

Javascript ä¸­çš„ GC æ˜¯åŸºäº**å¯è¾¾æ€§**å¹¶ä¸”å®Œå…¨è‡ªåŠ¨çš„ã€‚å‘ç°è¿™ç¯‡[æ–‡ç« ](https://javascript.info/garbage-collection)è§£é‡Šå¾—å¾ˆå¥½ï¼Œæ¨èä½ é€šè¯»ä¸€ä¸‹ã€‚

## æœ‰ç”¨çš„èµ„æº

[åƒåœ¾æ”¶é›†çš„åŸºç¡€çŸ¥è¯†](https://docs.microsoft.com/en-us/dotnet/standard/garbage-collection/fundamentals)

[ç»´åŸº:åƒåœ¾æ”¶é›†](https://en.m.wikipedia.org/wiki/Garbage_collection_(computer_science))