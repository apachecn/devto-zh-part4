# ä½¿ç”¨ Jest å’Œ Cypress æµ‹è¯• React -è®¾ç½®ã€å•å…ƒã€é›†æˆå’Œ E2E(ä¸“é•¿ã€‚GraphQL)

> åŸæ–‡ï¼š<https://dev.to/rxassim/testing-react-setup-unit-integration-and-e2e-using-jest-and-cypress-feat-graphql-4fj7>

*æ³¨:è¿™æ˜¯æ¥è‡ª[æˆ‘çš„æ—¶äº‹é€šè®¯](https://www.getdrip.com/forms/14582623/submissions/new)å’Œ[åšå®¢](https://www.assim.me/testing-react)çš„äº¤å‰å¸–å­ã€‚æˆ‘ä¼šåœ¨æ¯å°é‚®ä»¶å‘å‡ºä¸€å‘¨åå…¬å¸ƒã€‚è®¢é˜…ä»¥åœ¨æ‚¨çš„æ”¶ä»¶ç®±ä¸­æ›´æ—©åœ°è·å¾—æ›´å¤šç±»ä¼¼çš„å†…å®¹ï¼ğŸ’Œ*

å—¨ï¼è¿™æ˜¯ä¸€ä¸ªæŒ‡å—/å¤‡å¿˜å•ï¼Œå½“æˆ‘æƒ³ä¸ºä¸€ä¸ªé¡¹ç›®ç¼–å†™æµ‹è¯•æ—¶ï¼Œæˆ‘ä¼šå›æ¥é˜…è¯»ã€‚

æˆ‘æƒ³è¿™å¯èƒ½ä¼šå¸®åŠ©å…¶ä»–å¼€å‘äººå‘˜ï¼Œæ‰€ä»¥ç»™ä½ ğŸ˜

# è®¾ç½®

## å®‰è£… jestã€cypress å’Œ helper åº“

```
yarn add jest @testing-library/react @testing-library/jest-dom -D 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## é…ç½®

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†é…ç½® Jest å’Œ Cypress

### æ˜¯

è®©æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹ä¸º Jest åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶:

```
module.exports = {
  // location.href will have this value
  testURL: 'https://example.com',
  // Add here folders to ignore
  testPathIgnorePatterns: ['/node_modules/'],
  setupTestFrameworkScriptFile: require.resolve(
    './test/setup.js'
  ),
  // path to components/modules to test
  modulePaths: ['<rootDir>/src'],
  moduleNameMapper: {
    // mock files that jest doesn't support like CSS and SVG files
    '\\.css$': '<rootDir>/test/module-mock.js',
    '\\.svg$': '<rootDir>/test/module-mock.js',
  },
  // collect coverage report from only the js files inside src
  collectCoverageFrom: ['**/src/**/*.js'],
  coverageThreshold: {
    global: {
      // 20 is just an example
      // you can change it to any value you want (below 100)
      statements: 20,
      branches: 20,
      functions: 20,
      lines: 20,
    },
  },
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª`test`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»º`setup.js`æ–‡ä»¶:

```
// cleanup helper
import '@testing-library/react/cleanup-after-each'
// custom matchers for jest
// learn more: https://github.com/testing-library/jest-dom
import '@testing-library/jest-dom/extend-expect' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŒæ ·åœ¨åŒä¸€ä¸ª`test`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª`module-mock.js`:

```
module.exports = {} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### ä»£ç è¦†ç›–ç‡

åœ¨*çš„ package.json* ä¸­ï¼Œåœ¨ä½ çš„`test`è„šæœ¬çš„æœ«å°¾æ·»åŠ `--coverage`:

```
{  ...  "scripts":  {  ...  "test":  "jest --coverage"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### è§‚çœ‹æ¨¡å¼

åœ¨ç¼–ç æ—¶ï¼Œä½¿ç”¨ Jest in watch æ¨¡å¼æ¥è·å¾—ä¸æ‚¨æ­£åœ¨æ›´æ”¹çš„æ–‡ä»¶ç›¸å…³çš„æµ‹è¯•çš„å³æ—¶åé¦ˆã€‚
è¦ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæ·»åŠ ä¸€ä¸ªè„šæœ¬åˆ° *package.json* å¹¶ä½¿ç”¨å®ƒ:

```
{  ...  "scripts":  {  ...  "test:watch":  "jest --watch"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### æŸæ ‘

å®‰è£…`cypress`å’ŒåŠ©æ‰‹:

```
yarn add cypress @testing-library/cypress -D 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åç»™ *package.json* æ·»åŠ ä¸€ä¸ªè„šæœ¬æ¥è¿è¡Œ cypress:

```
{  ...  "scripts":  {  ...  "cy:open":  "cypress open",  "cy:run":  "cypress run",  //  run  all  cypress  tests  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
yarn cy:open 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Cypress åœ¨è¿è¡Œæµ‹è¯•æ—¶ä¼šå½•åˆ¶è§†é¢‘å¹¶æˆªå›¾ã€‚
è®©æˆ‘ä»¬å°†èµ›æ™®æ‹‰æ–¯ä¸ºæ­¤ä½¿ç”¨çš„æ–‡ä»¶å¤¹æ·»åŠ åˆ°`.gitignore`

```
 ...
  cypress/videos
  cypress/screenshots 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### æŸæ ‘. json

å½“ç¬¬ä¸€æ¬¡è¿è¡Œ`cypress open`æ—¶ï¼Œå®ƒä¼šåœ¨æ ¹ç›®å½•ä¸‹åä¸º`cypress`çš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€å †æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚å®ƒè¿˜åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`cypress.json`çš„æ–‡ä»¶ã€‚è¿™æ˜¯ cypress ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ã€‚

è®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªåœ¨ E2E æµ‹è¯•ä¸­ä½¿ç”¨çš„ base URL:

```
//cypress.json  {  "baseUrl":  "http://localhost:3000"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### @æµ‹è¯•-å›¾ä¹¦é¦†/æŸæ ‘

å‘ cypress æ·»åŠ äº†ä¸€äº›éå¸¸æ–¹ä¾¿çš„å‘½ä»¤ï¼Œè®©æˆ‘ä»¬æ¥é…ç½®å®ƒ:

è½¬åˆ°`<rootDir>/cypress/support`ï¼Œæ‰“å¼€`index.js`ï¼Œæ·»åŠ è¿™ä¸€è¡Œ:

```
import '@testing-library/cypress/add-commands'
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### æµ‹è¯•å·¥å…·(åŠ©æ‰‹):

æ‹¥æœ‰ä¸€ä¸ª test-utils æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯¼å‡ºä¸€ç»„ä¸“é—¨ç”¨äºæ‚¨æ­£åœ¨æµ‹è¯•çš„é¡¹ç›®çš„å·¥å…·ã€‚

*   ç¤ºä¾‹:

å¯¼å‡ºä¸€ä¸ª`render`æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ·»åŠ æ ·å¼åŒ–ç»„ä»¶ ThemeProvider HOC:

```
import React from 'react'
import {
  render as originalRender,
  wait,
} from '@testing-library/react'

const theme = {
  colors: {
    red: 'red',
  },
}

function render(component, renderOptions) {
  const utils = originalRender(
    <ThemeProvider theme={theme}>
      {component}
    </ThemeProvider>,
    renderOptions
  )
  return {
    ...utils,
  }
}
export { render } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨åœ¨ä½ çš„æµ‹è¯•ä¸­ï¼Œä»è¿™ä¸ª`test-utils`æ–‡ä»¶ä¸­å¯¼å…¥`render`è€Œä¸æ˜¯`@testing-library/react`

# å•å…ƒæµ‹è¯•

å½“ä½ æƒ³æµ‹è¯•*ä¸€ä¸ªåŠŸèƒ½/ç»„ä»¶* :
çš„åŠŸèƒ½æ—¶ï¼Œç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•

```
import React from 'react'
import { render } from '@testing-library/react'
import Paragraph from '../paragraph'

test('renders the text given', () => {
  const { getByText } = render(<Paragraph>Hello</Paragraph>)

  expect(getByText(/Hello/i)).toBeInTheDocument()
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# é›†æˆæµ‹è¯•

å½“ä½ æƒ³æµ‹è¯•*å‡ ä¸ªç»„ä»¶ä¸€èµ·å·¥ä½œ* :
çš„åŠŸèƒ½æ—¶ï¼Œå†™ä¸€ä¸ªé›†æˆæµ‹è¯•

```
import React from 'react'
import { MockedProvider } from '@apollo/react-testing'
import wait from 'waait'
import { fireEvent } from '@testing-library/react'
import { render } from '../test-utils'
import App, { LOGIN_MUTATION } from '../app'

beforeEach(() => {
  window.localStorage.removeItem('token')
})

test('login as a user', async () => {
  const fakeUser = { id: 123, username: 'fakeuser' }
  const fakeUserCredentials = {
    ...fakeUser,
    password: 'stupidpassword123',
  }
  const token =
    'thisisjustanexampleofatoken-youcanuseafakedatageneratorinstead'
  const loginMutationMock = jest.fn()
  const loginMutationErrorMock = jest.fn()
  const mocks = [
    {
      request: {
        query: LOGIN_MUTATION,
        variables: {
          username: fakeUserCredentials.username,
          password: fakeUserCredentials.password,
        },
      },
      result: () => {
        loginMutationMock()
        return { data: { user: fakeUser, token: token } }
      },
      error: () => {
        loginMutationErrorMock()
      },
    },
  ]
  const { getByTestId, getByText, getByLabelText } = render(
    <MockedProvider mocks={mocks} addTypename={false}>
      <App />
    </MockedProvider>
  )
  // open login form dialog/modal
  fireEvent.click(getByText(/login/i))
  // fill out login form
  const usernameNode = getByLabelText(/username/i)
  const passwordNode = getByLabelText(/password/i)
  usernameNode.value = fakeUserCredentials.username
  passwordNode.value = fakeUserCredentials.password
  // submit login form
  fireEvent.click(getByText(/sign in/i))
  // wait for the mocked requests to finish
  await wait(0)
  // assert calls
  expect(loginMutationMock).toHaveBeenCalledTimes(1)
  expect(loginMutationErrorMock).not.toHaveBeenCalled()
  // assert login side-effect
  expect(window.localStorage.getItem('token')).toBe(token)
  expect(getByTestId('username').textContent).toEqual(
    fakeUser.username
  )
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# ç«¯åˆ°ç«¯æµ‹è¯•:

æœ€ç®€å•çš„å®šä¹‰:å‡è®¾ä½ æœ‰ä¸€ä¸ªæœä»ä½ å‘½ä»¤çš„æœºå™¨äººï¼Œç°åœ¨è®©å®ƒä»¥æ™®é€šç”¨æˆ·çš„èº«ä»½æµ‹è¯•ä½ çš„åº”ç”¨ğŸ¤·â€â™‚ï¸.

```
describe('authentication and registration', () => {
  let user

  beforeEach(() => {
    return cy
      .logout()
      .createNewUser()
      .then(u => (user = u))
      .visit('/')
  })

  it('register as a guest user', () => {
    const user = {
      username: 'user',
      email: 'hello@example.com',
      password: 'password123',
    }
    cy.getByText(/register/i)
      .click()
      .getByLabelText(/username/i)
      .type(user.username)
      .getByLabelText(/email/i)
      .type(user.email)
      .getByLabelText(/password/i)
      .type(user.password)
      .getByText(/register/i)
      .click()
      .assertRoute('/')
    cy.getByTestId('username').should(
      'contain',
      user.username
    )
  })

  it('login as a user', () => {
    cy.getByText(/login/i)
      .click()
      .getByLabelText(/username/i)
      .type(user.username)
      .getByLabelText(/password/i)
      .type(user.password)
      .getByText(/sign in/i)
      .click()
      .assertRoute('/')
    cy.getByTestId('username').should(
      'contain',
      user.username
    )
  })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä¼šåŠªåŠ›æ”¹è¿›è¿™ç¯‡æ–‡ç« å¹¶æ·»åŠ å†…å®¹ï¼Œä½†å¦‚æœä½ æƒ³çº æ­£/æ·»åŠ /ç¼–è¾‘â¤ï¸çš„æŸäº›ä¸œè¥¿ï¼Œè¯·éšæ—¶å‘é€ä¸€ä»½ PR