# ç¬¬ 029 é›†-ç”¨ proxy kit-ASP.NET æ ¸å¿ƒç®€åŒ– BFF:ä» 0 åˆ°è¿‡åº¦æ€ä¼¤

> åŸæ–‡ï¼š<https://dev.to/joaofbantunes/episode-029-simplifying-the-bff-with-proxykit-asp-net-core-from-0-to-overkill-33k2>

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬å°†ä¸ºå‰ç«¯å®ç°ä¿®æ”¹å½“å‰çš„åç«¯ï¼Œå¼•å…¥ ProxyKit æ¥ç®€åŒ–è¯·æ±‚è·¯ç”±åˆ°åå° APIï¼Œæ”¾å¼ƒæ‰‹åŠ¨å®ç°ä¸€åˆ‡çš„éœ€è¦ã€‚

å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œä½†å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

[https://www.youtube.com/embed/Wgu97TKaRiI](https://www.youtube.com/embed/Wgu97TKaRiI)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚
T3ã€‘

## [T1ã€‘ç®€ä»‹](#intro)

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬å·²ç»ä¸ºæœªæ¥çš„å¼€å‘åˆ›å»ºäº†ä¸€ä¸ªç¨³å®šçš„åŸºç¡€è®¾æ–½ï¼Œä½†æ˜¯å°±å®é™…çš„åº”ç”¨ç¨‹åºç‰¹æ€§è€Œè¨€ï¼Œæˆ‘ä»¬ä»ç„¶å¤„äºéå¸¸åŸºç¡€çš„æ°´å¹³ï¼Œæ‰€ä»¥æ˜¯æ—¶å€™å›åˆ°å®ç°å®ƒä»¬äº†ã€‚

ä¸è¿‡ï¼Œæˆ‘ä»¬é¢ä¸´çš„ä¸€ä¸ªé—®é¢˜æ˜¯å½“å‰å‰ç«¯å¯¹åç«¯çš„å®ç°ï¼Œç»´æŠ¤èµ·æ¥ä¼šå¾ˆç—›è‹¦ã€‚

å½“æˆ‘ä»¬åœ¨ç¬¬ 020 é›†ä¸­å¼•å…¥ BFF æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸»è¦ç›®æ ‡:æœ‰ä¸€ä¸ªåœ°æ–¹æ¥å®ç°ç‰¹å®šäºç»™å®šå‰ç«¯çš„ç‰¹æ€§ï¼Œå…è®¸å®ƒå’Œå…¶ä»–å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå¯èƒ½ä½¿ç”¨çš„æ”¯æŒ API ä¹‹é—´æŸç§ç¨‹åº¦çš„è§£è€¦ã€‚

è¿™ä»ç„¶æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½†é—®é¢˜æ˜¯ï¼Œå¹¶ä¸æ˜¯æ¯ä¸€ä¸ªä¸åå° API çš„äº¤äº’éƒ½éœ€è¦å®šåˆ¶ã€‚æ­£å¦‚æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢åœ¨ç»„ç®¡ç† API ä¸­çœ‹åˆ°çš„ï¼Œæœ‰äº›ä¸œè¥¿å¯ä»¥ç›´æ¥æµå‘ APIï¼ŒBFF é™¤äº†å‘è¯·æ±‚æ·»åŠ æˆæƒä»¤ç‰Œä¹‹å¤–æ²¡æœ‰åšå¤ªå¤šäº‹æƒ…ã€‚

åœ¨ç¬¬ 020 é›†é‡Œï¼Œæˆ‘ä»¬æŠ“ä½æœºä¼šç©äº† HTTP å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ç»§ç»­åƒè¿™æ ·å®ç°æ‰€æœ‰ä¸œè¥¿ï¼Œæˆ‘ä»¬åœ¨ API é‡Œåšçš„æ¯ä¸€ä¸ªæ”¹å˜ï¼Œéƒ½éœ€è¦æˆ‘ä»¬æ”¹å˜ BFFã€‚æˆ‘ä»¬å¯ä»¥ç»™ BFF å–å¦ä¸€ä¸ªåå­— [API gateway](https://microservices.io/patterns/apigateway.html) ï¼Œå¦‚æœæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¼šå¼€å§‹æƒ³è±¡å¦‚æœæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨é…ç½®å‰ç«¯å’Œåç«¯ä¹‹é—´çš„æ‰€æœ‰äº¤äº’ï¼Œå³ä½¿ä¸éœ€è¦å®šåˆ¶ï¼Œæˆ‘ä»¬ä¼šæœ‰å¤šå°‘å·¥ä½œé‡ã€‚

è®°ä½è¿™ä¸€ç‚¹ï¼Œè¿™ä¸€é›†æˆ‘ä»¬å°†é€šè¿‡å¼•å…¥ [ProxyKit](https://github.com/damianh/ProxyKit) æ¥ç®€åŒ– BFFï¼Œå®ƒå°†è´Ÿè´£å°†ä»»ä½• API è¯·æ±‚è·¯ç”±åˆ°æ­£ç¡®çš„æ”¯æŒæœåŠ¡ã€‚

> **è¾¹æ³¨:**åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä¸ä¼šçœŸçš„è°ˆè®ºå®ƒä»¬ï¼Œä½†åªæ˜¯ä¸ºäº†è®©é‚£äº›å…³æ³¨è¿™ä¸ªç³»åˆ—å¹¶æ£€æŸ¥ä»£ç çš„äººçŸ¥é“ï¼Œæˆ‘å¯¹ BFF çš„è·¯çº¿åšäº†ä¸€äº›å°çš„è°ƒæ•´ï¼Œå³è®¤è¯ç«¯ç‚¹ä¸å†åœ¨`api/auth`ä¸Šï¼Œè€Œåªæ˜¯åœ¨`auth`ä¸Šã€‚ç”±äºè¿™ä¸€æ›´æ”¹ï¼Œè¿˜è°ƒæ•´äº†åå‘ä»£ç†é…ç½®ã€auth service é…ç½®çš„é‡å®šå‘ç«¯ç‚¹å’Œå•é¡µåº”ç”¨ç¨‹åºå¼€å‘æœåŠ¡å™¨ä»£ç†è®¾ç½®ã€‚

## å°† ProxyKit å¼•å…¥ BFF

ä»‹ç» [ProxyKit](https://github.com/damianh/ProxyKit) çš„æœ€å¥½æ–¹å¼å¯èƒ½å°±æ˜¯ä»å®ƒçš„ [GitHub é¡µé¢](https://github.com/damianh/ProxyKit)ä¸­å¤åˆ¶æè¿°:

> ä¸€ä¸ªåˆ›å»ºä»£ç ä¼˜å…ˆçš„ HTTP åå‘ä»£ç†çš„å·¥å…·åŒ…ï¼Œæ‰˜ç®¡åœ¨ ASP.NET æ ¸å¿ƒä½œä¸ºä¸­é—´ä»¶ã€‚è¿™ä½¿å¾—ä»£ç ä¼˜å…ˆçš„ä»£ç†å¯ä»¥åµŒå…¥åˆ°ç°æœ‰çš„ ASP.NET æ ¸å¿ƒåº”ç”¨ç¨‹åºä¸­ï¼Œæˆ–è€…ä½œä¸ºç‹¬ç«‹çš„æœåŠ¡å™¨éƒ¨ç½²ã€‚

æˆ‘è®¤ä¸ºè¿™ä¸ªæè¿°è®©æˆ‘ä»¬ç†è§£äº†ä¸ºä»€ä¹ˆå®ƒæ˜¯æˆ‘ä»¬é—®é¢˜çš„ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯è®©æˆ‘ä»¬ä»”ç»†åˆ†æä¸€ä¸‹ã€‚

é€šè¿‡æˆä¸ºæˆ‘ä»¬å¯ä»¥å¼•å…¥ ASP.NET æ ¸å¿ƒçš„å¦ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè¿™æ„å‘³ç€å®ƒåªæ˜¯ç®¡é“ä¸­å­˜åœ¨çš„å¦ä¸€ä¸ªä¸œè¥¿ï¼Œè€Œä¸æ˜¯ä½¿å…¶ä»–ä¸€åˆ‡æ— ç”¨ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå…¶ä»–ä¸€åˆ‡éƒ½å°†ç…§å¸¸å·¥ä½œï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ BFF ä¸­æ·»åŠ é¢å¤–çš„ç«¯ç‚¹æ¥å®ç°ç‰¹å®šçš„åŠŸèƒ½ï¼Œå°±åƒè®¤è¯è¿‡ç¨‹ä¸€æ ·ã€‚

### å¿«çœ‹ ProxyKit vs Ocelot

æˆ‘ä»¬å¿…é¡»å®ç°çš„å¦ä¸€ä¸ªé€‰é¡¹æ˜¯ [Ocelot](https://github.com/ThreeMammals/Ocelot) ã€‚å°½ç®¡æˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬æ¥å®ç°ç›¸ä¼¼çš„è¡Œä¸ºï¼Œä½†å®ƒä»¬çš„ä¾§é‡ç‚¹æ˜¯ä¸åŒçš„ã€‚

ProxyKit ä¸“æ³¨äºæˆä¸ºä¸€ä¸ªåå‘ä»£ç†ï¼Œå°±åƒæˆ‘ä»¬ä¸€ç›´ä½¿ç”¨çš„ HAProxy ä¸€æ ·ï¼Œä½†æ‰˜ç®¡åœ¨ ASP.NET æ ¸å¿ƒåº”ç”¨ç¨‹åºä¸­ï¼Œè¿™å…è®¸æˆ‘ä»¬åˆ©ç”¨å…¶ä»–æ¡†æ¶åŠŸèƒ½å’Œæˆ‘ä»¬é€‰æ‹©çš„ç¼–ç¨‹è¯­è¨€æ¥å®šåˆ¶ä¸œè¥¿ã€‚

Ocelot ä¸“æ³¨äºæˆä¸ºä¸€ä¸ª API ç½‘å…³ï¼Œæ‰€ä»¥å¼€ç®±å³ç”¨ï¼Œé™¤äº†ç±»ä¼¼çš„è·¯ç”±åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–å¯¹è¿™ä¸€ç‰¹å®šåœºæ™¯æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¦‚è¯·æ±‚èšåˆã€ç¼“å­˜ã€é‡è¯•å’Œå…¶ä»–åŠŸèƒ½ã€‚

ä¹ä¸€çœ‹ï¼ŒOcelot å¯èƒ½æ˜¯æˆ‘ä»¬æœ€å¥½çš„æœ‹å‹çš„æ›´å¥½çš„é€‰æ‹©ï¼Œæ‹¥æœ‰æ‰€æœ‰è¿™äº›é¢å¤–çš„åŠŸèƒ½ã€‚ä¸ ProxyKit ç›¸æ¯”ï¼Œå®ƒçš„ä¸è¶³ä¹‹å¤„åœ¨äºç®€å•ä»£ç†åœºæ™¯ä¸­çš„æ€§èƒ½ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬ç›®å‰æ‰€æ‹¥æœ‰çš„ã€‚äº‹å®ä¸Šï¼Œè¿™åœ¨ ProxyKit çš„ [GitHub é¡µé¢](https://github.com/damianh/ProxyKit#7-comparison-with-ocelot)ä¸­æœ‰æ›´å¥½çš„è§£é‡Šã€‚

> Ocelot æ˜¯ä¸€ä¸ª API ç½‘å…³ï¼Œä¹Ÿè¿è¡Œåœ¨ ASP.NET æ ¸å¿ƒä¸Šã€‚API ç½‘å…³å’Œé€šç”¨åå‘ä»£ç†ä¹‹é—´çš„ä¸€ä¸ªå…³é”®åŒºåˆ«æ˜¯ï¼Œå‰è€…å€¾å‘äºåŸºäºæ¶ˆæ¯ï¼Œè€Œåå‘ä»£ç†æ˜¯åŸºäºæµçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒAPI ç½‘å…³é€šå¸¸ä¼šç¼“å†²æ¯ä¸ªè¯·æ±‚å’Œå“åº”æ¶ˆæ¯ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ‰§è¡Œè½¬æ¢ã€‚è¿™å¯¹äº API ç½‘å…³æ¥è¯´å¾ˆå¥½ï¼Œä½†æ˜¯ä¸é€‚åˆä¸€èˆ¬çš„åå‘ä»£ç†æ€§èƒ½ï¼Œä¹Ÿä¸é€‚åˆåˆ†å—ç¼–ç çš„å“åº”ã€‚è¯·å‚é˜…ä¸æ”¯æŒçš„ Ocelot æ–‡æ¡£ã€‚
> 
> å°† ProxyKit ä¸ Ocelot ç›¸ç»“åˆå°†ä¸ºå„ç§åœºæ™¯æä¾›ä¸€äº›ä¸é”™çš„é€‰æ‹©ã€‚

è¿™æœ€åä¸€ä¸ªçŸ­è¯­ç‰¹åˆ«æœ‰è¶£ï¼Œä½†ä¸€ç‚¹ä¹Ÿä¸æ„å¤–ã€‚å› ä¸ºä¸¤è€…éƒ½æ˜¯ ASP.NET æ ¸å¿ƒåº”ç”¨ç¨‹åºä¸­çš„ä¸­é—´ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªç”±ç»„åˆå„è‡ªçš„ä¼˜ç‚¹ã€‚ä¸è¿‡ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ ProxyKitï¼Œå°†æ¥æˆ‘ä»¬ä¹Ÿå¯èƒ½åœ¨åº”ç”¨ç¨‹åºä¸­å¼•å…¥ Ocelotã€‚

### å®‰è£…å’Œé…ç½®

å®‰è£… ProxyKit åªæ˜¯å®‰è£…ä¸€ä¸ª NuGet åŒ…çš„é—®é¢˜ã€‚

```
dotnet add package ProxyKit 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ä½¿ç”¨å®ƒï¼Œå‡è®¾å®ƒæ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œä½ å¯èƒ½å·²ç»èƒ½æƒ³è±¡å‡ºæ­¥éª¤:è½¬åˆ°`Startup`ç±»ï¼Œåœ¨`ConfigureServices`ä¸­é…ç½®æ‰€éœ€çš„æœåŠ¡ï¼Œåœ¨`Configure`ä¸­é…ç½®ç®¡é“ã€‚

è¦é…ç½® DIï¼Œå¾ˆç®€å•:

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\Startup.cs`

```
services.AddProxy(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬å¿…é¡»é…ç½®ç®¡é“ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¨å¾®æ·±å…¥åˆ°`Configure`æ–¹æ³•ã€‚æˆ‘ä»¬ä¼šæŠŠå®ƒåŠ åˆ°æµæ°´çº¿çš„æœ«å°¾ï¼Œæ‰€ä»¥åœ¨`app.UseMvc()`ä¹‹åã€‚è¿™å…è®¸æˆ‘ä»¬ç”¨æ§åˆ¶å™¨æ¥å¤„ç†ä¸€äº›è¯·æ±‚ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰åŒ¹é…çš„ï¼Œå®ƒå°†é€šè¿‡ç®¡é“åˆ°è¾¾ä»£ç†ä¸­é—´ä»¶ã€‚

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\Startup.cs`

```
app.Map("/api/groups", api =>
{
    api.RunProxy(async context =>
    {
        var forwardContext = context
            .ForwardTo("http://groupmanagement:80/groups")
            .CopyXForwardedHeaders();

        var token = await context.GetAccessTokenAsync();
        forwardContext.UpstreamRequest.SetBearerToken(token);

        return await forwardContext.Send();
    });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¤ªå¤šçš„é…ç½®å°±å¯ä»¥è®©å®ƒå·¥ä½œã€‚æˆ‘ä»¬ä½¿ç”¨`app.Map`å’Œç»„ç®¡ç† API çš„åŸºæœ¬è·¯ç”±ï¼Œæ‰€ä»¥å®ƒåªè·¯ç”±æ­£ç¡®çš„è¯·æ±‚ï¼Œè€Œä¸æ˜¯æ‰€æœ‰çš„è¯·æ±‚ã€‚

åœ¨æˆ‘ä»¬å¯¹ç®¡é“è¿›è¡Œåˆ†æ”¯ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`RunProxy`æ‰©å±•æ–¹æ³•æ¥é…ç½®ä»£ç†ä¸­é—´ä»¶ï¼Œä½¿ç”¨`ForwardTo`æ‰©å±•æ–¹æ³•æ¥å¼€å§‹è¯·æ±‚çš„è½¬å‘ï¼Œå…¶ä¸­æˆ‘ä»¬æŒ‡æ˜äº†ç›®æ ‡ç«¯ç‚¹ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª`ForwardContext`å®ä¾‹ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥è¿›è¡Œé¢å¤–çš„é…ç½®ï¼Œå¹¶æœ€ç»ˆè½¬å‘è¯·æ±‚ã€‚

é™¤äº†æ‰€éœ€çš„ç›®æ ‡ç«¯ç‚¹ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å°†å…¶é…ç½®ä¸ºå¤åˆ¶å¤–éƒ¨åå‘ä»£ç†(HAProxy)å¯èƒ½åŒ…å«åœ¨è¯·æ±‚ä¸­çš„ä»»ä½•`X-Forwarded-*` HTTP å¤´ã€‚æœ€åï¼Œåœ¨å®é™…è½¬å‘è¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åŒ…å« API è¯†åˆ«ç”¨æˆ·æ‰€éœ€çš„ JWT ä»¤ç‰Œã€‚ä»¥å‰æˆ‘ä»¬æ˜¯åœ¨`HttpClient`çº§(ç”¨`DelegatingHandler`)å®Œæˆçš„ï¼Œä½†æ˜¯æœ‰äº† ProxyKitï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ä¸­é—´ä»¶ä¸­å®Œæˆã€‚æ³¨æ„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é…ç½® ProxyKit ä½¿ç”¨çš„`HttpClient`ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä½¿ç”¨å‰é¢çš„æ–¹æ³•(æ›´å¤šä¿¡æ¯[åœ¨è¿™é‡Œ](https://github.com/damianh/ProxyKit#24-configuring-proxykits-httpclient))ã€‚

æœ‰äº†è¿™äº›ï¼ŒBFF ç°åœ¨å¯ä»¥è‡ªåŠ¨åœ°å°†è¯·æ±‚è½¬å‘ç»™ç»„ç®¡ç† APIã€‚

### å‡†å¤‡æ›´å¤šæ”¯æŒ API

æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œæˆ‘ä»¬åªæ˜¯ä¸ºç»„ç®¡ç† API ç¡¬ç¼–ç é…ç½®ã€‚å¦‚æœæˆ‘ä»¬åªæ˜¯è¿™æ ·åšï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸åœ¨ç®¡é“ä¸­ä¸ºæ¯ä¸ªåå°æœåŠ¡æ·»åŠ ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè¿™æ˜¯éå¸¸ä¸ç†æƒ³çš„ã€‚

ç›¸åï¼Œè®©æˆ‘ä»¬é‡æ–°è®¾è®¡ä¸­é—´ä»¶é…ç½®ï¼Œä½¿å…¶æ›´å®¹æ˜“ä»£ç†æ›´å¤šçš„æœåŠ¡ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å°†å‘`appsettings`æ·»åŠ ä¸€äº›ä¸œè¥¿ï¼Œå…è®¸æˆ‘ä»¬å°†ä¸€ä¸ª API æ˜ å°„åˆ°å®ƒçš„ç«¯ç‚¹ã€‚

`appsetings.DockerDevelopment.json`

```
"ApiRoutes":  {  "groups":  "http://groupmanagement:80"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥å°†è¯·æ±‚è·¯ç”±åŒ¹é…åˆ°ç«¯ç‚¹ï¼Œå°±åƒæˆ‘ä»¬åœ¨è®¾ç½®æ–‡ä»¶ä¸­é…ç½®çš„é‚£æ ·ã€‚ä¸ºæ­¤ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªåä¸º`ProxiedApiRouteEndpointLookup`çš„æ–°ç±»ã€‚æˆ‘ä¸ä¼šæ·±å…¥è®¨è®ºå®ç°çš„ç»†èŠ‚ï¼Œå› ä¸ºæˆ‘è®¤ä¸ºè¿™æ˜¯ä¸‹ä¸€é›†çš„ä¸€ä¸ªæœ‰è¶£çš„è¯é¢˜(æˆ‘å–œæ¬¢åœ¨å‡†å¤‡ä¸Šä¸€é›†çš„æ—¶å€™æƒ³åˆ°ä¸‹ä¸€é›†çš„æƒ³æ³•ğŸ™‚)ï¼Œä½†æˆ‘è¿˜æ˜¯ä¼šæŠŠä»£ç æ”¾åœ¨è¿™é‡Œä¾›å‚è€ƒã€‚

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\ApiRouting\ProxiedApiRouteEndpointLookup.cs`

```
public class ProxiedApiRouteEndpointLookup
{
    // The double dictionary strategy can be simplified if we're able to lookup directly with a ReadOnlySpan<char>
    // Work in progress here -> https://github.com/dotnet/corefx/issues/31942

    private readonly Dictionary<string, string> _routeToEndpointMap;
    private readonly Dictionary<int, string[]> _routeMatcher;

    public ProxiedApiRouteEndpointLookup(Dictionary<string, string> routeToEndpointMap)
    {
        _routeToEndpointMap = routeToEndpointMap ?? throw new ArgumentNullException(nameof(routeToEndpointMap));
        _routeMatcher = _routeToEndpointMap
            .Keys
            .GroupBy(
                r => r.GetHashCode(),
                r => r)
            .ToDictionary(
                g => g.Key,
                g => g.ToArray());
    }

    public bool TryGet(PathString path, out string endpoint)
    {
        endpoint = null;
        var pathSpan = path.Value.AsSpan();
        var basePathEnd = pathSpan.Slice(1, pathSpan.Length - 1).IndexOf('/');
        var basePath = pathSpan.Slice(1, basePathEnd > 0 ? basePathEnd : pathSpan.Length - 1);

        // when we upgrade to .NET Core 3.0, we can use string.GetHashCode(basePath)
        // to get the hashcode directly from the span, which will be much better for allocations
        if (_routeMatcher.TryGetValue(basePath.ToString().GetHashCode(), out var routes))
        {
            var route = FindRoute(basePath, routes);
            return !(route is null) && _routeToEndpointMap.TryGetValue(route, out endpoint);
        }

        return false;
    }

    private static string FindRoute(ReadOnlySpan<char> route, string[] routes)
    {
        for (var i = 0; i < routes.Length; ++i)
        {
            var currentRoute = routes[i];
            if (MemoryExtensions.Equals(route, currentRoute, StringComparison.InvariantCultureIgnoreCase))
            {
                return currentRoute;
            }
        }
        return null;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŒæ ·ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬ 030 é›†çœ‹åˆ°æ›´å¤šç»†èŠ‚ï¼Œä½†ç°åœ¨é‡è¦çš„æ˜¯`ProxiedApiRouteEndpointLookup`åœ¨æ„é€ å‡½æ•°ä¸­æ¥æ”¶åˆ°è·¯ç”±æ˜ å°„ï¼Œç„¶åèƒ½å¤Ÿé€šè¿‡è°ƒç”¨`TryGet`æ–¹æ³•å°†è¯·æ±‚è·¯å¾„æ˜ å°„åˆ° API è·¯ç”±ã€‚

ä¸ºäº†åœ¨ä¸­é—´ä»¶ä¸­ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­é…ç½®å®ƒ:

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\Startup.cs`

```
services.AddSingleton(
    new ProxiedApiRouteEndpointLookup(
        _configuration.GetSection<Dictionary<string, string>>("ApiRoutes"))); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬å¯ä»¥è°ƒæ•´ä¸­é—´ä»¶é…ç½®:

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\Startup.cs`

```
app.Map("/api", api =>
{
    api.RunProxy(async context =>
    {
        var endpointLookup = context.RequestServices.GetRequiredService<ProxiedApiRouteEndpointLookup>();
        if (endpointLookup.TryGet(context.Request.Path, out var endpoint))
        {
            var forwardContext = context
                .ForwardTo(endpoint)
                .CopyXForwardedHeaders();

            var token = await context.GetAccessTokenAsync();
            forwardContext.UpstreamRequest.SetBearerToken(token);

            return await forwardContext.Send();
        }

        return new HttpResponseMessage(HttpStatusCode.NotFound);
    });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·æ³¨æ„ï¼Œ`app.Map`ç°åœ¨æ˜ å°„åˆ°ä»»ä½•åŸºäº`/api`çš„è·¯ç”±ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åŒ¹é…ä»»ä½• API æœåŠ¡ï¼Œè€Œä¸ä»…ä»…æ˜¯ç»„ç®¡ç†ã€‚

ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨`ProxiedApiRouteEndpointLookup`å°è¯•å°†è¯·æ±‚è·¯å¾„åŒ¹é…åˆ°æ”¯æŒæœåŠ¡ã€‚å¦‚æœæœ‰åŒ¹é…ï¼Œæˆ‘ä»¬åƒä»¥å‰ä¸€æ ·åšï¼Œåªæ˜¯ä½¿ç”¨æä¾›çš„ç«¯ç‚¹è€Œä¸æ˜¯ç¡¬ç¼–ç çš„ç«¯ç‚¹ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œæˆ‘ä»¬ç”¨ 404 å“åº”ã€‚

## è°ƒæ•´åŸºäº MVC çš„è¡Œä¸º

ä»£ç†éƒ¨åˆ†å·²ç»å®Œæˆï¼Œä½†æˆ‘ä»¬è¿˜æ²¡æœ‰å®Œæˆã€‚å› ä¸ºä»¥å‰æˆ‘ä»¬åŸºæœ¬ä¸Šæ˜¯åœ¨ä¸€ä¸ªæ§åˆ¶å™¨ä¸­æ‰‹åŠ¨ä»£ç†è¯·æ±‚(`GroupsController`)ï¼Œæ‰€ä»¥æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½ä½¿ç”¨ MVCï¼Œå³é€šè¿‡ä½¿ç”¨ MVC è¿‡æ»¤å™¨(`AuthorizeFilter`)ä»¥åŠé˜²ä¼ªä»¤ç‰ŒéªŒè¯(`AutoValidateAntiforgeryTokenAttribute`)æ¥å¼ºåˆ¶æˆæƒã€‚

éšç€è¿™ç§åœ¨ MVC ä¹‹å¤–åšäº‹æƒ…çš„ç§»åŠ¨ï¼Œè¿™å°†ä¸å†èµ·ä½œç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠè¿™äº›ä¹Ÿæ”¾å…¥ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ‰€ä»¥å®ƒé€‚ç”¨äº BFF ä¸­çš„ä¸€åˆ‡ï¼Œä¸ç®¡æ˜¯ä¸æ˜¯ MVCã€‚

### åœ¨ä¸­é—´ä»¶çº§åˆ«å®æ–½è®¤è¯

ä¸ºäº†åœ¨ä¸­é—´ä»¶çº§åˆ«å®æ–½èº«ä»½éªŒè¯ï¼Œæˆ‘ä»¬...åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶ï¼ğŸ™ƒ

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\Security\EnforceAuthenticatedUserMiddleware.cs`

```
public class EnforceAuthenticatedUserMiddleware : IMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        if (!context.User.Identity.IsAuthenticated)
        {
            await context.ChallengeAsync();
            return;
        }

        await next(context);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æƒ³å¾ˆç®€å•ã€‚æˆ‘ä»¬åœ¨ã€ŠT2ã€‹ç¬¬ 008 é›†ä¸­å­¦åˆ°äº†å®ç°ä¸­é—´ä»¶ï¼Œæ‰€ä»¥å®ç°`IMiddleware`å’Œ`InvokeAsync`æ–¹æ³•åº”è¯¥çœ‹èµ·æ¥å¾ˆç†Ÿæ‚‰ã€‚

è‡³äºåœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè¿è¡Œçš„ä»£ç ï¼Œæˆ‘ä»¬åªæ˜¯æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç»è¿‡èº«ä»½éªŒè¯ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰é€šè¿‡èº«ä»½éªŒè¯ï¼Œæˆ‘ä»¬è°ƒç”¨`HttpContext`ä¸Šçš„`ChallengeAsync`æ‰©å±•æ–¹æ³•æ¥å‘å‡ºç™»å½•è¯·æ±‚ï¼Œè¿™å¯èƒ½å¯¼è‡´ 401 æˆ–é‡å®šå‘åˆ° auth æœåŠ¡ï¼Œè¿™å–å†³äºè¯·æ±‚çš„ç›®æ ‡ç«¯ç‚¹ã€‚

æˆ‘ä»¬ä½¿ç”¨ä¸­é—´ä»¶æ‰€è¦åšçš„å°±æ˜¯å°†å®ƒæ·»åŠ åˆ° DI å’Œç®¡é“ä¸­:

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\Startup.cs`

```
// in ConfigureServices
services.AddSingleton<EnforceAuthenticatedUserMiddleware>();

// ...

// in Configure, between app.UseAuthentication() and app.UseMvc()
app.UseMiddleware<EnforceAuthenticatedUserMiddleware>(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### åœ¨ä¸­é—´ä»¶å±‚éªŒè¯é˜²ä¼ªä»¤ç‰Œ

ä¸ºäº†éªŒè¯é˜²ä¼ªä»¤ç‰Œï¼Œæˆ‘ä»¬å®ç°äº†å¦ä¸€ä¸ªä¸­é—´ä»¶ã€‚

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\Security\ValidateAntiForgeryTokenMiddleware.cs`

```
public class ValidateAntiForgeryTokenMiddleware : IMiddleware
{
    private readonly IAntiforgery _antiforgery;

    public ValidateAntiForgeryTokenMiddleware(IAntiforgery antiforgery)
    {
        _antiforgery = antiforgery;
    }

    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        if (ShouldValidate(context))
        {
            await _antiforgery.ValidateRequestAsync(context);
        }

        await next(context);
    }

    private static bool ShouldValidate(HttpContext context)
    {
        // as seen on https://github.com/aspnet/AspNetCore/blob/release/3.0/src/Mvc/Mvc.ViewFeatures/src/Filters/AutoValidateAntiforgeryTokenAuthorizationFilter.cs

        var method = context.Request.Method;
        return !(HttpMethods.IsGet(method)
                 || HttpMethods.IsHead(method)
                 || HttpMethods.IsTrace(method)
                 || HttpMethods.IsOptions(method));
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŒæ ·ï¼Œæ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ã€‚å¯¹äºæ¯ä¸ªè¯·æ±‚ï¼Œå¦‚æœå®ƒåº”è¯¥è¢«éªŒè¯ï¼Œæˆ‘ä»¬å°±è¿™æ ·åšï¼Œå¦åˆ™æˆ‘ä»¬å°±è®©å®ƒè¿‡å»ã€‚æ˜¯å¦éœ€è¦éªŒè¯å–å†³äºè¯·æ±‚çš„æ–¹æ³•ï¼Œå› ä¸ºæœ‰äº›æ–¹æ³•è¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œä¸éœ€è¦éªŒè¯ã€‚

ä½¿ç”¨æ–¹æ³•åŒ`EnforceAuthenticatedUserMiddleware`:

`WebFrontend\server\src\CodingMilitia.PlayBall.WebFrontend.BackForFront.Web\Startup.cs`

```
// in ConfigureServices
services.AddSingleton<ValidateAntiForgeryTokenMiddleware>();

// ...

// in Configure, after the use of EnforceAuthenticatedUserMiddleware
app.UseMiddleware<ValidateAntiForgeryTokenMiddleware>(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## å…¶ä»–

å¦ä¸€é›†çš„ç»“å°¾ã€‚å¦‚æœæˆ‘ä»¬ç°åœ¨è¿è¡Œåº”ç”¨ç¨‹åºï¼Œåˆ©ç”¨æˆ‘ä»¬çš„ Docker Compose ç¯å¢ƒï¼Œæˆ‘ä»¬åº”è¯¥çœ‹åˆ°åº”ç”¨ç¨‹åºåƒä»¥å‰ä¸€æ ·è¿è¡Œã€‚

æˆ‘ä»¬æ²¡æœ‰åœ¨ä¸ºåº”ç”¨ç¨‹åºæ·»åŠ æ›´å¤šåŠŸèƒ½æ–¹é¢å–å¾—è¿›å±•ï¼Œä½†æˆ‘ä»¬åœ¨æœªæ¥ä½¿è¿™ä¸€ç‚¹å˜å¾—æ›´å®¹æ˜“ï¼Œä¸éœ€è¦ä¸ºåç«¯æœåŠ¡ä¸Šçš„æ¯ä¸€ä»¶å°äº‹è€Œä¸ BFF å‘ç”Ÿå†²çªã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œæˆ‘ä»¬ç¡®å®ä¿ç•™äº†åœ¨ BFF çº§åˆ«å®ç°äº‹ç‰©çš„èƒ½åŠ›ï¼Œæ‰€ä»¥è¿™æ˜¯æ•æ·æ€§å’Œçµæ´»æ€§ä¹‹é—´çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¸­é—´åœ°å¸¦ã€‚

ä¸æœ¬ç³»åˆ—ä¸­çš„å…¶ä»–å†…å®¹ä¸€æ ·ï¼Œæˆ‘æ²¡æœ‰æ¢ç©¶ ProxyKit æä¾›çš„æ‰€æœ‰å†…å®¹ï¼Œè€Œæ˜¯åªç ”ç©¶äº†æˆ‘æƒ³åšçš„äº‹æƒ…æ‰€éœ€è¦çš„å†…å®¹ã€‚è¦äº†è§£æ›´å¤šç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹å…¶ GitHub é¡µé¢ã€‚

å¸–å­ä¸­çš„é“¾æ¥:

*   [ProxyKit](https://github.com/damianh/ProxyKit)
*   [è±¹çŒ«](https://github.com/ThreeMammals/Ocelot)
*   [æ¨¡å¼:API ç½‘å…³/å‰ç«¯åç«¯](https://microservices.io/patterns/apigateway.html)
*   [ä¿æŠ¤ spa çš„å¦ä¸€ç§æ–¹æ³•(ä½¿ç”¨ ASP.NET æ ¸å¿ƒã€OpenID è¿æ¥ã€OAuth 2.0 å’Œ ProxyKit)](https://leastprivilege.com/2019/01/18/an-alternative-way-to-secure-spas-with-asp-net-core-openid-connect-oauth-2-0-and-proxykit/)
*   [ç¬¬ 020 é›†-åç«¯å¯¹å‰ç«¯å’Œ http client-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°çŸ«æ‰è¿‡æ­£](https://blog.codingmilitia.com/2019/05/05/aspnet-020-from-zero-to-overkill-backend-for-frontend-httpclient)
*   [ç¬¬ 008 é›†â€”â€”ä¸­å“â€”â€”ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°çŸ«æ‰è¿‡æ­£](https://blog.codingmilitia.com/2018/12/05/aspnet-008-from-zero-to-overkill-middlewares)

è¿™ç¯‡æ–‡ç« çš„æºä»£ç åˆ†å¸ƒåœ¨[â€œç¼–ç æ°‘å…µ:ASP.NET æ ¸å¿ƒâ€”â€”ä» 0 åˆ°è¿‡åº¦æ€æˆ®â€ç»„ç»‡](https://github.com/AspNetCoreFromZeroToOverkill)çš„å­˜å‚¨åº“ä¸­ï¼Œæ ‡è®°ä¸º`episode029`ã€‚

*   [è®¤è¯](https://github.com/AspNetCoreFromZeroToOverkill/Auth/tree/episode029)
*   [web å‰ç«¯](https://github.com/AspNetCoreFromZeroToOverkill/WebFrontend/tree/episode029)
*   [éƒ¨ç½²](https://github.com/AspNetCoreFromZeroToOverkill/Deployment/tree/episode029)

æ„Ÿè°¢åˆ†äº«å’Œåé¦ˆï¼

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼