# æ¢ç´¢ CSS ç”»å›¾ API

> åŸæ–‡:[https://dev.to/bobrov1989/exploring-the-css-paint-api-4o9d](https://dev.to/bobrov1989/exploring-the-css-paint-api-4o9d)

CSS Paint API æ˜¯ Houdini é¡¹ç›®çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¯åœ¨æµè§ˆå™¨çš„ç¨³å®šç‰ˆæœ¬ä¸­ä½¿ç”¨ã€‚It è°·æ­Œ Chrome å›¢é˜Ÿåœ¨ 3 æœˆ 6 æ—¥å°†å…¶æ·»åŠ åˆ° Chrome 65 ä¸­ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶é—´å»å°è¯•å’Œå¼€å§‹å®éªŒã€‚æˆ‘æƒ³è®©ä½ å¼€å§‹åšè‡ªå·±çš„å®éªŒã€‚

## [](#what-is-houdini)ä»€ä¹ˆæ˜¯èƒ¡è¿ªå°¼ï¼Ÿ

åœ¨æˆ‘ä»¬å¼€å§‹æ¢ç´¢ CSS Paint API ä¹‹å‰ï¼Œè®©æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ Houdini é¡¹ç›®ã€‚æˆ‘ä¸ä¼šè¯´å¤ªå¤šçš„ç»†èŠ‚ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œæˆ‘ä¼šç»™ä½ æä¾›èµ„æºé“¾æ¥ã€‚

å› æ­¤ï¼ŒHoudini æ˜¯ä¸€ç»„ APIï¼Œå…è®¸æ‚¨ä¸ CSS å¼•æ“å†…éƒ¨è¿›è¡Œäº¤äº’ã€‚ä¸å¹¸çš„æ˜¯ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬ä»…é™äºé€šè¿‡ JavaScript ä½¿ç”¨ CSSOM (CSS å¯¹è±¡æ¨¡å‹)çš„æŸä¸ªéƒ¨åˆ†ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ JS å°è¯• polyfill CSSï¼Œä½†æ˜¯è¦åœ¨æµè§ˆå™¨æ¸²æŸ“ stage ä¹‹åã€‚å¹¶ä¸”åœ¨æ”¹å˜ä¹‹åï¼Œæµè§ˆå™¨éœ€è¦å†æ¬¡æ‰§è¡Œå±å¹•æ¸²æŸ“ã€‚ä½†æ˜¯æœ‰äº† Houdiniï¼Œæˆ‘ä»¬å¯ä»¥åƒå¯¹å¾… JS ä¸€æ ·æ‰©å±•æ ·å¼ã€‚

Houdini APIs åœ¨è¿™é‡Œä¸ CSS è§£æå™¨ã€CSSOMã€çº§è”ã€å¸ƒå±€ã€ç»˜åˆ¶å’Œå¤åˆæ¸²æŸ“é˜¶æ®µä¸€èµ·å·¥ä½œã€‚API æœ‰ä¸¤å¤§ç±»:CSS å±æ€§&å€¼å’Œå·¥ä½œå°ç¨‹åºã€‚worklets æ¶µç›–äº†æ¸²æŸ“çŠ¶æ€è®¿é—®:å¸ƒå±€ã€ç»˜åˆ¶å’Œåˆæˆã€‚å½“å±æ€§å’Œå€¼å…³æ³¨äºè§£æå™¨æ‰©å±•æ—¶ï¼Œä½¿ç”¨ CSSOM å’Œ cascadeã€‚ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹æ¯ä¸ª API [çš„æµè§ˆå™¨å®ç°çŠ¶æ€ï¼Œåœ¨è¿™é‡Œ](https://ishoudinireadyyet.com/)æŸ¥çœ‹æ›´å¤šå…³äºå®ƒçš„ä¿¡æ¯[ã€‚](https://developers.google.com/web/updates/2016/05/houdini)

## [](#css-paint-worklet)CSS ç”»å›¾å°å·¥å…·

CSS ç”»å›¾ API æ˜¯ä¸€ç§ workletsï¼Œä½ æ€ä¹ˆèƒ½ç†è§£å®ƒçš„åå­—ä¸ç”»å›¾æ¸²æŸ“è¿‡ç¨‹ã€‚å®ƒæ˜¯åšä»€ä¹ˆçš„ï¼Ÿå®ƒå…è®¸ä½ ç”¨ JavaScript åˆ›å»ºè‡ªå®šä¹‰çš„ CSS å‡½æ•°æ¥ç»˜åˆ¶å›¾åƒä½œä¸ºèƒŒæ™¯ã€‚ç„¶åå¯¹ä»»ä½•éœ€è¦å›¾åƒçš„ CSS å±æ€§ä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚æ¯”å¦‚ä½ å¯ä»¥ç”¨å®ƒæ¥åš`background-image`ã€`border-image`æˆ–è€…`list-style-image`ã€‚ä½†æ›´ä»¤äººå…´å¥‹çš„æ˜¯ï¼Œå®ƒè¿˜å¯ä»¥ç”¨äºè‡ªå®šä¹‰ CSS å±æ€§ï¼Œæˆ‘ä»¬ç¨åå°†å›åˆ°å®ƒä»¬ã€‚

å¯¹äºç”¨ JavaScript ç”»å›¾ï¼Œæ‚¨å…è®¸ä½¿ç”¨å—é™ç‰ˆæœ¬çš„ Canvas APIã€‚ä¸ºä»€ä¹ˆæœ‰é™ï¼Ÿå‡ºäºå®‰å…¨åŸå› ï¼Œæ‚¨ä¸èƒ½ä»å›¾åƒä¸­è¯»å–åƒç´ æˆ–å‘ˆç°æ–‡æœ¬ã€‚ä½†æ˜¯ä½ å¯ä»¥ç”»åœ†å¼§ï¼ŒçŸ©å½¢ï¼Œè·¯å¾„ç­‰ç­‰ã€‚

### [](#why-we-need-css-paint-api)ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ CSS ç”»å›¾ APIï¼Ÿ

ç›®å‰æˆ‘è„‘æµ·ä¸­æœ‰å‡ ä¸ªç”¨ä¾‹:

1.  CSS polyfills å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ JavaScript ä¸º CSS ç¼–å†™ polyfillï¼Œä½†æ˜¯è€ƒè™‘åˆ°å¯ç”¨æ€§å’Œæ€§èƒ½ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œè¯»åˆ°ä¸€äº›å…³äºé‚£ä¸ª[çš„æƒ³æ³•ã€‚ä½†æ˜¯ CSS Paint æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œä¾‹å¦‚ï¼Œçœ‹çœ‹`conic-gradient`](https://philipwalton.com/articles/the-dark-side-of-polyfilling-css/) [polyfill ç¤ºä¾‹](https://lab.iamvdo.me/houdini/conic-gradient)ã€‚

2.  å‡å°‘ DOM èŠ‚ç‚¹çš„æ•°é‡â€”â€”æœ‰æ—¶æˆ‘ä»¬éœ€è¦æ·»åŠ è™šæ‹Ÿçš„ DOM èŠ‚ç‚¹ï¼Œæ¯”å¦‚`span`åªæ˜¯ä¸ºäº†è§†è§‰æ•ˆæœã€‚æ­¤å¤–ï¼Œä¸€äº›åŠ¨ç”»å¯èƒ½éœ€è¦é¢å¤–çš„å…ƒç´ ã€‚çœ‹çœ‹å®ç°æè´¨è®¾è®¡çš„ç”»å®¶[çš„ã€æ¶Ÿæ¼ªã€‘åŠ¨ç”»](https://lab.iamvdo.me/houdini/ripple)ã€‚åœ¨ original Material Design library ä¸­ï¼Œå®ƒä¸ºè¯¥åŠ¨ç”»åˆ›å»ºäº†ä¸¤ä¸ªé¢å¤–çš„`span`å…ƒç´ ï¼Œè€Œ worklet æ— éœ€è¿™æ ·åšã€‚ç°åœ¨å‡è®¾é¡µé¢ä¸Šæœ‰ 10 ä¸ªå…·æœ‰â€œæ¶Ÿæ¼ªâ€æ•ˆæœçš„æŒ‰é’®ï¼ŒCSS paint ä¸ºæ‚¨èŠ‚çœäº† 20 ä¸ª DOM èŠ‚ç‚¹ã€‚

3.  èŠ±å“¨çš„èƒŒæ™¯â€”â€”ä½ å¯ä»¥ç”¨ä¸å¯»å¸¸çš„å›¾æ¡ˆå’ŒèƒŒæ™¯ä¸ºæœ€ç»ˆç”¨æˆ·åˆ›é€ æŸç§æ–°çš„ä½“éªŒã€‚è¿™é‡Œçš„å¥½å¤„æ˜¯ï¼Œå®ƒä»¬ä¸ä¼šå½±å“æ€§èƒ½ï¼Œå¹¶ä¸”å¯ä»¥ç”¨ä½œæ¸è¿›å¢å¼ºçš„ä¸€éƒ¨åˆ†ã€‚

### [](#how-to-use-css-paint-in-styles)å¦‚ä½•åœ¨æ ·å¼ä¸­ä½¿ç”¨ CSS ç”»å›¾ï¼Ÿ

è¦åœ¨ä½ çš„æ ·å¼è¡¨ä¸­ä½¿ç”¨è‡ªå®šä¹‰ç”»å›¾ï¼Œä½ éœ€è¦ä½¿ç”¨`paint`å‡½æ•°ï¼Œå¹¶ä¼ é€’ä½ çš„ç”»å›¾åç§°ï¼Œä»¥åŠä»»ä½•éœ€è¦çš„å‚æ•°ã€‚ä¸‹é¢æ˜¯å®ƒå¯èƒ½çš„æ ·å­:

```
div {
  background-image: paint(my-custom-paint);
} 
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†åä¸º`my-custom-paint`çš„è‡ªå®šä¹‰ç”»å›¾ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æƒ³è±¡å®ƒå…è®¸æˆ‘ä»¬ä¼ é€’é¢å¤–çš„å‚æ•°ï¼Œæ¯”å¦‚é¢œè‰²:

```
div {
  background-image: paint(my-custom-paint, #fff);
} 
```

çœ‹èµ·æ¥å’Œæˆ‘ä»¬çš„ä¸€äº› CSS å†…ç½®å‡½æ•°å¾ˆç›¸ä¼¼ï¼Œæ¯”å¦‚`linear-gradient`:

```
div {
  background-image: linear-gradient(to bottom, #fff, #000);
} 
```

ç”±äº`paint`åªæ˜¯ CSS å£°æ˜çš„ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥å¯¹äºå¸¦æœ‰çº¯è‰²æˆ–å›¾åƒçš„æ—§æµè§ˆå™¨æ¥è¯´ï¼Œå¾ˆå®¹æ˜“å°†å…¶é€€å›:

```
.paint-with-fallback {
  background-image: url('./my-paint-fallback.jpg');
  background-image: paint(my-custom-paint);
} 
```

æˆ–è€…æˆ‘ä»¬å¯ä»¥æ£€æŸ¥ CSS ä¸­çš„æµè§ˆå™¨æ”¯æŒ:

```
.paint-with-fallback {
  background-image: url('./my-paint-fallback.jpg');
}

@supports(background-image: paint(id)) {
  .paint-with-fallback {
    background-image: paint(my-custom-paint);
  }
} 
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸æ”¯æŒ CSS Paint API çš„æµè§ˆå™¨å°†å¿½ç•¥ last `background-image`å£°æ˜ï¼Œè€Œä½¿ç”¨ä¸€äº›é™æ€å›¾åƒã€‚

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å°†åˆ›å»ºä¸€äº›å¹¿æ³›ä½¿ç”¨çš„ç”»å¸ˆï¼Œè¿™å°†æ˜¯ä¼Ÿå¤§çš„è‡ªåŠ¨åŒ–å›é€€æ’å…¥ï¼Œå› ä¸ºäººç±»å¯èƒ½ä¼šå¿˜è®°å®ƒã€‚æˆ‘æœ‰ä¸€ä¸ªå¥½æ¶ˆæ¯è¦å‘Šè¯‰ä½ ï¼ŒPostCSS å¯ä»¥ç”¨ä¸€ä¸ªæ’ä»¶ä¸ºæˆ‘ä»¬åšè¿™ä»¶äº‹ã€‚è¦ç¼–å†™è¿™æ ·ä¸€ä¸ªæ’ä»¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¾ˆå¤šè¡Œä»£ç ã€‚PostCSS ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€å †æ–¹ä¾¿çš„åŠ©æ‰‹å·¥å…·æ¥éå† CSS AST(æŠ½è±¡è¯­æ³•æ ‘)å¹¶æ“ä½œå®ƒã€‚ä¸‹é¢æ˜¯è¿™æ ·ä¸€ä¸ªæ’ä»¶çš„ä¾‹å­ï¼Œå®ƒç”¨ä¸€ä¸ªä½œä¸º`fallbackValue`é€‰é¡¹ä¼ é€’çš„é™æ€å›é€€å€¼æ¥æ›¿æ¢è‡ªå®šä¹‰ç»˜ç”»:

```
const postcss = require('postcss');

module.exports = postcss.plugin(
  'postcss-fallback-my-paint',
  options => {
    return css => {
      css.walkRules(rule => {
        rule.walkDecls(decl => {
          const value = decl.value;

          if (value.includes('my-custom-paint')) {
            decl.cloneBefore({value: options.fallbackValue});
          }
        });
      });
    };
  }
); 
```

è¿™ä¸ªæ’ä»¶å°†éå†æ‰€æœ‰ CSS è§„åˆ™ï¼Œç„¶åéå†å…¶ä¸­çš„æ‰€æœ‰å£°æ˜ã€‚look for `my-css-paint`è°ƒç”¨å’Œ insert clones å£°æ˜ before with value replaced ä»¥å›é€€ã€‚ä¸æ˜¯é‚£ä¸ªğŸš€ç§‘å­¦ï¼Œä¸æ˜¯å—ï¼Ÿ

### [](#how-to-create-custom-css-paint)å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰ CSS ç”»å›¾ï¼Ÿ

é‚£ä¹ˆå¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰ CSS ç”»å›¾å‘¢ï¼Ÿåªéœ€ä¸‰ä¸ªæ­¥éª¤:

1.  å£°æ˜ä¸€ä¸ªè‡ªå®šä¹‰ç»˜åˆ¶ç±»
2.  æ³¨å†Œæ²¹æ¼†
3.  åŠ è½½å·¥ä½œæµ

æ‰€ä»¥ï¼Œé¦–å…ˆæˆ‘ä»¬è¦å£°æ˜ CSS ç”»å›¾ç±»ã€‚åº”è¯¥æ˜¯å¸¦`paint`æ–¹æ³•çš„ JavaScript ç±»ã€‚æˆ‘ä»¬ç¨åå°†æ¢è®¨è¿™ç§æ–¹æ³•åŠå…¶å‚æ•°ï¼Œç°åœ¨åªçœ‹åº•å±‚å®ç°:

```
class MyCustomPainter {
  paint(ctx, geom, props, args) {
    // paint implementation.
  }
} 
```

ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œæ–°å®šä¹‰çš„ç”»å®¶:

```
registerPaint('my-custom-paint', MyCustomPainter); 
```

æˆ‘ä»¬ä½¿ç”¨äº†`registerPaint`å‡½æ•°ï¼Œå°† paint name ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°†æˆ‘ä»¬çš„ç±»å¼•ç”¨ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘æƒ³æ³¨æ„åˆ°æˆ‘ä»¬çš„ paint æ¨¡å—æ–‡ä»¶ä¸ç±»å’Œæ³¨å†Œè°ƒç”¨æœ‰ä¸€ä¸ªå•ç‹¬çš„ä¸Šä¸‹æ–‡ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½è®¿é—®å…¨å±€æµè§ˆå™¨èŒƒå›´å†…çš„ä»»ä½•å‡½æ•°æˆ–å˜é‡ï¼Œç”šè‡³ä¸èƒ½åŠ è½½ä»»ä½•ä¾èµ–è„šæœ¬ã€‚

æ¥ä¸‹æ¥ï¼Œæœ€åä¸€æ­¥æ˜¯åŠ è½½ workletï¼Œè¿™æ ·ä¹‹åï¼Œæ‚¨å°±å¯ä»¥åœ¨æ ·å¼è¡¨ä¸­ä½¿ç”¨å®ƒäº†:

```
if ('paintWorklet' in CSS) {
  CSS.paintWorklet.addModule('my-custom-paint.js');
} 
```

é¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥`paintWorklet`åœ¨æµè§ˆå™¨ä¸­æ˜¯å¦å¯ç”¨ï¼Œç„¶åæ³¨å†Œæˆ‘ä»¬çš„è‡ªå®šä¹‰ç”»å›¾ï¼Œè°ƒç”¨`CSS.paintWorklet`ä¸Šå”¯ä¸€å¯ç”¨çš„æ–¹æ³•`addModule`ã€‚å®ƒæ¥å—ä¸€ä¸ªæŒ‡å‘æˆ‘ä»¬çš„ worklet JavaScript æ–‡ä»¶çš„å‚æ•°è·¯å¾„ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡é¢å¤–çš„`else`è¯­å¥é€‰æ‹© CSS Paint çš„åŸºäº JavaScript çš„å›é€€ã€‚

è¿™é‡Œåº”è¯¥å¦‚ä½•çœ‹å¾…æœ€ç»ˆç»“æœ:

```
// my-custom-paint.js

class MyCustomPainter {
  paint(ctx, geom, props, args) {
    // paint implementation.
  }
}

registerPaint('my-custom-paint', MyCustomPainter); 
```

```
// script loaded on page - script.js

if ('paintWorklet' in CSS) {
  CSS.paintWorklet.addModule('my-custom-paint.js');
} 
```

## [](#practice)ç»ƒä¹ 

ç”»å›¾ API ä»‹ç»å®Œåï¼Œæœ€å¥½çš„æƒ³æ³•å°±æ˜¯å°è¯•ä¸€ä¸‹ã€‚è®©æˆ‘ä»¬ä»æœ€åŸºæœ¬çš„ä¾‹å­å¼€å§‹â€”â€”åˆ›å»ºä¸€ä¸ªç»˜åˆ¶å‡ ä¸ªåœ†åœˆä½œä¸ºèƒŒæ™¯çš„ç”»å¸ˆã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸º paint å®šä¹‰ä¸€ä¸ªç±»å¹¶æ³¨å†Œå®ƒ:

```
// paint.js

class CirclesPainter {
  paint(ctx, geom) {
    const offset = 10;
    const size = Math.min(geom.width, geom.height);
    const radius = (size / 4) - offset;
    const point = radius + offset;

    for (let i = 0; i < 2; i++) {
      for (let j = 0; j < 2; j++) {
        ctx.fillStyle = `rgb(0, ${Math.floor(255 - 42.5 * i)}, ${Math.floor(255 - 42.5 * j)})`;

        ctx.beginPath();
        ctx.arc(point + (i * (point * 2)), point + (j * (point * 2)), radius, 0, 2 * Math.PI);
        ctx.fill();
      }
    }
  }
}

registerPaint('circles', CirclesPainter); 
```

æˆ‘ä»¬ç”¨`paint`æ–¹æ³•åˆ›å»ºäº†`CirclesPainter`ç±»ã€‚è¿™ä¸ªæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°:`ctx`å’Œ`geom`å¯¹è±¡ï¼Œå‰è€…æ˜¯æˆ‘ä»¬çš„ç”»å¸ƒä¸Šä¸‹æ–‡ï¼Œåè€…ç”±ä¸¤ä¸ªå±æ€§ç»„æˆã€‚`geom`åŒ…å«äº†æˆ‘ä»¬ç”»å¸ƒè¡¨é¢çš„`width`å’Œ`height`ã€‚ç„¶åä½¿ç”¨æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬åœ¨å¾ªç¯ä¸­ç”»å››ä¸ªåœ†ï¼Œå¹¶ç”¨è“è‰²å¡«å……å®ƒä»¬ã€‚æœ€åï¼Œæˆ‘ä»¬åœ¨é¡µé¢ä¸ŠåŠ è½½æˆ‘ä»¬çš„å·¥ä½œæµ:

```
if ('paintWorklet' in CSS) {
  CSS.paintWorklet.addModule('paint.js');
} 
```

ä¸ºäº†ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬ç”¨ç±»å`circles`åˆ›å»ºäº†ç®€å•çš„`div`ï¼Œå¹¶åœ¨æ ·å¼è¡¨ä¸­æ·»åŠ äº†åç»­è§„åˆ™:

```
.circles {
  overflow: hidden;
  height: 0;
  padding-top: 50%;
  background: #000;
  background: paint(circles);
} 
```

æ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒåšæˆæ–¹å½¢ï¼Œå¹¶æ·»åŠ é»‘è‰²ä½œä¸ºè€æµè§ˆå™¨çš„å¤‡ç”¨é¢œè‰²ã€‚å°±æ˜¯è¿™æ ·ï¼ä½ å¯ä»¥åœ¨ GitHub ä¸ŠæŸ¥çœ‹[ç»“æœ](https://bobrov.dev/css-paint-demos/hello-world/)å’Œ[ä»£ç ](https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/hello-world)ã€‚è¿™æ˜¯æ¼”ç¤º:

[https://www.youtube.com/embed/9ZVg3lrqIfg](https://www.youtube.com/embed/9ZVg3lrqIfg)

æˆ‘ç°åœ¨è¦æåˆ°çš„ä¸€ä»¶äº‹æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰æ·»åŠ ä»»ä½• resize äº‹ä»¶ç›‘å¬å™¨ï¼Œä½†æ˜¯æµè§ˆå™¨ä¼šåœ¨ä»»ä½•å¸ƒå±€æ”¹å˜æ—¶è‡ªåŠ¨è°ƒç”¨`paint`æ–¹æ³•ã€‚å½“å‰çš„ Chrome å®ç°ä½¿ç”¨ä¸» UI çº¿ç¨‹è¿›è¡Œç»˜ç”»æ¸²æŸ“ï¼Œä½†åœ¨æœªæ¥ï¼Œå®ƒå°†ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ã€‚å¯ä»¥æƒ³è±¡ä¸€äº›æ²‰é‡çš„åŠ¨ç”»æˆ–è€…èƒŒæ™¯ï¼Œå¯¹ä¸»çº¿ç¨‹çš„å½±å“ä¸ºé›¶ã€‚è¿™å°†æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ€§èƒ½æå‡ï¼

æ‚¨çš„èƒŒæ™¯å¯èƒ½ä¼šæœ‰å“åº”ï¼Œè€Œè¿™ç§å“åº”å–å†³äºå…ƒç´ æœ¬èº«çš„å¤§å°ï¼Œè€Œä¸éœ€è¦ä»»ä½•å…³äº`resize`äº‹ä»¶çš„ç›‘å¬å™¨ã€‚ç›´åˆ°`element queries`ä»ç„¶æ˜¯å»ºè®®ï¼Œä½ å¯ä»¥æ ¹æ®å…ƒç´ å¤§å°ç”Ÿæˆä¸åŒçš„å›¾ç‰‡ã€‚ç”¨[æºä»£ç ](https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/responsive)è¯•å‡º[è¿™ä¸ªä¾‹å­](https://bobrov.dev/css-paint-demos/responsive/)ã€‚å½“å…ƒç´ æ”¹å˜å°ºå¯¸æ—¶ï¼Œæˆ‘ä»¬ç”¨å¦ä¸€ç§é¢œè‰²å¡«å……æˆ‘ä»¬çš„åœ†ã€‚

è¿™ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼Œä½†æ¥ä¸‹æ¥æˆ‘æƒ³è®©æˆ‘ä»¬çš„ç»˜ç”»å¯é…ç½®ã€‚æ‰€ä»¥è®©æˆ‘ä»‹ç»å‡ ä¸ª CSS å˜é‡:

*   `--circles-offset` -æ§åˆ¶åœ†åœˆä¹‹é—´çš„è·ç¦»
*   `--circles-count` -è¡¨ç¤ºè¦æ¸²æŸ“çš„åœ†çš„æ•°é‡
*   `--circles-opacity` -æ”¹å˜åœ†åœˆçš„ä¸é€æ˜åº¦

æœ‰äº†è¿™äº›å˜é‡ï¼Œæˆ‘ä»¬å°±èƒ½åˆ›é€ å‡ºæŸç§å¯ä»¥éšæ—¶é—´å˜åŒ–çš„æ¨¡å¼ã€‚ä¸ºäº†è®¿é—® painter ç±»ä¸­çš„ CSS å˜é‡ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰åä¸º`inputProperties`çš„é™æ€å±æ€§ã€‚å®ƒåº”è¯¥æ˜¯æˆ‘ä»¬å¸Œæœ›åœ¨`paint`æ–¹æ³•ä¸­è®¿é—®çš„ CSS å±æ€§å’Œå˜é‡çš„`Array`ã€‚å¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªå±æ€§è¿›è¡Œæ›´æ”¹ï¼Œæµè§ˆå™¨å°†ä¸ºæˆ‘ä»¬è°ƒç”¨ renderï¼Œè€Œæ— éœ€ä»»ä½•é¢å¤–çš„ä»£ç è¡Œã€‚ä¸‹é¢æ˜¯æ›´æ–°åçš„`CirclesPainter`:

```
class CirclesPainter {
  static get inputProperties() {
    return [
      '--circles-offset',
      '--circles-count',
      '--circles-opacity'
    ];
  }

  paint(ctx, geom, props) {
    const offset = parseInt(props.get('--circles-offset').toString(), 10) || 0;
    const count = parseInt(props.get('--circles-count').toString(), 10) || 2;
    const opacity = parseFloat(props.get('--circles-opacity').toString()) || 1;
    const size = Math.min(geom.width, geom.height);
    const radius = Math.max(Math.round(((size / count) - offset * 2) / 2), 10);
    const point = radius + offset;

    for (let i = 0; i < count; i++) {
      for (let j = 0; j < count; j++) {
        ctx.fillStyle = `rgba(0, ${Math.floor(255 - 42.5 * i)}, ${Math.floor(255 - 42.5 * j)}, ${opacity})`;

        ctx.beginPath();
        ctx.arc(point + (i * (point * 2)), point + (j * (point * 2)), radius, 0, 2 * Math.PI);
        ctx.fill();
      }
    }
  }
}

registerPaint('circles', CirclesPainter); 
```

æ‰€ä»¥æˆ‘ä»¬ä¸º`inputProperties`æ·»åŠ äº† getterï¼Œå®ƒè¿”å›æˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„ CSS å˜é‡åˆ—è¡¨ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®æˆ‘ä»¬ç”¨`props`å‚æ•°è®¢é˜…çš„æ‰€æœ‰å±æ€§ã€‚å®ƒåŒ…å«å¸¦æœ‰å€¼çš„å±æ€§çš„ CSS æ˜ å°„ã€‚æˆ‘ä»¬ç”¨å˜é‡åè°ƒç”¨`get`æ–¹æ³•æ¥è·å–å®ƒçš„å€¼ä½œä¸º`string`ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€äº›ç¼ºçœå€¼ï¼Œå³ä½¿å®ƒä»¬æ²¡æœ‰åœ¨æ ·å¼ä¸­æŒ‡å®šã€‚æˆ‘ä»¬ç”¨è¿™ä¸ªå€¼æ¥åŠ¨æ€æ¸²æŸ“åœ†å½¢ã€‚

æˆ‘ä»¬åº”è¯¥ç”¨å˜é‡æ¥æ›´æ–°æ ·å¼:

```
.circles {
  --circles-count: 2;
  --circles-offset: 10;
  --circles-opacity: 1;
  overflow: hidden;
  height: 0;
  padding-top: 50%;
  background: #000;
  background: paint(circles);
} 
```

åœ¨è¿™é‡Œæ£€æŸ¥[ä»£ç ](https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/circles-with-params)å’Œ[ç»“æœ](https://bobrov.dev/css-paint-demos/circles-with-params/)ã€‚

[https://www.youtube.com/embed/4WJDY1HNdcg](https://www.youtube.com/embed/4WJDY1HNdcg)

å¯¹äº GitHub æ¼”ç¤ºï¼Œæˆ‘æ·»åŠ äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬æ¥è¿æ¥ CSS å˜é‡å’Œè¾“å…¥æ§ä»¶ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å®ƒã€‚

æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹æ¸²æŸ“å‚æ•°ï¼Œåªéœ€ç”¨ CSS æˆ– JavaScript æ›´æ–°å˜é‡ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬çœ‹çœ‹åƒ`linear-gradient`è¿™æ ·çš„å†…ç½® CSS å‡½æ•°ï¼Œå®ƒä»¬æ¥å—å‘å‡½æ•°æœ¬èº«ä¼ é€’é¢å¤–çš„å‚æ•°:

```
.gradient-bg {
  background: linear-gradient(to top, #fff, #000);
} 
```

æˆ‘ä»¬æ˜¯å¦ä¹Ÿå¯ä»¥ä¸ºè‡ªå®šä¹‰ç»˜ç”»å®ç°ç›¸åŒçš„è¡Œä¸ºï¼Ÿç­”æ¡ˆæ˜¯â€”â€”æ˜¯çš„ï¼ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ª Houdini APIï¼Œå®ƒä»ç„¶æ˜¯ Chrome ä¸­çš„ä¸€ä¸ªå®éªŒã€‚å®ƒè¢«ç§°ä¸º CSS ç±»å‹åŒ– OMï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨å†…ç½®çš„ CSS å¼•æ“ç±»å‹ï¼Œå¦‚é¢œè‰²ï¼Œå›¾åƒï¼Œé•¿åº¦ç­‰ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬ä½œä¸ºå‚æ•°ä¼ é€’ç»™`paint`å‡½æ•°ã€‚

ç”±äºåŠŸèƒ½ç°åœ¨ä»å¤„äºå®éªŒé˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Chrome ä¸­å¯ç”¨â€œå®éªŒç½‘ç»œå¹³å°åŠŸèƒ½â€æ ‡å¿—ã€‚è½¬åˆ°`chrome://flags/#enable-experimental-web-platform-features`å¹¶å¯ç”¨å®ƒã€‚

ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥ç»™æˆ‘ä»¬çš„ paint ç±»æ·»åŠ ä¸€ä¸ªæ–°çš„é™æ€å±æ€§- `inputArguments`ã€‚åƒ`inputProperties`ä¸€æ ·ï¼Œå®ƒè®¢é˜…å¯¹æ‰€åˆ—å‚æ•°çš„ä»»ä½•æ›´æ”¹ï¼Œä½†åº”è¯¥åŒ…å«ä¸€ç»„ CSS ç±»å‹ã€‚è®©æˆ‘ä»¬ç”¨å‚æ•°æ›¿æ¢ CSS å˜é‡:

```
class CirclesPainter {
  static get inputArguments() {
    return [
      '<number>',    // offset
      '<number>',    // number of circles
      '<percentage>' // opacity
    ];
  }

  paint(ctx, geom, props, args) {
    const offset = args[0].value;
    const count = args[1].value;
    const opacity = args[2].value / 100;
    const size = Math.min(geom.width, geom.height);
    const radius = Math.max(Math.round(((size / count) - offset * 2) / 2), 10);
    const point = radius + offset;

    for (let i = 0; i < count; i++) {
      for (let j = 0; j < count; j++) {
        ctx.fillStyle = `rgba(0, ${Math.floor(255 - 42.5 * i)}, ${Math.floor(255 - 42.5 * j)}, ${opacity})`;

        ctx.beginPath();
        ctx.arc(point + (i * (point * 2)), point + (j * (point * 2)), radius, 0, 2 * Math.PI);
        ctx.fill();
      }
    }
  }
} 
```

æ‰€ä»¥æˆ‘ä»¬çš„`CirclesPainter`ç°åœ¨åŒ…æ‹¬äº†åŒ…å«ä¸‰ä¸ªå‚æ•°çš„`inputArguments`åˆ—è¡¨:`<number>`ã€`<number>`å’Œ`<percentage>`ã€‚æ‚¨å¯èƒ½ä¼šæåˆ° CSS ç±»å‹çš„è¯­æ³•- `<type name>`ã€‚æ­¤å¤–ï¼Œæ‚¨å¯ä»¥åœ¨ TypeScript - `<number | percentage>`ä¸­ä»¥å°½å¯èƒ½ç›¸ä¼¼çš„æ–¹å¼æ¥å—ç±»å‹è”åˆã€‚ä½ å¯ä»¥åœ¨â€œCSS å€¼å’Œå•ä½â€è§„èŒƒ[è‰æ¡ˆ](https://drafts.csswg.org/css-values-4)ä¸­æ‰¾åˆ°æ‰€æœ‰å¯ç”¨çš„ç±»å‹ã€‚

ç„¶ååœ¨`paint`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ç±»ä¼¼äº JavaScript å‡½æ•°`arguments`å¯¹è±¡çš„`args`å‚æ•°ï¼Œä½†æ˜¯åªæœ‰`Array`åŒ…å«äº†`CSSUnitValue`å¯¹è±¡ã€‚æ¯ä¸ªå•å…ƒå¯¹è±¡ç”±ä¸¤ä¸ªå±æ€§`value`å’Œ`unit`ç»„æˆã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è®¿é—®äº†æ¯ä¸ªå‚æ•°çš„æ‰€æœ‰å€¼ã€‚æˆ‘ä»¬åº”è¯¥ä¿®æ”¹æˆ‘ä»¬çš„ CSS æ¥ä½¿ç”¨å®ƒ:

```
.circles {
  overflow: hidden;
  height: 0;
  padding-top: 50%;
  background: #000;
  background: paint(circles, 2, 10, 100%);
} 
```

åœ¨è¿™é‡ŒæŸ¥çœ‹[ä»£ç ](https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/circles-with-args)å’Œ[ç»“æœ](https://bobrov.dev/css-paint-demos/circles-with-args/)ã€‚

## [](#animations)åŠ¨ç”»

è¿™å¾ˆé…·ï¼Œä½†æ˜¯æˆ‘ä»¬å¦‚ä½•ä¸ºä¸€ä¸ªç”»å®¶åˆ›é€ åŠ¨ç”»å‘¢ï¼Ÿæ­£å¦‚æˆ‘ä¹‹å‰æ‰€è¯´çš„ï¼Œæˆ‘ä»¬çš„ worklets åœ¨ä¸€ä¸ªå•ç‹¬çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œæ²¡æœ‰`requestAnimationFrame`ç”šè‡³æ²¡æœ‰`setTimeout`å‡½æ•°ã€‚å¦‚ä½•å®ç°åŠ¨ç”»ï¼Ÿç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ CSS å˜é‡ã€‚è®©æˆ‘ä»¬è¯•ç€ç”¨ CSS æ¥åˆ¶ä½œåŠ¨ç”»:

```
.circles {
  --circles-count: 2;
  --circles-offset: 10;
  --circles-opacity: 1;
  overflow: hidden;
  height: 0;
  padding-top: 50%;
  background: #000;
  background: paint(circles);
}

.circles:hover {
  animation: opacify 0.3s;
}

@keyframes opacify {
  from {
    --circles-opacity: 1;
  }

  to {
    --circles-opacity: 0;
  }
} 
```

å’Œ...è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸ä¼šåƒæˆ‘ä»¬é¢„æœŸçš„é‚£æ ·èµ·ä½œç”¨ã€‚å®ƒåªæ˜¯åœ¨ 50%ç‚¹å°†ä¸é€æ˜åº¦ä» 1 åˆ‡æ¢åˆ° 0ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œæ‰€æœ‰ CSS å˜é‡éƒ½åªæ˜¯å­—ç¬¦ä¸²ï¼Œå®ƒä»¬ç±»ä¼¼äº SASS æˆ– LESS ä¸­çš„å˜é‡â€”â€”å˜é‡è¢«æ›¿æ¢ä¸ºç®€å•å­—ç¬¦ä¸²æ’å€¼çš„å€¼ã€‚ä¸ºäº†åˆ¶ä½œåŠ¨ç”»ï¼Œä¸€äº› CSS å±æ€§æµè§ˆå™¨éœ€è¦åº”ç”¨æ’å€¼å‡½æ•°ï¼Œä½†å®ƒä¸çŸ¥é“å¦‚ä½•å°†ä¸€ä¸ªå­—ç¬¦ä¸²æ’å€¼åˆ°å¦ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å®ƒæœ‰å”¯ä¸€çš„å†…ç½®åŠŸèƒ½æ¥åŠ¨ç”»é¢œè‰²ï¼Œé•¿åº¦ï¼Œæ•°å­—ï¼Œä½†ä¸æ˜¯å­—ç¬¦ä¸²ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒåªåœ¨ 50%åˆ‡æ¢å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`requestAnimationFrame`ç”¨ JavaScript åŠ¨ç”»åŒ–å˜é‡ã€‚è¿™æ ·çš„è„šæœ¬å¯èƒ½å¦‚ä¸‹æ‰€ç¤º:

```
const canvas = document.querySelector('.circles');
let start = performance.now();

canvas.addEventListener('mouseenter', event => {
  canvas.classList.add('animating');
  start = performance.now();

  requestAnimationFrame(function raf(now) {
    const count = Math.floor(now - start);
    const rawValue = canvas.style.getPropertyValue('--circles-opacity').trim();
    const value = (parseFloat(rawValue) * 100 - 3) / 100;

    canvas.style.setProperty('--circles-opacity', value);

    if(count > 300) {
      canvas.classList.remove('animating');
      canvas.style.setProperty('--circles-opacity', 0);

      return;
    }

    requestAnimationFrame(raf);
  });
}); 
```

ä¸å¤ªå¥½ï¼Œæˆ‘ä»¬èƒ½åšå¾—æ›´å¥½å—ï¼Ÿæ˜¯çš„ï¼Œä½¿ç”¨è‡ªå®šä¹‰å±æ€§ APIã€‚è¿™ä¸ª API ç°åœ¨ä¹Ÿåœ¨ Chrome çš„æ——å¸œä¸‹ï¼Œæ‰€ä»¥ä¸è¦å¿˜è®°å¯ç”¨å®ƒã€‚å®ƒå…è®¸æˆ‘ä»¬ç”¨ç±»ä¼¼äºå˜é‡çš„è¯­æ³•æ³¨å†Œè‡ªå®šä¹‰ CSS å±æ€§ï¼Œä½†è¿™æ¬¡æ˜¯ç”¨åˆ†é…ç»™å®ƒçš„ CSS ç±»å‹ã€‚å› æ­¤ï¼Œæµè§ˆå™¨å°†æœ‰ä¸€ä¸ªå…³äºå¦‚ä½•åŠ¨ç”»çš„æƒ³æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CSS åŠ¨ç”»å’Œè¿‡æ¸¡ï¼

æ‰€ä»¥è¦æ³¨å†Œè‡ªå®šä¹‰å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨`CSS.registerProperty`å¹¶ä¼ é€’ options å¯¹è±¡:

```
CSS.registerProperty({
  name: '--circles-opacity',
  syntax: '<percentage>',
  inherits: false,
  initialValue: '100%'
}); 
```

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬éœ€è¦ç”¨`name`é€‰é¡¹ç»™å±æ€§å‘½åã€‚ç„¶åæˆ‘ä»¬ç”¨`syntax`å±æ€§æŒ‡å®šå®ƒçš„ç±»å‹ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¯´å®ƒä¸ä¼šè¢«å­èŠ‚ç‚¹ç»§æ‰¿ï¼Œåˆå§‹å€¼ä¸º 100%ã€‚

ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ ·å¼è¡¨ä¸­ä½¿ç”¨æ–°åˆ›å»ºçš„è‡ªå®šä¹‰å±æ€§:

```
.circles {
  --circles-count: 2;
  --circles-offset: 10;
  --circles-opacity: 100%;
  overflow: hidden;
  height: 0;
  padding-top: 50%;
  background: #000;
  background: paint(circles);
  transition: --circles-opacity 0.3s ease;
}

.circles:hover {
  --circles-opacity: 0%;
} 
```

[https://www.youtube.com/embed/VC6XgOcTHW4](https://www.youtube.com/embed/VC6XgOcTHW4)

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª`transition`æ¥å¹³æ»‘åœ°æ”¹å˜åœ†å½¢çš„ä¸é€æ˜åº¦ã€‚åœ¨è¿™é‡ŒæŸ¥çœ‹[ä»£ç ](https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/circles-animation-with-custom-property)å’Œ[ç»“æœ](https://bobrov.dev/css-paint-demos/circles-animation-with-custom-property/)ã€‚

## [](#conclusion)ç»“è®º

ä»Šå¤©å¼€å§‹å­¦ä¹  CSS ç”»å›¾ APIï¼Œæ¢ç´¢å¦‚ä½•åˆ›å»ºè‡ªå·±çš„ç”»å›¾ï¼Œå¦‚ä½•ä½¿ç”¨è¾“å…¥å±æ€§å’Œå‚æ•°ï¼ŒCSS å˜é‡å’Œè‡ªå®šä¹‰å±æ€§ï¼Œä»¥åŠå¦‚ä½•åˆ¶ä½œåŠ¨ç”»ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ä»é‚£ç¯‡æ–‡ç« ä¸­è·å¾—çš„çŸ¥è¯†å®ç°æ›´å¤šçš„ç”Ÿäº§å°±ç»ªç¤ºä¾‹ã€‚å¦‚æœä½ æ­£åœ¨ä½¿ç”¨æœ€æ–°çš„ Chrome é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œä½ å¯èƒ½ä¼šæåˆ°æˆ‘æ­£åœ¨ä½¿ç”¨å®šåˆ¶æ²¹æ¼†æ¥åˆ¶ä½œææ–™è®¾è®¡èƒŒæ™¯ï¼Œä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹[å’ŒæŸ¥çœ‹](https://bobrov.dev/css-paint-demos/md-bg/)[ä»£ç ](https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/md-bg)ã€‚è‡ªå·±å°è¯• CSS ç”»å›¾ API å§ï¼

### [](#resources)èµ„æº

*   [å¼€å‘è€…è°·æ­Œ](https://developers.google.com/web/updates/2018/01/paintapi)
*   [èƒ¡è¿ªå°¼é€‰ç§€](https://drafts.css-houdini.org/css-paint-api/%E2%80%8B)
*   [W3C CSS ç”»ç¨¿](https://www.w3.org/TR/css-paint-api-1/)
*   [æ¼”ç¤º](https://lab.iamvdo.me/houdini/)
*   [æˆ‘çš„æ¼”ç¤º](https://bobrov.dev/css-paint-demos/%E2%80%8B)