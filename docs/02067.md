# ä¿æŠ¤æ‚¨çš„è§’åº¦æ¨¡å—ğŸ’‚â€

> åŸæ–‡:[https://dev.to/angular/guarding-your-angular-modules-lio](https://dev.to/angular/guarding-your-angular-modules-lio)

è®¸å¤šè§’åº¦æ¨¡å—éœ€è¦ä½¿ç”¨é™æ€`forRoot()`åŠŸèƒ½å¯¼å…¥ï¼Œé€šè¿‡è¯¥åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®æ¨¡å—ã€‚
ä¸€ä¸ªä¾‹å­ï¼Œä¹Ÿè®¸æ˜¯æœ€è‘—åçš„ï¼Œæ˜¯éœ€è¦è·¯ç”±é›†åˆçš„è§’åº¦è·¯ç”±å™¨æ¨¡å—ï¼Œå¦ä¸€ä¸ªä¾‹å­æ˜¯éœ€è¦åº”ç”¨çš„æ ¹ reducers çš„ NgRx å­˜å‚¨ã€‚
åœ¨å†…éƒ¨ï¼Œè¿™äº›æ¨¡å—å°†åˆå§‹åŒ–æ‰€éœ€çš„æœåŠ¡ï¼Œå®ƒå°†åœ¨è¿™äº›æœåŠ¡ä¹‹é—´å»ºç«‹ç¼–æ’ï¼Œä»¥ä¾¿èƒ½å¤Ÿå®Œæˆå®ƒçš„å·¥ä½œã€‚

ä½†æ˜¯æœ‰æ—¶æˆ‘ä»¬ä¼šçŠ¯é”™è¯¯ï¼Œåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å¤šæ¬¡ä½¿ç”¨`forRoot()`å‡½æ•°ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¸ä¼šæ³¨æ„åˆ°å®ƒï¼Œä½†å®ƒé€šå¸¸æ˜¯å¯¼è‡´æ„å¤–è¡Œä¸ºçš„åŸå› ï¼Œä»¤äººé—æ†¾çš„æ˜¯ï¼Œè¿™å¾ˆéš¾è°ƒè¯•ã€‚

è¿™ä¹‹æ‰€ä»¥æ˜¯ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºè¿™äº›æ¨¡å—å¿…é¡»è¢«è§†ä¸º[å•æ€](https://en.wikipedia.org/wiki/Singleton_pattern)ã€‚
å½“ä¸€ä¸ªæ¨¡å—è¢«å»¶è¿ŸåŠ è½½å¹¶ä¸”ä¹Ÿåœ¨ä½¿ç”¨`forRoot()`å‡½æ•°æ—¶ï¼Œå»¶è¿ŸåŠ è½½çš„æ¨¡å—å°†åˆ›å»ºæ¨¡å—æœåŠ¡çš„ç¬¬äºŒä¸ªå®ä¾‹ã€‚è¿™äº›å®ä¾‹åœ¨åˆ›å»ºå®ƒä»¬çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ã€‚å»¶è¿ŸåŠ è½½çš„æ¨¡å—å°†ä½¿ç”¨å®ƒåˆ›å»ºçš„å®ä¾‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ ¹å®ä¾‹ã€‚

å¦‚æœæˆ‘ä»¬ä»¥ NgRx `StoreModule`çš„`forRoot()`å‡½æ•°ä¸ºä¾‹æ¥è®¾ç½® NgRx Storeã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æœ€ç»ˆä¼šæœ‰å¤šä¸ª store å®ä¾‹ï¼Œæ‰€æœ‰çš„é…ç½®éƒ½ä¸åŒã€‚å¦‚æœä¸€ä¸ªç‰¹æ€§æ¨¡å—è¦åˆ†æ´¾ä¸€ä¸ªåŠ¨ä½œï¼Œå®ƒä¸ä¼šåˆ°è¾¾â€œçœŸæ­£çš„â€æ ¹ç¼©å‡å™¨ï¼Œå®ƒåªä¼šåˆ°è¾¾ç”±æ‡’æƒ°æ¨¡å—é…ç½®çš„ç¼©å‡å™¨ã€‚å¦‚æœä»æ ¹æ¨¡å—å†…éƒ¨åˆ†æ´¾ç›¸åŒçš„åŠ¨ä½œï¼Œé‚£ä¹ˆå®ƒå°†åˆ°è¾¾â€œçœŸæ­£çš„â€æ ¹ç¼©å‡å™¨ã€‚

ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œå½“ Angular å¼•å¯¼åº”ç”¨ç¨‹åºæ—¶ï¼ŒåŒä¸€ä¸ªæ¨¡å—è¢«æ€¥åˆ‡åœ°å¤šæ¬¡åŠ è½½ã€‚æ ¹æ®æ¨¡å—çš„åŠ è½½æ–¹å¼ï¼Œåªæœ‰ä¸€ä¸ªæ¨¡å—ä¼šè¢«æ³¨å†Œå’Œä½¿ç”¨ã€‚å¦‚æœæ‚¨æ²¡æœ‰æ„è¯†åˆ°è¿™ä¸€ç‚¹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ¨¡å—é…ç½®é”™è¯¯ã€‚

å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘ä¼šæµªè´¹å¾ˆå¤šæ—¶é—´æ¥è·Ÿè¸ªå’Œè§£å†³ç”±æ­¤å¼•èµ·çš„é—®é¢˜ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ä¸€ç§è§£å†³æ–¹æ¡ˆæ¥é˜²æ­¢è¿™ç§æƒ…å†µã€‚

> [ä¸ºä»€ä¹ˆä¸€ä¸ªå…±äº«æ¨¡å—ç»™ä¸€ä¸ªæ‡’åŠ è½½çš„æ¨¡å—æä¾›æœåŠ¡æ˜¯ä¸å¥½çš„ï¼Ÿ](https://angular.io/guide/ngmodule-faq#q-why-bad)

### [](#an-example)ä¸¾ä¸ªä¾‹å­

ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª`ThemeModule`æ¥è®¾ç½®åº”ç”¨ç¨‹åºçš„ä¸»é¢˜ã€‚
åº”ç”¨ç¨‹åºçš„ä¸»é¢˜å¯ä»¥é€šè¿‡`ThemeModule.forRoot(color)`è¿›è¡Œè®¾ç½®ï¼Œå¹¶åœ¨é¡¹ç›®å¼€å§‹æ—¶è¿›è¡Œé…ç½®ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬çš„`ThemeModule`è¢«æå–åˆ°ä¸€ä¸ªåº“ä¸­ï¼Œä½¿å…¶å¯ä»¥åœ¨å¤šä¸ªåº”ç”¨ç¨‹åºä¸­é‡ç”¨ï¼Œæˆ‘ä»¬çš„`ThemeModule`æ˜¯å¦‚æ­¤çš„æˆåŠŸï¼Œä»¥è‡³äºå®ƒåœ¨å¤šä¸ªä»£ç åº“ä¸­è¢«å¤§é‡ä½¿ç”¨ã€‚çªç„¶ï¼Œåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå½“æˆ‘ä»¬å¯¼å…¥å¦ä¸€ä¸ªæ¨¡å—æ—¶ï¼Œæˆ‘ä»¬çš„ä¸»é¢˜é¢œè‰²ç¥å¥‡åœ°æ”¹å˜äº†ï¼Œæˆ‘ä»¬ç°åœ¨å¤„äºä¸€ä¸ªå¤§çš„é¢œè‰²èŠ‚æ—¥ä¸­ï¼Œè¿™éƒ½æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä¿æŠ¤å¥½`ThemeModule`ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•æ‰èƒ½é¿å…è¿™ç§æƒ…å†µå‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯æ ¹ä¿æŠ¤ï¼Œåœ¨æ¥ä¸‹æ¥çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•è®¾ç½®å®ƒä»¬ã€‚

### [](#show-me-the-code)æ˜¾ç¤ºä»£ç 

è®©æˆ‘ä»¬é¦–å…ˆå®ç°`ThemeModule`ï¼Œé€šè¿‡æ·»åŠ ä¸€ä¸ªé™æ€çš„`forRoot()`å‡½æ•°æ¥è®¾ç½®`ThemeModule`ã€‚

```
@NgModule()
export class ThemeModule {
  static forRoot(themeConfig: ThemeConfig): ModuleWithProviders<ThemeModule> {
    return {
      ngModule: ThemeModule,
      providers: [{ provide: Theme, useValue: themeConfig }],
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„ä»£ç ç‰‡æ®µåˆ›å»ºäº†ä¸€ä¸ªå¸¦æœ‰`themeConfig`å‚æ•°çš„`Theme`ï¼Œ`Theme`å¦‚ä¸‹æ‰€ç¤ºã€‚

```
@Injectable()
export class Theme {
  constructor(config: ThemeConfig) {}
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦ä½¿ç”¨`ThemeModule`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`AppModule`ä¸­çš„`forRoot()`åŠŸèƒ½ã€‚

```
@NgModule({
  imports: [ThemeModule.forRoot({ color: '#dd0031' })],
})
export class AppModule {} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬çš„`ThemeModule`ç°åœ¨å¯ä»¥ä½¿ç”¨äº†ï¼Œä½†æ˜¯å¦‚æœå®ƒè¢«ç¬¬äºŒæ¬¡å¯¼å…¥ï¼Œå®ƒä¹Ÿåˆ›å»ºäº†ä¸»é¢˜çš„ç¬¬äºŒä¸ªå®ä¾‹ã€‚
å…¶ç»“æœæ˜¯ï¼Œå½“åŠ è½½åŠŸèƒ½æ¨¡å—æ—¶ï¼Œæ¨¡å—å°†ä½¿ç”¨è¯¥ä¸»é¢˜è€Œä¸æ˜¯æ ¹ä¸»é¢˜ã€‚

[https://stackblitz.com/edit/angular-theme-guard-start?embed=1&&](https://stackblitz.com/edit/angular-theme-guard-start?embed=1&&)

### è¿™å¯ä»¥é€šè¿‡ä¸‰ä¸ªç®€å•çš„æ­¥éª¤æ¥é¿å…

#### [](#1-create-an-raw-injectiontoken-endraw-)1ã€‚åˆ›å»ºä¸€ä¸ª`InjectionToken`

```
export const THEME_ROOT_GUARD = new InjectionToken<void>(
  'Internal Theme ForRoot Guard',
) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬çš„å«å£«åˆ›å»ºä¸€ä¸ª [`InjectionToken`](https://angular.io/api/core/InjectionToken) ã€‚

#### [](#2-provide-the-raw-rootmoduleguard-endraw-in-the-providers-of-the-module)2ã€‚åœ¨æ¨¡å—çš„æä¾›è€…ä¸­æä¾›`ROOT_MODULE_GUARD`

```
@NgModule()
export class ThemeModule {
  static forRoot(themeOptions): ModuleWithProviders<ThemeRootModule> {
    return {
      ngModule: ThemeRootModule,
      provides: [
        {
          provide: Theme,
          useFactory: createTheme,
          deps: [themeOptions],
        },
        {
          provide: THEME_ROOT_GUARD,
          useFactory: createThemeRootGuard,
          deps: [[Theme, new Optional(), new SkipSelf()]],
        },
      ],
    }
  }
}

export function createThemeRootGuard(theme) {
  if (theme) {
    throw new TypeError(
      `ThemeModule.forRoot() called twice. Feature modules should use ThemeModule.forFeature() instead.`,
    )
  }
  return 'guarded'
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡å·¥å‚å‡½æ•°`createThemeRootGuard`ï¼Œæˆ‘ä»¬ä¸º`THEME_ROOT_GUARD`ä»¤ç‰Œæä¾›äº†ä¸€ä¸ªå€¼ã€‚è¿™ä¸ªå·¥å‚å‡½æ•°éœ€è¦ä¸€ä¸ª`theme`å‚æ•°æ¥æ£€æŸ¥ä¸»é¢˜æ˜¯å¦å·²ç»åˆ›å»ºï¼Œå¦‚æœå·²ç»åˆ›å»ºï¼Œå®ƒå°†æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚
ä½¿ç”¨`deps`æˆ‘ä»¬å¯ä»¥æä¾›`Theme`ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å‡½æ•°æ—¶`Theme`è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨`Optional`å°†å‚æ•°æ ‡è®°ä¸ºå¯é€‰ï¼Œå¦åˆ™ä¾èµ–æ³¨å…¥å®¹å™¨ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸ºå®ƒæ— æ³•æ‰¾åˆ°`Theme`çš„å€¼ã€‚
ä¸ºäº†ä¸å®ä¾‹åŒ–`Theme`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`SkipSelf`ã€‚å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œæˆ‘ä»¬å°†ç›´æ¥å¾—åˆ° 2 ä¸ª`Theme`å®ä¾‹ã€‚

æ›´å¤šå…³äº [`Optional`](https://angular.io/api/core/Optional) [`SkipSelf`](https://angular.io/api/core/SkipSelf) çš„ä¿¡æ¯å¯ä»¥åœ¨ [angular.io](//angular.io) ä¸Šæ‰¾åˆ°ã€‚

#### [](#3-inject-the-guard-token-in-the-module)3ã€‚åœ¨æ¨¡å—ä¸­æ³¨å…¥ä¿æŠ¤ä»¤ç‰Œ

```
@NgModule()
export class ThemeModule {
  constructor(
    @Optional()
    @Inject(THEME_ROOT_GUARD)
    guard: any,
  ) {}
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“æ¨¡å—è¢«å¯¼å…¥æ—¶ï¼Œæˆ‘ä»¬åœ¨`ThemeModule`ä¸­æ³¨å…¥`InjectionToken`æ¥åˆ›å»º`THEME_ROOT_GUARD`ã€‚
æ¯æ¬¡åˆ›å»º`ThemeModule`çš„æ–°å®ä¾‹æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨`createThemeRootGuard`å·¥å‚å‡½æ•°æ¥åˆ›å»º`THEME_ROOT_GUARD`ã€‚ç¬¬äºŒæ¬¡å‡ºç°è¿™ç§æƒ…å†µæ—¶ï¼Œå‚æ•°`theme`å°†æœ‰ä¸€ä¸ªå€¼ï¼Œä»è€Œå¯¼è‡´å¼‚å¸¸ã€‚

[https://stackblitz.com/edit/angular-theme-guard?embed=1&&](https://stackblitz.com/edit/angular-theme-guard?embed=1&&)

é€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬å¯ä»¥é˜²æ­¢å¼€å‘è€…ä½¿ç”¨`ThemeModule`é€šè¿‡`forRoot()`å‡½æ•°ä¸æ­¢ä¸€æ¬¡åœ°æ„å¤–å¯¼å…¥æˆ‘ä»¬çš„æ¨¡å—ã€‚
æˆ‘ä»¬æ˜ç¡®è¡¨ç¤ºï¼Œæˆ‘ä»¬æ²¡æœ‰é¢„æ–™åˆ°è¿™ç§æƒ…å†µä¼šå‘ç”Ÿï¼Œå¦‚æœæˆ‘ä»¬çš„æ¨¡å—ä½¿ç”¨ä¸å½“ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä½¿ç”¨æˆ‘ä»¬æ¨¡å—çš„å¼€å‘äººå‘˜èŠ‚çœä¸€äº›æ—¶é—´å’ŒæŒ«æŠ˜ã€‚

### [](#a-second-solution-but-different)ç¬¬äºŒç§æ–¹æ¡ˆå´ä¸åŒ

è¿˜æœ‰ç¬¬äºŒä¸ªè§£å†³æ–¹æ¡ˆï¼ŒæŠŠä½ çš„æ¨¡å—å½“ä½œä¸€ä¸ªå•ä¾‹ï¼Œè¿™éœ€è¦æ›´å°‘çš„è®¾ç½®ï¼Œä½†æ˜¯è¡Œä¸ºæœ‰ç‚¹ä¸åŒã€‚
å¦‚æœæˆ‘ä»¬æ³¨å…¥`ThemeModule`æœ¬èº«ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æ£€æŸ¥`ThemeModule`æ˜¯å¦å·²ç»åˆå§‹åŒ–ã€‚

```
@NgModule()
export class ThemeModule {
  constructor(@Optional() @SkipSelf() themeModule: ThemeModule) {
    if (themeModule) {
      throw new TypeError(`ThemeModule is imported twice.`)
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> æœ‰å…³è¯¥è§£å†³æ–¹æ¡ˆçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[è§’åº¦æ–‡æ¡£](https://angular.io/guide/singleton-services#the-forroot-pattern)

[https://stackblitz.com/edit/angular-theme-guard-end-2?embed=1&&](https://stackblitz.com/edit/angular-theme-guard-end-2?embed=1&&)

### [](#the-difference)åŒºåˆ«

ç¬¬äºŒç§æ–¹æ³•çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ·»åŠ ç”¨`forChild`å‡½æ•°ç¬¬äºŒæ¬¡åŠ è½½`ThemeModule`çš„èƒ½åŠ›ï¼Œè¿™å°†æŠ›å‡ºåŒæ ·çš„é”™è¯¯ã€‚

å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºæˆ‘ä»¬åœ¨æ¨¡å—çš„æ„é€ å‡½æ•°ä¸­æœ‰é˜²æŠ¤ã€‚ä¸ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆç›¸æ¯”ï¼Œæˆ‘ä»¬åœ¨`createThemeRootGuard()`å‡½æ•°ä¸­è®¾ç½®äº†é˜²æŠ¤ï¼Œå®ƒåªåœ¨`forRoot()`å‡½æ•°ä¸­æä¾›ï¼Œè¿™æ„å‘³ç€åªæœ‰å½“æˆ‘ä»¬ç”¨`forRoot()`å¯¼å…¥æ¨¡å—æ—¶ï¼Œå®ƒæ‰ä¼šè¢«æ£€æŸ¥ã€‚

æ ¹æ®æ‚¨çš„ä½¿ç”¨æ¡ˆä¾‹ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ç¬¦åˆæ‚¨éœ€æ±‚çš„æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚

å¯¹äºä¸€ä¸ªçœŸå®çš„ä¾‹å­ï¼Œä½ å¯ä»¥çœ‹çœ‹[è§’è·¯ç”±å™¨](https://github.com/angular/angular/blob/master/packages/router/src/router_module.ts)çš„å®ç°ã€‚

* * *

åœ¨ Twitter ä¸Šå…³æ³¨æˆ‘ï¼Œåœ°å€: [@tim_deschryver](https://twitter.com/tim_deschryver) ã€‚