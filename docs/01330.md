# GraphQL:çªå˜å’Œæ•°æ®åº“è®¿é—®

> åŸæ–‡:[https://dev . to/pmbanugo/graph QL-mutation-and-database-access-5a 62](https://dev.to/pmbanugo/graphql-mutation-and-database-access-5a62)

GraphQL è¢«æè¿°ä¸º API çš„æ•°æ®æŸ¥è¯¢å’Œæ“ä½œè¯­è¨€ï¼Œä»¥åŠç”¨ç°æœ‰æ•°æ®å®ŒæˆæŸ¥è¯¢çš„è¿è¡Œæ—¶ï¼Œå®ƒå…è®¸ä¸åŒçš„å®¢æˆ·ç«¯ä½¿ç”¨æ‚¨çš„ API å¹¶åªæŸ¥è¯¢ä»–ä»¬éœ€è¦çš„æ•°æ®ã€‚å®ƒæœ‰åŠ©äºè§£å†³ä¸€äº› REST æœåŠ¡å­˜åœ¨çš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯[å–å¤šå’Œå–å°‘](https://stackoverflow.com/questions/44564905/what-is-over-fetching-or-under-fetching)ï¼Œè¿™æ˜¯ä¸€ä¸ªæ€§èƒ½é—®é¢˜ã€‚åœ¨ä¹‹å‰çš„[å¸–å­](https://dev.to/pmbanugo/graphql-schema-resolvers-type-system-schema-language-and-query-language-5c0i)ä¸­ï¼Œæˆ‘å†™äº†å…³äº GraphQL ç±»å‹ç³»ç»Ÿã€æŸ¥è¯¢è¯­è¨€ã€æ¨¡å¼å’Œè§£æå™¨çš„å†…å®¹ã€‚æˆ‘å‘æ‚¨å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨`graphql-yoga`æ„å»ºä¸€ä¸ª GraphQL æœåŠ¡å™¨ï¼Œå¹¶ç”¨æ¥è‡ª GraphQL playground çš„ä¸€äº›æŸ¥è¯¢æµ‹è¯•äº†è¿™ä¸ª APIã€‚åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘å°†å‘æ‚¨ä»‹ç» GraphQL çªå˜ã€‚æˆ‘ä»¬è¿˜å°†ç§»é™¤æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä½¿ç”¨çš„å†…å­˜å­˜å‚¨ï¼Œå¹¶ä½¿ç”¨æ•°æ®åº“æ¥è®¿é—®å’Œå­˜å‚¨æˆ‘ä»¬çš„æ•°æ®ã€‚

## [](#adding-a-database)æ·»åŠ æ•°æ®åº“

å¦‚æœä½ æ²¡æœ‰éµå¾ªä¹‹å‰çš„å¸–å­ï¼Œä½ å¯ä»¥åœ¨ [GitHub](https://github.com/pmbanugo/graphql-intro-js) ä¸Šä¸‹è½½æºä»£ç ã€‚å‰ä¸€ç¯‡æ–‡ç« çš„å®Œæ•´ä»£ç åŒ…å«åœ¨`src-part-1`æ–‡ä»¶å¤¹ä¸­ã€‚å¦‚æœæ‚¨æƒ³éµå¾ªç¼–ç ï¼Œå°†è¯¥æ–‡ä»¶å¤¹é‡å‘½åä¸º`src`,å¹¶ä»è¿™é‡Œå¼€å§‹éµå¾ªç¼–ç è¯´æ˜ã€‚

åœ¨æˆ‘ä»¬å¼€å§‹åˆ›å»º GraphQL å˜ä½“ä¹‹å‰ï¼Œæˆ‘å¸Œæœ›æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“æ¥å¤„ç† GraphQL ç³»ç»Ÿä¸­çš„ç°æœ‰æŸ¥è¯¢ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ [Prisma](https://github.com/prisma/prisma) ä½œä¸º MySQL æ•°æ®åº“çš„æ•°æ®è®¿é—®å±‚ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿è¡Œåœ¨ Prisma äº‘æœåŠ¡ä¸Šçš„ Prisma æ¼”ç¤ºæœåŠ¡å™¨ã€‚

è®©æˆ‘ä»¬ç»§ç»­å®šä¹‰ä¸€ä¸ªæ•°æ®åº“æ¨¡å¼ã€‚æ·»åŠ ä¸€ä¸ªæ–°æ–‡ä»¶`src/prisma/datamodel.prisma`ï¼Œå†…å®¹å¦‚ä¸‹

```
type Book {
    id: ID! @id
    title: String!
    pages: Int
    chapters: Int
    authors: [Author!]!
}

type Author {
    id: ID! @id
    name: String! @unique
    books: [Book!]!
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢æ¨¡å¼ä»£è¡¨äº†æˆ‘ä»¬çš„æ•°æ®æ¨¡å‹ã€‚æ¯ç§ç±»å‹éƒ½å°†è¢«æ˜ å°„åˆ°ä¸€ä¸ªæ•°æ®åº“è¡¨ã€‚è®©`!`å…·æœ‰ä¸€ä¸ªç±»å‹å°†ä½¿æ•°æ®åº“ä¸­çš„è¯¥åˆ—ä¸å¯ä¸ºç©ºã€‚æˆ‘ä»¬è¿˜ç”¨`@id`æŒ‡ä»¤æ³¨é‡Šäº†ä¸€äº›å­—æ®µã€‚GraphQL æŒ‡ä»¤ä»¥`@`å¼€å¤´ï¼Œç”¨äºæ¨¡å¼è¯­è¨€æˆ–æŸ¥è¯¢è¯­è¨€ã€‚`@id`æŒ‡ä»¤ç”± Prisma ç®¡ç†ï¼Œä¼šå°†å­—æ®µæ ‡è®°ä¸ºæ•°æ®åº“ä¸­çš„ä¸»é”®ï¼Œå¹¶ä¸ºæ•°æ®åº“ä¸­çš„è¯¥åˆ—è‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€ IDã€‚`@unique`æŒ‡ä»¤å°†åœ¨æ•°æ®åº“ä¸­ç”¨ä¸€ä¸ªæƒŸä¸€çš„çº¦æŸæ¥æ ‡è®°è¯¥åˆ—ã€‚è¿™ä¹Ÿå°†å…è®¸æˆ‘ä»¬é€šè¿‡ä½œè€…çš„åå­—æ¥æŸ¥æ‰¾ä½œè€…ï¼Œç¨åæ‚¨å°†çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–°æ–‡ä»¶`src/prisma/prisma.yml`ï¼Œå®ƒå°†åŒ…å« Prisma çš„é…ç½®é€‰é¡¹ã€‚

```
# The HTTP endpoint for the demo server on Prisma Cloud
endpoint: ""

# Points to the file that contains your datamodel
datamodel: datamodel.prisma

# Specifies language & location for the generated Prisma client
generate:
  - generator: javascript-client
    output: ./client 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Prisma CLI å°†ä½¿ç”¨å®ƒæ¥é…ç½®å’Œæ›´æ–°äº‘ä¸­çš„ Prisma æœåŠ¡å™¨ï¼Œå¹¶æ ¹æ®æ•°æ®æ¨¡å‹ç”Ÿæˆå®¢æˆ·ç«¯ APIã€‚`endpoint`é€‰é¡¹å°†åŒ…å« Prisma äº‘æœåŠ¡å™¨çš„ URLã€‚`datamodel`é€‰é¡¹æŒ‡å®šæ•°æ®æ¨¡å‹çš„è·¯å¾„ï¼Œ`generate`é€‰é¡¹æŒ‡å®šæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ javascript å®¢æˆ·ç«¯ç”Ÿæˆå™¨ï¼Œå®ƒåº”è¯¥å°†å®¢æˆ·ç«¯æ–‡ä»¶è¾“å‡ºåˆ°`/client`æ–‡ä»¶å¤¹ã€‚Prisma CLI å¯ä»¥ä½¿ç”¨å…¶ä»–ç”Ÿæˆå™¨ç”Ÿæˆå®¢æˆ·ç«¯ã€‚ç›®å‰æœ‰ TypeScript å’Œ Go çš„ç”Ÿæˆå™¨ã€‚æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ JavaScriptï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº†ä½¿ç”¨`javascript-client`ç”Ÿæˆå™¨ã€‚è¦äº†è§£æ›´å¤šå…³äºè¿™ä¸ªé…ç½®æ–‡ä»¶çš„ç»“æ„ï¼Œè¯·éšæ„æŸ¥çœ‹[æ–‡æ¡£](https://www.prisma.io/docs/-5cy7#reference)ã€‚

æˆ‘ä»¬éœ€è¦ Prisma CLI æ¥éƒ¨ç½²æˆ‘ä»¬çš„ Prisma æœåŠ¡å™¨å’Œç”Ÿæˆ Prisma å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ npm å…¨å±€å®‰è£… CLIã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… Prisma CLIã€‚

```
npm install -g prisma 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæˆ‘æ­£åœ¨è¿è¡Œ CLI çš„ç‰ˆæœ¬`1.34.0`ã€‚å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦éƒ¨ç½²æˆ‘ä»¬çš„æ•°æ®æ¨¡å‹ã€‚æŒ‰ç…§ä»¥ä¸‹è¯´æ˜åœ¨ Prisma cloud ä¸Šè®¾ç½®æ•°æ®åº“ã€‚

1.  åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ`cd src/prisma && prisma deploy`ã€‚
2.  ç³»ç»Ÿä¼šæç¤ºæ‚¨é€‰æ‹©å¦‚ä½•è®¾ç½® Prisma æœåŠ¡å™¨ã€‚é€‰æ‹©`Demo Server`ç»§ç»­ã€‚
3.  CLI å¯èƒ½å¸Œæœ›é€šè¿‡æ‰“å¼€æµè§ˆå™¨çª—å£è®©æ‚¨ç™»å½•æˆ–æ³¨å†Œ Prisma æ¥éªŒè¯æ‚¨çš„è¯·æ±‚ã€‚ç™»å½•åï¼Œå…³é—­çª—å£å¹¶è¿”å›åˆ°å‘½ä»¤æç¤ºç¬¦ã€‚
4.  ä¸‹ä¸€ä¸ªæç¤ºè¦æ±‚æ‚¨é€‰æ‹©ä¸€ä¸ªåŒºåŸŸï¼Œè®©æ¼”ç¤ºæœåŠ¡å™¨æ‰˜ç®¡åœ¨ Prisma Cloud ä¸Šã€‚é€‰æ‹©ä»»æ„ä¸€ä¸ªå¹¶æŒ‰ä¸‹**å›è½¦**é”®ç»§ç»­ã€‚
5.  ç°åœ¨è¦æ±‚æ‚¨ä¸ºæœåŠ¡é€‰æ‹©ä¸€ä¸ªåç§°ã€‚è¾“å…¥`graphql-intro`(æˆ–æ‚¨é€‰æ‹©çš„ä»»ä½•åç§°)å¹¶ç»§ç»­ã€‚
6.  ä¸‹ä¸€ä¸ªæç¤ºè¦æ±‚ä¸ºæˆ‘ä»¬çš„å·¥ä½œæµçš„å½“å‰é˜¶æ®µå‘½åã€‚æŒ‰ä¸‹**é”®ï¼Œè¾“å…¥**ç»§ç»­ï¼Œæ¥å—é»˜è®¤å€¼ã€‚

CLI åˆ©ç”¨è¿™äº›ä¿¡æ¯å’Œ`prisma.yml`ä¸­çš„ä¿¡æ¯æ¥è®¾ç½®æ¼”ç¤ºæœåŠ¡å™¨ã€‚å®Œæˆåï¼Œå®ƒä¼šå°†ç«¯ç‚¹æ–‡ä»¶æ›´æ–°åˆ° Prisma æœåŠ¡å™¨ã€‚å®ƒè¿˜å°†åœ¨æ§åˆ¶å°ä¸­æ‰“å°å…³äºæ•°æ®åº“å¦‚ä½•è®¾ç½®çš„ä¿¡æ¯ã€‚

[![prisma-deploy.gif](img/2876dbc81f558f27963f399ce0debbcc.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--rYK4Ovjn--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://ucarecdn.com/ab930c7a-c3d2-4182-b074-e44160da8b83/)

è®¾ç½®å¥½æœåŠ¡å™¨åï¼Œä¸‹ä¸€æ­¥æ˜¯ä¸ºæˆ‘ä»¬çš„æ•°æ®æ¨¡å‹ç”Ÿæˆ Prisma å®¢æˆ·æœºã€‚Prisma å®¢æˆ·ç«¯æ˜¯æ ¹æ®æ‚¨çš„æ•°æ®æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå®ƒä¸ºæ‚¨æä¾›äº†ä¸ Prisma æœåŠ¡è¿›è¡Œé€šä¿¡çš„ APIã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç”Ÿæˆæˆ‘ä»¬çš„ Prisma å®¢æˆ·ç«¯ã€‚

```
prisma generate 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªå‘½ä»¤ç”Ÿæˆå®¢æˆ·ç«¯ API æ¥è®¿é—®æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„æ¼”ç¤ºæœåŠ¡å™¨ã€‚å®ƒåº”è¯¥åœ¨`src/prisma/client`ä¸­è½¬å‚¨å‡ ä¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬çš„ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨ Prisma å®¢æˆ·æœºå°†æˆ‘ä»¬çš„ GraphQL æœåŠ¡å™¨è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡å™¨ï¼Œå¹¶ä»é‚£é‡Œè·å–æ•°æ®ã€‚

æ‰“å¼€`src/index.js`å¯¼å…¥ä»ç”Ÿæˆçš„å®¢æˆ·ç«¯å¯¼å‡ºçš„ prisma å®ä¾‹ï¼Œç„¶ååˆ é™¤`books`å˜é‡ã€‚

```
const { GraphQLServer } = require("graphql-yoga");
const { prisma } = require('./prisma/client')

....//rest of the code remains untouched 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªè¿è¡Œ Prisma å®¢æˆ·ç«¯æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚æ‰“å¼€å‘½ä»¤è¡Œå¹¶è¿è¡Œå‘½ä»¤`npm install prisma-client-lib`æ¥å®‰è£…è¿™ä¸ªåŒ…ã€‚

## [](#using-prisma-client-in-resolvers)åœ¨è§£æå™¨ä¸­ä½¿ç”¨ Prisma å®¢æˆ·ç«¯

ç°åœ¨æˆ‘ä»¬å·²ç»ç”Ÿæˆäº† Prisma å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è§£æå™¨ä¸­ä½¿ç”¨å®ƒã€‚æˆ‘ä»¬å°†é€šè¿‡æ¯ä¸ªè§£æå™¨å‡½æ•°è·å¾—çš„ä¸Šä¸‹æ–‡å‚æ•°ä¼ é€’ prisma å®ä¾‹ã€‚æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ç®€è¦è®¨è®ºäº†è¿™ä¸ªè®ºç‚¹ï¼Œç°åœ¨ä½ å°†ä¼šç”¨åˆ°å®ƒã€‚æˆ‘æåˆ°è¿‡,`context`å‚æ•°å¯¹äºä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯å¾ˆæœ‰ç”¨ï¼Œæ‚¨å¯ä»¥å‘å…¶ä¸­è¯»å–æˆ–å†™å…¥æ•°æ®ã€‚ä¸ºäº†ä½¿ç”¨ prisma å®¢æˆ·æœºï¼Œæˆ‘ä»¬å°†åœ¨åˆå§‹åŒ– GraphQL å®¢æˆ·æœºæ—¶ï¼Œå°† prisma å®ä¾‹ä»ç”Ÿæˆçš„å®¢æˆ·æœºå†™å…¥ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚

åœ¨`src/index.js`çš„ç¬¬ 32 è¡Œï¼Œæ›´æ–°`GraphQLServer`çš„åˆå§‹åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
const server = new GraphQLServer({
  typeDefs,
  resolvers,
  context: { prisma }
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜å°†æ›´æ–°è§£æå™¨ï¼Œä½¿ç”¨ prisma æ¥è§£ææŸ¥è¯¢ã€‚æ›´æ–°`resolvers`å˜é‡ä¸­çš„`Query`å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
const resolvers = {
  Query: {
    books: (root, args, context, info) => context.prisma.books(),
    book: (root, args, context, info) => context.prisma.book({ id: args.id })
  },
  ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™äº›è§£æå™¨ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨é™„å±äºä¸Šä¸‹æ–‡çš„ prisma å®¢æˆ·æœºå®ä¾‹ä¸Šçš„å‡½æ•°ã€‚å‡½æ•°`prisma.books()`ç»™æˆ‘ä»¬æ•°æ®åº“ä¸­çš„æ‰€æœ‰ä¹¦ç±ï¼Œè€Œ`prisma.book({ id: args.id})`æ ¹æ®ä¼ å…¥çš„ id ç»™æˆ‘ä»¬ä¸€æœ¬ä¹¦ã€‚

## [](#adding-mutation-operations)æ·»åŠ å˜å¼‚æ“ä½œ

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä» GraphQL API è·å–æ•°æ®ï¼Œä½†æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥æ›´æ–°æœåŠ¡å™¨ä¸Šçš„æ•°æ®ã€‚GraphQL å˜å¼‚æ˜¯ä¸€ç§å…è®¸å®¢æˆ·ç«¯ä¿®æ”¹æœåŠ¡å™¨ä¸Šçš„æ•°æ®çš„æ“ä½œã€‚é€šè¿‡è¿™ç§æ“ä½œç±»å‹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æœåŠ¡å™¨ä¸Šæ·»åŠ ã€åˆ é™¤å’Œæ›´æ–°è®°å½•ã€‚ä¸ºäº†è¯»å–æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨ GraphQL æŸ¥è¯¢æ“ä½œç±»å‹ï¼Œè¿™æ˜¯æ‚¨ä»ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å­¦åˆ°çš„ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­ä¹Ÿæåˆ°è¿‡ã€‚

æˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„ GraphQL API æ·»åŠ ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ·»åŠ ä¹¦ç±å’Œä½œè€…ã€‚æˆ‘ä»¬å°†ä»æ›´æ–° GraphQL æ¨¡å¼å¼€å§‹ã€‚æ›´æ–° index.js ä¸­çš„`typeDefs`å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤º

```
const typeDefs = `
type Book {
    id: ID!
    title: String!
    pages: Int
    chapters: Int
    authors: [Author!]!
}

type Author {
    id: ID!
    name: String!
    books: [Book!]!
}

type Query {
  books: [Book!]
  book(id: ID!): Book
  authors: [Author!]
}

type Mutation {
  book(title: String!, authors: [String!]!, pages: Int, chapters: Int): Book!
}
`; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å·²ç»æ›´æ–°äº†æˆ‘ä»¬çš„ GraphQL æ¨¡å¼ï¼Œæ·»åŠ äº†æ–°çš„ç±»å‹ï¼Œ`Author`å’Œ`Mutation`ã€‚æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°å­—æ®µ`authors`,å®ƒæ˜¯ Book ç±»å‹çš„`Author`åˆ—è¡¨ï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ªæ–°å­—æ®µ`authors: [Author!]`åˆ°æ ¹æŸ¥è¯¢ç±»å‹ã€‚æˆ‘è¿˜å°†åä¸º`id`çš„å­—æ®µæ”¹ä¸ºä½¿ç”¨`ID`ç±»å‹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨æ•°æ®æ¨¡å‹ä¸­ä½¿ç”¨äº†è¯¥ç±»å‹ï¼Œæ•°æ®åº“å°†ä¸ºè¿™äº›å­—æ®µç”Ÿæˆå…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè¿™ä¸æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„`Int`ç±»å‹ä¸åŒ¹é…ã€‚æ ¹`Mutation`ç±»å‹å®šä¹‰äº†æˆ‘ä»¬çš„å˜å¼‚æ“ä½œï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªåä¸º`book`çš„å­—æ®µï¼Œå®ƒæ¥å—åˆ›å»ºä¸€æœ¬ä¹¦æ‰€éœ€çš„å‚æ•°ã€‚

åœ¨æˆ‘ä»¬å‘ API æ·»åŠ å˜å¼‚çš„è¿‡ç¨‹ä¸­ï¼Œä¸‹ä¸€æ­¥æ˜¯ä¸ºæˆ‘ä»¬æ·»åŠ çš„æ–°å­—æ®µå’Œç±»å‹å®ç°è§£æå™¨ã€‚åœ¨`index.js`ä»ç„¶æ‰“å¼€çš„æƒ…å†µä¸‹ï¼Œè½¬åˆ°å®šä¹‰äº†`resolvers`å˜é‡çš„ç¬¬ **30** è¡Œï¼Œå‘å¯¹è±¡æ·»åŠ ä¸€ä¸ªæ–°å­—æ®µ`Mutation`ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
const resolvers = {
  Mutation: {
    book: async (root, args, context, info) => {
      let authorsToCreate = [];
      let authorsToConnect = [];

      for (const authorName of args.authors) {
        const author = await context.prisma.author({ name: authorName });
        if (author) authorsToConnect.push(author);
        else authorsToCreate.push({ name: authorName });
      }

      return context.prisma.createBook({
        title: args.title,
        pages: args.pages,
        chapters: args.chapters,
        authors: {
          create: authorsToCreate,
          connect: authorsToConnect
        }
      });
    }
  },
  Query: {
    ...
  },
  Book: {
    ...
  }
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±åƒå…¶ä»–è§£æå™¨å‡½æ•°ä¸€æ ·ï¼Œæ ¹çªå˜ç±»å‹ä¸­çš„`books`è§£æå™¨æ¥å—å››ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬ä» args å‚æ•°è·å¾—éœ€è¦åˆ›å»ºçš„æ•°æ®ï¼Œä» context å‚æ•°è·å¾— prisma å®ä¾‹ã€‚è¿™ä¸ªè§£æå™¨æ˜¯è¿™æ ·å®ç°çš„ï¼Œå®ƒå°†åœ¨æ•°æ®åº“ä¸­åˆ›å»ºå›¾ä¹¦è®°å½•ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä½œè€…ï¼Œç„¶åæ ¹æ®æˆ‘ä»¬çš„æ•°æ®æ¨¡å‹ä¸­å®šä¹‰çš„æ•°æ®å…³ç³»é“¾æ¥è¿™ä¸¤ä¸ªè®°å½•ã€‚æ‰€æœ‰è¿™äº›éƒ½å°†ä½œä¸ºæ•°æ®åº“ä¸­çš„ä¸€ä¸ªäº‹åŠ¡æ¥å®Œæˆã€‚æˆ‘ä»¬ä½¿ç”¨ Prisma æ‰€ç§°çš„[åµŒå¥—å¯¹è±¡å†™](https://www.prisma.io/docs/prisma-client/basic-data-access/writing-data-JAVASCRIPT-rsc6/#nested-object-writes)æ¥ä¿®æ”¹å•ä¸ªäº‹åŠ¡ä¸­è·¨å…³ç³»çš„å¤šä¸ªæ•°æ®åº“è®°å½•ã€‚

è™½ç„¶æˆ‘ä»¬æœ‰äº†æ ¹çªå˜ç±»å‹çš„è§£æå™¨ï¼Œä½†æˆ‘ä»¬ä»ç„¶éœ€è¦ä¸ºæ–°çš„`Author`ç±»å‹æ·»åŠ è§£æå™¨ï¼Œå¹¶ä¸º`Query`å’Œ`Book`ç±»å‹æ·»åŠ æ–°çš„å­—æ®µã€‚æ›´æ–°*ä¹¦*å’Œ*æŸ¥è¯¢*è§£æå™¨å¦‚ä¸‹:

```
const resolvers = {
  Mutation: {
    ...
  },
  Query: {
    books: (root, args, context, info) => context.prisma.books(),
    book: (root, args, context, info) => context.prisma.book({ id: args.id }),
    authors: (root, args, context, info) => context.prisma.authors()
  },
  Book: {
    authors: (parent, args, context) => context.prisma.book({ id: parent.id }).authors()
  },
  Author: {
    books: (parent, args, context) => context.prisma.author({ id: parent.id }).books()
  }
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ ¹æŸ¥è¯¢æ“ä½œçš„`authors`å­—æ®µè§£æå™¨å°±åƒè°ƒç”¨`prisma.authors()`æ¥è·å–æ•°æ®åº“ä¸­çš„æ‰€æœ‰ä½œè€…ä¸€æ ·ç®€å•ã€‚æ‚¨åº”è¯¥æ³¨æ„åˆ°åœ¨`Book`å’Œ`Author`ä¸­çœç•¥äº†æ ‡é‡ç±»å‹å­—æ®µçš„è§£æå™¨ã€‚è¿™æ˜¯å› ä¸º GraphQL æœåŠ¡å™¨å¯ä»¥é€šè¿‡å°†ç»“æœä¸æ¥è‡ª`parent`å‚æ•°çš„åŒåå±æ€§è¿›è¡ŒåŒ¹é…æ¥æ¨æ–­å¦‚ä½•è§£æè¿™äº›å­—æ®µã€‚æˆ‘ä»¬æ‹¥æœ‰çš„å…¶ä»–å…³ç³»å­—æ®µä¸èƒ½ä»¥åŒæ ·çš„æ–¹å¼è§£æï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªå®ç°ã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬æ‰“ç”µè¯ç»™ Prisma æ¥è·å–è¿™äº›æ•°æ®ã€‚

åœ¨æ‰€æœ‰è¿™äº›ç¼–è¾‘ä¹‹åï¼Œä½ çš„ **index.js** åº”è¯¥å’Œä¸‹é¢çš„ä¸€æ ·:

```
const { GraphQLServer } = require("graphql-yoga");
const { prisma } = require("./prisma/client");

const typeDefs = `
type Book {
    id: ID!
    title: String!
    pages: Int
    chapters: Int
    authors: [Author!]!
}

type Author {
    id: ID!
    name: String!
    books: [Book!]!
}

type Query {
  books: [Book!]
  book(id: ID!): Book
  authors: [Author!]
}

type Mutation {
  book(title: String!, authors: [String!]!, pages: Int, chapters: Int): Book!
}
`;

const resolvers = {
  Mutation: {
    book: async (root, args, context, info) => {
      let authorsToCreate = [];
      let authorsToConnect = [];

      for (const authorName of args.authors) {
        const author = await context.prisma.author({ name: authorName });
        if (author) authorsToConnect.push(author);
        else authorsToCreate.push({ name: authorName });
      }

      return context.prisma.createBook({
        title: args.title,
        pages: args.pages,
        chapters: args.chapters,
        authors: {
          create: authorsToCreate,
          connect: authorsToConnect
        }
      });
    }
  },
  Query: {
    books: (root, args, context, info) => context.prisma.books(),
    book: (root, args, context, info) => context.prisma.book({ id: args.id }),
    authors: (root, args, context, info) => context.prisma.authors()
  },
  Book: {
    authors: (parent, args, context) =>
      context.prisma.book({ id: parent.id }).authors()
  },
  Author: {
    books: (parent, args, context) =>
      context.prisma.author({ id: parent.id }).books()
  }
};

const server = new GraphQLServer({
  typeDefs,
  resolvers,
  context: { prisma }
});
server.start(() => console.log(`Server is running on http://localhost:4000`)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#testing-the-graphql-api)æµ‹è¯• GraphQL API

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ›´æ–°äº†æ¨¡å¼ï¼Œå¹¶æ·»åŠ äº†è§£æå™¨æ¥è°ƒç”¨æ•°æ®åº“æœåŠ¡å™¨ä»¥è·å–æ•°æ®ã€‚æˆ‘ä»¬ç°åœ¨å·²ç»åˆ°äº†éœ€è¦æµ‹è¯•æˆ‘ä»¬çš„ API çš„æ—¶å€™äº†ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦åƒé¢„æœŸçš„é‚£æ ·å·¥ä½œã€‚æ‰“å¼€å‘½ä»¤è¡Œï¼Œè¿è¡Œ`node src/index.js`å¯åŠ¨æœåŠ¡å™¨ã€‚ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ [localhost:4000](https://dev.tolocalhost:4000) ã€‚è¿™åº”è¯¥ä¼šæ‰“å¼€ GraphQL æ¸¸ä¹åœºã€‚å¤åˆ¶å¹¶è¿è¡Œä¸‹é¢çš„æŸ¥è¯¢æ¥æ·»åŠ ä¸€æœ¬ä¹¦ã€‚

```
mutation{
  book(title: "Introduction to GraphQL", pages: 150, chapters: 12, authors: ["Peter Mbanugo", "Peter Smith"]){
    title
    pages
    authors{
      name
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[![running-mutation-1.gif](img/9025863fa930572e0a8339f39a5a99a3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--vUiKY_cp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://ucarecdn.com/1461cd73-d446-4dec-9c5b-84f771a51606/)

æ—¢ç„¶å·²ç»åˆ›å»ºäº†å›¾ä¹¦ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­æŸ¥è¯¢å¹¶æŸ¥çœ‹ä½œè€…çš„æƒ…å†µã€‚

```
query{
  authors {
    name
    books {
      title
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[![query-authors.gif](img/d56b555af917944970ca0c056bfa8dfe.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--B4Gkrwcy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://ucarecdn.com/fd720758-7368-4ee5-97ca-d4b607d4999c/)

## [](#thats-a-wrap)å°±è¿™ä¹ˆå®šäº†ï¼

æˆ‘å‘æ‚¨ä»‹ç»äº† GraphQL å˜å¼‚ï¼Œè¿™æ˜¯ GraphQL ä¸­ä¸‰ç§æ ¹æ“ä½œç±»å‹ä¹‹ä¸€ã€‚æˆ‘ä»¬ç”¨æ–°çš„åŠŸèƒ½æ›´æ–°äº†æˆ‘ä»¬çš„æ¨¡å¼ï¼ŒåŒ…æ‹¬å‘åº”ç”¨ç¨‹åºæ·»åŠ ä¹¦ç±çš„çªå˜ï¼Œä»¥åŠä½¿ç”¨ Prisma ä½œä¸ºæˆ‘ä»¬çš„æ•°æ®åº“è®¿é—®å±‚ã€‚æˆ‘å‘æ‚¨å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ¥è‡ª GraphQL çš„ç›¸åŒæ¨¡å¼å®šä¹‰è¯­è¨€ä½¿ç”¨[æ•°æ®æ¨¡å‹](https://www.prisma.io/docs/datamodel-and-migrations/datamodel-MYSQL-knul/)ï¼Œä½¿ç”¨ [CLI å¹¶ç”Ÿæˆ Prisma å®¢æˆ·ç«¯](https://www.prisma.io/docs/prisma-client/)ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ Prisma å®¢æˆ·ç«¯[è¯»å–](https://www.prisma.io/docs/prisma-client/basic-data-access/reading-data-JAVASCRIPT-rsc2/)å’Œ[å†™å…¥](https://www.prisma.io/docs/prisma-client/basic-data-access/writing-data-JAVASCRIPT-rsc6/)æ•°æ®ã€‚ç”±äºæˆ‘ä»¬çš„æ•°æ®å­˜å‚¨åœ¨ Prisma cloud ä¸Šï¼Œæ‚¨å¯ä»¥åœ¨ [app.prisma.io](https://app.prisma.io) ä¸Šåœ¨çº¿è®¿é—®æ‚¨çš„æœåŠ¡å’Œæ•°æ®åº“ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæ‚¨ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ·»åŠ äº†æ–°çš„åŠŸèƒ½ã€‚è¿™å°†ä½¿æ‚¨å…·å¤‡æ„å»º GraphQL API æ¥æ‰§è¡Œ CRUD æ“ä½œçš„æŠ€èƒ½ã€‚è¿™åº”è¯¥è®©ä½ å¯ä»¥å‘ä½ çš„æœ‹å‹ç‚«è€€ä½ ç°åœ¨æ˜¯ä¸€å GraphQL å¼€å‘äººå‘˜ğŸ˜ã€‚ä¸ºäº†å‘æ‚¨è¯æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘å¸Œæœ›æ‚¨åœ¨ API ä¸­æ·»åŠ ä¸€ç»„æ–°çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤º:

1.  æ·»åŠ ä¸€ä¸ªæŸ¥è¯¢ï¼ŒæŒ‰ä½œè€…å§“åæŸ¥æ‰¾ä½œè€…ã€‚
2.  å…è®¸ä¹¦ç±æœ‰å‡ºç‰ˆå•†ã€‚è¿™å°†ä½¿æ‚¨å‘æ¨¡å¼ä¸­æ·»åŠ ä¸€ä¸ªæ–°ç±»å‹ã€‚æ‚¨åº”è¯¥èƒ½å¤Ÿç‹¬ç«‹æ·»åŠ å‡ºç‰ˆå•†å’ŒæŸ¥è¯¢å±äºä¸€ä¸ªå‡ºç‰ˆå•†çš„æ‰€æœ‰ä¹¦ç±ã€‚

å¦‚æœä½ å¡ä½äº†ï¼Œæˆ–è€…æƒ³è®©æˆ‘çœ‹çœ‹ä½ çš„è§£å†³æ–¹æ¡ˆï¼Œè¯·åœ¨ twitter ä¸Šå¯¹æˆ‘å¤§å–Šå¤§å«ã€‚æˆ‘æ˜¯æ¨ç‰¹ä¸Šçš„ [@p_mbanugoã€‚](https://twitter.com/p_mbanugo)

è™½ç„¶è¿™é¡¹æŠ€èƒ½ä½¿æ‚¨æˆä¸ºä¸€åè‡ªè±ªçš„ GraphQL å¼€å‘äººå‘˜ï¼Œä½†æˆ‘ä¸ä¼šå°±æ­¤æ­¢æ­¥ã€‚æˆ‘æƒ³å¢å¼ºä½ çš„æŠ€èƒ½ï¼Œè®©ä½ æ›´ä¸“ä¸šã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘æ‚¨ä»‹ç» GraphQL æœåŠ¡å™¨ä¸­çš„è®¤è¯å’Œ GraphQL è®¢é˜…ã€‚æ‰€ä»¥æ•¬è¯·å…³æ³¨ï¼Œä¿æŒç¼–ç ç²¾ç¥ğŸš€ğŸ‘©â€ğŸ¤ğŸ˜ğŸ’ªâ¤ï¸

ä½ å¯ä»¥åœ¨ [GitHub](https://github.com/pmbanugo/graphql-intro-js) ä¸Šæ‰¾åˆ°è¿™ç¯‡æ–‡ç« çš„å®Œæ•´ä»£ç ã€‚ä¸‹è½½æºä»£ç ï¼Œè¿›å…¥`src-part-2`æ–‡ä»¶å¤¹ã€‚

> æœ€åˆå‘è¡¨äº[telerik.com/blogs](https://www.telerik.com/blogs/graphql-mutation-and-database-access)