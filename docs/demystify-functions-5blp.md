# æ­å¼€å‡½æ•°çš„ç¥ç§˜é¢çº±

> åŸæ–‡ï¼š<https://dev.to/stereobooster/demystify-functions-5blp>

åœ¨æˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è°ˆåˆ°äº†å‡½æ•°çš„ç†è®ºè§‚ç‚¹ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•ç”¨ç¼–ç¨‹è¯­è¨€ä»å¤´å¼€å§‹å®ç°å‡½æ•°ã€‚

è¿™ç¯‡æ–‡ç« æ˜¯è¿™ä¸ªç³»åˆ—çš„ä¸€éƒ¨åˆ†:åœ¨ä»¥å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ„å»ºäº†å°å‹è¯­è¨€ï¼Œç°åœ¨å¯ä»¥åš`+`ã€`-`ã€`define`(å…¨å±€èŒƒå›´å˜é‡)ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ `function`æ“ä½œï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ã€‚æˆ‘ä»¬å°†å‘ç°æœ‰ç±»å‹(`symbol`ã€`number`)çš„åˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæ–°ç±»å‹(`function`)ã€‚

## æˆ‘ä»¬å°†è¦†ç›–ä»€ä¹ˆï¼Ÿ

è¿™æ˜¯å­¦ä¹ ç»ƒä¹ ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å°†åªå®ç°æœ‰é™çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŠ¨æ€å˜é‡è§£æè€Œä¸æ˜¯è¯æ³•èŒƒå›´ï¼Œæˆ‘ä»¬ä¸ä¼šè°ˆè®ºé€’å½’æˆ–å †æ ˆæº¢å‡ºé”™è¯¯æˆ–å°¾éƒ¨è°ƒç”¨ä¼˜åŒ–ï¼Œæˆ‘ä»¬è¿˜ä¸ä¼šæ”¯æŒé—­åŒ…(è¿™æ˜¯ä¸‹ä¸€ç¯‡æ–‡ç« )ï¼Œè¯„ä¼°ç­–ç•¥(å¤§å¤šæ•°æ—¶é—´æˆ‘ä»¬å°†ä½¿ç”¨æŒ‰å€¼è°ƒç”¨)ã€‚

æˆ‘ä»¬å°†å®ç°è¿™æ ·ä¸€ä¸ªåŠŸèƒ½:

```
> (define minus
    (function (x y)
      (- x y)))
> (minus 2 1)
= 1 
```

ä¾‹å¦‚ï¼Œ`(function ...)`è¿”å›ä¸€ä¸ªæˆ‘ä»¬èµ‹ç»™å˜é‡(`minus`)çš„å‡½æ•°ï¼Œç¨åæˆ‘ä»¬å¯ä»¥åƒè°ƒç”¨å†…ç½®å‡½æ•°ä¸€æ ·è°ƒç”¨å®ƒã€‚

## å®ç°

åˆ›å»ºä¸€ä¸ªå‡½æ•°éœ€è¦ä»€ä¹ˆï¼Ÿæˆ‘ä»¬éœ€è¦ä¸‰æ ·ä¸œè¥¿

*   ä½œä¸ºè¿™æ˜¯è¡¨è¾¾å¼çš„ä¿¡å·çš„å…³é”®å­—`function`æ˜¯å‡½æ•°å£°æ˜ã€‚å…¶ä»–çš„ Lisp é£æ ¼å¯èƒ½ä¼šç”¨`lambda`ã€`Î»`æˆ–è€…`\`æ¥ä»£æ›¿ã€‚
*   å‡½æ•°å‚æ•°åˆ—è¡¨
*   å‡½æ•°ä½“

ä¾‹å¦‚:

```
;                 function bodyâ¤µ
(define minus (function (x y) (- x y)))
;              argumentsâ¤´ 
```

å‡½æ•°è°ƒç”¨å°†ä½¿ç”¨ä¸€ä¸ªç¯å¢ƒæ¥è¯„ä¼°ä¸»ä½“ï¼Œè¯¥ç¯å¢ƒå°†å…·æœ‰ä»¥ä¸å‚æ•°ç›¸åŒçš„æ–¹å¼å‘½åçš„å˜é‡ï¼Œä¾‹å¦‚

```
(minus 2 1) 
```

ä¸
ç›¸åŒ

```
evaluate(parse(`(- x y)`), { x: 2, y: 1 }); 
```

**å‡½æ•°æ˜¯å¸¦æœ‰ä¸€äº›å±€éƒ¨å˜é‡çš„å­ç¨‹åº(æˆ–ä¾‹ç¨‹)**ã€‚

### å‡½æ•°ä¸ºæ•°å€¼

å‡½æ•°æ˜¯ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠå®ƒèµ‹ç»™å˜é‡:

```
(define minus (function (x y) (- x y))) 
```

å¦‚æœæˆ‘ä»¬å¯ä»¥å°†å®ƒèµ‹ç»™ä¸€ä¸ªå˜é‡ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä»¥æŸç§å¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ–¹å¼æ¥è¡¨ç¤ºä¸€ä¸ªå‡½æ•°ã€‚æˆ‘ä»¬å°†å¦‚ä½•åšï¼Ÿ

æˆ‘ä»¬å¯ä»¥å°†å®ƒå­˜å‚¨ä¸ºåˆ—è¡¨:

*   é¦–å…ˆå°†æ˜¯å…³é”®å­—â€œåŠŸèƒ½â€(æ ‡ç­¾)
*   ç¬¬äºŒä¸ªæ˜¯å‚æ•°åˆ—è¡¨
*   ç¬¬ä¸‰ä¸ªæ˜¯å‡½æ•°ä½“

ç™¾ç±³...ä¼¼ä¹å¾ˆç†Ÿæ‚‰ğŸ¤”ã€‚æˆ‘ä»¬å¯ä»¥é‡ç”¨å‡½æ•°çš„ AST ä½œä¸ºå‡½æ•°è¡¨ç¤º

```
const evaluate = (ast, environment = {}) => {
  // ...
  // function call handling
  let [name, first, second] = ast;
  const numberOfArguments = ast.length - 1;
  if (name === "+") {
    // ...
  } else if (name === "function") {
    return ast;
  } else {
    // ...
  }
}; 
```

æˆ‘ä»¬å¯ä»¥è¿™æ ·æ£€æµ‹å‡½æ•°:

```
const isFunction = ast => isList(ast) && ast[0] === "function"; 
```

### å‡½æ•°è°ƒç”¨

è®©æˆ‘ä»¬æ·»åŠ å¯¹å‡½æ•°è°ƒç”¨çš„æ”¯æŒã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡çš„ï¼Œå‡½æ•°è°ƒç”¨åªæ˜¯ç”¨é™„åŠ çš„å±€éƒ¨å˜é‡æ¥æ±‚å€¼:

```
const evaluate = (ast, environment = {}) => {
  // ...
  if (name === "+") {
    return evaluate(first, environment) + evaluate(second, environment);
    //...
  } else {
    if (!isFunction(environment[name])) {
      throw new RuntimeError(`"${name}" is not a function`);
    }
    // take function and destructure it to arguments and body
    const [_, argumentNames, body] = environment[name];
    // assume all functions expect 2 arguments
    const functionEnvironment = {
      // take current environment
      ...environment,
      // add arguments to environment
      [argumentNames[0]]: evaluate(first, environment),
      [argumentNames[1]]: evaluate(second, environment)
    };
    // pass body and new environment to evaluate
    return evaluate(body, functionEnvironment);
  }
}; 
```

å°±æ˜¯è¿™æ ·ã€‚æˆ‘ä»¬å®ç°äº†å‡½æ•°ã€‚ç°åœ¨æ¥è¯´è¯´ç»†èŠ‚ã€‚

### å±€éƒ¨å˜é‡

ä¸ºä»€ä¹ˆä»–ä»¬ç§°ä¹‹ä¸ºå±€éƒ¨å˜é‡ï¼Ÿå±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡çš„åŒºåˆ«åœ¨äºå…¨å±€å˜é‡åœ¨ä»»ä½•åœ°æ–¹éƒ½æ˜¯å¯è®¿é—®çš„(ä¸€æ—¦å®šä¹‰)ï¼Œä½†æ˜¯å±€éƒ¨å˜é‡åªåœ¨å‡½æ•°å†…éƒ¨å¯ç”¨ã€‚

ä¾‹å¦‚:

```
> (define z 1)
= 1
> (+ z z)
= 2 
```

å®ƒå°†è¿”å›åˆ° 2ã€‚

```
(define minus (function (x y) (- x y))) 
```

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`x`å’Œ`y`å˜é‡ï¼Œè¿™æ„å‘³ç€å®ƒä»¬æ˜¯è¢«å®šä¹‰çš„(è‡³å°‘åœ¨å‡½æ•°å†…éƒ¨)ã€‚ç°åœ¨å¦‚æœæˆ‘ä»¬å°è¯•

```
> (minus 2 1)
= 1
> (+ x y) 
```

å®ƒä¼šæŠ›å‡ºä¸€ä¸ªå…³äºæœªå®šä¹‰å˜é‡`x`å’Œ`y`çš„å¼‚å¸¸ï¼Œå› ä¸ºå®ƒä»¬å¹¶ä¸å…¨å±€å­˜åœ¨ã€‚

æ¯ä¸ªå‡½æ•°éƒ½æœ‰å®ƒçš„ä½œç”¨åŸŸï¼Œä½†å®ƒåŒ…å«äº†å…¨å±€ä½œç”¨åŸŸä¸­çš„æ‰€æœ‰å˜é‡ã€‚

### å¯å˜é®è”½

è®©æˆ‘ä»¬çœ‹æ›´å¤šçš„ä¾‹å­:

```
> (define z 1)
= 1
> (define minuzzz (function (x y) (- (- x y) z)))
> (minuzzz 2 1)
= 0 
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`minuzzz`å‡½æ•°å·²ç»è®¿é—®äº†å…¨å±€ä½œç”¨åŸŸ(`z`å˜é‡)ã€‚è¿™å¾ˆæœ‰é“ç†ï¼Œä½†æ˜¯è¿™ä¸ªä¾‹å­æ€ä¹ˆæ ·

```
> (define x 1)
= 1
> (define minus (function (x y) (- x y)))
> (minus 2 1)
= 1 
```

`x`å­˜åœ¨äºå…¨çƒå’Œæœ¬åœ°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå±€éƒ¨ç‰ˆæœ¬â€œè·èƒœâ€ï¼Œè¿™è¢«ç§°ä¸ºå˜é‡é˜´å½±(å±€éƒ¨å˜é‡é˜´å½±å…¨å±€ä¸€)ã€‚

### åŠ¨æ€åˆ†è¾¨ç‡

å¦‚æœæˆ‘ä»¬åšäº†ä¼šå‘ç”Ÿä»€ä¹ˆ:

```
> (define getFun
        (function (x y)
          (function (i j)
            (- (+ x y) (+ i j))
          )
        )
      )
> (define fun (getFun 5 4))
> (fun 3 2) 
```

`getFun`æ˜¯è¿”å›å‡½æ•°çš„å‡½æ•°ã€‚æˆ‘ä»¬ç»™`fun`åˆ†é…ä¸€ä¸ªç”±`getFun`è¿”å›çš„å‡½æ•°(å°†`x`å’Œ`y`åˆ†åˆ«æ›¿æ¢ä¸º 5 å’Œ 4)ã€‚

æˆ‘å¸Œæœ›`(fun 3 2)`æ‰©å±•åˆ°ä¸‹é¢çš„è¡¨è¾¾å¼`(- (+ 5 4) (+ 3 2))`æˆ–ç®—æœ¯ç¬¦å·`((5 + 4) - (3 + 2))`ï¼Œå¹¶è®¡ç®—ä¸º`4`ã€‚ä½†æ˜¯ï¼Œè¿™åè€Œä¼šå¯¼è‡´é”™è¯¯`Can't find "y" variable...`ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨â€œåŠ¨æ€â€è§£æï¼Œæˆ‘ä»¬ä¸ä¿ç•™ç¯å¢ƒï¼Œåªæœ‰ä¸€ä¸ªå…¨å±€ç¯å¢ƒå’Œä¸€ä¸ªå‡½æ•°ç¯å¢ƒï¼Œä½†æ˜¯ä¸ºäº†æ”¯æŒè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åœ¨åˆ›å»ºæ—¶ä¿å­˜æ¯ä¸ªå‡½æ•°çš„ç¯å¢ƒï¼Œå¹¶å°†å…¶ä¸å‡½æ•°ä¸€èµ·ä¼ é€’ã€‚è¿™ä¸ªå‡½æ•°ä¸ä¸€ä¸ªå«åš closure çš„ç¯å¢ƒä¸€èµ·ä¼ é€’ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å®ç° closureã€‚

### åŸç”Ÿå‡½æ•°

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨è‡ªå·±çš„è¯­è¨€å®šä¹‰å‡½æ•°äº†ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†`+`å’Œ`-`ä¹‹é—´çš„ä¸€äº›åŒºåˆ«ï¼Œæ¯”å¦‚ï¼Œå’Œç”¨æˆ·å®šä¹‰çš„å‡½æ•°ã€‚

`+`å’Œ`-`ä½¿ç”¨â€œæœ¬åœ°â€åŠŸèƒ½ï¼Œä¾‹å¦‚åº•å±‚å¹³å°çš„èƒ½åŠ›æ¥æ‰§è¡Œå®é™…æ“ä½œã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨æ±‡ç¼–è¯­è¨€è€Œä¸æ˜¯ JSï¼Œå®ƒå¯èƒ½æ˜¯ä¸€äº›ç‰¹å®šäºå¤„ç†å™¨çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚:

ä¸‰æ“ä½œæ•°æ¶æ„(RISC - PowerPC)

```
;A:= B+C
lwz r2, [num1]
lwz r3, [num2]
add r4,r3,r2 
```

åŒæ“ä½œæ•°ä½“ç³»ç»“æ„(CISC - x86)

```
;A:=B
mov eax, [num1]
mov ebx, [num2]
;A:=A+B
add eax,ebx 
```

[æ±‡ç¼–ç‰‡æ®µçš„æ¥æº](https://www.quora.com/How-do-I-add-two-numbers-in-assembly-language/answer/Alexandre-Horst)ã€‚

### ç¯å¢ƒä¸­çš„åŠŸèƒ½

ç°åœ¨ï¼Œå½“æˆ‘ä»¬å¯ä»¥åœ¨ç¯å¢ƒä¸­å­˜å‚¨ç”¨æˆ·åˆ›å»ºçš„å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘åœ¨ç¯å¢ƒä¸­å­˜å‚¨ä¸€äº›å†…ç½®å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ç¨å¾®ç®€åŒ–ä»£ç ã€‚

æˆ‘ä»¬å¯ä»¥å°†`+`ã€`-`å‡½æ•°ç§»åˆ°ç¯å¢ƒä¸­ï¼Œä½†ä¸èƒ½å°†`define`å’Œ`function`å‡½æ•°ç§»åˆ°ç¯å¢ƒä¸­ã€‚(æƒ³æƒ³æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸èƒ½ã€‚)

é€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿåˆ é™¤ä¸€äº›ä»£ç :

```
const evaluate = (ast, environment = {}) => {
  // ...
  // function call handling
  let [name, first, second] = ast;
  const numberOfArguments = ast.length - 1;
- if (name === "+") {
-   return evaluate(first, environment) + evaluate(second, environment);
- } else if (name === "-") {
-   return evaluate(first, environment) - evaluate(second, environment);
- } else if (name === "define") { + if (name === "define") {
    // ...
    if (
      environment[first] !== undefined ||
-     first === "+" ||
-     first === "-" ||
      first === "define" ||
      first === "function"
    ) {
      throw new RuntimeError(`Can't redefine "${first}" variable`);
    }
    // ...
  }
}; 
```

å°†å‡½æ•°ç§»åŠ¨åˆ°ç¯å¢ƒ:

```
const defaultEnvironment = {
  "+": (a, b) => a + b,
  "-": (a, b) => a - b
};

const evaluate = (ast, environment = { ...defaultEnvironment }) => { 
```

æ·»åŠ å¤„ç†å‡½æ•°è°ƒç”¨çš„é€»è¾‘:

```
const evaluate = (ast, environment = { ...defaultEnvironment }) => {
  // ...
  if (name === "define") {
    // ...
  } else {
    if (isNativeFunction(environment[name])) {
      return environment[name](
        evaluate(first, environment),
        evaluate(second, environment)
      );
    }
    if (isFunction(environment[name])) {
      // ...
    }
  }
}; 
```

## PS

è¿™åªæ˜¯å‡½æ•°çš„å¼€å§‹ã€‚æˆ‘ä»¬ä»ç„¶éœ€è¦æ¶µç›–å¾ˆå¤šä¸»é¢˜ï¼Œä½†åŸºæœ¬çš„æƒ³æ³•å·²ç»åˆ°ä½ã€‚

è¿™ç¯‡æ–‡ç« çš„æºä»£ç æ˜¯[è¿™é‡Œ](https://github.com/stereobooster/write-a-language/tree/master/4.function)å’Œ[è¿™é‡Œ](https://github.com/stereobooster/write-a-language/tree/master/5.functions-in-environment)ã€‚